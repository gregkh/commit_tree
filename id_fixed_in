#!/bin/bash
# SPDX-License-Identifier: GPL-2.0
#
# Copyright 2020 Greg Kroah-Hartman <gregkh@linuxfoundation.org>
#
# Given a git commit id, does any commit fix this patch as well?
#
# spits the output as:
#  SHA1:KERNEL_VERSION:COMMIT_THAT_FIXES
# where:
#  SHA1 - the sha1 that was asked to be looked up
#  KERNEL_VERSION - kernel version where the commit that fixes this was released in
#  COMMIT_THAT_FIXES - commit that fixes the sha1 that was asked to be looked up
#
# if no fixes is found, 1 is returned with no output on the command line
#
# this script is mostly to be used by other "wrapper" scripts, not all that
# useful output on its own.
#
#


#KERNEL_DIR="/home/gregkh/linux/gregkh"
KERNEL_DIR="/home/gregkh/linux/stable/linux-stable"

REAL_SCRIPT=$(realpath -e ${BASH_SOURCE[0]})
SCRIPT_TOP="${SCRIPT_TOP:-$(dirname ${REAL_SCRIPT})}"

source ${SCRIPT_TOP}/lib/common

usage()
{
	echo "sha1 number not found"
	echo "usage:"
	echo "	$0 SHA1"
	echo ""
	echo "output is printed in:"
	echo "	SHA1:KERNEL_VERSION:COMMIT_THAT_FIXES"
	exit 1
}

sha1=$1

if [ "${sha1}" == "" ] ; then
	usage
fi

# turn the sha1 into a 12 digit number only (shorten or lengthen it)
cd "${KERNEL_DIR}"
unified_sha1=$(git show -s --abbrev-commit --abbrev=12 --pretty=format:"%h" "${sha1}" 2>/dev/null)
if [ "${unified_sha1}" = "" ] ; then
	log "${txtylw}${sha1}${txtred} not found in upstream repo${txtrst}"
	exit 2
fi

sha1=${unified_sha1}

cd "${SCRIPT_TOP}/changes" || exit 1

found=0
for commit in $(git grep -l --threads=3 "${sha1}"); do
	kernel_ver=$(echo "${commit}" | cut -f 1 -d '/')
	commit_id=$(echo "${commit}" | cut -f 2 -d '/')

#	logn "${txtcyn}${sha1}${txtgrn} fixed in kernel "
#	logn "${txtylw}${kernel_ver}${txtgrn} in commit "
#	log  "${txtred}${commit_id}${txtrst}"
	log "${sha1}:${kernel_ver}:${commit_id}"
	found=1
done

if [ "${found}" = "1" ] ; then
	exit
fi

#log "${txtylw}${sha1}${txtgrn} no fixes found${txtrst}"
exit 1
