commit 09f886dc5a6945679ed35e6acfbc746f472f0f34
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Thu Jan 26 08:25:24 2017 +0100

    Linux 4.9.6

commit f77ef5348d4bfb498062930bd9af828f3ef2947e
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:08 2016 +0100

    libceph: stop allocating a new cipher on every crypto request
    
    commit 7af3ea189a9a13f090de51c97f676215dabc1205 upstream.
    
    This is useless and more importantly not allowed on the writeback path,
    because crypto_alloc_skcipher() allocates memory with GFP_KERNEL, which
    can recurse back into the filesystem:
    
        kworker/9:3     D ffff92303f318180     0 20732      2 0x00000080
        Workqueue: ceph-msgr ceph_con_workfn [libceph]
         ffff923035dd4480 ffff923038f8a0c0 0000000000000001 000000009eb27318
         ffff92269eb28000 ffff92269eb27338 ffff923036b145ac ffff923035dd4480
         00000000ffffffff ffff923036b145b0 ffffffff951eb4e1 ffff923036b145a8
        Call Trace:
         [<ffffffff951eb4e1>] ? schedule+0x31/0x80
         [<ffffffff951eb77a>] ? schedule_preempt_disabled+0xa/0x10
         [<ffffffff951ed1f4>] ? __mutex_lock_slowpath+0xb4/0x130
         [<ffffffff951ed28b>] ? mutex_lock+0x1b/0x30
         [<ffffffffc0a974b3>] ? xfs_reclaim_inodes_ag+0x233/0x2d0 [xfs]
         [<ffffffff94d92ba5>] ? move_active_pages_to_lru+0x125/0x270
         [<ffffffff94f2b985>] ? radix_tree_gang_lookup_tag+0xc5/0x1c0
         [<ffffffff94dad0f3>] ? __list_lru_walk_one.isra.3+0x33/0x120
         [<ffffffffc0a98331>] ? xfs_reclaim_inodes_nr+0x31/0x40 [xfs]
         [<ffffffff94e05bfe>] ? super_cache_scan+0x17e/0x190
         [<ffffffff94d919f3>] ? shrink_slab.part.38+0x1e3/0x3d0
         [<ffffffff94d9616a>] ? shrink_node+0x10a/0x320
         [<ffffffff94d96474>] ? do_try_to_free_pages+0xf4/0x350
         [<ffffffff94d967ba>] ? try_to_free_pages+0xea/0x1b0
         [<ffffffff94d863bd>] ? __alloc_pages_nodemask+0x61d/0xe60
         [<ffffffff94ddf42d>] ? cache_grow_begin+0x9d/0x560
         [<ffffffff94ddfb88>] ? fallback_alloc+0x148/0x1c0
         [<ffffffff94ed84e7>] ? __crypto_alloc_tfm+0x37/0x130
         [<ffffffff94de09db>] ? __kmalloc+0x1eb/0x580
         [<ffffffffc09fe2db>] ? crush_choose_firstn+0x3eb/0x470 [libceph]
         [<ffffffff94ed84e7>] ? __crypto_alloc_tfm+0x37/0x130
         [<ffffffff94ed9c19>] ? crypto_spawn_tfm+0x39/0x60
         [<ffffffffc08b30a3>] ? crypto_cbc_init_tfm+0x23/0x40 [cbc]
         [<ffffffff94ed857c>] ? __crypto_alloc_tfm+0xcc/0x130
         [<ffffffff94edcc23>] ? crypto_skcipher_init_tfm+0x113/0x180
         [<ffffffff94ed7cc3>] ? crypto_create_tfm+0x43/0xb0
         [<ffffffff94ed83b0>] ? crypto_larval_lookup+0x150/0x150
         [<ffffffff94ed7da2>] ? crypto_alloc_tfm+0x72/0x120
         [<ffffffffc0a01dd7>] ? ceph_aes_encrypt2+0x67/0x400 [libceph]
         [<ffffffffc09fd264>] ? ceph_pg_to_up_acting_osds+0x84/0x5b0 [libceph]
         [<ffffffff950d40a0>] ? release_sock+0x40/0x90
         [<ffffffff95139f94>] ? tcp_recvmsg+0x4b4/0xae0
         [<ffffffffc0a02714>] ? ceph_encrypt2+0x54/0xc0 [libceph]
         [<ffffffffc0a02b4d>] ? ceph_x_encrypt+0x5d/0x90 [libceph]
         [<ffffffffc0a02bdf>] ? calcu_signature+0x5f/0x90 [libceph]
         [<ffffffffc0a02ef5>] ? ceph_x_sign_message+0x35/0x50 [libceph]
         [<ffffffffc09e948c>] ? prepare_write_message_footer+0x5c/0xa0 [libceph]
         [<ffffffffc09ecd18>] ? ceph_con_workfn+0x2258/0x2dd0 [libceph]
         [<ffffffffc09e9903>] ? queue_con_delay+0x33/0xd0 [libceph]
         [<ffffffffc09f68ed>] ? __submit_request+0x20d/0x2f0 [libceph]
         [<ffffffffc09f6ef8>] ? ceph_osdc_start_request+0x28/0x30 [libceph]
         [<ffffffffc0b52603>] ? rbd_queue_workfn+0x2f3/0x350 [rbd]
         [<ffffffff94c94ec0>] ? process_one_work+0x160/0x410
         [<ffffffff94c951bd>] ? worker_thread+0x4d/0x480
         [<ffffffff94c95170>] ? process_one_work+0x410/0x410
         [<ffffffff94c9af8d>] ? kthread+0xcd/0xf0
         [<ffffffff951efb2f>] ? ret_from_fork+0x1f/0x40
         [<ffffffff94c9aec0>] ? kthread_create_on_node+0x190/0x190
    
    Allocating the cipher along with the key fixes the issue - as long the
    key doesn't change, a single cipher context can be used concurrently in
    multiple requests.
    
    We still can't take that GFP_KERNEL allocation though.  Both
    ceph_crypto_key_clone() and ceph_crypto_key_decode() are called from
    GFP_NOFS context, so resort to memalloc_noio_{save,restore}() here.
    
    Reported-by: Lucas Stach <l.stach@pengutronix.de>
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5b482bf5886855be44e89653f88297aab423dee6
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:08 2016 +0100

    libceph: uninline ceph_crypto_key_destroy()
    
    commit 6db2304aabb070261ad34923bfd83c43dfb000e3 upstream.
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 12274f2c17f2f7d5c0a0cfdc649410c9a37bb66c
Author: Halil Pasic <pasic@linux.vnet.ibm.com>
Date:   Mon Aug 29 18:25:22 2016 +0200

    tools/virtio/ringtest: fix run-on-all.sh for offline cpus
    
    commit 21f5eda9b8671744539c8295b9df62991fffb2ce upstream.
    
    Since ef1b144d ("tools/virtio/ringtest: fix run-on-all.sh to work
    without /dev/cpu") run-on-all.sh uses seq 0 $HOST_AFFINITY as the list
    of ids of the CPUs to run the command on (assuming ids of online CPUs
    are consecutive and start from 0), where $HOST_AFFINITY is the highest
    CPU id in the system previously determined using lscpu.  This can fail
    on systems with offline CPUs.
    
    Instead let's use lscpu to determine the list of online CPUs.
    
    Signed-off-by: Halil Pasic <pasic@linux.vnet.ibm.com>
    Fixes: ef1b144d ("tools/virtio/ringtest: fix run-on-all.sh to work without
    /dev/cpu")
    Reviewed-by: Sascha Silbe <silbe@linux.vnet.ibm.com>
    Signed-off-by: Cornelia Huck <cornelia.huck@de.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fa555d021d2b87faffe156e642c781ce20b05932
Author: Madhavan Srinivasan <maddy@linux.vnet.ibm.com>
Date:   Mon Dec 19 17:46:53 2016 +0530

    selftest/powerpc: Wrong PMC initialized in pmc56_overflow test
    
    commit df21d2fa733035e4d414379960f94b2516b41296 upstream.
    
    Test uses PMC2 to count the event. But PMC1 is being initialized.
    Patch to fix it.
    
    Fixes: 3752e453f6ba ('selftests/powerpc: Add tests of PMU EBBs')
    Signed-off-by: Madhavan Srinivasan <maddy@linux.vnet.ibm.com>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f37b7a3004bbf49d76ed170e720293752e74a06f
Author: Wei Yongjun <weiyongjun1@huawei.com>
Date:   Thu Jan 12 14:53:41 2017 +0000

    soc: ti: wkup_m3_ipc: Fix error return code in wkup_m3_ipc_probe()
    
    commit 36b29eb30ee0f6c99f06bea406c23a3fd4cbb80b upstream.
    
    Fix to return a negative error code from the kthread_run() error
    handling case instead of 0, as done elsewhere in this function.
    
    Fixes: cdd5de500b2c ("soc: ti: Add wkup_m3_ipc driver")
    Signed-off-by: Wei Yongjun <weiyongjun1@huawei.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 97d5e2057564dc21aba1506ee30d869d691e3830
Author: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Date:   Mon Jan 2 13:44:28 2017 +0200

    spi: pxa2xx: add missed break
    
    commit a2dd8af00ca7fff4972425a4a6b19dd1840dc807 upstream.
    
    The commit 7c7289a40425 ("spi: pxa2xx: Default thresholds to PXA
    configuration") while splitting up CE4100 code obviously missed a break
    condition in one chunk. Add it here.
    
    Looks like we have no active user of CE4100, though better to fix this later
    than never.
    
    Fixes: commit 7c7289a40425 ("spi: pxa2xx: Default thresholds to PXA configuration")
    Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d21814a8068ae5a006453f6c2c0b687a87249b24
Author: Marek Szyprowski <m.szyprowski@samsung.com>
Date:   Fri Dec 16 11:39:11 2016 +0100

    dmaengine: pl330: Fix runtime PM support for terminated transfers
    
    commit 5c9e6c2b2ba3ec3a442e2fb5b4286498f8b4dcb7 upstream.
    
    PL330 DMA engine driver is leaking a runtime reference after any terminated
    DMA transactions. This patch fixes this issue by tracking runtime PM state
    of the device and making additional call to pm_runtime_put() in terminate_all
    callback if needed.
    
    Fixes: ae43b3289186 ("ARM: 8202/1: dmaengine: pl330: Add runtime Power Management support v12")
    Signed-off-by: Marek Szyprowski <m.szyprowski@samsung.com>
    Reviewed-by: Krzysztof Kozlowski <krzk@kernel.org>
    Signed-off-by: Vinod Koul <vinod.koul@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 172270c743487ec24cc145949a77bd57136ffff9
Author: Niklas Söderlund <niklas.soderlund+renesas@ragnatech.se>
Date:   Wed Jan 11 15:39:31 2017 +0100

    dmaengine: rcar-dmac: unmap slave resource when channel is freed
    
    commit 3139dc8ded6f27552a248d23fe9f086e3027fa12 upstream.
    
    The slave mapping should be removed together with other channel
    resources when the channel is freed. If it's not unmapped it will hang
    around forever after the channel is freed.
    
    Fixes: 9f878603dbdb7db3 ("dmaengine: rcar-dmac: add iommu support for slave transfers")
    Reported-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
    Signed-off-by: Niklas Söderlund <niklas.soderlund+renesas@ragnatech.se>
    Reviewed-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
    Signed-off-by: Vinod Koul <vinod.koul@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3bef7578e05f8188743641da8bc7ddfdbb64d268
Author: Marek Szyprowski <m.szyprowski@samsung.com>
Date:   Mon Nov 14 12:09:26 2016 -0200

    s5p-mfc: Fix clock management in s5p_mfc_release() function
    
    commit c0026c7bfb95c250c3e34fde59f96ad72fd730d6 upstream.
    
    Clock control indirectly requires access to MFC device, so call it only
    if we are sure that the device exists in s5p_mfc_release function.
    s5p_mfc_remove() calls s5p_mfc_final_pm(), which releases all PM related
    resources, including clocks, so any call to clocks related functions
    is not valid after s5p_mfc_final_pm().
    
    Fixes: d695c12 ("[media] media: s5p-mfc fix invalid memory access from
    s5p_mfc_release()")
    
    Signed-off-by: Marek Szyprowski <m.szyprowski@samsung.com>
    Signed-off-by: Sylwester Nawrocki <s.nawrocki@samsung.com>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d47e1e7c46fed13f6e9d60c98f8352c714db695e
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Thu Oct 13 11:39:04 2016 -0300

    s5p-cec: mark PM functions as __maybe_unused again
    
    commit eadf081146ec327d6fbbb6aff28e3d9aac329dc6 upstream.
    
    A bugfix removed the two callers of s5p_cec_runtime_suspend
    and s5p_cec_runtime_resume, leading to the return of a harmless
    warning that I had previously fixed in commit aee8937089b1
    ("[media] s5p_cec: mark suspend/resume as __maybe_unused"):
    
    staging/media/s5p-cec/s5p_cec.c:234:12: error: ‘s5p_cec_runtime_suspend’ defined but not used [-Werror=unused-function]
    staging/media/s5p-cec/s5p_cec.c:242:12: error: ‘s5p_cec_runtime_resume’ defined but not used [-Werror=unused-function]
    
    This adds the __maybe_unused annotations to the function that
    were not removed and that are now unused when CONFIG_PM
    is disabled.
    
    Fixes: 57b978ada073 ("[media] s5p-cec: fix system and runtime PM integration")
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Signed-off-by: Hans Verkuil <hans.verkuil@cisco.com>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dfe8e5730fa1a91129c65dacf85783fa796d7e0a
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Fri Oct 14 04:32:24 2016 -0300

    st-hva: fix some error handling in hva_hw_probe()
    
    commit 6b2bed891253c08e7f4c17dbd46b71fc87f22eef upstream.
    
    The devm_ioremap_resource() returns error pointers, never NULL.  The
    platform_get_resource() returns NULL on error, never error pointers.
    The error code needs to be set, as well.  The current code returns
    PTR_ERR(NULL) which is success.
    
    Fixes: 57b2c0628b60 ("[media] st-hva: multi-format video encoder V4L2 driver")
    
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Acked-by: Jean-Christophe Trotin <jean-christophe.trotin@st.com>
    Signed-off-by: Hans Verkuil <hans.verkuil@cisco.com>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b9dc16170dbf5385a273019175c0576d3224cd36
Author: Nicolas Iooss <nicolas.iooss_linux@m4x.org>
Date:   Sat Sep 10 13:59:49 2016 -0300

    ite-cir: initialize use_demodulator before using it
    
    commit 7ec03e60ef81c19b5d3a46dd070ee966774b860f upstream.
    
    Function ite_set_carrier_params() uses variable use_demodulator after
    having initialized it to false in some if branches, but this variable is
    never set to true otherwise.
    
    This bug has been found using clang -Wsometimes-uninitialized warning
    flag.
    
    Fixes: 620a32bba4a2 ("[media] rc: New rc-based ite-cir driver for
    several ITE CIRs")
    
    Signed-off-by: Nicolas Iooss <nicolas.iooss_linux@m4x.org>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 278997a8e002ba1cedf132e86b12acf00137c28a
Author: Wei Yongjun <weiyongjun1@huawei.com>
Date:   Wed Sep 21 10:09:39 2016 -0300

    gs1662: drop kfree for memory allocated with devm_kzalloc
    
    commit df94121f02ecce435d6b5277071eb94b764caa89 upstream.
    
    It's not necessary to free memory allocated with devm_kzalloc
    and using kfree leads to a double free.
    
    Fixes: 7aae6e2df127 ("[media] Add GS1662 driver, a video serializer")
    
    Signed-off-by: Wei Yongjun <weiyongjun1@huawei.com>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cec5ef6ac5202c79d0a95e65d41511a770e8607b
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Mon Sep 19 09:46:30 2016 -0300

    platform: pxa_camera: add VIDEO_V4L2 dependency
    
    commit ff681022c6639c194fbb6893c50ace9e52a44788 upstream.
    
    Moving the pxa_camera driver from soc_camera lots the implied
    VIDEO_V4L2 Kconfig dependency, and building the driver without
    V4L2 results in a kernel that cannot link:
    
    drivers/media/platform/pxa_camera.o: In function `pxa_camera_remove':
    pxa_camera.c:(.text.pxa_camera_remove+0x10): undefined reference to `v4l2_clk_unregister'
    pxa_camera.c:(.text.pxa_camera_remove+0x18): undefined reference to `v4l2_device_unregister'
    drivers/media/platform/pxa_camera.o: In function `pxa_camera_probe':
    pxa_camera.c:(.text.pxa_camera_probe+0x458): undefined reference to `v4l2_of_parse_endpoint'
    drivers/media/v4l2-core/videobuf2-core.o: In function `__enqueue_in_driver':
    drivers/media/v4l2-core/videobuf2-core.o: In function `vb2_core_streamon':
    videobuf2-core.c:(.text.vb2_core_streamon+0x1b4): undefined reference to `v4l_vb2q_enable_media_source'
    drivers/media/v4l2-core/videobuf2-v4l2.o: In function `vb2_ioctl_reqbufs':
    videobuf2-v4l2.c:(.text.vb2_ioctl_reqbufs+0xc): undefined reference to `video_devdata'
    
    This adds back an explicit dependency.
    
    Fixes: 3050b9985024 ("[media] media: platform: pxa_camera: move pxa_camera out of soc_camera")
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Acked-by: Robert Jarzmik <robert.jarzmik@free.fr>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2a306053176853c785d48dfe27da8d1c544723b5
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Jul 14 07:18:14 2016 -0300

    blackfin: check devm_pinctrl_get() for errors
    
    commit c9205e18b41a6ef5ad73e1c4b86a78b2ea3ccb9b upstream.
    
    devm_pinctrl_get() can fail so we should check for that.
    
    Fixes: 0a6824bc10de ('[media] v4l2: blackfin: select proper pinctrl state in ppi_set_params if CONFIG_PINCTRL is enabled')
    
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Mauro Carvalho Chehab <mchehab@s-opensource.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fcdab6ca9c31bc4d2abfa931d9ebde986515dedd
Author: Loic Pallardy <loic.pallardy@st.com>
Date:   Thu Dec 15 15:49:56 2016 +0100

    rpmsg: virtio_rpmsg_bus: fix channel creation
    
    commit 63447646ac657fde00bb658ce21a3431940ae0ad upstream.
    
    Since commit 4dffed5b3ac796b ("rpmsg: Name rpmsg devices based on
    channel id"), it is no more possible for a firmware to register twice
    a service (on different endpoints). rpmsg_register_device function
    is failing when calling device_add for the second time as second
    device has the same name as first one already register.
    It is because name is based only on service name and so is not more
    unique. Previously name was unique thanks to the use of rpmsg_dev_index.
    
    This patch adds destination and source endpoint numbers device name to
    create an unique identifier.
    
    Fixes: 4dffed5b3ac7 ("rpmsg: Name rpmsg devices based on channel id")
    Acked-by: Peter Griffin <peter.griffin@linaro.org>
    Signed-off-by: Loic Pallardy <loic.pallardy@st.com>
    [bjorn: flipped name and address in device name]
    Signed-off-by: Bjorn Andersson <bjorn.andersson@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0f3418442d7bc8050426c733022fd111d8ae1375
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Oct 13 11:30:39 2016 +0300

    mtd: spi-nor: Fix some error codes in cqspi_setup_flash()
    
    commit 10ad1d754a434c024ce7eeb1cec9f69fd3ecc863 upstream.
    
    We return success or possibly uninitialized values on these error paths
    instead of proper error codes.
    
    Fixes: 140623410536 ("mtd: spi-nor: Add driver for Cadence Quad SPI Flash Controller")
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Reviewed-by: Marek Vasut <marex@denx.de>
    Reviewed-by: Moritz Fischer <moritz.fischer@ettus.com>
    Signed-off-by: Cyrille Pitchen <cyrille.pitchen@atmel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e55e6c026b7c49c4dcc33f4ebc330e660ecf3963
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Oct 13 11:06:47 2016 +0300

    mtd: spi-nor: Off by one in cqspi_setup_flash()
    
    commit 193e87143c290ec16838f5368adc0e0bc94eb931 upstream.
    
    There are CQSPI_MAX_CHIPSELECT elements in the ->f_pdata array so the >
    should be >=.
    
    Fixes: 140623410536 ('mtd: spi-nor: Add driver for Cadence Quad SPI Flash Controller')
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Reviewed-by: Marek Vasut <marex@denx.de>
    Signed-off-by: Cyrille Pitchen <cyrille.pitchen@atmel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ebdfcaa14eef97ae0711823524fd8c8865c05933
Author: Chanwoo Choi <cw00.choi@samsung.com>
Date:   Wed Dec 28 20:52:35 2016 +0900

    PM / devfreq: Fix the bug of devfreq_add_device when governor is NULL
    
    commit 73613b16cb5c5d5a659fc8832eff99eead3f9afb upstream.
    
    This patch fixes the bug of devfreq_add_device(). The devfreq device must
    have the default governor. If find_devfreq_governor() returns error,
    devfreq_add_device() fail to add the devfreq instance.
    
    Fixes: 1b5c1be2c88e (PM / devfreq: map devfreq drivers to governor using name)
    Signed-off-by: Chanwoo Choi <cw00.choi@samsung.com>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7959835473173638527f3d294fcccb1b1697bd92
Author: Chanwoo Choi <cw00.choi@samsung.com>
Date:   Wed Dec 28 20:52:36 2016 +0900

    PM / devfreq: exynos-bus: Fix the wrong return value
    
    commit 32dd7731699765f21dbe6df9020e613d4ed73fc3 upstream.
    
    This patch fixes the wrong return value. If devfreq driver requires the wrong
    and non-available governor, it is fail. So, this patch returns the error
    insead of -EPROBE_DEFER.
    
    Fixes: 403e0689d2a9 (PM / devfreq: exynos: Add support of bus frequency of sub-blocks using passive governor)
    Signed-off-by: Chanwoo Choi <cw00.choi@samsung.com>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 16236802bfecb1082144a48b7d6fa60997824662
Author: James Bottomley <James.Bottomley@HansenPartnership.com>
Date:   Sun Jan 1 09:39:24 2017 -0800

    scsi: mpt3sas: fix hang on ata passthrough commands
    
    commit ffb58456589443ca572221fabbdef3db8483a779 upstream.
    
    mpt3sas has a firmware failure where it can only handle one pass through
    ATA command at a time.  If another comes in, contrary to the SAT
    standard, it will hang until the first one completes (causing long
    commands like secure erase to timeout).  The original fix was to block
    the device when an ATA command came in, but this caused a regression
    with
    
    commit 669f044170d8933c3d66d231b69ea97cb8447338
    Author: Bart Van Assche <bart.vanassche@sandisk.com>
    Date:   Tue Nov 22 16:17:13 2016 -0800
    
        scsi: srp_transport: Move queuecommand() wait code to SCSI core
    
    So fix the original fix of the secure erase timeout by properly
    returning SAM_STAT_BUSY like the SAT recommends.  The original patch
    also had a concurrency problem since scsih_qcmd is lockless at that
    point (this is fixed by using atomic bitops to set and test the flag).
    
    [mkp: addressed feedback wrt. test_bit and fixed whitespace]
    
    Fixes: 18f6084a989ba1b (mpt3sas: Fix secure erase premature termination)
    Signed-off-by: James Bottomley <James.Bottomley@HansenPartnership.com>
    Acked-by: Sreekanth Reddy <Sreekanth.Reddy@broadcom.com>
    Reviewed-by: Christoph Hellwig <hch@lst.de>
    Reported-by: Ingo Molnar <mingo@kernel.org>
    Tested-by: Ingo Molnar <mingo@kernel.org>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a07a122ad2a2e03209155fe907bf8b1e6ae4c915
Author: Ewan D. Milne <emilne@redhat.com>
Date:   Mon Jan 9 16:33:36 2017 -0500

    scsi: ses: Fix SAS device detection in enclosure
    
    commit 9373eba6cfae48911b977d14323032cd5d161aae upstream.
    
    The call to scsi_is_sas_rphy() needs to be made on the SAS end_device,
    not on the SCSI device.
    
    Fixes: 835831c57e9b ("ses: use scsi_is_sas_rphy instead of is_sas_attached")
    Signed-off-by: Ewan D. Milne <emilne@redhat.com>
    Reviewed-by: Johannes Thumshirn <jthumshirn@suse.de>
    Reviewed-by: James Bottomley <James.Bottomley@HansenPartnership.com>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 41c6b3e8989e79772a50429d92cf91959bcce96d
Author: Geert Uytterhoeven <geert+renesas@glider.be>
Date:   Fri Dec 16 14:28:42 2016 +0100

    swiotlb: Add swiotlb=noforce debug option
    
    commit fff5d99225107f5f13fe4a9805adc2a1c4b5fb00 upstream.
    
    On architectures like arm64, swiotlb is tied intimately to the core
    architecture DMA support. In addition, ZONE_DMA cannot be disabled.
    
    To aid debugging and catch devices not supporting DMA to memory outside
    the 32-bit address space, add a kernel command line option
    "swiotlb=noforce", which disables the use of bounce buffers.
    If specified, trying to map memory that cannot be used with DMA will
    fail, and a rate-limited warning will be printed.
    
    Note that io_tlb_nslabs is set to 1, which is the minimal supported
    value.
    
    Signed-off-by: Geert Uytterhoeven <geert+renesas@glider.be>
    Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1fd1e6cd63143cf5d198a536d875dfc88ce179bc
Author: Geert Uytterhoeven <geert+renesas@glider.be>
Date:   Fri Dec 16 14:28:41 2016 +0100

    swiotlb: Convert swiotlb_force from int to enum
    
    commit ae7871be189cb41184f1e05742b4a99e2c59774d upstream.
    
    Convert the flag swiotlb_force from an int to an enum, to prepare for
    the advent of more possible values.
    
    Suggested-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
    Signed-off-by: Geert Uytterhoeven <geert+renesas@glider.be>
    Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 776c2b2d165dc64397f3f9b39839920a08578e8f
Author: Alexander Graf <agraf@suse.de>
Date:   Mon Jan 16 12:46:33 2017 +0100

    arm64: Fix swiotlb fallback allocation
    
    commit 524dabe1c68e0bca25ce7b108099e5d89472a101 upstream.
    
    Commit b67a8b29df introduced logic to skip swiotlb allocation when all memory
    is DMA accessible anyway.
    
    While this is a great idea, __dma_alloc still calls swiotlb code unconditionally
    to allocate memory when there is no CMA memory available. The swiotlb code is
    called to ensure that we at least try get_free_pages().
    
    Without initialization, swiotlb allocation code tries to access io_tlb_list
    which is NULL. That results in a stack trace like this:
    
      Unable to handle kernel NULL pointer dereference at virtual address 00000000
      [...]
      [<ffff00000845b908>] swiotlb_tbl_map_single+0xd0/0x2b0
      [<ffff00000845be94>] swiotlb_alloc_coherent+0x10c/0x198
      [<ffff000008099dc0>] __dma_alloc+0x68/0x1a8
      [<ffff000000a1b410>] drm_gem_cma_create+0x98/0x108 [drm]
      [<ffff000000abcaac>] drm_fbdev_cma_create_with_funcs+0xbc/0x368 [drm_kms_helper]
      [<ffff000000abcd84>] drm_fbdev_cma_create+0x2c/0x40 [drm_kms_helper]
      [<ffff000000abc040>] drm_fb_helper_initial_config+0x238/0x410 [drm_kms_helper]
      [<ffff000000abce88>] drm_fbdev_cma_init_with_funcs+0x98/0x160 [drm_kms_helper]
      [<ffff000000abcf90>] drm_fbdev_cma_init+0x40/0x58 [drm_kms_helper]
      [<ffff000000b47980>] vc4_kms_load+0x90/0xf0 [vc4]
      [<ffff000000b46a94>] vc4_drm_bind+0xec/0x168 [vc4]
      [...]
    
    Thankfully swiotlb code just learned how to not do allocations with the FORCE_NO
    option. This patch configures the swiotlb code to use that if we decide not to
    initialize the swiotlb framework.
    
    Fixes: b67a8b29df ("arm64: mm: only initialize swiotlb when necessary")
    Signed-off-by: Alexander Graf <agraf@suse.de>
    CC: Jisheng Zhang <jszhang@marvell.com>
    CC: Geert Uytterhoeven <geert+renesas@glider.be>
    CC: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 962957889d74c161d797dbf418d8d7ded241aaa1
Author: Oleksandr Andrushchenko <Oleksandr_Andrushchenko@epam.com>
Date:   Wed Jan 18 09:09:25 2017 +0200

    arm64: mm: avoid name clash in __page_to_voff()
    
    commit 1c8a946bf3754a59cba1fc373949a8114bfe5aaa upstream.
    
    The arm64 __page_to_voff() macro takes a parameter called 'page', and
    also refers to 'struct page'. Thus, if the value passed in is not
    called 'page', we'll refer to the wrong struct name (which might not
    exist).
    
    Fixes: 3fa72fe9c614 ("arm64: mm: fix __page_to_voff definition")
    Acked-by: Mark Rutland <mark.rutland@arm.com>
    Suggested-by: Volodymyr Babchuk <Volodymyr_Babchuk@epam.com>
    Signed-off-by: Oleksandr Andrushchenko <Oleksandr_Andrushchenko@epam.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d34b6684e60f25ae1e5c189b00f42ed65c5cdbc0
Author: Chuck Lever <chuck.lever@oracle.com>
Date:   Tue Nov 29 10:53:13 2016 -0500

    xprtrdma: Squelch "max send, max recv" messages at connect time
    
    commit 6d6bf72de914059b304f7b99530a7856e5c846aa upstream.
    
    Clean up: This message was intended to be a dprintk, as it is on the
    server-side.
    
    Fixes: 87cfb9a0c85c ('xprtrdma: Client-side support for ...')
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8ade1c2b453019997e9cd367790366a4366491e8
Author: Chuck Lever <chuck.lever@oracle.com>
Date:   Tue Nov 29 10:52:16 2016 -0500

    xprtrdma: Make FRWR send queue entry accounting more accurate
    
    commit 8d38de65644d900199f035277aa5f3da4aa9fc17 upstream.
    
    Verbs providers may perform house-keeping on the Send Queue during
    each signaled send completion. It is necessary therefore for a verbs
    consumer (like xprtrdma) to occasionally force a signaled send
    completion if it runs unsignaled most of the time.
    
    xprtrdma does not require signaled completions for Send or FastReg
    Work Requests, but does signal some LocalInv Work Requests. To
    ensure that Send Queue house-keeping can run before the Send Queue
    is more than half-consumed, xprtrdma forces a signaled completion
    on occasion by counting the number of Send Queue Entries it
    consumes. It currently does this by counting each ib_post_send as
    one Entry.
    
    Commit c9918ff56dfb ("xprtrdma: Add ro_unmap_sync method for FRWR")
    introduced the ability for frwr_op_unmap_sync to post more than one
    Work Request with a single post_send. Thus the underlying assumption
    of one Send Queue Entry per ib_post_send is no longer true.
    
    Also, FastReg Work Requests are currently never signaled. They
    should be signaled once in a while, just as Send is, to keep the
    accounting of consumed SQEs accurate.
    
    While we're here, convert the CQCOUNT macros to the currently
    preferred kernel coding style, which is inline functions.
    
    Fixes: c9918ff56dfb ("xprtrdma: Add ro_unmap_sync method for FRWR")
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a193c72475960dfb98a37d0fc7739a10ccd95111
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Mon Jan 16 19:16:46 2017 +0100

    libceph: make sure ceph_aes_crypt() IV is aligned
    
    commit 124f930b8cbc4ac11236e6eb1c5f008318864588 upstream.
    
    ... otherwise the crypto stack will align it for us with a GFP_ATOMIC
    allocation and a memcpy() -- see skcipher_walk_first().
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6e9fa67c58ccd59df9cc21a8e9a4c4f9aea15fa8
Author: Jeff Layton <jlayton@kernel.org>
Date:   Thu Jan 12 14:42:39 2017 -0500

    ceph: fix endianness bug in frag_tree_split_cmp
    
    commit fe2ed42517533068ac03eed5630fffafff27eacf upstream.
    
    sparse says:
    
        fs/ceph/inode.c:308:36: warning: incorrect type in argument 1 (different base types)
        fs/ceph/inode.c:308:36:    expected unsigned int [unsigned] [usertype] a
        fs/ceph/inode.c:308:36:    got restricted __le32 [usertype] frag
        fs/ceph/inode.c:308:46: warning: incorrect type in argument 2 (different base types)
        fs/ceph/inode.c:308:46:    expected unsigned int [unsigned] [usertype] b
        fs/ceph/inode.c:308:46:    got restricted __le32 [usertype] frag
    
    We need to convert these values to host-endian before calling the
    comparator.
    
    Fixes: a407846ef7c6 ("ceph: don't assume frag tree splits in mds reply are sorted")
    Signed-off-by: Jeff Layton <jlayton@redhat.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2e4f2131b66ffe64ef90d1e85223ef347e355b65
Author: Jeff Layton <jlayton@kernel.org>
Date:   Thu Jan 12 14:42:38 2017 -0500

    ceph: fix endianness of getattr mask in ceph_d_revalidate
    
    commit 1097680d759918ce4a8705381c0ab2ed7bd60cf1 upstream.
    
    sparse says:
    
        fs/ceph/dir.c:1248:50: warning: incorrect type in assignment (different base types)
        fs/ceph/dir.c:1248:50:    expected restricted __le32 [usertype] mask
        fs/ceph/dir.c:1248:50:    got int [signed] [assigned] mask
    
    Fixes: 200fd27c8fa2 ("ceph: use lookup request to revalidate dentry")
    Signed-off-by: Jeff Layton <jlayton@redhat.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8934e069674a09c4ce4a0858e1aee5474784df92
Author: Yan, Zheng <zyan@redhat.com>
Date:   Thu Dec 22 16:05:43 2016 +0800

    ceph: fix ceph_get_caps() interruption
    
    commit 6e09d0fb64402cec579f029ca4c7f39f5c48fc60 upstream.
    
    Commit 5c341ee32881 ("ceph: fix scheduler warning due to nested
    blocking") causes infinite loop when process is interrupted.  Fix it.
    
    Signed-off-by: Yan, Zheng <zyan@redhat.com>
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 48baa924108e124bc5221ca73b72562a8479c11c
Author: Nikolay Borisov <kernel@kyup.com>
Date:   Tue Oct 11 12:04:09 2016 +0300

    ceph: fix scheduler warning due to nested blocking
    
    commit 5c341ee32881c554727ec14b71ec3e8832f01989 upstream.
    
    try_get_cap_refs can be used as a condition in a wait_event* calls.
    This is all fine until it has to call __ceph_do_pending_vmtruncate,
    which in turn acquires the i_truncate_mutex. This leads to a situation
    in which a task's state is !TASK_RUNNING and at the same time it's
    trying to acquire a sleeping primitive. In essence a nested sleeping
    primitives are being used. This causes the following warning:
    
    WARNING: CPU: 22 PID: 11064 at kernel/sched/core.c:7631 __might_sleep+0x9f/0xb0()
    do not call blocking ops when !TASK_RUNNING; state=1 set at [<ffffffff8109447d>] prepare_to_wait_event+0x5d/0x110
     ipmi_msghandler tcp_scalable ib_qib dca ib_mad ib_core ib_addr ipv6
    CPU: 22 PID: 11064 Comm: fs_checker.pl Tainted: G           O    4.4.20-clouder2 #6
    Hardware name: Supermicro X10DRi/X10DRi, BIOS 1.1a 10/16/2015
     0000000000000000 ffff8838b416fa88 ffffffff812f4409 ffff8838b416fad0
     ffffffff81a034f2 ffff8838b416fac0 ffffffff81052b46 ffffffff81a0432c
     0000000000000061 0000000000000000 0000000000000000 ffff88167bda54a0
    Call Trace:
     [<ffffffff812f4409>] dump_stack+0x67/0x9e
     [<ffffffff81052b46>] warn_slowpath_common+0x86/0xc0
     [<ffffffff81052bcc>] warn_slowpath_fmt+0x4c/0x50
     [<ffffffff8109447d>] ? prepare_to_wait_event+0x5d/0x110
     [<ffffffff8109447d>] ? prepare_to_wait_event+0x5d/0x110
     [<ffffffff8107767f>] __might_sleep+0x9f/0xb0
     [<ffffffff81612d30>] mutex_lock+0x20/0x40
     [<ffffffffa04eea14>] __ceph_do_pending_vmtruncate+0x44/0x1a0 [ceph]
     [<ffffffffa04fa692>] try_get_cap_refs+0xa2/0x320 [ceph]
     [<ffffffffa04fd6f5>] ceph_get_caps+0x255/0x2b0 [ceph]
     [<ffffffff81094370>] ? wait_woken+0xb0/0xb0
     [<ffffffffa04f2c11>] ceph_write_iter+0x2b1/0xde0 [ceph]
     [<ffffffff81613f22>] ? schedule_timeout+0x202/0x260
     [<ffffffff8117f01a>] ? kmem_cache_free+0x1ea/0x200
     [<ffffffff811b46ce>] ? iput+0x9e/0x230
     [<ffffffff81077632>] ? __might_sleep+0x52/0xb0
     [<ffffffff81156147>] ? __might_fault+0x37/0x40
     [<ffffffff8119e123>] ? cp_new_stat+0x153/0x170
     [<ffffffff81198cfa>] __vfs_write+0xaa/0xe0
     [<ffffffff81199369>] vfs_write+0xa9/0x190
     [<ffffffff811b6d01>] ? set_close_on_exec+0x31/0x70
     [<ffffffff8119a056>] SyS_write+0x46/0xa0
    
    This happens since wait_event_interruptible can interfere with the
    mutex locking code, since they both fiddle with the task state.
    
    Fix the issue by using the newly-added nested blocking infrastructure
    in 61ada528dea0 ("sched/wait: Provide infrastructure to deal with
    nested blocking")
    
    Link: https://lwn.net/Articles/628628/
    Signed-off-by: Nikolay Borisov <kernel@kyup.com>
    Signed-off-by: Yan, Zheng <zyan@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 04c9fe63166fa9a3004e770c36ec1eb7cdfd5465
Author: Linus Walleij <linus.walleij@linaro.org>
Date:   Tue Sep 13 12:31:17 2016 +0100

    ARM: 8613/1: Fix the uaccess crash on PB11MPCore
    
    commit 90f92c631b210c1e97080b53a9d863783281a932 upstream.
    
    The following patch was sketched by Russell in response to my
    crashes on the PB11MPCore after the patch for software-based
    priviledged no access support for ARMv8.1. See this thread:
    http://marc.info/?l=linux-arm-kernel&m=144051749807214&w=2
    
    I am unsure what is going on, I suspect everyone involved in
    the discussion is. I just want to repost this to get the
    discussion restarted, as I still have to apply this patch
    with every kernel iteration to get my PB11MPCore Realview
    running.
    
    Testing by Neil Armstrong on the Oxnas NAS has revealed that
    this bug exist also on that widely deployed hardware, so
    we are probably currently regressing all ARM11MPCore systems.
    
    Cc: Russell King <linux@armlinux.org.uk>
    Cc: Will Deacon <will.deacon@arm.com>
    Fixes: a5e090acbf54 ("ARM: software-based priviledged-no-access support")
    Tested-by: Neil Armstrong <narmstrong@baylibre.com>
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
    Signed-off-by: Russell King <rmk+kernel@arm.linux.org.uk>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dd8334a5e17e291f503cada56a0d6aed3ddb3c12
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Wed Nov 16 16:20:37 2016 +0100

    ARM: ux500: fix prcmu_is_cpu_in_wfi() calculation
    
    commit f0e8faa7a5e894b0fc99d24be1b18685a92ea466 upstream.
    
    This function clearly never worked and always returns true,
    as pointed out by gcc-7:
    
    arch/arm/mach-ux500/pm.c: In function 'prcmu_is_cpu_in_wfi':
    arch/arm/mach-ux500/pm.c:137:212: error: ?:
    using integer constants in boolean context, the expression
    will always evaluate to 'true' [-Werror=int-in-bool-context]
    
    With the added braces, the condition actually makes sense.
    
    Fixes: 34fe6f107eab ("mfd : Check if the other db8500 core is in WFI")
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Acked-by: Daniel Lezcano <daniel.lezcano@linaro.org>
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cd9601caa2fa45e768ec6bf1fa1375bbb566466f
Author: Adam Ford <aford173@gmail.com>
Date:   Tue Jan 17 13:34:06 2017 -0600

    ARM: dts: omap3: Fix Card Detect and Write Protect on Logic PD SOM-LV
    
    commit 1ea6af3216b092ec97129ac81bd95cf254c4b140 upstream.
    
    This fixes commit ab8dd3aed011 ("ARM: DTS: Add minimal Support for
    Logic PD DM3730 SOM-LV") where the Card Detect and Write Protect
    pins were improperly configured.
    
    Fixes: ab8dd3aed011 ("ARM: DTS: Add minimal Support for Logic PD DM3730 SOM-LV")
    Signed-off-by: Adam Ford <aford173@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a075ac9c0a40f20ad14f052ee34e88922703ed20
Author: Gary Bisson <gary.bisson@boundarydevices.com>
Date:   Tue Jan 3 12:22:46 2017 +0100

    ARM: dts: imx6qdl-nitrogen6_max: fix sgtl5000 pinctrl init
    
    commit 6ab5c2b662e2dcbb964099bf7f19e9dbc9ae5a41 upstream.
    
    This patch fixes the following error:
    sgtl5000 0-000a: Error reading chip id -6
    imx-sgtl5000 sound: ASoC: CODEC DAI sgtl5000 not registered
    imx-sgtl5000 sound: snd_soc_register_card failed (-517)
    
    The problem was that the pinctrl group was linked to the sound driver
    instead of the codec node. Since the codec is probed first, the sys_mclk
    was missing and it would therefore fail to initialize.
    
    Fixes: b32e700256bc ("ARM: dts: imx: add Boundary Devices Nitrogen6_Max board")
    Signed-off-by: Gary Bisson <gary.bisson@boundarydevices.com>
    Signed-off-by: Shawn Guo <shawnguo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cfcb94b3a498108364db1ad1c36742e86d0c5c4c
Author: Javier Martinez Canillas <javier@osg.samsung.com>
Date:   Mon Dec 19 11:44:33 2016 -0300

    ARM: dts: omap2: Add an empty chosen node to top level DTSI
    
    commit 3d37d41a148c32389ed360e10a9f8a7cd37ce166 upstream.
    
    Commit d1f3156fc8c7 ("ARM: dts: omap2: Remove skeleton.dtsi usage")
    removed the skeleton.dtsi usage since we want to get rid of it.
    
    But this can cause issues when booting a kernel with a boot-loader
    that doesn't create a chosen node if this isn't present in the DTB
    since the decompressor relies on a pre-existing chosen node to be
    available to insert the command line and merge other ATAGS info.
    
    Fixes: d1f3156fc8c7 ("ARM: dts: omap2: Remove skeleton.dtsi usage")
    Reported-by: Pali Rohar <pali.rohar@gmail.com>
    Signed-off-by: Javier Martinez Canillas <javier@osg.samsung.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5921b26bf7445591055bbe385b91d2ea866e7278
Author: Javier Martinez Canillas <javier@osg.samsung.com>
Date:   Mon Dec 19 11:44:34 2016 -0300

    ARM: dts: omap3: Add an empty chosen node to top level DTSI
    
    commit 23ab4c6183ac0679d80888b5c4cc1d528fcc21c2 upstream.
    
    Commit 008a2ebcd677 ("ARM: dts: omap3: Remove skeleton.dtsi usage")
    removed the skeleton.dtsi usage since we want to get rid of it.
    
    But this can cause issues when booting a kernel with a boot-loader
    that doesn't create a chosen node if this isn't present in the DTB
    since the decompressor relies on a pre-existing chosen node to be
    available to insert the command line and merge other ATAGS info.
    
    Fixes: 008a2ebcd677 ("ARM: dts: omap3: Remove skeleton.dtsi usage")
    Reported-by: Pali Rohar <pali.rohar@gmail.com>
    Signed-off-by: Javier Martinez Canillas <javier@osg.samsung.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bec062cd47bd0184ec88a80c06f695acae8999ff
Author: Javier Martinez Canillas <javier@osg.samsung.com>
Date:   Mon Dec 19 11:44:38 2016 -0300

    ARM: dts: am4372: Add an empty chosen node to top level DTSI
    
    commit ce95077d0cdfcc8e40dea10a1680249831ccec77 upstream.
    
    Commit 75813028bbd7 ("ARM: dts: am4372: Remove skeleton.dtsi usage")
    removed the skeleton.dtsi usage since we want to get rid of it.
    
    But this can cause issues when booting a kernel with a boot-loader
    that doesn't create a chosen node if this isn't present in the DTB
    since the decompressor relies on a pre-existing chosen node to be
    available to insert the command line and merge other ATAGS info.
    
    Fixes: 75813028bbd7 ("ARM: dts: am4372: Remove skeleton.dtsi usage")
    Reported-by: Pali Rohar <pali.rohar@gmail.com>
    Signed-off-by: Javier Martinez Canillas <javier@osg.samsung.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c3f7ca43b2d4eaf797d11d815326f78d092371ea
Author: Javier Martinez Canillas <javier@osg.samsung.com>
Date:   Mon Dec 19 11:44:36 2016 -0300

    ARM: dts: omap5: Add an empty chosen node to top level DTSI
    
    commit c9faa84cb9c34852ad70cb175457ae21fc06f39b upstream.
    
    Commit 76a8548ea987 ("ARM: dts: omap5: Remove skeleton.dtsi usage")
    removed the skeleton.dtsi usage since we want to get rid of it.
    
    But this can cause issues when booting a kernel with a boot-loader
    that doesn't create a chosen node if this isn't present in the DTB
    since the decompressor relies on a pre-existing chosen node to be
    available to insert the command line and merge other ATAGS info.
    
    Fixes: 76a8548ea987 ("ARM: dts: omap5: Remove skeleton.dtsi usage")
    Reported-by: Pali Rohar <pali.rohar@gmail.com>
    Signed-off-by: Javier Martinez Canillas <javier@osg.samsung.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 835bf872d924a8442ef6d9c8fb078a5eed48c8a1
Author: Javier Martinez Canillas <javier@osg.samsung.com>
Date:   Mon Dec 19 11:44:35 2016 -0300

    ARM: dts: omap4: Add an empty chosen node to top level DTSI
    
    commit 6c565d1a63ce241a0100f5d327c48dde87b4df76 upstream.
    
    Commit da6269e7e3dd ("ARM: dts: omap4: Remove skeleton.dtsi usage")
    removed the skeleton.dtsi usage since we want to get rid of it.
    
    But this can cause issues when booting a kernel with a boot-loader
    that doesn't create a chosen node if this isn't present in the DTB
    since the decompressor relies on a pre-existing chosen node to be
    available to insert the command line and merge other ATAGS info.
    
    Fixes: da6269e7e3dd ("ARM: dts: omap4: Remove skeleton.dtsi usage")
    Reported-by: Pali Rohar <pali.rohar@gmail.com>
    Signed-off-by: Javier Martinez Canillas <javier@osg.samsung.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 355a8fced2bf8d0c242b8a9baffa7f07abc6ca12
Author: Javier Martinez Canillas <javier@osg.samsung.com>
Date:   Mon Dec 19 11:44:37 2016 -0300

    ARM: dts: am33xx: Add an empty chosen node to top level DTSI
    
    commit 1d8d6d3f2f7d553c479f24ab93767974a8c2dfad upstream.
    
    Commit f8bf01611c99 ("ARM: dts: am33xx: Remove skeleton.dtsi usage")
    removed the skeleton.dtsi usage since we want to get rid of it.
    
    But this can cause issues when booting a kernel with a boot-loader
    that doesn't create a chosen node if this isn't present in the DTB
    since the decompressor relies on a pre-existing chosen node to be
    available to insert the command line and merge other ATAGS info.
    
    Fixes: f8bf01611c99 ("ARM: dts: am33xx: Remove skeleton.dtsi usage")
    Reported-by: Pali Rohar <pali.rohar@gmail.com>
    Signed-off-by: Javier Martinez Canillas <javier@osg.samsung.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3e1c70972204add48a338ee9170a6c0358304e9a
Author: Javier Martinez Canillas <javier@osg.samsung.com>
Date:   Mon Dec 19 11:44:39 2016 -0300

    ARM: dts: dm814x: Add an empty chosen node to top level DTSI
    
    commit 9536fd30d41ae4f30d04762676e5f5f602e16aa8 upstream.
    
    Commit 76155b378c59 ("ARM: dts: dm814x: Remove skeleton.dtsi usage")
    removed the skeleton.dtsi usage since we want to get rid of it.
    
    But this can cause issues when booting a kernel with a boot-loader
    that doesn't create a chosen node if this isn't present in the DTB
    since the decompressor relies on a pre-existing chosen node to be
    available to insert the command line and merge other ATAGS info.
    
    Fixes: 76155b378c59 ("ARM: dts: dm814x: Remove skeleton.dtsi usage")
    Reported-by: Pali Rohar <pali.rohar@gmail.com>
    Signed-off-by: Javier Martinez Canillas <javier@osg.samsung.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ab6dc01db1f7df8957e451af93ece9327135bbac
Author: Javier Martinez Canillas <javier@osg.samsung.com>
Date:   Mon Dec 19 11:44:40 2016 -0300

    ARM: dts: dm816x: Add an empty chosen node to top level DTSI
    
    commit 6ed80b3a232e61da6d0189bbbe2b2b9afaefe3b3 upstream.
    
    Commit 06bfb9c19957 ("ARM: dts: dm816x: Remove skeleton.dtsi usage")
    removed the skeleton.dtsi usage since we want to get rid of it.
    
    But this can cause issues when booting a kernel with a boot-loader
    that doesn't create a chosen node if this isn't present in the DTB
    since the decompressor relies on a pre-existing chosen node to be
    available to insert the command line and merge other ATAGS info.
    
    Fixes: 06bfb9c19957 ("ARM: dts: dm816x: Remove skeleton.dtsi usage")
    Reported-by: Pali Rohar <pali.rohar@gmail.com>
    Signed-off-by: Javier Martinez Canillas <javier@osg.samsung.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d4f12aa133dbac336925ce7c1929b141819dcebf
Author: Javier Martinez Canillas <javier@osg.samsung.com>
Date:   Mon Dec 19 11:44:41 2016 -0300

    ARM: dts: dra7: Add an empty chosen node to top level DTSI
    
    commit 7f6c857b12911ed56b2056f9d5491e16b5fc95ea upstream.
    
    Commit 55871eb6e2cc ("ARM: dts: dra7: Remove skeleton.dtsi usage")
    removed the skeleton.dtsi usage since we want to get rid of it.
    
    But this can cause issues when booting a kernel with a boot-loader
    that doesn't create a chosen node if this isn't present in the DTB
    since the decompressor relies on a pre-existing chosen node to be
    available to insert the command line and merge other ATAGS info.
    
    Fixes: 55871eb6e2cc ("ARM: dts: dra7: Remove skeleton.dtsi usage")
    Reported-by: Pali Rohar <pali.rohar@gmail.com>
    Signed-off-by: Javier Martinez Canillas <javier@osg.samsung.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b8add6715c9ada1619e6db6d4e106c03df94267c
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:08 2016 +0100

    libceph: remove now unused ceph_*{en,de}crypt*() functions
    
    commit 2b1e1a7cd0a615d57455567a549f9965023321b5 upstream.
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2982b9c92a66604ffb9fb2db54cf735133d1ef56
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:08 2016 +0100

    libceph: switch ceph_x_decrypt() to ceph_crypt()
    
    commit e15fd0a11db00fc7f470a9fc804657ec3f6d04a5 upstream.
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 717a145bd5a92e3aae1dae1535b83ec38a85fa1b
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:07 2016 +0100

    libceph: switch ceph_x_encrypt() to ceph_crypt()
    
    commit d03857c63bb036edff0aa7a107276360173aca4e upstream.
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6e371f9a4144c1097a675ca482fc90cbcb0fb4e7
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:07 2016 +0100

    libceph: tweak calcu_signature() a little
    
    commit 4eb4517ce7c9c573b6c823de403aeccb40018cfc upstream.
    
    - replace an ad-hoc array with a struct
    - rename to calc_signature() for consistency
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 788a0bbc70115d2964d1b708720b30fd9f91b6ae
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:07 2016 +0100

    libceph: rename and align ceph_x_authorizer::reply_buf
    
    commit 7882a26d2e2e520099e2961d5e2e870f8e4172dc upstream.
    
    It's going to be used as a temporary buffer for in-place en/decryption
    with ceph_crypt() instead of on-stack buffers, so rename to enc_buf.
    Ensure alignment to avoid GFP_ATOMIC allocations in the crypto stack.
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ecf7ced8562811576cd02158d6ae8e44c1fb4671
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:07 2016 +0100

    libceph: introduce ceph_crypt() for in-place en/decryption
    
    commit a45f795c65b479b4ba107b6ccde29b896d51ee98 upstream.
    
    Starting with 4.9, kernel stacks may be vmalloced and therefore not
    guaranteed to be physically contiguous; the new CONFIG_VMAP_STACK
    option is enabled by default on x86.  This makes it invalid to use
    on-stack buffers with the crypto scatterlist API, as sg_set_buf()
    expects a logical address and won't work with vmalloced addresses.
    
    There isn't a different (e.g. kvec-based) crypto API we could switch
    net/ceph/crypto.c to and the current scatterlist.h API isn't getting
    updated to accommodate this use case.  Allocating a new header and
    padding for each operation is a non-starter, so do the en/decryption
    in-place on a single pre-assembled (header + data + padding) heap
    buffer.  This is explicitly supported by the crypto API:
    
        "... the caller may provide the same scatter/gather list for the
         plaintext and cipher text. After the completion of the cipher
         operation, the plaintext data is replaced with the ciphertext data
         in case of an encryption and vice versa for a decryption."
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0548b82989384a58e749f0c04781b2c823c6c1b9
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:07 2016 +0100

    libceph: introduce ceph_x_encrypt_offset()
    
    commit 55d9cc834f933698fc864f0d36f3cca533d30a8d upstream.
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit be60457612a22a040103bc98b1ebc72d95d4d6e0
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:06 2016 +0100

    libceph: old_key in process_one_ticket() is redundant
    
    commit 462e650451c577d15eeb4d883d70fa9e4e529fad upstream.
    
    Since commit 0a990e709356 ("ceph: clean up service ticket decoding"),
    th->session_key isn't assigned until everything is decoded.
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2e62bf3c6fe94b9c7fd37beac4b8b8fcd3f72d71
Author: Ilya Dryomov <idryomov@gmail.com>
Date:   Fri Dec 2 16:35:06 2016 +0100

    libceph: ceph_x_encrypt_buflen() takes in_len
    
    commit 36721ece1e84a25130c4befb930509b3f96de020 upstream.
    
    Pass what's going to be encrypted - that's msg_b, not ticket_blob.
    ceph_x_encrypt_buflen() returns the upper bound, so this doesn't change
    the maxlen calculation, but makes it a bit clearer.
    
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6d9b544d88a4a697211062fc2ab2eb0e28c01b13
Author: Paul Donohue <linux-kernel@PaulSD.com>
Date:   Mon Nov 28 20:11:25 2016 -0800

    Input: ALPS - fix TrackStick support for SS5 hardware
    
    commit 864db9295b06837d11a260e5dacf99a3fdf6bce2 upstream.
    
    The current Alps SS5 (SS4 v2) code generates bogus TouchPad events when
    TrackStick packets are processed.
    
    This causes the xorg synaptics driver to print
    "unable to find touch point 0" and
    "BUG: triggered 'if (priv->num_active_touches > priv->num_slots)'"
    messages.  It also causes unexpected TouchPad button release and re-click
    event sequences if the TrackStick is moved while holding a TouchPad
    button.
    
    This commit corrects the problem by adjusting alps_process_packet_ss4_v2()
    so that it only sends TrackStick reports when processing TrackStick
    packets.
    
    Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
    Signed-off-by: Paul Donohue <linux-kernel@PaulSD.com>
    Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6e53a62a0d529fb5cf8df8304ef02b691fb2736c
Author: Dave Martin <Dave.Martin@arm.com>
Date:   Wed Jan 18 16:25:24 2017 +0000

    arm64/ptrace: Reject attempts to set incomplete hardware breakpoint fields
    
    commit ad9e202aa1ce571b1d7fed969d06f66067f8a086 upstream.
    
    We cannot preserve partial fields for hardware breakpoints, because
    the values written by userspace to the hardware breakpoint
    registers can't subsequently be recovered intact from the hardware.
    
    So, just reject attempts to write incomplete fields with -EINVAL.
    
    Fixes: 478fcb2cdb23 ("arm64: Debugging support")
    Signed-off-by: Dave Martin <Dave.Martin@arm.com>
    Acked-by: Will Deacon <Will.Deacon@arm.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f9081dd0c8be396428e04cd1e9ca5e4c86e375d4
Author: Dave Martin <Dave.Martin@arm.com>
Date:   Wed Jan 18 16:25:23 2017 +0000

    arm64/ptrace: Avoid uninitialised struct padding in fpr_set()
    
    commit aeb1f39d814b2e21e5e5706a48834bfd553d0059 upstream.
    
    This patch adds an explicit __reserved[] field to user_fpsimd_state
    to replace what was previously unnamed padding.
    
    This ensures that data in this region are propagated across
    assignment rather than being left possibly uninitialised at the
    destination.
    
    Fixes: 60ffc30d5652 ("arm64: Exception handling")
    Signed-off-by: Dave Martin <Dave.Martin@arm.com>
    Acked-by: Will Deacon <Will.Deacon@arm.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5c5839be08423b8a76d40beb59165e7993b4d455
Author: Dave Martin <Dave.Martin@arm.com>
Date:   Wed Jan 18 16:25:22 2017 +0000

    arm64/ptrace: Preserve previous registers for short regset write - 3
    
    commit a672401c00f82e4e19704aff361d9bad18003714 upstream.
    
    Ensure that if userspace supplies insufficient data to
    PTRACE_SETREGSET to fill all the registers, the thread's old
    registers are preserved.
    
    Fixes: 5d220ff9420f ("arm64: Better native ptrace support for compat tasks")
    Signed-off-by: Dave Martin <Dave.Martin@arm.com>
    Acked-by: Will Deacon <Will.Deacon@arm.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a4aafb8c4204c3a672b3340ae66e731148a30cd1
Author: Dave Martin <Dave.Martin@arm.com>
Date:   Wed Jan 18 16:25:21 2017 +0000

    arm64/ptrace: Preserve previous registers for short regset write - 2
    
    commit 9dd73f72f218320c6c90da5f834996e7360dc227 upstream.
    
    Ensure that if userspace supplies insufficient data to
    PTRACE_SETREGSET to fill all the registers, the thread's old
    registers are preserved.
    
    Fixes: 766a85d7bc5d ("arm64: ptrace: add NT_ARM_SYSTEM_CALL regset")
    Signed-off-by: Dave Martin <Dave.Martin@arm.com>
    Acked-by: Will Deacon <Will.Deacon@arm.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 357cfd6c83ee601f88f741b026c3301d6ca564e0
Author: Dave Martin <Dave.Martin@arm.com>
Date:   Wed Jan 18 16:25:20 2017 +0000

    arm64/ptrace: Preserve previous registers for short regset write
    
    commit 9a17b876b573441bfb3387ad55d98bf7184daf9d upstream.
    
    Ensure that if userspace supplies insufficient data to
    PTRACE_SETREGSET to fill all the registers, the thread's old
    registers are preserved.
    
    Fixes: 478fcb2cdb23 ("arm64: Debugging support")
    Signed-off-by: Dave Martin <Dave.Martin@arm.com>
    Acked-by: Will Deacon <Will.Deacon@arm.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit de327948c009792ea49b07139c21e3a953137344
Author: Mark Rutland <mark.rutland@arm.com>
Date:   Wed Jan 18 17:23:41 2017 +0000

    arm64: avoid returning from bad_mode
    
    commit 7d9e8f71b989230bc613d121ca38507d34ada849 upstream.
    
    Generally, taking an unexpected exception should be a fatal event, and
    bad_mode is intended to cater for this. However, it should be possible
    to contain unexpected synchronous exceptions from EL0 without bringing
    the kernel down, by sending a SIGILL to the task.
    
    We tried to apply this approach in commit 9955ac47f4ba1c95 ("arm64:
    don't kill the kernel on a bad esr from el0"), by sending a signal for
    any bad_mode call resulting from an EL0 exception.
    
    However, this also applies to other unexpected exceptions, such as
    SError and FIQ. The entry paths for these exceptions branch to bad_mode
    without configuring the link register, and have no kernel_exit. Thus, if
    we take one of these exceptions from EL0, bad_mode will eventually
    return to the original user link register value.
    
    This patch fixes this by introducing a new bad_el0_sync handler to cater
    for the recoverable case, and restoring bad_mode to its original state,
    whereby it calls panic() and never returns. The recoverable case
    branches to bad_el0_sync with a bl, and returns to userspace via the
    usual ret_to_user mechanism.
    
    Signed-off-by: Mark Rutland <mark.rutland@arm.com>
    Fixes: 9955ac47f4ba1c95 ("arm64: don't kill the kernel on a bad esr from el0")
    Reported-by: Mark Salter <msalter@redhat.com>
    Cc: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 71c49649551460f484c97f79c4fd51728ae55495
Author: Fabien Parent <fparent@baylibre.com>
Date:   Tue Jan 17 13:57:42 2017 +0100

    ARM: dts: da850-evm: fix read access to SPI flash
    
    commit 43849785e1079f6606a31cb7fda92d1200849728 upstream.
    
    Read access to the SPI flash are broken on da850-evm, i.e. the data
    read is not what is actually programmed on the flash.
    According to the datasheet for the M25P64 part present on the da850-evm,
    if the SPI frequency is higher than 20MHz then the READ command is not
    usable anymore and only the FAST_READ command can be used to read data.
    
    This commit specifies in the DTS that we should use FAST_READ command
    instead of the READ command.
    
    Tested-by: Kevin Hilman <khilman@baylibre.com>
    Signed-off-by: Fabien Parent <fparent@baylibre.com>
    [nsekhar@ti.com: subject line adjustment]
    Signed-off-by: Sekhar Nori <nsekhar@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    
    Signed-off-by: Olof Johansson <olof@lixom.net>

commit 5b66186152158076de6a1405329b255a327dd538
Author: Jean-Jacques Hiblot <jjhiblot@ti.com>
Date:   Mon Jan 9 13:22:15 2017 +0100

    ARM: dts: OMAP5 / DRA7: indicate that SATA port 0 is available.
    
    commit 87cb12910a2ab6ed41ae951ea4d9c1cc1120199a upstream.
    
    AHCI provides the register PORTS_IMPL to let the software know which port
    is supported. The register must be initialized by the bootloader. However
    in some cases u-boot doesn't properly initialize this value (if it is not
    compiled with SATA support for example or if the SATA initialization fails).
    The DTS entry "ports-implemented" can be used to override the value in
    PORTS_IMPL.
    
    Without this patch the SATA will not work in the following two cases:
    
    * if there has been a failure to initialize SATA in u-boot.
    
    * if ahci_platform module has been removed and re-inserted. The reason is
      that the content of PORTS_IMPL is lost after the module is removed.
      I suspect that it's because the controller is reset by the hwmod.
    
    Signed-off-by: Jean-Jacques Hiblot <jjhiblot@ti.com>
    Acked-by: Roger Quadros <rogerq@ti.com>
    [tony@atomide.com: updated comments with what goes wrong]
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1f75575aca7be589881cda14344b978b42cbceb5
Author: Jeff Layton <jlayton@kernel.org>
Date:   Thu Jan 12 14:42:41 2017 -0500

    ceph: fix bad endianness handling in parse_reply_info_extra
    
    commit 6df8c9d80a27cb587f61b4f06b57e248d8bc3f86 upstream.
    
    sparse says:
    
        fs/ceph/mds_client.c:291:23: warning: restricted __le32 degrades to integer
        fs/ceph/mds_client.c:293:28: warning: restricted __le32 degrades to integer
        fs/ceph/mds_client.c:294:28: warning: restricted __le32 degrades to integer
        fs/ceph/mds_client.c:296:28: warning: restricted __le32 degrades to integer
    
    The op value is __le32, so we need to convert it before comparing it.
    
    Signed-off-by: Jeff Layton <jlayton@redhat.com>
    Reviewed-by: Sage Weil <sage@redhat.com>
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a14aeccb65e5dacdd8b47eafc2778b1bfce8978b
Author: Bryant G. Ly <bryantly@linux.vnet.ibm.com>
Date:   Wed Jan 11 13:52:27 2017 -0600

    ibmvscsis: Fix max transfer length
    
    commit 387b978cb0d12cf3720ecb17e652e0a9991a08e2 upstream.
    
    Current code incorrectly calculates the max transfer length, since
    it is assuming a 4k page table, but ppc64 all run on 64k page tables.
    
    Reported-by: Steven Royer <seroyer@linux.vnet.ibm.com>
    Tested-by: Steven Royer <seroyer@linux.vnet.ibm.com>
    Signed-off-by: Bryant G. Ly <bryantly@linux.vnet.ibm.com>
    Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 51cff2c64d20ba65af768b4d922b98cb7baf947e
Author: Bryant G. Ly <bryantly@linux.vnet.ibm.com>
Date:   Wed Jan 11 13:16:42 2017 -0600

    ibmvscsis: Fix sleeping in interrupt context
    
    commit a5b0e4062fb225155189e593699bbfcd0597f8b5 upstream.
    
    Currently, dma_alloc_coherent is being called with a GFP_KERNEL
    flag which allows it to sleep in an interrupt context, need to
    change to GFP_ATOMIC.
    
    Tested-by: Steven Royer <seroyer@linux.vnet.ibm.com>
    Reviewed-by: Michael Cyr <mikecyr@linux.vnet.ibm.com>
    Signed-off-by: Bryant G. Ly <bryantly@linux.vnet.ibm.com>
    Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit df35a8f51fcbad255df9ac541eef2e84182a4c50
Author: Mark Rutland <mark.rutland@arm.com>
Date:   Fri Jan 6 13:12:47 2017 +0100

    ARM: 8634/1: hw_breakpoint: blacklist Scorpion CPUs
    
    commit ddc37832a1349f474c4532de381498020ed71d31 upstream.
    
    On APQ8060, the kernel crashes in arch_hw_breakpoint_init, taking an
    undefined instruction trap within write_wb_reg. This is because Scorpion
    CPUs erroneously appear to set DBGPRSR.SPD when WFI is issued, even if
    the core is not powered down. When DBGPRSR.SPD is set, breakpoint and
    watchpoint registers are treated as undefined.
    
    It's possible to trigger similar crashes later on from userspace, by
    requesting the kernel to install a breakpoint or watchpoint, as we can
    go idle at any point between the reset of the debug registers and their
    later use. This has always been the case.
    
    Given that this has always been broken, no-one has complained until now,
    and there is no clear workaround, disable hardware breakpoints and
    watchpoints on Scorpion to avoid these issues.
    
    Signed-off-by: Mark Rutland <mark.rutland@arm.com>
    Reported-by: Linus Walleij <linus.walleij@linaro.org>
    Reviewed-by: Stephen Boyd <sboyd@codeaurora.org>
    Acked-by: Will Deacon <will.deacon@arm.com>
    Cc: Russell King <linux@armlinux.org.uk>
    Signed-off-by: Russell King <rmk+kernel@arm.linux.org.uk>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 73a2e2405d300931f9e30ae439dcda21f592d110
Author: Sriharsha Basavapatna <sriharsha.basavapatna@broadcom.com>
Date:   Mon Jan 9 16:00:44 2017 +0530

    svcrdma: avoid duplicate dma unmapping during error recovery
    
    commit ce1ca7d2d140a1f4aaffd297ac487f246963dd2f upstream.
    
    In rdma_read_chunk_frmr() when ib_post_send() fails, the error code path
    invokes ib_dma_unmap_sg() to unmap the sg list. It then invokes
    svc_rdma_put_frmr() which in turn tries to unmap the same sg list through
    ib_dma_unmap_sg() again. This second unmap is invalid and could lead to
    problems when the iova being unmapped is subsequently reused. Remove
    the call to unmap in rdma_read_chunk_frmr() and let svc_rdma_put_frmr()
    handle it.
    
    Fixes: 412a15c0fe53 ("svcrdma: Port to new memory registration API")
    Signed-off-by: Sriharsha Basavapatna <sriharsha.basavapatna@broadcom.com>
    Reviewed-by: Chuck Lever <chuck.lever@oracle.com>
    Reviewed-by: Yuval Shaia <yuval.shaia@oracle.com>
    Signed-off-by: J. Bruce Fields <bfields@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c49b31b585a17fd59227a23bd98b7c834947e851
Author: Joonyoung Shim <jy0922.shim@samsung.com>
Date:   Tue Jan 17 13:54:36 2017 +0900

    clocksource/exynos_mct: Clear interrupt when cpu is shut down
    
    commit bc7c36eedb0c7004aa06c2afc3c5385adada8fa3 upstream.
    
    When a CPU goes offline a potentially pending timer interrupt is not
    cleared. When the CPU comes online again then the pending interrupt is
    delivered before the per cpu clockevent device is initialized. As a
    consequence the tick interrupt handler dereferences a NULL pointer.
    
    [   51.251378] Unable to handle kernel NULL pointer dereference at virtual address 00000040
    [   51.289348] task: ee942d00 task.stack: ee960000
    [   51.293861] PC is at tick_periodic+0x38/0xb0
    [   51.298102] LR is at tick_handle_periodic+0x1c/0x90
    
    Clear the pending interrupt in the cpu dying path.
    
    Fixes: 56a94f13919c ("clocksource: exynos_mct: Avoid blocking calls in the cpu hotplug notifier")
    Reported-by: Seung-Woo Kim <sw0312.kim@samsung.com>
    Signed-off-by: Joonyoung Shim <jy0922.shim@samsung.com>
    Cc: linux-samsung-soc@vger.kernel.org
    Cc: cw00.choi@samsung.com
    Cc: daniel.lezcano@linaro.org
    Cc: javier@osg.samsung.com
    Cc: kgene@kernel.org
    Cc: krzk@kernel.org
    Cc: linux-arm-kernel@lists.infradead.org
    Link: http://lkml.kernel.org/r/1484628876-22065-1-git-send-email-jy0922.shim@samsung.com
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ce5c52f039cf886ac1f2a2535bb4e02ebcefe043
Author: Richard Weinberger <richard@nod.at>
Date:   Tue Jan 10 11:49:40 2017 +0100

    ubifs: Fix journal replay wrt. xattr nodes
    
    commit 1cb51a15b576ee325d527726afff40947218fd5e upstream.
    
    When replaying the journal it can happen that a journal entry points to
    a garbage collected node.
    This is the case when a power-cut occurred between a garbage collect run
    and a commit. In such a case nodes have to be read using the failable
    read functions to detect whether the found node matches what we expect.
    
    One corner case was forgotten, when the journal contains an entry to
    remove an inode all xattrs have to be removed too. UBIFS models xattr
    like directory entries, so the TNC code iterates over
    all xattrs of the inode and removes them too. This code re-uses the
    functions for walking directories and calls ubifs_tnc_next_ent().
    ubifs_tnc_next_ent() expects to be used only after the journal and
    aborts when a node does not match the expected result. This behavior can
    render an UBIFS volume unmountable after a power-cut when xattrs are
    used.
    
    Fix this issue by using failable read functions in ubifs_tnc_next_ent()
    too when replaying the journal.
    Fixes: 1e51764a3c2ac05a ("UBIFS: add new flash file system")
    Reported-by: Rock Lee <rockdotlee@gmail.com>
    Reviewed-by: David Gstir <david@sigma-star.at>
    Signed-off-by: Richard Weinberger <richard@nod.at>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bab10a549fd64e36f06c995d6adf22c0413e9379
Author: Johannes Berg <johannes.berg@intel.com>
Date:   Wed Dec 14 16:47:43 2016 +0100

    mac80211: implement multicast forwarding on fast-RX path
    
    commit eeb0d56fab4cd7848cf2be6704fa48900dbc1381 upstream.
    
    In AP (or VLAN) mode, when unicast 802.11 packets are received,
    they might actually be multicast after conversion. In this case
    the fast-RX path didn't handle them properly to send them back
    to the wireless medium. Implement that by copying the SKB and
    sending it back out.
    
    The possible alternative would be to just punt the packet back
    to the regular (slow) RX path, but since we have almost all of
    the required code here already it's not so complicated to add
    here. Punting it back would also mean acquiring the spinlock,
    which would be bad for the stated purpose of the fast-RX path,
    to enable well-performing parallel RX.
    
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit beecb1e72cc5af0921c9daf75c404408744822cd
Author: Quinn Tran <quinn.tran@cavium.com>
Date:   Fri Dec 23 18:06:10 2016 -0800

    qla2xxx: Fix crash due to null pointer access
    
    commit fc1ffd6cb38a1c1af625b9833c41928039e733f5 upstream.
    
    During code inspection, while investigating following stack trace
    seen on one of the test setup, we found out there was possibility
    of memory leak becuase driver was not unwinding the stack properly.
    
    This issue has not been reproduced in a test environment or on a
    customer setup.
    
    Here's stack trace that was seen.
    
    [1469877.797315] Call Trace:
    [1469877.799940]  [<ffffffffa03ab6e9>] qla2x00_mem_alloc+0xb09/0x10c0 [qla2xxx]
    [1469877.806980]  [<ffffffffa03ac50a>] qla2x00_probe_one+0x86a/0x1b50 [qla2xxx]
    [1469877.814013]  [<ffffffff813b6d01>] ? __pm_runtime_resume+0x51/0xa0
    [1469877.820265]  [<ffffffff8157c1f5>] ? _raw_spin_lock_irqsave+0x25/0x90
    [1469877.826776]  [<ffffffff8157cd2d>] ? _raw_spin_unlock_irqrestore+0x6d/0x80
    [1469877.833720]  [<ffffffff810741d1>] ? preempt_count_sub+0xb1/0x100
    [1469877.839885]  [<ffffffff8157cd0c>] ? _raw_spin_unlock_irqrestore+0x4c/0x80
    [1469877.846830]  [<ffffffff81319b9c>] local_pci_probe+0x4c/0xb0
    [1469877.852562]  [<ffffffff810741d1>] ? preempt_count_sub+0xb1/0x100
    [1469877.858727]  [<ffffffff81319c89>] pci_call_probe+0x89/0xb0
    
    Signed-off-by: Quinn Tran <quinn.tran@cavium.com>
    Signed-off-by: Himanshu Madhani <himanshu.madhani@cavium.com>
    Reviewed-by: Christoph Hellwig <hch@lst.de>
    [ bvanassche: Fixed spelling in patch description ]
    Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 33038189bcabe9fecfef79adf985539b954e0c7c
Author: Ruslan Ruslichenko <rruslich@cisco.com>
Date:   Tue Jan 17 16:13:52 2017 +0200

    x86/ioapic: Restore IO-APIC irq_chip retrigger callback
    
    commit 020eb3daaba2857b32c4cf4c82f503d6a00a67de upstream.
    
    commit d32932d02e18 removed the irq_retrigger callback from the IO-APIC
    chip and did not add it to the new IO-APIC-IR irq chip.
    
    Unfortunately the software resend fallback is not enabled on X86, so edge
    interrupts which are received during the lazy disabled state of the
    interrupt line are not retriggered and therefor lost.
    
    Restore the callbacks.
    
    [ tglx: Massaged changelog ]
    
    Fixes: d32932d02e18  ("x86/irq: Convert IOAPIC to use hierarchical irqdomain interfaces")
    Signed-off-by: Ruslan Ruslichenko <rruslich@cisco.com>
    Cc: xe-linux-external@cisco.com
    Link: http://lkml.kernel.org/r/1484662432-13580-1-git-send-email-rruslich@cisco.com
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bf15e45eee7ab5df30cc9ec0f7030fbccf1d55b0
Author: Anton Blanchard <anton@samba.org>
Date:   Thu Jan 19 14:19:10 2017 +1100

    powerpc: Ignore reserved field in DCSR and PVR reads and writes
    
    commit 178f358208ceb8b38e5cff3f815e0db4a6a70a07 upstream.
    
    IBM bit 31 (for the rest of us - bit 0) is a reserved field in the
    instruction definition of mtspr and mfspr. Hardware is encouraged to
    (and does) ignore it.
    
    As a result, if userspace executes an mtspr DSCR with the reserved bit
    set, we get a DSCR facility unavailable exception. The kernel fails to
    match against the expected value/mask, and we silently return to
    userspace to try and re-execute the same mtspr DSCR instruction. We
    loop forever until the process is killed.
    
    We should do something here, and it seems mirroring what hardware does
    is the better option vs killing the process. While here, relax the
    matching of mfspr PVR too.
    
    Signed-off-by: Anton Blanchard <anton@samba.org>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e097785467134635a99a223168ff3825c6fb9d01
Author: Dave Martin <Dave.Martin@arm.com>
Date:   Thu Jan 5 16:50:57 2017 +0000

    powerpc/ptrace: Preserve previous TM fprs/vsrs on short regset write
    
    commit b34ca60148c53971d373643195cc5c4d5d20be78 upstream.
    
    Ensure that if userspace supplies insufficient data to PTRACE_SETREGSET
    to fill all the check pointed registers, the thread's old check pointed
    registers are preserved.
    
    Fixes: 9d3918f7c0e5 ("powerpc/ptrace: Enable support for NT_PPC_CVSX")
    Fixes: 19cbcbf75a0c ("powerpc/ptrace: Enable support for NT_PPC_CFPR")
    Signed-off-by: Dave Martin <Dave.Martin@arm.com>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9e10a0fc73122e90544875ec8375f1e9a187bb25
Author: Dave Martin <Dave.Martin@arm.com>
Date:   Thu Jan 5 16:50:57 2017 +0000

    powerpc/ptrace: Preserve previous fprs/vsrs on short regset write
    
    commit 99dfe80a2a246c600440a815741fd2e74a8b4977 upstream.
    
    Ensure that if userspace supplies insufficient data to PTRACE_SETREGSET
    to fill all the registers, the thread's old registers are preserved.
    
    Fixes: c6e6771b87d4 ("powerpc: Introduce VSX thread_struct and CONFIG_VSX")
    Signed-off-by: Dave Martin <Dave.Martin@arm.com>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 98e60a8345ae93fc5e5a9c9f30879a1da53aabad
Author: Madhavan Srinivasan <maddy@linux.vnet.ibm.com>
Date:   Mon Jan 9 19:00:15 2017 +0530

    powerpc/perf: Fix PM_BRU_CMPL event code for power9
    
    commit d89f473ff6f84872e761419f7233d6e00f99c340 upstream.
    
    Use 0x10012 event code for PM_BRU_CMPL event in power9 event list
    instead of current 0x40060.
    
    Fixes: 34922527a2bcb ('powerpc/perf: Add power9 event list macros for generic and cache events')
    Signed-off-by: Madhavan Srinivasan <maddy@linux.vnet.ibm.com>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 09187cdf50c17a5f537b78a3154c4b1014d9a36e
Author: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Date:   Mon Jan 16 11:58:53 2017 -0600

    powerpc/icp-opal: Fix missing KVM case and harden replay
    
    commit 9728a7c8ab2f7a1c8d5c95278d2e4f4ac1285385 upstream.
    
    The icp-opal call is missing the code from icp-native to recover
    interrupts snatched by KVM. Without that, when running KVM, we can
    get into a situation where an interrupt is lost and the CPU stuck
    with an elevated CPPR.
    
    Also harden replay by always checking the return from opal_int_eoi().
    
    Fixes: d74361881f0d ("powerpc/xics: Add ICP OPAL backend")
    Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 26c4d513b6af730941bb4ff4c237789a4d190c27
Author: Marc Zyngier <maz@kernel.org>
Date:   Thu Jan 12 09:21:56 2017 +0000

    KVM: arm/arm64: vgic: Fix deadlock on error handling
    
    commit 1193e6aeecb36c74c48c7cd0f641acbbed9ddeef upstream.
    
    Dmitry Vyukov reported that the syzkaller fuzzer triggered a
    deadlock in the vgic setup code when an error was detected, as
    the cleanup code tries to take a lock that is already held by
    the setup code.
    
    The fix is to avoid retaking the lock when cleaning up, by
    telling the cleanup function that we already hold it.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Reviewed-by: Christoffer Dall <christoffer.dall@linaro.org>
    Reviewed-by: Eric Auger <eric.auger@redhat.com>
    Signed-off-by: Marc Zyngier <marc.zyngier@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e0641f201114700dceac729babc89991ebb4b3ef
Author: Christian Borntraeger <borntraeger@de.ibm.com>
Date:   Thu Jan 12 16:25:15 2017 +0100

    KVM: s390: do not expose random data via facility bitmap
    
    commit 04478197416e3a302e9ebc917ba1aa884ef9bfab upstream.
    
    kvm_s390_get_machine() populates the facility bitmap by copying bytes
    from the host results that are stored in a 256 byte array in the prefix
    page. The KVM code does use the size of the target buffer (2k), thus
    copying and exposing unrelated kernel memory (mostly machine check
    related logout data).
    
    Let's use the size of the source buffer instead.  This is ok, as the
    target buffer will always be greater or equal than the source buffer as
    the KVM internal buffers (and thus S390_ARCH_FAC_LIST_SIZE_BYTE) cover
    the maximum possible size that is allowed by STFLE, which is 256
    doublewords. All structures are zero allocated so we can leave bytes
    256-2047 unchanged.
    
    Add a similar fix for kvm_arch_init_vm().
    
    Reported-by: Heiko Carstens <heiko.carstens@de.ibm.com>
    [found with smatch]
    Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
    Acked-by: Cornelia Huck <cornelia.huck@de.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 001ed27d088a4f66de05d440a2e7c8dd018be457
Author: Hauke Mehrtens <hauke@hauke-m.de>
Date:   Mon Dec 5 22:14:37 2016 +0100

    mtd: nand: xway: fix build because of module functions
    
    commit a2724663494f7313f53da10d8c0a729c5e3c4dea upstream.
    
    Remove the usage of modules functions to make this driver compile
    again. Otherwise an include of linux/modules.h would be needed.
    
    Fixes: 024366750c2e ("mtd: nand: xway: convert to normal platform driver")
    Signed-off-by: Hauke Mehrtens <hauke@hauke-m.de>
    Signed-off-by: Boris Brezillon <boris.brezillon@free-electrons.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c8dce6e0ef2c3641be81639fbfe4f10b6d411c41
Author: Hauke Mehrtens <hauke@hauke-m.de>
Date:   Mon Dec 5 22:14:36 2016 +0100

    mtd: nand: xway: disable module support
    
    commit 73529c872a189c747bdb528ce9b85b67b0e28dec upstream.
    
    The xway_nand driver accesses the ltq_ebu_membase symbol which is not
    exported. This also should not get exported and we should handle the
    EBU interface in a better way later. This quick fix just deactivated
    support for building as module.
    
    Fixes: 99f2b107924c ("mtd: lantiq: Add NAND support on Lantiq XWAY SoC.")
    Signed-off-by: Hauke Mehrtens <hauke@hauke-m.de>
    Signed-off-by: Boris Brezillon <boris.brezillon@free-electrons.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d8d82ac42e27a0312193364193139aa1917efe11
Author: Vladimir Zapolskiy <vz@mleia.com>
Date:   Mon Dec 5 03:47:10 2016 +0200

    mtd: nand: lpc32xx: fix invalid error handling of a requested irq
    
    commit cf9e1672a66c49ed8903c01b4c380a2f2dc91b40 upstream.
    
    Semantics of NR_IRQS is different on machines with SPARSE_IRQ option
    disabled or enabled, in the latter case IRQs are allocated starting
    at least from the value specified by NR_IRQS and going upwards, so
    the check of (irq >= NR_IRQ) to decide about an error code returned by
    platform_get_irq() is completely invalid, don't attempt to overrule
    irq subsystem in the driver.
    
    The change fixes LPC32xx NAND MLC driver initialization on boot.
    
    Fixes: 8cb17b5ed017 ("irqchip: Add LPC32xx interrupt controller driver")
    Signed-off-by: Vladimir Zapolskiy <vz@mleia.com>
    Acked-by: Sylvain Lemieux <slemieux.tyco@gmail.com>
    Signed-off-by: Boris Brezillon <boris.brezillon@free-electrons.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 86249aef233e6e05ba84f6c9aab9e6b890fc6ba7
Author: Stefan Schmidt <stefan@osg.samsung.com>
Date:   Thu Dec 15 18:40:14 2016 +0100

    ieee802154: atusb: do not use the stack for buffers to make them DMA able
    
    commit 05a974efa4bdf6e2a150e3f27dc6fcf0a9ad5655 upstream.
    
    From 4.9 we should really avoid using the stack here as this will not be DMA
    able on various platforms. This changes the buffers already being present in
    time of 4.9 being released. This should go into stable as well.
    
    Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Stefan Schmidt <stefan@osg.samsung.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ad17175732ca7b368b654c5736ef488a064c52a4
Author: Stefan Wahren <stefan.wahren@i2se.com>
Date:   Thu Jan 5 19:24:04 2017 +0000

    mmc: mxs-mmc: Fix additional cycles after transmission stop
    
    commit 01167c7b9cbf099c69fe411a228e4e9c7104e123 upstream.
    
    According to the code the intention is to append 8 SCK cycles
    instead of 4 at end of a MMC_STOP_TRANSMISSION command. But this
    will never happened because it's an AC command not an ADTC command.
    So fix this by moving the statement into the right function.
    
    Signed-off-by: Stefan Wahren <stefan.wahren@i2se.com>
    Fixes: e4243f13d10e (mmc: mxs-mmc: add mmc host driver for i.MX23/28)
    Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c1274eeb2fe3524ed075d3343213923262c845c8
Author: Hans de Goede <hdegoede@redhat.com>
Date:   Wed Dec 21 00:19:19 2016 +0100

    mmc: sdhci-acpi: Only powered up enabled acpi child devices
    
    commit e1d070c3793a2766122865a7c2142853b48808c5 upstream.
    
    Commit e5bbf30733f9 ("mmc: sdhci-acpi: Ensure connected devices are
    powered when probing") introduced code to powerup any acpi child
    nodes listed in the dstd. But some dstd-s list all possible devices
    used on some board variants, while reporting if the device is actually
    present and enabled in the status field of the device.
    
    So we end up calling the acpi _PS0 (power-on) method for devices which
    are not actually present. This does not always end well, e.g. on my
    cube iwork8 air tablet, this results in freezing the entire tablet as
    soon as the r8723bs module is loaded.
    
    This commit fixes this by checking the child device's status.present
    and status.enabled bits and only call acpi_device_fix_up_power()
    if both are set.
    
    Fixes: e5bbf30733f9 ("mmc: sdhci-acpi: Ensure connected devices are powered when probing")
    BugLink: https://github.com/hadess/rtl8723bs/issues/80
    Signed-off-by: Hans de Goede <hdegoede@redhat.com>
    Acked-by: Adrian Hunter <adrian.hunter@intel.com>
    Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 35028599bc8884f33e36a9353be6f1401940aa29
Author: Johan Hovold <johan@kernel.org>
Date:   Thu Jan 12 18:17:43 2017 +0100

    HID: corsair: fix control-transfer error handling
    
    commit 7a546af50eb78ab99840903083231eb635c8a566 upstream.
    
    Make sure to check for short control transfers in order to avoid parsing
    uninitialised buffer data and leaking it to user space.
    
    Note that the backlight and macro-mode buffer constraints are kept as
    loose as possible in order to avoid any regressions should the current
    buffer sizes be larger than necessary.
    
    Fixes: 6f78193ee9ea ("HID: corsair: Add Corsair Vengeance K90 driver")
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 63df1ccb937f67fbefa0a77415b3a4d10434a09b
Author: Johan Hovold <johan@kernel.org>
Date:   Thu Jan 12 18:17:42 2017 +0100

    HID: corsair: fix DMA buffers on stack
    
    commit 6d104af38b570d37aa32a5803b04c354f8ed513d upstream.
    
    Not all platforms support DMA to the stack, and specifically since v4.9
    this is no longer supported on x86 with VMAP_STACK either.
    
    Note that the macro-mode buffer was larger than necessary.
    
    Fixes: 6f78193ee9ea ("HID: corsair: Add Corsair Vengeance K90 driver")
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4922a6a5cfa7ff25622f07860d840e6b9c49f6a1
Author: Bjorn Helgaas <bhelgaas@google.com>
Date:   Wed Jan 11 09:11:53 2017 -0600

    PCI: Enumerate switches below PCI-to-PCIe bridges
    
    commit 51ebfc92b72b4f7dac1ab45683bf56741e454b8c upstream.
    
    A PCI-to-PCIe bridge (a "reverse bridge") has a PCI or PCI-X primary
    interface and a PCI Express secondary interface.  The PCIe interface is a
    Downstream Port that originates a Link.  See the "PCI Express to PCI/PCI-X
    Bridge Specification", rev 1.0, sections 1.2 and A.6.
    
    The bug report below involves a PCI-to-PCIe bridge and a PCIe switch below
    the bridge:
    
      00:1e.0 Intel 82801 PCI Bridge to [bus 01-0a]
      01:00.0 Pericom PI7C9X111SL PCIe-to-PCI Reversible Bridge to [bus 02-0a]
      02:00.0 Pericom Device 8608 [PCIe Upstream Port] to [bus 03-0a]
      03:01.0 Pericom Device 8608 [PCIe Downstream Port] to [bus 0a]
    
    01:00.0 is configured as a PCI-to-PCIe bridge (despite the name printed by
    lspci).  As we traverse a PCIe hierarchy, device connections alternate
    between PCIe Links and internal Switch logic.  Previously we did not
    recognize that 01:00.0 had a secondary link, so we thought the 02:00.0
    Upstream Port *did* have a secondary link.  In fact, it's the other way
    around: 01:00.0 has a secondary link, and 02:00.0 has internal Switch logic
    on its secondary side.
    
    When we thought 02:00.0 had a secondary link, the pci_scan_slot() ->
    only_one_child() path assumed 02:00.0 could have only one child, so 03:00.0
    was the only possible downstream device.  But 03:00.0 doesn't exist, so we
    didn't look for any other devices on bus 03.
    
    Booting with "pci=pcie_scan_all" is a workaround, but we don't want users
    to have to do that.
    
    Recognize that PCI-to-PCIe bridges originate links on their secondary
    interfaces.
    
    Link: https://bugzilla.kernel.org/show_bug.cgi?id=189361
    Fixes: d0751b98dfa3 ("PCI: Add dev->has_secondary_link to track downstream PCIe links")
    Tested-by: Blake Moore <blake.moore@men.de>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c6bdc450fe93b54c394143a3e564a6730f3350ff
Author: Murali Karicheri <m-karicheri2@ti.com>
Date:   Wed Jan 4 14:32:30 2017 -0500

    PCI: designware: Check for iATU unroll only on platforms that use ATU
    
    commit a782b5f986c3fa1cfa7f2b57941200c6a5809242 upstream.
    
    Previously we checked for iATU unroll support by reading PCIE_ATU_VIEWPORT
    even on platforms, e.g., Keystone, that do not have ATU ports.  This can
    cause bad behavior such as asynchronous external aborts:
    
      OF: PCI:   MEM 0x60000000..0x6fffffff -> 0x60000000
      Unhandled fault: asynchronous external abort (0x1211) at 0x00000000
      pgd = c0003000
      [00000000] *pgd=80000800004003, *pmd=00000000
      Internal error: : 1211 [#1] PREEMPT SMP ARM
      Modules linked in:
      CPU: 0 PID: 1 Comm: swapper/0 Not tainted 4.9.0-00009-g6ff59d2-dirty #7
      Hardware name: Keystone
      task: eb878000 task.stack: eb866000
      PC is at dw_pcie_setup_rc+0x24/0x380
      LR is at ks_pcie_host_init+0x10/0x170
    
    Move the dw_pcie_iatu_unroll_enabled() check so we only call it on
    platforms that do not use the ATU.  These platforms supply their own
    ->rd_other_conf() and ->wr_other_conf() methods.
    
    [bhelgaas: changelog]
    Fixes: a0601a470537 ("PCI: designware: Add iATU Unroll feature")
    Fixes: 416379f9ebde ("PCI: designware: Check for iATU unroll support after initializing host")
    Tested-by: Kishon Vijay Abraham I <kishon@ti.com>
    Signed-off-by: Murali Karicheri <m-karicheri2@ti.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Acked-By: Joao Pinto <jpinto@synopsys.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 07f0267561c6cbe4a87c9a05134d2070f8b4a2ee
Author: David Sheets <david.sheets@docker.com>
Date:   Fri Jan 13 15:58:30 2017 +0000

    fuse: fix time_to_jiffies nsec sanity check
    
    commit 210675270caa33253e4c33f3c5e657e7d6060812 upstream.
    
    Commit bcb6f6d2b9c2 ("fuse: use timespec64") introduced clamped nsec values
    in time_to_jiffies but used the max of nsec and NSEC_PER_SEC - 1 instead of
    the min. Because of this, dentries would stay in the cache longer than
    requested and go stale in scenarios that relied on their timely eviction.
    
    Fixes: bcb6f6d2b9c2 ("fuse: use timespec64")
    Signed-off-by: David Sheets <dsheets@docker.com>
    Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0181b3603681d03e5753079cef8b17d2905faee5
Author: Tahsin Erdogan <tahsin@google.com>
Date:   Thu Jan 12 12:04:04 2017 -0800

    fuse: clear FR_PENDING flag when moving requests out of pending queue
    
    commit a8a86d78d673b1c99fe9b0064739fde9e9774184 upstream.
    
    fuse_abort_conn() moves requests from pending list to a temporary list
    before canceling them. This operation races with request_wait_answer()
    which also tries to remove the request after it gets a fatal signal. It
    checks FR_PENDING flag to determine whether the request is still in the
    pending list.
    
    Make fuse_abort_conn() clear FR_PENDING flag so that request_wait_answer()
    does not remove the request from temporary list.
    
    This bug causes an Oops when trying to delete an already deleted list entry
    in end_requests().
    
    Fixes: ee314a870e40 ("fuse: abort: no fc->lock needed for request ending")
    Signed-off-by: Tahsin Erdogan <tahsin@google.com>
    Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bb82fb48df8cab8f902052ce03f6d51b9b8f1bcd
Author: Vineet Gupta <vgupta@synopsys.com>
Date:   Mon Jan 16 10:48:09 2017 -0800

    ARC: module: Fix !CONFIG_ARC_DW2_UNWIND builds
    
    commit eb1357d942e5d96de6b4c20a8ffa55acf96233a2 upstream.
    
    commit d65283f7b695b5 added mod->arch.secstr under
    CONFIG_ARC_DW2_UNWIND, but used it unconditionally which broke builds
    when the option was disabled. Fix that by adjusting the #ifdef guard.
    
    And while at it add a missing guard (for unwinder) in module.c as well
    
    Reported-by: Waldemar Brodkorb <wbx@openadk.org>
    Fixes: d65283f7b695b5 ("ARC: module: elide loop to save reference to .eh_frame")
    Tested-by: Anton Kolesov <akolesov@synopsys.com>
    Reviewed-by: Alexey Brodkin <abrodkin@synopsys.com>
    [abrodkin: provided fixlet to Kconfig per failure in allnoconfig build]
    Signed-off-by: Vineet Gupta <vgupta@synopsys.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3c4d83a1a41efdf2c191d0072e6545e6bf8ecc94
Author: Dan Williams <dan.j.williams@intel.com>
Date:   Mon Jan 9 17:30:49 2017 -0800

    libnvdimm, namespace: fix pmem namespace leak, delete when size set to zero
    
    commit 1f19b983a8877f81763fab3e693c6befe212736d upstream.
    
    Commit 98a29c39dc68 ("libnvdimm, namespace: allow creation of multiple
    pmem-namespaces per region") added support for establishing additional
    pmem namespace beyond the seed device, similar to blk namespaces.
    However, it neglected to delete the namespace when the size is set to
    zero.
    
    Fixes: 98a29c39dc68 ("libnvdimm, namespace: allow creation of multiple pmem-namespaces per region")
    Signed-off-by: Dan Williams <dan.j.williams@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f29f3616b9328e17f902f1839634b2440ca07982
Author: J. Bruce Fields <bfields@redhat.com>
Date:   Mon Jan 9 17:15:18 2017 -0500

    svcrpc: don't leak contexts on PROC_DESTROY
    
    commit 78794d1890708cf94e3961261e52dcec2cc34722 upstream.
    
    Context expiry times are in units of seconds since boot, not unix time.
    
    The use of get_seconds() here therefore sets the expiry time decades in
    the future.  This prevents timely freeing of contexts destroyed by
    client RPC_GSS_PROC_DESTROY requests.  We'd still free them eventually
    (when the module is unloaded or the container shut down), but a lot of
    contexts could pile up before then.
    
    Fixes: c5b29f885afe "sunrpc: use seconds since boot in expiry cache"
    Reported-by: Andy Adamson <andros@netapp.com>
    Signed-off-by: J. Bruce Fields <bfields@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a297ed84b92846963b4a7c5efd90910cea9c39a5
Author: Scott Mayhew <smayhew@redhat.com>
Date:   Thu Jan 5 16:34:51 2017 -0500

    sunrpc: don't call sleeping functions from the notifier block callbacks
    
    commit 546125d1614264d26080817d0c8cddb9b25081fa upstream.
    
    The inet6addr_chain is an atomic notifier chain, so we can't call
    anything that might sleep (like lock_sock)... instead of closing the
    socket from svc_age_temp_xprts_now (which is called by the notifier
    function), just have the rpc service threads do it instead.
    
    Fixes: c3d4879e01be "sunrpc: Add a function to close..."
    Signed-off-by: Scott Mayhew <smayhew@redhat.com>
    Signed-off-by: J. Bruce Fields <bfields@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 90687fc3c8c386a16326089d68cf616b8049440f
Author: Paul E. McKenney <paulmck@kernel.org>
Date:   Tue Jan 10 02:28:26 2017 -0800

    rcu: Narrow early boot window of illegal synchronous grace periods
    
    commit 52d7e48b86fc108e45a656d8e53e4237993c481d upstream.
    
    The current preemptible RCU implementation goes through three phases
    during bootup.  In the first phase, there is only one CPU that is running
    with preemption disabled, so that a no-op is a synchronous grace period.
    In the second mid-boot phase, the scheduler is running, but RCU has
    not yet gotten its kthreads spawned (and, for expedited grace periods,
    workqueues are not yet running.  During this time, any attempt to do
    a synchronous grace period will hang the system (or complain bitterly,
    depending).  In the third and final phase, RCU is fully operational and
    everything works normally.
    
    This has been OK for some time, but there has recently been some
    synchronous grace periods showing up during the second mid-boot phase.
    This code worked "by accident" for awhile, but started failing as soon
    as expedited RCU grace periods switched over to workqueues in commit
    8b355e3bc140 ("rcu: Drive expedited grace periods from workqueue").
    Note that the code was buggy even before this commit, as it was subject
    to failure on real-time systems that forced all expedited grace periods
    to run as normal grace periods (for example, using the rcu_normal ksysfs
    parameter).  The callchain from the failure case is as follows:
    
    early_amd_iommu_init()
    |-> acpi_put_table(ivrs_base);
    |-> acpi_tb_put_table(table_desc);
    |-> acpi_tb_invalidate_table(table_desc);
    |-> acpi_tb_release_table(...)
    |-> acpi_os_unmap_memory
    |-> acpi_os_unmap_iomem
    |-> acpi_os_map_cleanup
    |-> synchronize_rcu_expedited
    
    The kernel showing this callchain was built with CONFIG_PREEMPT_RCU=y,
    which caused the code to try using workqueues before they were
    initialized, which did not go well.
    
    This commit therefore reworks RCU to permit synchronous grace periods
    to proceed during this mid-boot phase.  This commit is therefore a
    fix to a regression introduced in v4.9, and is therefore being put
    forward post-merge-window in v4.10.
    
    This commit sets a flag from the existing rcu_scheduler_starting()
    function which causes all synchronous grace periods to take the expedited
    path.  The expedited path now checks this flag, using the requesting task
    to drive the expedited grace period forward during the mid-boot phase.
    Finally, this flag is updated by a core_initcall() function named
    rcu_exp_runtime_mode(), which causes the runtime codepaths to be used.
    
    Note that this arrangement assumes that tasks are not sent POSIX signals
    (or anything similar) from the time that the first task is spawned
    through core_initcall() time.
    
    Fixes: 8b355e3bc140 ("rcu: Drive expedited grace periods from workqueue")
    Reported-by: "Zheng, Lv" <lv.zheng@intel.com>
    Reported-by: Borislav Petkov <bp@alien8.de>
    Signed-off-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
    Tested-by: Stan Kain <stan.kain@gmail.com>
    Tested-by: Ivan <waffolz@hotmail.com>
    Tested-by: Emanuel Castelo <emanuel.castelo@gmail.com>
    Tested-by: Bruno Pesavento <bpesavento@infinito.it>
    Tested-by: Borislav Petkov <bp@suse.de>
    Tested-by: Frederic Bezies <fredbezies@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bdeaa468e22171497b289c2f31d20ab6b318d53c
Author: Paul E. McKenney <paulmck@kernel.org>
Date:   Mon Jan 9 23:23:15 2017 -0800

    rcu: Remove cond_resched() from Tiny synchronize_sched()
    
    commit f466ae66fa6a599f9a53b5f9bafea4b8cfffa7fb upstream.
    
    It is now legal to invoke synchronize_sched() at early boot, which causes
    Tiny RCU's synchronize_sched() to emit spurious splats.  This commit
    therefore removes the cond_resched() from Tiny RCU's synchronize_sched().
    
    Fixes: 8b355e3bc140 ("rcu: Drive expedited grace periods from workqueue")
    Signed-off-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f779e00d2e86df2c9409c7cc8c054113c5086d1b
Author: Bjorn Helgaas <bhelgaas@google.com>
Date:   Wed Dec 28 14:55:16 2016 -0600

    x86/PCI: Ignore _CRS on Supermicro X8DTH-i/6/iF/6F
    
    commit 89e9f7bcd8744ea25fcf0ac671b8d72c10d7d790 upstream.
    
    Martin reported that the Supermicro X8DTH-i/6/iF/6F advertises incorrect
    host bridge windows via _CRS:
    
      pci_root PNP0A08:00: host bridge window [io  0xf000-0xffff]
      pci_root PNP0A08:01: host bridge window [io  0xf000-0xffff]
    
    Both bridges advertise the 0xf000-0xffff window, which cannot be correct.
    
    Work around this by ignoring _CRS on this system.  The downside is that we
    may not assign resources correctly to hot-added PCI devices (if they are
    possible on this system).
    
    Link: https://bugzilla.kernel.org/show_bug.cgi?id=42606
    Reported-by: Martin Burnicki <martin.burnicki@meinberg.de>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 782b361c93062f083bbc9a78928498218f950399
Author: Gu Zheng <guzheng1@huawei.com>
Date:   Mon Jan 9 09:34:48 2017 +0800

    tmpfs: clear S_ISGID when setting posix ACLs
    
    commit 497de07d89c1410d76a15bec2bb41f24a2a89f31 upstream.
    
    This change was missed the tmpfs modification in In CVE-2016-7097
    commit 073931017b49 ("posix_acl: Clear SGID bit when setting
    file permissions")
    It can test by xfstest generic/375, which failed to clear
    setgid bit in the following test case on tmpfs:
    
      touch $testfile
      chown 100:100 $testfile
      chmod 2755 $testfile
      _runas -u 100 -g 101 -- setfacl -m u::rwx,g::rwx,o::rwx $testfile
    
    Signed-off-by: Gu Zheng <guzheng1@huawei.com>
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Cc: Brad Spengler <spender@grsecurity.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9170948a24b7ad73ea6511c5d37984f9475b699f
Author: Adam Ford <aford173@gmail.com>
Date:   Sat Dec 3 04:57:23 2016 -0600

    ARM: dts: omap3: Add DTS for Logic PD SOM-LV 37xx Dev Kit
    
    commit 7245f67f86e847769f41dacad26bb8f5b5d74bf4 upstream.
    
    Fixes: ("ab8dd3aed011 ARM: DTS: Add minimal Support for Logic PD
    DM3730 SOM-LV")
    
    This adds the dts file into the Makefile. This should have been included in
    the original patch.
    
    V2:  Update patch description - same source code
    V1:  Original patch
    
    Reviewed-by: Javier Martinez Canillas <javier@osg.samsung.com>
    Signed-off-by: Adam Ford <aford173@gmail.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit efba7a37efe28ea53ccecbb377983d11a938df10
Author: Vladimir Zapolskiy <vladimir_zapolskiy@mentor.com>
Date:   Thu Nov 17 03:30:51 2016 +0200

    ARM: dts: imx31: fix AVIC base address
    
    commit af92305e567b7f4c9cf48b9e46c1f48ec9ffb1fb upstream.
    
    On i.MX31 AVIC interrupt controller base address is at 0x68000000.
    
    The problem was shadowed by the AVIC driver, which takes the correct
    base address from a SoC specific header file.
    
    Fixes: d2a37b3d91f4 ("ARM i.MX31: Add devicetree support")
    Signed-off-by: Vladimir Zapolskiy <vladimir_zapolskiy@mentor.com>
    Reviewed-by: Fabio Estevam <fabio.estevam@nxp.com>
    Signed-off-by: Shawn Guo <shawnguo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 173470b1b10a853a0b11cbf363c8b50087aa3962
Author: Vladimir Zapolskiy <vz@mleia.com>
Date:   Mon Sep 26 03:03:41 2016 +0300

    ARM: dts: imx31: move CCM device node to AIPS2 bus devices
    
    commit 1f87aee6a2e55eda466a43ba6248a8b75eede153 upstream.
    
    i.MX31 Clock Control Module controller is found on AIPS2 bus, move it
    there from SPBA bus to avoid a conflict of device IO space mismatch.
    
    Fixes: ef0e4a606fb6 ("ARM: mx31: Replace clk_register_clkdev with clock DT lookup")
    Signed-off-by: Vladimir Zapolskiy <vz@mleia.com>
    Acked-by: Uwe Kleine-König <u.kleine-koenig@pengutronix.de>
    Signed-off-by: Shawn Guo <shawnguo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 979f63227c98004635b6c329749618372a3ff4bf
Author: Vladimir Zapolskiy <vz@mleia.com>
Date:   Mon Sep 26 03:03:40 2016 +0300

    ARM: dts: imx31: fix clock control module interrupts description
    
    commit 2e575cbc930901718cc18e084566ecbb9a4b5ebb upstream.
    
    The type of AVIC interrupt controller found on i.MX31 is one-cell,
    namely 31 for CCM DVFS and 53 for CCM, however for clock control
    module its interrupts are specified as 3-cells, fix it.
    
    Fixes: ef0e4a606fb6 ("ARM: mx31: Replace clk_register_clkdev with clock DT lookup")
    Acked-by: Rob Herring <robh@kernel.org>
    Signed-off-by: Vladimir Zapolskiy <vz@mleia.com>
    Signed-off-by: Shawn Guo <shawnguo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e95bd2ca11a9b680a46ac4af6167d5299753a1f5
Author: Christopher Spinrath <christopher.spinrath@rwth-aachen.de>
Date:   Fri Nov 11 16:59:38 2016 +0100

    ARM: dts: imx6q-cm-fx6: fix fec pinctrl
    
    commit 72649a46067903d00f46e2ebef6543768224f1a0 upstream.
    
    According to the schematics of CompuLab's sbc-fx6 baseboard and the
    vendor devicetree GPIO_16 is *not* muxed to ENET_REF_CLK but to SPDIF_IN.
    
    Remove the wrong pinctrl setting.
    
    Fixes: 682d055e6ac5 ("ARM: dts: Add initial support for cm-fx6.")
    Signed-off-by: Christopher Spinrath <christopher.spinrath@rwth-aachen.de>
    Signed-off-by: Shawn Guo <shawnguo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 387812143cbede75658d267ad224e653b83b498b
Author: Sergei Shtylyov <sergei.shtylyov@cogentembedded.com>
Date:   Sun Oct 30 00:31:27 2016 +0300

    ARM: dts: r8a7794: remove Z clock
    
    commit 68cc085a4daaa32f7138de1e918331c05165a484 upstream.
    
    R8A7794 doesn't have Cortex-A15 CPUs, thus there's no Z clock...
    
    Fixes: 0dce5454d5c2 ("ARM: shmobile: Initial r8a7794 SoC device tree")
    Signed-off-by: Sergei Shtylyov <sergei.shtylyov@cogentembedded.com>
    Reviewed-by: Geert Uytterhoeven <geert+renesas@glider.be>
    Signed-off-by: Simon Horman <horms+renesas@verge.net.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 57a10f29e0b3b407336293139459012259885ce2
Author: Geert Uytterhoeven <geert+renesas@glider.be>
Date:   Mon Nov 7 20:10:04 2016 +0100

    ARM: dts: r8a7794: Use SYSC "always-on" PM Domain for sound
    
    commit 24b2d930a50662c11918fd0c22931f1448488da4 upstream.
    
    Hook up the Audio-DMAC and sound device nodes to the SYSC "always-on" PM
    Domain, for a more consistent device-power-area description in DT.
    
    Cfr. commit 0761ff2ad0c581f3 ("ARM: dts: r8a7794: Add SYSC PM Domains").
    
    Fixes: 320d6c5a08a4abd3 ("ARM: dts: r8a7794: add sound support")
    Fixes: 298e4ee3d213a076 ("ARM: dts: r8a7794: add Audio-DMAC support")
    Signed-off-by: Geert Uytterhoeven <geert+renesas@glider.be>
    Signed-off-by: Simon Horman <horms+renesas@verge.net.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 97136d1ef47aa2bd5efc4061fbca364ba4e6a138
Author: Stefan Wahren <stefan.wahren@i2se.com>
Date:   Sun Oct 30 17:22:19 2016 +0000

    ARM: dts: bcm283x: fix typo in mailbox address
    
    commit 7d891a685dd46b925cf25b74ada0280a2531c34f upstream.
    
    The address of the mailbox node in the bcm283x.dtsi also has a typo.
    So fix it accordingly.
    
    Signed-off-by: Stefan Wahren <stefan.wahren@i2se.com>
    Reviewed-by: Andreas Färber <afaerber@suse.de>
    Fixes: 05b682b7a3b2 ("ARM: bcm2835: dt: Add the mailbox to the device tree")
    Signed-off-by: Eric Anholt <eric@anholt.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 03f5be20ec9befe477e9978bdba2b1f4f2ca9e42
Author: Maciej Debski <maciejd@google.com>
Date:   Thu Oct 13 03:59:36 2016 -0700

    perf jit: Enable jitdump support without dwarf
    
    commit 621cb4e7837e39d25a5af5a785ad282cdd2b4ce8 upstream.
    
    This patch modifies the build dependencies on the jitdump support in
    perf. As it stands jitdump was wrongfully made dependent 100% on using
    DWARF. However, the dwarf dependency, only exist if generating the
    source line table in genelf_debug.c. The rest of the support does not
    need DWARF.
    
    This patch removes the dependency on DWARF for the entire jitdump
    support. It keeps it only for the genelf_debug.c support.
    
    Signed-off-by: Maciej Debski <maciejd@google.com>
    Reviewed-by: Stephane Eranian <eranian@google.com>
    Cc: Anton Blanchard <anton@ozlabs.org>
    Cc: Jiri Olsa <jolsa@redhat.com>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Link: http://lkml.kernel.org/r/1476356383-30100-3-git-send-email-eranian@google.com
    Fixes: e12b202f8fb9 ("perf jitdump: Build only on supported archs")
    [ Make it build only if NO_LIBELF isn't defined, as jitdump.o will only be built in that case ]
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3ef6a3c0136b2005ff887e777f51200938ac3214
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Tue Oct 25 17:20:47 2016 -0300

    perf scripting: Avoid leaking the scripting_context variable
    
    commit cf346d5bd4b9d61656df2f72565c9b354ef3ca0d upstream.
    
    Both register_perl_scripting() and register_python_scripting() allocate
    this variable, fix it by checking if it already was.
    
    Cc: Adrian Hunter <adrian.hunter@intel.com>
    Cc: David Ahern <dsahern@gmail.com>
    Cc: Frederic Weisbecker <fweisbec@gmail.com>
    Cc: Jiri Olsa <jolsa@kernel.org>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Tom Zanussi <tzanussi@gmail.com>
    Cc: Wang Nan <wangnan0@huawei.com>
    Fixes: 7e4b21b84c43 ("perf/scripts: Add Python scripting engine")
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ea738532666a465d0a7fc0546e35d6acb9242a29
Author: Rabin Vincent <rabinv@axis.com>
Date:   Wed Aug 10 15:52:28 2016 +0200

    perf callchain: Fixup help/config for no-unwinding
    
    commit c56cb33b56c13493eeb95612f80e4dd6e35cd109 upstream.
    
    Since 841e3558b2d ("perf callchain: Recording 'dwarf' callchains do not
    need DWARF unwinding support"), --call-graph dwarf is allowed in 'perf
    record' even without unwind support.  A couple of other places don't
    reflect this yet though: the help text should list dwarf as a valid
    record mode and the dump_size config should be respected too.
    
    Signed-off-by: Rabin Vincent <rabinv@axis.com>
    Cc: He Kuang <hekuang@huawei.com>
    Fixes: 841e3558b2de ("perf callchain: Recording 'dwarf' callchains do not need DWARF unwinding support")
    Link: http://lkml.kernel.org/r/1470837148-7642-1-git-send-email-rabin.vincent@axis.com
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a1d308914090d689973af1b4cb8d0141a91d7a46
Author: Kan Liang <kan.liang@intel.com>
Date:   Tue Dec 13 10:29:44 2016 -0500

    perf diff: Do not overwrite valid build id
    
    commit ed6c166cc7dc329736cace3affd2df984fb22ec8 upstream.
    
    Fixes a perf diff regression issue which was introduced by commit
    5baecbcd9c9a ("perf symbols: we can now read separate debug-info files
    based on a build ID")
    
    The binary name could be same when perf diff different binaries. Build
    id is used to distinguish between them.
    However, the previous patch assumes the same binary name has same build
    id. So it overwrites the build id according to the binary name,
    regardless of whether the build id is set or not.
    
    Check the has_build_id in dso__load. If the build id is already set, use
    it.
    
    Before the fix:
    
      $ perf diff 1.perf.data 2.perf.data
      # Event 'cycles'
      #
      # Baseline    Delta  Shared Object     Symbol
      # ........  .......  ................  .............................
      #
        99.83%  -99.80%  tchain_edit       [.] f2
         0.12%  +99.81%  tchain_edit       [.] f3
         0.02%   -0.01%  [ixgbe]           [k] ixgbe_read_reg
    
      After the fix:
      $ perf diff 1.perf.data 2.perf.data
      # Event 'cycles'
      #
      # Baseline    Delta  Shared Object     Symbol
      # ........  .......  ................  .............................
      #
        99.83%   +0.10%  tchain_edit       [.] f3
         0.12%   -0.08%  tchain_edit       [.] f2
    
    Signed-off-by: Kan Liang <kan.liang@intel.com>
    Cc: Andi Kleen <andi@firstfloor.org>
    CC: Dima Kogan <dima@secretsauce.net>
    Cc: Jiri Olsa <jolsa@redhat.com>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Fixes: 5baecbcd9c9a ("perf symbols: we can now read separate debug-info files based on a build ID")
    Link: http://lkml.kernel.org/r/1481642984-13593-1-git-send-email-kan.liang@intel.com
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0f242c0ae0a6d414bab8aa7aa6ad0e55fb669bb0
Author: Jiri Olsa <jolsa@kernel.org>
Date:   Thu Dec 15 20:56:54 2016 +0100

    perf trace: Check if MAP_32BIT is defined (again)
    
    commit 2bd42f3aaa53ebe78b9be6f898b7945dd61f9773 upstream.
    
    There might be systems where MAP_32BIT is not defined, like some some
    RHEL7 powerpc versions.
    
    Signed-off-by: Jiri Olsa <jolsa@kernel.org>
    Cc: David Ahern <dsahern@gmail.com>
    Cc: Kyle McMartin <kyle@redhat.com>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
    Fixes: 256763b01741 ("perf trace beauty mmap: Add more conditional defines")
    Link: http://lkml.kernel.org/r/1481831814-23683-1-git-send-email-jolsa@kernel.org
    [ Changed the Fixme cset to the one removing the conditional switch case for MAP_32BIT ]
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8b5484fab145d4c03c8afff7223d687668abf5d9
Author: Jiri Olsa <jolsa@kernel.org>
Date:   Mon Dec 12 11:35:39 2016 +0100

    perf mem: Fix --all-user/--all-kernel options
    
    commit 631ac41b46d293fb3ee43a809776c1663de8d9c6 upstream.
    
    Removing extra '--' prefix.
    
    Signed-off-by: Jiri Olsa <jolsa@kernel.org>
    Cc: David Ahern <dsahern@gmail.com>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
    Fixes: ad16511b0e40 ("perf mem: Add -U/-K (--all-user/--all-kernel) options")
    Link: http://lkml.kernel.org/r/1481538943-21874-2-git-send-email-jolsa@kernel.org
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 567eea578016f181968f76f9e81bc98ecf231ae9
Author: Arnaldo Carvalho de Melo <acme@redhat.com>
Date:   Tue Oct 18 11:28:32 2016 -0300

    perf trace: Use the syscall raw_syscalls:sys_enter timestamp
    
    commit ecf1e2253ea79c6204f4d6a5e756e8fb4aed5a7e upstream.
    
    Instead of the one when another syscall takes place while another is being
    processed (in another CPU, but we show it serialized, so need to "interrupt"
    the other), and also when finally showing the sys_enter + sys_exit + duration,
    where we were showing the sample->time for the sys_exit, duh.
    
    Before:
    
      # perf trace sleep 1
      <SNIP>
         0.373 (   0.001 ms): close(fd: 3                   ) = 0
      1000.626 (1000.211 ms): nanosleep(rqtp: 0x7ffd6ddddfb0) = 0
      1000.653 (   0.003 ms): close(fd: 1                   ) = 0
      1000.657 (   0.002 ms): close(fd: 2                   ) = 0
      1000.667 (   0.000 ms): exit_group(                   )
      #
    
    After:
    
      # perf trace sleep 1
      <SNIP>
         0.336 (   0.001 ms): close(fd: 3                   ) = 0
         0.373 (1000.086 ms): nanosleep(rqtp: 0x7ffe303e9550) = 0
      1000.481 (   0.002 ms): close(fd: 1                   ) = 0
      1000.485 (   0.001 ms): close(fd: 2                   ) = 0
      1000.494 (   0.000 ms): exit_group(                   )
    [root@jouet linux]#
    
    Cc: Adrian Hunter <adrian.hunter@intel.com>
    Cc: David Ahern <dsahern@gmail.com>
    Cc: Jiri Olsa <jolsa@kernel.org>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Wang Nan <wangnan0@huawei.com>
    Link: http://lkml.kernel.org/n/tip-ecbzgmu2ni6glc6zkw8p1zmx@git.kernel.org
    Fixes: 752fde44fd1c ("perf trace: Support interrupted syscalls")
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d622b626270ae58c0d40c55a97170ac464c9063a
Author: Kamal Heib <kamalh@mellanox.com>
Date:   Thu Nov 10 10:16:48 2016 +0200

    IB/IPoIB: Remove can't use GFP_NOIO warning
    
    commit 0b59970e7d96edcb3c7f651d9d48e1a59af3c3b0 upstream.
    
    Remove the warning print of "can't use of GFP_NOIO" to avoid prints in
    each QP creation when devices aren't supporting IB_QP_CREATE_USE_GFP_NOIO.
    
    This print become more annoying when the IPoIB interface is configured
    to work in connected mode.
    
    Fixes: 09b93088d750 ('IB: Add a QP creation flag to use GFP_NOIO allocations')
    Signed-off-by: Kamal Heib <kamalh@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Reviewed-by: Yuval Shaia <yuval.shaia@oracle.com>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 656a7d6575336348000bcf42e9827b3b4ff95102
Author: Eran Ben Elisha <eranbe@mellanox.com>
Date:   Thu Nov 10 11:31:01 2016 +0200

    IB/mlx4: Check if GRH is available before using it
    
    commit bf08e884bfd5be068fd2ccf2bc450f085d8dd853 upstream.
    
    Before reading GRH attributes, need to make sure AH contains GRH,
    and in addition, initialize GID type.
    
    Fixes: dbf727de7440 ('IB/core: Use GID table in AH creation and dmac resolution')
    Signed-off-by: Eran Ben Elisha <eranbe@mellanox.com>
    Signed-off-by: Daniel Jurgens <danielj@mellanox.com>
    Reviewed-by: Mark Bloch <markb@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 661600ff77f142b26338eb795e5694a17a6df699
Author: Eran Ben Elisha <eranbe@mellanox.com>
Date:   Thu Nov 10 11:31:00 2016 +0200

    IB/mlx4: When no DMFS for IPoIB, don't allow NET_IF QPs
    
    commit 1f22e454df2eb99ba6b7ace3f594f6805cdf5cbc upstream.
    
    According to the firmware spec, FLOW_STEERING_IB_UC_QP_RANGE command is
    supported only if dmfs_ipoib bit is set.
    
    If it isn't set we want to ensure allocating NET_IF QPs fail. We do so
    by filling out the allocation bitmap. By thus, the NET_IF QPs allocating
    function won't find any free QP and will fail.
    
    Fixes: c1c98501121e ('IB/mlx4: Add support for steerable IB UD QPs')
    Signed-off-by: Eran Ben Elisha <eranbe@mellanox.com>
    Signed-off-by: Daniel Jurgens <danielj@mellanox.com>
    Reviewed-by: Mark Bloch <markb@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8f95735412ad8d9327cb890ac11a89a4b911c41b
Author: Saeed Mahameed <saeedm@mellanox.com>
Date:   Thu Nov 10 11:30:59 2016 +0200

    IB/mlx4: Fix port query for 56Gb Ethernet links
    
    commit 6fa26208206c406fa529cd73f7ae6bf4181e270b upstream.
    
    Report the correct speed in the port attributes when using a 56Gbps
    ethernet link.  Without this change the field is incorrectly set to 10.
    
    Fixes: a9c766bb75ee ('IB/mlx4: Fix info returned when querying IBoE ports')
    Fixes: 2e96691c31ec ('IB: Use central enum for speed instead of hard-coded values')
    Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: Yishai Hadas <yishaih@mellanox.com>
    Signed-off-by: Daniel Jurgens <danielj@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1039b7f5c7ef027279a2f554e31bcb529163d335
Author: Jack Morgenstein <jackm@dev.mellanox.co.il>
Date:   Thu Nov 10 11:30:57 2016 +0200

    IB/mlx4: Handle well-known-gid in mad_demux processing
    
    commit befcabcd530e4ffb6f016638f693b7d94986d2ba upstream.
    
    If OpenSM runs over a ConnectX-3, and there are ConnectX-4 or Connect-IB
    VFs active on the network, the OpenSM will receive QP1 packets containing
    a GRH where the destination GID is the "Well-Known GID" -- which is not a
    GID in the HCA Port's GID Table.
    
    This GID must be tested-for separately -- and packets which contain
    this destination GID should be routed to slave 0 (the PF).
    
    Fixes: 37bfc7c1e83f ('IB/mlx4: SR-IOV multiplex and demultiplex MADs')
    Signed-off-by: Jack Morgenstein <jackm@dev.mellanox.co.il>
    Signed-off-by: Daniel Jurgens <danielj@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 618d14b01a45cb0fbfe5ad1177699e4a49dec237
Author: Jack Morgenstein <jackm@dev.mellanox.co.il>
Date:   Sun Nov 27 15:18:19 2016 +0200

    IB/mlx4: Fix out-of-range array index in destroy qp flow
    
    commit c482af646d0809a8d5e1b7f4398cce3592589b98 upstream.
    
    For non-special QPs, the port value becomes non-zero only at the
    RESET-to-INIT transition. If the QP has not undergone that transition,
    its port number value is still zero.
    
    If such a QP is destroyed before being moved out of the RESET state,
    subtracting one from the qp port number results in a negative value.
    Using that negative value as an index into the qp1_proxy array
    results in an out-of-bounds array reference.
    
    Fix this by testing that the QP type is one that uses qp1_proxy before
    using the port number. For special QPs of all types, the port number is
    specified at QP creation time.
    
    Fixes: 9433c188915c ("IB/mlx4: Invoke UPDATE_QP for proxy QP1 on MAC changes")
    Signed-off-by: Jack Morgenstein <jackm@dev.mellanox.co.il>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 970f6806c2b17054ab47cfa0751d8e4150a92c1f
Author: Maor Gottlieb <maorg@mellanox.com>
Date:   Thu Nov 10 11:30:53 2016 +0200

    IB/mlx4: Set traffic class in AH
    
    commit af4295c117b82a521b05d0daf39ce879d26e6cb1 upstream.
    
    Set traffic class within sl_tclass_flowlabel when create iboe AH.
    Without this the TOS value will be empty when running VLAN tagged
    traffic, because the TOS value is taken from the traffic class in the
    address handle attributes.
    
    Fixes: 9106c4106974 ('IB/mlx4: Fix SL to 802.1Q priority-bits mapping for IBoE')
    Signed-off-by: Maor Gottlieb <maorg@mellanox.com>
    Signed-off-by: Daniel Jurgens <danielj@mellanox.com>
    Reviewed-by: Mark Bloch <markb@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0d64860aa6389e4cd23da3ef1eb648fbeded1060
Author: Eli Cohen <eli@mellanox.com>
Date:   Thu Oct 27 16:36:43 2016 +0300

    IB/mlx5: Wait for all async command completions to complete
    
    commit acbda523884dcf45613bf6818d8ead5180df35c2 upstream.
    
    Wait before continuing unload till all pending mkey async creation requests
    are done.
    
    Fixes: e126ba97dba9 ('mlx5: Add driver for Mellanox Connect-IB adapters')
    Signed-off-by: Eli Cohen <eli@mellanox.com>
    Signed-off-by: Maor Gottlieb <maorg@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7c8441c89043d9914a441e5589bb76148f1a93da
Author: Maor Gottlieb <maorg@mellanox.com>
Date:   Sun Nov 27 15:18:20 2016 +0200

    IB/mlx5: Assign SRQ type earlier
    
    commit c73b7911de97fad3ab9032a110af48d6ab2da48f upstream.
    
    Move the SRQ type assignment to be before actually using it
    in create_srq_user() and in create_srq_kernel() functions.
    
    Fixes: af1ba291c5e4 ('{net, IB}/mlx5: Refactor internal SRQ API')
    Signed-off-by: Maor Gottlieb <maorg@mellanox.com>
    Reviewed-by: Majd Dibbiny <majd@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dae9f4f144119229e4218f92ec0876549460ed45
Author: Eli Cohen <eli@mellanox.com>
Date:   Thu Oct 27 16:36:45 2016 +0300

    IB/mlx5: Fix reported max SGE calculation
    
    commit 288c01b746aab484651391ca6d64b585d3eb5ec6 upstream.
    
    Add the 512 bytes limit of RDMA READ and the size of remote
    address to the max SGE calculation.
    
    Fixes: e126ba97dba9 ('mlx5: Add driver for Mellanox Connect-IB adapters')
    Signed-off-by: Eli Cohen <eli@mellanox.com>
    Signed-off-by: Maor Gottlieb <maorg@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4db097fe49ea9dc608e614fbf46bc7463be0eb76
Author: Eli Cohen <eli@mellanox.com>
Date:   Sun Nov 27 15:18:21 2016 +0200

    IB/mlx5: Avoid system crash when enabling many VFs
    
    commit afd02cd3a9b6c04b41d946b5d7f6e17b3fc30c6b upstream.
    
    When enabling many VFs, the total amount of DMA mappings increase
    significantly. This causes DMA allocations to take a lot of time
    since they are serialized in the kernel.
    
    As a result the driver enters into fatal condition due to
    timeout and the system hangs. To recover from this we disable
    MR cache for VFs.
    
    PFs will still have a full cache and VFs cache can be manipulated
    as usual after driver load.
    
    Fixes: e126ba97dba9 ('mlx5: Add driver for Mellanox Connect-IB adapters')
    Signed-off-by: Eli Cohen <eli@mellanox.com>
    Signed-off-by: Maor Gottlieb <maorg@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 45f3a7eb2ca05a8cd0e56889fba96b548077f7a3
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Mon Sep 19 13:57:26 2016 +0200

    IB/rxe: avoid putting a large struct rxe_qp on stack
    
    commit a0fa72683e78979ef1123d679b1c40ae28bd9096 upstream.
    
    A race condition fix added an rxe_qp structure to the stack in order
    to be able to perform rollback in rxe_requester(), but the structure
    is large enough to trigger the warning for possible stack overflow:
    
    drivers/infiniband/sw/rxe/rxe_req.c: In function 'rxe_requester':
    drivers/infiniband/sw/rxe/rxe_req.c:757:1: error: the frame size of 2064 bytes is larger than 1024 bytes [-Werror=frame-larger-than=]
    
    This changes the rollback function to only save the psn inside
    the qp, which is the only field we access in the rollback_qp
    anyway.
    
    Fixes: 3050b9985024 ("IB/rxe: Fix race condition between requester and completer")
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Reviewed-by: Leon Romanovsky <leonro@mellanox.com>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 25c72b518734ec5d4dfb7ad90d785ff8efc04eb7
Author: Yonatan Cohen <yonatanc@mellanox.com>
Date:   Wed Nov 16 10:39:16 2016 +0200

    IB/rxe: Increase max number of completions to 32k
    
    commit d680ebed91e0b45c43ae03a880a0b43211096161 upstream.
    
    Increase limit of max CQE from 8K to 32K to allow demanding
    applications to work over SoftRoCE with same configuration
    as most RoCEv2 HW vendors have.
    
    Fixes: 8700e3e7c485 ("Soft RoCE driver")
    Signed-off-by: Yonatan Cohen <yonatanc@mellanox.com>
    Reviewed-by: Moni Shoua <monis@mellanox.com>
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b7c55155983403fe654324e4828e79bd7aab8d76
Author: Leon Romanovsky <leon@kernel.org>
Date:   Thu Nov 3 16:44:11 2016 +0200

    IB/core: Release allocated memory in cache setup failure
    
    commit aa6aae38f7fb2c030f326a6dd10b58fff1851dfa upstream.
    
    The failure in ib_cache_setup_one function during
    ib_register_device will leave leaked allocated memory.
    
    Fixes: 03db3a2d81e6 ("IB/core: Add RoCE GID table management")
    Signed-off-by: Leon Romanovsky <leon@kernel.org>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
