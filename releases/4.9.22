commit cf2586e60ede2217d7f53a0585e27e1cca693600
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Wed Apr 12 12:41:42 2017 +0200

    Linux 4.9.22

commit 7eae64f9195ce67ab635ca07bde258edc00b10a6
Author: Matjaz Hegedic <matjaz.hegedic@gmail.com>
Date:   Tue Apr 4 19:32:38 2017 +0000

    x86/reboot/quirks: Fix typo in ASUS EeeBook X205TA reboot quirk
    
    [ Upstream commit bba8376aea1dcbbe22bbda118c52abee317c7609 ]
    
    The reboot quirk for ASUS EeeBook X205TA contains a typo in
    DMI_PRODUCT_NAME, improperly referring to X205TAW instead of
    X205TA, which prevents the quirk from being triggered. The
    model X205TAW already has a reboot quirk of its own.
    
    This fix simply removes the inappropriate final letter W.
    
    Fixes: 90b28ded88dd ("x86/reboot/quirks: Add ASUS EeeBook X205TA reboot quirk")
    Signed-off-by: Matjaz Hegedic <matjaz.hegedic@gmail.com>
    Link: http://lkml.kernel.org/r/1489064417-7445-1-git-send-email-matjaz.hegedic@gmail.com
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit af11789a05485a0ddc6c5d4e2b9a658ff3c2e7bf
Author: Tobias Jakobi <tjakobi@math.uni-bielefeld.de>
Date:   Tue Apr 4 19:32:38 2017 +0000

    usb-storage: Add ignore-residue quirk for Initio INIC-3619
    
    [ Upstream commit d595259fbb7a7afed241b1afb2c4fe4b47de47fa ]
    
    This USB-SATA bridge chip is used in a StarTech enclosure for
    optical drives.
    
    Without the quirk MakeMKV fails during the key exchange with an
    installed BluRay drive:
    > Error 'Scsi error - ILLEGAL REQUEST:COPY PROTECTION KEY EXCHANGE FAILURE - KEY NOT ESTABLISHED'
    > occurred while issuing SCSI command AD010..080002400 to device 'SG:dev_11:2'
    
    Signed-off-by: Tobias Jakobi <tjakobi@math.uni-bielefeld.de>
    Acked-by: Alan Stern <stern@rowland.harvard.edu>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e5525c7419f16e75c31dd5eaa25c375882ec99bd
Author: Matjaz Hegedic <matjaz.hegedic@gmail.com>
Date:   Tue Apr 4 19:32:38 2017 +0000

    x86/reboot/quirks: Add ASUS EeeBook X205TA/W reboot quirk
    
    [ Upstream commit 3b3e78552d3077ec70d2640e629e07e3ab416a6a ]
    
    Without the parameter reboot=a, ASUS EeeBook X205TA/W will hang
    when it should reboot. This adds the appropriate quirk, thus
    fixing the problem.
    
    Signed-off-by: Matjaz Hegedic <matjaz.hegedic@gmail.com>
    Link: http://lkml.kernel.org/r/1488737804-20681-1-git-send-email-matjaz.hegedic@gmail.com
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0605fff95d3328f42c2b78f48144c6a5174bc899
Author: Matjaz Hegedic <matjaz.hegedic@gmail.com>
Date:   Tue Apr 4 19:32:37 2017 +0000

    x86/reboot/quirks: Add ASUS EeeBook X205TA reboot quirk
    
    [ Upstream commit 90b28ded88dda8bea82b4a86923e73ba0746d884 ]
    
    Without the parameter reboot=a, ASUS EeeBook X205TA will hang when it should reboot.
    
    This adds the appropriate quirk, thus fixing the problem.
    
    Signed-off-by: Matjaz Hegedic <matjaz.hegedic@gmail.com>
    Cc: Andy Lutomirski <luto@kernel.org>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: Brian Gerst <brgerst@gmail.com>
    Cc: Denys Vlasenko <dvlasenk@redhat.com>
    Cc: H. Peter Anvin <hpa@zytor.com>
    Cc: Josh Poimboeuf <jpoimboe@redhat.com>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Ingo Molnar <mingo@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7c6b1ad9deb53d40a7a3dd7e2ad05e4e65ad10e0
Author: João Paulo Rechi Vita <jprvita@gmail.com>
Date:   Tue Apr 4 19:32:36 2017 +0000

    platform/x86: asus-wmi: Detect quirk_no_rfkill from the DSDT
    
    [ Upstream commit 71050ae7bf83e4d71a859257d11adc5de517073e ]
    
    Some Asus laptops that have an airplane-mode indicator LED, also have
    the WMI WLAN user bit set, and the following bits in their DSDT:
    
        Scope (_SB)
        {
          (...)
          Device (ATKD)
          {
            (...)
            Method (WMNB, 3, Serialized)
            {
              (...)
              If (LEqual (IIA0, 0x00010002))
              {
                OWGD (IIA1)
                Return (One)
              }
            }
          }
        }
    
    So when asus-wmi uses ASUS_WMI_DEVID_WLAN_LED (0x00010002) to store the
    wlan state, it drives the airplane-mode indicator LED (through the call
    to OWGD) in an inverted fashion: the LED is ON when airplane mode is OFF
    (since wlan is ON), and vice-versa.
    
    This commit skips registering RFKill switches at all for these laptops,
    to allow the asus-wireless driver to drive the airplane mode LED
    correctly through the ASHS ACPI device. Relying on the presence of ASHS
    and ASUS_WMI_DSTS_USER_BIT avoids adding DMI-based quirks for at least
    21 different laptops.
    
    Signed-off-by: João Paulo Rechi Vita <jprvita@endlessm.com>
    Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 71f38c11cdb87f0372cbedb599c08d7915fdd448
Author: Kai-Chuan Hsieh <kai.chiuan@gmail.com>
Date:   Tue Apr 4 19:32:36 2017 +0000

    platform/x86: asus-wmi: Set specified XUSB2PR value for X550LB
    
    [ Upstream commit 8023eff10e7b0327898f17f0b553d2e45c71cef3 ]
    
    The bluetooth adapter Atheros AR3012 can't be enumerated
    and make the bluetooth function broken.
    
    T:  Bus=02 Lev=01 Prnt=01 Port=05 Cnt=02 Dev#=  5 Spd=12  MxCh= 0
    D:  Ver= 1.10 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
    P:  Vendor=13d3 ProdID=3362 Rev=00.02
    S:  Manufacturer=Atheros Communications
    S:  Product=Bluetooth USB Host Controller
    S:  SerialNumber=Alaska Day 2006
    C:  #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
    I:  If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    I:  If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    
    The error is:
    
     usb 2-6: device not accepting address 7, error -62
     usb usb2-port6: unable to enumerate USB device
    
    It is caused by adapter's connected port is mapped to xHC
    controller, but the xHCI is not supported by the usb device.
    
    The output of 'sudo lspci -nnxxx -s 00:14.0':
    
     00:14.0 USB controller [0c03]: Intel Corporation 8 Series USB xHCI HC [8086:9c31] (rev 04)
     00: 86 80 31 9c 06 04 90 02 04 30 03 0c 00 00 00 00
     10: 04 00 a0 f7 00 00 00 00 00 00 00 00 00 00 00 00
     20: 00 00 00 00 00 00 00 00 00 00 00 00 43 10 1f 20
     30: 00 00 00 00 70 00 00 00 00 00 00 00 0b 01 00 00
     40: fd 01 36 80 89 c6 0f 80 00 00 00 00 00 00 00 00
     50: 5f 2e ce 0f 00 00 00 00 00 00 00 00 00 00 00 00
     60: 30 20 00 00 00 00 00 00 00 00 00 00 00 00 00 00
     70: 01 80 c2 c1 08 00 00 00 00 00 00 00 00 00 00 00
     80: 05 00 87 00 0c a0 e0 fe 00 00 00 00 a1 41 00 00
     90: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
     a0: 00 01 04 00 00 00 00 00 00 00 00 00 00 00 00 00
     b0: 0f 00 03 00 00 00 00 00 00 00 00 00 00 00 00 00
     c0: 03 c0 30 00 00 00 00 00 03 0c 00 00 00 00 00 00
     d0: f9 01 00 00 f9 01 00 00 0f 00 00 00 0f 00 00 00
     e0: 00 08 00 00 00 00 00 00 00 00 00 00 d8 d8 00 00
     f0: 00 00 00 00 00 00 00 00 b1 0f 04 08 00 00 00 00
    
    By referencing Intel Platform Controller Hub(PCH) datasheet,
    the xHC USB 2.0 Port Routing(XUSB2PR) at offset 0xD0-0xD3h
    decides the setting of mapping the port to EHCI controller or
    xHC controller. And the port mapped to xHC will enable xHCI
    during bus resume.
    
    The setting of disabling bluetooth adapter's connected port is
    0x000001D9. The value can be obtained by few times 1 bit flip
    operation. The suited configuration should have the 'lsusb -t'
    result with bluetooth using ehci:
    
    /:  Bus 03.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/4p, 5000M
    /:  Bus 02.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/9p, 480M
        |__ Port 5: Dev 2, If 0, Class=Video, Driver=uvcvideo, 480M
        |__ Port 5: Dev 2, If 1, Class=Video, Driver=uvcvideo, 480M
    /:  Bus 01.Port 1: Dev 1, Class=root_hub, Driver=ehci-pci/2p, 480M
        |__ Port 1: Dev 2, If 0, Class=Hub, Driver=hub/8p, 480M
            |__ Port 6: Dev 3, If 0, Class=Wireless, Driver=btusb, 12M
            |__ Port 6: Dev 3, If 1, Class=Wireless, Driver=btusb, 12M
    
    Signed-off-by: Kai-Chuan Hsieh <kai.chiuan@gmail.com>
    Acked-by: Corentin Chary <corentin.chary@gmail.com>
    Reviewed-by: Andy Shevchenko <andy.shevchenko@gmail.com>
    [andy: resolve merge conflict in asus-wmi.h]
    Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4dc1eb47fbea4018715f017ff83b77e1a8d79f62
Author: Krzysztof Kozlowski <krzk@kernel.org>
Date:   Tue Apr 4 19:32:35 2017 +0000

    watchdog: s3c2410: Fix infinite interrupt in soft mode
    
    [ Upstream commit 0b445549ea6f91ffea78a976fe89b932db6e077a ]
    
    In soft (no-reboot) mode, the driver self-pings watchdog upon expiration
    of an interrupt.  However the interrupt itself was not cleared thus on
    first hit, the system enters infinite interrupt handling loop.
    
    On Odroid U3 (Exynos4412), when booted with s3c2410_wdt.soft_noboot=1
    argument the console is flooded:
            # killall -9 watchdog
            [   60.523760] s3c2410-wdt 10060000.watchdog: watchdog timer expired (irq)
            [   60.536744] s3c2410-wdt 10060000.watchdog: watchdog timer expired (irq)
    
    Fix this by writing something to the WTCLRINT register to clear the
    interrupt.  The register WTCLRINT however appeared in S3C6410 so a new
    watchdog quirk and flavor are needed.
    
    Signed-off-by: Krzysztof Kozlowski <krzk@kernel.org>
    Reviewed-by: Guenter Roeck <linux@roeck-us.net>
    Signed-off-by: Guenter Roeck <linux@roeck-us.net>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b18877ff66cf564c0e2f31086239ceb6b82cb4f4
Author: Sinan Kaya <okaya@codeaurora.org>
Date:   Tue Apr 4 19:32:34 2017 +0000

    PCI: Add ACS quirk for Qualcomm QDF2400 and QDF2432
    
    [ Upstream commit 33be632b8443b6ac74aa293504f430604fb9abeb ]
    
    The Qualcomm QDF2xxx root ports don't advertise an ACS capability, but they
    do provide ACS-like features to disable peer transactions and validate bus
    numbers in requests.
    
    To be specific:
    * Hardware supports source validation but it will report the issue as
    Completer Abort instead of ACS Violation.
    
    * Hardware doesn't support peer-to-peer and each root port is a root
    complex with unique segment numbers.
    
    * It is not possible for one root port to pass traffic to the other root
    port.  All PCIe transactions are terminated inside the root port.
    
    Add an ACS quirk for the QDF2400 and QDF2432 products.
    
    [bhelgaas: changelog]
    Signed-off-by: Sinan Kaya <okaya@codeaurora.org>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Reviewed-by: Alex Williamson <alex.williamson@redhat.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5feac34f670c3f02f14363674551f9568324e888
Author: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Date:   Tue Apr 4 19:32:34 2017 +0000

    PCI: Sort the list of devices with D3 delay quirk by ID
    
    [ Upstream commit cd3e2eb8905d14fe28a2fc75362b8ecec16f0fb6 ]
    
    Sort the list of Intel devices that have no PCI D3 delay by ID.  Add a
    comment for group of devices that had not been marked yet.
    
    There is no functional change.
    
    Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6b69d1f64499f14933731736561f89c650781f4f
Author: yangbo lu <yangbo.lu@nxp.com>
Date:   Tue Apr 4 19:32:33 2017 +0000

    mmc: sdhci-of-esdhc: remove default broken-cd for ARM
    
    [ Upstream commit e9acc77dd046b22c7ebf70e35f68968978445f8b ]
    
    Initially all QorIQ platforms were PowerPC architecture and they didn't
    support card detection except several platforms. The driver added the
    quirk SDHCI_QUIRK_BROKEN_CARD_DETECTION as default and this made broken-cd
    property in dts node didn't work. Now QorIQ platform turns to ARM
    architecture and most of them could support card detection. However it's
    a large number of dts trees that need to be fixed with broken-cd if we
    remove the default SDHCI_QUIRK_BROKEN_CARD_DETECTION in driver. And the
    users don't want to see this. So this patch is to remove this default
    quirk just for ARM and keep it for PowerPC.(Note, QorIQ PowerPC platform
    only has big-endian eSDHC while QorIQ ARM platform has big-endian or
    little-endian eSDHC) This makes broken-cd property work again for ARM.
    
    Signed-off-by: Yangbo Lu <yangbo.lu@nxp.com>
    Acked-by: Adrian Hunter <adrian.hunter@intel.com>
    Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0ddf07d2a130adda9bfe7ec1fd0be88426862ccb
Author: Dongdong Liu <liudongdong3@huawei.com>
Date:   Tue Apr 4 19:32:33 2017 +0000

    PCI: Disable MSI for HiSilicon Hip06/Hip07 Root Ports
    
    [ Upstream commit 72f2ff0deb870145a5a2d24cd75b4f9936159a62 ]
    
    The PCIe Root Port in Hip06/Hip07 SoCs advertises an MSI capability, but it
    cannot generate MSIs.  It can transfer MSI/MSI-X from downstream devices,
    but does not support MSI/MSI-X itself.
    
    Add a quirk to prevent use of MSI/MSI-X by the Root Port.
    
    [bhelgaas: changelog, sort vendor ID #define, drop device ID #define]
    Signed-off-by: Dongdong Liu <liudongdong3@huawei.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Reviewed-by: Gabriele Paoloni <gabriele.paoloni@huawei.com>
    Reviewed-by: Zhou Wang <wangzhou1@hisilicon.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 28dd2313a6e4144a3cd41bc112b2d951dcf09a53
Author: Jon Mason <jon.mason@broadcom.com>
Date:   Tue Apr 4 19:32:33 2017 +0000

    PCI: Add Broadcom Northstar2 PAXC quirk for device class and MPSS
    
    [ Upstream commit ce709f86501a013e941e9986cb072eae375ddf3e ]
    
    The Broadcom Northstar2 SoC has a number of quirks for the PAXC
    (internal/fake) PCI bus.  Specifically, the PCI config space is shared
    between the root port and the first PF (ie., PF0), and a number of fields
    are tied to zero (thus preventing them from being set).  These cannot be
    "fixed" in device firmware, so we must fix them with a quirk.
    
    Signed-off-by: Jon Mason <jon.mason@broadcom.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 35b366d584da2a82444f73d8c17d5afb84b3f8e2
Author: Will Deacon <will@kernel.org>
Date:   Tue Apr 4 19:32:32 2017 +0000

    ARM: smccc: Update HVC comment to describe new quirk parameter
    
    [ Upstream commit 3046ec674d441562c6bb3e4284cd866743042ef3 ]
    
    Commit 680a0873e193 ("arm: kernel: Add SMC structure parameter") added
    a new "quirk" parameter to the SMC and HVC SMCCC backends, but only
    updated the comment for the SMC version. This patch adds the new
    paramater to the comment describing the HVC version too.
    
    Signed-off-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 25bdb190ade0185b751cf6c428e01b9d4e4596dc
Author: Baoyou Xie <baoyou.xie@linaro.org>
Date:   Tue Apr 4 19:32:32 2017 +0000

    drm/msm/adreno: move function declarations to header file
    
    [ Upstream commit a5725ab0497ad91a2df7c01a78bf1a0cc5be4526 ]
    
    We get 2 warnings when building kernel with W=1:
    drivers/gpu/drm/msm/adreno/a3xx_gpu.c:535:17: warning: no previous prototype for 'a3xx_gpu_init' [-Wmissing-prototypes]
    drivers/gpu/drm/msm/adreno/a4xx_gpu.c:624:17: warning: no previous prototype for 'a4xx_gpu_init' [-Wmissing-prototypes]
    
    In fact, both functions are declared in
    drivers/gpu/drm/msm/adreno/adreno_device.c, but should be declared
    in a header file. So this patch moves both function declarations to
    drivers/gpu/drm/msm/adreno/adreno_gpu.h.
    
    Signed-off-by: Baoyou Xie <baoyou.xie@linaro.org>
    Reviewed-by: Arnd Bergmann <arnd@arndb.de>
    Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Link: http://patchwork.freedesktop.org/patch/msgid/1477127865-9381-1-git-send-email-baoyou.xie@linaro.org
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bec9918bb4dae2099c37791133403c32aa2738c7
Author: Andy Gross <andy.gross@linaro.org>
Date:   Tue Apr 4 19:32:32 2017 +0000

    firmware: qcom: scm: Fix interrupted SCM calls
    
    [ Upstream commit 82bcd087029f6056506ea929f11af02622230901 ]
    
    This patch adds a Qualcomm specific quirk to the arm_smccc_smc call.
    
    On Qualcomm ARM64 platforms, the SMC call can return before it has
    completed.  If this occurs, the call can be restarted, but it requires
    using the returned session ID value from the interrupted SMC call.
    
    The quirk stores off the session ID from the interrupted call in the
    quirk structure so that it can be used by the caller.
    
    This patch folds in a fix given by Sricharan R:
    https://lkml.org/lkml/2016/9/28/272
    
    Signed-off-by: Andy Gross <andy.gross@linaro.org>
    Reviewed-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 007f0a2f2c0fcfa9ecef016c0910aebd0b784fdd
Author: Andy Gross <andy.gross@linaro.org>
Date:   Tue Apr 4 19:32:31 2017 +0000

    arm: kernel: Add SMC structure parameter
    
    [ Upstream commit 680a0873e193bae666439f4b5e32c758e68f114c ]
    
    This patch adds a quirk parameter to the arm_smccc_(smc/hvc) calls.
    The quirk structure allows for specialized SMC operations due to SoC
    specific requirements.  The current arm_smccc_(smc/hvc) is renamed and
    macros are used instead to specify the standard arm_smccc_(smc/hvc) or
    the arm_smccc_(smc/hvc)_quirk function.
    
    This patch and partial implementation was suggested by Will Deacon.
    
    Signed-off-by: Andy Gross <andy.gross@linaro.org>
    Reviewed-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 703f48a1c302f66e686535355092116ebaeccaad
Author: Ping Cheng <pinglinux@gmail.com>
Date:   Tue Apr 4 19:32:31 2017 +0000

    HID: wacom: don't apply generic settings to old devices
    
    [ Upstream commit e7deb1570a527d3c74be4e21a72b1b459605c501 ]
    
    Non-generic devices have numbered_buttons set for both pen and
    touch interfaces by default. The actual number of buttons on the
    interface is normally manually decided later, which is different
    from what those HID generic devices are processed, where number
    of buttons are directly retrieved from HID descriptors.
    
    This patch adds the missed HID_GENERIC check and moves the statement
    to wacom_setup_pad_input_capabilities since it's not a quirk anymore.
    
    Signed-off-by: Ping Cheng <ping.cheng@wacom.com>
    Reviewed-by: Jason Gerecke <jason.gerecke@wacom.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit abb640893830c7bddd0dd75ef5184c688eb94dc0
Author: Mylène Josserand <mylene.josserand@free-electrons.com>
Date:   Tue Apr 4 19:32:30 2017 +0000

    ASoC: sun4i-i2s: Add quirks to handle a31 compatible
    
    [ Upstream commit 2ad6f30de7087515a0bc2a718fca6681a57739a0 ]
    
    Some SoCs have a reset line that must be asserted/deasserted.
    This patch adds a quirk to handle the new compatible
    "allwinner,sun6i-a31-i2s" which will deassert the reset
    line on probe function and assert it on remove's one.
    
    This new compatible is useful in case of A33 codec driver, for example.
    
    Signed-off-by: Mylène Josserand <mylene.josserand@free-electrons.com>
    Acked-by: Maxime Ripard <maxime.ripard@free-electrons.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3d2f06d8d180f288ae79d8bd2eb7eee5e2599f31
Author: Zhang Rui <rui.zhang@intel.com>
Date:   Tue Apr 4 19:32:29 2017 +0000

    ACPI: save NVS memory for Lenovo G50-45
    
    [ Upstream commit cbc00c1310d34139a63946482b40a6b261a03fb9 ]
    
    In commit 821d6f0359b0 (ACPI / sleep: Do not save NVS for new machines to
    accelerate S3), to optimize S3 suspend/resume speed, code is introduced
    to ignore NVS memory saving during S3 for all the platforms later than
    2012.
    
    But, Lenovo G50-45, a platform released in 2015, still needs NVS memory
    saving during S3. A quirk is introduced for this platform.
    
    Link: https://bugzilla.kernel.org/show_bug.cgi?id=189431
    Tested-by: Przemek <soprwa@gmail.com>
    Signed-off-by: Zhang Rui <rui.zhang@intel.com>
    [ rjw: Drop unnecessary code ]
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 09f78f116c03d9ffc06bdbf5930228313d9b5d5e
Author: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Date:   Tue Apr 4 19:32:29 2017 +0000

    ASoC: Intel: cht_bsw_rt5645: add Baytrail MCLK support
    
    [ Upstream commit a50477e55fff69e1028f25624ee9fc9182d59b1f ]
    
    The existing code assumes a 19.2 MHz MCLK as the default
    hardware configuration. This is valid for CherryTrail but
    not for Baytrail.
    
    Add explicit MCLK configuration to set the 19.2 clock on/off
    depending on DAPM events.
    
    This is a prerequisite step to enable devices with Baytrail
    and RT5645 such as Asus X205TA
    
    Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 584f4318f9236a8b30b0d8717bb047749bc72095
Author: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Date:   Tue Apr 4 19:32:29 2017 +0000

    ASoC: Intel: cht_bsw_rt5645: harden ACPI device detection
    
    [ Upstream commit 42648c2270ca0c96935dfc5d0f5c4f8d2406cf75 ]
    
    Fix classic issue of having multiple codecs listed in DSDT
    but a single one actually enabled. The previous code did
    not handle such errors and could also lead to uninitalized
    configurations
    
    Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4060a32e9d2471b030ce21f0519daecf2f17db5e
Author: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Date:   Tue Apr 4 19:32:28 2017 +0000

    ASoC: Intel: Baytrail: add quirk for Lenovo Thinkpad 10
    
    [ Upstream commit fd0138dc5d17c636477b371d99265c406437c583 ]
    
    the BIOS reports this codec as RT5640 but it's a rt5670. Use the
    quirk mechanism to use the cht_bsw_rt5672 machine driver
    
    Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d572cfb662643761d55934331b42a2b8d68701cc
Author: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Date:   Tue Apr 4 19:32:28 2017 +0000

    ASoC: codecs: rt5670: add quirk for Lenovo Thinkpad 10
    
    [ Upstream commit 93ffeaa8ee3f10a0628ad135b552a2497e0bef2c ]
    
    the BIOS incorrectly reports this codec as 5640 but it is
    really a rt5670
    
    Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 58153cca226fb32e77f102205050fcc752e1ffbe
Author: Takashi Iwai <tiwai@suse.de>
Date:   Tue Apr 4 19:32:28 2017 +0000

    ASoC: rt5670: Add missing 10EC5072 ACPI ID
    
    [ Upstream commit d25280060835e1b2b84c242905da8334ab15c5b4 ]
    
    rt5670 driver supports also RT5672 codec, but its ACPI ID is missing.
    This was found on Dell Wyse 3040 box.
    
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e4ae51e44b898262903c9b7a138e6fed8da388ce
Author: Lv Zheng <lv.zheng@intel.com>
Date:   Tue Apr 4 19:32:27 2017 +0000

    ACPI / button: Change default behavior to lid_init_state=open
    
    [ Upstream commit 77e9a4aa9de10cc1418bf9a892366988802a8025 ]
    
    More and more platforms need the button.lid_init_state=open quirk. This
    patch sets it the default behavior.
    
    If a platform doesn't send lid open event or lid open event is lost due to
    the underlying system problems, then we can compare various combinations:
    1. systemd/acpid is used to suspend system or not, systemd has a special
       logic forcing open event after resuming;
    2. _LID returns a cached value or not.
    
    The result is as follows:
    
     1. lid_init_state=method
       1. cached
          1. resumed by lid:
             (x) event=close
             (x) systemd=suspends again
             (x) acpid=suspends again
             (x) state=close
          2. resumed by other:
             (o) event=close
             (x) systemd=suspends again
             (x) acpid=suspends again
             (o) state=close
       2. non-cached
          1. resumed by lid:
             (o) event=open
             (o) systemd=resumes
             (o) acpid=resumes
             (o) state=open
          2. resumed by other:
             (o) event=close
             (x) systemd=suspends again
             (x) acpid=suspends again
             (o) state=close
     2. lid_init_state=open
       1. cached
          1. resumed by lid:
             (o) event=open
             (o) systemd=resumes
             (o) acpid=resumes
             (x) state=close
          2. resumed by other:
             (x) event=open
             (o) systemd=resumes
             (o) acpid=resumes
             (o) state=close
       2. non-cached
          1. resumed by lid:
             (o) event=open
             (o) systemd=resumes
             (o) acpid=resumes
             (o) state=open
          2. resumed by other:
             (x) event=open
             (o) systemd=resumes
             (o) acpid=resumes
             (o) state=close
     3. lid_init_state=ignore
       1. cached
          1. resumed by lid:
             (o) event=none
             (x) systemd=suspends again
             (o) acpid=resumes
             (x) state=close
          2. resumed by other:
             (o) event=none
             (x) systemd=suspends again
             (o) acpid=resumes
             (o) state=close
       2. non-cached
          1. resumed by lid:
             (o) event=none
             (x) systemd=suspends again
             (o) acpid=resumes
             (o) state=open
          2. resumed by other:
             (o) event=none
             (x) systemd=suspends again
             (o) acpid=resumes
             (o) state=close
    
    As a conclusion:
     1. With systemd changed, lid_init_state=ignore has only one problem and the
        problem comes from an underlying issue, not userspace and kernel lid
        handling.
     2. Without systemd changed, lid_init_state=open can be the default
        behavior as the pass ratio is not much worse than lid_init_state=ignore.
     3. lid_init_state=method is buggy, we can have a separate patch to make it
        deprectated.
    
    Link: https://bugzilla.kernel.org/show_bug.cgi?id=187271
    Signed-off-by: Lv Zheng <lv.zheng@intel.com>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b369fd719fa455c11665700d704ac2c9ba8d0e0a
Author: Bartosz Golaszewski <bgolaszewski@baylibre.com>
Date:   Tue Apr 4 19:32:27 2017 +0000

    sata: ahci-da850: implement a workaround for the softreset quirk
    
    [ Upstream commit f4d435f3265661d04e5290a0a0450e3a38898128 ]
    
    There's an issue with the da850 SATA controller: if port multiplier
    support is compiled in, but we're connecting the drive directly to
    the SATA port on the board, the drive can't be detected.
    
    To make SATA work on the da850-lcdk board: first try to softreset
    with pmp - if the operation fails with -EBUSY, retry without pmp.
    
    Signed-off-by: Bartosz Golaszewski <bgolaszewski@baylibre.com>
    Acked-by: Tejun Heo <tj@kernel.org>
    Signed-off-by: Sekhar Nori <nsekhar@ti.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f36d3f1fe79e3cbf9af18434b3b2800e6a210cf4
Author: Alex Williamson <alex.williamson@redhat.com>
Date:   Tue Apr 4 19:32:26 2017 +0000

    PCI: Add ACS quirk for Intel Union Point
    
    [ Upstream commit 7184f5b451cf3dc61de79091d235b5d2bba2782d ]
    
    Intel 200-series chipsets have the same errata as 100-series: the ACS
    capability doesn't follow the PCIe spec, the capability and control
    registers are dwords rather than words.  Add PCIe root port device IDs to
    existing quirk.
    
    Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a452e4eb6ee2cee7a062c3c3fca3b3ec0956e08d
Author: Patrice Chotard <patrice.chotard@st.com>
Date:   Tue Apr 4 19:32:25 2017 +0000

    ARM: dts: STiH407-family: set snps,dis_u3_susphy_quirk
    
    [ Upstream commit 8413299cb3933dade6186bbee8363f190032107e ]
    
    Since v4.10-rc1, the following logs appears in loop :
    [  801.953836] usb usb6-port1: Cannot enable. Maybe the USB cable is bad?
    [  801.960455] xhci-hcd xhci-hcd.0.auto: Cannot set link state.
    [  801.966611] usb usb6-port1: cannot disable (err = -32)
    [  806.083772] usb usb6-port1: Cannot enable. Maybe the USB cable is bad?
    [  806.090370] xhci-hcd xhci-hcd.0.auto: Cannot set link state.
    [  806.096494] usb usb6-port1: cannot disable (err = -32)
    
    After analysis, xhci try to set link in U3 and returns an error.
    Using snps,dis_u3_susphy_quirk fix this issue.
    
    Signed-off-by: Patrice Chotard <patrice.chotard@st.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9ec57c921b9d450520cd25dc52a6affb3a91186e
Author: Daniel Vetter <daniel.vetter@ffwll.ch>
Date:   Tue Apr 4 19:32:25 2017 +0000

    drm/mga: remove device_is_agp callback
    
    [ Upstream commit 858b2c1bf820ebfba89c5e2867ab882bdb5b2f5a ]
    
    It's only for a device quirk, and we might as well do that in the load
    callback.
    
    Acked-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Daniel Vetter <daniel.vetter@intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/20170125062657.19270-10-daniel.vetter@ffwll.ch
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ae3a3e209ef1e2fa7efac9bb54c6fe934755bff6
Author: Felipe Balbi <felipe.balbi@linux.intel.com>
Date:   Tue Apr 4 19:32:25 2017 +0000

    usb: dwc3: host: pass quirk-broken-port-ped property for known broken revisions
    
    [ Upstream commit e42a5dbb8a3d14f5a35bffa3bf7dcb87883f767a ]
    
    dwc3 revisions <=3.00a have a limitation where Port Disable command
    doesn't work. Set the quirk-broken-port-ped property for such
    controllers so XHCI core can do the necessary workaround.
    
    [rogerq@ti.com] Updated code from platform data to device property.
    
    Signed-off-by: Roger Quadros <rogerq@ti.com>
    Signed-off-by: Felipe Balbi <felipe.balbi@linux.intel.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7bdf7bebbbedb2bfe1dc3bcad71acb77bf660113
Author: Felipe Balbi <balbi@ti.com>
Date:   Tue Apr 4 19:32:24 2017 +0000

    usb: host: xhci-plat: enable BROKEN_PED quirk if platform requested
    
    [ Upstream commit 21939f003ad09355d9c975735750bb22aa37d8de ]
    
    In case 'quirk-broken-port-ped' property is passed in via device property,
    we should enable the corresponding BROKEN_PED quirk flag for XHCI core.
    
    [rogerq@ti.com] Updated code from platform data to device property
    and added DT binding.
    
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Roger Quadros <rogerq@ti.com>
    Signed-off-by: Mathias Nyman <mathias.nyman@linux.intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 15159247d25b70a310bcc1450c90050d266192ae
Author: Felipe Balbi <balbi@ti.com>
Date:   Tue Apr 4 19:32:24 2017 +0000

    usb: xhci: add quirk flag for broken PED bits
    
    [ Upstream commit 41135de1e7fd14c6fcb9158404ba5c8fb97bf259 ]
    
    Some devices from Texas Instruments [1] suffer from
    a silicon bug where Port Enabled/Disabled bit
    should not be used to silence an erroneous device.
    
    The bug is so that if port is disabled with PED
    bit, an IRQ for device removal (or attachment)
    will never fire.
    
    Just for the sake of completeness, the actual
    problem lies with SNPS USB IP and this affects
    all known versions up to 3.00a. A separate
    patch will be added to dwc3 to enabled this
    quirk flag if version is <= 3.00a.
    
    [1] - AM572x Silicon Errata http://www.ti.com/lit/er/sprz429j/sprz429j.pdf
    Section i896— USB xHCI Port Disable Feature Does Not Work
    
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Roger Quadros <rogerq@ti.com>
    Signed-off-by: Mathias Nyman <mathias.nyman@linux.intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 660b38eab8850198587a4cf1f047cddba2226a5d
Author: Kevin Hilman <khilman@baylibre.com>
Date:   Tue Apr 4 19:32:23 2017 +0000

    ARM: davinci: PM: support da8xx DT platforms
    
    [ Upstream commit 7e431af8fa0b9ed9d74378c99514856211cb9db8 ]
    
    Add PM support for DA850 device-tree boot.
    
    Signed-off-by: Kevin Hilman <khilman@baylibre.com>
    Signed-off-by: Sekhar Nori <nsekhar@ti.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit db7c1706fa6d9d1c2f2ab651814130b60bca26d1
Author: Geert Uytterhoeven <geert+renesas@glider.be>
Date:   Tue Apr 4 19:32:22 2017 +0000

    Input: gpio_keys - add support for GPIO descriptors
    
    [ Upstream commit 5feeca3c1e39c01f9ef5abc94dea94021ccf94fc ]
    
    GPIO descriptors are the preferred way over legacy GPIO numbers
    nowadays. Convert the driver to use GPIO descriptors internally but
    still allow passing legacy GPIO numbers from platform data to support
    existing platforms.
    
    Based on commits 633a21d80b4a2cd6 ("input: gpio_keys_polled: Add support
    for GPIO descriptors") and 1ae5ddb6f8837558 ("Input: gpio_keys_polled -
    request GPIO pin as input.").
    
    Signed-off-by: Geert Uytterhoeven <geert+renesas@glider.be>
    Reviewed-by: Linus Walleij <linus.walleij@linaro.org>
    Tested-by: Mika Westerberg <mika.westerberg@linux.intel.com>
    Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 80b0d7e623d10d4bc9bad2a35d6ce18e08454b3d
Author: Vignesh R <vigneshr@ti.com>
Date:   Tue Apr 4 19:32:22 2017 +0000

    serial: 8250_omap: Add OMAP_DMA_TX_KICK quirk for AM437x
    
    [ Upstream commit b6ffcf21082300519bc4f9c3d24f61207cc9eae4 ]
    
    UART uses as EDMA as dma engine on AM437x SoC and therefore, requires
    OMAP_DMA_TX_KICK quirk just like AM33xx. So, enable OMAP_DMA_TX_KICK
    quirk for AM437x platform as well. While at that, drop use of
    of_machine_is_compatible() and instead pass quirks via device data.
    
    Signed-off-by: Vignesh R <vigneshr@ti.com>
    Acked-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6b8deb1082730c867c44b59cb00a8320189d1f4b
Author: Stephen Boyd <stephen.boyd@linaro.org>
Date:   Tue Apr 4 19:32:21 2017 +0000

    usb: chipidea: msm: Rely on core to override AHBBURST
    
    [ Upstream commit dd3749099cfa2c80039193c438b90f3160eaf7f9 ]
    
    The core framework already handles setting this parameter with a
    platform quirk. Add the appropriate flag so that we always set
    AHBBURST to 0. Technically DT should be doing this, but we always
    do it for msm chipidea devices so setting the flag in the driver
    works just as well. If the burst needs to be anything besides 0,
    we expect the 'ahb-burst-config' dts property to be present.
    
    Acked-by: Peter Chen <peter.chen@nxp.com>
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Stephen Boyd <stephen.boyd@linaro.org>
    Signed-off-by: Peter Chen <peter.chen@nxp.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c5fc946a15dc2da428f4cca19ed5be1ad20dff30
Author: Subhash Jadavani <subhashj@codeaurora.org>
Date:   Tue Apr 4 19:32:20 2017 +0000

    scsi: ufs: issue link starup 2 times if device isn't active
    
    [ Upstream commit 7caf489b99a42a9017ef3d733912aea8794677e7 ]
    
    If we issue the link startup to the device while its UniPro state is
    LinkDown (and device state is sleep/power-down) then link startup
    will not move the device state to Active. Device will only move to
    active state if the link starup is issued when its UniPro state is
    LinkUp. So in this case, we would have to issue the link startup 2
    times to make sure that device moves to active state.
    
    Reviewed-by: Gilad Broner <gbroner@codeaurora.org>
    Signed-off-by: Subhash Jadavani <subhashj@codeaurora.org>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a17bddc4a78102ab55c7dbf76018b91e85694b07
Author: Zang Leigang <zangleigang@hisilicon.com>
Date:   Tue Apr 4 19:32:20 2017 +0000

    scsi: ufs: introduce a new ufshcd_statea UFSHCD_STATE_EH_SCHEDULED
    
    [ Upstream commit 141f81651037ea109188a6bafdc5c9a318bd5a46 ]
    
    Add a new ufshcd_state, indicats that an err handler may get to run
    immediately. Use UFSHCD_STATE_ERROR here looks not literaly correct.
    
    Signed-off-by: Zang Leigang <zangleigang@hisilicon.com>
    Reviewed-by: Subhash Jadavani <subhashj@codeaurora.org>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e94ed347105dff7619d52e24bb8c298c6d5d06fd
Author: youling257 <youling257@gmail.com>
Date:   Tue Apr 4 19:32:19 2017 +0000

    ASoC: Intel: bytcr_rt5640: quirks for Insyde devices
    
    [ Upstream commit 571800487837263e914ef68681e4ad6a57d49c7f ]
    
    There are literally dozens of Insyde devices with a different
    name but with the same audio routing. Use a generic quirk to
    match on vendor name only to avoid recurring edits of the
    same thing.
    
    Signed-off-by: youling257 <youling257@gmail.com>
    Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0ed0810b8b0222875f2c0fd373ef1e789cf50044
Author: Paulo Zanoni <paulo.r.zanoni@intel.com>
Date:   Tue Apr 4 19:32:19 2017 +0000

    drm/i915: actually drive the BDW reserved IDs
    
    [ Upstream commit 98b2f01c8dfc8922a2af1fe82a1c40cac4911634 ]
    
    Back in 2014, commit fb7023e0e248 ("drm/i915: BDW: Adding Reserved PCI
    IDs.") added the reserved PCI IDs in order to try to make sure we had
    working drivers in case we ever released products using these IDs
    (since we had instances of this type of problem in the past). The
    problem is that the patch only touched the macros used by
    early-quirks.c and by the user space components that rely on
    i915_pciids.h, it didn't touch the macros used by i915_pci.c. So we
    correctly handled the stolen memory for these theoretical IDs, but we
    didn't actually drive the devices from i915.ko.
    
    So this patch fixes the original commit by actually making i915.ko
    drive these IDs, which was the goal. There's no information on what
    would be the GT count on these IDs, so we just go with the safer
    intel_broadwell_info, at the risk of ignoring a possibly inexistent
    BSD2_RING.
    
    I did some checking, and it seems that these IDs are driven by
    intel-gpu-tools, xf86-video-intel and libdrm (since they contain old
    copies of i915_pciids.h), but they are not checked by mesa.
    
    The alternative to this patch would be to just assume we're actually
    never going to use these IDs, and then remove them from our ID lists
    and make sure our user space components sync the latest i915_pciids.h
    copy. I'm fine with either approaches, as long as we make sure that
    every component tries to drive the same list of PCI IDs.
    
    Fixes: fb7023e0e248 ("drm/i915: BDW: Adding Reserved PCI IDs.")
    Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
    Cc: Ben Widawsky <ben@bwidawsk.net>
    Cc: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Paulo Zanoni <paulo.r.zanoni@intel.com>
    Reviewed-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1483473860-17644-3-git-send-email-paulo.r.zanoni@intel.com
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 70797929ee364304d499003ea0e3a7de9c36ca14
Author: Paulo Zanoni <paulo.r.zanoni@intel.com>
Date:   Tue Apr 4 19:32:19 2017 +0000

    drm/i915: more .is_mobile cleanups for BDW
    
    [ Upstream commit 0784bc624ae9be4269f8129572ee164ca680ca7c ]
    
    Commit 8d9c20e1d1e3 ("drm/i915: Remove .is_mobile field from platform
    struct") removed mobile vs desktop differences for HSW+, but forgot
    the Broadwell reserved IDs, so do it now.
    
    It's interesting to notice that these IDs are used by early-quirks.c
    but are *not* used by i915_pci.c.
    
    Cc: Carlos Santa <carlos.santa@intel.com>
    Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
    Signed-off-by: Paulo Zanoni <paulo.r.zanoni@intel.com>
    Reviewed-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1483473860-17644-2-git-send-email-paulo.r.zanoni@intel.com
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0b348464eea01b2d4447c72a84d27e6d32a709ad
Author: Paulo Zanoni <paulo.r.zanoni@intel.com>
Date:   Tue Apr 4 19:32:18 2017 +0000

    drm/i915: fix INTEL_BDW_IDS definition
    
    [ Upstream commit 7fbd995ce4241e98d30859405504c3fb279c4ccb ]
    
    Remove duplicated IDs from the list. Currently, this definition is
    only used by early-quirks.c. From my understanding of the code, having
    duplicated IDs shouldn't be causing any bugs.
    
    Fixes: 8d9c20e1d1e3 ("drm/i915: Remove .is_mobile field from platform struct")
    Cc: Carlos Santa <carlos.santa@intel.com>
    Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
    Signed-off-by: Paulo Zanoni <paulo.r.zanoni@intel.com>
    Reviewed-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1483473860-17644-1-git-send-email-paulo.r.zanoni@intel.com
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 14ec1cf414cfc8e78a8a1074f1b50f54fa8bb703
Author: Jani Nikula <jani.nikula@intel.com>
Date:   Tue Apr 4 19:32:18 2017 +0000

    drm/edid: constify edid quirk list
    
    [ Upstream commit 23c4cfbdab494568600ae6073a2bf02be4b10f4e ]
    
    No reason not to be const.
    
    Reviewed-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1482923186-22430-1-git-send-email-jani.nikula@intel.com
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f188ee38d4cb1eaa9cac93574bb8ca79a6c6d424
Author: Marcel Hasler <mahasler@gmail.com>
Date:   Tue Apr 4 19:32:18 2017 +0000

    HID: usbhid: Add quirk for Mayflash/Dragonrise DolphinBar.
    
    [ Upstream commit 8aa2cc7e747881d1fd52db28261b201d4e3e5565 ]
    
    The DolphinBar by Mayflash (identified as Dragonrise) needs
    HID_QUIRK_MULTI_INPUT to split it up into four input devices. Without this
    quirk the adapter is falsely recognized as a tablet. See also bug 115841
    (https://bugzilla.kernel.org/show_bug.cgi?id=115841).
    
    Signed-off-by: Marcel Hasler <mahasler@gmail.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7fd75759ba073830c960baa540f6047f35d22760
Author: Alex Wood <thetewood@gmail.com>
Date:   Tue Apr 4 19:32:17 2017 +0000

    HID: usbhid: Add quirk for the Futaba TOSD-5711BB VFD
    
    [ Upstream commit f83f90cf7ba68deb09406ea9da80852a64c4db29 ]
    
    The Futaba TOSD-5711BB VFD crashes when the initial HID report is requested,
    register the display in hid-ids and tell hid-quirks to not do the init.
    
    Signed-off-by: Alex Wood <thetewood@gmail.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c1e94148f93c4319a1aea4ae29835cd1e2017ff9
Author: Lv Zheng <lv.zheng@intel.com>
Date:   Tue Apr 4 19:32:17 2017 +0000

    ACPI / sysfs: Provide quirk mechanism to prevent GPE flooding
    
    [ Upstream commit 9c4aa1eecb48cfac18ed5e3aca9d9ae58fbafc11 ]
    
    Sometimes, the users may require a quirk to be provided from ACPI subsystem
    core to prevent a GPE from flooding.
    Normally, if a GPE cannot be dispatched, ACPICA core automatically prevents
    the GPE from firing. But there are cases the GPE is dispatched by _Lxx/_Exx
    provided via AML table, and OSPM is lacking of the knowledge to get
    _Lxx/_Exx correctly executed to handle the GPE, thus the GPE flooding may
    still occur.
    
    The existing quirk mechanism can be enabled/disabled using the following
    commands to prevent such kind of GPE flooding during runtime:
     # echo mask > /sys/firmware/acpi/interrupts/gpe00
     # echo unmask > /sys/firmware/acpi/interrupts/gpe00
    To avoid GPE flooding during boot, we need a boot stage mechanism.
    
    This patch provides such a boot stage quirk mechanism to stop this kind of
    GPE flooding. This patch doesn't fix any feature gap but since the new
    feature gaps could be found in the future endlessly, and can disappear if
    the feature gaps are filled, providing a boot parameter rather than a DMI
    table should suffice.
    
    Link: https://bugzilla.kernel.org/show_bug.cgi?id=53071
    Link: https://bugzilla.kernel.org/show_bug.cgi?id=117481
    Link: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/887793
    Signed-off-by: Lv Zheng <lv.zheng@intel.com>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 43cfff65c989c0ef722bfcd2335b07a48e09aab9
Author: Keith Busch <keith.busch@intel.com>
Date:   Tue Apr 4 19:32:16 2017 +0000

    nvme: simplify stripe quirk
    
    [ Upstream commit e6282aef7b89a11d26e731060c4409b7aac278bf ]
    
    Some OEMs believe they own the Identify Controller vendor specific
    region and will repurpose it with their own values. While not common,
    we can't rely on the PCI VID:DID to tell use how to decode the field
    we reserved for this as the stripe size so we need to do something else
    for the list of devices using this quirk.
    
    The field was supposed to allow flexibility on the device's back-end
    striping, but it turned out that never materialized; the chunk is always
    the same as MDTS in the products subscribing to this quirk, so this
    patch removes the stripe_size field and sets the chunk to the max hw
    transfer size for the devices using this quirk.
    
    Signed-off-by: Keith Busch <keith.busch@intel.com>
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8d620dff40bab02f4da98c95e2fd47f445f5440a
Author: Lee, Chun-Yi <joeyli.kernel@gmail.com>
Date:   Tue Apr 4 19:32:14 2017 +0000

    platform/x86: acer-wmi: Only supports AMW0_GUID1 on acer family
    
    [ Upstream commit 5241b1938a4d33eee3d3b43f23067c8e5b96db45 ]
    
    The AMW0_GUID1 wmi is not only found on Acer family but also other
    machines like Lenovo, Fujitsu and Medion. In the past, acer-wmi handled
    those non-Acer machines by quirks list.
    
    But actually acer-wmi driver was loaded on any machine that had
    AMW0_GUID1. This behavior is strange because those machines should be
    supported by appropriate wmi drivers. e.g. fujitsu-laptop,
    ideapad-laptop.
    
    This patch adds the logic to check the machine that has AMW0_GUID1
    should be in Acer/Packard Bell/Gateway white list. But, it still keeps
    the quirk list of those supported non-acer machines for backward
    compatibility.
    
    Tested-by: Bjørn Mork <bjorn@mork.no>
    Signed-off-by: Lee, Chun-Yi <jlee@suse.com>
    Signed-off-by: Darren Hart <dvhart@linux.intel.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2bd6cc1cce47a4e572ba5f9107b34120cd8c3302
Author: Nobutaka Okabe <nob77413@gmail.com>
Date:   Tue Apr 4 19:32:14 2017 +0000

    ALSA: usb-audio: Add native DSD support for TEAC 501/503 DAC
    
    [ Upstream commit 7f38ca047b0cb54df7f6d9e4110e292e45dba6ad ]
    
    This patch adds native DSD support for the following devices.
    
    - TEAC NT-503
    - TEAC UD-503
    - TEAC UD-501
    
    (1) Add quirks for native DSD support for TEAC devices.
    (2) A specific vendor command is needed to switch between PCM/DOP and
        DSD mode, same as Denon/Marantz devices.
    
    Signed-off-by: Nobutaka Okabe <nob77413@gmail.com>
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8ae7242fea545a4dbaef6a4b545b6cf288a0d789
Author: Bjorn Helgaas <bhelgaas@google.com>
Date:   Tue Apr 4 19:32:14 2017 +0000

    PCI: Expand "VPD access disabled" quirk message
    
    [ Upstream commit 044bc425bb72ffdecfb2a66d50cb1d024ecb96d0 ]
    
    It's not very enlightening to see
    
      pci 0000:07:00.0: [Firmware Bug]: VPD access disabled
    
    in the dmesg log because there's no clue about what the firmware bug is.
    Expand the message to explain why we're disabling VPD.
    
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c0aac1bbb5d8a61a626092b0fd44219356d48cf4
Author: Alberto Aguirre <albaguirre@gmail.com>
Date:   Tue Apr 4 19:32:13 2017 +0000

    ALSA: usb-audio: add implicit fb quirk for Axe-Fx II
    
    [ Upstream commit 17f08b0d9aafccdb10038ab6dbd9ddb6433c13e2 ]
    
    The Axe-Fx II implicit feedback end point and the data sync endpoint
    are in different interface descriptors. Add quirk to ensure a sync
    endpoint is properly configured.
    
    Signed-off-by: Alberto Aguirre <albaguirre@gmail.com>
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bedc629494cdd55d1ef7d6d8bff294f8b07b919b
Author: Subhash Jadavani <subhashj@codeaurora.org>
Date:   Tue Apr 4 19:32:13 2017 +0000

    scsi: ufs: add quirk to increase host PA_SaveConfigTime
    
    [ Upstream commit 56d4a1866d748732fd8d690b2c2156bbc9c9eb02 ]
    
    The maximum value PA_SaveConfigTime is 250 (10us) but this is not enough
    for some vendors. Gear switch from PWM to HS may fail even with this
    max.  PA_SaveConfigTime. Gear switch can be issued by host controller as
    an error recovery and any software delay will not help on this case so
    we need to increase PA_SaveConfigTime to >32us as per vendor
    recommendation.  This change adds a quirk to increase the
    PA_SaveConfigTime parameter.
    
    Reviewed-by: Venkat Gopalakrishnan <venkatg@codeaurora.org>
    Signed-off-by: Subhash Jadavani <subhashj@codeaurora.org>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5c6b8ad1ab251d14545853b9bb4b3282d182aa67
Author: Bjorn Helgaas <bhelgaas@google.com>
Date:   Tue Apr 4 19:32:11 2017 +0000

    PCI: thunder-pem: Factor out resource lookup
    
    [ Upstream commit 0d414268fb8d0844030f87027e904f69d96706be ]
    
    Pull the register resource lookup out of thunder_pem_init() so we can
    easily add a corresponding lookup using ACPI.  No functional change
    intended.
    
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5582c1980eac27a1d2ae9ed2aee0ce04d4b6e2c9
Author: Bjorn Helgaas <bhelgaas@google.com>
Date:   Tue Apr 4 19:32:09 2017 +0000

    arm64: PCI: Add local struct device pointers
    
    [ Upstream commit dfd1972c2b464c10fb585c4c60b594e09d181a01 ]
    
    Use a local "struct device *dev" for brevity.  No functional change
    intended.
    
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Acked-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cc49b39f3f2d82c217a5f1f9c1ae795ec53fe786
Author: Tomasz Nowicki <tn@semihalf.com>
Date:   Tue Apr 4 19:32:08 2017 +0000

    arm64: PCI: Manage controller-specific data on per-controller basis
    
    [ Upstream commit 093d24a204425f71f4f106b7e62c8df4b456e1cc ]
    
    Currently we use one shared global acpi_pci_root_ops structure to keep
    controller-specific ops. We pass its pointer to acpi_pci_root_create() and
    associate it with a host bridge instance for good.  Such a design implies
    serious drawback. Any potential manipulation on the single system-wide
    acpi_pci_root_ops leads to kernel crash. The structure content is not
    really changing even across multiple host bridges creation; thus it was not
    an issue so far.
    
    In preparation for adding ECAM quirks mechanism (where controller-specific
    PCI ops may be different for each host bridge) allocate new
    acpi_pci_root_ops and fill in with data for each bridge. Now it is safe to
    have different controller-specific info. As a consequence free
    acpi_pci_root_ops when host bridge is released.
    
    No functional changes in this patch.
    
    Signed-off-by: Tomasz Nowicki <tn@semihalf.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Acked-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 625fd9d1af7070ff3a54c0c6e93a7c654425a1d7
Author: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Date:   Tue Apr 4 19:32:08 2017 +0000

    x86/intel_idle: Add CPU model 0x4a (Atom Z34xx series)
    
    [ Upstream commit 5e7ec268fd48d63cfd0e3a9be6c6443f01673bd4 ]
    
    Add CPU ID for Atom Z34xx processors. Datasheets indicate support for this,
    detailed information about potential quirks or limitations are missing, though.
    So we just reuse the definition from official BSP code.
    
    Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
    Signed-off-by: Len Brown <len.brown@intel.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 607ca1dccbbd880b9f2bddfda23ec8aed1c5acbe
Author: Chuck Lever <chuck.lever@oracle.com>
Date:   Tue Apr 4 19:32:07 2017 +0000

    svcauth_gss: Close connection when dropping an incoming message
    
    [ Upstream commit 4d712ef1db05c3aa5c3b690a50c37ebad584c53f ]
    
    S5.3.3.1 of RFC 2203 requires that an incoming GSS-wrapped message
    whose sequence number lies outside the current window is dropped.
    The rationale is:
    
      The reason for discarding requests silently is that the server
      is unable to determine if the duplicate or out of range request
      was due to a sequencing problem in the client, network, or the
      operating system, or due to some quirk in routing, or a replay
      attack by an intruder.  Discarding the request allows the client
      to recover after timing out, if indeed the duplication was
      unintentional or well intended.
    
    However, clients may rely on the server dropping the connection to
    indicate that a retransmit is needed. Without a connection reset, a
    client can wait forever without retransmitting, and the workload
    just stops dead. I've reproduced this behavior by running xfstests
    generic/323 on an NFSv4.0 mount with proto=rdma and sec=krb5i.
    
    To address this issue, have the server close the connection when it
    silently discards an incoming message due to a GSS sequence number
    problem.
    
    There are a few other places where the server will never reply.
    Change those spots in a similar fashion.
    
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: J. Bruce Fields <bfields@redhat.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3a87bcdebf6eeb094be139a42626edb7dce8c960
Author: Subhash Jadavani <subhashj@codeaurora.org>
Date:   Tue Apr 4 19:32:07 2017 +0000

    scsi: ufs: ensure that host pa_tactivate is higher than device
    
    [ Upstream commit c6a6db439868c7ba5cc90d4c461d9697ec731fa1 ]
    
    Some UFS devices require host PA_TACTIVATE to be higher than
    device PA_TACTIVATE otherwise it may get stuck during hibern8 sequence.
    This change allows this by using quirk.
    
    Reviewed-by: Venkat Gopalakrishnan <venkatg@codeaurora.org>
    Signed-off-by: Subhash Jadavani <subhashj@codeaurora.org>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d84be51d1c1d3fa148a3abdeeb1455690df59e63
Author: Ritesh Harjani <riteshh@codeaurora.org>
Date:   Tue Apr 4 19:32:07 2017 +0000

    mmc: sdhci-msm: Enable few quirks
    
    [ Upstream commit a0e3142869d29688de6f77be31aa7a401a4a88f1 ]
    
    sdhc-msm controller needs this SDHCI_QUIRK_CAP_CLOCK_BASE_BROKEN
    & SDHCI_QUIRK2_PRESET_VALUE_BROKEN to be set. Hence setting it.
    
    Signed-off-by: Sahitya Tummala <stummala@codeaurora.org>
    Signed-off-by: Ritesh Harjani <riteshh@codeaurora.org>
    Acked-by: Adrian Hunter <adrian.hunter@intel.com>
    Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c6e3c6628dfbb9950f829e3f2803476f486abf17
Author: Benjamin Tissoires <benjamin.tissoires@redhat.com>
Date:   Tue Apr 4 19:32:07 2017 +0000

    HID: multitouch: do not retrieve all reports for all devices
    
    [ Upstream commit b897f6db3ae2cd9a42377f8b1865450f34ceff0e ]
    
    We already have in place a quirk for Windows 8 devices, but it looks
    like the Surface Cover are not conforming to it.
    Given that we are only interested in 3 feature reports (the ones that
    the Windows driver retrieves), we should be safe to unconditionally apply
    the quirk to everybody.
    
    In case there is an issue with a controller, we can always mark it as such
    in the transport driver, and hid-multitouch won't try to retrieve the
    feature report.
    
    Signed-off-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 68a83be3813507da97024decc4a48d347524bfd6
Author: Benjamin Tissoires <benjamin.tissoires@redhat.com>
Date:   Tue Apr 4 19:32:06 2017 +0000

    HID: multitouch: enable the Surface 3 Type Cover to report multitouch data
    
    [ Upstream commit 8fe89ef076fa104f514da6ef61d90f5bf93488e3 ]
    
    There is no reasons to filter out keyboard and consumer control collections
    in hid-multitouch.
    With the previous hid-input fix, there is now a full support of the Type
    Cover and we can remove all specific bits from hid-core and hid-microsoft.
    
    hid-multitouch will automatically set HID_QUIRK_NO_INIT_REPORTS so we can
    also remove it from the list of ushbid quirks.
    
    Signed-off-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c5fcc6332ddb15e5812e21cc30c4c5d073274b28
Author: Benjamin Tissoires <benjamin.tissoires@redhat.com>
Date:   Tue Apr 4 19:32:06 2017 +0000

    HID: sensor-hub: add quirk for Microchip MM7150
    
    [ Upstream commit 5cc5084dd9afa2f9bf953b0217bdb1b7c2158be1 ]
    
    One more device requiring a quirk :/
    
    Reported-by: Christian-Nils Boda <christian-nils.boda@gadz.org>
    Signed-off-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 39f3c9291d6928b3fb752d8bc459c3483312ddda
Author: Benjamin Tissoires <benjamin.tissoires@redhat.com>
Date:   Tue Apr 4 19:32:06 2017 +0000

    HID: sensor-hub add quirk for Microsoft Surface 3
    
    [ Upstream commit da809197a919942ab6ee0d008c20a011872181b1 ]
    
    One more device requiring a quirk :/
    
    [jkosina@suse.cz: update comment based on Bastien's remark]
    Signed-off-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
    Tested-by: Bastien Nocera <hadess@hadess.net>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9b41ed79ec780817a1293d0cc10d7bf11846d1da
Author: Kiwoong Kim <kwmad.kim@samsung.com>
Date:   Tue Apr 4 19:32:05 2017 +0000

    scsi: ufs: introduce UFSHCD_QUIRK_PRDT_BYTE_GRAN quirk
    
    [ Upstream commit 75b1cc4ad63afa28c1a045b5157c008f405f06a9 ]
    
    Some UFS host controllers may think granularities of PRDT length and
    offset as bytes, not double words.
    
    Signed-off-by: Kiwoong Kim <kwmad.kim@samsung.com>
    Reviewed-by: Subhash Jadavani <subhashj@codeaurora.org>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 26cbe162df3d0282e5108711663b8dcdafb1ad33
Author: Brian Norris <briannorris@chromium.org>
Date:   Tue Apr 4 19:32:05 2017 +0000

    clocksource/drivers/arm_arch_timer: Don't assume clock runs in suspend
    
    [ Upstream commit d8ec7595a013237f82d965dcf981571aeb41855b ]
    
    The ARM specifies that the system counter "must be implemented in an
    always-on power domain," and so we try to use the counter as a source of
    timekeeping across suspend/resume. Unfortunately, some SoCs (e.g.,
    Rockchip's RK3399) do not keep the counter ticking properly when
    switched from their high-power clock to the lower-power clock used in
    system suspend. Support this quirk by adding a new device tree property.
    
    Signed-off-by: Brian Norris <briannorris@chromium.org>
    Reviewed-by: Douglas Anderson <dianders@chromium.org>
    Acked-by: Marc Zyngier <marc.zyngier@arm.com>
    Signed-off-by: Daniel Lezcano <daniel.lezcano@linaro.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d2f1000c3ae3ce285d99dae444f85baa53c1dfe6
Author: Bjorn Helgaas <bhelgaas@google.com>
Date:   Tue Apr 4 19:32:04 2017 +0000

    net/mlx4_core: Use device ID defines
    
    [ Upstream commit c19e4b9037fa8a0477525a64e93847f534e8cc17 ]
    
    We added a bunch of new Mellanox device ID definitions because they'll be
    used by INTx quirks.  Use them in the mlx4 ID table also so grep can find
    both places.  No functional change intended.
    
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Acked-by: Tariq Toukan <tariqt@mellanox.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dcc4c67581007255fd7f7258ff77a49ef7c536e4
Author: John Garry <john.garry@huawei.com>
Date:   Tue Apr 4 19:32:04 2017 +0000

    arm64: dts: hisi: fix hip06 sas am-max-trans quirk
    
    [ Upstream commit f65e786604b34d0b599b8c01ecca28be2d746290 ]
    
    The string for the am max transmissions quirk property
    is not correct -> fix it.
    
    Signed-off-by: John Garry <john.garry@huawei.com>
    Reviewed-by: Xiang Chen <chenxiang66@hisilicon.com>
    Signed-off-by: Wei Xu <xuwei5@hisilicon.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b340c9648c2fc649d33388b1cd4cbf1bb29a2a9a
Author: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Date:   Tue Apr 4 19:32:04 2017 +0000

    ASoC: Intel: bytct_rt5640: change default capture settings
    
    [ Upstream commit bf46241bee7bc3ec28703796f4fbd56085055fca ]
    
    Most Baytrail-CR devices use analog differential microphones,
    modify capture default to avoid DMI quirks. Keep digital mics
    for all other configurations.
    
    Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d9a97dcdf5c23f5a074e204e7a8fd355412146b8
Author: Janusz Dziedzic <januszx.dziedzic@intel.com>
Date:   Mon Mar 13 14:11:32 2017 +0200

    usb: dwc3: gadget: delay unmap of bounced requests
    
    commit de288e36fe33f7e06fa272bc8e2f85aa386d99aa upstream.
    
    In the case of bounced ep0 requests, we must delay DMA operation until
    after ->complete() otherwise we might overwrite contents of req->buf.
    
    This caused problems with RNDIS gadget.
    
    Signed-off-by: Janusz Dziedzic <januszx.dziedzic@intel.com>
    Signed-off-by: Felipe Balbi <felipe.balbi@linux.intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ee670af5feede68f0ad22b329626594b8aebefc3
Author: HungNien Chen <hn.chen@weidahitech.com>
Date:   Tue Apr 4 19:32:03 2017 +0000

    HID: i2c-hid: add a simple quirk to fix device defects
    
    [ Upstream commit 71af01a8c85ad89449209594133bdfdfaa9f1e2a ]
    
    Certain devices produced by Weida Tech need to have a wakeup command sent to
    them before powering on. The call itself will come back with error, but the
    device can be powered on afterwards.
    
    [jkosina@suse.cz: rewrite changelog]
    [jkosina@suse.cz: remove unused device ID addition]
    Signed-off-by: HungNien Chen <hn.chen@weidahitech.com>
    Reviewed-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d640c41bced65d82592e4d01a61715d78dede2ae
Author: Marcel Hasler <mahasler@gmail.com>
Date:   Tue Apr 4 19:32:03 2017 +0000

    HID: usbhid: Add quirks for Mayflash/Dragonrise GameCube and PS3 adapters
    
    [ Upstream commit b2554000f5b5d2a3a368d09c6debf7da64901fcf ]
    
    All known gamepad adapters by Mayflash (identified as Dragonrise) need
    HID_QUIRK_MULTI_INPUT to split them up into four input devices. Without this
    quirk those adapters are falsely recognized as tablets. Fixes bug 115841
    (https://bugzilla.kernel.org/show_bug.cgi?id=115841).
    
    Signed-off-by: Marcel Hasler <mahasler@gmail.com>
    Reviewed-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e02a5d1d5a053374dffe9ed6300113a125121f29
Author: Vladimir Zapolskiy <vz@mleia.com>
Date:   Tue Apr 4 19:32:03 2017 +0000

    clk: lpc32xx: add a quirk for PWM and MS clock dividers
    
    [ Upstream commit f84d42a9cffc4ecd96f1ce3a038f841782142eb2 ]
    
    In common clock framework CLK_DIVIDER_ONE_BASED or'ed with
    CLK_DIVIDER_ALLOW_ZERO flags indicates that
    1) a divider clock may be set to zero value,
    2) divider's zero value is interpreted as a non-divided clock.
    
    On the LPC32xx platform clock dividers of PWM and memory card clocks
    comply with the first condition, but zero value means a gated clock,
    thus it may happen that the divider value is not updated when
    the clock is enabled and the clock remains gated.
    
    The change adds one-shot quirks, which check for zero value of divider
    on initialization and set it to a non-zero value, therefore in runtime
    a gate clock will work as expected.
    
    Signed-off-by: Vladimir Zapolskiy <vz@mleia.com>
    Reviewed-by: Sylvain Lemieux <slemieux.tyco@gmail.com>
    Signed-off-by: Stephen Boyd <sboyd@codeaurora.org>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 666d5f34d8972d1d159b9f79f56620b6e817cc8a
Author: Chen-Yu Tsai <wens@csie.org>
Date:   Thu Oct 20 11:43:40 2016 +0800

    drm/sun4i: Add compatible string for A31/A31s TCON (timing controller)
    
    commit 93a5ec14da24a8abbac5bcb953b45cc7a5d0198a upstream.
    
    The A31 TCON has mux controls for how TCON outputs are routed to the
    HDMI and MIPI DSI blocks.
    
    Since the A31s does not have MIPI DSI, it only has a mux for the HDMI
    controller input.
    
    This patch only adds support for the compatible strings. Actual support
    for the mux controls should be added with HDMI and MIPI DSI support.
    
    Signed-off-by: Chen-Yu Tsai <wens@csie.org>
    Signed-off-by: Maxime Ripard <maxime.ripard@free-electrons.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6af7e1cae4457f5a17df46ca73d2f9b13d14edaf
Author: Chen-Yu Tsai <wens@csie.org>
Date:   Thu Oct 20 11:43:41 2016 +0800

    drm/sun4i: Add compatible strings for A31/A31s display pipelines
    
    commit 49c440e87cd6f547f93d0dc53571ae0e11d9ec8f upstream.
    
    The A31's display pipeline has 2 frontends, 2 backends, and 2 TCONs. It
    also has new display enhancement blocks, such as the DRC (Dynamic Range
    Controller), the DEU (Display Enhancement Unit), and the CMU (Color
    Management Unit). It supports HDMI, MIPI DSI, and 2 LCD/LVDS channels.
    
    The A31s display pipeline is almost the same, just without MIPI DSI.
    Only the TCON seems to be different, due to the missing mux for MIPI
    DSI.
    
    Add compatible strings for both of them.
    
    Signed-off-by: Chen-Yu Tsai <wens@csie.org>
    Acked-by: Rob Herring <robh@kernel.org>
    Signed-off-by: Maxime Ripard <maxime.ripard@free-electrons.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 06a2bb472f71c6e2ed2a51c06608680dc20eb327
Author: Chen-Yu Tsai <wens@csie.org>
Date:   Thu Oct 20 11:43:39 2016 +0800

    drm/sun4i: tcon: Move SoC specific quirks to a DT matched data structure
    
    commit 91ea2f29cba6a7fe035ea232e4f981211a9fce5d upstream.
    
    We already have some differences between the 2 supported SoCs.
    More will be added as we support other SoCs. To avoid bloating
    the probe function with even more conditionals, move the quirks
    to a separate data structure that's tied to the compatible string.
    
    Signed-off-by: Chen-Yu Tsai <wens@csie.org>
    Signed-off-by: Maxime Ripard <maxime.ripard@free-electrons.com>
    Signed-off-by: Sasha Levin <alexander.levin@verizon.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7c03613344663982a27c49d5951c80c575714ab8
Author: Jason A. Donenfeld <Jason@zx2c4.com>
Date:   Fri Jan 6 19:32:01 2017 +0100

    random: use chacha20 for get_random_int/long
    
    commit f5b98461cb8167ba362ad9f74c41d126b7becea7 upstream.
    
    Now that our crng uses chacha20, we can rely on its speedy
    characteristics for replacing MD5, while simultaneously achieving a
    higher security guarantee. Before the idea was to use these functions if
    you wanted random integers that aren't stupidly insecure but aren't
    necessarily secure either, a vague gray zone, that hopefully was "good
    enough" for its users. With chacha20, we can strengthen this claim,
    since either we're using an rdrand-like instruction, or we're using the
    same crng as /dev/urandom. And it's faster than what was before.
    
    We could have chosen to replace this with a SipHash-derived function,
    which might be slightly faster, but at the cost of having yet another
    RNG construction in the kernel. By moving to chacha20, we have a single
    RNG to analyze and verify, and we also already get good performance
    improvements on all platforms.
    
    Implementation-wise, rather than use a generic buffer for both
    get_random_int/long and memcpy based on the size needs, we use a
    specific buffer for 32-bit reads and for 64-bit reads. This way, we're
    guaranteed to always have aligned accesses on all platforms. While
    slightly more verbose in C, the assembly this generates is a lot
    simpler than otherwise.
    
    Finally, on 32-bit platforms where longs and ints are the same size,
    we simply alias get_random_int to get_random_long.
    
    Signed-off-by: Jason A. Donenfeld <Jason@zx2c4.com>
    Suggested-by: Theodore Ts'o <tytso@mit.edu>
    Cc: Theodore Ts'o <tytso@mit.edu>
    Cc: Hannes Frederic Sowa <hannes@stressinduktion.org>
    Cc: Andy Lutomirski <luto@amacapital.net>
    Signed-off-by: Theodore Ts'o <tytso@mit.edu>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cddab768d13469d1e254fb8c0e1629f93c8dfaca
Author: Chris Salls <salls@cs.ucsb.edu>
Date:   Fri Apr 7 23:48:11 2017 -0700

    mm/mempolicy.c: fix error handling in set_mempolicy and mbind.
    
    commit cf01fb9985e8deb25ccf0ea54d916b8871ae0e62 upstream.
    
    In the case that compat_get_bitmap fails we do not want to copy the
    bitmap to the user as it will contain uninitialized stack data and leak
    sensitive data.
    
    Signed-off-by: Chris Salls <salls@cs.ucsb.edu>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 24317cb6b400d7fc567e4c8d1fdca587113c6423
Author: Johan Hovold <johan@kernel.org>
Date:   Mon Apr 3 15:53:34 2017 +0200

    Documentation: stable-kernel-rules: fix stable-tag format
    
    commit cf903e9d3a97f89b224d2d07be37c0f160db8192 upstream.
    
    A patch documenting how to specify which kernels a particular fix should
    be backported to (seemingly) inadvertently added a minus sign after the
    kernel version. This particular stable-tag format had never been used
    prior to this patch, and was neither present when the patch in question
    was first submitted (it was added in v2 without any comment).
    
    Drop the minus sign to avoid any confusion.
    
    Fixes: fdc81b7910ad ("stable_kernel_rules: Add clause about specification of kernel versions to patch.")
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit be56f92cc0a9868c2eab776250abeba5b5c21d77
Author: Huacai Chen <chenhc@lemote.com>
Date:   Thu Mar 16 21:00:29 2017 +0800

    MIPS: c-r4k: Fix Loongson-3's vcache/scache waysize calculation
    
    commit 0be032c190abcdcfa948082b6a1e0d461184ba4d upstream.
    
    If scache.waysize is 0, r4k___flush_cache_all() will do nothing and
    then cause bugs. BTW, though vcache.waysize isn't being used by now,
    we also fix its calculation.
    
    Signed-off-by: Huacai Chen <chenhc@lemote.com>
    Cc: John Crispin <john@phrozen.org>
    Cc: Steven J . Hill <Steven.Hill@caviumnetworks.com>
    Cc: Fuxin Zhang <zhangfx@lemote.com>
    Cc: Zhangjin Wu <wuzhangjin@gmail.com>
    Cc: linux-mips@linux-mips.org
    Patchwork: https://patchwork.linux-mips.org/patch/15756/
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 59b8725f2b1e7e3c5529b0995d0201026f47de2d
Author: Huacai Chen <chenhc@lemote.com>
Date:   Thu Mar 16 21:00:27 2017 +0800

    MIPS: Flush wrong invalid FTLB entry for huge page
    
    commit 0115f6cbf26663c86496bc56eeea293f85b77897 upstream.
    
    On VTLB+FTLB platforms (such as Loongson-3A R2), FTLB's pagesize is
    usually configured the same as PAGE_SIZE. In such a case, Huge page
    entry is not suitable to write in FTLB.
    
    Unfortunately, when a huge page is created, its page table entries
    haven't created immediately. Then the TLB refill handler will fetch an
    invalid page table entry which has no "HUGE" bit, and this entry may be
    written to FTLB. Since it is invalid, TLB load/store handler will then
    use tlbwi to write the valid entry at the same place. However, the
    valid entry is a huge page entry which isn't suitable for FTLB.
    
    Our solution is to modify build_huge_handler_tail. Flush the invalid
    old entry (whether it is in FTLB or VTLB, this is in order to reduce
    branches) and use tlbwr to write the valid new entry.
    
    Signed-off-by: Rui Wang <wangr@lemote.com>
    Signed-off-by: Huacai Chen <chenhc@lemote.com>
    Cc: John Crispin <john@phrozen.org>
    Cc: Steven J . Hill <Steven.Hill@caviumnetworks.com>
    Cc: Fuxin Zhang <zhangfx@lemote.com>
    Cc: Zhangjin Wu <wuzhangjin@gmail.com>
    Cc: Huacai Chen <chenhc@lemote.com>
    Cc: linux-mips@linux-mips.org
    Patchwork: https://patchwork.linux-mips.org/patch/15754/
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 186fb3c52e39e41977fd7227a45bcd0877af790b
Author: Huacai Chen <chenhc@lemote.com>
Date:   Thu Mar 16 21:00:25 2017 +0800

    MIPS: Add MIPS_CPU_FTLB for Loongson-3A R2
    
    commit 033cffeedbd11c140952b98e8639bf652091a17d upstream.
    
    Loongson-3A R2 and newer CPU have FTLB, but Config0.MT is 1, so add
    MIPS_CPU_FTLB to the CPU options.
    
    Signed-off-by: Huacai Chen <chenhc@lemote.com>
    Cc: John Crispin <john@phrozen.org>
    Cc: Steven J . Hill <Steven.Hill@caviumnetworks.com>
    Cc: Fuxin Zhang <zhangfx@lemote.com>
    Cc: Zhangjin Wu <wuzhangjin@gmail.com>
    Cc: linux-mips@linux-mips.org
    Patchwork: https://patchwork.linux-mips.org/patch/15752/
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3d5e13d891b0e7f4b7eee97aea1c15037a994d68
Author: Huacai Chen <chenhc@lemote.com>
Date:   Thu Mar 16 21:00:26 2017 +0800

    MIPS: Check TLB before handle_ri_rdhwr() for Loongson-3
    
    commit 5a34133167dce36666ea054e30a561b7f4413b7f upstream.
    
    Loongson-3's micro TLB (ITLB) is not strictly a subset of JTLB. That
    means: when a JTLB entry is replaced by hardware, there may be an old
    valid entry exists in ITLB. So, a TLB miss exception may occur while
    handle_ri_rdhwr() is running because it try to access EPC's content.
    However, handle_ri_rdhwr() doesn't clear EXL, which makes a TLB Refill
    exception be treated as a TLB Invalid exception and tlbp may fail. In
    this case, if FTLB (which is usually set-associative instead of set-
    associative) is enabled, a tlbp failure will cause an invalid tlbwi,
    which will hang the whole system.
    
    This patch rename handle_ri_rdhwr_vivt to handle_ri_rdhwr_tlbp and use
    it for Loongson-3. It try to solve the same problem described as below,
    but more straightforwards.
    
    https://patchwork.linux-mips.org/patch/12591/
    
    I think Loongson-2 has the same problem, but it has no FTLB, so we just
    keep it as is.
    
    Signed-off-by: Huacai Chen <chenhc@lemote.com>
    Cc: Rui Wang <wangr@lemote.com>
    Cc: John Crispin <john@phrozen.org>
    Cc: Steven J . Hill <Steven.Hill@caviumnetworks.com>
    Cc: Fuxin Zhang <zhangfx@lemote.com>
    Cc: Zhangjin Wu <wuzhangjin@gmail.com>
    Cc: Huacai Chen <chenhc@lemote.com>
    Cc: linux-mips@linux-mips.org
    Patchwork: https://patchwork.linux-mips.org/patch/15753/
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c7f6633f7657a56bdb8628c129de6c3079eb7d07
Author: Hauke Mehrtens <hauke@hauke-m.de>
Date:   Wed Mar 15 23:26:42 2017 +0100

    MIPS: Lantiq: fix missing xbar kernel panic
    
    commit 6ef90877eee63a0d03e83183bb44b64229b624e6 upstream.
    
    Commit 08b3c894e565 ("MIPS: lantiq: Disable xbar fpi burst mode")
    accidentally requested the resources from the pmu address region
    instead of the xbar registers region, but the check for the return
    value of request_mem_region() was wrong. Commit 98ea51cb0c8c ("MIPS:
    Lantiq: Fix another request_mem_region() return code check") fixed the
    check of the return value of request_mem_region() which made the kernel
    panics.
    This patch now makes use of the correct memory region for the cross bar.
    
    Fixes: 08b3c894e565 ("MIPS: lantiq: Disable xbar fpi burst mode")
    Signed-off-by: Hauke Mehrtens <hauke@hauke-m.de>
    Cc: John Crispin <john@phrozen.org>
    Cc: james.hogan@imgtec.com
    Cc: arnd@arndb.de
    Cc: sergei.shtylyov@cogentembedded.com
    Cc: john@phrozen.org
    Cc: linux-mips@linux-mips.org
    Patchwork: https://patchwork.linux-mips.org/patch/15751
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1e7deb9da03373318b642cec56607f6bdb8f6407
Author: Paul Burton <paulburton@kernel.org>
Date:   Thu Feb 23 14:50:24 2017 +0000

    MIPS: End spinlocks with .insn
    
    commit 4b5347a24a0f2d3272032c120664b484478455de upstream.
    
    When building for microMIPS we need to ensure that the assembler always
    knows that there is code at the target of a branch or jump. Recent
    toolchains will fail to link a microMIPS kernel when this isn't the case
    due to what it thinks is a branch to non-microMIPS code.
    
    mips-mti-linux-gnu-ld kernel/built-in.o: .spinlock.text+0x2fc: Unsupported branch between ISA modes.
    mips-mti-linux-gnu-ld final link failed: Bad value
    
    This is due to inline assembly labels in spinlock.h not being followed
    by an instruction mnemonic, either due to a .subsection pseudo-op or the
    end of the inline asm block.
    
    Fix this with a .insn direction after such labels.
    
    Signed-off-by: Paul Burton <paul.burton@imgtec.com>
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Reviewed-by: Maciej W. Rozycki <macro@imgtec.com>
    Cc: Ralf Baechle <ralf@linux-mips.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Ingo Molnar <mingo@redhat.com>
    Cc: linux-mips@linux-mips.org
    Cc: linux-kernel@vger.kernel.org
    Patchwork: https://patchwork.linux-mips.org/patch/15325/
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 19aa26f5be49fd53deaa3a7145013bf3cdec5050
Author: John Crispin <john@phrozen.org>
Date:   Sat Feb 25 11:54:23 2017 +0100

    MIPS: ralink: Fix typos in rt3883 pinctrl
    
    commit 7c5a3d813050ee235817b0220dd8c42359a9efd8 upstream.
    
    There are two copy & paste errors in the definition of the 5GHz LNA and
    second ethernet pinmux.
    
    Fixes: f576fb6a0700 ("MIPS: ralink: cleanup the soc specific pinmux data")
    Signed-off-by: John Crispin <john@phrozen.org>
    Signed-off-by: Daniel Golle <daniel@makrotopia.org>
    Cc: linux-mips@linux-mips.org
    Patchwork: https://patchwork.linux-mips.org/patch/15328/
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9dcb21e63b2e804b67d5f998b5e39d821776e336
Author: James Hogan <jhogan@kernel.org>
Date:   Thu Feb 16 12:39:01 2017 +0000

    MIPS: Force o32 fp64 support on 32bit MIPS64r6 kernels
    
    commit 2e6c7747730296a6d4fd700894286db1132598c4 upstream.
    
    When a 32-bit kernel is configured to support MIPS64r6 (CPU_MIPS64_R6),
    MIPS_O32_FP64_SUPPORT won't be selected as it should be because
    MIPS32_O32 is disabled (o32 is already the default ABI available on
    32-bit kernels).
    
    This results in userland FP breakage as CP0_Status.FR is read-only 1
    since r6 (when an FPU is present) so __enable_fpu() will fail to clear
    FR. This causes the FPU emulator to get used which will incorrectly
    emulate 32-bit FPU registers.
    
    Force o32 fp64 support in this case by also selecting
    MIPS_O32_FP64_SUPPORT from CPU_MIPS64_R6 if 32BIT.
    
    Fixes: 4e9d324d4288 ("MIPS: Require O32 FP64 support for MIPS64 with O32 compat")
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Reviewed-by: Paul Burton <paul.burton@imgtec.com>
    Cc: Ralf Baechle <ralf@linux-mips.org>
    Cc: linux-mips@linux-mips.org
    Patchwork: https://patchwork.linux-mips.org/patch/15310/
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7b68273f79e83911114fb07597f06cc3913c4227
Author: Heiko Carstens <heiko.carstens@de.ibm.com>
Date:   Mon Mar 27 09:48:04 2017 +0200

    s390/uaccess: get_user() should zero on failure (again)
    
    commit d09c5373e8e4eaaa09233552cbf75dc4c4f21203 upstream.
    
    Commit fd2d2b191fe7 ("s390: get_user() should zero on failure")
    intended to fix s390's get_user() implementation which did not zero
    the target operand if the read from user space faulted. Unfortunately
    the patch has no effect: the corresponding inline assembly specifies
    that the operand is only written to ("=") and the previous value is
    discarded.
    
    Therefore the compiler is free to and actually does omit the zero
    initialization.
    
    To fix this simply change the contraint modifier to "+", so the
    compiler cannot omit the initialization anymore.
    
    Fixes: c9ca78415ac1 ("s390/uaccess: provide inline variants of get_user/put_user")
    Fixes: fd2d2b191fe7 ("s390: get_user() should zero on failure")
    Cc: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
    Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f4938792af381c1838cfb561735cfbeb49fa4dd2
Author: Marcelo Henrique Cerri <marcelo.cerri@canonical.com>
Date:   Mon Mar 13 12:14:58 2017 -0300

    s390/decompressor: fix initrd corruption caused by bss clear
    
    commit d82c0d12c92705ef468683c9b7a8298dd61ed191 upstream.
    
    Reorder the operations in decompress_kernel() to ensure initrd is moved
    to a safe location before the bss section is zeroed.
    
    During decompression bss can overlap with the initrd and this can
    corrupt the initrd contents depending on the size of the compressed
    kernel (which affects where the initrd is placed by the bootloader) and
    the size of the bss section of the decompressor.
    
    Also use the correct initrd size when checking for overlaps with
    parmblock.
    
    Fixes: 06c0dd72aea3 ([S390] fix boot failures with compressed kernels)
    Reviewed-by: Joy Latten <joy.latten@canonical.com>
    Reviewed-by: Vineetha HariPai <vineetha.hari.pai@canonical.com>
    Signed-off-by: Marcelo Henrique Cerri <marcelo.cerri@canonical.com>
    Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
    Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6a776f6ae3f8b27a55c7d3479b7a6f13bc5e54bd
Author: Max Filippov <jcmvbkbc@gmail.com>
Date:   Wed Mar 29 15:44:47 2017 -0700

    xtensa: make __pa work with uncached KSEG addresses
    
    commit 2b83878dd74a7c73bedcb6600663c1c46836e8af upstream.
    
    When __pa is applied to virtual address in uncached KSEG region the
    result is incorrect. Fix it by checking if the original address is in
    the uncached KSEG and adjusting the result. It looks better than masking
    off bits because pfn_valid would correctly work with new __pa results
    and it may be made working in noMMU case, once we get definition for
    uncached memory view.
    
    This is required for the dma_common_mmap and DMA debug code to work
    correctly: they both indirectly use __pa with coherent DMA addresses.
    In case of DMA debug the visible effect is false reports that an address
    mapped for DMA is accessed by CPU.
    
    Tested-by: Boris Brezillon <boris.brezillon@free-electrons.com>
    Reviewed-by: Boris Brezillon <boris.brezillon@free-electrons.com>
    Signed-off-by: Max Filippov <jcmvbkbc@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c1dcea123655f4b905790842b04e054407559229
Author: Tobias Klauser <tklauser@distanz.ch>
Date:   Sun Apr 2 20:08:04 2017 -0700

    nios2: reserve boot memory for device tree
    
    commit 921d701e6f31e1ffaca3560416af1aa04edb4c4f upstream.
    
    Make sure to reserve the boot memory for the flattened device tree.
    Otherwise it might get overwritten, e.g. when initial_boot_params is
    copied, leading to a corrupted FDT and a boot hang/crash:
    
      bootconsole [early0] enabled
      Early console on uart16650 initialized at 0xf8001600
      OF: fdt: Error -11 processing FDT
      Kernel panic - not syncing: setup_cpuinfo: No CPU found in devicetree!
    
      ---[ end Kernel panic - not syncing: setup_cpuinfo: No CPU found in devicetree!
    
    Guenter Roeck says:
    
    > I think I found the problem. In unflatten_and_copy_device_tree(), with added
    > debug information:
    >
    > OF: fdt: initial_boot_params=c861e400, dt=c861f000 size=28874 (0x70ca)
    >
    > ... and then initial_boot_params is copied to dt, which results in corrupted
    > fdt since the memory overlaps. Looks like the initial_boot_params memory
    > is not reserved and (re-)allocated by early_init_dt_alloc_memory_arch().
    
    Reported-by: Guenter Roeck <linux@roeck-us.net>
    Reference: http://lkml.kernel.org/r/20170226210338.GA19476@roeck-us.net
    Tested-by: Guenter Roeck <linux@roeck-us.net>
    Signed-off-by: Tobias Klauser <tklauser@distanz.ch>
    Acked-by: Ley Foon Tan <ley.foon.tan@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 27d382fb6afe46e42036e85c93eb2a7ad6e0c004
Author: Dmitry Bilunov <kmeaw@yandex-team.ru>
Date:   Thu Mar 30 18:14:26 2017 +0300

    dm raid: fix NULL pointer dereference for raid1 without bitmap
    
    commit 7a0c5c5b834fb60764b494b0e39c239da3b0774b upstream.
    
    Commit 4257e08 ("dm raid: support to change bitmap region size")
    introduced a bitmap resize call during preresume phase. User can create
    a DM device with "raid" target configured as raid1 with no metadata
    devices to hold superblock/bitmap info. It can be achieved using the
    following sequence:
    
      truncate -s 32M /dev/shm/raid-test
      LOOP=$(losetup --show -f /dev/shm/raid-test)
      dmsetup create raid-test-linear0 --table "0 1024 linear $LOOP 0"
      dmsetup create raid-test-linear1 --table "0 1024 linear $LOOP 1024"
      dmsetup create raid-test --table "0 1024 raid raid1 1 2048 2 - /dev/mapper/raid-test-linear0 - /dev/mapper/raid-test-linear1"
    
    This results in the following crash:
    
    [ 4029.110216] device-mapper: raid: Ignoring chunk size parameter for RAID 1
    [ 4029.110217] device-mapper: raid: Choosing default region size of 4MiB
    [ 4029.111349] md/raid1:mdX: active with 2 out of 2 mirrors
    [ 4029.114770] BUG: unable to handle kernel NULL pointer dereference at 0000000000000030
    [ 4029.114802] IP: bitmap_resize+0x25/0x7c0 [md_mod]
    [ 4029.114816] PGD 0
    …
    [ 4029.115059] Hardware name: Aquarius Pro P30 S85 BUY-866/B85M-E, BIOS 2304 05/25/2015
    [ 4029.115079] task: ffff88015cc29a80 task.stack: ffffc90001a5c000
    [ 4029.115097] RIP: 0010:bitmap_resize+0x25/0x7c0 [md_mod]
    [ 4029.115112] RSP: 0018:ffffc90001a5fb68 EFLAGS: 00010246
    [ 4029.115127] RAX: 0000000000000005 RBX: 0000000000000000 RCX: 0000000000000000
    [ 4029.115146] RDX: 0000000000000000 RSI: 0000000000000400 RDI: 0000000000000000
    [ 4029.115166] RBP: ffffc90001a5fc28 R08: 0000000800000000 R09: 00000008ffffffff
    [ 4029.115185] R10: ffffea0005661600 R11: ffff88015cc29a80 R12: ffff88021231f058
    [ 4029.115204] R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
    [ 4029.115223] FS:  00007fe73a6b4740(0000) GS:ffff88021ea80000(0000) knlGS:0000000000000000
    [ 4029.115245] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    [ 4029.115261] CR2: 0000000000000030 CR3: 0000000159a74000 CR4: 00000000001426e0
    [ 4029.115281] Call Trace:
    [ 4029.115291]  ? raid_iterate_devices+0x63/0x80 [dm_raid]
    [ 4029.115309]  ? dm_table_all_devices_attribute.isra.23+0x41/0x70 [dm_mod]
    [ 4029.115329]  ? dm_table_set_restrictions+0x225/0x2d0 [dm_mod]
    [ 4029.115346]  raid_preresume+0x81/0x2e0 [dm_raid]
    [ 4029.115361]  dm_table_resume_targets+0x47/0xe0 [dm_mod]
    [ 4029.115378]  dm_resume+0xa8/0xd0 [dm_mod]
    [ 4029.115391]  dev_suspend+0x123/0x250 [dm_mod]
    [ 4029.115405]  ? table_load+0x350/0x350 [dm_mod]
    [ 4029.115419]  ctl_ioctl+0x1c2/0x490 [dm_mod]
    [ 4029.115433]  dm_ctl_ioctl+0xe/0x20 [dm_mod]
    [ 4029.115447]  do_vfs_ioctl+0x8d/0x5a0
    [ 4029.115459]  ? ____fput+0x9/0x10
    [ 4029.115470]  ? task_work_run+0x79/0xa0
    [ 4029.115481]  SyS_ioctl+0x3c/0x70
    [ 4029.115493]  entry_SYSCALL_64_fastpath+0x13/0x94
    
    The raid_preresume() function incorrectly assumes that the raid_set has
    a bitmap enabled if RT_FLAG_RS_BITMAP_LOADED is set.  But
    RT_FLAG_RS_BITMAP_LOADED is getting set in __load_dirty_region_bitmap()
    even if there is no bitmap present (and bitmap_load() happily returns 0
    even if a bitmap isn't present).  So the only way forward in the
    near-term is to check if the bitmap is present by seeing if
    mddev->bitmap is not NULL after bitmap_load() has been called.
    
    By doing so the above NULL pointer is avoided.
    
    Fixes: 4257e08 ("dm raid: support to change bitmap region size")
    Signed-off-by: Dmitry Bilunov <kmeaw@yandex-team.ru>
    Signed-off-by: Andrey Smetanin <asmetanin@yandex-team.ru>
    Acked-by: Heinz Mauelshagen <heinzm@redhat.com>
    Signed-off-by: Mike Snitzer <snitzer@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit abbf0fd436a92155177738862ec328f34dc40821
Author: Michael Ellerman <mpe@ellerman.id.au>
Date:   Thu Apr 6 23:34:38 2017 +1000

    powerpc/crypto/crc32c-vpmsum: Fix missing preempt_disable()
    
    commit 4749228f022893faf54a3dbc70796f78b7d4f342 upstream.
    
    In crc32c_vpmsum() we call enable_kernel_altivec() without first
    disabling preemption, which is not allowed:
    
      WARNING: CPU: 9 PID: 2949 at ../arch/powerpc/kernel/process.c:277 enable_kernel_altivec+0x100/0x120
      Modules linked in: dm_thin_pool dm_persistent_data dm_bio_prison dm_bufio libcrc32c vmx_crypto ...
      CPU: 9 PID: 2949 Comm: docker Not tainted 4.11.0-rc5-compiler_gcc-6.3.1-00033-g308ac7563944 #381
      ...
      NIP [c00000000001e320] enable_kernel_altivec+0x100/0x120
      LR [d000000003df0910] crc32c_vpmsum+0x108/0x150 [crc32c_vpmsum]
      Call Trace:
        0xc138fd09 (unreliable)
        crc32c_vpmsum+0x108/0x150 [crc32c_vpmsum]
        crc32c_vpmsum_update+0x3c/0x60 [crc32c_vpmsum]
        crypto_shash_update+0x88/0x1c0
        crc32c+0x64/0x90 [libcrc32c]
        dm_bm_checksum+0x48/0x80 [dm_persistent_data]
        sb_check+0x84/0x120 [dm_thin_pool]
        dm_bm_validate_buffer.isra.0+0xc0/0x1b0 [dm_persistent_data]
        dm_bm_read_lock+0x80/0xf0 [dm_persistent_data]
        __create_persistent_data_objects+0x16c/0x810 [dm_thin_pool]
        dm_pool_metadata_open+0xb0/0x1a0 [dm_thin_pool]
        pool_ctr+0x4cc/0xb60 [dm_thin_pool]
        dm_table_add_target+0x16c/0x3c0
        table_load+0x184/0x400
        ctl_ioctl+0x2f0/0x560
        dm_ctl_ioctl+0x38/0x50
        do_vfs_ioctl+0xd8/0x920
        SyS_ioctl+0x68/0xc0
        system_call+0x38/0xfc
    
    It used to be sufficient just to call pagefault_disable(), because that
    also disabled preemption. But the two were decoupled in commit 8222dbe21e79
    ("sched/preempt, mm/fault: Decouple preemption from the page fault
    logic") in mid 2015.
    
    So add the missing preempt_disable/enable(). We should also call
    disable_kernel_fp(), although it does nothing by default, there is a
    debug switch to make it active and all enables should be paired with
    disables.
    
    Fixes: 6dd7a82cc54e ("crypto: powerpc - Add POWER8 optimised crc32c")
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 45c2ed941c0855848fb305d1ff6201a88d74bdef
Author: Paul Mackerras <paulus@ozlabs.org>
Date:   Tue Apr 4 14:56:05 2017 +1000

    powerpc: Don't try to fix up misaligned load-with-reservation instructions
    
    commit 48fe9e9488743eec9b7c1addd3c93f12f2123d54 upstream.
    
    In the past, there was only one load-with-reservation instruction,
    lwarx, and if a program attempted a lwarx on a misaligned address, it
    would take an alignment interrupt and the kernel handler would emulate
    it as though it was lwzx, which was not really correct, but benign since
    it is loading the right amount of data, and the lwarx should be paired
    with a stwcx. to the same address, which would also cause an alignment
    interrupt which would result in a SIGBUS being delivered to the process.
    
    We now have 5 different sizes of load-with-reservation instruction. Of
    those, lharx and ldarx cause an immediate SIGBUS by luck since their
    entries in aligninfo[] overlap instructions which were not fixed up, but
    lqarx overlaps with lhz and will be emulated as such. lbarx can never
    generate an alignment interrupt since it only operates on 1 byte.
    
    To straighten this out and fix the lqarx case, this adds code to detect
    the l[hwdq]arx instructions and return without fixing them up, resulting
    in a SIGBUS being delivered to the process.
    
    Signed-off-by: Paul Mackerras <paulus@ozlabs.org>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fba7546bbe659e261be8ef6f26f3ae48a4e9b85d
Author: Oliver O'Halloran <oohall@gmail.com>
Date:   Mon Apr 3 13:25:12 2017 +1000

    powerpc/64: Fix flush_(d|i)cache_range() called from modules
    
    commit 8f5f525d5b83f7d76a6baf9c4e94d4bf312ea7f6 upstream.
    
    When the kernel is compiled to use 64bit ABIv2 the _GLOBAL() macro does
    not include a global entry point. A function's global entry point is
    used when the function is called from a different TOC context and in the
    kernel this typically means a call from a module into the vmlinux (or
    vice-versa).
    
    There are a few exported asm functions declared with _GLOBAL() and
    calling them from a module will likely crash the kernel since any TOC
    relative load will yield garbage.
    
    flush_icache_range() and flush_dcache_range() are both exported to
    modules, and use the TOC, so must use _GLOBAL_TOC().
    
    Fixes: 721aeaa9fdf3 ("powerpc: Build little endian ppc64 kernel with ABIv2")
    Signed-off-by: Oliver O'Halloran <oohall@gmail.com>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 24d945d4791f8a8a9693cc4ff67cb0b787b70b77
Author: Frederic Barrat <fbarrat@linux.vnet.ibm.com>
Date:   Wed Mar 29 19:19:42 2017 +0200

    powerpc/mm: Add missing global TLB invalidate if cxl is active
    
    commit 88b1bf7268f56887ca88eb09c6fb0f4fc970121a upstream.
    
    Commit 4c6d9acce1f4 ("powerpc/mm: Add hooks for cxl") converted local
    TLB invalidates to global if the cxl driver is active. This is necessary
    because the CAPP snoops invalidations to forward them to the PSL on the
    cxl adapter. However one path was forgotten. native_flush_hash_range()
    still does local TLB invalidates, as found out the hard way recently.
    
    This patch fixes it by following the same logic as previously: if the
    cxl driver is active, the local TLB invalidates are 'upgraded' to
    global.
    
    Fixes: 4c6d9acce1f4 ("powerpc/mm: Add hooks for cxl")
    Signed-off-by: Frederic Barrat <fbarrat@linux.vnet.ibm.com>
    Reviewed-by: Aneesh Kumar K.V <aneesh.kumar@linux.vnet.ibm.com>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6fbf84b5da23e7436b710660d2fd5d136e1bcfd3
Author: Benjamin Herrenschmidt <benh@kernel.crashing.org>
Date:   Mon Mar 20 17:49:03 2017 +1100

    powerpc: Disable HFSCR[TM] if TM is not supported
    
    commit 7ed23e1bae8bf7e37fd555066550a00b95a3a98b upstream.
    
    On Power8 & Power9 the early CPU inititialisation in __init_HFSCR()
    turns on HFSCR[TM] (Hypervisor Facility Status and Control Register
    [Transactional Memory]), but that doesn't take into account that TM
    might be disabled by CPU features, or disabled by the kernel being built
    with CONFIG_PPC_TRANSACTIONAL_MEM=n.
    
    So later in boot, when we have setup the CPU features, clear HSCR[TM] if
    the TM CPU feature has been disabled. We use CPU_FTR_TM_COMP to account
    for the CONFIG_PPC_TRANSACTIONAL_MEM=n case.
    
    Without this a KVM guest might try use TM, even if told not to, and
    cause an oops in the host kernel. Typically the oops is seen in
    __kvmppc_vcore_entry() and may or may not be fatal to the host, but is
    always bad news.
    
    In practice all shipping CPU revisions do support TM, and all host
    kernels we are aware of build with TM support enabled, so no one should
    actually be able to hit this in the wild.
    
    Fixes: 2a3563b023e5 ("powerpc: Setup in HFSCR for POWER8")
    Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
    Tested-by: Sam Bobroff <sam.bobroff@au1.ibm.com>
    [mpe: Rewrite change log with input from Sam, add Fixes/stable]
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a1db9b2c1b120c7779cba2587f0cb3af4c3f8042
Author: James Hogan <jhogan@kernel.org>
Date:   Tue Apr 4 08:51:34 2017 +0100

    metag/usercopy: Add missing fixups
    
    commit b884a190afcecdbef34ca508ea5ee88bb7c77861 upstream.
    
    The rapf copy loops in the Meta usercopy code is missing some extable
    entries for HTP cores with unaligned access checking enabled, where
    faults occur on the instruction immediately after the faulting access.
    
    Add the fixup labels and extable entries for these cases so that corner
    case user copy failures don't cause kernel crashes.
    
    Fixes: 373cd784d0fc ("metag: Memory handling")
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: linux-metag@vger.kernel.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ce154d517ae45fe20c62a0c563e9b0858519259f
Author: James Hogan <jhogan@kernel.org>
Date:   Mon Apr 3 17:41:40 2017 +0100

    metag/usercopy: Fix src fixup in from user rapf loops
    
    commit 2c0b1df88b987a12d95ea1d6beaf01894f3cc725 upstream.
    
    The fixup code to rewind the source pointer in
    __asm_copy_from_user_{32,64}bit_rapf_loop() always rewound the source by
    a single unit (4 or 8 bytes), however this is insufficient if the fault
    didn't occur on the first load in the loop, as the source pointer will
    have been incremented but nothing will have been stored until all 4
    register [pairs] are loaded.
    
    Read the LSM_STEP field of TXSTATUS (which is already loaded into a
    register), a bit like the copy_to_user versions, to determine how many
    iterations of MGET[DL] have taken place, all of which need rewinding.
    
    Fixes: 373cd784d0fc ("metag: Memory handling")
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: linux-metag@vger.kernel.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4f3f0dd2a75b3a25198492cd815ea82de9cef8a7
Author: James Hogan <jhogan@kernel.org>
Date:   Tue Apr 4 11:43:26 2017 +0100

    metag/usercopy: Set flags before ADDZ
    
    commit fd40eee1290ad7add7aa665e3ce6b0f9fe9734b4 upstream.
    
    The fixup code for the copy_to_user rapf loops reads TXStatus.LSM_STEP
    to decide how far to rewind the source pointer. There is a special case
    for the last execution of an MGETL/MGETD, since it leaves LSM_STEP=0
    even though the number of MGETLs/MGETDs attempted was 4. This uses ADDZ
    which is conditional upon the Z condition flag, but the AND instruction
    which masked the TXStatus.LSM_STEP field didn't set the condition flags
    based on the result.
    
    Fix that now by using ANDS which does set the flags, and also marking
    the condition codes as clobbered by the inline assembly.
    
    Fixes: 373cd784d0fc ("metag: Memory handling")
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: linux-metag@vger.kernel.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3dc0fe517a9fb44f6c45cbb787cc4bdf5e9a3d0f
Author: James Hogan <jhogan@kernel.org>
Date:   Fri Mar 31 11:14:02 2017 +0100

    metag/usercopy: Zero rest of buffer from copy_from_user
    
    commit 563ddc1076109f2b3f88e6d355eab7b6fd4662cb upstream.
    
    Currently we try to zero the destination for a failed read from userland
    in fixup code in the usercopy.c macros. The rest of the destination
    buffer is then zeroed from __copy_user_zeroing(), which is used for both
    copy_from_user() and __copy_from_user().
    
    Unfortunately we fail to zero in the fixup code as D1Ar1 is set to 0
    before the fixup code entry labels, and __copy_from_user() shouldn't even
    be zeroing the rest of the buffer.
    
    Move the zeroing out into copy_from_user() and rename
    __copy_user_zeroing() to raw_copy_from_user() since it no longer does
    any zeroing. This also conveniently matches the name needed for
    RAW_COPY_USER support in a later patch.
    
    Fixes: 373cd784d0fc ("metag: Memory handling")
    Reported-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: linux-metag@vger.kernel.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4a93ac814ddcc8d2841f224d9157ab241feab1ac
Author: James Hogan <jhogan@kernel.org>
Date:   Fri Mar 31 13:35:01 2017 +0100

    metag/usercopy: Add early abort to copy_to_user
    
    commit fb8ea062a8f2e85256e13f55696c5c5f0dfdcc8b upstream.
    
    When copying to userland on Meta, if any faults are encountered
    immediately abort the copy instead of continuing on and repeatedly
    faulting, and worse potentially copying further bytes successfully to
    subsequent valid pages.
    
    Fixes: 373cd784d0fc ("metag: Memory handling")
    Reported-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: linux-metag@vger.kernel.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 49a292dcd86bd04794cfc50f87ff5aa4444df088
Author: James Hogan <jhogan@kernel.org>
Date:   Fri Mar 31 11:23:18 2017 +0100

    metag/usercopy: Fix alignment error checking
    
    commit 2257211942bbbf6c798ab70b487d7e62f7835a1a upstream.
    
    Fix the error checking of the alignment adjustment code in
    raw_copy_from_user(), which mistakenly considers it safe to skip the
    error check when aligning the source buffer on a 2 or 4 byte boundary.
    
    If the destination buffer was unaligned it may have started to copy
    using byte or word accesses, which could well be at the start of a new
    (valid) source page. This would result in it appearing to have copied 1
    or 2 bytes at the end of the first (invalid) page rather than none at
    all.
    
    Fixes: 373cd784d0fc ("metag: Memory handling")
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: linux-metag@vger.kernel.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2bb52b47e7f420bbed4192efca20a9de8ff4fa08
Author: James Hogan <jhogan@kernel.org>
Date:   Fri Mar 31 10:37:44 2017 +0100

    metag/usercopy: Drop unused macros
    
    commit ef62a2d81f73d9cddef14bc3d9097a57010d551c upstream.
    
    Metag's lib/usercopy.c has a bunch of copy_from_user macros for larger
    copies between 5 and 16 bytes which are completely unused. Before fixing
    zeroing lets drop these macros so there is less to fix.
    
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: Al Viro <viro@zeniv.linux.org.uk>
    Cc: linux-metag@vger.kernel.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9afc076d281208464039eafdd99d6c53e7862236
Author: Arend Van Spriel <arend.vanspriel@broadcom.com>
Date:   Tue Mar 28 09:11:30 2017 +0100

    brcmfmac: use local iftype avoiding use-after-free of virtual interface
    
    commit d77facb88448cdeaaa3adba5b9704a48ac2ac8d6 upstream.
    
    A use-after-free was found using KASAN. In brcmf_p2p_del_if() the virtual
    interface is removed using call to brcmf_remove_interface(). After that
    the virtual interface instance has been freed and should not be referenced.
    Solve this by storing the nl80211 iftype in local variable, which is used
    in a couple of places anyway.
    
    Reported-by: Daniel J Blueman <daniel@quora.org>
    Reviewed-by: Hante Meuleman <hante.meuleman@broadcom.com>
    Reviewed-by: Pieter-Paul Giesberts <pieter-paul.giesberts@broadcom.com>
    Reviewed-by: Franky Lin <franky.lin@broadcom.com>
    Signed-off-by: Arend van Spriel <arend.vanspriel@broadcom.com>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c0321505df2eedfb468512d629cd198b1abc2d03
Author: Johannes Berg <johannes.berg@intel.com>
Date:   Wed Mar 29 14:15:24 2017 +0200

    mac80211: unconditionally start new netdev queues with iTXQ support
    
    commit 7d65f82954dadbbe7b6e1aec7e07ad17bc6d958b upstream.
    
    When internal mac80211 TXQs aren't supported, netdev queues must
    always started out started even when driver queues are stopped
    while the interface is added. This is necessary because with the
    internal TXQ support netdev queues are never stopped and packet
    scheduling/dropping is done in mac80211.
    
    Fixes: 80a83cfc434b1 ("mac80211: skip netdev queue control with software queuing")
    Reported-and-tested-by: Sven Eckelmann <sven.eckelmann@openmesh.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 703cebf6e978bb44a9752ddbe62e4330cbaa0e0c
Author: Wei Yongjun <yongjun_wei@trendmicro.com.cn>
Date:   Fri Jun 17 17:33:59 2016 +0000

    ring-buffer: Fix return value check in test_ringbuffer()
    
    commit 62277de758b155dc04b78f195a1cb5208c37b2df upstream.
    
    In case of error, the function kthread_run() returns ERR_PTR()
    and never returns NULL. The NULL test in the return value check
    should be replaced with IS_ERR().
    
    Link: http://lkml.kernel.org/r/1466184839-14927-1-git-send-email-weiyj_lk@163.com
    
    Fixes: 6c43e554a ("ring-buffer: Add ring buffer startup selftest")
    Signed-off-by: Wei Yongjun <yongjun_wei@trendmicro.com.cn>
    Signed-off-by: Steven Rostedt (VMware) <rostedt@goodmis.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f7db18998e9c1e0eef40cf43de44cc28109d2235
Author: Calvin Owens <calvinowens@fb.com>
Date:   Mon Apr 3 12:22:29 2017 -0700

    xfs: Honor FALLOC_FL_KEEP_SIZE when punching ends of files
    
    commit 3dd09d5a8589c640abb49cfcf92b4ed669eafad1 upstream.
    
    When punching past EOF on XFS, fallocate(mode=PUNCH_HOLE|KEEP_SIZE) will
    round the file size up to the nearest multiple of PAGE_SIZE:
    
      calvinow@vm-disks/generic-xfs-1 ~$ dd if=/dev/urandom of=test bs=2048 count=1
      calvinow@vm-disks/generic-xfs-1 ~$ stat test
        Size: 2048            Blocks: 8          IO Block: 4096   regular file
      calvinow@vm-disks/generic-xfs-1 ~$ fallocate -n -l 2048 -o 2048 -p test
      calvinow@vm-disks/generic-xfs-1 ~$ stat test
        Size: 4096            Blocks: 8          IO Block: 4096   regular file
    
    Commit 3c2bdc912a1cc050 ("xfs: kill xfs_zero_remaining_bytes") replaced
    xfs_zero_remaining_bytes() with calls to iomap helpers. The new helpers
    don't enforce that [pos,offset) lies strictly on [0,i_size) when being
    called from xfs_free_file_space(), so by "leaking" these ranges into
    xfs_zero_range() we get this buggy behavior.
    
    Fix this by reintroducing the checks xfs_zero_remaining_bytes() did
    against i_size at the bottom of xfs_free_file_space().
    
    Reported-by: Aaron Gao <gzh@fb.com>
    Fixes: 3c2bdc912a1cc050 ("xfs: kill xfs_zero_remaining_bytes")
    Cc: Christoph Hellwig <hch@lst.de>
    Cc: Brian Foster <bfoster@redhat.com>
    Signed-off-by: Calvin Owens <calvinowens@fb.com>
    Reviewed-by: Christoph Hellwig <hch@lst.de>
    Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
    Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dc62935ce0fbeed98f10907d8fad8b13c0a73d33
Author: Martin Brandenburg <martin@omnibond.com>
Date:   Thu Apr 6 18:11:00 2017 -0400

    orangefs: move features validation to fix filesystem hang
    
    commit cefdc26e86728812aea54248a534fd4a5da2a43d upstream.
    
    Without this fix (and another to the userspace component itself
    described later), the kernel will be unable to process any OrangeFS
    requests after the userspace component is restarted (due to a crash or
    at the administrator's behest).
    
    The bug here is that inside orangefs_remount, the orangefs_request_mutex
    is locked.  When the userspace component restarts while the filesystem
    is mounted, it sends a ORANGEFS_DEV_REMOUNT_ALL ioctl to the device,
    which causes the kernel to send it a few requests aimed at synchronizing
    the state between the two.  While this is happening the
    orangefs_request_mutex is locked to prevent any other requests going
    through.
    
    This is only half of the bugfix.  The other half is in the userspace
    component which outright ignores(!) requests made before it considers
    the filesystem remounted, which is after the ioctl returns.  Of course
    the ioctl doesn't return until after the userspace component responds to
    the request it ignores.  The userspace component has been changed to
    allow ORANGEFS_VFS_OP_FEATURES regardless of the mount status.
    
    Mike Marshall says:
     "I've tested this patch against the fixed userspace part. This patch is
      real important, I hope it can make it into 4.11...
    
      Here's what happens when the userspace daemon is restarted, without
      the patch:
    
        =============================================
        [ INFO: possible recursive locking detected ]
        [   4.10.0-00007-ge98bdb3 #1 Not tainted    ]
        ---------------------------------------------
        pvfs2-client-co/29032 is trying to acquire lock:
         (orangefs_request_mutex){+.+.+.}, at: service_operation+0x3c7/0x7b0 [orangefs]
                      but task is already holding lock:
         (orangefs_request_mutex){+.+.+.}, at: dispatch_ioctl_command+0x1bf/0x330 [orangefs]
    
        CPU: 0 PID: 29032 Comm: pvfs2-client-co Not tainted 4.10.0-00007-ge98bdb3 #1
        Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.9.3-1.fc25 04/01/2014
        Call Trace:
         __lock_acquire+0x7eb/0x1290
         lock_acquire+0xe8/0x1d0
         mutex_lock_killable_nested+0x6f/0x6e0
         service_operation+0x3c7/0x7b0 [orangefs]
         orangefs_remount+0xea/0x150 [orangefs]
         dispatch_ioctl_command+0x227/0x330 [orangefs]
         orangefs_devreq_ioctl+0x29/0x70 [orangefs]
         do_vfs_ioctl+0xa3/0x6e0
         SyS_ioctl+0x79/0x90"
    
    Signed-off-by: Martin Brandenburg <martin@omnibond.com>
    Acked-by: Mike Marshall <hubcap@omnibond.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c4fe79a44a5ddcfc19d87bb02c3c8d6b4cf2e8e6
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Fri Jan 13 16:40:01 2017 +0100

    Kbuild: use cc-disable-warning consistently for maybe-uninitialized
    
    commit b334e19ae9381f12a7521976883022385d2b7eef upstream.
    
    In commit a76bcf557ef4 ("Kbuild: enable -Wmaybe-uninitialized warning
    for "make W=1""), I reverted another change that happened to fix a problem
    with old compilers, and now we get this report again with old compilers
    (prior to gcc-4.8) and GCOV enabled:
    
       cc1: warnings being treated as errors
       drivers/gpu/drm/i915/intel_ringbuffer.c: In function 'intel_ring_setup_status_page':
       drivers/gpu/drm/i915/intel_ringbuffer.c:438: error: 'mmio.reg' may be used uninitialized in this function
       At top level:
    >> cc1: error: unrecognized command line option "-Wno-maybe-uninitialized"
    
    The problem is that we turn off the warning conditionally in a number
    of places as we should, but one of them does it unconditionally.
    Instead, change it to call cc-disable-warning as we do elsewhere.
    
    The original patch that caused it was merged into linux-4.7, then
    4.8 removed the change and 4.9 brought it back, so we probably want
    a backport to 4.9 once this is merged.
    
    Use a ':=' assignment instead of '=' to force the cc-disable-warning
    call to only be evaluated once instead of every time.
    
    Fixes: a76bcf557ef4 ("Kbuild: enable -Wmaybe-uninitialized warning for "make W=1"")
    Fixes: e72e2dfe7c16 ("gcov: disable -Wmaybe-uninitialized warning")
    Reported-by: kbuild test robot <fengguang.wu@intel.com>
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Signed-off-by: Masahiro Yamada <yamada.masahiro@socionext.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e4a62348935ef4305bf9490cefcf17602c34404a
Author: Dmitry Torokhov <dmitry.torokhov@gmail.com>
Date:   Thu Mar 23 13:21:38 2017 -0700

    ACPI / gpio: do not fall back to parsing _CRS when we get a deferral
    
    commit 693bdaa164b40b7aa6018b98af6f7e40dbd52457 upstream.
    
    If, while locating GPIOs by name, we get probe deferral, we should
    immediately report it to caller rather than trying to fall back to parsing
    unnamed GPIOs from _CRS block.
    
    Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
    Acked-by: Mika Westerberg <mika.westerberg@linux.intel.com>
    Acked-and-Tested-by: Hans de Goede <hdegoede@redhat.com>
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ab83597b9d404793d93bf80657503fac99e96299
Author: Sami Tolvanen <samitolvanen@google.com>
Date:   Fri Mar 31 12:32:45 2017 -0700

    dm verity fec: fix bufio leaks
    
    commit 86e3e83b443669dd2bcc5c8a83b23e3aa0694c0d upstream.
    
    Buffers read through dm_bufio_read() were not released in all code paths.
    
    Fixes: a739ff3f543a ("dm verity: add support for forward error correction")
    Signed-off-by: Sami Tolvanen <samitolvanen@google.com>
    Signed-off-by: Mike Snitzer <snitzer@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2ff087642643e9ac2aceb7a07c227357751c9a1b
Author: Sami Tolvanen <samitolvanen@google.com>
Date:   Wed Mar 15 15:12:23 2017 -0700

    dm verity fec: limit error correction recursion
    
    commit f1a880a93baaadb14c10a348fd199f1cdb6bcccd upstream.
    
    If the hash tree itself is sufficiently corrupt in addition to data blocks,
    it's possible for error correction to end up in a deep recursive loop,
    which eventually causes a kernel panic.  This change limits the
    recursion to a reasonable level during a single I/O operation.
    
    Fixes: a739ff3f543a ("dm verity: add support for forward error correction")
    Signed-off-by: Sami Tolvanen <samitolvanen@google.com>
    Signed-off-by: Mike Snitzer <snitzer@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d9fa4351037b60068e108465afb5ddf66b8d115e
Author: bsegall@google.com <bsegall@google.com>
Date:   Fri Apr 7 16:04:51 2017 -0700

    ptrace: fix PTRACE_LISTEN race corrupting task->state
    
    commit 5402e97af667e35e54177af8f6575518bf251d51 upstream.
    
    In PT_SEIZED + LISTEN mode STOP/CONT signals cause a wakeup against
    __TASK_TRACED.  If this races with the ptrace_unfreeze_traced at the end
    of a PTRACE_LISTEN, this can wake the task /after/ the check against
    __TASK_TRACED, but before the reset of state to TASK_TRACED.  This
    causes it to instead clobber TASK_WAKING, allowing a subsequent wakeup
    against TRACED while the task is still on the rq wake_list, corrupting
    it.
    
    Oleg said:
     "The kernel can crash or this can lead to other hard-to-debug problems.
      In short, "task->state = TASK_TRACED" in ptrace_unfreeze_traced()
      assumes that nobody else can wake it up, but PTRACE_LISTEN breaks the
      contract. Obviusly it is very wrong to manipulate task->state if this
      task is already running, or WAKING, or it sleeps again"
    
    [akpm@linux-foundation.org: coding-style fixes]
    Fixes: 9899d11f ("ptrace: ensure arch_ptrace/ptrace_request can never race with SIGKILL")
    Link: http://lkml.kernel.org/r/xm26y3vfhmkp.fsf_-_@bsegall-linux.mtv.corp.google.com
    Signed-off-by: Ben Segall <bsegall@google.com>
    Acked-by: Oleg Nesterov <oleg@redhat.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e3b08ebe47734b65a8dae73499aac4f3a6eb258e
Author: Alexander Polakov <apolyakov@beget.ru>
Date:   Fri Apr 7 16:04:45 2017 -0700

    mm/page_alloc.c: fix print order in show_free_areas()
    
    commit 1f06b81aea5ecba2c1f8afd87e0ba1b9f8f90160 upstream.
    
    Fixes: 11fb998986a72a ("mm: move most file-based accounting to the node")
    Link: http://lkml.kernel.org/r/1490377730.30219.2.camel@beget.ru
    Signed-off-by: Alexander Polyakov <apolyakov@beget.com>
    Acked-by: Michal Hocko <mhocko@suse.com>
    Cc: Mel Gorman <mgorman@techsingularity.net>
    Cc: Vlastimil Babka <vbabka@suse.cz>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8446cb1adf95fd12289865ec9f21c7d877d0be04
Author: Jan-Marek Glogowski <glogow@fbihome.de>
Date:   Mon Feb 20 12:25:58 2017 +0100

    Reset TreeId to zero on SMB2 TREE_CONNECT
    
    commit 806a28efe9b78ffae5e2757e1ee924b8e50c08ab upstream.
    
    Currently the cifs module breaks the CIFS specs on reconnect as
    described in http://msdn.microsoft.com/en-us/library/cc246529.aspx:
    
    "TreeId (4 bytes): Uniquely identifies the tree connect for the
    command. This MUST be 0 for the SMB2 TREE_CONNECT Request."
    
    Signed-off-by: Jan-Marek Glogowski <glogow@fbihome.de>
    Reviewed-by: Aurelien Aptel <aaptel@suse.com>
    Tested-by: Aurelien Aptel <aaptel@suse.com>
    Signed-off-by: Steve French <smfrench@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 57e1e90dda74f87bef31bcc5eea89f775b7b3c69
Author: Arend Van Spriel <arend.vanspriel@broadcom.com>
Date:   Tue Mar 28 09:11:31 2017 +0100

    cfg80211: check rdev resume callback only for registered wiphy
    
    commit b3ef5520c1eabb56064474043c7c55a1a65b8708 upstream.
    
    We got the following use-after-free KASAN report:
    
     BUG: KASAN: use-after-free in wiphy_resume+0x591/0x5a0 [cfg80211]
             at addr ffff8803fc244090
     Read of size 8 by task kworker/u16:24/2587
     CPU: 6 PID: 2587 Comm: kworker/u16:24 Tainted: G    B 4.9.13-debug+
     Hardware name: Dell Inc. XPS 15 9550/0N7TVV, BIOS 1.2.19 12/22/2016
     Workqueue: events_unbound async_run_entry_fn
      ffff880425d4f9d8 ffffffffaeedb541 ffff88042b80ef00 ffff8803fc244088
      ffff880425d4fa00 ffffffffae84d7a1 ffff880425d4fa98 ffff8803fc244080
      ffff88042b80ef00 ffff880425d4fa88 ffffffffae84da3a ffffffffc141f7d9
     Call Trace:
      [<ffffffffaeedb541>] dump_stack+0x85/0xc4
      [<ffffffffae84d7a1>] kasan_object_err+0x21/0x70
      [<ffffffffae84da3a>] kasan_report_error+0x1fa/0x500
      [<ffffffffc141f7d9>] ? cfg80211_bss_age+0x39/0xc0 [cfg80211]
      [<ffffffffc141f83a>] ? cfg80211_bss_age+0x9a/0xc0 [cfg80211]
      [<ffffffffae48d46d>] ? trace_hardirqs_on+0xd/0x10
      [<ffffffffc13fb1c0>] ? wiphy_suspend+0xc70/0xc70 [cfg80211]
      [<ffffffffae84def1>] __asan_report_load8_noabort+0x61/0x70
      [<ffffffffc13fb100>] ? wiphy_suspend+0xbb0/0xc70 [cfg80211]
      [<ffffffffc13fb751>] ? wiphy_resume+0x591/0x5a0 [cfg80211]
      [<ffffffffc13fb751>] wiphy_resume+0x591/0x5a0 [cfg80211]
      [<ffffffffc13fb1c0>] ? wiphy_suspend+0xc70/0xc70 [cfg80211]
      [<ffffffffaf3b206e>] dpm_run_callback+0x6e/0x4f0
      [<ffffffffaf3b31b2>] device_resume+0x1c2/0x670
      [<ffffffffaf3b367d>] async_resume+0x1d/0x50
      [<ffffffffae3ee84e>] async_run_entry_fn+0xfe/0x610
      [<ffffffffae3d0666>] process_one_work+0x716/0x1a50
      [<ffffffffae3d05c9>] ? process_one_work+0x679/0x1a50
      [<ffffffffafdd7b6d>] ? _raw_spin_unlock_irq+0x3d/0x60
      [<ffffffffae3cff50>] ? pwq_dec_nr_in_flight+0x2b0/0x2b0
      [<ffffffffae3d1a80>] worker_thread+0xe0/0x1460
      [<ffffffffae3d19a0>] ? process_one_work+0x1a50/0x1a50
      [<ffffffffae3e54c2>] kthread+0x222/0x2e0
      [<ffffffffae3e52a0>] ? kthread_park+0x80/0x80
      [<ffffffffae3e52a0>] ? kthread_park+0x80/0x80
      [<ffffffffae3e52a0>] ? kthread_park+0x80/0x80
      [<ffffffffafdd86aa>] ret_from_fork+0x2a/0x40
     Object at ffff8803fc244088, in cache kmalloc-1024 size: 1024
     Allocated:
     PID = 71
      save_stack_trace+0x1b/0x20
      save_stack+0x46/0xd0
      kasan_kmalloc+0xad/0xe0
      kasan_slab_alloc+0x12/0x20
      __kmalloc_track_caller+0x134/0x360
      kmemdup+0x20/0x50
      brcmf_cfg80211_attach+0x10b/0x3a90 [brcmfmac]
      brcmf_bus_start+0x19a/0x9a0 [brcmfmac]
      brcmf_pcie_setup+0x1f1a/0x3680 [brcmfmac]
      brcmf_fw_request_nvram_done+0x44c/0x11b0 [brcmfmac]
      request_firmware_work_func+0x135/0x280
      process_one_work+0x716/0x1a50
      worker_thread+0xe0/0x1460
      kthread+0x222/0x2e0
      ret_from_fork+0x2a/0x40
     Freed:
     PID = 2568
      save_stack_trace+0x1b/0x20
      save_stack+0x46/0xd0
      kasan_slab_free+0x71/0xb0
      kfree+0xe8/0x2e0
      brcmf_cfg80211_detach+0x62/0xf0 [brcmfmac]
      brcmf_detach+0x14a/0x2b0 [brcmfmac]
      brcmf_pcie_remove+0x140/0x5d0 [brcmfmac]
      brcmf_pcie_pm_leave_D3+0x198/0x2e0 [brcmfmac]
      pci_pm_resume+0x186/0x220
      dpm_run_callback+0x6e/0x4f0
      device_resume+0x1c2/0x670
      async_resume+0x1d/0x50
      async_run_entry_fn+0xfe/0x610
      process_one_work+0x716/0x1a50
      worker_thread+0xe0/0x1460
      kthread+0x222/0x2e0
      ret_from_fork+0x2a/0x40
     Memory state around the buggy address:
      ffff8803fc243f80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
      ffff8803fc244000: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
     >ffff8803fc244080: fc fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
                              ^
      ffff8803fc244100: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
      ffff8803fc244180: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
    
    What is happening is that brcmf_pcie_resume() detects a device that
    is no longer responsive and it decides to unbind resulting in a
    wiphy_unregister() and wiphy_free() call. Now the wiphy instance
    remains allocated, because PM needs to call wiphy_resume() for it.
    However, brcmfmac already does a kfree() for the struct
    cfg80211_registered_device::ops field. Change the checks in
    wiphy_resume() to only access the struct cfg80211_registered_device::ops
    if the wiphy instance is still registered at this time.
    
    Reported-by: Daniel J Blueman <daniel@quora.org>
    Reviewed-by: Hante Meuleman <hante.meuleman@broadcom.com>
    Reviewed-by: Pieter-Paul Giesberts <pieter-paul.giesberts@broadcom.com>
    Reviewed-by: Franky Lin <franky.lin@broadcom.com>
    Signed-off-by: Arend van Spriel <arend.vanspriel@broadcom.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3715dbf77f3bcbd82f447b50e3310f5139028cde
Author: Victor Kamensky <kamensky@cisco.com>
Date:   Mon Apr 3 22:51:01 2017 -0700

    arm64: mm: unaligned access by user-land should be received as SIGBUS
    
    commit 09a6adf53d42ca3088fa3fb41f40b768efc711ed upstream.
    
    After 52d7523 (arm64: mm: allow the kernel to handle alignment faults on
    user accesses) commit user-land accesses that produce unaligned exceptions
    like in case of aarch32 ldm/stm/ldrd/strd instructions operating on
    unaligned memory received by user-land as SIGSEGV. It is wrong, it should
    be reported as SIGBUS as it was before 52d7523 commit.
    
    Changed do_bad_area function to take signal and code parameters out of esr
    value using fault_info table, so in case of do_alignment_fault fault
    user-land will receive SIGBUS. Wrapped access to fault_info table into
    esr_to_fault_info function.
    
    Fixes: 52d7523 (arm64: mm: allow the kernel to handle alignment faults on user accesses)
    Signed-off-by: Victor Kamensky <kamensky@cisco.com>
    Signed-off-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 71b44ef83d2a74e1be9053f80455f62086fae822
Author: Quentin Schulz <quentin.schulz@free-electrons.com>
Date:   Tue Mar 21 16:52:14 2017 +0100

    iio: bmg160: reset chip when probing
    
    commit 4bdc9029685ac03be50b320b29691766d2326c2b upstream.
    
    The gyroscope chip might need to be reset to be used.
    
    Without the chip being reset, the driver stopped at the first
    regmap_read (to get the CHIP_ID) and failed to probe.
    
    The datasheet of the gyroscope says that a minimum wait of 30ms after
    the reset has to be done.
    
    This patch has been checked on a BMX055 and the datasheet of the BMG160
    and the BMI055 give the same reset register and bits.
    
    Signed-off-by: Quentin Schulz <quentin.schulz@free-electrons.com>
    Signed-off-by: Jonathan Cameron <jic23@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ac303c64cdb82a66817df89a7b56ebececd7396f
Author: Suzuki K Poulose <suzuki.poulose@arm.com>
Date:   Mon Apr 3 15:12:43 2017 +0100

    kvm: arm/arm64: Fix locking for kvm_free_stage2_pgd
    
    commit 8b3405e345b5a098101b0c31b264c812bba045d9 upstream.
    
    In kvm_free_stage2_pgd() we don't hold the kvm->mmu_lock while calling
    unmap_stage2_range() on the entire memory range for the guest. This could
    cause problems with other callers (e.g, munmap on a memslot) trying to
    unmap a range. And since we have to unmap the entire Guest memory range
    holding a spinlock, make sure we yield the lock if necessary, after we
    unmap each PUD range.
    
    Fixes: commit d5d8184d35c9 ("KVM: ARM: Memory virtualization setup")
    Cc: Paolo Bonzini <pbonzin@redhat.com>
    Cc: Marc Zyngier <marc.zyngier@arm.com>
    Cc: Christoffer Dall <christoffer.dall@linaro.org>
    Cc: Mark Rutland <mark.rutland@arm.com>
    Signed-off-by: Suzuki K Poulose <suzuki.poulose@arm.com>
    [ Avoid vCPU starvation and lockup detector warnings ]
    Signed-off-by: Marc Zyngier <marc.zyngier@arm.com>
    Signed-off-by: Suzuki K Poulose <suzuki.poulose@arm.com>
    Signed-off-by: Christoffer Dall <cdall@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a1ea3189368498e8921cb8173144fee2b191d019
Author: Marc Zyngier <maz@kernel.org>
Date:   Thu Mar 16 18:20:50 2017 +0000

    arm/arm64: KVM: Take mmap_sem in kvm_arch_prepare_memory_region
    
    commit 72f310481a08db821b614e7b5d00febcc9064b36 upstream.
    
    We don't hold the mmap_sem while searching for VMAs (via find_vma), in
    kvm_arch_prepare_memory_region, which can end up in expected failures.
    
    Fixes: commit 8eef91239e57 ("arm/arm64: KVM: map MMIO regions at creation time")
    Cc: Ard Biesheuvel <ard.biesheuvel@linaro.org>
    Cc: Eric Auger <eric.auger@rehat.com>
    Reviewed-by: Christoffer Dall <cdall@linaro.org>
    [ Handle dirty page logging failure case ]
    Signed-off-by: Suzuki K Poulose <suzuki.poulose@arm.com>
    Signed-off-by: Marc Zyngier <marc.zyngier@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 48f2825abc65943437033adfd05b59e287ea3bfd
Author: Marc Zyngier <maz@kernel.org>
Date:   Thu Mar 16 18:20:49 2017 +0000

    arm/arm64: KVM: Take mmap_sem in stage2_unmap_vm
    
    commit 90f6e150e44a0dc3883110eeb3ab35d1be42b6bb upstream.
    
    We don't hold the mmap_sem while searching for the VMAs when
    we try to unmap each memslot for a VM. Fix this properly to
    avoid unexpected results.
    
    Fixes: commit 957db105c997 ("arm/arm64: KVM: Introduce stage2_unmap_vm")
    Reviewed-by: Christoffer Dall <cdall@linaro.org>
    Signed-off-by: Suzuki K Poulose <suzuki.poulose@arm.com>
    Signed-off-by: Marc Zyngier <marc.zyngier@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8f8de8d2bf6cd0efc49116afd3aa02b64730d74e
Author: Shuxiao Zhang <zhangshuxiao@xiaomi.com>
Date:   Thu Apr 6 22:30:29 2017 +0800

    staging: android: ashmem: lseek failed due to no FMODE_LSEEK.
    
    commit 97fbfef6bd597888485b653175fb846c6998b60c upstream.
    
    vfs_llseek will check whether the file mode has
    FMODE_LSEEK, no return failure. But ashmem can be
    lseek, so add FMODE_LSEEK to ashmem file.
    
    Comment From Greg Hackmann:
            ashmem_llseek() passes the llseek() call through to the backing
            shmem file.  91360b02ab48 ("ashmem: use vfs_llseek()") changed
            this from directly calling the file's llseek() op into a VFS
            layer call.  This also adds a check for the FMODE_LSEEK bit, so
            without that bit ashmem_llseek() now always fails with -ESPIPE.
    
    Fixes: 91360b02ab48 ("ashmem: use vfs_llseek()")
    Signed-off-by: Shuxiao Zhang <zhangshuxiao@xiaomi.com>
    Tested-by: Greg Hackmann <ghackmann@google.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d9eedab38395ac98c21545a5aa0664112af0526b
Author: NeilBrown <neilb@suse.com>
Date:   Mon Apr 3 11:30:34 2017 +1000

    sysfs: be careful of error returns from ops->show()
    
    commit c8a139d001a1aab1ea8734db14b22dac9dd143b6 upstream.
    
    ops->show() can return a negative error code.
    Commit 65da3484d9be ("sysfs: correctly handle short reads on PREALLOC attrs.")
    (in v4.4) caused this to be stored in an unsigned 'size_t' variable, so errors
    would look like large numbers.
    As a result, if an error is returned, sysfs_kf_read() will return the
    value of 'count', typically 4096.
    
    Commit 17d0774f8068 ("sysfs: correctly handle read offset on PREALLOC attrs")
    (in v4.8) extended this error to use the unsigned large 'len' as a size for
    memmove().
    Consequently, if ->show returns an error, then the first read() on the
    sysfs file will return 4096 and could return uninitialized memory to
    user-space.
    If the application performs a subsequent read, this will trigger a memmove()
    with extremely large count, and is likely to crash the machine is bizarre ways.
    
    This bug can currently only be triggered by reading from an md
    sysfs attribute declared with __ATTR_PREALLOC() during the
    brief period between when mddev_put() deletes an mddev from
    the ->all_mddevs list, and when mddev_delayed_delete() - which is
    scheduled on a workqueue - completes.
    Before this, an error won't be returned by the ->show()
    After this, the ->show() won't be called.
    
    I can reproduce it reliably only by putting delay like
            usleep_range(500000,700000);
    early in mddev_delayed_delete(). Then after creating an
    md device md0 run
      echo clear > /sys/block/md0/md/array_state; cat /sys/block/md0/md/array_state
    
    The bug can be triggered without the usleep.
    
    Fixes: 65da3484d9be ("sysfs: correctly handle short reads on PREALLOC attrs.")
    Fixes: 17d0774f8068 ("sysfs: correctly handle read offset on PREALLOC attrs")
    Signed-off-by: NeilBrown <neilb@suse.com>
    Acked-by: Tejun Heo <tj@kernel.org>
    Reported-and-tested-by: Miroslav Benes <mbenes@suse.cz>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4ddd24d54fedff301e8f020d7b9f70116383af31
Author: Li Qiang <liq3ea@gmail.com>
Date:   Mon Mar 27 20:10:53 2017 -0700

    drm/vmwgfx: fix integer overflow in vmw_surface_define_ioctl()
    
    commit e7e11f99564222d82f0ce84bd521e57d78a6b678 upstream.
    
    In vmw_surface_define_ioctl(), the 'num_sizes' is the sum of the
    'req->mip_levels' array. This array can be assigned any value from
    the user space. As both the 'num_sizes' and the array is uint32_t,
    it is easy to make 'num_sizes' overflow. The later 'mip_levels' is
    used as the loop count. This can lead an oob write. Add the check of
    'req->mip_levels' to avoid this.
    
    Signed-off-by: Li Qiang <liqiang6-s@360.cn>
    Reviewed-by: Thomas Hellstrom <thellstrom@vmware.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 28c84df739e3ac2bdb7898d6b5f92aa72330a423
Author: Thomas Hellstrom <thellstrom@vmware.com>
Date:   Mon Mar 27 13:06:05 2017 +0200

    drm/vmwgfx: Remove getparam error message
    
    commit 53e16798b0864464c5444a204e1bb93ae246c429 upstream.
    
    The mesa winsys sometimes uses unimplemented parameter requests to
    check for features. Remove the error message to avoid bloating the
    kernel log.
    
    Signed-off-by: Thomas Hellstrom <thellstrom@vmware.com>
    Reviewed-by: Brian Paul <brianp@vmware.com>
    Reviewed-by: Sinclair Yeh <syeh@vmware.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b116797b81e55c6ac9ddcbf92bcd662648273045
Author: Thomas Hellstrom <thellstrom@vmware.com>
Date:   Mon Mar 27 11:21:25 2017 +0200

    drm/ttm, drm/vmwgfx: Relax permission checking when opening surfaces
    
    commit fe25deb7737ce6c0879ccf79c99fa1221d428bf2 upstream.
    
    Previously, when a surface was opened using a legacy (non prime) handle,
    it was verified to have been created by a client in the same master realm.
    Relax this so that opening is also allowed recursively if the client
    already has the surface open.
    
    This works around a regression in svga mesa where opening of a shared
    surface is used recursively to obtain surface information.
    
    Signed-off-by: Thomas Hellstrom <thellstrom@vmware.com>
    Reviewed-by: Sinclair Yeh <syeh@vmware.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 604d2eac67cb3518aa6a236ec505fbe7c60947af
Author: Murray McAllister <murray.mcallister@insomniasec.com>
Date:   Mon Mar 27 11:15:12 2017 +0200

    drm/vmwgfx: avoid calling vzalloc with a 0 size in vmw_get_cap_3d_ioctl()
    
    commit 63774069d9527a1aeaa4aa20e929ef5e8e9ecc38 upstream.
    
    In vmw_get_cap_3d_ioctl(), a user can supply 0 for a size that is
    used in vzalloc(). This eventually calls dump_stack() (in warn_alloc()),
    which can leak useful addresses to dmesg.
    
    Add check to avoid a size of 0.
    
    Signed-off-by: Murray McAllister <murray.mcallister@insomniasec.com>
    Reviewed-by: Sinclair Yeh <syeh@vmware.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 73ab72517b61ce4b27ceddec47dd5d6edafb556a
Author: Murray McAllister <murray.mcallister@insomniasec.com>
Date:   Mon Mar 27 11:12:53 2017 +0200

    drm/vmwgfx: NULL pointer dereference in vmw_surface_define_ioctl()
    
    commit 36274ab8c596f1240c606bb514da329add2a1bcd upstream.
    
    Before memory allocations vmw_surface_define_ioctl() checks the
    upper-bounds of a user-supplied size, but does not check if the
    supplied size is 0.
    
    Add check to avoid NULL pointer dereferences.
    
    Signed-off-by: Murray McAllister <murray.mcallister@insomniasec.com>
    Reviewed-by: Sinclair Yeh <syeh@vmware.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 92cc48166e4909c5eb6b1e2abbab9ab07b64b6dd
Author: Thomas Hellstrom <thellstrom@vmware.com>
Date:   Mon Mar 27 11:09:08 2017 +0200

    drm/vmwgfx: Type-check lookups of fence objects
    
    commit f7652afa8eadb416b23eb57dec6f158529942041 upstream.
    
    A malicious caller could otherwise hand over handles to other objects
    causing all sorts of interesting problems.
    
    Testing done: Ran a Fedora 25 desktop using both Xorg and
    gnome-shell/Wayland.
    
    Signed-off-by: Thomas Hellstrom <thellstrom@vmware.com>
    Reviewed-by: Sinclair Yeh <syeh@vmware.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9c2b46e720d5b083268ca0131f513a90696f3a82
Author: Sudip Mukherjee <sudipm.mukherjee@gmail.com>
Date:   Mon Mar 6 23:23:43 2017 +0000

    ppdev: fix registering same device name
    
    commit 9a69645dde1188723d80745c1bc6ee9af2cbe2a7 upstream.
    
    Usually every parallel port will have a single pardev registered with
    it. But ppdev driver is an exception. This userspace parallel port
    driver allows to create multiple parrallel port devices for a single
    parallel port. And as a result we were having a big warning like:
    "sysfs: cannot create duplicate filename '/devices/parport0/ppdev0.0'".
    And with that many parallel port printers stopped working.
    
    We have been using the minor number as the id field while registering
    a parralel port device with a parralel port. But when there are
    multiple parrallel port device for one single parallel port, they all
    tried to register with the same name like 'pardev0.0' and everything
    started failing.
    Use an incremented index as the id instead of the minor number.
    
    Fixes: 8b7d3a9d903e ("ppdev: use new parport device model")
    Cc: stable <stable@vger.kernel.org> # v4.9+
    Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1414656
    Bugzilla: https://bugs.archlinux.org/task/52322
    Tested-by: James Feeney <james@nurealm.net>
    Signed-off-by: Sudip Mukherjee <sudip.mukherjee@codethink.co.uk>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bf5202b58f61e8fe2dba5ec8cf5720225b1b9e4c
Author: Sudip Mukherjee <sudipm.mukherjee@gmail.com>
Date:   Sat Nov 12 21:22:12 2016 +0000

    ppdev: check before attaching port
    
    commit dd5c472a60e43549d789a17a8444513eec64bd7e upstream.
    
    After parport starts using the device model, all pardevice drivers
    should decide in their match_port callback function if they want to
    attach with that particulatr port. ppdev has been converted to use the
    new parport device-model code but pp_attach() tried to attach with all
    the ports.
    Create a new array of pointer and use that to remember the ports we
    have attached. And use that information to skip attaching ports which
    we have already attached.
    
    Tested-by: Joe Lawrence <joe.lawrence@redhat.com>
    Signed-off-by: Sudip Mukherjee <sudip.mukherjee@codethink.co.uk>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
