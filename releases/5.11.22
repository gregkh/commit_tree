commit ef8aed2fffe03c394547dde0cf3590f98555827f
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Wed May 19 10:30:06 2021 +0200

    Linux 5.11.22
    
    Tested-by: Jon Hunter <jonathanh@nvidia.com>
    Tested-by: Fox Chen <foxhlchen@gmail.com>
    Tested-by: Shuah Khan <skhan@linuxfoundation.org>
    Tested-by: Jason Self <jason@bluehome.net>
    Tested-by: Linux Kernel Functional Testing <lkft@linaro.org>
    Tested-by: Justin M. Forbes <jforbes@fedoraproject.org>
    Tested-by: Guenter Roeck <linux@roeck-us.net>
    Link: https://lore.kernel.org/r/20210517140302.043055203@linuxfoundation.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 262d48a3a6fb5293fa82c96a075ea5415a97e32a
Author: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
Date:   Thu Apr 8 13:28:47 2021 +0900

    ASoC: rsnd: check all BUSIF status when error
    
    commit a4856e15e58b54977f1c0c0299309ad4d1f13365 upstream.
    
    commit 66c705d07d784 ("SoC: rsnd: add interrupt support for SSI BUSIF
    buffer") adds __rsnd_ssi_interrupt() checks for BUSIF status,
    but is using "break" at for loop.
    This means it is not checking all status. Let's check all BUSIF status.
    
    Fixes: commit 66c705d07d784 ("SoC: rsnd: add interrupt support for SSI BUSIF buffer")
    Signed-off-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
    Link: https://lore.kernel.org/r/874kgh1jsw.wl-kuninori.morimoto.gx@renesas.com
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 91519cae06f5890f3e80e294b16a7a78dfa1925e
Author: Christoph Hellwig <hch@lst.de>
Date:   Fri Apr 9 11:46:12 2021 +0200

    nvme: do not try to reconfigure APST when the controller is not live
    
    commit 53fe2a30bc168db9700e00206d991ff934973cf1 upstream.
    
    Do not call nvme_configure_apst when the controller is not live, given
    that nvme_configure_apst will fail due the lack of an admin queue when
    the controller is being torn down and nvme_set_latency_tolerance is
    called from dev_pm_qos_hide_latency_tolerance.
    
    Fixes: 510a405d945b("nvme: fix memory leak for power latency tolerance")
    Reported-by: Peng Liu <liupeng17@lenovo.com>
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Reviewed-by: Keith Busch <kbusch@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fa1e80cfa6ca9be3abc9d81e8165c9b84e518fd0
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Fri Apr 9 22:12:05 2021 +0200

    ext4: fix debug format string warning
    
    commit fcdf3c34b7abdcbb49690c94c7fa6ce224dc9749 upstream.
    
    Using no_printk() for jbd_debug() revealed two warnings:
    
    fs/jbd2/recovery.c: In function 'fc_do_one_pass':
    fs/jbd2/recovery.c:256:30: error: format '%d' expects a matching 'int' argument [-Werror=format=]
      256 |                 jbd_debug(3, "Processing fast commit blk with seq %d");
          |                              ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    fs/ext4/fast_commit.c: In function 'ext4_fc_replay_add_range':
    fs/ext4/fast_commit.c:1732:30: error: format '%d' expects argument of type 'int', but argument 2 has type 'long unsigned int' [-Werror=format=]
     1732 |                 jbd_debug(1, "Converting from %d to %d %lld",
    
    The first one was added incorrectly, and was also missing a few newlines
    in debug output, and the second one happened when the type of an
    argument changed.
    
    Reported-by: kernel test robot <lkp@intel.com>
    Fixes: d556435156b7 ("jbd2: avoid -Wempty-body warnings")
    Fixes: 6db074618969 ("ext4: use BIT() macro for BH_** state bits")
    Fixes: 5b849b5f96b4 ("jbd2: fast commit recovery path")
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Link: https://lore.kernel.org/r/20210409201211.1866633-1-arnd@kernel.org
    Signed-off-by: Theodore Ts'o <tytso@mit.edu>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f784dd88f6ae87e2d0d7726e5a3ad0469b2d0ccf
Author: Kees Cook <keescook@chromium.org>
Date:   Mon Apr 5 14:39:59 2021 -0700

    debugfs: Make debugfs_allow RO after init
    
    commit 312723a0b34d6d110aa4427a982536bb36ab8471 upstream.
    
    Since debugfs_allow is only set at boot time during __init, make it
    read-only after being set.
    
    Fixes: a24c6f7bc923 ("debugfs: Add access restriction option")
    Cc: Peter Enderborg <peter.enderborg@sony.com>
    Reviewed-by: Peter Enderborg <peter.enderborg@sony.com>
    Signed-off-by: Kees Cook <keescook@chromium.org>
    Link: https://lore.kernel.org/r/20210405213959.3079432-1-keescook@chromium.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 250c9dde33e99612d0144fe7c50d835981596b43
Author: Geert Uytterhoeven <geert+renesas@glider.be>
Date:   Thu Apr 29 14:44:09 2021 +0200

    dt-bindings: PCI: rcar-pci-host: Document missing R-Car H1 support
    
    commit 62b3b3660aff66433d71f142ab6ed2baaea25025 upstream.
    
    scripts/checkpatch.pl -f drivers/pci/controller/pcie-rcar-host.c:
    
        WARNING: DT compatible string "renesas,pcie-r8a7779" appears un-documented -- check ./Documentation/devicetree/bindings/
        #853: FILE: drivers/pci/controller/pcie-rcar-host.c:853:
        +   { .compatible = "renesas,pcie-r8a7779",
    
    Re-add the compatible value for R-Car H1, which was lost during the
    json-schema conversion.  Make the "resets" property optional on R-Car
    H1, as it is not present yet on R-Car Gen1 SoCs.
    
    Fixes: 0d69ce3c2c63d4db ("dt-bindings: PCI: rcar-pci-host: Convert bindings to json-schema")
    Signed-off-by: Geert Uytterhoeven <geert+renesas@glider.be>
    Link: https://lore.kernel.org/r/fb0bb969cd0e5872ab5eac70e070242c0d8a5b81.1619700202.git.geert+renesas@glider.be
    Signed-off-by: Rob Herring <robh@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8046c84e23f49fad54f3f2404ff08323fc1510fe
Author: Zhen Lei <thunder.leizhen@huawei.com>
Date:   Thu Apr 22 17:08:57 2021 +0800

    dt-bindings: serial: 8250: Remove duplicated compatible strings
    
    commit a7277a73984114b38dcb62c8548850800ffe864e upstream.
    
    The compatible strings "mediatek,*" appears two times, remove one of them.
    
    Fixes: e69f5dc623f9 ("dt-bindings: serial: Convert 8250 to json-schema")
    Signed-off-by: Zhen Lei <thunder.leizhen@huawei.com>
    Link: https://lore.kernel.org/r/20210422090857.583-1-thunder.leizhen@huawei.com
    Signed-off-by: Rob Herring <robh@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b02e6118e7b1a1fb087cd05474d14eadbf0561a7
Author: Niklas Söderlund <niklas.soderlund+renesas@ragnatech.se>
Date:   Wed Mar 10 12:07:16 2021 +0100

    dt-bindings: thermal: rcar-gen3-thermal: Support five TSC nodes on r8a779a0
    
    commit 9468e7b031876935230182628f8d5f216c071784 upstream.
    
    When adding support for V3U (r8a779a0) it was incorrectly recorded it
    supports four nodes, while in fact it supports five. The fifth node is
    named TSC0 and breaks the existing naming schema starting at 1. Work
    around this by separately defining the reg property for V3U and others.
    
    Restore the maximum number of nodes to three for other compatibles as
    it was before erroneously increasing it for V3U.
    
    Fixes: d7fdfb6541f3be88 ("dt-bindings: thermal: rcar-gen3-thermal: Add r8a779a0 support")
    Signed-off-by: Niklas Söderlund <niklas.soderlund+renesas@ragnatech.se>
    Reviewed-by: Geert Uytterhoeven <geert+renesas@glider.be>
    Signed-off-by: Daniel Lezcano <daniel.lezcano@linaro.org>
    Link: https://lore.kernel.org/r/20210310110716.3297544-1-niklas.soderlund+renesas@ragnatech.se
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 73a63a7c985eb8c1f6de85bba25ba0179b6d76a3
Author: Geert Uytterhoeven <geert+renesas@glider.be>
Date:   Thu Apr 29 14:45:52 2021 +0200

    dt-bindings: media: renesas,vin: Make resets optional on R-Car Gen1
    
    commit 7935bb56e21b2add81149f4def8e59b4133fe57c upstream.
    
    The "resets" property is not present on R-Car Gen1 SoCs.
    Supporting it would require migrating from renesas,cpg-clocks to
    renesas,cpg-mssr.
    
    Fixes: 905fc6b1bfb4a631 ("dt-bindings: rcar-vin: Convert bindings to json-schema")
    Signed-off-by: Geert Uytterhoeven <geert+renesas@glider.be>
    Reviewed-by: Niklas Söderlund <niklas.soderlund+renesas@ragnatech.se>
    Link: https://lore.kernel.org/r/217c8197efaee7d803b22d433abb0ea8e33b84c6.1619700314.git.geert+renesas@glider.be
    Signed-off-by: Rob Herring <robh@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a894b72c40fda8c0efb070873559308160a3fac3
Author: Qii Wang <qii.wang@mediatek.com>
Date:   Sat Apr 17 14:46:50 2021 +0800

    i2c: mediatek: Fix send master code at more than 1MHz
    
    commit 63ce8e3df8f6deca2da52eaf064751ad4018b46e upstream.
    
    There are some omissions in the previous patch about replacing
    I2C_MAX_FAST_MODE__FREQ with I2C_MAX_FAST_MODE_PLUS_FREQ and
    need to fix it.
    
    Fixes: b44658e755b5("i2c: mediatek: Send i2c master code at more than 1MHz")
    Signed-off-by: Qii Wang <qii.wang@mediatek.com>
    Signed-off-by: Wolfram Sang <wsa@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9085b64078222b384742ec7763b308b02ee4d9a6
Author: Fabio Estevam <festevam@gmail.com>
Date:   Sat Mar 20 13:21:52 2021 +0100

    media: rkvdec: Remove of_match_ptr()
    
    commit c2357dd9cbafc8ed37156e32c24884cfa8380b2f upstream.
    
    When building with CONFIG_OF not set, the following clang
    build warning is seen:
    
    >> drivers/staging/media/rkvdec/rkvdec.c:967:34: warning: unused variable 'of_rkvdec_match' [-Wunused-const-variable]
    
    Fix the warning by removing the unnecessary of_match_ptr().
    
    Reported-by: kernel test robot <lkp@intel.com>
    Fixes: cd33c830448b ("media: rkvdec: Add the rkvdec driver")
    Signed-off-by: Fabio Estevam <festevam@gmail.com>
    Reviewed-by: Ezequiel Garcia <ezequiel@collabora.com>
    Signed-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>
    Signed-off-by: Mauro Carvalho Chehab <mchehab+huawei@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f4ecadc026d6f6a0afcb55531a80d4e56290cecc
Author: Enric Balletbo i Serra <enric.balletbo@collabora.com>
Date:   Thu Feb 25 18:49:59 2021 +0100

    soc: mediatek: pm-domains: Add a power domain names for mt8192
    
    commit 3edc01bc53c639b1c98f57e7f1c026aae6a25a62 upstream.
    
    Add the power domains names for the mt8192 SoC.
    
    Fixes: a49d5e7a89d6 ("soc: mediatek: pm-domains: Add support for mt8192")
    Signed-off-by: Enric Balletbo i Serra <enric.balletbo@collabora.com>
    Reviewed-by: Hsin-Yi Wang <hsinyi@chromium.org>
    Link: https://lore.kernel.org/r/20210225175000.824661-3-enric.balletbo@collabora.com
    Signed-off-by: Matthias Brugger <matthias.bgg@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6129610ebcdb171cae252b1daf2a2d1288d91d4e
Author: Enric Balletbo i Serra <enric.balletbo@collabora.com>
Date:   Thu Feb 25 18:49:58 2021 +0100

    soc: mediatek: pm-domains: Add a power domain names for mt8183
    
    commit e57b8112258ed46dff23b49d6e400f54a8dbf1c3 upstream.
    
    Add the power domains names for the mt8183 SoC. This removes the debugfs
    errors like the following:
    
      debugfs: Directory 'power-domain' with parent 'pm_genpd' already present!
    
    Fixes: eb9fa767fbe1 ("soc: mediatek: pm-domains: Add support for mt8183")
    Signed-off-by: Enric Balletbo i Serra <enric.balletbo@collabora.com>
    Reviewed-by: Hsin-Yi Wang <hsinyi@chromium.org>
    Link: https://lore.kernel.org/r/20210225175000.824661-2-enric.balletbo@collabora.com
    Signed-off-by: Matthias Brugger <matthias.bgg@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 772aae09e118437e73fdbbc9c83cffb20043169d
Author: Enric Balletbo i Serra <enric.balletbo@collabora.com>
Date:   Thu Feb 25 18:49:57 2021 +0100

    soc: mediatek: pm-domains: Add a meaningful power domain name
    
    commit 022b02b4505ecea5eda02b18683531e49f7d8eb7 upstream.
    
    Add the power domains names to the power domain struct so we
    have meaningful name for every power domain. This also removes the
    following debugfs error message.
    
      [    2.242068] debugfs: Directory 'power-domain' with parent 'pm_genpd' already present!
      [    2.249949] debugfs: Directory 'power-domain' with parent 'pm_genpd' already present!
      [    2.257784] debugfs: Directory 'power-domain' with parent 'pm_genpd' already present!
      ...
    
    Fixes: 59b644b01cf4 ("soc: mediatek: Add MediaTek SCPSYS power domains")
    Signed-off-by: Enric Balletbo i Serra <enric.balletbo@collabora.com>
    Reviewed-by: Hsin-Yi Wang <hsinyi@chromium.org>
    Link: https://lore.kernel.org/r/20210225175000.824661-1-enric.balletbo@collabora.com
    Signed-off-by: Matthias Brugger <matthias.bgg@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cafeec02842fbf1995642c97553879accd325b43
Author: Paweł Chmiel <pawel.mikolaj.chmiel@gmail.com>
Date:   Sat Oct 24 17:43:46 2020 +0200

    clk: exynos7: Mark aclk_fsys1_200 as critical
    
    commit 34138a59b92c1a30649a18ec442d2e61f3bc34dd upstream.
    
    This clock must be always enabled to allow access to any registers in
    fsys1 CMU. Until proper solution based on runtime PM is applied
    (similar to what was done for Exynos5433), mark that clock as critical
    so it won't be disabled.
    
    It was observed on Samsung Galaxy S6 device (based on Exynos7420), where
    UFS module is probed before pmic used to power that device.
    In this case defer probe was happening and that clock was disabled by
    UFS driver, causing whole boot to hang on next CMU access.
    
    Fixes: 753195a749a6 ("clk: samsung: exynos7: Correct CMU_FSYS1 clocks names")
    Signed-off-by: Paweł Chmiel <pawel.mikolaj.chmiel@gmail.com>
    Acked-by: Krzysztof Kozlowski <krzk@kernel.org>
    Link: https://lore.kernel.org/linux-clk/20201024154346.9589-1-pawel.mikolaj.chmiel@gmail.com
    [s.nawrocki: Added comment in the code]
    Signed-off-by: Sylwester Nawrocki <s.nawrocki@samsung.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 608441de3976c526b02af4d7063093c8adf351e3
Author: Stéphane Marchesin <marcheu@chromium.org>
Date:   Thu Apr 29 03:10:21 2021 +0000

    drm/i915: Fix crash in auto_retire
    
    commit 402be8a101190969fc7ff122d07e262df86e132b upstream.
    
    The retire logic uses the 2 lower bits of the pointer to the retire
    function to store flags. However, the auto_retire function is not
    guaranteed to be aligned to a multiple of 4, which causes crashes as
    we jump to the wrong address, for example like this:
    
    2021-04-24T18:03:53.804300Z WARNING kernel: [  516.876901] invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
    2021-04-24T18:03:53.804310Z WARNING kernel: [  516.876906] CPU: 7 PID: 146 Comm: kworker/u16:6 Tainted: G     U            5.4.105-13595-g3cd84167b2df #1
    2021-04-24T18:03:53.804311Z WARNING kernel: [  516.876907] Hardware name: Google Volteer2/Volteer2, BIOS Google_Volteer2.13672.76.0 02/22/2021
    2021-04-24T18:03:53.804312Z WARNING kernel: [  516.876911] Workqueue: events_unbound active_work
    2021-04-24T18:03:53.804313Z WARNING kernel: [  516.876914] RIP: 0010:auto_retire+0x1/0x20
    2021-04-24T18:03:53.804314Z WARNING kernel: [  516.876916] Code: e8 01 f2 ff ff eb 02 31 db 48 89 d8 5b 5d c3 0f 1f 44 00 00 55 48 89 e5 f0 ff 87 c8 00 00 00 0f 88 ab 47 4a 00 31 c0 5d c3 0f <1f> 44 00 00 55 48 89 e5 f0 ff 8f c8 00 00 00 0f 88 9a 47 4a 00 74
    2021-04-24T18:03:53.804319Z WARNING kernel: [  516.876918] RSP: 0018:ffff9b4d809fbe38 EFLAGS: 00010286
    2021-04-24T18:03:53.804320Z WARNING kernel: [  516.876919] RAX: 0000000000000007 RBX: ffff927915079600 RCX: 0000000000000007
    2021-04-24T18:03:53.804320Z WARNING kernel: [  516.876921] RDX: ffff9b4d809fbe40 RSI: 0000000000000286 RDI: ffff927915079600
    2021-04-24T18:03:53.804321Z WARNING kernel: [  516.876922] RBP: ffff9b4d809fbe68 R08: 8080808080808080 R09: fefefefefefefeff
    2021-04-24T18:03:53.804321Z WARNING kernel: [  516.876924] R10: 0000000000000010 R11: ffffffff92e44bd8 R12: ffff9279150796a0
    2021-04-24T18:03:53.804322Z WARNING kernel: [  516.876925] R13: ffff92791c368180 R14: ffff927915079640 R15: 000000001c867605
    2021-04-24T18:03:53.804323Z WARNING kernel: [  516.876926] FS:  0000000000000000(0000) GS:ffff92791ffc0000(0000) knlGS:0000000000000000
    2021-04-24T18:03:53.804323Z WARNING kernel: [  516.876928] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    2021-04-24T18:03:53.804324Z WARNING kernel: [  516.876929] CR2: 0000239514955000 CR3: 00000007f82da001 CR4: 0000000000760ee0
    2021-04-24T18:03:53.804325Z WARNING kernel: [  516.876930] PKRU: 55555554
    2021-04-24T18:03:53.804325Z WARNING kernel: [  516.876931] Call Trace:
    2021-04-24T18:03:53.804326Z WARNING kernel: [  516.876935]  __active_retire+0x77/0xcf
    2021-04-24T18:03:53.804326Z WARNING kernel: [  516.876939]  process_one_work+0x1da/0x394
    2021-04-24T18:03:53.804327Z WARNING kernel: [  516.876941]  worker_thread+0x216/0x375
    2021-04-24T18:03:53.804327Z WARNING kernel: [  516.876944]  kthread+0x147/0x156
    2021-04-24T18:03:53.804335Z WARNING kernel: [  516.876946]  ? pr_cont_work+0x58/0x58
    2021-04-24T18:03:53.804335Z WARNING kernel: [  516.876948]  ? kthread_blkcg+0x2e/0x2e
    2021-04-24T18:03:53.804336Z WARNING kernel: [  516.876950]  ret_from_fork+0x1f/0x40
    2021-04-24T18:03:53.804336Z WARNING kernel: [  516.876952] Modules linked in: cdc_mbim cdc_ncm cdc_wdm xt_cgroup rfcomm cmac algif_hash algif_skcipher af_alg xt_MASQUERADE uinput snd_soc_rt5682_sdw snd_soc_rt5682 snd_soc_max98373_sdw snd_soc_max98373 snd_soc_rl6231 regmap_sdw snd_soc_sof_sdw snd_soc_hdac_hdmi snd_soc_dmic snd_hda_codec_hdmi snd_sof_pci snd_sof_intel_hda_common intel_ipu6_psys snd_sof_xtensa_dsp soundwire_intel soundwire_generic_allocation soundwire_cadence snd_sof_intel_hda snd_sof snd_soc_hdac_hda snd_soc_acpi_intel_match snd_soc_acpi snd_hda_ext_core soundwire_bus snd_hda_intel snd_intel_dspcfg snd_hda_codec snd_hwdep snd_hda_core intel_ipu6_isys videobuf2_dma_contig videobuf2_v4l2 videobuf2_common videobuf2_memops mei_hdcp intel_ipu6 ov2740 ov8856 at24 sx9310 dw9768 v4l2_fwnode cros_ec_typec intel_pmc_mux roles acpi_als typec fuse iio_trig_sysfs cros_ec_light_prox cros_ec_lid_angle cros_ec_sensors cros_ec_sensors_core industrialio_triggered_buffer cros_ec_sensors_ring kfifo_buf industrialio cros_ec_sensorhub
    2021-04-24T18:03:53.804337Z WARNING kernel: [  516.876972]  cdc_ether usbnet iwlmvm lzo_rle lzo_compress iwl7000_mac80211 iwlwifi zram cfg80211 r8152 mii btusb btrtl btintel btbcm bluetooth ecdh_generic ecc joydev
    2021-04-24T18:03:53.804337Z EMERG kernel: [  516.879169] gsmi: Log Shutdown Reason 0x03
    
    This change fixes this by aligning the function.
    
    Signed-off-by: Stéphane Marchesin <marcheu@chromium.org>
    Fixes: 229007e02d69 ("drm/i915: Wrap i915_active in a simple kreffed struct")
    Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
    Link: https://patchwork.freedesktop.org/patch/msgid/20210429031021.1218091-1-marcheu@chromium.org
    (cherry picked from commit ca419f407b43cc89942ebc297c7a63d94abbcae4)
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b742725518fe5868e7b66c926bbd899924e0be9e
Author: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Date:   Thu Apr 29 09:35:29 2021 +0100

    drm/i915/overlay: Fix active retire callback alignment
    
    commit a915fe5e9601c632417ef5261af70788d7d23a8a upstream.
    
    __i915_active_call annotation is required on the retire callback to ensure
    correct function alignment.
    
    Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
    Fixes: a21ce8ad12d2 ("drm/i915/overlay: Switch to using i915_active tracking")
    Cc: Chris Wilson <chris@chris-wilson.co.uk>
    Cc: Matthew Auld <matthew.auld@intel.com>
    Reviewed-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
    Link: https://patchwork.freedesktop.org/patch/msgid/20210429083530.849546-1-tvrtko.ursulin@linux.intel.com
    (cherry picked from commit d8e44e4dd221ee283ea60a6fb87bca08807aa0ab)
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 85b00ca51f638067151051efc5b1c94a7c2497c7
Author: Ville Syrjälä <ville.syrjala@linux.intel.com>
Date:   Wed Apr 21 18:33:59 2021 +0300

    drm/i915: Read C0DRB3/C1DRB3 as 16 bits again
    
    commit 04d019961fd15de92874575536310243a0d4c5c5 upstream.
    
    We've defined C0DRB3/C1DRB3 as 16 bit registers, so access them
    as such.
    
    Fixes: 1c8242c3a4b2 ("drm/i915: Use unchecked writes for setting up the fences")
    Reviewed-by: Chris Wilson <chris@chris-wilson.co.uk>
    Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
    Link: https://patchwork.freedesktop.org/patch/msgid/20210421153401.13847-3-ville.syrjala@linux.intel.com
    (cherry picked from commit f765a5b48c667bdada5e49d5e0f23f8c0687b21b)
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5c5b4880fe393031c82b86c37872eeee1adebeac
Author: Kuogee Hsieh <khsieh@codeaurora.org>
Date:   Wed Apr 21 16:37:35 2021 -0700

    drm/msm/dp: check sink_count before update is_connected status
    
    commit d9aa6571b28ba0022de1e48801ff03a1854c7ef2 upstream.
    
    Link status is different from display connected status in the case
    of something like an Apple dongle where the type-c plug can be
    connected, and therefore the link is connected, but no sink is
    connected until an HDMI cable is plugged into the dongle.
    The sink_count of DPCD of dongle will increase to 1 once an HDMI
    cable is plugged into the dongle so that display connected status
    will become true. This checking also apply at pm_resume.
    
    Changes in v4:
    -- none
    
    Fixes: 94e58e2d06e3 ("drm/msm/dp: reset dp controller only at boot up and pm_resume")
    Reported-by: Stephen Boyd <swboyd@chromium.org>
    Reviewed-by: Stephen Boyd <swboyd@chromium.org>
    Tested-by: Stephen Boyd <swboyd@chromium.org>
    Signed-off-by: Kuogee Hsieh <khsieh@codeaurora.org>
    Fixes: 8ede2ecc3e5e ("drm/msm/dp: Add DP compliance tests on Snapdragon Chipsets")
    Link: https://lore.kernel.org/r/1619048258-8717-2-git-send-email-khsieh@codeaurora.org
    Signed-off-by: Rob Clark <robdclark@chromium.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7cd242ee933827b85bdab8516a5988b7a07c0121
Author: Lv Yunlong <lyl2019@mail.ustc.edu.cn>
Date:   Mon Apr 26 05:43:40 2021 -0700

    drm/i915/gt: Fix a double free in gen8_preallocate_top_level_pdp
    
    commit ea995218dddba171fecd05496c69617c5ef3c5b8 upstream.
    
    Our code analyzer reported a double free bug.
    
    In gen8_preallocate_top_level_pdp, pde and pde->pt.base are allocated
    via alloc_pd(vm) with one reference. If pin_pt_dma() failed, pde->pt.base
    is freed by i915_gem_object_put() with a reference dropped. Then free_pd
    calls free_px() defined in intel_ppgtt.c, which calls i915_gem_object_put()
    to put pde->pt.base again.
    
    As pde->pt.base is protected by refcount, so the second put will not free
    pde->pt.base actually. But, maybe it is better to remove the first put?
    
    Fixes: 82adf901138cc ("drm/i915/gt: Shrink i915_page_directory's slab bucket")
    Signed-off-by: Lv Yunlong <lyl2019@mail.ustc.edu.cn>
    Reviewed-by: Matthew Auld <matthew.auld@intel.com>
    Signed-off-by: Matthew Auld <matthew.auld@intel.com>
    Link: https://patchwork.freedesktop.org/patch/msgid/20210426124340.4238-1-lyl2019@mail.ustc.edu.cn
    (cherry picked from commit ac69496fe65cca0611d5917b7d232730ff605bc7)
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3a14134636da65534770f968be5cad4ff3ceb5eb
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Mon Apr 5 11:48:52 2021 +0200

    kobject_uevent: remove warning in init_uevent_argv()
    
    commit b4104180a2efb85f55e1ba1407885c9421970338 upstream.
    
    syzbot can trigger the WARN() in init_uevent_argv() which isn't the
    nicest as the code does properly recover and handle the error.  So
    change the WARN() call to pr_warn() and provide some more information on
    what the buffer size that was needed.
    
    Link: https://lore.kernel.org/r/20201107082206.GA19079@kroah.com
    Cc: "Rafael J. Wysocki" <rafael@kernel.org>
    Cc: linux-kernel@vger.kernel.org
    Reported-by: syzbot+92340f7b2b4789907fdb@syzkaller.appspotmail.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Link: https://lore.kernel.org/r/20210405094852.1348499-1-gregkh@linuxfoundation.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7c019a7f2a01855e77b2c026fc3b4418f79d6084
Author: Badhri Jagan Sridharan <badhri@google.com>
Date:   Wed Apr 14 22:01:21 2021 -0700

    usb: typec: tcpm: Fix error while calculating PPS out values
    
    commit 374157ff88ae1a7f7927331cbc72c1ec11994e8a upstream.
    
    "usb: typec: tcpm: Address incorrect values of tcpm psy for pps supply"
    introduced a regression for req_out_volt and req_op_curr calculation.
    
    req_out_volt should consider the newly calculated max voltage instead
    of previously accepted max voltage by the port partner. Likewise,
    req_op_curr should consider the newly calculated max current instead
    of previously accepted max current by the port partner.
    
    Fixes: e3a072022487 ("usb: typec: tcpm: Address incorrect values of tcpm psy for pps supply")
    Reviewed-by: Guenter Roeck <linux@roeck-us.net>
    Signed-off-by: Badhri Jagan Sridharan <badhri@google.com>
    Link: https://lore.kernel.org/r/20210415050121.1928298-1-badhri@google.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 67c080e011c4026a8becf3cdab29d4e1169b4634
Author: Tony Lindgren <tony@atomide.com>
Date:   Tue Mar 23 09:43:26 2021 +0200

    clocksource/drivers/timer-ti-dm: Handle dra7 timer wrap errata i940
    
    commit 25de4ce5ed02994aea8bc111d133308f6fd62566 upstream.
    
    There is a timer wrap issue on dra7 for the ARM architected timer.
    In a typical clock configuration the timer fails to wrap after 388 days.
    
    To work around the issue, we need to use timer-ti-dm percpu timers instead.
    
    Let's configure dmtimer3 and 4 as percpu timers by default, and warn about
    the issue if the dtb is not configured properly.
    
    Let's do this as a single patch so it can be backported to v5.8 and later
    kernels easily. Note that this patch depends on earlier timer-ti-dm
    systimer posted mode fixes, and a preparatory clockevent patch
    "clocksource/drivers/timer-ti-dm: Prepare to handle dra7 timer wrap issue".
    
    For more information, please see the errata for "AM572x Sitara Processors
    Silicon Revisions 1.1, 2.0":
    
    https://www.ti.com/lit/er/sprz429m/sprz429m.pdf
    
    The concept is based on earlier reference patches done by Tero Kristo and
    Keerthy.
    
    Cc: Keerthy <j-keerthy@ti.com>
    Cc: Tero Kristo <kristo@kernel.org>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Daniel Lezcano <daniel.lezcano@linaro.org>
    Link: https://lore.kernel.org/r/20210323074326.28302-3-tony@atomide.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d4a976a27a48343e691135aad74cb7bde2cf0ddf
Author: Tony Lindgren <tony@atomide.com>
Date:   Tue Mar 23 09:43:25 2021 +0200

    clocksource/drivers/timer-ti-dm: Prepare to handle dra7 timer wrap issue
    
    commit 3efe7a878a11c13b5297057bfc1e5639ce1241ce upstream.
    
    There is a timer wrap issue on dra7 for the ARM architected timer.
    In a typical clock configuration the timer fails to wrap after 388 days.
    
    To work around the issue, we need to use timer-ti-dm timers instead.
    
    Let's prepare for adding support for percpu timers by adding a common
    dmtimer_clkevt_init_common() and call it from dmtimer_clockevent_init().
    This patch makes no intentional functional changes.
    
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Daniel Lezcano <daniel.lezcano@linaro.org>
    Link: https://lore.kernel.org/r/20210323074326.28302-2-tony@atomide.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6470518351f49f55a7c5919934c7163b6ab47b83
Author: Maciej W. Rozycki <macro@orcam.me.uk>
Date:   Thu Apr 22 22:36:12 2021 +0200

    MIPS: Avoid handcoded DIVU in `__div64_32' altogether
    
    commit 25ab14cbe9d1b66fda44c71a2db7582a31b6f5cd upstream.
    
    Remove the inline asm with a DIVU instruction from `__div64_32' and use
    plain C code for the intended DIVMOD calculation instead.  GCC is smart
    enough to know that both the quotient and the remainder are calculated
    with single DIVU, so with ISAs up to R5 the same instruction is actually
    produced with overall similar code.
    
    For R6 compiled code will work, but separate DIVU and MODU instructions
    will be produced, which are also interlocked, so scalar implementations
    will likely not perform as well as older ISAs with their asynchronous MD
    unit.  Likely still faster then the generic algorithm though.
    
    This removes a compilation error for R6 however where the original DIVU
    instruction is not supported anymore and the MDU accumulator registers
    have been removed and consequently GCC complains as to a constraint it
    cannot find a register for:
    
    In file included from ./include/linux/math.h:5,
                     from ./include/linux/kernel.h:13,
                     from mm/page-writeback.c:15:
    ./include/linux/math64.h: In function 'div_u64_rem':
    ./arch/mips/include/asm/div64.h:76:17: error: inconsistent operand constraints in an 'asm'
       76 |                 __asm__("divu   $0, %z1, %z2"                           \
          |                 ^~~~~~~
    ./include/asm-generic/div64.h:245:25: note: in expansion of macro '__div64_32'
      245 |                 __rem = __div64_32(&(n), __base);       \
          |                         ^~~~~~~~~~
    ./include/linux/math64.h:91:22: note: in expansion of macro 'do_div'
       91 |         *remainder = do_div(dividend, divisor);
          |                      ^~~~~~
    
    This has passed correctness verification with test_div64 and reduced the
    module's average execution time down to 1.0404s from 1.0445s with R3400
    @40MHz.  The module's MIPS I machine code has also shrunk by 12 bytes or
    3 instructions.
    
    Signed-off-by: Maciej W. Rozycki <macro@orcam.me.uk>
    Signed-off-by: Thomas Bogendoerfer <tsbogend@alpha.franken.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cd45216aa90b823a7bb98732a622c344c282aadc
Author: Maciej W. Rozycki <macro@orcam.me.uk>
Date:   Tue Apr 20 04:50:48 2021 +0200

    MIPS: Avoid DIVU in `__div64_32' is result would be zero
    
    commit c1d337d45ec0a802299688e17d568c4e3a585895 upstream.
    
    We already check the high part of the divident against zero to avoid the
    costly DIVU instruction in that case, needed to reduce the high part of
    the divident, so we may well check against the divisor instead and set
    the high part of the quotient to zero right away.  We need to treat the
    high part the divident in that case though as the remainder that would
    be calculated by the DIVU instruction we avoided.
    
    This has passed correctness verification with test_div64 and reduced the
    module's average execution time down to 1.0445s and 0.2619s from 1.0668s
    and 0.2629s respectively for an R3400 CPU @40MHz and a 5Kc CPU @160MHz.
    
    Signed-off-by: Maciej W. Rozycki <macro@orcam.me.uk>
    Signed-off-by: Thomas Bogendoerfer <tsbogend@alpha.franken.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 93d5be9a64b9d9bac3d92986b62db8c14479feac
Author: Maciej W. Rozycki <macro@orcam.me.uk>
Date:   Tue Apr 20 04:50:40 2021 +0200

    MIPS: Reinstate platform `__div64_32' handler
    
    commit c49f71f60754acbff37505e1d16ca796bf8a8140 upstream.
    
    Our current MIPS platform `__div64_32' handler is inactive, because it
    is incorrectly only enabled for 64-bit configurations, for which generic
    `do_div' code does not call it anyway.
    
    The handler is not suitable for being called from there though as it
    only calculates 32 bits of the quotient under the assumption the 64-bit
    divident has been suitably reduced.  Code for such reduction used to be
    there, however it has been incorrectly removed with commit c21004cd5b4c
    ("MIPS: Rewrite <asm/div64.h> to work with gcc 4.4.0."), which should
    have only updated an obsoleted constraint for an inline asm involving
    $hi and $lo register outputs, while possibly wiring the original MIPS
    variant of the `do_div' macro as `__div64_32' handler for the generic
    `do_div' implementation
    
    Correct the handler as follows then:
    
    - Revert most of the commit referred, however retaining the current
      formatting, except for the final two instructions of the inline asm
      sequence, which the original commit missed.  Omit the original 64-bit
      parts though.
    
    - Rename the original `do_div' macro to `__div64_32'.  Use the combined
      `x' constraint referring to the MD accumulator as a whole, replacing
      the original individual `h' and `l' constraints used for $hi and $lo
      registers respectively, of which `h' has been obsoleted with GCC 4.4.
      Update surrounding code accordingly.
    
      We have since removed support for GCC versions before 4.9, so no need
      for a special arrangement here; GCC has supported the `x' constraint
      since forever anyway, or at least going back to 1991.
    
    - Rename the `__base' local variable in `__div64_32' to `__radix' to
      avoid a conflict with a local variable in `do_div'.
    
    - Actually enable this code for 32-bit rather than 64-bit configurations
      by qualifying it with BITS_PER_LONG being 32 instead of 64.  Include
      <asm/bitsperlong.h> for this macro rather than <linux/types.h> as we
      don't need anything else.
    
    - Finally include <asm-generic/div64.h> last rather than first.
    
    This has passed correctness verification with test_div64 and reduced the
    module's average execution time down to 1.0668s and 0.2629s from 2.1529s
    and 0.5647s respectively for an R3400 CPU @40MHz and a 5Kc CPU @160MHz.
    For a reference 64-bit `do_div' code where we have the DDIVU instruction
    available to do the whole calculation right away averages at 0.0660s for
    the latter CPU.
    
    Fixes: c21004cd5b4c ("MIPS: Rewrite <asm/div64.h> to work with gcc 4.4.0.")
    Reported-by: Huacai Chen <chenhuacai@kernel.org>
    Signed-off-by: Maciej W. Rozycki <macro@orcam.me.uk>
    Cc: stable@vger.kernel.org # v2.6.30+
    Signed-off-by: Thomas Bogendoerfer <tsbogend@alpha.franken.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 49e8be2b17e76afd71e0f32cee86b48c24cc4e44
Author: Matthew Wilcox (Oracle) <willy@infradead.org>
Date:   Fri May 14 17:27:24 2021 -0700

    mm: fix struct page layout on 32-bit systems
    
    commit 9ddb3c14afba8bc5950ed297f02d4ae05ff35cd1 upstream.
    
    32-bit architectures which expect 8-byte alignment for 8-byte integers and
    need 64-bit DMA addresses (arm, mips, ppc) had their struct page
    inadvertently expanded in 2019.  When the dma_addr_t was added, it forced
    the alignment of the union to 8 bytes, which inserted a 4 byte gap between
    'flags' and the union.
    
    Fix this by storing the dma_addr_t in one or two adjacent unsigned longs.
    This restores the alignment to that of an unsigned long.  We always
    store the low bits in the first word to prevent the PageTail bit from
    being inadvertently set on a big endian platform.  If that happened,
    get_user_pages_fast() racing against a page which was freed and
    reallocated to the page_pool could dereference a bogus compound_head(),
    which would be hard to trace back to this cause.
    
    Link: https://lkml.kernel.org/r/20210510153211.1504886-1-willy@infradead.org
    Fixes: c25fff7171be ("mm: add dma_addr_t to struct page")
    Signed-off-by: Matthew Wilcox (Oracle) <willy@infradead.org>
    Acked-by: Ilias Apalodimas <ilias.apalodimas@linaro.org>
    Acked-by: Jesper Dangaard Brouer <brouer@redhat.com>
    Acked-by: Vlastimil Babka <vbabka@suse.cz>
    Tested-by: Matteo Croce <mcroce@linux.microsoft.com>
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5adcdeb57007ccf8ab7ac20bf787ffb6fafb1a94
Author: Sean Christopherson <seanjc@google.com>
Date:   Tue May 4 10:17:24 2021 -0700

    KVM: VMX: Disable preemption when probing user return MSRs
    
    commit 5104d7ffcf24749939bea7fdb5378d186473f890 upstream.
    
    Disable preemption when probing a user return MSR via RDSMR/WRMSR.  If
    the MSR holds a different value per logical CPU, the WRMSR could corrupt
    the host's value if KVM is preempted between the RDMSR and WRMSR, and
    then rescheduled on a different CPU.
    
    Opportunistically land the helper in common x86, SVM will use the helper
    in a future commit.
    
    Fixes: 4be534102624 ("KVM: VMX: Initialize vmx->guest_msrs[] right after allocation")
    Cc: stable@vger.kernel.org
    Cc: Xiaoyao Li <xiaoyao.li@intel.com>
    Signed-off-by: Sean Christopherson <seanjc@google.com>
    Message-Id: <20210504171734.1434054-6-seanjc@google.com>
    Reviewed-by: Jim Mattson <jmattson@google.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 83c9e4a5b7023224a9d5e774bd2338384cfe2700
Author: Sean Christopherson <seanjc@google.com>
Date:   Tue May 4 10:17:20 2021 -0700

    KVM: VMX: Do not advertise RDPID if ENABLE_RDTSCP control is unsupported
    
    commit 8aec21c04caa2000f91cf8822ae0811e4b0c3971 upstream.
    
    Clear KVM's RDPID capability if the ENABLE_RDTSCP secondary exec control is
    unsupported.  Despite being enumerated in a separate CPUID flag, RDPID is
    bundled under the same VMCS control as RDTSCP and will #UD in VMX non-root
    if ENABLE_RDTSCP is not enabled.
    
    Fixes: 41cd02c6f7f6 ("kvm: x86: Expose RDPID in KVM_GET_SUPPORTED_CPUID")
    Cc: stable@vger.kernel.org
    Signed-off-by: Sean Christopherson <seanjc@google.com>
    Message-Id: <20210504171734.1434054-2-seanjc@google.com>
    Reviewed-by: Jim Mattson <jmattson@google.com>
    Reviewed-by: Reiji Watanabe <reijiw@google.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 200a45649ab7361bc80c70aebf7165b64f9a6c9f
Author: Vitaly Kuznetsov <vkuznets@redhat.com>
Date:   Mon May 3 17:08:51 2021 +0200

    KVM: nVMX: Always make an attempt to map eVMCS after migration
    
    commit f5c7e8425f18fdb9bdb7d13340651d7876890329 upstream.
    
    When enlightened VMCS is in use and nested state is migrated with
    vmx_get_nested_state()/vmx_set_nested_state() KVM can't map evmcs
    page right away: evmcs gpa is not 'struct kvm_vmx_nested_state_hdr'
    and we can't read it from VP assist page because userspace may decide
    to restore HV_X64_MSR_VP_ASSIST_PAGE after restoring nested state
    (and QEMU, for example, does exactly that). To make sure eVMCS is
    mapped /vmx_set_nested_state() raises KVM_REQ_GET_NESTED_STATE_PAGES
    request.
    
    Commit f2c7ef3ba955 ("KVM: nSVM: cancel KVM_REQ_GET_NESTED_STATE_PAGES
    on nested vmexit") added KVM_REQ_GET_NESTED_STATE_PAGES clearing to
    nested_vmx_vmexit() to make sure MSR permission bitmap is not switched
    when an immediate exit from L2 to L1 happens right after migration (caused
    by a pending event, for example). Unfortunately, in the exact same
    situation we still need to have eVMCS mapped so
    nested_sync_vmcs12_to_shadow() reflects changes in VMCS12 to eVMCS.
    
    As a band-aid, restore nested_get_evmcs_page() when clearing
    KVM_REQ_GET_NESTED_STATE_PAGES in nested_vmx_vmexit(). The 'fix' is far
    from being ideal as we can't easily propagate possible failures and even if
    we could, this is most likely already too late to do so. The whole
    'KVM_REQ_GET_NESTED_STATE_PAGES' idea for mapping eVMCS after migration
    seems to be fragile as we diverge too much from the 'native' path when
    vmptr loading happens on vmx_set_nested_state().
    
    Fixes: f2c7ef3ba955 ("KVM: nSVM: cancel KVM_REQ_GET_NESTED_STATE_PAGES on nested vmexit")
    Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
    Message-Id: <20210503150854.1144255-2-vkuznets@redhat.com>
    Cc: stable@vger.kernel.org
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ff4a50a455ecd99c1890a5a35e19c276a271adbf
Author: Sean Christopherson <seanjc@google.com>
Date:   Tue May 4 10:17:23 2021 -0700

    KVM: x86: Move RDPID emulation intercept to its own enum
    
    commit 2183de4161b90bd3851ccd3910c87b2c9adfc6ed upstream.
    
    Add a dedicated intercept enum for RDPID instead of piggybacking RDTSCP.
    Unlike VMX's ENABLE_RDTSCP, RDPID is not bound to SVM's RDTSCP intercept.
    
    Fixes: fb6d4d340e05 ("KVM: x86: emulate RDPID")
    Cc: stable@vger.kernel.org
    Signed-off-by: Sean Christopherson <seanjc@google.com>
    Message-Id: <20210504171734.1434054-5-seanjc@google.com>
    Reviewed-by: Jim Mattson <jmattson@google.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5fc7a3a1e9d3dbdaec6685a5d89d5f16a9b9cfcc
Author: Sean Christopherson <seanjc@google.com>
Date:   Tue May 4 10:17:21 2021 -0700

    KVM: x86: Emulate RDPID only if RDTSCP is supported
    
    commit 85d0011264da24be08ae907d7f29983a597ca9b1 upstream.
    
    Do not advertise emulation support for RDPID if RDTSCP is unsupported.
    RDPID emulation subtly relies on MSR_TSC_AUX to exist in hardware, as
    both vmx_get_msr() and svm_get_msr() will return an error if the MSR is
    unsupported, i.e. ctxt->ops->get_msr() will fail and the emulator will
    inject a #UD.
    
    Note, RDPID emulation also relies on RDTSCP being enabled in the guest,
    but this is a KVM bug and will eventually be fixed.
    
    Fixes: fb6d4d340e05 ("KVM: x86: emulate RDPID")
    Cc: stable@vger.kernel.org
    Signed-off-by: Sean Christopherson <seanjc@google.com>
    Message-Id: <20210504171734.1434054-3-seanjc@google.com>
    Reviewed-by: Jim Mattson <jmattson@google.com>
    Reviewed-by: Reiji Watanabe <reijiw@google.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 323cda5fff437ecc37f353f36c85863253480a83
Author: Juergen Gross <jgross@suse.com>
Date:   Fri Apr 23 07:40:38 2021 +0200

    xen/gntdev: fix gntdev_mmap() error exit path
    
    commit 970655aa9b42461f8394e4457307005bdeee14d9 upstream.
    
    Commit d3eeb1d77c5d0af ("xen/gntdev: use mmu_interval_notifier_insert")
    introduced an error in gntdev_mmap(): in case the call of
    mmu_interval_notifier_insert_locked() fails the exit path should not
    call mmu_interval_notifier_remove(), as this might result in NULL
    dereferences.
    
    One reason for failure is e.g. a signal pending for the running
    process.
    
    Fixes: d3eeb1d77c5d0af ("xen/gntdev: use mmu_interval_notifier_insert")
    Cc: stable@vger.kernel.org
    Reported-by: Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com>
    Tested-by: Marek Marczykowski-Górecki <marmarek@invisiblethingslab.com>
    Signed-off-by: Juergen Gross <jgross@suse.com>
    Reviewed-by: Luca Fancellu <luca.fancellu@arm.com>
    Link: https://lore.kernel.org/r/20210423054038.26696-1-jgross@suse.com
    Signed-off-by: Juergen Gross <jgross@suse.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9984778818e8cad44c835a1ebd68c39252a182ce
Author: Oliver Neukum <oneukum@suse.com>
Date:   Mon Apr 26 11:26:22 2021 +0200

    cdc-wdm: untangle a circular dependency between callback and softint
    
    commit 18abf874367456540846319574864e6ff32752e2 upstream.
    
    We have a cycle of callbacks scheduling works which submit
    URBs with those callbacks. This needs to be blocked, stopped
    and unblocked to untangle the circle.
    
    Signed-off-by: Oliver Neukum <oneukum@suse.com>
    Link: https://lore.kernel.org/r/20210426092622.20433-1-oneukum@suse.com
    Cc: stable <stable@vger.kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f57a08ed6d0513ef943486750733c66c416f6203
Author: Colin Ian King <colin.king@canonical.com>
Date:   Fri May 7 19:30:41 2021 +0100

    iio: tsl2583: Fix division by a zero lux_val
    
    commit af0e1871d79cfbb91f732d2c6fa7558e45c31038 upstream.
    
    The lux_val returned from tsl2583_get_lux can potentially be zero,
    so check for this to avoid a division by zero and an overflowed
    gain_trim_val.
    
    Fixes clang scan-build warning:
    
    drivers/iio/light/tsl2583.c:345:40: warning: Either the
    condition 'lux_val<0' is redundant or there is division
    by zero at line 345. [zerodivcond]
    
    Fixes: ac4f6eee8fe8 ("staging: iio: TAOS tsl258x: Device driver")
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Cc: <Stable@vger.kernel.org>
    Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 661e4e1ba1fc3fe5cce183ff44b7ef565f25b6b2
Author: Dmitry Osipenko <digetx@gmail.com>
Date:   Fri Apr 23 05:09:59 2021 +0300

    iio: gyro: mpu3050: Fix reported temperature value
    
    commit f73c730774d88a14d7b60feee6d0e13570f99499 upstream.
    
    The raw temperature value is a 16-bit signed integer. The sign casting
    is missing in the code, which results in a wrong temperature reported
    by userspace tools, fix it.
    
    Cc: stable@vger.kernel.org
    Fixes: 3904b28efb2c ("iio: gyro: Add driver for the MPU-3050 gyroscope")
    Datasheet: https://www.cdiweb.com/datasheets/invensense/mpu-3000a.pdf
    Tested-by: Maxim Schwalm <maxim.schwalm@gmail.com> # Asus TF700T
    Tested-by: Svyatoslav Ryhel <clamor95@gmail.com> # Asus TF201
    Reported-by: Svyatoslav Ryhel <clamor95@gmail.com>
    Reviewed-by: Andy Shevchenko <Andy.Shevchenko@gmail.com>
    Reviewed-by: Linus Walleij <linus.walleij@linaro.org>
    Signed-off-by: Dmitry Osipenko <digetx@gmail.com>
    Acked-by: Jean-Baptiste Maneyrol <jmaneyrol@invensense.com>
    Link: https://lore.kernel.org/r/20210423020959.5023-1-digetx@gmail.com
    Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 11e1cae5da4096552f7c091476cbadbc0d1817da
Author: Tomasz Duszynski <tomasz.duszynski@octakon.com>
Date:   Fri Apr 23 10:02:44 2021 +0200

    iio: core: fix ioctl handlers removal
    
    commit 901f84de0e16bde10a72d7eb2f2eb73fcde8fa1a upstream.
    
    Currently ioctl handlers are removed twice. For the first time during
    iio_device_unregister() then later on inside
    iio_device_unregister_eventset() and iio_buffers_free_sysfs_and_mask().
    Double free leads to kernel panic.
    
    Fix this by not touching ioctl handlers list directly but rather
    letting code responsible for registration call the matching cleanup
    routine itself.
    
    Fixes: 8dedcc3eee3ac ("iio: core: centralize ioctl() calls to the main chardev")
    Signed-off-by: Tomasz Duszynski <tomasz.duszynski@octakon.com>
    Acked-by: Alexandru Ardelean <ardeleanalex@gmail.com>
    Cc: <Stable@vger.kernel.org>
    Link: https://lore.kernel.org/r/20210423080244.2790-1-tomasz.duszynski@octakon.com
    Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4f33f7b3210fdcd3117e3ef23f32ce5e5d319b66
Author: Sandeep Singh <sandeep.singh@amd.com>
Date:   Wed May 12 11:08:16 2021 +0300

    xhci: Add reset resume quirk for AMD xhci controller.
    
    commit 3c128781d8da463761495aaf8898c9ecb4e71528 upstream.
    
    One of AMD xhci controller require reset on resume.
    Occasionally AMD xhci controller does not respond to
    Stop endpoint command.
    Once the issue happens controller goes into bad state
    and in that case controller needs to be reset.
    
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Sandeep Singh <sandeep.singh@amd.com>
    Signed-off-by: Mathias Nyman <mathias.nyman@linux.intel.com>
    Link: https://lore.kernel.org/r/20210512080816.866037-6-mathias.nyman@linux.intel.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 13c2ffc27a20e059de6b7fa56ab600f9bcce0826
Author: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
Date:   Wed May 12 11:08:14 2021 +0300

    xhci: Do not use GFP_KERNEL in (potentially) atomic context
    
    commit dda32c00c9a0fa103b5d54ef72c477b7aa993679 upstream.
    
    'xhci_urb_enqueue()' is passed a 'mem_flags' argument, because "URBs may be
    submitted in interrupt context" (see comment related to 'usb_submit_urb()'
    in 'drivers/usb/core/urb.c')
    
    So this flag should be used in all the calling chain.
    Up to now, 'xhci_check_maxpacket()' which is only called from
    'xhci_urb_enqueue()', uses GFP_KERNEL.
    
    Be safe and pass the mem_flags to this function as well.
    
    Fixes: ddba5cd0aeff ("xhci: Use command structures when queuing commands on the command ring")
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
    Signed-off-by: Mathias Nyman <mathias.nyman@linux.intel.com>
    Link: https://lore.kernel.org/r/20210512080816.866037-4-mathias.nyman@linux.intel.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d6320af7bf1edad6cc228da07acfe82c41482843
Author: Abhijeet Rao <abhijeet.rao@intel.com>
Date:   Wed May 12 11:08:12 2021 +0300

    xhci-pci: Allow host runtime PM as default for Intel Alder Lake xHCI
    
    commit b813511135e8b84fa741afdfbab4937919100bef upstream.
    
    In the same way as Intel Tiger Lake TCSS (Type-C Subsystem) the Alder Lake
    TCSS xHCI needs to be runtime suspended whenever possible to allow the
    TCSS hardware block to enter D3cold and thus save energy.
    
    Cc: stable@vger.kernel.org
    Signed-off-by: Abhijeet Rao <abhijeet.rao@intel.com>
    Signed-off-by: Nikunj A. Dadhania <nikunj.dadhania@intel.com>
    Signed-off-by: Azhar Shaikh <azhar.shaikh@intel.com>
    Signed-off-by: Mathias Nyman <mathias.nyman@linux.intel.com>
    Link: https://lore.kernel.org/r/20210512080816.866037-2-mathias.nyman@linux.intel.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ee0e8fdb9061e67a1dce6819072fa158618fc294
Author: Andy Shevchenko <andy.shevchenko@gmail.com>
Date:   Wed May 5 01:23:37 2021 +0300

    usb: typec: ucsi: Put fwnode in any case during ->probe()
    
    commit b9a0866a5bdf6a4643a52872ada6be6184c6f4f2 upstream.
    
    device_for_each_child_node() bumps a reference counting of a returned variable.
    We have to balance it whenever we return to the caller.
    
    Fixes: c1b0bc2dabfa ("usb: typec: Add support for UCSI interface")
    Cc: Heikki Krogerus <heikki.krogerus@linux.intel.com>
    Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
    Signed-off-by: Andy Shevchenko <andy.shevchenko@gmail.com>
    Link: https://lore.kernel.org/r/20210504222337.3151726-1-andy.shevchenko@gmail.com
    Cc: stable <stable@vger.kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a453bfd7ef15fd9d524004d3ca7b05353a302911
Author: Jack Pham <jackp@codeaurora.org>
Date:   Mon May 3 00:46:11 2021 -0700

    usb: typec: ucsi: Retrieve all the PDOs instead of just the first 4
    
    commit 1f4642b72be79757f050924a9b9673b6a02034bc upstream.
    
    commit 4dbc6a4ef06d ("usb: typec: ucsi: save power data objects
    in PD mode") introduced retrieval of the PDOs when connected to a
    PD-capable source. But only the first 4 PDOs are received since
    that is the maximum number that can be fetched at a time given the
    MESSAGE_IN length limitation (16 bytes). However, as per the PD spec
    a connected source may advertise up to a maximum of 7 PDOs.
    
    If such a source is connected it's possible the PPM could have
    negotiated a power contract with one of the PDOs at index greater
    than 4, and would be reflected in the request data object's (RDO)
    object position field. This would result in an out-of-bounds access
    when the rdo_index() is used to index into the src_pdos array in
    ucsi_psy_get_voltage_now().
    
    With the help of the UBSAN -fsanitize=array-bounds checker enabled
    this exact issue is revealed when connecting to a PD source adapter
    that advertise 5 PDOs and the PPM enters a contract having selected
    the 5th one.
    
    [  151.545106][   T70] Unexpected kernel BRK exception at EL1
    [  151.545112][   T70] Internal error: BRK handler: f2005512 [#1] PREEMPT SMP
    ...
    [  151.545499][   T70] pc : ucsi_psy_get_prop+0x208/0x20c
    [  151.545507][   T70] lr : power_supply_show_property+0xc0/0x328
    ...
    [  151.545542][   T70] Call trace:
    [  151.545544][   T70]  ucsi_psy_get_prop+0x208/0x20c
    [  151.545546][   T70]  power_supply_uevent+0x1a4/0x2f0
    [  151.545550][   T70]  dev_uevent+0x200/0x384
    [  151.545555][   T70]  kobject_uevent_env+0x1d4/0x7e8
    [  151.545557][   T70]  power_supply_changed_work+0x174/0x31c
    [  151.545562][   T70]  process_one_work+0x244/0x6f0
    [  151.545564][   T70]  worker_thread+0x3e0/0xa64
    
    We can resolve this by instead retrieving and storing up to the
    maximum of 7 PDOs in the con->src_pdos array. This would involve
    two calls to the GET_PDOS command.
    
    Fixes: 992a60ed0d5e ("usb: typec: ucsi: register with power_supply class")
    Fixes: 4dbc6a4ef06d ("usb: typec: ucsi: save power data objects in PD mode")
    Cc: stable@vger.kernel.org
    Reported-and-tested-by: Subbaraman Narayanamurthy <subbaram@codeaurora.org>
    Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
    Signed-off-by: Jack Pham <jackp@codeaurora.org>
    Link: https://lore.kernel.org/r/20210503074611.30973-1-jackp@codeaurora.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 19e7bf52c7fee140a5d91808c77b5271cdcb1d0d
Author: Wesley Cheng <wcheng@codeaurora.org>
Date:   Fri May 7 10:55:19 2021 -0700

    usb: dwc3: gadget: Return success always for kick transfer in ep queue
    
    commit 18ffa988dbae69cc6e9949cddd9606f6fe533894 upstream.
    
    If an error is received when issuing a start or update transfer
    command, the error handler will stop all active requests (including
    the current USB request), and call dwc3_gadget_giveback() to notify
    function drivers of the requests which have been stopped.  Avoid
    returning an error for kick transfer during EP queue, to remove
    duplicate cleanup operations on the request being queued.
    
    Fixes: 8d99087c2db8 ("usb: dwc3: gadget: Properly handle failed kick_transfer")
    cc: stable@vger.kernel.org
    Signed-off-by: Wesley Cheng <wcheng@codeaurora.org>
    Link: https://lore.kernel.org/r/1620410119-24971-1-git-send-email-wcheng@codeaurora.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 56245530f2746958e52e2b7f637d42723fbf5446
Author: Jack Pham <jackp@codeaurora.org>
Date:   Wed Apr 28 02:01:10 2021 -0700

    usb: dwc3: gadget: Enable suspend events
    
    commit d1d90dd27254c44d087ad3f8b5b3e4fff0571f45 upstream.
    
    commit 72704f876f50 ("dwc3: gadget: Implement the suspend entry event
    handler") introduced (nearly 5 years ago!) an interrupt handler for
    U3/L1-L2 suspend events.  The problem is that these events aren't
    currently enabled in the DEVTEN register so the handler is never
    even invoked.  Fix this simply by enabling the corresponding bit
    in dwc3_gadget_enable_irq() using the same revision check as found
    in the handler.
    
    Fixes: 72704f876f50 ("dwc3: gadget: Implement the suspend entry event handler")
    Acked-by: Felipe Balbi <balbi@kernel.org>
    Signed-off-by: Jack Pham <jackp@codeaurora.org>
    Cc: stable <stable@vger.kernel.org>
    Link: https://lore.kernel.org/r/20210428090111.3370-1-jackp@codeaurora.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dcf0e6c2b9d536af11bcad49c59bcbaf57d202d5
Author: Chunfeng Yun <chunfeng.yun@mediatek.com>
Date:   Wed May 12 10:07:38 2021 +0800

    usb: core: hub: fix race condition about TRSMRCY of resume
    
    commit 975f94c7d6c306b833628baa9aec3f79db1eb3a1 upstream.
    
    This may happen if the port becomes resume status exactly
    when usb_port_resume() gets port status, it still need provide
    a TRSMCRY time before access the device.
    
    CC: <stable@vger.kernel.org>
    Reported-by: Tianping Fang <tianping.fang@mediatek.com>
    Acked-by: Alan Stern <stern@rowland.harvard.edu>
    Signed-off-by: Chunfeng Yun <chunfeng.yun@mediatek.com>
    Link: https://lore.kernel.org/r/20210512020738.52961-1-chunfeng.yun@mediatek.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e8c33315eb24bc2265284537a0e5b67bf7f4bc1e
Author: Phil Elwell <phil@raspberrypi.com>
Date:   Thu May 6 12:22:00 2021 +0100

    usb: dwc2: Fix gadget DMA unmap direction
    
    commit 75a41ce46bae6cbe7d3bb2584eb844291d642874 upstream.
    
    The dwc2 gadget support maps and unmaps DMA buffers as necessary. When
    mapping and unmapping it uses the direction of the endpoint to select
    the direction of the DMA transfer, but this fails for Control OUT
    transfers because the unmap occurs after the endpoint direction has
    been reversed for the status phase.
    
    A possible solution would be to unmap the buffer before the direction
    is changed, but a safer, less invasive fix is to remember the buffer
    direction independently of the endpoint direction.
    
    Fixes: fe0b94abcdf6 ("usb: dwc2: gadget: manage ep0 state in software")
    Acked-by: Minas Harutyunyan <Minas.Harutyunyan@synopsys.com>
    Cc: stable <stable@vger.kernel.org>
    Signed-off-by: Phil Elwell <phil@raspberrypi.com>
    Link: https://lore.kernel.org/r/20210506112200.2893922-1-phil@raspberrypi.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 439baba2e32195b3822dddd0410b19e01ad95aa5
Author: Maximilian Luz <luzmaximilian@gmail.com>
Date:   Wed May 12 11:08:15 2021 +0300

    usb: xhci: Increase timeout for HC halt
    
    commit ca09b1bea63ab83f4cca3a2ae8bc4f597ec28851 upstream.
    
    On some devices (specifically the SC8180x based Surface Pro X with
    QCOM04A6) HC halt / xhci_halt() times out during boot. Manually binding
    the xhci-hcd driver at some point later does not exhibit this behavior.
    To work around this, double XHCI_MAX_HALT_USEC, which also resolves this
    issue.
    
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Maximilian Luz <luzmaximilian@gmail.com>
    Signed-off-by: Mathias Nyman <mathias.nyman@linux.intel.com>
    Link: https://lore.kernel.org/r/20210512080816.866037-5-mathias.nyman@linux.intel.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cf8cf47b0b6ec59ad5b1ca01317642a8389f20dd
Author: Ferry Toth <ftoth@exalondelft.nl>
Date:   Sun Apr 25 17:09:47 2021 +0200

    usb: dwc3: pci: Enable usb2-gadget-lpm-disable for Intel Merrifield
    
    commit 04357fafea9c7ed34525eb9680c760245c3bb958 upstream.
    
    On Intel Merrifield LPM is causing host to reset port after a timeout.
    By disabling LPM entirely this is prevented.
    
    Fixes: 066c09593454 ("usb: dwc3: pci: Enable extcon driver for Intel Merrifield")
    Reviewed-by: Andy Shevchenko <andy.shevchenko@gmail.com>
    Signed-off-by: Ferry Toth <ftoth@exalondelft.nl>
    Cc: stable <stable@vger.kernel.org>
    Link: https://lore.kernel.org/r/20210425150947.5862-1-ftoth@exalondelft.nl
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 86749dbd2557dc64fff06f705633c848de710242
Author: Marcel Hamer <marcel@solidxs.se>
Date:   Tue Apr 27 14:21:18 2021 +0200

    usb: dwc3: omap: improve extcon initialization
    
    commit e17b02d4970913233d543c79c9c66e72cac05bdd upstream.
    
    When extcon is used in combination with dwc3, it is assumed that the dwc3
    registers are untouched and as such are only configured if VBUS is valid
    or ID is tied to ground.
    
    In case VBUS is not valid or ID is floating, the registers are not
    configured as such during driver initialization, causing a wrong
    default state during boot.
    
    If the registers are not in a default state, because they are for
    instance touched by a boot loader, this can cause for a kernel error.
    
    Signed-off-by: Marcel Hamer <marcel@solidxs.se>
    Link: https://lore.kernel.org/r/20210427122118.1948340-1-marcel@solidxs.se
    Cc: stable <stable@vger.kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 929778cfc8f31f3fa793a5fa5f10fe3cd30f63ff
Author: Bart Van Assche <bvanassche@acm.org>
Date:   Thu May 13 10:15:29 2021 -0700

    blk-mq: Swap two calls in blk_mq_exit_queue()
    
    [ Upstream commit 630ef623ed26c18a457cdc070cf24014e50129c2 ]
    
    If a tag set is shared across request queues (e.g. SCSI LUNs) then the
    block layer core keeps track of the number of active request queues in
    tags->active_queues. blk_mq_tag_busy() and blk_mq_tag_idle() update that
    atomic counter if the hctx flag BLK_MQ_F_TAG_QUEUE_SHARED is set. Make
    sure that blk_mq_exit_queue() calls blk_mq_tag_idle() before that flag is
    cleared by blk_mq_del_queue_tag_set().
    
    Cc: Christoph Hellwig <hch@infradead.org>
    Cc: Ming Lei <ming.lei@redhat.com>
    Cc: Hannes Reinecke <hare@suse.com>
    Fixes: 0d2602ca30e4 ("blk-mq: improve support for shared tags maps")
    Signed-off-by: Bart Van Assche <bvanassche@acm.org>
    Reviewed-by: Ming Lei <ming.lei@redhat.com>
    Link: https://lore.kernel.org/r/20210513171529.7977-1-bvanassche@acm.org
    Signed-off-by: Jens Axboe <axboe@kernel.dk>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 273047c938ac3cd33ec8c037f5e7a1a7f63b9566
Author: Ming Lei <ming.lei@redhat.com>
Date:   Fri May 14 10:20:52 2021 +0800

    blk-mq: plug request for shared sbitmap
    
    [ Upstream commit 03f26d8f11403295de445b6e4e0e57ac57755791 ]
    
    In case of shared sbitmap, request won't be held in plug list any more
    sine commit 32bc15afed04 ("blk-mq: Facilitate a shared sbitmap per
    tagset"), this way makes request merge from flush plug list & batching
    submission not possible, so cause performance regression.
    
    Yanhui reports performance regression when running sequential IO
    test(libaio, 16 jobs, 8 depth for each job) in VM, and the VM disk
    is emulated with image stored on xfs/megaraid_sas.
    
    Fix the issue by recovering original behavior to allow to hold request
    in plug list.
    
    Cc: Yanhui Ma <yama@redhat.com>
    Cc: John Garry <john.garry@huawei.com>
    Cc: Bart Van Assche <bvanassche@acm.org>
    Cc: kashyap.desai@broadcom.com
    Fixes: 32bc15afed04 ("blk-mq: Facilitate a shared sbitmap per tagset")
    Signed-off-by: Ming Lei <ming.lei@redhat.com>
    Link: https://lore.kernel.org/r/20210514022052.1047665-1-ming.lei@redhat.com
    Signed-off-by: Jens Axboe <axboe@kernel.dk>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit b31d237796fd618379ec8e0f4de3370b5e4aeee7
Author: Sun Ke <sunke32@huawei.com>
Date:   Wed May 12 19:43:30 2021 +0800

    nbd: Fix NULL pointer in flush_workqueue
    
    [ Upstream commit 79ebe9110fa458d58f1fceb078e2068d7ad37390 ]
    
    Open /dev/nbdX first, the config_refs will be 1 and
    the pointers in nbd_device are still null. Disconnect
    /dev/nbdX, then reference a null recv_workq. The
    protection by config_refs in nbd_genl_disconnect is useless.
    
    [  656.366194] BUG: kernel NULL pointer dereference, address: 0000000000000020
    [  656.368943] #PF: supervisor write access in kernel mode
    [  656.369844] #PF: error_code(0x0002) - not-present page
    [  656.370717] PGD 10cc87067 P4D 10cc87067 PUD 1074b4067 PMD 0
    [  656.371693] Oops: 0002 [#1] SMP
    [  656.372242] CPU: 5 PID: 7977 Comm: nbd-client Not tainted 5.11.0-rc5-00040-g76c057c84d28 #1
    [  656.373661] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS ?-20190727_073836-buildvm-ppc64le-16.ppc.fedoraproject.org-3.fc31 04/01/2014
    [  656.375904] RIP: 0010:mutex_lock+0x29/0x60
    [  656.376627] Code: 00 0f 1f 44 00 00 55 48 89 fd 48 83 05 6f d7 fe 08 01 e8 7a c3 ff ff 48 83 05 6a d7 fe 08 01 31 c0 65 48 8b 14 25 00 6d 01 00 <f0> 48 0f b1 55 d
    [  656.378934] RSP: 0018:ffffc900005eb9b0 EFLAGS: 00010246
    [  656.379350] RAX: 0000000000000000 RBX: 0000000000000000 RCX: 0000000000000000
    [  656.379915] RDX: ffff888104cf2600 RSI: ffffffffaae8f452 RDI: 0000000000000020
    [  656.380473] RBP: 0000000000000020 R08: 0000000000000000 R09: ffff88813bd6b318
    [  656.381039] R10: 00000000000000c7 R11: fefefefefefefeff R12: ffff888102710b40
    [  656.381599] R13: ffffc900005eb9e0 R14: ffffffffb2930680 R15: ffff88810770ef00
    [  656.382166] FS:  00007fdf117ebb40(0000) GS:ffff88813bd40000(0000) knlGS:0000000000000000
    [  656.382806] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    [  656.383261] CR2: 0000000000000020 CR3: 0000000100c84000 CR4: 00000000000006e0
    [  656.383819] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
    [  656.384370] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
    [  656.384927] Call Trace:
    [  656.385111]  flush_workqueue+0x92/0x6c0
    [  656.385395]  nbd_disconnect_and_put+0x81/0xd0
    [  656.385716]  nbd_genl_disconnect+0x125/0x2a0
    [  656.386034]  genl_family_rcv_msg_doit.isra.0+0x102/0x1b0
    [  656.386422]  genl_rcv_msg+0xfc/0x2b0
    [  656.386685]  ? nbd_ioctl+0x490/0x490
    [  656.386954]  ? genl_family_rcv_msg_doit.isra.0+0x1b0/0x1b0
    [  656.387354]  netlink_rcv_skb+0x62/0x180
    [  656.387638]  genl_rcv+0x34/0x60
    [  656.387874]  netlink_unicast+0x26d/0x590
    [  656.388162]  netlink_sendmsg+0x398/0x6c0
    [  656.388451]  ? netlink_rcv_skb+0x180/0x180
    [  656.388750]  ____sys_sendmsg+0x1da/0x320
    [  656.389038]  ? ____sys_recvmsg+0x130/0x220
    [  656.389334]  ___sys_sendmsg+0x8e/0xf0
    [  656.389605]  ? ___sys_recvmsg+0xa2/0xf0
    [  656.389889]  ? handle_mm_fault+0x1671/0x21d0
    [  656.390201]  __sys_sendmsg+0x6d/0xe0
    [  656.390464]  __x64_sys_sendmsg+0x23/0x30
    [  656.390751]  do_syscall_64+0x45/0x70
    [  656.391017]  entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    To fix it, just add if (nbd->recv_workq) to nbd_disconnect_and_put().
    
    Fixes: e9e006f5fcf2 ("nbd: fix max number of supported devs")
    Signed-off-by: Sun Ke <sunke32@huawei.com>
    Reviewed-by: Josef Bacik <josef@toxicpanda.com>
    Link: https://lore.kernel.org/r/20210512114331.1233964-2-sunke32@huawei.com
    Signed-off-by: Jens Axboe <axboe@kernel.dk>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 530d4804865432472587438707a513bbb6cda85d
Author: Chao Yu <chao@kernel.org>
Date:   Mon May 10 17:30:32 2021 +0800

    f2fs: compress: fix to assign cc.cluster_idx correctly
    
    [ Upstream commit 8bfbfb0ddd706b1ce2e89259ecc45f192c0ec2bf ]
    
    In f2fs_destroy_compress_ctx(), after f2fs_destroy_compress_ctx(),
    cc.cluster_idx will be cleared w/ NULL_CLUSTER, f2fs_cluster_blocks()
    may check wrong cluster metadata, fix it.
    
    Fixes: 4c8ff7095bef ("f2fs: support data compression")
    Signed-off-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 64acb100fe3beb5d20184d0ae3307235bd3555c4
Author: Chao Yu <chao@kernel.org>
Date:   Mon May 10 17:30:31 2021 +0800

    f2fs: compress: fix race condition of overwrite vs truncate
    
    [ Upstream commit a949dc5f2c5cfe0c910b664650f45371254c0744 ]
    
    pos_fsstress testcase complains a panic as belew:
    
    ------------[ cut here ]------------
    kernel BUG at fs/f2fs/compress.c:1082!
    invalid opcode: 0000 [#1] SMP PTI
    CPU: 4 PID: 2753477 Comm: kworker/u16:2 Tainted: G           OE     5.12.0-rc1-custom #1
    Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.14.0-2 04/01/2014
    Workqueue: writeback wb_workfn (flush-252:16)
    RIP: 0010:prepare_compress_overwrite+0x4c0/0x760 [f2fs]
    Call Trace:
     f2fs_prepare_compress_overwrite+0x5f/0x80 [f2fs]
     f2fs_write_cache_pages+0x468/0x8a0 [f2fs]
     f2fs_write_data_pages+0x2a4/0x2f0 [f2fs]
     do_writepages+0x38/0xc0
     __writeback_single_inode+0x44/0x2a0
     writeback_sb_inodes+0x223/0x4d0
     __writeback_inodes_wb+0x56/0xf0
     wb_writeback+0x1dd/0x290
     wb_workfn+0x309/0x500
     process_one_work+0x220/0x3c0
     worker_thread+0x53/0x420
     kthread+0x12f/0x150
     ret_from_fork+0x22/0x30
    
    The root cause is truncate() may race with overwrite as below,
    so that one reference count left in page can not guarantee the
    page attaching in mapping tree all the time, after truncation,
    later find_lock_page() may return NULL pointer.
    
    - prepare_compress_overwrite
     - f2fs_pagecache_get_page
     - unlock_page
                                            - f2fs_setattr
                                             - truncate_setsize
                                              - truncate_inode_page
                                               - delete_from_page_cache
     - find_lock_page
    
    Fix this by avoiding referencing updated page.
    
    Fixes: 4c8ff7095bef ("f2fs: support data compression")
    Signed-off-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 02de9d20039da8d2773e59fef37e73e106e30fec
Author: Chao Yu <chao@kernel.org>
Date:   Thu May 6 17:00:43 2021 +0800

    f2fs: compress: fix to free compress page correctly
    
    [ Upstream commit a12cc5b423d4f36dc1a1ea3911e49cf9dff43898 ]
    
    In error path of f2fs_write_compressed_pages(), it needs to call
    f2fs_compress_free_page() to release temporary page.
    
    Fixes: 5e6bbde95982 ("f2fs: introduce mempool for {,de}compress intermediate page allocation")
    Signed-off-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 17fb6dfa5162b89ecfa07df891a53afec321abe8
Author: Michal Kalderon <michal.kalderon@marvell.com>
Date:   Thu May 6 10:08:19 2021 +0300

    nvmet-rdma: Fix NULL deref when SEND is completed with error
    
    [ Upstream commit 8cc365f9559b86802afc0208389f5c8d46b4ad61 ]
    
    When running some traffic and taking down the link on peer, a
    retry counter exceeded error is received. This leads to
    nvmet_rdma_error_comp which tried accessing the cq_context to
    obtain the queue. The cq_context is no longer valid after the
    fix to use shared CQ mechanism and should be obtained similar
    to how it is obtained in other functions from the wc->qp.
    
    [ 905.786331] nvmet_rdma: SEND for CQE 0x00000000e3337f90 failed with status transport retry counter exceeded (12).
    [ 905.832048] BUG: unable to handle kernel NULL pointer dereference at 0000000000000048
    [ 905.839919] PGD 0 P4D 0
    [ 905.842464] Oops: 0000 1 SMP NOPTI
    [ 905.846144] CPU: 13 PID: 1557 Comm: kworker/13:1H Kdump: loaded Tainted: G OE --------- - - 4.18.0-304.el8.x86_64 #1
    [ 905.872135] RIP: 0010:nvmet_rdma_error_comp+0x5/0x1b [nvmet_rdma]
    [ 905.878259] Code: 19 4f c0 e8 89 b3 a5 f6 e9 5b e0 ff ff 0f b7 75 14 4c 89 ea 48 c7 c7 08 1a 4f c0 e8 71 b3 a5 f6 e9 4b e0 ff ff 0f 1f 44 00 00 <48> 8b 47 48 48 85 c0 74 08 48 89 c7 e9 98 bf 49 00 e9 c3 e3 ff ff
    [ 905.897135] RSP: 0018:ffffab601c45fe28 EFLAGS: 00010246
    [ 905.902387] RAX: 0000000000000065 RBX: ffff9e729ea2f800 RCX: 0000000000000000
    [ 905.909558] RDX: 0000000000000000 RSI: ffff9e72df9567c8 RDI: 0000000000000000
    [ 905.916731] RBP: ffff9e729ea2b400 R08: 000000000000074d R09: 0000000000000074
    [ 905.923903] R10: 0000000000000000 R11: ffffab601c45fcc0 R12: 0000000000000010
    [ 905.931074] R13: 0000000000000000 R14: 0000000000000010 R15: ffff9e729ea2f400
    [ 905.938247] FS: 0000000000000000(0000) GS:ffff9e72df940000(0000) knlGS:0000000000000000
    [ 905.938249] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    [ 905.950067] nvmet_rdma: SEND for CQE 0x00000000c7356cca failed with status transport retry counter exceeded (12).
    [ 905.961855] CR2: 0000000000000048 CR3: 000000678d010004 CR4: 00000000007706e0
    [ 905.961855] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
    [ 905.961856] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
    [ 905.961857] PKRU: 55555554
    [ 906.010315] Call Trace:
    [ 906.012778] __ib_process_cq+0x89/0x170 [ib_core]
    [ 906.017509] ib_cq_poll_work+0x26/0x80 [ib_core]
    [ 906.022152] process_one_work+0x1a7/0x360
    [ 906.026182] ? create_worker+0x1a0/0x1a0
    [ 906.030123] worker_thread+0x30/0x390
    [ 906.033802] ? create_worker+0x1a0/0x1a0
    [ 906.037744] kthread+0x116/0x130
    [ 906.040988] ? kthread_flush_work_fn+0x10/0x10
    [ 906.045456] ret_from_fork+0x1f/0x40
    
    Fixes: ca0f1a8055be2 ("nvmet-rdma: use new shared CQ mechanism")
    Signed-off-by: Shai Malin <smalin@marvell.com>
    Signed-off-by: Michal Kalderon <michal.kalderon@marvell.com>
    Reviewed-by: Sagi Grimberg <sagi@grimberg.me>
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c0e4af6e92488174bbce096ac1b7fa9191f2b4b1
Author: Chaitanya Kulkarni <chaitanya.kulkarni@wdc.com>
Date:   Thu May 6 18:51:36 2021 -0700

    nvmet: fix inline bio check for passthru
    
    [ Upstream commit ab96de5def854d8fc51280b6a20597e64b14ac31 ]
    
    When handling passthru commands, for inline bio allocation we only
    consider the transfer size. This works well when req->sg_cnt fits into
    the req->inline_bvec, but it will result in the early return from
    bio_add_hw_page() when req->sg_cnt > NVMET_MAX_INLINE_BVEC.
    
    Consider an I/O of size 32768 and first buffer is not aligned to the
    page boundary, then I/O is split in following manner :-
    
    [ 2206.256140] nvmet: sg->length 3440 sg->offset 656
    [ 2206.256144] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256148] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256152] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256155] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256159] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256163] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256166] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256170] nvmet: sg->length 656 sg->offset 0
    
    Now the req->transfer_size == NVMET_MAX_INLINE_DATA_LEN i.e. 32768, but
    the req->sg_cnt is (9) > NVMET_MAX_INLINE_BIOVEC which is (8).
    This will result in early return in the following code path :-
    
    nvmet_bdev_execute_rw()
            bio_add_pc_page()
                    bio_add_hw_page()
                            if (bio_full(bio, len))
                                    return 0;
    
    Use previously introduced helper nvmet_use_inline_bvec() to consider
    req->sg_cnt when using inline bio. This only affects nvme-loop
    transport.
    
    Fixes: dab3902b19a0 ("nvmet: use inline bio for passthru fast path")
    Signed-off-by: Chaitanya Kulkarni <chaitanya.kulkarni@wdc.com>
    Reviewed-by: Sagi Grimberg <sagi@grimberg.me>
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 407be9fe90a42352c3302e9ae5276032ce742f0e
Author: Chaitanya Kulkarni <chaitanya.kulkarni@wdc.com>
Date:   Thu May 6 18:51:35 2021 -0700

    nvmet: fix inline bio check for bdev-ns
    
    [ Upstream commit 608a969046e6e0567d05a166be66c77d2dd8220b ]
    
    When handling rw commands, for inline bio case we only consider
    transfer size. This works well when req->sg_cnt fits into the
    req->inline_bvec, but it will result in the warning in
    __bio_add_page() when req->sg_cnt > NVMET_MAX_INLINE_BVEC.
    
    Consider an I/O size 32768 and first page is not aligned to the page
    boundary, then I/O is split in following manner :-
    
    [ 2206.256140] nvmet: sg->length 3440 sg->offset 656
    [ 2206.256144] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256148] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256152] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256155] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256159] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256163] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256166] nvmet: sg->length 4096 sg->offset 0
    [ 2206.256170] nvmet: sg->length 656 sg->offset 0
    
    Now the req->transfer_size == NVMET_MAX_INLINE_DATA_LEN i.e. 32768, but
    the req->sg_cnt is (9) > NVMET_MAX_INLINE_BIOVEC which is (8).
    This will result in the following warning message :-
    
    nvmet_bdev_execute_rw()
            bio_add_page()
                    __bio_add_page()
                            WARN_ON_ONCE(bio_full(bio, len));
    
    This scenario is very hard to reproduce on the nvme-loop transport only
    with rw commands issued with the passthru IOCTL interface from the host
    application and the data buffer is allocated with the malloc() and not
    the posix_memalign().
    
    Fixes: 73383adfad24 ("nvmet: don't split large I/Os unconditionally")
    Signed-off-by: Chaitanya Kulkarni <chaitanya.kulkarni@wdc.com>
    Reviewed-by: Sagi Grimberg <sagi@grimberg.me>
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit dbfb2b1682d796b9f7dc8e0f53d530e7ffdfc512
Author: Chaitanya Kulkarni <chaitanya.kulkarni@wdc.com>
Date:   Mon Jan 11 20:26:16 2021 -0800

    nvmet: add lba to sect conversion helpers
    
    [ Upstream commit 193fcf371f9e3705c14a0bf1d4bfc44af0f7c124 ]
    
    In this preparation patch, we add helpers to convert lbas to sectors &
    sectors to lba. This is needed to eliminate code duplication in the ZBD
    backend.
    
    Use these helpers in the block device backend.
    
    Signed-off-by: Chaitanya Kulkarni <chaitanya.kulkarni@wdc.com>
    Reviewed-by: Damien Le Moal <damien.lemoal@wdc.com>
    Signed-off-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a287cd84e047045f5a4d4da793414e848de627c6
Author: Omar Sandoval <osandov@fb.com>
Date:   Mon May 10 17:05:35 2021 -0700

    kyber: fix out of bounds access when preempted
    
    [ Upstream commit efed9a3337e341bd0989161b97453b52567bc59d ]
    
    __blk_mq_sched_bio_merge() gets the ctx and hctx for the current CPU and
    passes the hctx to ->bio_merge(). kyber_bio_merge() then gets the ctx
    for the current CPU again and uses that to get the corresponding Kyber
    context in the passed hctx. However, the thread may be preempted between
    the two calls to blk_mq_get_ctx(), and the ctx returned the second time
    may no longer correspond to the passed hctx. This "works" accidentally
    most of the time, but it can cause us to read garbage if the second ctx
    came from an hctx with more ctx's than the first one (i.e., if
    ctx->index_hw[hctx->type] > hctx->nr_ctx).
    
    This manifested as this UBSAN array index out of bounds error reported
    by Jakub:
    
    UBSAN: array-index-out-of-bounds in ../kernel/locking/qspinlock.c:130:9
    index 13106 is out of range for type 'long unsigned int [128]'
    Call Trace:
     dump_stack+0xa4/0xe5
     ubsan_epilogue+0x5/0x40
     __ubsan_handle_out_of_bounds.cold.13+0x2a/0x34
     queued_spin_lock_slowpath+0x476/0x480
     do_raw_spin_lock+0x1c2/0x1d0
     kyber_bio_merge+0x112/0x180
     blk_mq_submit_bio+0x1f5/0x1100
     submit_bio_noacct+0x7b0/0x870
     submit_bio+0xc2/0x3a0
     btrfs_map_bio+0x4f0/0x9d0
     btrfs_submit_data_bio+0x24e/0x310
     submit_one_bio+0x7f/0xb0
     submit_extent_page+0xc4/0x440
     __extent_writepage_io+0x2b8/0x5e0
     __extent_writepage+0x28d/0x6e0
     extent_write_cache_pages+0x4d7/0x7a0
     extent_writepages+0xa2/0x110
     do_writepages+0x8f/0x180
     __writeback_single_inode+0x99/0x7f0
     writeback_sb_inodes+0x34e/0x790
     __writeback_inodes_wb+0x9e/0x120
     wb_writeback+0x4d2/0x660
     wb_workfn+0x64d/0xa10
     process_one_work+0x53a/0xa80
     worker_thread+0x69/0x5b0
     kthread+0x20b/0x240
     ret_from_fork+0x1f/0x30
    
    Only Kyber uses the hctx, so fix it by passing the request_queue to
    ->bio_merge() instead. BFQ and mq-deadline just use that, and Kyber can
    map the queues itself to avoid the mismatch.
    
    Fixes: a6088845c2bf ("block: kyber: make kyber more friendly with merging")
    Reported-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Omar Sandoval <osandov@fb.com>
    Link: https://lore.kernel.org/r/c7598605401a48d5cfeadebb678abd10af22b83f.1620691329.git.osandov@fb.com
    Signed-off-by: Jens Axboe <axboe@kernel.dk>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c5c8f6ffc942cf42f990f22e35bcf4cbe9d8c2fb
Author: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
Date:   Sat May 8 09:23:09 2021 +0200

    ACPI: scan: Fix a memory leak in an error handling path
    
    [ Upstream commit 0c8bd174f0fc131bc9dfab35cd8784f59045da87 ]
    
    If 'acpi_device_set_name()' fails, we must free
    'acpi_device_bus_id->bus_id' or there is a (potential) memory leak.
    
    Fixes: eb50aaf960e3 ("ACPI: scan: Use unique number for instance_no")
    Signed-off-by: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
    Reviewed-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 0d75b7836a5aa5f4c6d33199677003a54055ced8
Author: Andy Shevchenko <andy.shevchenko@gmail.com>
Date:   Mon May 10 13:01:36 2021 +0300

    hwmon: (ltc2992) Put fwnode in error case during ->probe()
    
    [ Upstream commit 8370e5b093080c03cf89f7ebf0bef6984545429e ]
    
    In each iteration fwnode_for_each_available_child_node() bumps a reference
    counting of a loop variable followed by dropping in on a next iteration,
    
    Since in error case the loop is broken, we have to drop a reference count
    by ourselves. Do it for port_fwnode in error case during ->probe().
    
    Fixes: b0bd407e94b0 ("hwmon: (ltc2992) Add support")
    Cc: Alexandru Tachici <alexandru.tachici@analog.com>
    Signed-off-by: Andy Shevchenko <andy.shevchenko@gmail.com>
    Link: https://lore.kernel.org/r/20210510100136.3303142-1-andy.shevchenko@gmail.com
    Signed-off-by: Guenter Roeck <linux@roeck-us.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2c1609e38324a0879a3b01725ba16cd59d63fe9f
Author: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
Date:   Tue May 4 22:26:29 2021 +0200

    usb: musb: Fix an error message
    
    [ Upstream commit d9ff1096a840dddea3d5cfa2149ff7da9f499fb2 ]
    
    'ret' is known to be 0 here.
    Initialize 'ret' with the expected error code before using it.
    
    Fixes: 0990366bab3c ("usb: musb: Add support for MediaTek musb controller")
    Signed-off-by: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
    Link: https://lore.kernel.org/r/69f514dc7134e3c917cad208e73cc650cb9e2bd6.1620159879.git.christophe.jaillet@wanadoo.fr
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 61f459e285b82d00377753f43c31c382cf149df5
Author: Eddie James <eajames@linux.ibm.com>
Date:   Thu Apr 29 10:13:36 2021 -0500

    hwmon: (occ) Fix poll rate limiting
    
    [ Upstream commit 5216dff22dc2bbbbe6f00335f9fd2879670e753b ]
    
    The poll rate limiter time was initialized at zero. This breaks the
    comparison in time_after if jiffies is large. Switch to storing the
    next update time rather than the previous time, and initialize the
    time when the device is probed.
    
    Fixes: c10e753d43eb ("hwmon (occ): Add sensor types and versions")
    Signed-off-by: Eddie James <eajames@linux.ibm.com>
    Link: https://lore.kernel.org/r/20210429151336.18980-1-eajames@linux.ibm.com
    Signed-off-by: Guenter Roeck <linux@roeck-us.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a44a97639442e36fe755f8c513957f6856642d08
Author: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
Date:   Thu May 6 22:39:10 2021 +0200

    usb: fotg210-hcd: Fix an error message
    
    [ Upstream commit a60a34366e0d09ca002c966dd7c43a68c28b1f82 ]
    
    'retval' is known to be -ENODEV here.
    This is a hard-coded default error code which is not useful in the error
    message. Moreover, another error message is printed at the end of the
    error handling path. The corresponding error code (-ENOMEM) is more
    informative.
    
    So remove simplify the first error message.
    
    While at it, also remove the useless initialization of 'retval'.
    
    Fixes: 7d50195f6c50 ("usb: host: Faraday fotg210-hcd driver")
    Signed-off-by: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
    Link: https://lore.kernel.org/r/94531bcff98e46d4f9c20183a90b7f47f699126c.1620333419.git.christophe.jaillet@wanadoo.fr
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ec07eccc6de49c7c57c358b1d0265358a158267a
Author: Alexandru Ardelean <aardelean@deviqon.com>
Date:   Mon May 3 17:43:50 2021 +0300

    iio: core: return ENODEV if ioctl is unknown
    
    [ Upstream commit af0670b0bf1b116fd729b1b1011cf814bc34e12e ]
    
    When the ioctl() mechanism was introduced in IIO core to centralize the
    registration of all ioctls in one place via commit 8dedcc3eee3ac ("iio:
    core: centralize ioctl() calls to the main chardev"), the return code was
    changed from ENODEV to EINVAL, when the ioctl code isn't known.
    
    This was done by accident.
    
    This change reverts back to the old behavior, where if the ioctl() code
    isn't known, ENODEV is returned (vs EINVAL).
    
    This was brought into perspective by this patch:
      https://lore.kernel.org/linux-iio/20210428150815.136150-1-paul@crapouillou.net/
    
    Fixes: 8dedcc3eee3ac ("iio: core: centralize ioctl() calls to the main chardev")
    Signed-off-by: Alexandru Ardelean <aardelean@deviqon.com>
    Reviewed-by: Nuno Sá <nuno.sa@analog.com>
    Tested-by: Paul Cercueil <paul@crapouillou.net>
    Reviewed-by: Linus Walleij <linus.walleij@linaro.org>
    Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f55ae144668d815cfcbecb8e98ef7ad5b1e7f9a7
Author: Alexandru Ardelean <aardelean@deviqon.com>
Date:   Wed Apr 14 11:49:55 2021 +0300

    iio: hid-sensors: select IIO_TRIGGERED_BUFFER under HID_SENSOR_IIO_TRIGGER
    
    [ Upstream commit 7061803522ee7876df1ca18cdd1e1551f761352d ]
    
    During commit 067fda1c065ff ("iio: hid-sensors: move triggered buffer
    setup into hid_sensor_setup_trigger"), the
    iio_triggered_buffer_{setup,cleanup}() functions got moved under the
    hid-sensor-trigger module.
    
    The above change works fine, if any of the sensors get built. However, when
    only the common hid-sensor-trigger module gets built (and none of the
    drivers), then the IIO_TRIGGERED_BUFFER symbol isn't selected/enforced.
    
    Previously, each driver would enforce/select the IIO_TRIGGERED_BUFFER
    symbol. With this change the HID_SENSOR_IIO_TRIGGER (for the
    hid-sensor-trigger module) will enforce that IIO_TRIGGERED_BUFFER gets
    selected.
    
    All HID sensor drivers select the HID_SENSOR_IIO_TRIGGER symbol. So, this
    change removes the IIO_TRIGGERED_BUFFER enforcement from each driver.
    
    Fixes: 067fda1c065ff ("iio: hid-sensors: move triggered buffer setup into hid_sensor_setup_trigger")
    Reported-by: Thomas Deutschmann <whissi@gentoo.org>
    Cc: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
    Signed-off-by: Alexandru Ardelean <aardelean@deviqon.com>
    Acked-by: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
    Link: https://lore.kernel.org/r/20210414084955.260117-1-aardelean@deviqon.com
    Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a9a34d1511c244cd1c9dfbe4cb9dcd7ddba7a511
Author: Dinghao Liu <dinghao.liu@zju.edu.cn>
Date:   Mon Apr 12 13:32:02 2021 +0800

    iio: proximity: pulsedlight: Fix rumtime PM imbalance on error
    
    [ Upstream commit a2fa9242e89f27696515699fe0f0296bf1ac1815 ]
    
    When lidar_write_control() fails, a pairing PM usage counter
    decrement is needed to keep the counter balanced.
    
    Fixes: 4ac4e086fd8c5 ("iio: pulsedlight-lidar-lite: add runtime PM")
    Signed-off-by: Dinghao Liu <dinghao.liu@zju.edu.cn>
    Reviewed-by: Andy Shevchenko <andy.shevchenko@gmail.com>
    Link: https://lore.kernel.org/r/20210412053204.4889-1-dinghao.liu@zju.edu.cn
    Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 37c7a85a5fb00b75dc25f2b5dd284321abe340ae
Author: Dinghao Liu <dinghao.liu@zju.edu.cn>
Date:   Wed Apr 7 11:49:27 2021 +0800

    iio: light: gp2ap002: Fix rumtime PM imbalance on error
    
    [ Upstream commit 8edb79af88efc6e49e735f9baf61d9f0748b881f ]
    
    When devm_request_threaded_irq() fails, we should decrease the
    runtime PM counter to keep the counter balanced. But when
    iio_device_register() fails, we need not to decrease it because
    we have already decreased it before.
    
    Signed-off-by: Dinghao Liu <dinghao.liu@zju.edu.cn>
    Reviewed-by: Linus Walleij <linus.walleij@linaro.org>
    Fixes: 97d642e23037 ("iio: light: Add a driver for Sharp GP2AP002x00F")
    Link: https://lore.kernel.org/r/20210407034927.16882-1-dinghao.liu@zju.edu.cn
    Signed-off-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit bc0cdd72493236fb72b390ad38ce581e353c143c
Author: Jack Pham <jackp@codeaurora.org>
Date:   Sat May 1 02:35:58 2021 -0700

    usb: dwc3: gadget: Free gadget structure only after freeing endpoints
    
    [ Upstream commit bb9c74a5bd1462499fe5ccb1e3c5ac40dcfa9139 ]
    
    As part of commit e81a7018d93a ("usb: dwc3: allocate gadget structure
    dynamically") the dwc3_gadget_release() was added which will free
    the dwc->gadget structure upon the device's removal when
    usb_del_gadget_udc() is called in dwc3_gadget_exit().
    
    However, simply freeing the gadget results a dangling pointer
    situation: the endpoints created in dwc3_gadget_init_endpoints()
    have their dep->endpoint.ep_list members chained off the list_head
    anchored at dwc->gadget->ep_list.  Thus when dwc->gadget is freed,
    the first dwc3_ep in the list now has a dangling prev pointer and
    likewise for the next pointer of the dwc3_ep at the tail of the list.
    The dwc3_gadget_free_endpoints() that follows will result in a
    use-after-free when it calls list_del().
    
    This was caught by enabling KASAN and performing a driver unbind.
    The recent commit 568262bf5492 ("usb: dwc3: core: Add shutdown
    callback for dwc3") also exposes this as a panic during shutdown.
    
    There are a few possibilities to fix this.  One could be to perform
    a list_del() of the gadget->ep_list itself which removes it from
    the rest of the dwc3_ep chain.
    
    Another approach is what this patch does, by splitting up the
    usb_del_gadget_udc() call into its separate "del" and "put"
    components.  This allows dwc3_gadget_free_endpoints() to be
    called before the gadget is finally freed with usb_put_gadget().
    
    Fixes: e81a7018d93a ("usb: dwc3: allocate gadget structure dynamically")
    Reviewed-by: Peter Chen <peter.chen@kernel.org>
    Signed-off-by: Jack Pham <jackp@codeaurora.org>
    Link: https://lore.kernel.org/r/20210501093558.7375-1-jackp@codeaurora.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4c61c48f1daa19eb90ee64736c79bcb0b3a7002d
Author: Jiri Olsa <jolsa@kernel.org>
Date:   Sat May 8 22:50:20 2021 +0200

    perf tools: Fix dynamic libbpf link
    
    [ Upstream commit ad1237c30d975535a669746496cbed136aa5a045 ]
    
    Justin reported broken build with LIBBPF_DYNAMIC=1.
    
    When linking libbpf dynamically we need to use perf's
    hashmap object, because it's not exported in libbpf.so
    (only in libbpf.a).
    
    Following build is now passing:
    
      $ make LIBBPF_DYNAMIC=1
        BUILD:   Doing 'make -j8' parallel build
        ...
      $ ldd perf | grep libbpf
            libbpf.so.0 => /lib64/libbpf.so.0 (0x00007fa7630db000)
    
    Fixes: eee19501926d ("perf tools: Grab a copy of libbpf's hashmap")
    Reported-by: Justin M. Forbes <jforbes@redhat.com>
    Signed-off-by: Jiri Olsa <jolsa@kernel.org>
    Cc: Alexander Shishkin <alexander.shishkin@linux.intel.com>
    Cc: Ian Rogers <irogers@google.com>
    Cc: Mark Rutland <mark.rutland@arm.com>
    Cc: Michael Petlan <mpetlan@redhat.com>
    Cc: Namhyung Kim <namhyung@kernel.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Link: http://lore.kernel.org/lkml/20210508205020.617984-1-jolsa@kernel.org
    Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ac7825aa4fdad03016d6044df30d3c70d7967b12
Author: Zhen Lei <thunder.leizhen@huawei.com>
Date:   Sat May 8 10:19:13 2021 +0800

    xen/unpopulated-alloc: fix error return code in fill_list()
    
    [ Upstream commit dbc03e81586fc33e4945263fd6e09e22eb4b980f ]
    
    Fix to return a negative error code from the error handling case instead
    of 0, as done elsewhere in this function.
    
    Fixes: a4574f63edc6 ("mm/memremap_pages: convert to 'struct range'")
    Reported-by: Hulk Robot <hulkci@huawei.com>
    Signed-off-by: Zhen Lei <thunder.leizhen@huawei.com>
    Reviewed-by: Juergen Gross <jgross@suse.com>
    Link: https://lore.kernel.org/r/20210508021913.1727-1-thunder.leizhen@huawei.com
    Signed-off-by: Juergen Gross <jgross@suse.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 370f182d79717beef7731667a9e177ec0ddc8d7f
Author: Vivek Goyal <vgoyal@redhat.com>
Date:   Wed Apr 28 15:03:14 2021 -0400

    dax: Wake up all waiters after invalidating dax entry
    
    [ Upstream commit 237388320deffde7c2d65ed8fc9eef670dc979b3 ]
    
    I am seeing missed wakeups which ultimately lead to a deadlock when I am
    using virtiofs with DAX enabled and running "make -j". I had to mount
    virtiofs as rootfs and also reduce to dax window size to 256M to reproduce
    the problem consistently.
    
    So here is the problem. put_unlocked_entry() wakes up waiters only
    if entry is not null as well as !dax_is_conflict(entry). But if I
    call multiple instances of invalidate_inode_pages2() in parallel,
    then I can run into a situation where there are waiters on
    this index but nobody will wake these waiters.
    
    invalidate_inode_pages2()
      invalidate_inode_pages2_range()
        invalidate_exceptional_entry2()
          dax_invalidate_mapping_entry_sync()
            __dax_invalidate_entry() {
                    xas_lock_irq(&xas);
                    entry = get_unlocked_entry(&xas, 0);
                    ...
                    ...
                    dax_disassociate_entry(entry, mapping, trunc);
                    xas_store(&xas, NULL);
                    ...
                    ...
                    put_unlocked_entry(&xas, entry);
                    xas_unlock_irq(&xas);
            }
    
    Say a fault in in progress and it has locked entry at offset say "0x1c".
    Now say three instances of invalidate_inode_pages2() are in progress
    (A, B, C) and they all try to invalidate entry at offset "0x1c". Given
    dax entry is locked, all tree instances A, B, C will wait in wait queue.
    
    When dax fault finishes, say A is woken up. It will store NULL entry
    at index "0x1c" and wake up B. When B comes along it will find "entry=0"
    at page offset 0x1c and it will call put_unlocked_entry(&xas, 0). And
    this means put_unlocked_entry() will not wake up next waiter, given
    the current code. And that means C continues to wait and is not woken
    up.
    
    This patch fixes the issue by waking up all waiters when a dax entry
    has been invalidated. This seems to fix the deadlock I am facing
    and I can make forward progress.
    
    Reported-by: Sergio Lopez <slp@redhat.com>
    Fixes: ac401cc78242 ("dax: New fault locking")
    Reviewed-by: Jan Kara <jack@suse.cz>
    Suggested-by: Dan Williams <dan.j.williams@intel.com>
    Signed-off-by: Vivek Goyal <vgoyal@redhat.com>
    Link: https://lore.kernel.org/r/20210428190314.1865312-4-vgoyal@redhat.com
    Signed-off-by: Dan Williams <dan.j.williams@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 027f17d68079c40c6c84b321d8c079f30123e514
Author: Vivek Goyal <vgoyal@redhat.com>
Date:   Wed Apr 28 15:03:13 2021 -0400

    dax: Add a wakeup mode parameter to put_unlocked_entry()
    
    [ Upstream commit 4c3d043d271d4d629aa2328796cdfc96b37d3b3c ]
    
    As of now put_unlocked_entry() always wakes up next waiter. In next
    patches we want to wake up all waiters at one callsite. Hence, add a
    parameter to the function.
    
    This patch does not introduce any change of behavior.
    
    Reviewed-by: Greg Kurz <groug@kaod.org>
    Reviewed-by: Jan Kara <jack@suse.cz>
    Suggested-by: Dan Williams <dan.j.williams@intel.com>
    Signed-off-by: Vivek Goyal <vgoyal@redhat.com>
    Link: https://lore.kernel.org/r/20210428190314.1865312-3-vgoyal@redhat.com
    Signed-off-by: Dan Williams <dan.j.williams@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 9653df1358cb302c87117968ab4a9c0301e54097
Author: Vivek Goyal <vgoyal@redhat.com>
Date:   Wed Apr 28 15:03:12 2021 -0400

    dax: Add an enum for specifying dax wakup mode
    
    [ Upstream commit 698ab77aebffe08b312fbcdddeb0e8bd08b78717 ]
    
    Dan mentioned that he is not very fond of passing around a boolean true/false
    to specify if only next waiter should be woken up or all waiters should be
    woken up. He instead prefers that we introduce an enum and make it very
    explicity at the callsite itself. Easier to read code.
    
    This patch should not introduce any change of behavior.
    
    Reviewed-by: Greg Kurz <groug@kaod.org>
    Reviewed-by: Jan Kara <jack@suse.cz>
    Suggested-by: Dan Williams <dan.j.williams@intel.com>
    Signed-off-by: Vivek Goyal <vgoyal@redhat.com>
    Link: https://lore.kernel.org/r/20210428190314.1865312-2-vgoyal@redhat.com
    Signed-off-by: Dan Williams <dan.j.williams@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit e4638f7b7988dc7b4a06ccb9ba3bc6bd98160aea
Author: Thomas Gleixner <tglx@linutronix.de>
Date:   Thu May 6 15:21:37 2021 +0200

    KVM: x86: Prevent deadlock against tk_core.seq
    
    [ Upstream commit 3f804f6d201ca93adf4c3df04d1bfd152c1129d6 ]
    
    syzbot reported a possible deadlock in pvclock_gtod_notify():
    
    CPU 0                                       CPU 1
    write_seqcount_begin(&tk_core.seq);
      pvclock_gtod_notify()                     spin_lock(&pool->lock);
        queue_work(..., &pvclock_gtod_work)     ktime_get()
         spin_lock(&pool->lock);                  do {
                                                    seq = read_seqcount_begin(tk_core.seq)
                                                    ...
                                                  } while (read_seqcount_retry(&tk_core.seq, seq);
    
    While this is unlikely to happen, it's possible.
    
    Delegate queue_work() to irq_work() which postpones it until the
    tk_core.seq write held region is left and interrupts are reenabled.
    
    Fixes: 16e8d74d2da9 ("KVM: x86: notifier for clocksource changes")
    Reported-by: syzbot+6beae4000559d41d80f8@syzkaller.appspotmail.com
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Message-Id: <87h7jgm1zy.ffs@nanos.tec.linutronix.de>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 71479ab28b5ef62f206a66533bd0226f6c84f435
Author: Thomas Gleixner <tglx@linutronix.de>
Date:   Wed May 5 23:48:17 2021 +0200

    KVM: x86: Cancel pvclock_gtod_work on module removal
    
    [ Upstream commit 594b27e677b35f9734b1969d175ebc6146741109 ]
    
    Nothing prevents the following:
    
      pvclock_gtod_notify()
        queue_work(system_long_wq, &pvclock_gtod_work);
      ...
      remove_module(kvm);
      ...
      work_queue_run()
        pvclock_gtod_work() <- UAF
    
    Ditto for any other operation on that workqueue list head which touches
    pvclock_gtod_work after module removal.
    
    Cancel the work in kvm_arch_exit() to prevent that.
    
    Fixes: 16e8d74d2da9 ("KVM: x86: notifier for clocksource changes")
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Message-Id: <87czu4onry.ffs@nanos.tec.linutronix.de>
    Cc: stable@vger.kernel.org
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit eb3530837060e81f783281fb27957d75978dabb1
Author: Kuogee Hsieh <khsieh@codeaurora.org>
Date:   Wed Apr 21 16:37:36 2021 -0700

    drm/msm/dp: initialize audio_comp when audio starts
    
    [ Upstream commit f2f46b878777e0d3f885c7ddad48f477b4dea247 ]
    
    Initialize audio_comp when audio starts and wait for audio_comp at
    dp_display_disable(). This will take care of both dongle unplugged
    and display off (suspend) cases.
    
    Changes in v2:
    -- add dp_display_signal_audio_start()
    
    Changes in v3:
    -- restore dp_display_handle_plugged_change() at dp_hpd_unplug_handle().
    
    Changes in v4:
    -- none
    
    Signed-off-by: Kuogee Hsieh <khsieh@codeaurora.org>
    Reviewed-by: Stephen Boyd <swboyd@chromium.org>
    Tested-by: Stephen Boyd <swboyd@chromium.org>
    Fixes: c703d5789590 ("drm/msm/dp: trigger unplug event in msm_dp_display_disable")
    Link: https://lore.kernel.org/r/1619048258-8717-3-git-send-email-khsieh@codeaurora.org
    Signed-off-by: Rob Clark <robdclark@chromium.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d59b53f583fd788c89661ec84cb294735b831ccd
Author: Wanpeng Li <wanpengli@tencent.com>
Date:   Wed Apr 28 19:08:02 2021 +0800

    KVM: LAPIC: Accurately guarantee busy wait for timer to expire when using hv_timer
    
    [ Upstream commit d981dd15498b188636ec5a7d8ad485e650f63d8d ]
    
    Commit ee66e453db13d (KVM: lapic: Busy wait for timer to expire when
    using hv_timer) tries to set ktime->expired_tscdeadline by checking
    ktime->hv_timer_in_use since lapic timer oneshot/periodic modes which
    are emulated by vmx preemption timer also get advanced, they leverage
    the same vmx preemption timer logic with tsc-deadline mode. However,
    ktime->hv_timer_in_use is cleared before apic_timer_expired() handling,
    let's delay this clearing in preemption-disabled region.
    
    Fixes: ee66e453db13d ("KVM: lapic: Busy wait for timer to expire when using hv_timer")
    Reviewed-by: Sean Christopherson <seanjc@google.com>
    Signed-off-by: Wanpeng Li <wanpengli@tencent.com>
    Message-Id: <1619608082-4187-1-git-send-email-wanpengli@tencent.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c53f8654e39329c4bc7915985cdd150ff5295300
Author: Jonathan Marek <jonathan@marek.ca>
Date:   Fri Apr 23 21:49:26 2021 -0400

    drm/msm: fix LLC not being enabled for mmu500 targets
    
    [ Upstream commit 4b95d371fb001185af84d177e69a23d55bd0167a ]
    
    mmu500 targets don't have a "cx_mem" region, set llc_mmio to NULL in that
    case to avoid the IS_ERR() condition in a6xx_llc_activate().
    
    Fixes: 3d247123b5a1 ("drm/msm/a6xx: Add support for using system cache on MMU500 based targets")
    Signed-off-by: Jonathan Marek <jonathan@marek.ca>
    Link: https://lore.kernel.org/r/20210424014927.1661-1-jonathan@marek.ca
    Signed-off-by: Rob Clark <robdclark@chromium.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 905155b5c5fb8e2183e22fdc9ccea37701960dfc
Author: Benjamin Segall <bsegall@google.com>
Date:   Thu Apr 29 16:22:34 2021 +0000

    kvm: exit halt polling on need_resched() as well
    
    commit 262de4102c7bb8e59f26a967a8ffe8cce85cc537 upstream.
    
    single_task_running() is usually more general than need_resched()
    but CFS_BANDWIDTH throttling will use resched_task() when there
    is just one task to get the task to block. This was causing
    long-need_resched warnings and was likely allowing VMs to
    overrun their quota when halt polling.
    
    Signed-off-by: Ben Segall <bsegall@google.com>
    Signed-off-by: Venkatesh Srinivas <venkateshs@chromium.org>
    Message-Id: <20210429162233.116849-1-venkateshs@chromium.org>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Cc: stable@vger.kernel.org
    Reviewed-by: Jim Mattson <jmattson@google.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 542bc12f6c565239238bff90d28b38bfe6a5539b
Author: Ville Syrjälä <ville.syrjala@linux.intel.com>
Date:   Wed Apr 21 18:33:58 2021 +0300

    drm/i915: Avoid div-by-zero on gen2
    
    commit 4819d16d91145966ce03818a95169df1fd56b299 upstream.
    
    Gen2 tiles are 2KiB in size so i915_gem_object_get_tile_row_size()
    can in fact return <4KiB, which leads to div-by-zero here.
    Avoid that.
    
    Not sure i915_gem_object_get_tile_row_size() is entirely
    sane anyway since it doesn't account for the different tile
    layouts on i8xx/i915...
    
    I'm not able to hit this before commit 6846895fde05 ("drm/i915:
    Replace PIN_NONFAULT with calls to PIN_NOEVICT") and it looks
    like I also need to run recent version of Mesa. With those in
    place xonotic trips on this quite easily on my 85x.
    
    Cc: stable@vger.kernel.org
    Reviewed-by: Chris Wilson <chris@chris-wilson.co.uk>
    Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
    Link: https://patchwork.freedesktop.org/patch/msgid/20210421153401.13847-2-ville.syrjala@linux.intel.com
    (cherry picked from commit ed52c62d386f764194e0184fdb905d5f24194cae)
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 738d4417c87cb413fbf6662c59b559a77c338f3f
Author: David Ward <david.ward@gatech.edu>
Date:   Mon May 10 05:30:39 2021 -0400

    drm/amd/display: Initialize attribute for hdcp_srm sysfs file
    
    commit fe1c97d008f86f672f0e9265f180c22451ca3b9f upstream.
    
    It is stored in dynamically allocated memory, so sysfs_bin_attr_init() must
    be called to initialize it. (Note: "initialization" only sets the .attr.key
    member in this struct; it does not change the value of any other members.)
    
    Otherwise, when CONFIG_DEBUG_LOCK_ALLOC=y this message appears during boot:
    
        BUG: key ffff9248900cd148 has not been registered!
    
    Fixes: 9037246bb2da ("drm/amd/display: Add sysfs interface for set/get srm")
    Bug: https://gitlab.freedesktop.org/drm/amd/-/issues/1586
    Reported-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
    Signed-off-by: David Ward <david.ward@gatech.edu>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Cc: stable@vger.kernel.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 79b3d63a7bbba2d5cbb6c2e82d9c893856989b3a
Author: Kai-Heng Feng <kai.heng.feng@canonical.com>
Date:   Fri Apr 30 12:56:56 2021 +0800

    drm/radeon/dpm: Disable sclk switching on Oland when two 4K 60Hz monitors are connected
    
    commit 227545b9a08c68778ddd89428f99c351fc9315ac upstream.
    
    Screen flickers rapidly when two 4K 60Hz monitors are in use. This issue
    doesn't happen when one monitor is 4K 60Hz (pixelclock 594MHz) and
    another one is 4K 30Hz (pixelclock 297MHz).
    
    The issue is gone after setting "power_dpm_force_performance_level" to
    "high". Following the indication, we found that the issue occurs when
    sclk is too low.
    
    So resolve the issue by disabling sclk switching when there are two
    monitors requires high pixelclock (> 297MHz).
    
    v2:
     - Only apply the fix to Oland.
    Signed-off-by: Kai-Heng Feng <kai.heng.feng@canonical.com>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Cc: stable@vger.kernel.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 74780b32ce454dc0c1740fe0629f62ecb4dad2fc
Author: Filipe Manana <fdmanana@suse.com>
Date:   Tue Apr 27 11:27:20 2021 +0100

    btrfs: fix race leading to unpersisted data and metadata on fsync
    
    commit 626e9f41f7c281ba3e02843702f68471706aa6d9 upstream.
    
    When doing a fast fsync on a file, there is a race which can result in the
    fsync returning success to user space without logging the inode and without
    durably persisting new data.
    
    The following example shows one possible scenario for this:
    
       $ mkfs.btrfs -f /dev/sdc
       $ mount /dev/sdc /mnt
    
       $ touch /mnt/bar
       $ xfs_io -f -c "pwrite -S 0xab 0 1M" -c "fsync" /mnt/baz
    
       # Now we have:
       # file bar == inode 257
       # file baz == inode 258
    
       $ mv /mnt/baz /mnt/foo
    
       # Now we have:
       # file bar == inode 257
       # file foo == inode 258
    
       $ xfs_io -c "pwrite -S 0xcd 0 1M" /mnt/foo
    
       # fsync bar before foo, it is important to trigger the race.
       $ xfs_io -c "fsync" /mnt/bar
       $ xfs_io -c "fsync" /mnt/foo
    
       # After this:
       # inode 257, file bar, is empty
       # inode 258, file foo, has 1M filled with 0xcd
    
       <power failure>
    
       # Replay the log:
       $ mount /dev/sdc /mnt
    
       # After this point file foo should have 1M filled with 0xcd and not 0xab
    
    The following steps explain how the race happens:
    
    1) Before the first fsync of inode 258, when it has the "baz" name, its
       ->logged_trans is 0, ->last_sub_trans is 0 and ->last_log_commit is -1.
       The inode also has the full sync flag set;
    
    2) After the first fsync, we set inode 258 ->logged_trans to 6, which is
       the generation of the current transaction, and set ->last_log_commit
       to 0, which is the current value of ->last_sub_trans (done at
       btrfs_log_inode()).
    
       The full sync flag is cleared from the inode during the fsync.
    
       The log sub transaction that was committed had an ID of 0 and when we
       synced the log, at btrfs_sync_log(), we incremented root->log_transid
       from 0 to 1;
    
    3) During the rename:
    
       We update inode 258, through btrfs_update_inode(), and that causes its
       ->last_sub_trans to be set to 1 (the current log transaction ID), and
       ->last_log_commit remains with a value of 0.
    
       After updating inode 258, because we have previously logged the inode
       in the previous fsync, we log again the inode through the call to
       btrfs_log_new_name(). This results in updating the inode's
       ->last_log_commit from 0 to 1 (the current value of its
       ->last_sub_trans).
    
       The ->last_sub_trans of inode 257 is updated to 1, which is the ID of
       the next log transaction;
    
    4) Then a buffered write against inode 258 is made. This leaves the value
       of ->last_sub_trans as 1 (the ID of the current log transaction, stored
       at root->log_transid);
    
    5) Then an fsync against inode 257 (or any other inode other than 258),
       happens. This results in committing the log transaction with ID 1,
       which results in updating root->last_log_commit to 1 and bumping
       root->log_transid from 1 to 2;
    
    6) Then an fsync against inode 258 starts. We flush delalloc and wait only
       for writeback to complete, since the full sync flag is not set in the
       inode's runtime flags - we do not wait for ordered extents to complete.
    
       Then, at btrfs_sync_file(), we call btrfs_inode_in_log() before the
       ordered extent completes. The call returns true:
    
         static inline bool btrfs_inode_in_log(...)
         {
             bool ret = false;
    
             spin_lock(&inode->lock);
             if (inode->logged_trans == generation &&
                 inode->last_sub_trans <= inode->last_log_commit &&
                 inode->last_sub_trans <= inode->root->last_log_commit)
                     ret = true;
             spin_unlock(&inode->lock);
             return ret;
         }
    
       generation has a value of 6 (fs_info->generation), ->logged_trans also
       has a value of 6 (set when we logged the inode during the first fsync
       and when logging it during the rename), ->last_sub_trans has a value
       of 1, set during the rename (step 3), ->last_log_commit also has a
       value of 1 (set in step 3) and root->last_log_commit has a value of 1,
       which was set in step 5 when fsyncing inode 257.
    
       As a consequence we don't log the inode, any new extents and do not
       sync the log, resulting in a data loss if a power failure happens
       after the fsync and before the current transaction commits.
       Also, because we do not log the inode, after a power failure the mtime
       and ctime of the inode do not match those we had before.
    
       When the ordered extent completes before we call btrfs_inode_in_log(),
       then the call returns false and we log the inode and sync the log,
       since at the end of ordered extent completion we update the inode and
       set ->last_sub_trans to 2 (the value of root->log_transid) and
       ->last_log_commit to 1.
    
    This problem is found after removing the check for the emptiness of the
    inode's list of modified extents in the recent commit 209ecbb8585bf6
    ("btrfs: remove stale comment and logic from btrfs_inode_in_log()"),
    added in the 5.13 merge window. However checking the emptiness of the
    list is not really the way to solve this problem, and was never intended
    to, because while that solves the problem for COW writes, the problem
    persists for NOCOW writes because in that case the list is always empty.
    
    In the case of NOCOW writes, even though we wait for the writeback to
    complete before returning from btrfs_sync_file(), we end up not logging
    the inode, which has a new mtime/ctime, and because we don't sync the log,
    we never issue disk barriers (send REQ_PREFLUSH to the device) since that
    only happens when we sync the log (when we write super blocks at
    btrfs_sync_log()). So effectively, for a NOCOW case, when we return from
    btrfs_sync_file() to user space, we are not guaranteeing that the data is
    durably persisted on disk.
    
    Also, while the example above uses a rename exchange to show how the
    problem happens, it is not the only way to trigger it. An alternative
    could be adding a new hard link to inode 258, since that also results
    in calling btrfs_log_new_name() and updating the inode in the log.
    An example reproducer using the addition of a hard link instead of a
    rename operation:
    
      $ mkfs.btrfs -f /dev/sdc
      $ mount /dev/sdc /mnt
    
      $ touch /mnt/bar
      $ xfs_io -f -c "pwrite -S 0xab 0 1M" -c "fsync" /mnt/foo
    
      $ ln /mnt/foo /mnt/foo_link
      $ xfs_io -c "pwrite -S 0xcd 0 1M" /mnt/foo
    
      $ xfs_io -c "fsync" /mnt/bar
      $ xfs_io -c "fsync" /mnt/foo
    
      <power failure>
    
      # Replay the log:
      $ mount /dev/sdc /mnt
    
      # After this point file foo often has 1M filled with 0xab and not 0xcd
    
    The reasons leading to the final fsync of file foo, inode 258, not
    persisting the new data are the same as for the previous example with
    a rename operation.
    
    So fix by never skipping logging and log syncing when there are still any
    ordered extents in flight. To avoid making the conditional if statement
    that checks if logging an inode is needed harder to read, place all the
    logic into an helper function with separate if statements to make it more
    manageable and easier to read.
    
    A test case for fstests will follow soon.
    
    For NOCOW writes, the problem existed before commit b5e6c3e170b770
    ("btrfs: always wait on ordered extents at fsync time"), introduced in
    kernel 4.19, then it went away with that commit since we started to always
    wait for ordered extent completion before logging.
    
    The problem came back again once the fast fsync path was changed again to
    avoid waiting for ordered extent completion, in commit 487781796d3022
    ("btrfs: make fast fsyncs wait only for writeback"), added in kernel 5.10.
    
    However, for COW writes, the race only happens after the recent
    commit 209ecbb8585bf6 ("btrfs: remove stale comment and logic from
    btrfs_inode_in_log()"), introduced in the 5.13 merge window. For NOCOW
    writes, the bug existed before that commit. So tag 5.10+ as the release
    for stable backports.
    
    CC: stable@vger.kernel.org # 5.10+
    Signed-off-by: Filipe Manana <fdmanana@suse.com>
    Signed-off-by: David Sterba <dsterba@suse.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d5347827d0b4b2250cbce6eccaa1c81dc78d8651
Author: Filipe Manana <fdmanana@suse.com>
Date:   Thu Apr 22 12:08:05 2021 +0100

    btrfs: fix deadlock when cloning inline extents and using qgroups
    
    commit f9baa501b4fd6962257853d46ddffbc21f27e344 upstream.
    
    There are a few exceptional cases where cloning an inline extent needs to
    copy the inline extent data into a page of the destination inode.
    
    When this happens, we end up starting a transaction while having a dirty
    page for the destination inode and while having the range locked in the
    destination's inode iotree too. Because when reserving metadata space
    for a transaction we may need to flush existing delalloc in case there is
    not enough free space, we have a mechanism in place to prevent a deadlock,
    which was introduced in commit 3d45f221ce627d ("btrfs: fix deadlock when
    cloning inline extent and low on free metadata space").
    
    However when using qgroups, a transaction also reserves metadata qgroup
    space, which can also result in flushing delalloc in case there is not
    enough available space at the moment. When this happens we deadlock, since
    flushing delalloc requires locking the file range in the inode's iotree
    and the range was already locked at the very beginning of the clone
    operation, before attempting to start the transaction.
    
    When this issue happens, stack traces like the following are reported:
    
      [72747.556262] task:kworker/u81:9   state:D stack:    0 pid:  225 ppid:     2 flags:0x00004000
      [72747.556268] Workqueue: writeback wb_workfn (flush-btrfs-1142)
      [72747.556271] Call Trace:
      [72747.556273]  __schedule+0x296/0x760
      [72747.556277]  schedule+0x3c/0xa0
      [72747.556279]  io_schedule+0x12/0x40
      [72747.556284]  __lock_page+0x13c/0x280
      [72747.556287]  ? generic_file_readonly_mmap+0x70/0x70
      [72747.556325]  extent_write_cache_pages+0x22a/0x440 [btrfs]
      [72747.556331]  ? __set_page_dirty_nobuffers+0xe7/0x160
      [72747.556358]  ? set_extent_buffer_dirty+0x5e/0x80 [btrfs]
      [72747.556362]  ? update_group_capacity+0x25/0x210
      [72747.556366]  ? cpumask_next_and+0x1a/0x20
      [72747.556391]  extent_writepages+0x44/0xa0 [btrfs]
      [72747.556394]  do_writepages+0x41/0xd0
      [72747.556398]  __writeback_single_inode+0x39/0x2a0
      [72747.556403]  writeback_sb_inodes+0x1ea/0x440
      [72747.556407]  __writeback_inodes_wb+0x5f/0xc0
      [72747.556410]  wb_writeback+0x235/0x2b0
      [72747.556414]  ? get_nr_inodes+0x35/0x50
      [72747.556417]  wb_workfn+0x354/0x490
      [72747.556420]  ? newidle_balance+0x2c5/0x3e0
      [72747.556424]  process_one_work+0x1aa/0x340
      [72747.556426]  worker_thread+0x30/0x390
      [72747.556429]  ? create_worker+0x1a0/0x1a0
      [72747.556432]  kthread+0x116/0x130
      [72747.556435]  ? kthread_park+0x80/0x80
      [72747.556438]  ret_from_fork+0x1f/0x30
    
      [72747.566958] Workqueue: btrfs-flush_delalloc btrfs_work_helper [btrfs]
      [72747.566961] Call Trace:
      [72747.566964]  __schedule+0x296/0x760
      [72747.566968]  ? finish_wait+0x80/0x80
      [72747.566970]  schedule+0x3c/0xa0
      [72747.566995]  wait_extent_bit.constprop.68+0x13b/0x1c0 [btrfs]
      [72747.566999]  ? finish_wait+0x80/0x80
      [72747.567024]  lock_extent_bits+0x37/0x90 [btrfs]
      [72747.567047]  btrfs_invalidatepage+0x299/0x2c0 [btrfs]
      [72747.567051]  ? find_get_pages_range_tag+0x2cd/0x380
      [72747.567076]  __extent_writepage+0x203/0x320 [btrfs]
      [72747.567102]  extent_write_cache_pages+0x2bb/0x440 [btrfs]
      [72747.567106]  ? update_load_avg+0x7e/0x5f0
      [72747.567109]  ? enqueue_entity+0xf4/0x6f0
      [72747.567134]  extent_writepages+0x44/0xa0 [btrfs]
      [72747.567137]  ? enqueue_task_fair+0x93/0x6f0
      [72747.567140]  do_writepages+0x41/0xd0
      [72747.567144]  __filemap_fdatawrite_range+0xc7/0x100
      [72747.567167]  btrfs_run_delalloc_work+0x17/0x40 [btrfs]
      [72747.567195]  btrfs_work_helper+0xc2/0x300 [btrfs]
      [72747.567200]  process_one_work+0x1aa/0x340
      [72747.567202]  worker_thread+0x30/0x390
      [72747.567205]  ? create_worker+0x1a0/0x1a0
      [72747.567208]  kthread+0x116/0x130
      [72747.567211]  ? kthread_park+0x80/0x80
      [72747.567214]  ret_from_fork+0x1f/0x30
    
      [72747.569686] task:fsstress        state:D stack:    0 pid:841421 ppid:841417 flags:0x00000000
      [72747.569689] Call Trace:
      [72747.569691]  __schedule+0x296/0x760
      [72747.569694]  schedule+0x3c/0xa0
      [72747.569721]  try_flush_qgroup+0x95/0x140 [btrfs]
      [72747.569725]  ? finish_wait+0x80/0x80
      [72747.569753]  btrfs_qgroup_reserve_data+0x34/0x50 [btrfs]
      [72747.569781]  btrfs_check_data_free_space+0x5f/0xa0 [btrfs]
      [72747.569804]  btrfs_buffered_write+0x1f7/0x7f0 [btrfs]
      [72747.569810]  ? path_lookupat.isra.48+0x97/0x140
      [72747.569833]  btrfs_file_write_iter+0x81/0x410 [btrfs]
      [72747.569836]  ? __kmalloc+0x16a/0x2c0
      [72747.569839]  do_iter_readv_writev+0x160/0x1c0
      [72747.569843]  do_iter_write+0x80/0x1b0
      [72747.569847]  vfs_writev+0x84/0x140
      [72747.569869]  ? btrfs_file_llseek+0x38/0x270 [btrfs]
      [72747.569873]  do_writev+0x65/0x100
      [72747.569876]  do_syscall_64+0x33/0x40
      [72747.569879]  entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
      [72747.569899] task:fsstress        state:D stack:    0 pid:841424 ppid:841417 flags:0x00004000
      [72747.569903] Call Trace:
      [72747.569906]  __schedule+0x296/0x760
      [72747.569909]  schedule+0x3c/0xa0
      [72747.569936]  try_flush_qgroup+0x95/0x140 [btrfs]
      [72747.569940]  ? finish_wait+0x80/0x80
      [72747.569967]  __btrfs_qgroup_reserve_meta+0x36/0x50 [btrfs]
      [72747.569989]  start_transaction+0x279/0x580 [btrfs]
      [72747.570014]  clone_copy_inline_extent+0x332/0x490 [btrfs]
      [72747.570041]  btrfs_clone+0x5b7/0x7a0 [btrfs]
      [72747.570068]  ? lock_extent_bits+0x64/0x90 [btrfs]
      [72747.570095]  btrfs_clone_files+0xfc/0x150 [btrfs]
      [72747.570122]  btrfs_remap_file_range+0x3d8/0x4a0 [btrfs]
      [72747.570126]  do_clone_file_range+0xed/0x200
      [72747.570131]  vfs_clone_file_range+0x37/0x110
      [72747.570134]  ioctl_file_clone+0x7d/0xb0
      [72747.570137]  do_vfs_ioctl+0x138/0x630
      [72747.570140]  __x64_sys_ioctl+0x62/0xc0
      [72747.570143]  do_syscall_64+0x33/0x40
      [72747.570146]  entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    So fix this by skipping the flush of delalloc for an inode that is
    flagged with BTRFS_INODE_NO_DELALLOC_FLUSH, meaning it is currently under
    such a special case of cloning an inline extent, when flushing delalloc
    during qgroup metadata reservation.
    
    The special cases for cloning inline extents were added in kernel 5.7 by
    by commit 05a5a7621ce66c ("Btrfs: implement full reflink support for
    inline extents"), while having qgroup metadata space reservation flushing
    delalloc when low on space was added in kernel 5.9 by commit
    c53e9653605dbf ("btrfs: qgroup: try to flush qgroup space when we get
    -EDQUOT"). So use a "Fixes:" tag for the later commit to ease stable
    kernel backports.
    
    Reported-by: Wang Yugui <wangyugui@e16-tech.com>
    Link: https://lore.kernel.org/linux-btrfs/20210421083137.31E3.409509F4@e16-tech.com/
    Fixes: c53e9653605dbf ("btrfs: qgroup: try to flush qgroup space when we get -EDQUOT")
    CC: stable@vger.kernel.org # 5.9+
    Reviewed-by: Qu Wenruo <wqu@suse.com>
    Signed-off-by: Filipe Manana <fdmanana@suse.com>
    Reviewed-by: David Sterba <dsterba@suse.com>
    Signed-off-by: David Sterba <dsterba@suse.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 637d15e2998a421fcc0db4829db5a6e47b070401
Author: Catalin Marinas <catalin.marinas@arm.com>
Date:   Fri May 14 10:50:01 2021 +0100

    arm64: Fix race condition on PG_dcache_clean in __sync_icache_dcache()
    
    commit 588a513d34257fdde95a9f0df0202e31998e85c6 upstream.
    
    To ensure that instructions are observable in a new mapping, the arm64
    set_pte_at() implementation cleans the D-cache and invalidates the
    I-cache to the PoU. As an optimisation, this is only done on executable
    mappings and the PG_dcache_clean page flag is set to avoid future cache
    maintenance on the same page.
    
    When two different processes map the same page (e.g. private executable
    file or shared mapping) there's a potential race on checking and setting
    PG_dcache_clean via set_pte_at() -> __sync_icache_dcache(). While on the
    fault paths the page is locked (PG_locked), mprotect() does not take the
    page lock. The result is that one process may see the PG_dcache_clean
    flag set but the I/D cache maintenance not yet performed.
    
    Avoid test_and_set_bit(PG_dcache_clean) in favour of separate test_bit()
    and set_bit(). In the rare event of a race, the cache maintenance is
    done twice.
    
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Cc: <stable@vger.kernel.org>
    Cc: Will Deacon <will@kernel.org>
    Cc: Steven Price <steven.price@arm.com>
    Reviewed-by: Steven Price <steven.price@arm.com>
    Acked-by: Will Deacon <will@kernel.org>
    Link: https://lore.kernel.org/r/20210514095001.13236-1-catalin.marinas@arm.com
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4b0f04c9151aad7bc78981131abf6480389714f4
Author: Peter Collingbourne <pcc@google.com>
Date:   Fri May 7 11:59:05 2021 -0700

    arm64: mte: initialize RGSR_EL1.SEED in __cpu_setup
    
    commit 37a8024d265564eba680575df6421f19db21dfce upstream.
    
    A valid implementation choice for the ChooseRandomNonExcludedTag()
    pseudocode function used by IRG is to behave in the same way as with
    GCR_EL1.RRND=0. This would mean that RGSR_EL1.SEED is used as an LFSR
    which must have a non-zero value in order for IRG to properly produce
    pseudorandom numbers. However, RGSR_EL1 is reset to an UNKNOWN value
    on soft reset and thus may reset to 0. Therefore we must initialize
    RGSR_EL1.SEED to a non-zero value in order to ensure that IRG behaves
    as expected.
    
    Signed-off-by: Peter Collingbourne <pcc@google.com>
    Fixes: 3b714d24ef17 ("arm64: mte: CPU feature detection and initial sysreg configuration")
    Cc: <stable@vger.kernel.org> # 5.10
    Link: https://linux-review.googlesource.com/id/I2b089b6c7d6f17ee37e2f0db7df5ad5bcc04526c
    Acked-by: Mark Rutland <mark.rutland@arm.com>
    Link: https://lore.kernel.org/r/20210507185905.1745402-1-pcc@google.com
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3478004851573da1dd48549c65526f19456f3126
Author: Huang Rui <ray.huang@amd.com>
Date:   Sun Apr 25 15:34:51 2021 +0800

    x86, sched: Fix the AMD CPPC maximum performance value on certain AMD Ryzen generations
    
    commit 3743d55b289c203d8f77b7cd47c24926b9d186ae upstream.
    
    Some AMD Ryzen generations has different calculation method on maximum
    performance. 255 is not for all ASICs, some specific generations should use 166
    as the maximum performance. Otherwise, it will report incorrect frequency value
    like below:
    
      ~ → lscpu | grep MHz
      CPU MHz:                         3400.000
      CPU max MHz:                     7228.3198
      CPU min MHz:                     2200.0000
    
    [ mingo: Tidied up whitespace use. ]
    [ Alexander Monakov <amonakov@ispras.ru>: fix 225 -> 255 typo. ]
    
    Fixes: 41ea667227ba ("x86, sched: Calculate frequency invariance for AMD systems")
    Fixes: 3c55e94c0ade ("cpufreq: ACPI: Extend frequency tables to cover boost frequencies")
    Reported-by: Jason Bagavatsingham <jason.bagavatsingham@gmail.com>
    Fixed-by: Alexander Monakov <amonakov@ispras.ru>
    Reviewed-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Huang Rui <ray.huang@amd.com>
    Signed-off-by: Ingo Molnar <mingo@kernel.org>
    Tested-by: Jason Bagavatsingham <jason.bagavatsingham@gmail.com>
    Cc: stable@vger.kernel.org
    Link: https://lore.kernel.org/r/20210425073451.2557394-1-ray.huang@amd.com
    Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=211791
    Signed-off-by: Ingo Molnar <mingo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0df9ad4878d6016ad686ae064ad73bc26fca66df
Author: Tejun Heo <tj@kernel.org>
Date:   Tue May 11 21:38:36 2021 -0400

    blk-iocost: fix weight updates of inner active iocgs
    
    commit e9f4eee9a0023ba22db9560d4cc6ee63f933dae8 upstream.
    
    When the weight of an active iocg is updated, weight_updated() is called
    which in turn calls __propagate_weights() to update the active and inuse
    weights so that the effective hierarchical weights are update accordingly.
    
    The current implementation is incorrect for inner active nodes. For an
    active leaf iocg, inuse can be any value between 1 and active and the
    difference represents how much the iocg is donating. When weight is updated,
    as long as inuse is clamped between 1 and the new weight, we're alright and
    this is what __propagate_weights() currently implements.
    
    However, that's not how an active inner node's inuse is set. An inner node's
    inuse is solely determined by the ratio between the sums of inuse's and
    active's of its children - ie. they're results of propagating the leaves'
    active and inuse weights upwards. __propagate_weights() incorrectly applies
    the same clamping as for a leaf when an active inner node's weight is
    updated. Consider a hierarchy which looks like the following with saturating
    workloads in AA and BB.
    
         R
       /   \
      A     B
      |     |
     AA     BB
    
    1. For both A and B, active=100, inuse=100, hwa=0.5, hwi=0.5.
    
    2. echo 200 > A/io.weight
    
    3. __propagate_weights() update A's active to 200 and leave inuse at 100 as
       it's already between 1 and the new active, making A:active=200,
       A:inuse=100. As R's active_sum is updated along with A's active,
       A:hwa=2/3, B:hwa=1/3. However, because the inuses didn't change, the
       hwi's remain unchanged at 0.5.
    
    4. The weight of A is now twice that of B but AA and BB still have the same
       hwi of 0.5 and thus are doing the same amount of IOs.
    
    Fix it by making __propgate_weights() always calculate the inuse of an
    active inner iocg based on the ratio of child_inuse_sum to child_active_sum.
    
    Signed-off-by: Tejun Heo <tj@kernel.org>
    Reported-by: Dan Schatzberg <dschatzberg@fb.com>
    Fixes: 7caa47151ab2 ("blkcg: implement blk-iocost")
    Cc: stable@vger.kernel.org # v5.4+
    Link: https://lore.kernel.org/r/YJsxnLZV1MnBcqjj@slm.duckdns.org
    Signed-off-by: Jens Axboe <axboe@kernel.dk>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4cccaa01c61a70619a5b2523641d065d7901fc98
Author: Peter Xu <peterx@redhat.com>
Date:   Fri May 14 17:27:04 2021 -0700

    mm/hugetlb: fix F_SEAL_FUTURE_WRITE
    
    commit 22247efd822e6d263f3c8bd327f3f769aea9b1d9 upstream.
    
    Patch series "mm/hugetlb: Fix issues on file sealing and fork", v2.
    
    Hugh reported issue with F_SEAL_FUTURE_WRITE not applied correctly to
    hugetlbfs, which I can easily verify using the memfd_test program, which
    seems that the program is hardly run with hugetlbfs pages (as by default
    shmem).
    
    Meanwhile I found another probably even more severe issue on that hugetlb
    fork won't wr-protect child cow pages, so child can potentially write to
    parent private pages.  Patch 2 addresses that.
    
    After this series applied, "memfd_test hugetlbfs" should start to pass.
    
    This patch (of 2):
    
    F_SEAL_FUTURE_WRITE is missing for hugetlb starting from the first day.
    There is a test program for that and it fails constantly.
    
    $ ./memfd_test hugetlbfs
    memfd-hugetlb: CREATE
    memfd-hugetlb: BASIC
    memfd-hugetlb: SEAL-WRITE
    memfd-hugetlb: SEAL-FUTURE-WRITE
    mmap() didn't fail as expected
    Aborted (core dumped)
    
    I think it's probably because no one is really running the hugetlbfs test.
    
    Fix it by checking FUTURE_WRITE also in hugetlbfs_file_mmap() as what we
    do in shmem_mmap().  Generalize a helper for that.
    
    Link: https://lkml.kernel.org/r/20210503234356.9097-1-peterx@redhat.com
    Link: https://lkml.kernel.org/r/20210503234356.9097-2-peterx@redhat.com
    Fixes: ab3948f58ff84 ("mm/memfd: add an F_SEAL_FUTURE_WRITE seal to memfd")
    Signed-off-by: Peter Xu <peterx@redhat.com>
    Reported-by: Hugh Dickins <hughd@google.com>
    Reviewed-by: Mike Kravetz <mike.kravetz@oracle.com>
    Cc: Joel Fernandes (Google) <joel@joelfernandes.org>
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 43c380523b2a6694d2767e61601c5b172017d41a
Author: Peter Collingbourne <pcc@google.com>
Date:   Fri May 14 17:27:27 2021 -0700

    kasan: fix unit tests with CONFIG_UBSAN_LOCAL_BOUNDS enabled
    
    commit f649dc0e0d7b509c75570ee403723660f5b72ec7 upstream.
    
    These tests deliberately access these arrays out of bounds, which will
    cause the dynamic local bounds checks inserted by
    CONFIG_UBSAN_LOCAL_BOUNDS to fail and panic the kernel.  To avoid this
    problem, access the arrays via volatile pointers, which will prevent the
    compiler from being able to determine the array bounds.
    
    These accesses use volatile pointers to char (char *volatile) rather than
    the more conventional pointers to volatile char (volatile char *) because
    we want to prevent the compiler from making inferences about the pointer
    itself (i.e.  its array bounds), not the data that it refers to.
    
    Link: https://lkml.kernel.org/r/20210507025915.1464056-1-pcc@google.com
    Link: https://linux-review.googlesource.com/id/I90b1713fbfa1bf68ff895aef099ea77b98a7c3b9
    Signed-off-by: Peter Collingbourne <pcc@google.com>
    Tested-by: Alexander Potapenko <glider@google.com>
    Reviewed-by: Andrey Konovalov <andreyknvl@gmail.com>
    Cc: Peter Collingbourne <pcc@google.com>
    Cc: George Popescu <georgepope@android.com>
    Cc: Elena Petrova <lenaptr@google.com>
    Cc: Evgenii Stepanov <eugenis@google.com>
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ad53127973034c63b5348715a1043d0e80ceb330
Author: Axel Rasmussen <axelrasmussen@google.com>
Date:   Fri May 14 17:27:19 2021 -0700

    userfaultfd: release page in error path to avoid BUG_ON
    
    commit 7ed9d238c7dbb1fdb63ad96a6184985151b0171c upstream.
    
    Consider the following sequence of events:
    
    1. Userspace issues a UFFD ioctl, which ends up calling into
       shmem_mfill_atomic_pte(). We successfully account the blocks, we
       shmem_alloc_page(), but then the copy_from_user() fails. We return
       -ENOENT. We don't release the page we allocated.
    2. Our caller detects this error code, tries the copy_from_user() after
       dropping the mmap_lock, and retries, calling back into
       shmem_mfill_atomic_pte().
    3. Meanwhile, let's say another process filled up the tmpfs being used.
    4. So shmem_mfill_atomic_pte() fails to account blocks this time, and
       immediately returns - without releasing the page.
    
    This triggers a BUG_ON in our caller, which asserts that the page
    should always be consumed, unless -ENOENT is returned.
    
    To fix this, detect if we have such a "dangling" page when accounting
    fails, and if so, release it before returning.
    
    Link: https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen@google.com
    Fixes: cb658a453b93 ("userfaultfd: shmem: avoid leaking blocks and used blocks in UFFDIO_COPY")
    Signed-off-by: Axel Rasmussen <axelrasmussen@google.com>
    Reported-by: Hugh Dickins <hughd@google.com>
    Acked-by: Hugh Dickins <hughd@google.com>
    Reviewed-by: Peter Xu <peterx@redhat.com>
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 204dd74b9933e6cbf91dfb7e6d11ce8737ac82e1
Author: Phillip Lougher <phillip@squashfs.org.uk>
Date:   Fri May 14 17:27:16 2021 -0700

    squashfs: fix divide error in calculate_skip()
    
    commit d6e621de1fceb3b098ebf435ef7ea91ec4838a1a upstream.
    
    Sysbot has reported a "divide error" which has been identified as being
    caused by a corrupted file_size value within the file inode.  This value
    has been corrupted to a much larger value than expected.
    
    Calculate_skip() is passed i_size_read(inode) >> msblk->block_log.  Due to
    the file_size value corruption this overflows the int argument/variable in
    that function, leading to the divide error.
    
    This patch changes the function to use u64.  This will accommodate any
    unexpectedly large values due to corruption.
    
    The value returned from calculate_skip() is clamped to be never more than
    SQUASHFS_CACHED_BLKS - 1, or 7.  So file_size corruption does not lead to
    an unexpectedly large return result here.
    
    Link: https://lkml.kernel.org/r/20210507152618.9447-1-phillip@squashfs.org.uk
    Signed-off-by: Phillip Lougher <phillip@squashfs.org.uk>
    Reported-by: <syzbot+e8f781243ce16ac2f962@syzkaller.appspotmail.com>
    Reported-by: <syzbot+7b98870d4fec9447b951@syzkaller.appspotmail.com>
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c477f62db1a0c0ecaa60a29713006ceeeb04b685
Author: Jouni Roivas <jouni.roivas@tuxera.com>
Date:   Fri May 14 17:27:33 2021 -0700

    hfsplus: prevent corruption in shrinking truncate
    
    commit c3187cf32216313fb316084efac4dab3a8459b1d upstream.
    
    I believe there are some issues introduced by commit 31651c607151
    ("hfsplus: avoid deadlock on file truncation")
    
    HFS+ has extent records which always contains 8 extents.  In case the
    first extent record in catalog file gets full, new ones are allocated from
    extents overflow file.
    
    In case shrinking truncate happens to middle of an extent record which
    locates in extents overflow file, the logic in hfsplus_file_truncate() was
    changed so that call to hfs_brec_remove() is not guarded any more.
    
    Right action would be just freeing the extents that exceed the new size
    inside extent record by calling hfsplus_free_extents(), and then check if
    the whole extent record should be removed.  However since the guard
    (blk_cnt > start) is now after the call to hfs_brec_remove(), this has
    unfortunate effect that the last matching extent record is removed
    unconditionally.
    
    To reproduce this issue, create a file which has at least 10 extents, and
    then perform shrinking truncate into middle of the last extent record, so
    that the number of remaining extents is not under or divisible by 8.  This
    causes the last extent record (8 extents) to be removed totally instead of
    truncating into middle of it.  Thus this causes corruption, and lost data.
    
    Fix for this is simply checking if the new truncated end is below the
    start of this extent record, making it safe to remove the full extent
    record.  However call to hfs_brec_remove() can't be moved to it's previous
    place since we're dropping ->tree_lock and it can cause a race condition
    and the cached info being invalidated possibly corrupting the node data.
    
    Another issue is related to this one.  When entering into the block
    (blk_cnt > start) we are not holding the ->tree_lock.  We break out from
    the loop not holding the lock, but hfs_find_exit() does unlock it.  Not
    sure if it's possible for someone else to take the lock under our feet,
    but it can cause hard to debug errors and premature unlocking.  Even if
    there's no real risk of it, the locking should still always be kept in
    balance.  Thus taking the lock now just before the check.
    
    Link: https://lkml.kernel.org/r/20210429165139.3082828-1-jouni.roivas@tuxera.com
    Fixes: 31651c607151f ("hfsplus: avoid deadlock on file truncation")
    Signed-off-by: Jouni Roivas <jouni.roivas@tuxera.com>
    Reviewed-by: Anton Altaparmakov <anton@tuxera.com>
    Cc: Anatoly Trosinenko <anatoly.trosinenko@gmail.com>
    Cc: Viacheslav Dubeyko <slava@dubeyko.com>
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dd0d6117052faace5440db20fc37175efe921c7d
Author: Michael Ellerman <mpe@ellerman.id.au>
Date:   Thu May 6 14:49:59 2021 +1000

    powerpc/64s: Fix crashes when toggling entry flush barrier
    
    commit aec86b052df6541cc97c5fca44e5934cbea4963b upstream.
    
    The entry flush mitigation can be enabled/disabled at runtime via a
    debugfs file (entry_flush), which causes the kernel to patch itself to
    enable/disable the relevant mitigations.
    
    However depending on which mitigation we're using, it may not be safe to
    do that patching while other CPUs are active. For example the following
    crash:
    
      sleeper[15639]: segfault (11) at c000000000004c20 nip c000000000004c20 lr c000000000004c20
    
    Shows that we returned to userspace with a corrupted LR that points into
    the kernel, due to executing the partially patched call to the fallback
    entry flush (ie. we missed the LR restore).
    
    Fix it by doing the patching under stop machine. The CPUs that aren't
    doing the patching will be spinning in the core of the stop machine
    logic. That is currently sufficient for our purposes, because none of
    the patching we do is to that code or anywhere in the vicinity.
    
    Fixes: f79643787e0a ("powerpc/64s: flush L1D on kernel entry")
    Cc: stable@vger.kernel.org # v5.10+
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Link: https://lore.kernel.org/r/20210506044959.1298123-2-mpe@ellerman.id.au
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3ee7c54977600dfc63d1e7a61c7c234ad251d066
Author: Michael Ellerman <mpe@ellerman.id.au>
Date:   Thu May 6 14:49:58 2021 +1000

    powerpc/64s: Fix crashes when toggling stf barrier
    
    commit 8ec7791bae1327b1c279c5cd6e929c3b12daaf0a upstream.
    
    The STF (store-to-load forwarding) barrier mitigation can be
    enabled/disabled at runtime via a debugfs file (stf_barrier), which
    causes the kernel to patch itself to enable/disable the relevant
    mitigations.
    
    However depending on which mitigation we're using, it may not be safe to
    do that patching while other CPUs are active. For example the following
    crash:
    
      User access of kernel address (c00000003fff5af0) - exploit attempt? (uid: 0)
      segfault (11) at c00000003fff5af0 nip 7fff8ad12198 lr 7fff8ad121f8 code 1
      code: 40820128 e93c00d0 e9290058 7c292840 40810058 38600000 4bfd9a81 e8410018
      code: 2c030006 41810154 3860ffb6 e9210098 <e94d8ff0> 7d295279 39400000 40820a3c
    
    Shows that we returned to userspace without restoring the user r13
    value, due to executing the partially patched STF exit code.
    
    Fix it by doing the patching under stop machine. The CPUs that aren't
    doing the patching will be spinning in the core of the stop machine
    logic. That is currently sufficient for our purposes, because none of
    the patching we do is to that code or anywhere in the vicinity.
    
    Fixes: a048a07d7f45 ("powerpc/64s: Add support for a store forwarding barrier at kernel entry/exit")
    Cc: stable@vger.kernel.org # v4.17+
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Link: https://lore.kernel.org/r/20210506044959.1298123-1-mpe@ellerman.id.au
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 197d2f8c69d7e879e7ebd4dba5af60ad3595dd1e
Author: Eric Dumazet <edumazet@google.com>
Date:   Wed Apr 14 10:05:17 2021 -0700

    sh: Remove unused variable
    
    commit 0d3ae948741ac6d80e39ab27b45297367ee477de upstream.
    
    Removes this annoying warning:
    
    arch/sh/kernel/traps.c: In function ‘nmi_trap_handler’:
    arch/sh/kernel/traps.c:183:15: warning: unused variable ‘cpu’ [-Wunused-variable]
      183 |  unsigned int cpu = smp_processor_id();
    
    Fixes: fe3f1d5d7cd3 ("sh: Get rid of nmi_count()")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Cc: stable@vger.kernel.org
    Link: https://lore.kernel.org/r/20210414170517.1205430-1-eric.dumazet@gmail.com
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 899ef30289ae1004a479c4d0ab6c7d1eaa67f3e0
Author: Vladimir Isaev <isaev@synopsys.com>
Date:   Tue Apr 27 15:13:54 2021 +0300

    ARC: mm: Use max_high_pfn as a HIGHMEM zone border
    
    commit 1d5e4640e5df15252398c1b621f6bd432f2d7f17 upstream.
    
    Commit 4af22ded0ecf ("arc: fix memory initialization for systems
    with two memory banks") fixed highmem, but for the PAE case it causes
    bug messages:
    
    | BUG: Bad page state in process swapper  pfn:80000
    | page:(ptrval) refcount:0 mapcount:1 mapping:00000000 index:0x0 pfn:0x80000 flags: 0x0()
    | raw: 00000000 00000100 00000122 00000000 00000000 00000000 00000000 00000000
    | raw: 00000000
    | page dumped because: nonzero mapcount
    | Modules linked in:
    | CPU: 0 PID: 0 Comm: swapper Not tainted 5.12.0-rc5-00003-g1e43c377a79f #1
    
    This is because the fix expects highmem to be always less than
    lowmem and uses min_low_pfn as an upper zone border for highmem.
    
    max_high_pfn should be ok for both highmem and highmem+PAE cases.
    
    Fixes: 4af22ded0ecf ("arc: fix memory initialization for systems with two memory banks")
    Signed-off-by: Vladimir Isaev <isaev@synopsys.com>
    Cc: Mike Rapoport <rppt@linux.ibm.com>
    Cc: stable@vger.kernel.org  #5.8 onwards
    Signed-off-by: Vineet Gupta <vgupta@synopsys.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 00d9666b29a06b6c21eacd89eb905212c82c1d2f
Author: Vladimir Isaev <isaev@synopsys.com>
Date:   Tue Apr 27 15:12:37 2021 +0300

    ARC: mm: PAE: use 40-bit physical page mask
    
    commit c5f756d8c6265ebb1736a7787231f010a3b782e5 upstream.
    
    32-bit PAGE_MASK can not be used as a mask for physical addresses
    when PAE is enabled. PAGE_MASK_PHYS must be used for physical
    addresses instead of PAGE_MASK.
    
    Without this, init gets SIGSEGV if pte_modify was called:
    
    | potentially unexpected fatal signal 11.
    | Path: /bin/busybox
    | CPU: 0 PID: 1 Comm: init Not tainted 5.12.0-rc5-00003-g1e43c377a79f-dirty
    | Insn could not be fetched
    |     @No matching VMA found
    |  ECR: 0x00040000 EFA: 0x00000000 ERET: 0x00000000
    | STAT: 0x80080082 [IE U     ]   BTA: 0x00000000
    |  SP: 0x5f9ffe44  FP: 0x00000000 BLK: 0xaf3d4
    | LPS: 0x000d093e LPE: 0x000d0950 LPC: 0x00000000
    | r00: 0x00000002 r01: 0x5f9fff14 r02: 0x5f9fff20
    | ...
    | Kernel panic - not syncing: Attempted to kill init! exitcode=0x0000000b
    
    Signed-off-by: Vladimir Isaev <isaev@synopsys.com>
    Reported-by: kernel test robot <lkp@intel.com>
    Cc: Vineet Gupta <vgupta@synopsys.com>
    Cc: stable@vger.kernel.org
    Signed-off-by: Vineet Gupta <vgupta@synopsys.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 88a77b9bd78b0028064625d999a60b5d9840cade
Author: Vineet Gupta <vgupta@synopsys.com>
Date:   Fri Apr 23 12:16:25 2021 -0700

    ARC: entry: fix off-by-one error in syscall number validation
    
    commit 3433adc8bd09fc9f29b8baddf33b4ecd1ecd2cdc upstream.
    
    We have NR_syscall syscalls from [0 .. NR_syscall-1].
    However the check for invalid syscall number is "> NR_syscall" as
    opposed to >=. This off-by-one error erronesously allows "NR_syscall"
    to be treated as valid syscall causeing out-of-bounds access into
    syscall-call table ensuing a crash (holes within syscall table have a
    invalid-entry handler but this is beyond the array implementing the
    table).
    
    This problem showed up on v5.6 kernel when testing glibc 2.33 (v5.10
    kernel capable, includng faccessat2 syscall 439). The v5.6 kernel has
    NR_syscalls=439 (0 to 438). Due to the bug, 439 passed by glibc was
    not handled as -ENOSYS but processed leading to a crash.
    
    Link: https://github.com/foss-for-synopsys-dwc-arc-processors/linux/issues/48
    Reported-by: Shahab Vahedi <shahab@synopsys.com>
    Cc: <stable@vger.kernel.org>
    Signed-off-by: Vineet Gupta <vgupta@synopsys.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7e2eb3812ceb90d3db9af222e998ee768639054d
Author: Paolo Abeni <pabeni@redhat.com>
Date:   Thu May 6 17:16:38 2021 -0700

    mptcp: fix splat when closing unaccepted socket
    
    [ Upstream commit 578c18eff1627d6a911f08f4cf351eca41fdcc7d ]
    
    If userspace exits before calling accept() on a listener that had at least
    one new connection ready, we get:
    
       Attempt to release TCP socket in state 8
    
    This happens because the mptcp socket gets cloned when the TCP connection
    is ready, but the socket is never exposed to userspace.
    
    The client additionally sends a DATA_FIN, which brings connection into
    CLOSE_WAIT state.  This in turn prevents the orphan+state reset fixup
    in mptcp_sock_destruct() from doing its job.
    
    Fixes: 3721b9b64676b ("mptcp: Track received DATA_FIN sequence number and add related helpers")
    Closes: https://github.com/multipath-tcp/mptcp_net-next/issues/185
    Tested-by: Florian Westphal <fw@strlen.de>
    Signed-off-by: Paolo Abeni <pabeni@redhat.com>
    Signed-off-by: Mat Martineau <mathew.j.martineau@linux.intel.com>
    Link: https://lore.kernel.org/r/20210507001638.225468-1-mathew.j.martineau@linux.intel.com
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 08459ed007a88e1632bda38477df0c5420b1168f
Author: Mateusz Palczewski <mateusz.palczewski@intel.com>
Date:   Tue Apr 13 14:43:07 2021 +0000

    i40e: Fix PHY type identifiers for 2.5G and 5G adapters
    
    [ Upstream commit 15395ec4685bd45a43d1b54b8fd9846b87e2c621 ]
    
    Unlike other supported adapters, 2.5G and 5G use different
    PHY type identifiers for reading/writing PHY settings
    and for reading link status. This commit introduces
    separate PHY identifiers for these two operation types.
    
    Fixes: 2e45d3f4677a ("i40e: Add support for X710 B/P & SFP+ cards")
    Signed-off-by: Dawid Lukwinski <dawid.lukwinski@intel.com>
    Signed-off-by: Mateusz Palczewski <mateusz.palczewski@intel.com>
    Reviewed-by: Aleksandr Loktionov <aleksandr.loktionov@intel.com>
    Tested-by: Dave Switzer <david.switzer@intel.com>
    Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 0d17d531948fdd41925f09827d577a8d63a96b23
Author: Jaroslaw Gawin <jaroslawx.gawin@intel.com>
Date:   Tue Apr 13 14:19:40 2021 +0000

    i40e: fix the restart auto-negotiation after FEC modified
    
    [ Upstream commit 61343e6da7810de81d6b826698946ae4f9070819 ]
    
    When FEC mode was changed the link didn't know it because
    the link was not reset and new parameters were not negotiated.
    Set a flag 'I40E_AQ_PHY_ENABLE_ATOMIC_LINK' in 'abilities'
    to restart the link and make it run with the new settings.
    
    Fixes: 1d96340196f1 ("i40e: Add support FEC configuration for Fortville 25G")
    Signed-off-by: Jaroslaw Gawin <jaroslawx.gawin@intel.com>
    Signed-off-by: Mateusz Palczewski <mateusz.palczewski@intel.com>
    Tested-by: Dave Switzer <david.switzer@intel.com>
    Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4ebc10aa7cd17fd9857dedac69600465c9dd16d1
Author: Yunjian Wang <wangyunjian@huawei.com>
Date:   Mon Apr 12 22:41:18 2021 +0800

    i40e: Fix use-after-free in i40e_client_subtask()
    
    [ Upstream commit 38318f23a7ef86a8b1862e5e8078c4de121960c3 ]
    
    Currently the call to i40e_client_del_instance frees the object
    pf->cinst, however pf->cinst->lan_info is being accessed after
    the free. Fix this by adding the missing return.
    
    Addresses-Coverity: ("Read from pointer after free")
    Fixes: 7b0b1a6d0ac9 ("i40e: Disable iWARP VSI PETCP_ENA flag on netdev down events")
    Signed-off-by: Yunjian Wang <wangyunjian@huawei.com>
    Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5366ed0ec22ffdf80f1abe11940fe2b6998022d0
Author: Magnus Karlsson <magnus.karlsson@intel.com>
Date:   Mon Apr 26 13:14:01 2021 +0200

    i40e: fix broken XDP support
    
    [ Upstream commit ae4393dfd472b194c90d75d2123105fb5ed59b04 ]
    
    Commit 12738ac4754e ("i40e: Fix sparse errors in i40e_txrx.c") broke
    XDP support in the i40e driver. That commit was fixing a sparse error
    in the code by introducing a new variable xdp_res instead of
    overloading this into the skb pointer. The problem is that the code
    later uses the skb pointer in if statements and these where not
    extended to also test for the new xdp_res variable. Fix this by adding
    the correct tests for xdp_res in these places.
    
    The skb pointer was used to store the result of the XDP program by
    overloading the results in the error pointer
    ERR_PTR(-result). Therefore, the allocation failure test that used to
    only test for !skb now need to be extended to also consider !xdp_res.
    
    i40e_cleanup_headers() had a check that based on the skb value being
    an error pointer, i.e. a result from the XDP program != XDP_PASS, and
    if so start to process a new packet immediately, instead of populating
    skb fields and sending the skb to the stack. This check is not needed
    anymore, since we have added an explicit test for xdp_res being set
    and if so just do continue to pick the next packet from the NIC.
    
    Fixes: 12738ac4754e ("i40e: Fix sparse errors in i40e_txrx.c")
    Acked-by: Jesper Dangaard Brouer <brouer@redhat.com>
    Tested-by: Jesper Dangaard Brouer <brouer@redhat.com>
    Reported-by: Jesper Dangaard Brouer <brouer@redhat.com>
    Reviewed-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
    Signed-off-by: Magnus Karlsson <magnus.karlsson@intel.com>
    Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1e8ab479cfbe5751efccedb95afb9b112a5ba475
Author: Eric Dumazet <edumazet@google.com>
Date:   Thu May 6 05:53:23 2021 -0700

    netfilter: nftables: avoid overflows in nft_hash_buckets()
    
    [ Upstream commit a54754ec9891830ba548e2010c889e3c8146e449 ]
    
    Number of buckets being stored in 32bit variables, we have to
    ensure that no overflows occur in nft_hash_buckets()
    
    syzbot injected a size == 0x40000000 and reported:
    
    UBSAN: shift-out-of-bounds in ./include/linux/log2.h:57:13
    shift exponent 64 is too large for 64-bit type 'long unsigned int'
    CPU: 1 PID: 29539 Comm: syz-executor.4 Not tainted 5.12.0-rc7-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    Call Trace:
     __dump_stack lib/dump_stack.c:79 [inline]
     dump_stack+0x141/0x1d7 lib/dump_stack.c:120
     ubsan_epilogue+0xb/0x5a lib/ubsan.c:148
     __ubsan_handle_shift_out_of_bounds.cold+0xb1/0x181 lib/ubsan.c:327
     __roundup_pow_of_two include/linux/log2.h:57 [inline]
     nft_hash_buckets net/netfilter/nft_set_hash.c:411 [inline]
     nft_hash_estimate.cold+0x19/0x1e net/netfilter/nft_set_hash.c:652
     nft_select_set_ops net/netfilter/nf_tables_api.c:3586 [inline]
     nf_tables_newset+0xe62/0x3110 net/netfilter/nf_tables_api.c:4322
     nfnetlink_rcv_batch+0xa09/0x24b0 net/netfilter/nfnetlink.c:488
     nfnetlink_rcv_skb_batch net/netfilter/nfnetlink.c:612 [inline]
     nfnetlink_rcv+0x3af/0x420 net/netfilter/nfnetlink.c:630
     netlink_unicast_kernel net/netlink/af_netlink.c:1312 [inline]
     netlink_unicast+0x533/0x7d0 net/netlink/af_netlink.c:1338
     netlink_sendmsg+0x856/0xd90 net/netlink/af_netlink.c:1927
     sock_sendmsg_nosec net/socket.c:654 [inline]
     sock_sendmsg+0xcf/0x120 net/socket.c:674
     ____sys_sendmsg+0x6e8/0x810 net/socket.c:2350
     ___sys_sendmsg+0xf3/0x170 net/socket.c:2404
     __sys_sendmsg+0xe5/0x1b0 net/socket.c:2433
     do_syscall_64+0x2d/0x70 arch/x86/entry/common.c:46
    
    Fixes: 0ed6389c483d ("netfilter: nf_tables: rename set implementations")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: syzbot <syzkaller@googlegroups.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7e7de66095d429d9112fac418dfcbed5c0a6a28a
Author: David Hildenbrand <david@redhat.com>
Date:   Thu May 6 18:05:16 2021 -0700

    kernel/resource: make walk_mem_res() find all busy IORESOURCE_MEM resources
    
    [ Upstream commit 3c9c797534364593b73ba6ab060a014af8934721 ]
    
    It used to be true that we can have system RAM (IORESOURCE_SYSTEM_RAM |
    IORESOURCE_BUSY) only on the first level in the resource tree.  However,
    this is no longer holds for driver-managed system RAM (i.e., added via
    dax/kmem and virtio-mem), which gets added on lower levels, for example,
    inside device containers.
    
    IORESOURCE_SYSTEM_RAM is defined as IORESOURCE_MEM | IORESOURCE_SYSRAM and
    just a special type of IORESOURCE_MEM.
    
    The function walk_mem_res() only considers the first level and is used in
    arch/x86/mm/ioremap.c:__ioremap_check_mem() only.  We currently fail to
    identify System RAM added by dax/kmem and virtio-mem as
    "IORES_MAP_SYSTEM_RAM", for example, allowing for remapping of such
    "normal RAM" in __ioremap_caller().
    
    Let's find all IORESOURCE_MEM | IORESOURCE_BUSY resources, making the
    function behave similar to walk_system_ram_res().
    
    Link: https://lkml.kernel.org/r/20210325115326.7826-3-david@redhat.com
    Fixes: ebf71552bb0e ("virtio-mem: Add parent resource for all added "System RAM"")
    Fixes: c221c0b0308f ("device-dax: "Hotplug" persistent memory for use like normal RAM")
    Signed-off-by: David Hildenbrand <david@redhat.com>
    Reviewed-by: Dan Williams <dan.j.williams@intel.com>
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Cc: Dan Williams <dan.j.williams@intel.com>
    Cc: Daniel Vetter <daniel.vetter@ffwll.ch>
    Cc: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
    Cc: Mauro Carvalho Chehab <mchehab+huawei@kernel.org>
    Cc: Dave Young <dyoung@redhat.com>
    Cc: Baoquan He <bhe@redhat.com>
    Cc: Vivek Goyal <vgoyal@redhat.com>
    Cc: Dave Hansen <dave.hansen@linux.intel.com>
    Cc: Keith Busch <keith.busch@intel.com>
    Cc: Michal Hocko <mhocko@suse.com>
    Cc: Qian Cai <cai@lca.pw>
    Cc: Oscar Salvador <osalvador@suse.de>
    Cc: Eric Biederman <ebiederm@xmission.com>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Ingo Molnar <mingo@redhat.com>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: "H. Peter Anvin" <hpa@zytor.com>
    Cc: Tom Lendacky <thomas.lendacky@amd.com>
    Cc: Brijesh Singh <brijesh.singh@amd.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 3cc24f2a62a1f59efa07590557ff9ffdfe4729f1
Author: David Hildenbrand <david@redhat.com>
Date:   Thu May 6 18:05:12 2021 -0700

    kernel/resource: make walk_system_ram_res() find all busy IORESOURCE_SYSTEM_RAM resources
    
    [ Upstream commit 97f61c8f44ec9020708b97a51188170add4f3084 ]
    
    Patch series "kernel/resource: make walk_system_ram_res() and walk_mem_res() search the whole tree", v2.
    
    Playing with kdump+virtio-mem I noticed that kexec_file_load() does not
    consider System RAM added via dax/kmem and virtio-mem when preparing the
    elf header for kdump.  Looking into the details, the logic used in
    walk_system_ram_res() and walk_mem_res() seems to be outdated.
    
    walk_system_ram_range() already does the right thing, let's change
    walk_system_ram_res() and walk_mem_res(), and clean up.
    
    Loading a kdump kernel via "kexec -p -s" ...  will result in the kdump
    kernel to also dump dax/kmem and virtio-mem added System RAM now.
    
    Note: kexec-tools on x86-64 also have to be updated to consider this
    memory in the kexec_load() case when processing /proc/iomem.
    
    This patch (of 3):
    
    It used to be true that we can have system RAM (IORESOURCE_SYSTEM_RAM |
    IORESOURCE_BUSY) only on the first level in the resource tree.  However,
    this is no longer holds for driver-managed system RAM (i.e., added via
    dax/kmem and virtio-mem), which gets added on lower levels, for example,
    inside device containers.
    
    We have two users of walk_system_ram_res(), which currently only
    consideres the first level:
    
    a) kernel/kexec_file.c:kexec_walk_resources() -- We properly skip
       IORESOURCE_SYSRAM_DRIVER_MANAGED resources via
       locate_mem_hole_callback(), so even after this change, we won't be
       placing kexec images onto dax/kmem and virtio-mem added memory.  No
       change.
    
    b) arch/x86/kernel/crash.c:fill_up_crash_elf_data() -- we're currently
       not adding relevant ranges to the crash elf header, resulting in them
       not getting dumped via kdump.
    
    This change fixes loading a crashkernel via kexec_file_load() and
    including dax/kmem and virtio-mem added System RAM in the crashdump on
    x86-64.  Note that e.g,, arm64 relies on memblock data and, therefore,
    always considers all added System RAM already.
    
    Let's find all IORESOURCE_SYSTEM_RAM | IORESOURCE_BUSY resources, making
    the function behave like walk_system_ram_range().
    
    Link: https://lkml.kernel.org/r/20210325115326.7826-1-david@redhat.com
    Link: https://lkml.kernel.org/r/20210325115326.7826-2-david@redhat.com
    Fixes: ebf71552bb0e ("virtio-mem: Add parent resource for all added "System RAM"")
    Fixes: c221c0b0308f ("device-dax: "Hotplug" persistent memory for use like normal RAM")
    Signed-off-by: David Hildenbrand <david@redhat.com>
    Reviewed-by: Dan Williams <dan.j.williams@intel.com>
    Acked-by: Baoquan He <bhe@redhat.com>
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Cc: Dan Williams <dan.j.williams@intel.com>
    Cc: Daniel Vetter <daniel.vetter@ffwll.ch>
    Cc: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
    Cc: Mauro Carvalho Chehab <mchehab+huawei@kernel.org>
    Cc: Dave Young <dyoung@redhat.com>
    Cc: Baoquan He <bhe@redhat.com>
    Cc: Vivek Goyal <vgoyal@redhat.com>
    Cc: Dave Hansen <dave.hansen@linux.intel.com>
    Cc: Keith Busch <keith.busch@intel.com>
    Cc: Michal Hocko <mhocko@suse.com>
    Cc: Qian Cai <cai@lca.pw>
    Cc: Oscar Salvador <osalvador@suse.de>
    Cc: Eric Biederman <ebiederm@xmission.com>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Ingo Molnar <mingo@redhat.com>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: "H. Peter Anvin" <hpa@zytor.com>
    Cc: Tom Lendacky <thomas.lendacky@amd.com>
    Cc: Brijesh Singh <brijesh.singh@amd.com>
    Cc: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 10188ee5c5a447086d0dccc3e03b3a7b071a4e0a
Author: Jia-Ju Bai <baijiaju1990@gmail.com>
Date:   Thu May 6 18:04:38 2021 -0700

    kernel: kexec_file: fix error return code of kexec_calculate_store_digests()
    
    [ Upstream commit 31d82c2c787d5cf65fedd35ebbc0c1bd95c1a679 ]
    
    When vzalloc() returns NULL to sha_regions, no error return code of
    kexec_calculate_store_digests() is assigned.  To fix this bug, ret is
    assigned with -ENOMEM in this case.
    
    Link: https://lkml.kernel.org/r/20210309083904.24321-1-baijiaju1990@gmail.com
    Fixes: a43cac0d9dc2 ("kexec: split kexec_file syscall code to kexec_file.c")
    Signed-off-by: Jia-Ju Bai <baijiaju1990@gmail.com>
    Reported-by: TOTE Robot <oslab@tsinghua.edu.cn>
    Acked-by: Baoquan He <bhe@redhat.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit aaf9f00fc11f763bf76f6cd49d98cf1f1e975314
Author: Colin Ian King <colin.king@canonical.com>
Date:   Thu May 6 18:02:10 2021 -0700

    fs/proc/generic.c: fix incorrect pde_is_permanent check
    
    [ Upstream commit f4bf74d82915708208bc9d0c9bd3f769f56bfbec ]
    
    Currently the pde_is_permanent() check is being run on root multiple times
    rather than on the next proc directory entry.  This looks like a
    copy-paste error.  Fix this by replacing root with next.
    
    Addresses-Coverity: ("Copy-paste error")
    Link: https://lkml.kernel.org/r/20210318122633.14222-1-colin.king@canonical.com
    Fixes: d919b33dafb3 ("proc: faster open/read/close with "permanent" files")
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Acked-by: Christian Brauner <christian.brauner@ubuntu.com>
    Reviewed-by: Alexey Dobriyan <adobriyan@gmail.com>
    Cc: Greg Kroah-Hartman <gregkh@google.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2897c1d872863db0a7c2e6e93d6742ea4522a2b8
Author: Alex Elder <elder@linaro.org>
Date:   Wed May 5 17:36:36 2021 -0500

    net: ipa: fix inter-EE IRQ register definitions
    
    [ Upstream commit 6a780f51f87b430cc69ebf4e859e7e9be720b283 ]
    
    In gsi_irq_setup(), two registers are written with the intention of
    disabling inter-EE channel and event IRQs.
    
    But the wrong registers are used (and defined); the ones used are
    read-only registers that indicate whether the interrupt condition is
    present.
    
    Define the mask registers instead of the status registers, and use
    them to disable the inter-EE interrupt types.
    
    Fixes: 46f748ccaf01 ("net: ipa: explicitly disallow inter-EE interrupts")
    Signed-off-by: Alex Elder <elder@linaro.org>
    Link: https://lore.kernel.org/r/20210505223636.232527-1-elder@linaro.org
    Signed-off-by: Jakub Kicinski <kuba@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit cba969eb922c75d581a157d574511d5adc706b7f
Author: Odin Ugedal <odin@uged.al>
Date:   Sat May 1 16:19:50 2021 +0200

    sched/fair: Fix unfairness caused by missing load decay
    
    [ Upstream commit 0258bdfaff5bd13c4d2383150b7097aecd6b6d82 ]
    
    This fixes an issue where old load on a cfs_rq is not properly decayed,
    resulting in strange behavior where fairness can decrease drastically.
    Real workloads with equally weighted control groups have ended up
    getting a respective 99% and 1%(!!) of cpu time.
    
    When an idle task is attached to a cfs_rq by attaching a pid to a cgroup,
    the old load of the task is attached to the new cfs_rq and sched_entity by
    attach_entity_cfs_rq. If the task is then moved to another cpu (and
    therefore cfs_rq) before being enqueued/woken up, the load will be moved
    to cfs_rq->removed from the sched_entity. Such a move will happen when
    enforcing a cpuset on the task (eg. via a cgroup) that force it to move.
    
    The load will however not be removed from the task_group itself, making
    it look like there is a constant load on that cfs_rq. This causes the
    vruntime of tasks on other sibling cfs_rq's to increase faster than they
    are supposed to; causing severe fairness issues. If no other task is
    started on the given cfs_rq, and due to the cpuset it would not happen,
    this load would never be properly unloaded. With this patch the load
    will be properly removed inside update_blocked_averages. This also
    applies to tasks moved to the fair scheduling class and moved to another
    cpu, and this path will also fix that. For fork, the entity is queued
    right away, so this problem does not affect that.
    
    This applies to cases where the new process is the first in the cfs_rq,
    issue introduced 3d30544f0212 ("sched/fair: Apply more PELT fixes"), and
    when there has previously been load on the cgroup but the cgroup was
    removed from the leaflist due to having null PELT load, indroduced
    in 039ae8bcf7a5 ("sched/fair: Fix O(nr_cgroups) in the load balancing
    path").
    
    For a simple cgroup hierarchy (as seen below) with two equally weighted
    groups, that in theory should get 50/50 of cpu time each, it often leads
    to a load of 60/40 or 70/30.
    
    parent/
      cg-1/
        cpu.weight: 100
        cpuset.cpus: 1
      cg-2/
        cpu.weight: 100
        cpuset.cpus: 1
    
    If the hierarchy is deeper (as seen below), while keeping cg-1 and cg-2
    equally weighted, they should still get a 50/50 balance of cpu time.
    This however sometimes results in a balance of 10/90 or 1/99(!!) between
    the task groups.
    
    $ ps u -C stress
    USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
    root       18568  1.1  0.0   3684   100 pts/12   R+   13:36   0:00 stress --cpu 1
    root       18580 99.3  0.0   3684   100 pts/12   R+   13:36   0:09 stress --cpu 1
    
    parent/
      cg-1/
        cpu.weight: 100
        sub-group/
          cpu.weight: 1
          cpuset.cpus: 1
      cg-2/
        cpu.weight: 100
        sub-group/
          cpu.weight: 10000
          cpuset.cpus: 1
    
    This can be reproduced by attaching an idle process to a cgroup and
    moving it to a given cpuset before it wakes up. The issue is evident in
    many (if not most) container runtimes, and has been reproduced
    with both crun and runc (and therefore docker and all its "derivatives"),
    and with both cgroup v1 and v2.
    
    Fixes: 3d30544f0212 ("sched/fair: Apply more PELT fixes")
    Fixes: 039ae8bcf7a5 ("sched/fair: Fix O(nr_cgroups) in the load balancing path")
    Signed-off-by: Odin Ugedal <odin@uged.al>
    Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
    Reviewed-by: Vincent Guittot <vincent.guittot@linaro.org>
    Link: https://lkml.kernel.org/r/20210501141950.23622-2-odin@uged.al
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 3da3f804b82a0a382d523a21acf4cf3bb35f936d
Author: Quentin Perret <qperret@google.com>
Date:   Fri Apr 30 15:14:12 2021 +0000

    sched: Fix out-of-bound access in uclamp
    
    [ Upstream commit 6d2f8909a5fabb73fe2a63918117943986c39b6c ]
    
    Util-clamp places tasks in different buckets based on their clamp values
    for performance reasons. However, the size of buckets is currently
    computed using a rounding division, which can lead to an off-by-one
    error in some configurations.
    
    For instance, with 20 buckets, the bucket size will be 1024/20=51. A
    task with a clamp of 1024 will be mapped to bucket id 1024/51=20. Sadly,
    correct indexes are in range [0,19], hence leading to an out of bound
    memory access.
    
    Clamp the bucket id to fix the issue.
    
    Fixes: 69842cba9ace ("sched/uclamp: Add CPU's clamp buckets refcounting")
    Suggested-by: Qais Yousef <qais.yousef@arm.com>
    Signed-off-by: Quentin Perret <qperret@google.com>
    Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
    Reviewed-by: Vincent Guittot <vincent.guittot@linaro.org>
    Reviewed-by: Dietmar Eggemann <dietmar.eggemann@arm.com>
    Link: https://lkml.kernel.org/r/20210430151412.160913-1-qperret@google.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7eb92e6c84636e14d8524d7b9df3d39e5ee35032
Author: Marc Kleine-Budde <mkl@pengutronix.de>
Date:   Wed May 5 13:32:27 2021 +0200

    can: m_can: m_can_tx_work_queue(): fix tx_skb race condition
    
    [ Upstream commit e04b2cfe61072c7966e1a5fb73dd1feb30c206ed ]
    
    The m_can_start_xmit() function checks if the cdev->tx_skb is NULL and
    returns with NETDEV_TX_BUSY in case tx_sbk is not NULL.
    
    There is a race condition in the m_can_tx_work_queue(), where first
    the skb is send to the driver and then the case tx_sbk is set to NULL.
    A TX complete IRQ might come in between and wake the queue, which
    results in tx_skb not being cleared yet.
    
    Fixes: f524f829b75a ("can: m_can: Create a m_can platform framework")
    Tested-by: Torin Cooper-Bennun <torin@maxiluxsystems.com>
    Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 6f8f1c27b577de15f69fefce3c502bb6300d825c
Author: Frieder Schrempf <frieder.schrempf@kontron.de>
Date:   Wed May 5 09:14:15 2021 +0200

    can: mcp251x: fix resume from sleep before interface was brought up
    
    [ Upstream commit 03c427147b2d3e503af258711af4fc792b89b0af ]
    
    Since 8ce8c0abcba3 the driver queues work via priv->restart_work when
    resuming after suspend, even when the interface was not previously
    enabled. This causes a null dereference error as the workqueue is only
    allocated and initialized in mcp251x_open().
    
    To fix this we move the workqueue init to mcp251x_can_probe() as there
    is no reason to do it later and repeat it whenever mcp251x_open() is
    called.
    
    Fixes: 8ce8c0abcba3 ("can: mcp251x: only reset hardware as required")
    Link: https://lore.kernel.org/r/17d5d714-b468-482f-f37a-482e3d6df84e@kontron.de
    Signed-off-by: Frieder Schrempf <frieder.schrempf@kontron.de>
    Reviewed-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
    [mkl: fix error handling in mcp251x_stop()]
    Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 716775bced5496ff70a717fbd7496a0a169bc74a
Author: Marc Kleine-Budde <mkl@pengutronix.de>
Date:   Sun May 2 11:34:34 2021 +0200

    can: mcp251xfd: mcp251xfd_probe(): add missing can_rx_offload_del() in error path
    
    [ Upstream commit 4376ea42db8bfcac2bc3a30bba93917244a8c2d4 ]
    
    This patch adds the missing can_rx_offload_del(), that must be called
    if mcp251xfd_register() fails.
    
    Fixes: 55e5b97f003e ("can: mcp25xxfd: add driver for Microchip MCP25xxFD SPI CAN")
    Link: https://lore.kernel.org/r/20210504091838.1109047-1-mkl@pengutronix.de
    Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 59fa98bfa1f4013d658d990cac88c87b46ff410c
Author: Pablo Neira Ayuso <pablo@netfilter.org>
Date:   Wed May 5 23:06:43 2021 +0200

    netfilter: nftables: Fix a memleak from userdata error path in new objects
    
    [ Upstream commit 85dfd816fabfc16e71786eda0a33a7046688b5b0 ]
    
    Release object name if userdata allocation fails.
    
    Fixes: b131c96496b3 ("netfilter: nf_tables: add userdata support for nft_object")
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 142d91d0fb292581e7258c7c85f522fe8db00769
Author: Pablo Neira Ayuso <pablo@netfilter.org>
Date:   Wed May 5 22:25:24 2021 +0200

    netfilter: nfnetlink_osf: Fix a missing skb_header_pointer() NULL check
    
    [ Upstream commit 5e024c325406470d1165a09c6feaf8ec897936be ]
    
    Do not assume that the tcph->doff field is correct when parsing for TCP
    options, skb_header_pointer() might fail to fetch these bits.
    
    Fixes: 11eeef41d5f6 ("netfilter: passive OS fingerprint xtables match")
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 80a9709678eda8b49a5c004b8112229c90802721
Author: Cong Wang <cong.wang@bytedance.com>
Date:   Wed May 5 12:40:48 2021 -0700

    smc: disallow TCP_ULP in smc_setsockopt()
    
    [ Upstream commit 8621436671f3a4bba5db57482e1ee604708bf1eb ]
    
    syzbot is able to setup kTLS on an SMC socket which coincidentally
    uses sk_user_data too. Later, kTLS treats it as psock so triggers a
    refcnt warning. The root cause is that smc_setsockopt() simply calls
    TCP setsockopt() which includes TCP_ULP. I do not think it makes
    sense to setup kTLS on top of SMC sockets, so we should just disallow
    this setup.
    
    It is hard to find a commit to blame, but we can apply this patch
    since the beginning of TCP_ULP.
    
    Reported-and-tested-by: syzbot+b54a1ce86ba4a623b7f0@syzkaller.appspotmail.com
    Fixes: 734942cc4ea6 ("tcp: ULP infrastructure")
    Cc: John Fastabend <john.fastabend@gmail.com>
    Signed-off-by: Karsten Graul <kgraul@linux.ibm.com>
    Signed-off-by: Cong Wang <cong.wang@bytedance.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f46fb01e01c4acbdbb6bbb6beb42e34930f20bc4
Author: Maciej Żenczykowski <maze@google.com>
Date:   Wed May 5 09:58:31 2021 -0700

    net: fix nla_strcmp to handle more then one trailing null character
    
    [ Upstream commit 2c16db6c92b0ee4aa61e88366df82169e83c3f7e ]
    
    Android userspace has been using TCA_KIND with a char[IFNAMESIZ]
    many-null-terminated buffer containing the string 'bpf'.
    
    This works on 4.19 and ceases to work on 5.10.
    
    I'm not entirely sure what fixes tag to use, but I think the issue
    was likely introduced in the below mentioned 5.4 commit.
    
    Reported-by: Nucca Chen <nuccachen@google.com>
    Cc: Cong Wang <xiyou.wangcong@gmail.com>
    Cc: David Ahern <dsahern@gmail.com>
    Cc: David S. Miller <davem@davemloft.net>
    Cc: Jakub Kicinski <jakub.kicinski@netronome.com>
    Cc: Jamal Hadi Salim <jhs@mojatatu.com>
    Cc: Jiri Pirko <jiri@mellanox.com>
    Cc: Jiri Pirko <jiri@resnulli.us>
    Fixes: 62794fc4fbf5 ("net_sched: add max len check for TCA_KIND")
    Change-Id: I66dc281f165a2858fc29a44869a270a2d698a82b
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7c7feca231a2320c7a9030f116827781c64d5c96
Author: Fernando Fernandez Mancera <ffmancera@riseup.net>
Date:   Wed May 5 00:47:14 2021 +0200

    ethtool: fix missing NLM_F_MULTI flag when dumping
    
    [ Upstream commit cf754ae331be7cc192b951756a1dd031e9ed978a ]
    
    When dumping the ethtool information from all the interfaces, the
    netlink reply should contain the NLM_F_MULTI flag. This flag allows
    userspace tools to identify that multiple messages are expected.
    
    Link: https://bugzilla.redhat.com/1953847
    Fixes: 365f9ae4ee36 ("ethtool: fix genlmsg_put() failure handling in ethnl_default_dumpit()")
    Signed-off-by: Fernando Fernandez Mancera <ffmancera@riseup.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 76094e1b4ef0df8b7e36e290498873837c0fec2d
Author: Pavel Tatashin <pasha.tatashin@soleen.com>
Date:   Tue May 4 18:38:49 2021 -0700

    mm/gup: check for isolation errors
    
    [ Upstream commit 6e7f34ebb8d25d71ce7f4580ba3cbfc10b895580 ]
    
    It is still possible that we pin movable CMA pages if there are
    isolation errors and cma_page_list stays empty when we check again.
    
    Check for isolation errors, and return success only when there are no
    isolation errors, and cma_page_list is empty after checking.
    
    Because isolation errors are transient, we retry indefinitely.
    
    Link: https://lkml.kernel.org/r/20210215161349.246722-5-pasha.tatashin@soleen.com
    Fixes: 9a4e9f3b2d73 ("mm: update get_user_pages_longterm to migrate pages allocated from CMA region")
    Signed-off-by: Pavel Tatashin <pasha.tatashin@soleen.com>
    Reviewed-by: Jason Gunthorpe <jgg@nvidia.com>
    Cc: Dan Williams <dan.j.williams@intel.com>
    Cc: David Hildenbrand <david@redhat.com>
    Cc: David Rientjes <rientjes@google.com>
    Cc: Ingo Molnar <mingo@redhat.com>
    Cc: Ira Weiny <ira.weiny@intel.com>
    Cc: James Morris <jmorris@namei.org>
    Cc: Jason Gunthorpe <jgg@ziepe.ca>
    Cc: John Hubbard <jhubbard@nvidia.com>
    Cc: Joonsoo Kim <iamjoonsoo.kim@lge.com>
    Cc: Matthew Wilcox <willy@infradead.org>
    Cc: Mel Gorman <mgorman@suse.de>
    Cc: Michal Hocko <mhocko@kernel.org>
    Cc: Michal Hocko <mhocko@suse.com>
    Cc: Mike Kravetz <mike.kravetz@oracle.com>
    Cc: Oscar Salvador <osalvador@suse.de>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Sasha Levin <sashal@kernel.org>
    Cc: Steven Rostedt (VMware) <rostedt@goodmis.org>
    Cc: Tyler Hicks <tyhicks@linux.microsoft.com>
    Cc: Vlastimil Babka <vbabka@suse.cz>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a05c81bb72eea24c1d8e3c9bbda9cd2885a6ad26
Author: Pavel Tatashin <pasha.tatashin@soleen.com>
Date:   Tue May 4 18:38:46 2021 -0700

    mm/gup: return an error on migration failure
    
    [ Upstream commit f0f4463837da17a89d965dcbe4e411629dbcf308 ]
    
    When migration failure occurs, we still pin pages, which means that we
    may pin CMA movable pages which should never be the case.
    
    Instead return an error without pinning pages when migration failure
    happens.
    
    No need to retry migrating, because migrate_pages() already retries 10
    times.
    
    Link: https://lkml.kernel.org/r/20210215161349.246722-4-pasha.tatashin@soleen.com
    Signed-off-by: Pavel Tatashin <pasha.tatashin@soleen.com>
    Reviewed-by: Jason Gunthorpe <jgg@nvidia.com>
    Cc: Dan Williams <dan.j.williams@intel.com>
    Cc: David Hildenbrand <david@redhat.com>
    Cc: David Rientjes <rientjes@google.com>
    Cc: Ingo Molnar <mingo@redhat.com>
    Cc: Ira Weiny <ira.weiny@intel.com>
    Cc: James Morris <jmorris@namei.org>
    Cc: Jason Gunthorpe <jgg@ziepe.ca>
    Cc: John Hubbard <jhubbard@nvidia.com>
    Cc: Joonsoo Kim <iamjoonsoo.kim@lge.com>
    Cc: Matthew Wilcox <willy@infradead.org>
    Cc: Mel Gorman <mgorman@suse.de>
    Cc: Michal Hocko <mhocko@kernel.org>
    Cc: Michal Hocko <mhocko@suse.com>
    Cc: Mike Kravetz <mike.kravetz@oracle.com>
    Cc: Oscar Salvador <osalvador@suse.de>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Sasha Levin <sashal@kernel.org>
    Cc: Steven Rostedt (VMware) <rostedt@goodmis.org>
    Cc: Tyler Hicks <tyhicks@linux.microsoft.com>
    Cc: Vlastimil Babka <vbabka@suse.cz>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a64e4781b4857b7ad2ad304891eff6c16e705983
Author: Pavel Tatashin <pasha.tatashin@soleen.com>
Date:   Tue May 4 18:38:42 2021 -0700

    mm/gup: check every subpage of a compound page during isolation
    
    [ Upstream commit 83c02c23d0747a7bdcd71f99a538aacec94b146c ]
    
    When pages are isolated in check_and_migrate_movable_pages() we skip
    compound number of pages at a time.  However, as Jason noted, it is not
    necessary correct that pages[i] corresponds to the pages that we
    skipped.  This is because it is possible that the addresses in this
    range had split_huge_pmd()/split_huge_pud(), and these functions do not
    update the compound page metadata.
    
    The problem can be reproduced if something like this occurs:
    
    1. User faulted huge pages.
    2. split_huge_pmd() was called for some reason
    3. User has unmapped some sub-pages in the range
    4. User tries to longterm pin the addresses.
    
    The resulting pages[i] might end-up having pages which are not compound
    size page aligned.
    
    Link: https://lkml.kernel.org/r/20210215161349.246722-3-pasha.tatashin@soleen.com
    Fixes: aa712399c1e8 ("mm/gup: speed up check_and_migrate_cma_pages() on huge page")
    Signed-off-by: Pavel Tatashin <pasha.tatashin@soleen.com>
    Reported-by: Jason Gunthorpe <jgg@nvidia.com>
    Reviewed-by: Jason Gunthorpe <jgg@nvidia.com>
    Cc: Dan Williams <dan.j.williams@intel.com>
    Cc: David Hildenbrand <david@redhat.com>
    Cc: David Rientjes <rientjes@google.com>
    Cc: Ingo Molnar <mingo@redhat.com>
    Cc: Ira Weiny <ira.weiny@intel.com>
    Cc: James Morris <jmorris@namei.org>
    Cc: Jason Gunthorpe <jgg@ziepe.ca>
    Cc: John Hubbard <jhubbard@nvidia.com>
    Cc: Joonsoo Kim <iamjoonsoo.kim@lge.com>
    Cc: Matthew Wilcox <willy@infradead.org>
    Cc: Mel Gorman <mgorman@suse.de>
    Cc: Michal Hocko <mhocko@kernel.org>
    Cc: Michal Hocko <mhocko@suse.com>
    Cc: Mike Kravetz <mike.kravetz@oracle.com>
    Cc: Oscar Salvador <osalvador@suse.de>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Sasha Levin <sashal@kernel.org>
    Cc: Steven Rostedt (VMware) <rostedt@goodmis.org>
    Cc: Tyler Hicks <tyhicks@linux.microsoft.com>
    Cc: Vlastimil Babka <vbabka@suse.cz>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d63fced3223b89d909ac85baab05cc744a10a72e
Author: Miaohe Lin <linmiaohe@huawei.com>
Date:   Tue May 4 18:37:45 2021 -0700

    ksm: fix potential missing rmap_item for stable_node
    
    [ Upstream commit c89a384e2551c692a9fe60d093fd7080f50afc51 ]
    
    When removing rmap_item from stable tree, STABLE_FLAG of rmap_item is
    cleared with head reserved.  So the following scenario might happen: For
    ksm page with rmap_item1:
    
    cmp_and_merge_page
      stable_node->head = &migrate_nodes;
      remove_rmap_item_from_tree, but head still equal to stable_node;
      try_to_merge_with_ksm_page failed;
      return;
    
    For the same ksm page with rmap_item2, stable node migration succeed this
    time.  The stable_node->head does not equal to migrate_nodes now.  For ksm
    page with rmap_item1 again:
    
    cmp_and_merge_page
     stable_node->head != &migrate_nodes && rmap_item->head == stable_node
     return;
    
    We would miss the rmap_item for stable_node and might result in failed
    rmap_walk_ksm().  Fix this by set rmap_item->head to NULL when rmap_item
    is removed from stable tree.
    
    Link: https://lkml.kernel.org/r/20210330140228.45635-5-linmiaohe@huawei.com
    Fixes: 4146d2d673e8 ("ksm: make !merge_across_nodes migration safe")
    Signed-off-by: Miaohe Lin <linmiaohe@huawei.com>
    Cc: Hugh Dickins <hughd@google.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c5b811bb28afe9101796fc566fb9528c99e33827
Author: Miaohe Lin <linmiaohe@huawei.com>
Date:   Tue May 4 18:37:10 2021 -0700

    mm/migrate.c: fix potential indeterminate pte entry in migrate_vma_insert_page()
    
    [ Upstream commit 34f5e9b9d1990d286199084efa752530ee3d8297 ]
    
    If the zone device page does not belong to un-addressable device memory,
    the variable entry will be uninitialized and lead to indeterminate pte
    entry ultimately.  Fix this unexpected case and warn about it.
    
    Link: https://lkml.kernel.org/r/20210325131524.48181-4-linmiaohe@huawei.com
    Fixes: df6ad69838fc ("mm/device-public-memory: device memory cache coherent with CPU")
    Signed-off-by: Miaohe Lin <linmiaohe@huawei.com>
    Reviewed-by: David Hildenbrand <david@redhat.com>
    Cc: Alistair Popple <apopple@nvidia.com>
    Cc: Jerome Glisse <jglisse@redhat.com>
    Cc: Rafael Aquini <aquini@redhat.com>
    Cc: Yang Shi <shy828301@gmail.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 726af0287be96b2d742574183b170fbb9097c72e
Author: Miaohe Lin <linmiaohe@huawei.com>
Date:   Tue May 4 18:34:38 2021 -0700

    mm/hugeltb: handle the error case in hugetlb_fix_reserve_counts()
    
    [ Upstream commit da56388c4397878a65b74f7fe97760f5aa7d316b ]
    
    A rare out of memory error would prevent removal of the reserve map region
    for a page.  hugetlb_fix_reserve_counts() handles this rare case to avoid
    dangling with incorrect counts.  Unfortunately, hugepage_subpool_get_pages
    and hugetlb_acct_memory could possibly fail too.  We should correctly
    handle these cases.
    
    Link: https://lkml.kernel.org/r/20210410072348.20437-5-linmiaohe@huawei.com
    Fixes: b5cec28d36f5 ("hugetlbfs: truncate_hugepages() takes a range of pages")
    Signed-off-by: Miaohe Lin <linmiaohe@huawei.com>
    Cc: Feilong Lin <linfeilong@huawei.com>
    Cc: Mike Kravetz <mike.kravetz@oracle.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 64cd863b7d8efd0e0a03e25631ddb89106d466f1
Author: Miaohe Lin <linmiaohe@huawei.com>
Date:   Tue May 4 18:33:46 2021 -0700

    khugepaged: fix wrong result value for trace_mm_collapse_huge_page_isolate()
    
    [ Upstream commit 74e579bf231a337ab3786d59e64bc94f45ca7b3f ]
    
    In writable and !referenced case, the result value should be
    SCAN_LACK_REFERENCED_PAGE for trace_mm_collapse_huge_page_isolate()
    instead of default 0 (SCAN_FAIL) here.
    
    Link: https://lkml.kernel.org/r/20210306032947.35921-5-linmiaohe@huawei.com
    Fixes: 7d2eba0557c1 ("mm: add tracepoint for scanning pages")
    Signed-off-by: Miaohe Lin <linmiaohe@huawei.com>
    Acked-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
    Cc: Dan Carpenter <dan.carpenter@oracle.com>
    Cc: Ebru Akagunduz <ebru.akagunduz@gmail.com>
    Cc: Mike Kravetz <mike.kravetz@oracle.com>
    Cc: Rik van Riel <riel@redhat.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit e67a83f078005461b59b4c776e6b5addd11725fa
Author: Mark Rutland <mark.rutland@arm.com>
Date:   Wed Apr 28 12:15:55 2021 +0100

    arm64: entry: always set GIC_PRIO_PSR_I_SET during entry
    
    [ Upstream commit 4d6a38da8e79e94cbd1344aa90876f0f805db705 ]
    
    Zenghui reports that booting a kernel with "irqchip.gicv3_pseudo_nmi=1"
    on the command line hits a warning during kernel entry, due to the way
    we manipulate the PMR.
    
    Early in the entry sequence, we call lockdep_hardirqs_off() to inform
    lockdep that interrupts have been masked (as the HW sets DAIF wqhen
    entering an exception). Architecturally PMR_EL1 is not affected by
    exception entry, and we don't set GIC_PRIO_PSR_I_SET in the PMR early in
    the exception entry sequence, so early in exception entry the PMR can
    indicate that interrupts are unmasked even though they are masked by
    DAIF.
    
    If DEBUG_LOCKDEP is selected, lockdep_hardirqs_off() will check that
    interrupts are masked, before we set GIC_PRIO_PSR_I_SET in any of the
    exception entry paths, and hence lockdep_hardirqs_off() will WARN() that
    something is amiss.
    
    We can avoid this by consistently setting GIC_PRIO_PSR_I_SET during
    exception entry so that kernel code sees a consistent environment. We
    must also update local_daif_inherit() to undo this, as currently only
    touches DAIF. For other paths, local_daif_restore() will update both
    DAIF and the PMR. With this done, we can remove the existing special
    cases which set this later in the entry code.
    
    We always use (GIC_PRIO_IRQON | GIC_PRIO_PSR_I_SET) for consistency with
    local_daif_save(), as this will warn if it ever encounters
    (GIC_PRIO_IRQOFF | GIC_PRIO_PSR_I_SET), and never sets this itself. This
    matches the gic_prio_kentry_setup that we have to retain for
    ret_to_user.
    
    The original splat from Zenghui's report was:
    
    | DEBUG_LOCKS_WARN_ON(!irqs_disabled())
    | WARNING: CPU: 3 PID: 125 at kernel/locking/lockdep.c:4258 lockdep_hardirqs_off+0xd4/0xe8
    | Modules linked in:
    | CPU: 3 PID: 125 Comm: modprobe Tainted: G        W         5.12.0-rc8+ #463
    | Hardware name: QEMU KVM Virtual Machine, BIOS 0.0.0 02/06/2015
    | pstate: 604003c5 (nZCv DAIF +PAN -UAO -TCO BTYPE=--)
    | pc : lockdep_hardirqs_off+0xd4/0xe8
    | lr : lockdep_hardirqs_off+0xd4/0xe8
    | sp : ffff80002a39bad0
    | pmr_save: 000000e0
    | x29: ffff80002a39bad0 x28: ffff0000de214bc0
    | x27: ffff0000de1c0400 x26: 000000000049b328
    | x25: 0000000000406f30 x24: ffff0000de1c00a0
    | x23: 0000000020400005 x22: ffff8000105f747c
    | x21: 0000000096000044 x20: 0000000000498ef9
    | x19: ffff80002a39bc88 x18: ffffffffffffffff
    | x17: 0000000000000000 x16: ffff800011c61eb0
    | x15: ffff800011700a88 x14: 0720072007200720
    | x13: 0720072007200720 x12: 0720072007200720
    | x11: 0720072007200720 x10: 0720072007200720
    | x9 : ffff80002a39bad0 x8 : ffff80002a39bad0
    | x7 : ffff8000119f0800 x6 : c0000000ffff7fff
    | x5 : ffff8000119f07a8 x4 : 0000000000000001
    | x3 : 9bcdab23f2432800 x2 : ffff800011730538
    | x1 : 9bcdab23f2432800 x0 : 0000000000000000
    | Call trace:
    |  lockdep_hardirqs_off+0xd4/0xe8
    |  enter_from_kernel_mode.isra.5+0x7c/0xa8
    |  el1_abort+0x24/0x100
    |  el1_sync_handler+0x80/0xd0
    |  el1_sync+0x6c/0x100
    |  __arch_clear_user+0xc/0x90
    |  load_elf_binary+0x9fc/0x1450
    |  bprm_execve+0x404/0x880
    |  kernel_execve+0x180/0x188
    |  call_usermodehelper_exec_async+0xdc/0x158
    |  ret_from_fork+0x10/0x18
    
    Fixes: 23529049c684 ("arm64: entry: fix non-NMI user<->kernel transitions")
    Fixes: 7cd1ea1010ac ("arm64: entry: fix non-NMI kernel<->kernel transitions")
    Fixes: f0cd5ac1e4c5 ("arm64: entry: fix NMI {user, kernel}->kernel transitions")
    Fixes: 2a9b3e6ac69a ("arm64: entry: fix EL1 debug transitions")
    Link: https://lore.kernel.org/r/f4012761-026f-4e51-3a0c-7524e434e8b3@huawei.com
    Signed-off-by: Mark Rutland <mark.rutland@arm.com>
    Reported-by: Zenghui Yu <yuzenghui@huawei.com>
    Cc: Marc Zyngier <maz@kernel.org>
    Cc: Will Deacon <will@kernel.org>
    Acked-by: Marc Zyngier <maz@kernel.org>
    Link: https://lore.kernel.org/r/20210428111555.50880-1-mark.rutland@arm.com
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 76e2524389dfd6a9d96f63c2891b5acd817faaf1
Author: Marc Zyngier <maz@kernel.org>
Date:   Mon Mar 15 11:56:27 2021 +0000

    arm64: entry: factor irq triage logic into macros
    
    [ Upstream commit 9eb563cdabe1d583c262042d5d44cc256f644543 ]
    
    In subsequent patches we'll allow an FIQ handler to be registered, and
    FIQ exceptions will need to be triaged very similarly to IRQ exceptions.
    So that we can reuse the existing logic, this patch factors the IRQ
    triage logic out into macros that can be reused for FIQ.
    
    The macros are named to follow the elX_foo_handler scheme used by the C
    exception handlers. For consistency with other top-level exception
    handlers, the kernel_entry/kernel_exit logic is not moved into the
    macros. As FIQ will use a different C handler, this handler name is
    provided as an argument to the macros.
    
    There should be no functional change as a result of this patch.
    
    Signed-off-by: Marc Zyngier <maz@kernel.org>
    [Mark: rework macros, commit message, rebase before DAIF rework]
    Signed-off-by: Mark Rutland <mark.rutland@arm.com>
    Tested-by: Hector Martin <marcan@marcan.st>
    Cc: James Morse <james.morse@arm.com>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Will Deacon <will@kernel.org>
    Acked-by: Will Deacon <will@kernel.org>
    Link: https://lore.kernel.org/r/20210315115629.57191-5-mark.rutland@arm.com
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 88a2148284db8fbfe5ef169ae9ab3c4925f05678
Author: Kees Cook <keescook@chromium.org>
Date:   Sun May 2 22:06:08 2021 -0700

    drm/radeon: Avoid power table parsing memory leaks
    
    [ Upstream commit c69f27137a38d24301a6b659454a91ad85dff4aa ]
    
    Avoid leaving a hanging pre-allocated clock_info if last mode is
    invalid, and avoid heap corruption if no valid modes are found.
    
    Bug: https://bugzilla.kernel.org/show_bug.cgi?id=211537
    Fixes: 6991b8f2a319 ("drm/radeon/kms: fix segfault in pm rework")
    Signed-off-by: Kees Cook <keescook@chromium.org>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 0e99b5416f220c037d50401cda60550f3e82e92b
Author: Kees Cook <keescook@chromium.org>
Date:   Sun May 2 22:06:07 2021 -0700

    drm/radeon: Fix off-by-one power_state index heap overwrite
    
    [ Upstream commit 5bbf219328849e83878bddb7c226d8d42e84affc ]
    
    An out of bounds write happens when setting the default power state.
    KASAN sees this as:
    
    [drm] radeon: 512M of GTT memory ready.
    [drm] GART: num cpu pages 131072, num gpu pages 131072
    ==================================================================
    BUG: KASAN: slab-out-of-bounds in
    radeon_atombios_parse_power_table_1_3+0x1837/0x1998 [radeon]
    Write of size 4 at addr ffff88810178d858 by task systemd-udevd/157
    
    CPU: 0 PID: 157 Comm: systemd-udevd Not tainted 5.12.0-E620 #50
    Hardware name: eMachines        eMachines E620  /Nile       , BIOS V1.03 09/30/2008
    Call Trace:
     dump_stack+0xa5/0xe6
     print_address_description.constprop.0+0x18/0x239
     kasan_report+0x170/0x1a8
     radeon_atombios_parse_power_table_1_3+0x1837/0x1998 [radeon]
     radeon_atombios_get_power_modes+0x144/0x1888 [radeon]
     radeon_pm_init+0x1019/0x1904 [radeon]
     rs690_init+0x76e/0x84a [radeon]
     radeon_device_init+0x1c1a/0x21e5 [radeon]
     radeon_driver_load_kms+0xf5/0x30b [radeon]
     drm_dev_register+0x255/0x4a0 [drm]
     radeon_pci_probe+0x246/0x2f6 [radeon]
     pci_device_probe+0x1aa/0x294
     really_probe+0x30e/0x850
     driver_probe_device+0xe6/0x135
     device_driver_attach+0xc1/0xf8
     __driver_attach+0x13f/0x146
     bus_for_each_dev+0xfa/0x146
     bus_add_driver+0x2b3/0x447
     driver_register+0x242/0x2c1
     do_one_initcall+0x149/0x2fd
     do_init_module+0x1ae/0x573
     load_module+0x4dee/0x5cca
     __do_sys_finit_module+0xf1/0x140
     do_syscall_64+0x33/0x40
     entry_SYSCALL_64_after_hwframe+0x44/0xae
    
    Without KASAN, this will manifest later when the kernel attempts to
    allocate memory that was stomped, since it collides with the inline slab
    freelist pointer:
    
    invalid opcode: 0000 [#1] SMP NOPTI
    CPU: 0 PID: 781 Comm: openrc-run.sh Tainted: G        W 5.10.12-gentoo-E620 #2
    Hardware name: eMachines        eMachines E620  /Nile , BIOS V1.03       09/30/2008
    RIP: 0010:kfree+0x115/0x230
    Code: 89 c5 e8 75 ea ff ff 48 8b 00 0f ba e0 09 72 63 e8 1f f4 ff ff 41 89 c4 48 8b 45 00 0f ba e0 10 72 0a 48 8b 45 08 a8 01 75 02 <0f> 0b 44 89 e1 48 c7 c2 00 f0 ff ff be 06 00 00 00 48 d3 e2 48 c7
    RSP: 0018:ffffb42f40267e10 EFLAGS: 00010246
    RAX: ffffd61280ee8d88 RBX: 0000000000000004 RCX: 000000008010000d
    RDX: 4000000000000000 RSI: ffffffffba1360b0 RDI: ffffd61280ee8d80
    RBP: ffffd61280ee8d80 R08: ffffffffb91bebdf R09: 0000000000000000
    R10: ffff8fe2c1047ac8 R11: 0000000000000000 R12: 0000000000000000
    R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000100
    FS:  00007fe80eff6b68(0000) GS:ffff8fe339c00000(0000) knlGS:0000000000000000
    CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    CR2: 00007fe80eec7bc0 CR3: 0000000038012000 CR4: 00000000000006f0
    Call Trace:
     __free_fdtable+0x16/0x1f
     put_files_struct+0x81/0x9b
     do_exit+0x433/0x94d
     do_group_exit+0xa6/0xa6
     __x64_sys_exit_group+0xf/0xf
     do_syscall_64+0x33/0x40
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    RIP: 0033:0x7fe80ef64bea
    Code: Unable to access opcode bytes at RIP 0x7fe80ef64bc0.
    RSP: 002b:00007ffdb1c47528 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
    RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 00007fe80ef64bea
    RDX: 00007fe80ef64f60 RSI: 0000000000000000 RDI: 0000000000000000
    RBP: 0000000000000000 R08: 0000000000000001 R09: 0000000000000000
    R10: 00007fe80ee2c620 R11: 0000000000000246 R12: 00007fe80eff41e0
    R13: 00000000ffffffff R14: 0000000000000024 R15: 00007fe80edf9cd0
    Modules linked in: radeon(+) ath5k(+) snd_hda_codec_realtek ...
    
    Use a valid power_state index when initializing the "flags" and "misc"
    and "misc2" fields.
    
    Bug: https://bugzilla.kernel.org/show_bug.cgi?id=211537
    Reported-by: Erhard F. <erhard_f@mailbox.org>
    Fixes: a48b9b4edb8b ("drm/radeon/kms/pm: add asic specific callbacks for getting power state (v2)")
    Fixes: 79daedc94281 ("drm/radeon/kms: minor pm cleanups")
    Signed-off-by: Kees Cook <keescook@chromium.org>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit eb541e25d807a075117c63d83c6c7721f33168fc
Author: Ramesh Babu B <ramesh.babu.b@intel.com>
Date:   Tue May 4 21:12:41 2021 +0530

    net: stmmac: Clear receive all(RA) bit when promiscuous mode is off
    
    [ Upstream commit 4c7a94286ef7ac7301d633f17519fb1bb89d7550 ]
    
    In promiscuous mode Receive All bit is set in GMAC packet filter register,
    but outside promiscuous mode Receive All bit is not cleared,
    which resulted in all network packets are received when toggle (ON/OFF)
    the promiscuous mode.
    
    Fixes: e0f9956a3862 ("net: stmmac: Add option for VLAN filter fail queue enable")
    Signed-off-by: Ramesh Babu B <ramesh.babu.b@intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2104e2a9aea27912a92a980796b554d4b5563d58
Author: Xuan Zhuo <xuanzhuo@linux.alibaba.com>
Date:   Wed Apr 28 17:44:24 2021 +0800

    xsk: Fix for xp_aligned_validate_desc() when len == chunk_size
    
    [ Upstream commit ac31565c21937eee9117e43c9cd34f557f6f1cb8 ]
    
    When desc->len is equal to chunk_size, it is legal. But when the
    xp_aligned_validate_desc() got chunk_end from desc->addr + desc->len
    pointing to the next chunk during the check, it caused the check to
    fail.
    
    This problem was first introduced in bbff2f321a86 ("xsk: new descriptor
    addressing scheme"). Later in 2b43470add8c ("xsk: Introduce AF_XDP buffer
    allocation API") this piece of code was moved into the new function called
    xp_aligned_validate_desc(). This function was then moved into xsk_queue.h
    via 26062b185eee ("xsk: Explicitly inline functions and move definitions").
    
    Fixes: bbff2f321a86 ("xsk: new descriptor addressing scheme")
    Signed-off-by: Xuan Zhuo <xuanzhuo@linux.alibaba.com>
    Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
    Acked-by: Magnus Karlsson <magnus.karlsson@intel.com>
    Link: https://lore.kernel.org/bpf/20210428094424.54435-1-xuanzhuo@linux.alibaba.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f2252cb43c6c53c83682f62ef8d3c26f6873cf4c
Author: Pablo Neira Ayuso <pablo@netfilter.org>
Date:   Fri Apr 30 14:00:13 2021 +0200

    netfilter: xt_SECMARK: add new revision to fix structure layout
    
    [ Upstream commit c7d13358b6a2f49f81a34aa323a2d0878a0532a2 ]
    
    This extension breaks when trying to delete rules, add a new revision to
    fix this.
    
    Fixes: 5e6874cdb8de ("[SECMARK]: Add xtables SECMARK target")
    Signed-off-by: Phil Sutter <phil@nwl.cc>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 71af6139c067779eb29f4198434cc32f48a494b5
Author: Xin Long <lucien.xin@gmail.com>
Date:   Mon May 3 04:41:20 2021 +0800

    sctp: fix a SCTP_MIB_CURRESTAB leak in sctp_sf_do_dupcook_b
    
    [ Upstream commit f282df0391267fb2b263da1cc3233aa6fb81defc ]
    
    Normally SCTP_MIB_CURRESTAB is always incremented once asoc enter into
    ESTABLISHED from the state < ESTABLISHED and decremented when the asoc
    is being deleted.
    
    However, in sctp_sf_do_dupcook_b(), the asoc's state can be changed to
    ESTABLISHED from the state >= ESTABLISHED where it shouldn't increment
    SCTP_MIB_CURRESTAB. Otherwise, one asoc may increment MIB_CURRESTAB
    multiple times but only decrement once at the end.
    
    I was able to reproduce it by using scapy to do the 4-way shakehands,
    after that I replayed the COOKIE-ECHO chunk with 'peer_vtag' field
    changed to different values, and SCTP_MIB_CURRESTAB was incremented
    multiple times and never went back to 0 even when the asoc was freed.
    
    This patch is to fix it by only incrementing SCTP_MIB_CURRESTAB when
    the state < ESTABLISHED in sctp_sf_do_dupcook_b().
    
    Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
    Reported-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 6892396ebf04ea2c021d80e10f4075e014cd7cc3
Author: Lv Yunlong <lyl2019@mail.ustc.edu.cn>
Date:   Sun May 2 04:58:18 2021 -0700

    ethernet:enic: Fix a use after free bug in enic_hard_start_xmit
    
    [ Upstream commit 643001b47adc844ae33510c4bb93c236667008a3 ]
    
    In enic_hard_start_xmit, it calls enic_queue_wq_skb(). Inside
    enic_queue_wq_skb, if some error happens, the skb will be freed
    by dev_kfree_skb(skb). But the freed skb is still used in
    skb_tx_timestamp(skb).
    
    My patch makes enic_queue_wq_skb() return error and goto spin_unlock()
    incase of error. The solution is provided by Govind.
    See https://lkml.org/lkml/2021/4/30/961.
    
    Fixes: fb7516d42478e ("enic: add sw timestamp support")
    Signed-off-by: Lv Yunlong <lyl2019@mail.ustc.edu.cn>
    Acked-by: Govindarajulu Varadarajan <gvaradar@cisco.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 281c236887705e25b82b1fd5803e71c12aec3bc4
Author: Jim Quinlan <jim2101024@gmail.com>
Date:   Fri Apr 30 11:21:56 2021 -0400

    PCI: brcmstb: Use reset/rearm instead of deassert/assert
    
    [ Upstream commit bb610757fcd74558ad94fe19993fd4470208dd02 ]
    
    The Broadcom STB PCIe RC uses a reset control "rescal" for certain chips.
    The "rescal" implements a "pulse reset" so using assert/deassert is wrong
    for this device.  Instead, we use reset/rearm.  We need to use rearm so
    that we can reset it after a suspend/resume cycle; w/o using "rearm", the
    "rescal" device will only ever fire once.
    
    Of course for suspend/resume to work we also need to put the reset/rearm
    calls in the suspend and resume routines.
    
    Fixes: 740d6c3708a9 ("PCI: brcmstb: Add control of rescal reset")
    Link: https://lore.kernel.org/r/20210430152156.21162-4-jim2101024@gmail.com
    Signed-off-by: Jim Quinlan <jim2101024@gmail.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Acked-by: Florian Fainelli <f.fainelli@gmail.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4d3f043efd23467de3238362ae57e494d94d968b
Author: Jim Quinlan <jim2101024@gmail.com>
Date:   Fri Apr 30 11:21:55 2021 -0400

    ata: ahci_brcm: Fix use of BCM7216 reset controller
    
    [ Upstream commit e8d6f9e56187c101b325e8d18f1d4032420d08ff ]
    
    This driver may use one of two resets controllers.  Keep them in separate
    variables to keep things simple.  The reset controller "rescal" is shared
    between the AHCI driver and the PCIe driver for the BrcmSTB 7216 chip.  Use
    devm_reset_control_get_optional_shared() to handle this sharing.
    
    [bhelgaas: add Jens' ack from v5 posting]
    Fixes: 272ecd60a636 ("ata: ahci_brcm: BCM7216 reset is self de-asserting")
    Fixes: c345ec6a50e9 ("ata: ahci_brcm: Support BCM7216 reset controller name")
    Link: https://lore.kernel.org/r/20210430152156.21162-3-jim2101024@gmail.com
    Signed-off-by: Jim Quinlan <jim2101024@gmail.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Acked-by: Jens Axboe <axboe@kernel.dk>
    Acked-by: Florian Fainelli <f.fainelli@gmail.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5dd8b27bb2ba923f76139ac446b7de656a571506
Author: Md Haris Iqbal <haris.iqbal@cloud.ionos.com>
Date:   Wed Apr 28 08:13:58 2021 +0200

    block/rnbd-clt: Check the return value of the function rtrs_clt_query
    
    [ Upstream commit 1056ad829ec43f9b705b507c2093b05e2088b0b7 ]
    
    In case none of the paths are in connected state, the function
    rtrs_clt_query returns an error. In such a case, error out since the
    values in the rtrs_attrs structure would be garbage.
    
    Fixes: f7a7a5c228d45 ("block/rnbd: client: main functionality")
    Signed-off-by: Md Haris Iqbal <haris.iqbal@ionos.com>
    Reviewed-by: Guoqing Jiang <guoqing.jiang@ionos.com>
    Signed-off-by: Jack Wang <jinpu.wang@ionos.com>
    Signed-off-by: Gioh Kim <gi-oh.kim@ionos.com>
    Link: https://lore.kernel.org/r/20210428061359.206794-4-gi-oh.kim@ionos.com
    Signed-off-by: Jens Axboe <axboe@kernel.dk>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 52b133687856a32de593a0fe54cce999ddf6454b
Author: Md Haris Iqbal <haris.iqbal@cloud.ionos.com>
Date:   Wed Apr 28 08:13:56 2021 +0200

    block/rnbd-clt: Change queue_depth type in rnbd_clt_session to size_t
    
    [ Upstream commit 80d43cbd46155744ee450d2476ee4fcf2917ae9b ]
    
    The member queue_depth in the structure rnbd_clt_session is read from the
    rtrs client side using the function rtrs_clt_query, which in turn is read
    from the rtrs_clt structure. It should really be of type size_t.
    
    Fixes: 90426e89f54db ("block/rnbd: client: private header with client structs and functions")
    Signed-off-by: Md Haris Iqbal <haris.iqbal@ionos.com>
    Reviewed-by: Guoqing Jiang <guoqing.jiang@ionos.com>
    Signed-off-by: Gioh Kim <gi-oh.kim@ionos.com>
    Link: https://lore.kernel.org/r/20210428061359.206794-2-gi-oh.kim@ionos.com
    Signed-off-by: Jens Axboe <axboe@kernel.dk>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7b8ea4953a3fd4eb690a1c0272015ade3e2cefc3
Author: Brendan Jackman <jackmanb@google.com>
Date:   Thu Apr 29 13:05:10 2021 +0000

    libbpf: Fix signed overflow in ringbuf_process_ring
    
    [ Upstream commit 2a30f9440640c418bcfbea9b2b344d268b58e0a2 ]
    
    One of our benchmarks running in (Google-internal) CI pushes data
    through the ringbuf faster htan than userspace is able to consume
    it. In this case it seems we're actually able to get >INT_MAX entries
    in a single ring_buffer__consume() call. ASAN detected that cnt
    overflows in this case.
    
    Fix by using 64-bit counter internally and then capping the result to
    INT_MAX before converting to the int return type. Do the same for
    the ring_buffer__poll().
    
    Fixes: bf99c936f947 (libbpf: Add BPF ring buffer support)
    Signed-off-by: Brendan Jackman <jackmanb@google.com>
    Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
    Link: https://lore.kernel.org/bpf/20210429130510.1621665-1-jackmanb@google.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a521954cc34f2df86d2e0fa8a553b25dff6736a4
Author: Baptiste Lepers <baptiste.lepers@gmail.com>
Date:   Sat May 1 14:10:51 2021 +1000

    sunrpc: Fix misplaced barrier in call_decode
    
    [ Upstream commit f8f7e0fb22b2e75be55f2f0c13e229e75b0eac07 ]
    
    Fix a misplaced barrier in call_decode. The struct rpc_rqst is modified
    as follows by xprt_complete_rqst:
    
    req->rq_private_buf.len = copied;
    /* Ensure all writes are done before we update */
    /* req->rq_reply_bytes_recvd */
    smp_wmb();
    req->rq_reply_bytes_recvd = copied;
    
    And currently read as follows by call_decode:
    
    smp_rmb(); // misplaced
    if (!req->rq_reply_bytes_recvd)
       goto out;
    req->rq_rcv_buf.len = req->rq_private_buf.len;
    
    This patch places the smp_rmb after the if to ensure that
    rq_reply_bytes_recvd and rq_private_buf.len are read in order.
    
    Fixes: 9ba828861c56a ("SUNRPC: Don't try to parse incomplete RPC messages")
    Signed-off-by: Baptiste Lepers <baptiste.lepers@gmail.com>
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8e27c4731aecfff34c5d33781fb59d7a2a86ef6c
Author: Anup Patel <anup.patel@wdc.com>
Date:   Thu Apr 15 14:25:22 2021 +0530

    RISC-V: Fix error code returned by riscv_hartid_to_cpuid()
    
    [ Upstream commit 533b4f3a789d49574e7ae0f6ececed153f651f97 ]
    
    We should return a negative error code upon failure in
    riscv_hartid_to_cpuid() instead of NR_CPUS. This is also
    aligned with all uses of riscv_hartid_to_cpuid() which
    expect negative error code upon failure.
    
    Fixes: 6825c7a80f18 ("RISC-V: Add logical CPU indexing for RISC-V")
    Fixes: f99fb607fb2b ("RISC-V: Use Linux logical CPU number instead of hartid")
    Signed-off-by: Anup Patel <anup.patel@wdc.com>
    Signed-off-by: Palmer Dabbelt <palmerdabbelt@google.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 61b877bad9bb0d82b7d8841be50872557090a704
Author: Xin Long <lucien.xin@gmail.com>
Date:   Sat May 1 04:02:58 2021 +0800

    sctp: do asoc update earlier in sctp_sf_do_dupcook_a
    
    [ Upstream commit 35b4f24415c854cd718ccdf38dbea6297f010aae ]
    
    There's a panic that occurs in a few of envs, the call trace is as below:
    
      [] general protection fault, ... 0x29acd70f1000a: 0000 [#1] SMP PTI
      [] RIP: 0010:sctp_ulpevent_notify_peer_addr_change+0x4b/0x1fa [sctp]
      []  sctp_assoc_control_transport+0x1b9/0x210 [sctp]
      []  sctp_do_8_2_transport_strike.isra.16+0x15c/0x220 [sctp]
      []  sctp_cmd_interpreter.isra.21+0x1231/0x1a10 [sctp]
      []  sctp_do_sm+0xc3/0x2a0 [sctp]
      []  sctp_generate_timeout_event+0x81/0xf0 [sctp]
    
    This is caused by a transport use-after-free issue. When processing a
    duplicate COOKIE-ECHO chunk in sctp_sf_do_dupcook_a(), both COOKIE-ACK
    and SHUTDOWN chunks are allocated with the transort from the new asoc.
    However, later in the sideeffect machine, the old asoc is used to send
    them out and old asoc's shutdown_last_sent_to is set to the transport
    that SHUTDOWN chunk attached to in sctp_cmd_setup_t2(), which actually
    belongs to the new asoc. After the new_asoc is freed and the old asoc
    T2 timeout, the old asoc's shutdown_last_sent_to that is already freed
    would be accessed in sctp_sf_t2_timer_expire().
    
    Thanks Alexander and Jere for helping dig into this issue.
    
    To fix it, this patch is to do the asoc update first, then allocate
    the COOKIE-ACK and SHUTDOWN chunks with the 'updated' old asoc. This
    would make more sense, as a chunk from an asoc shouldn't be sent out
    with another asoc. We had fixed quite a few issues caused by this.
    
    Fixes: 145cb2f7177d ("sctp: Fix bundling of SHUTDOWN with COOKIE-ACK")
    Reported-by: Alexander Sverdlin <alexander.sverdlin@nokia.com>
    Reported-by: syzbot+bbe538efd1046586f587@syzkaller.appspotmail.com
    Reported-by: Michal Tesar <mtesar@redhat.com>
    Signed-off-by: Xin Long <lucien.xin@gmail.com>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 667913bd380660293c588ddd0973b556b9a06a7d
Author: Yufeng Mo <moyufeng@huawei.com>
Date:   Fri Apr 30 17:06:22 2021 +0800

    net: hns3: disable phy loopback setting in hclge_mac_start_phy
    
    [ Upstream commit 472497d0bdae890a896013332a0b673f9acdf2bf ]
    
    If selftest and reset are performed at the same time, the phy
    loopback setting may be still in enable state after the reset,
    and device cannot link up. So fix this issue by disabling phy
    loopback before phy_start().
    
    Fixes: 256727da7395 ("net: hns3: Add MDIO support to HNS3 Ethernet driver for hip08 SoC")
    Signed-off-by: Yufeng Mo <moyufeng@huawei.com>
    Signed-off-by: Huazhong Tan <tanhuazhong@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c727b94843f23cd608f0e93910a118c60f46687f
Author: Peng Li <lipeng321@huawei.com>
Date:   Fri Apr 30 17:06:20 2021 +0800

    net: hns3: use netif_tx_disable to stop the transmit queue
    
    [ Upstream commit b416e872be06fdace3c36cf5210130509d0f0e72 ]
    
    Currently, netif_tx_stop_all_queues() is used to ensure that
    the xmit is not running, but for the concurrent case it will
    not take effect, since netif_tx_stop_all_queues() just sets
    a flag without locking to indicate that the xmit queue(s)
    should not be run.
    
    So use netif_tx_disable() to replace netif_tx_stop_all_queues(),
    it takes the xmit queue lock while marking the queue stopped.
    
    Fixes: 76ad4f0ee747 ("net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC")
    Signed-off-by: Peng Li <lipeng321@huawei.com>
    Signed-off-by: Huazhong Tan <tanhuazhong@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c3856a0351b4dc748a7619664e70d458540c16e8
Author: Hao Chen <chenhao288@hisilicon.com>
Date:   Fri Apr 30 17:06:19 2021 +0800

    net: hns3: fix for vxlan gpe tx checksum bug
    
    [ Upstream commit 905416f18fe74bdd4de91bf94ef5a790a36e4b99 ]
    
    When skb->ip_summed is CHECKSUM_PARTIAL, for non-tunnel udp packet,
    which has a dest port as the IANA assigned, the hardware is expected
    to do the checksum offload, but the hardware whose version is below
    V3 will not do the checksum offload when udp dest port is 4790.
    
    So fixes it by doing the checksum in software for this case.
    
    Fixes: 76ad4f0ee747 ("net: hns3: Add support of HNS3 Ethernet Driver for hip08 SoC")
    Signed-off-by: Hao Chen <chenhao288@hisilicon.com>
    Signed-off-by: Huazhong Tan <tanhuazhong@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 018c4f2f0cff8d3b34414c1970ba8435a44ec717
Author: Jian Shen <shenjian15@huawei.com>
Date:   Thu Apr 29 16:34:52 2021 +0800

    net: hns3: add check for HNS3_NIC_STATE_INITED in hns3_reset_notify_up_enet()
    
    [ Upstream commit b4047aac4ec1066bab6c71950623746d7bcf7154 ]
    
    In some cases, the device is not initialized because reset failed.
    If another task calls hns3_reset_notify_up_enet() before reset
    retry, it will cause an error since uninitialized pointer access.
    So add check for HNS3_NIC_STATE_INITED before calling
    hns3_nic_net_open() in hns3_reset_notify_up_enet().
    
    Fixes: bb6b94a896d4 ("net: hns3: Add reset interface implementation in client")
    Signed-off-by: Jian Shen <shenjian15@huawei.com>
    Signed-off-by: Huazhong Tan <tanhuazhong@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a6e52bafd23232507d92abc4a1551aeb71c4053d
Author: Yufeng Mo <moyufeng@huawei.com>
Date:   Thu Apr 29 16:34:51 2021 +0800

    net: hns3: initialize the message content in hclge_get_link_mode()
    
    [ Upstream commit 568a54bdf70b143f3e0befa298e22ad469ffc732 ]
    
    The message sent to VF should be initialized, otherwise random
    value of some contents may cause improper processing by the target.
    So add a initialization to message in hclge_get_link_mode().
    
    Fixes: 9194d18b0577 ("net: hns3: fix the problem that the supported port is empty")
    Signed-off-by: Yufeng Mo <moyufeng@huawei.com>
    Signed-off-by: Huazhong Tan <tanhuazhong@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ee17f6da4d52380ef5e72388af1843de7d4dbb7b
Author: Yufeng Mo <moyufeng@huawei.com>
Date:   Thu Apr 29 16:34:50 2021 +0800

    net: hns3: fix incorrect configuration for igu_egu_hw_err
    
    [ Upstream commit 2867298dd49ee84214b8721521dc7a5a6382520c ]
    
    According to the UM, the type and enable status of igu_egu_hw_err
    should be configured separately. Currently, the type field is
    incorrect when disable this error. So fix it by configuring these
    two fields separately.
    
    Fixes: bf1faf9415dd ("net: hns3: Add enable and process hw errors from IGU, EGU and NCSI")
    Signed-off-by: Yufeng Mo <moyufeng@huawei.com>
    Signed-off-by: Huazhong Tan <tanhuazhong@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 129a5bb630a8f3ec2b09afc6f6545990f4b9b9e9
Author: Nobuhiro Iwamatsu <nobuhiro1.iwamatsu@toshiba.co.jp>
Date:   Tue Apr 20 11:39:17 2021 +0900

    rtc: ds1307: Fix wday settings for rx8130
    
    [ Upstream commit 204756f016726a380bafe619438ed979088bd04a ]
    
    rx8130 wday specifies the bit position, not BCD.
    
    Fixes: ee0981be7704 ("rtc: ds1307: Add support for Epson RX8130CE")
    Signed-off-by: Nobuhiro Iwamatsu <nobuhiro1.iwamatsu@toshiba.co.jp>
    Signed-off-by: Alexandre Belloni <alexandre.belloni@bootlin.com>
    Link: https://lore.kernel.org/r/20210420023917.1949066-1-nobuhiro1.iwamatsu@toshiba.co.jp
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5f359c4c2d5fbffee87592dfc01d29cadfaba856
Author: Can Guo <cang@codeaurora.org>
Date:   Sun Apr 25 20:48:40 2021 -0700

    scsi: ufs: core: Narrow down fast path in system suspend path
    
    [ Upstream commit ce4f62f9dd8cf43ac044045ed598a0b80ef33890 ]
    
    If spm_lvl is set to 0 or 1, when system suspend kicks start and HBA is
    runtime active, system suspend may just bail without doing anything (the
    fast path), leaving other contexts still running, e.g., clock gating and
    clock scaling. When system resume kicks start, concurrency can happen
    between ufshcd_resume() and these contexts, leading to various stability
    issues.
    
    Add a check against HBA's runtime state and allowing fast path only if HBA
    is runtime suspended, otherwise let system suspend go ahead call
    ufshcd_suspend(). This will guarantee that these contexts are stopped by
    either runtime suspend or system suspend.
    
    Link: https://lore.kernel.org/r/1619408921-30426-4-git-send-email-cang@codeaurora.org
    Fixes: 0b257734344a ("scsi: ufs: optimize system suspend handling")
    Reviewed-by: Daejun Park <daejun7.park@samsung.com>
    Signed-off-by: Can Guo <cang@codeaurora.org>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 3ac330861f99baced78813914bfc9f3e7ea6f04e
Author: Can Guo <cang@codeaurora.org>
Date:   Sun Apr 25 20:48:39 2021 -0700

    scsi: ufs: core: Cancel rpm_dev_flush_recheck_work during system suspend
    
    [ Upstream commit 637822e63b79ee8a729f7ba2645a26cf5a524ee4 ]
    
    During ufs system suspend, leaving rpm_dev_flush_recheck_work running or
    pending is risky because concurrency may happen between system
    suspend/resume and runtime resume routine. Fix this by cancelling
    rpm_dev_flush_recheck_work synchronously during system suspend.
    
    Link: https://lore.kernel.org/r/1619408921-30426-3-git-send-email-cang@codeaurora.org
    Fixes: 51dd905bd2f6 ("scsi: ufs: Fix WriteBooster flush during runtime suspend")
    Reviewed-by: Daejun Park <daejun7.park@samsung.com>
    Signed-off-by: Can Guo <cang@codeaurora.org>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit bd7e06d6d711bd22292d1caab1880e2636f67772
Author: Can Guo <cang@codeaurora.org>
Date:   Sun Apr 25 20:48:38 2021 -0700

    scsi: ufs: core: Do not put UFS power into LPM if link is broken
    
    [ Upstream commit 23043dd87b153d02eaf676e752d32429be5e5126 ]
    
    During resume, if link is broken due to AH8 failure, make sure
    ufshcd_resume() does not put UFS power back into LPM.
    
    Link: https://lore.kernel.org/r/1619408921-30426-2-git-send-email-cang@codeaurora.org
    Fixes: 4db7a2360597 ("scsi: ufs: Fix concurrency of error handler and other error recovery paths")
    Reviewed-by: Daejun Park <daejun7.park@samsung.com>
    Signed-off-by: Can Guo <cang@codeaurora.org>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 6d779793a904487c5add154a5b2dcbd82f08d92a
Author: Anastasia Kovaleva <a.kovaleva@yadro.com>
Date:   Thu Apr 22 18:34:14 2021 +0300

    scsi: qla2xxx: Prevent PRLI in target mode
    
    [ Upstream commit fcb16d9a8ecf1e9bfced0fc654ea4e2caa7517f4 ]
    
    In a case when the initiator in P2P mode by some circumstances does not
    send PRLI, the target, in a case when the target port's WWPN is less than
    initiator's, changes the discovery state in DSC_GNL. When gnl completes it
    sends PRLI to the initiator.
    
    Usually the initiator in P2P mode always sends PRLI. We caught this issue
    on Linux stable v5.4.6 https://www.spinics.net/lists/stable/msg458515.html.
    
    Fix this particular corner case in the behaviour of the P2P mod target
    login state machine.
    
    Link: https://lore.kernel.org/r/20210422153414.4022-1-a.kovaleva@yadro.com
    Fixes: a9ed06d4e640 ("scsi: qla2xxx: Allow PLOGI in target mode")
    Reviewed-by: Roman Bolshakov <r.bolshakov@yadro.com>
    Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
    Signed-off-by: Anastasia Kovaleva <a.kovaleva@yadro.com>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 22fa4c8288f1ec40f6d62d7a32c57ac176f9f0bc
Author: Jeff Layton <jlayton@kernel.org>
Date:   Fri Mar 26 09:21:53 2021 -0400

    ceph: fix inode leak on getattr error in __fh_to_dentry
    
    [ Upstream commit 1775c7ddacfcea29051c67409087578f8f4d751b ]
    
    Fixes: 878dabb64117 ("ceph: don't return -ESTALE if there's still an open file")
    Signed-off-by: Jeff Layton <jlayton@kernel.org>
    Reviewed-by: Xiubo Li <xiubli@redhat.com>
    Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 262adcb7c23092747b541b8f8ff18b6e53a6d50d
Author: Claire Chang <tientzu@chromium.org>
Date:   Thu Apr 22 16:14:53 2021 +0800

    swiotlb: Fix the type of index
    
    [ Upstream commit 95b079d8215b83b37fa59341fda92fcb9392f14a ]
    
    Fix the type of index from unsigned int to int since find_slots() might
    return -1.
    
    Fixes: 26a7e094783d ("swiotlb: refactor swiotlb_tbl_map_single")
    Reviewed-by: Christoph Hellwig <hch@lst.de>
    Signed-off-by: Claire Chang <tientzu@chromium.org>
    Signed-off-by: Konrad Rzeszutek Wilk <konrad@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ebdd1961f8950a6417c2e8ce21555e86882be610
Author: Chuck Lever <chuck.lever@oracle.com>
Date:   Mon Apr 19 14:02:54 2021 -0400

    xprtrdma: rpcrdma_mr_pop() already does list_del_init()
    
    [ Upstream commit 1363e6388c363d0433f9aa4e2f33efe047572687 ]
    
    The rpcrdma_mr_pop() earlier in the function has already cleared
    out mr_list, so it must not be done again in the error path.
    
    Fixes: 847568942f93 ("xprtrdma: Remove fr_state")
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8834ecb5df22b7ff3c9b0deba7726579bb613f95
Author: Chuck Lever <chuck.lever@oracle.com>
Date:   Mon Apr 19 14:02:41 2021 -0400

    xprtrdma: Fix cwnd update ordering
    
    [ Upstream commit 35d8b10a25884050bb3b0149b62c3818ec59f77c ]
    
    After a reconnect, the reply handler is opening the cwnd (and thus
    enabling more RPC Calls to be sent) /before/ rpcrdma_post_recvs()
    can post enough Receive WRs to receive their replies. This causes an
    RNR and the new connection is lost immediately.
    
    The race is most clearly exposed when KASAN and disconnect injection
    are enabled. This slows down rpcrdma_rep_create() enough to allow
    the send side to post a bunch of RPC Calls before the Receive
    completion handler can invoke ib_post_recv().
    
    Fixes: 2ae50ad68cd7 ("xprtrdma: Close window between waking RPC senders and posting Receives")
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 6276265c31a70fa88a8c1317e09f2e01d4d9c339
Author: Chuck Lever <chuck.lever@oracle.com>
Date:   Mon Apr 19 14:02:03 2021 -0400

    xprtrdma: Avoid Receive Queue wrapping
    
    [ Upstream commit 32e6b68167f1d446111c973d57e6f52aee11897a ]
    
    Commit e340c2d6ef2a ("xprtrdma: Reduce the doorbell rate (Receive)")
    increased the number of Receive WRs that are posted by the client,
    but did not increase the size of the Receive Queue allocated during
    transport set-up.
    
    This is usually not an issue because RPCRDMA_BACKWARD_WRS is defined
    as (32) when SUNRPC_BACKCHANNEL is defined. In cases where it isn't,
    there is a real risk of Receive Queue wrapping.
    
    Fixes: e340c2d6ef2a ("xprtrdma: Reduce the doorbell rate (Receive)")
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Reviewed-by: Tom Talpey <tom@talpey.com>
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8a6f204ac8413c9a9760e5c249885a256e6df44f
Author: Uwe Kleine-König <u.kleine-koenig@pengutronix.de>
Date:   Tue Apr 20 11:51:17 2021 +0200

    pwm: atmel: Fix duty cycle calculation in .get_state()
    
    [ Upstream commit 453e8b3d8e36ddcb283b3d1698864a03ea45599a ]
    
    The CDTY register contains the number of inactive cycles. .apply() does
    this correctly, however .get_state() got this wrong.
    
    Fixes: 651b510a74d4 ("pwm: atmel: Implement .get_state()")
    Signed-off-by: Uwe Kleine-König <u.kleine-koenig@pengutronix.de>
    Signed-off-by: Thierry Reding <thierry.reding@gmail.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1e10f58f1c9a6b667b045513c7a4e6111c24fe7c
Author: Yunjian Wang <wangyunjian@huawei.com>
Date:   Fri Apr 23 17:42:58 2021 +0800

    SUNRPC: Fix null pointer dereference in svc_rqst_free()
    
    [ Upstream commit b9f83ffaa0c096b4c832a43964fe6bff3acffe10 ]
    
    When alloc_pages_node() returns null in svc_rqst_alloc(), the
    null rq_scratch_page pointer will be dereferenced when calling
    put_page() in svc_rqst_free(). Fix it by adding a null check.
    
    Addresses-Coverity: ("Dereference after null check")
    Fixes: 5191955d6fc6 ("SUNRPC: Prepare for xdr_stream-style decoding on the server-side")
    Signed-off-by: Yunjian Wang <wangyunjian@huawei.com>
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 3d34eb527a2bf7b8a5117bf2cb7965078b97173a
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Apr 22 12:14:37 2021 +0300

    SUNRPC: fix ternary sign expansion bug in tracing
    
    [ Upstream commit cb579086536f6564f5846f89808ec394ef8b8621 ]
    
    This code is supposed to pass negative "err" values for tracing but it
    passes positive values instead.  The problem is that the
    trace_svcsock_tcp_send() function takes a long but "err" is an int and
    "sent" is a u32.  The negative is first type promoted to u32 so it
    becomes a high positive then it is promoted to long and it stays
    positive.
    
    Fix this by casting "err" directly to long.
    
    Fixes: 998024dee197 ("SUNRPC: Add more svcsock tracepoints")
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 56a8cb3028fc7b1077b413d1cd3734aa7f59550b
Author: Dave Jiang <dave.jiang@intel.com>
Date:   Thu Apr 15 16:37:57 2021 -0700

    dmaengine: idxd: fix cdev setup and free device lifetime issues
    
    [ Upstream commit 04922b7445a1950b86f130a1fe8c52cc27b3e30b ]
    
    The char device setup and cleanup has device lifetime issues regarding when
    parts are initialized and cleaned up. The initialization of struct device is
    done incorrectly. device_initialize() needs to be called on the 'struct
    device' and then additional changes can be added. The ->release() function
    needs to be setup via device_type before dev_set_name() to allow proper
    cleanup. The change re-parents the cdev under the wq->conf_dev to get
    natural reference inheritance. No known dependency on the old device path exists.
    
    Reported-by: Jason Gunthorpe <jgg@nvidia.com>
    Fixes: 42d279f9137a ("dmaengine: idxd: add char driver to expose submission portal to userland")
    Signed-off-by: Dave Jiang <dave.jiang@intel.com>
    Reviewed-by: Dan Williams <dan.j.williams@intel.com>
    Link: https://lore.kernel.org/r/161852987721.2203940.1478218825576630810.stgit@djiang5-desk3.ch.intel.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit e6f86fe368cdc14764833a6e8bb59f7a85a40e06
Author: Dave Jiang <dave.jiang@intel.com>
Date:   Thu Apr 15 16:37:51 2021 -0700

    dmaengine: idxd: fix group conf_dev lifetime
    
    [ Upstream commit defe49f96012ca91e8e673cb95b5c30b4a3735e8 ]
    
    Remove devm_* allocation and fix group->conf_dev 'struct device'
    lifetime. Address issues flagged by CONFIG_DEBUG_KOBJECT_RELEASE.
    Add release functions in order to free the allocated memory at the
    group->conf_dev destruction time.
    
    Reported-by: Jason Gunthorpe <jgg@nvidia.com>
    Fixes: bfe1d56091c1 ("dmaengine: idxd: Init and probe for Intel data accelerators")
    Signed-off-by: Dave Jiang <dave.jiang@intel.com>
    Link: https://lore.kernel.org/r/161852987144.2203940.8830315575880047.stgit@djiang5-desk3.ch.intel.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 26c219e7522c494f7865a928c81ced84cc7db3ae
Author: Dave Jiang <dave.jiang@intel.com>
Date:   Thu Apr 15 16:37:44 2021 -0700

    dmaengine: idxd: fix engine conf_dev lifetime
    
    [ Upstream commit 75b911309060f42ba94bbbf46f5f497d35d5cd02 ]
    
    Remove devm_* allocation and fix engine->conf_dev 'struct device'
    lifetime. Address issues flagged by CONFIG_DEBUG_KOBJECT_RELEASE.
    Add release functions in order to free the allocated memory at the
    engine conf_dev destruction time.
    
    Reported-by: Jason Gunthorpe <jgg@nvidia.com>
    Fixes: bfe1d56091c1 ("dmaengine: idxd: Init and probe for Intel data accelerators")
    Signed-off-by: Dave Jiang <dave.jiang@intel.com>
    Link: https://lore.kernel.org/r/161852986460.2203940.16603218225412118431.stgit@djiang5-desk3.ch.intel.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 394e179f51fce06d6bb8ca5af8fa53f33c718cf4
Author: Dave Jiang <dave.jiang@intel.com>
Date:   Thu Apr 15 16:37:39 2021 -0700

    dmaengine: idxd: fix wq conf_dev 'struct device' lifetime
    
    [ Upstream commit 7c5dd23e57c14cf7177b8a5e0fd08916e0c60005 ]
    
    Remove devm_* allocation and fix wq->conf_dev 'struct device' lifetime.
    Address issues flagged by CONFIG_DEBUG_KOBJECT_RELEASE. Add release
    functions in order to free the allocated memory for the wq context at
    device destruction time.
    
    Reported-by: Jason Gunthorpe <jgg@nvidia.com>
    Fixes: bfe1d56091c1 ("dmaengine: idxd: Init and probe for Intel data accelerators")
    Signed-off-by: Dave Jiang <dave.jiang@intel.com>
    Link: https://lore.kernel.org/r/161852985907.2203940.6840120734115043753.stgit@djiang5-desk3.ch.intel.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 3f0e87eb9680975184e98aed0e8866b4442a31f6
Author: Dave Jiang <dave.jiang@intel.com>
Date:   Thu Apr 15 16:37:33 2021 -0700

    dmaengine: idxd: fix idxd conf_dev 'struct device' lifetime
    
    [ Upstream commit 47c16ac27d4cb664cee53ee0b9b7e2f907923fb3 ]
    
    The devm managed lifetime is incompatible with 'struct device' objects that
    resides in idxd context. This is one of the series that clean up the idxd
    driver 'struct device' lifetime. Fix idxd->conf_dev 'struct device'
    lifetime. Address issues flagged by CONFIG_DEBUG_KOBJECT_RELEASE.
    Add release functions in order to free the allocated memory at the
    appropriate time.
    
    Reported-by: Jason Gunthorpe <jgg@nvidia.com>
    Fixes: bfe1d56091c1 ("dmaengine: idxd: Init and probe for Intel data accelerators")
    Signed-off-by: Dave Jiang <dave.jiang@intel.com>
    Link: https://lore.kernel.org/r/161852985319.2203940.4650791514462735368.stgit@djiang5-desk3.ch.intel.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2389e264467f3b677dd9d2dc355e812e1a31b147
Author: Dave Jiang <dave.jiang@intel.com>
Date:   Thu Apr 15 16:37:27 2021 -0700

    dmaengine: idxd: use ida for device instance enumeration
    
    [ Upstream commit f7f7739847bd68b3c3103fd1b50d943038bd14c7 ]
    
    The idr is only used for an device id, never to lookup context from that
    id. Switch to plain ida.
    
    Fixes: bfe1d56091c1 ("dmaengine: idxd: Init and probe for Intel data accelerators")
    Reported-by: Jason Gunthorpe <jgg@nvidia.com>
    Signed-off-by: Dave Jiang <dave.jiang@intel.com>
    Link: https://lore.kernel.org/r/161852984730.2203940.15032482460902003819.stgit@djiang5-desk3.ch.intel.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 24c6dac48370457089e450a87a2bdcf86e26c351
Author: Zheng Yongjun <zhengyongjun3@huawei.com>
Date:   Thu Dec 24 21:22:54 2020 +0800

    dma: idxd: use DEFINE_MUTEX() for mutex lock
    
    [ Upstream commit e2fcd6e427c2fae92b366b24759f95d77b6f7bc7 ]
    
    mutex lock can be initialized automatically with DEFINE_MUTEX()
    rather than explicitly calling mutex_init().
    
    Signed-off-by: Zheng Yongjun <zhengyongjun3@huawei.com>
    Acked-by: Dave Jiang <dave.jiang@intel.com>
    Link: https://lore.kernel.org/r/20201224132254.30961-1-zhengyongjun3@huawei.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 0e3806996501810d1ad4495872ab59554ca367b6
Author: Dave Jiang <dave.jiang@intel.com>
Date:   Thu Apr 15 16:37:21 2021 -0700

    dmaengine: idxd: removal of pcim managed mmio mapping
    
    [ Upstream commit a39c7cd0438ee2f0b859ee1eb86cdc52217d2223 ]
    
    The devm managed lifetime is incompatible with 'struct device' objects that
    resides in idxd context. This is one of the series that clean up the idxd
    driver 'struct device' lifetime. Remove pcim_* management of the PCI device
    and the ioremap of MMIO BAR and replace with unmanaged versions. This is
    for consistency of removing all the pcim/devm based calls.
    
    Reported-by: Jason Gunthorpe <jgg@nvidia.com>
    Fixes: bfe1d56091c1 ("dmaengine: idxd: Init and probe for Intel data accelerators")
    Signed-off-by: Dave Jiang <dave.jiang@intel.com>
    Reviewed-by: Dan Williams <dan.j.williams@intel.com>
    Link: https://lore.kernel.org/r/161852984150.2203940.8043988289748519056.stgit@djiang5-desk3.ch.intel.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 474f021005dab1eab6298fc8a32a9f986497d5fc
Author: Dave Jiang <dave.jiang@intel.com>
Date:   Thu Apr 15 16:37:15 2021 -0700

    dmaengine: idxd: cleanup pci interrupt vector allocation management
    
    [ Upstream commit 5fc8e85ff12ce0530ac658686902a0ee64600f56 ]
    
    The devm managed lifetime is incompatible with 'struct device' objects that
    resides in idxd context. This is one of the series that clean up the idxd
    driver 'struct device' lifetime. Remove devm managed pci interrupt vectors
    and replace with unmanged allocators.
    
    Reported-by: Jason Gunthorpe <jgg@nvidia.com>
    Fixes: bfe1d56091c1 ("dmaengine: idxd: Init and probe for Intel data accelerators")
    Signed-off-by: Dave Jiang <dave.jiang@intel.com>
    Reviewed-by: Dan Williams <dan.j.williams@intel.com>
    Link: https://lore.kernel.org/r/161852983563.2203940.8116028229124776669.stgit@djiang5-desk3.ch.intel.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a5385ea872fa2295ac60afddd6582b3d3761b661
Author: Dave Jiang <dave.jiang@intel.com>
Date:   Thu Apr 15 16:37:10 2021 -0700

    dmaengine: idxd: fix dma device lifetime
    
    [ Upstream commit 397862855619271296e46d10f7dfa7bafe71eb81 ]
    
    The devm managed lifetime is incompatible with 'struct device' objects that
    resides in idxd context. This is one of the series that clean up the idxd
    driver 'struct device' lifetime. Remove embedding of dma_device and dma_chan
    in idxd since it's not the only interface that idxd will use. The freeing of
    the dma_device will be managed by the ->release() function.
    
    Reported-by: Jason Gunthorpe <jgg@nvidia.com>
    Fixes: bfe1d56091c1 ("dmaengine: idxd: Init and probe for Intel data accelerators")
    Signed-off-by: Dave Jiang <dave.jiang@intel.com>
    Reviewed-by: Dan Williams <dan.j.williams@intel.com>
    Link: https://lore.kernel.org/r/161852983001.2203940.14817017492384561719.stgit@djiang5-desk3.ch.intel.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2280b4cc29d8cdd2be3d1b2d1ea4f958e2131c97
Author: Colin Ian King <colin.king@canonical.com>
Date:   Thu Apr 15 12:06:54 2021 +0100

    dmaengine: idxd: Fix potential null dereference on pointer status
    
    [ Upstream commit 28ac8e03c43dfc6a703aa420d18222540b801120 ]
    
    There are calls to idxd_cmd_exec that pass a null status pointer however
    a recent commit has added an assignment to *status that can end up
    with a null pointer dereference.  The function expects a null status
    pointer sometimes as there is a later assignment to *status where
    status is first null checked.  Fix the issue by null checking status
    before making the assignment.
    
    Addresses-Coverity: ("Explicit null dereferenced")
    Fixes: 89e3becd8f82 ("dmaengine: idxd: check device state before issue command")
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Acked-by: Dave Jiang <dave.jiang@intel.com>
    Link: https://lore.kernel.org/r/20210415110654.1941580-1-colin.king@canonical.com
    Signed-off-by: Vinod Koul <vkoul@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1f84f1d7711b9369bc07e0b59f56f6d6cdd3430b
Author: Michael Walle <michael@walle.cc>
Date:   Wed Apr 14 10:40:06 2021 +0200

    rtc: fsl-ftm-alarm: add MODULE_TABLE()
    
    [ Upstream commit 7fcb86185978661c9188397d474f90364745b8d9 ]
    
    The module doesn't load automatically. Fix it by adding the missing
    MODULE_TABLE().
    
    Fixes: 7b0b551dbc1e ("rtc: fsl-ftm-alarm: add FTM alarm driver")
    Signed-off-by: Michael Walle <michael@walle.cc>
    Signed-off-by: Alexandre Belloni <alexandre.belloni@bootlin.com>
    Link: https://lore.kernel.org/r/20210414084006.17933-1-michael@walle.cc
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f6ab92ea9132a9734417761734de6c68231620fc
Author: J. Bruce Fields <bfields@redhat.com>
Date:   Fri Apr 16 14:00:14 2021 -0400

    nfsd: ensure new clients break delegations
    
    [ Upstream commit 217fd6f625af591e2866bebb8cda778cf85bea2e ]
    
    If nfsd already has an open file that it plans to use for IO from
    another, it may not need to do another vfs open, but it still may need
    to break any delegations in case the existing opens are for another
    client.
    
    Symptoms are that we may incorrectly fail to break a delegation on a
    write open from a different client, when the delegation-holding client
    already has a write open.
    
    Fixes: 28df3d1539de ("nfsd: clients don't need to break their own delegations")
    Signed-off-by: J. Bruce Fields <bfields@redhat.com>
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit cb557c7d68b589f732c1f417c4f742a7da113dd3
Author: Trond Myklebust <trond.myklebust@hammerspace.com>
Date:   Thu Apr 15 15:09:41 2021 -0400

    NFSv4.x: Don't return NFS4ERR_NOMATCHING_LAYOUT if we're unmounting
    
    [ Upstream commit 8926cc8302819be9e67f70409ed001ecb2c924a9 ]
    
    If the NFS super block is being unmounted, then we currently may end up
    telling the server that we've forgotten the layout while it is actually
    still in use by the client.
    In that case, just assume that the client will soon return the layout
    anyway, and so return NFS4ERR_DELAY in response to the layout recall.
    
    Fixes: 58ac3e59235f ("NFSv4/pnfs: Clean up nfs_layout_find_inode()")
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 677d23d6eb48e30a89868e738a4115af18b1abc3
Author: Guangqing Zhu <zhuguangqing83@gmail.com>
Date:   Sun Apr 4 20:54:31 2021 +0800

    thermal/drivers/tsens: Fix missing put_device error
    
    [ Upstream commit f4136863e8899fa0554343201b78b9e197c78a78 ]
    
    Fixes coccicheck error:
    
    drivers/thermal/qcom/tsens.c:759:4-10: ERROR: missing put_device; call
    of_find_device_by_node on line 715, but without a corresponding object
    release within this function.
    
    Fixes: a7ff82976122 ("drivers: thermal: tsens: Merge tsens-common.c into tsens.c")
    Signed-off-by: Guangqing Zhu <zhuguangqing83@gmail.com>
    Reviewed-by: Bjorn Andersson <bjorn.andersson@linaro.org>
    Signed-off-by: Daniel Lezcano <daniel.lezcano@linaro.org>
    Link: https://lore.kernel.org/r/20210404125431.12208-1-zhuguangqing83@gmail.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 742287b24aae72bbef17775f49bd47d988db97a7
Author: Chris Dion <Christopher.Dion@dell.com>
Date:   Sun Apr 4 21:29:26 2021 -0400

    SUNRPC: Handle major timeout in xprt_adjust_timeout()
    
    [ Upstream commit 09252177d5f924f404551b4b4eded5daa7f04a3a ]
    
    Currently if a major timeout value is reached, but the minor value has
    not been reached, an ETIMEOUT will not be sent back to the caller.
    This can occur if the v4 server is not responding to requests and
    retrans is configured larger than the default of two.
    
    For example, A TCP mount with a configured timeout value of 50 and a
    retransmission count of 3 to a v4 server which is not responding:
    
    1. Initial value and increment set to 5s, maxval set to 20s, retries at 3
    2. Major timeout is set to 20s, minor timeout set to 5s initially
    3. xport_adjust_timeout() is called after 5s, retry with 10s timeout,
       minor timeout is bumped to 10s
    4. And again after another 10s, 15s total time with minor timeout set
       to 15s
    5. After 20s total time xport_adjust_timeout is called as major timeout is
       reached, but skipped because the minor timeout is not reached
           - After this time the cpu spins continually calling
             xport_adjust_timeout() and returning 0 for 10 seconds.
             As seen on perf sched:
             39243.913182 [0005]  mount.nfs[3794] 4607.938      0.017   9746.863
    6. This continues until the 15s minor timeout condition is reached (in
       this case for 10 seconds). After which the ETIMEOUT is processed
       back to the caller, the cpu spinning stops, and normal operations
       continue
    
    Fixes: 7de62bc09fe6 ("SUNRPC dont update timeout value on connection reset")
    Signed-off-by: Chris Dion <Christopher.Dion@dell.com>
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 97b834378eedc712e5e89da09611ec28c5af5132
Author: Chuck Lever <chuck.lever@oracle.com>
Date:   Wed Mar 31 16:03:08 2021 -0400

    SUNRPC: Remove trace_xprt_transmit_queued
    
    [ Upstream commit 6cf23783f750634e10daeede48b0f5f5d64ebf3a ]
    
    This tracepoint can crash when dereferencing snd_task because
    when some transports connect, they put a cookie in that field
    instead of a pointer to an rpc_task.
    
    BUG: KASAN: use-after-free in trace_event_raw_event_xprt_writelock_event+0x141/0x18e [sunrpc]
    Read of size 2 at addr ffff8881a83bd3a0 by task git/331872
    
    CPU: 11 PID: 331872 Comm: git Tainted: G S                5.12.0-rc2-00007-g3ab6e585a7f9 #1453
    Hardware name: Supermicro SYS-6028R-T/X10DRi, BIOS 1.1a 10/16/2015
    Call Trace:
     dump_stack+0x9c/0xcf
     print_address_description.constprop.0+0x18/0x239
     kasan_report+0x174/0x1b0
     trace_event_raw_event_xprt_writelock_event+0x141/0x18e [sunrpc]
     xprt_prepare_transmit+0x8e/0xc1 [sunrpc]
     call_transmit+0x4d/0xc6 [sunrpc]
    
    Fixes: 9ce07ae5eb1d ("SUNRPC: Replace dprintk() call site in xprt_prepare_transmit")
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 3d1817c8d1b413a09935648937b25a8b9460c87d
Author: Chuck Lever <chuck.lever@oracle.com>
Date:   Wed Mar 31 13:22:14 2021 -0400

    SUNRPC: Move fault injection call sites
    
    [ Upstream commit 7638e0bfaed1b653d3ca663e560e9ffb44bb1030 ]
    
    I've hit some crashes that occur in the xprt_rdma_inject_disconnect
    path. It appears that, for some provides, rdma_disconnect() can
    take so long that the transport can disconnect and release its
    hardware resources while rdma_disconnect() is still running,
    resulting in a UAF in the provider.
    
    The transport's fault injection method may depend on the stability
    of transport data structures. That means it needs to be invoked
    only from contexts that hold the transport write lock.
    
    Fixes: 4a0682583988 ("SUNRPC: Transport fault injection")
    Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1c2fbe29dc4cafb818e34d4a4ab38c56af11d911
Author: Olga Kornievskaia <kolga@netapp.com>
Date:   Wed Mar 31 15:30:25 2021 -0400

    NFSv4.2 fix handling of sr_eof in SEEK's reply
    
    [ Upstream commit 73f5c88f521a630ea1628beb9c2d48a2e777a419 ]
    
    Currently the client ignores the value of the sr_eof of the SEEK
    operation. According to the spec, if the server didn't find the
    requested extent and reached the end of the file, the server
    would return sr_eof=true. In case the request for DATA and no
    data was found (ie in the middle of the hole), then the lseek
    expects that ENXIO would be returned.
    
    Fixes: 1c6dcbe5ceff8 ("NFS: Implement SEEK")
    Signed-off-by: Olga Kornievskaia <kolga@netapp.com>
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit fd02a794aaeac693c7c092a4b482f87256d151fc
Author: Nikola Livic <nlivic@gmail.com>
Date:   Mon Mar 29 11:56:49 2021 +0300

    pNFS/flexfiles: fix incorrect size check in decode_nfs_fh()
    
    [ Upstream commit ed34695e15aba74f45247f1ee2cf7e09d449f925 ]
    
    We (adam zabrocki, alexander matrosov, alexander tereshkin, maksym
    bazalii) observed the check:
    
            if (fh->size > sizeof(struct nfs_fh))
    
    should not use the size of the nfs_fh struct which includes an extra two
    bytes from the size field.
    
    struct nfs_fh {
            unsigned short         size;
            unsigned char          data[NFS_MAXFHSIZE];
    }
    
    but should determine the size from data[NFS_MAXFHSIZE] so the memcpy
    will not write 2 bytes beyond destination.  The proposed fix is to
    compare against the NFS_MAXFHSIZE directly, as is done elsewhere in fs
    code base.
    
    Fixes: d67ae825a59d ("pnfs/flexfiles: Add the FlexFile Layout Driver")
    Signed-off-by: Nikola Livic <nlivic@gmail.com>
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 6f4e38375aa84fd040076827c9ee109317a0a874
Author: Suman Anna <s-anna@ti.com>
Date:   Wed Apr 7 10:56:41 2021 -0500

    remoteproc: pru: Fix and cleanup firmware interrupt mapping logic
    
    [ Upstream commit 880a66e026fbe6a17cd59fe0ee942bbad62a6c26 ]
    
    The PRU firmware interrupt mappings are configured and unconfigured in
    .start() and .stop() callbacks respectively using the variables 'evt_count'
    and a 'mapped_irq' pointer. These variables are modified only during these
    callbacks but are not re-initialized/reset properly during unwind or
    failure paths. These stale values caused a kernel crash while stopping a
    PRU remoteproc running a different firmware with no events on a subsequent
    run after a previous run that was running a firmware with events.
    
    Fix this crash by ensuring that the evt_count is 0 and the mapped_irq
    pointer is set to NULL in pru_dispose_irq_mapping(). Also, reset these
    variables properly during any failures in the .start() callback. While
    at this, the pru_dispose_irq_mapping() callsites are all made to look
    the same, moving any conditional logic to inside the function.
    
    Reviewed-by: Mathieu Poirier <mathieu.poirier@linaro.org>
    Fixes: c75c9fdac66e ("remoteproc: pru: Add support for PRU specific interrupt configuration")
    Reported-by: Vignesh Raghavendra <vigneshr@ti.com>
    Signed-off-by: Suman Anna <s-anna@ti.com>
    Link: https://lore.kernel.org/r/20210407155641.5501-4-s-anna@ti.com
    Signed-off-by: Bjorn Andersson <bjorn.andersson@linaro.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2c83114da3e04befded9395e12527518e62da704
Author: Suman Anna <s-anna@ti.com>
Date:   Wed Apr 7 10:56:40 2021 -0500

    remoteproc: pru: Fix wrong success return value for fw events
    
    [ Upstream commit 1fe72bcfac087dba5ab52778e0646ed9e145cd32 ]
    
    The irq_create_fwspec_mapping() returns a proper virq value on success
    and 0 upon any failure. The pru_handle_intrmap() treats this as an error
    and disposes all firmware event mappings correctly, but is returning
    this incorrect value as is, letting the pru_rproc_start() interpret it
    as a success and boot the PRU.
    
    Fix this by returning an error value back upon any such failure. While
    at this, revise the error trace to print some meaningful info about the
    failed event.
    
    Fixes: c75c9fdac66e ("remoteproc: pru: Add support for PRU specific interrupt configuration")
    Signed-off-by: Suman Anna <s-anna@ti.com>
    Reviewed-by: Mathieu Poirier <mathieu.poirier@linaro.org>
    Link: https://lore.kernel.org/r/20210407155641.5501-3-s-anna@ti.com
    Signed-off-by: Bjorn Andersson <bjorn.andersson@linaro.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 01bb83e7fa92f97073f24808f300a286ba89728a
Author: Suman Anna <s-anna@ti.com>
Date:   Wed Apr 7 10:56:39 2021 -0500

    remoteproc: pru: Fixup interrupt-parent logic for fw events
    
    [ Upstream commit 6d1f2803cb6b414c2e45fa64d1fdad6b581e1e88 ]
    
    The PRU firmware interrupt mapping logic in pru_handle_intrmap() uses
    of_irq_find_parent() with PRU device node to get a handle to the PRUSS
    Interrupt Controller at present. This logic however requires that the
    PRU nodes always define a interrupt-parent property. This property is
    neither a required/defined property as per the PRU remoteproc binding,
    nor is relevant from a DT node point of view without any associated
    interrupts. The current logic finds a wrong interrupt controller and
    fails to perform proper mapping without any interrupt-parent property
    in the PRU nodes.
    
    Fix this logic to always find and use the sibling interrupt controller.
    Also, while at this, fix the acquired interrupt controller device node
    reference properly.
    
    Fixes: c75c9fdac66e ("remoteproc: pru: Add support for PRU specific interrupt configuration")
    Signed-off-by: Suman Anna <s-anna@ti.com>
    Reviewed-by: Mathieu Poirier <mathieu.poirier@linaro.org>
    Link: https://lore.kernel.org/r/20210407155641.5501-2-s-anna@ti.com
    Signed-off-by: Bjorn Andersson <bjorn.andersson@linaro.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit e23797be630bcbbcb5f239f11e9f547d05ae1e94
Author: Yang Yingliang <yangyingliang@huawei.com>
Date:   Wed Mar 31 16:40:12 2021 +0800

    PCI: endpoint: Fix missing destroy_workqueue()
    
    [ Upstream commit acaef7981a218813e3617edb9c01837808de063c ]
    
    Add the missing destroy_workqueue() before return from
    pci_epf_test_init() in the error handling case and add
    destroy_workqueue() in pci_epf_test_exit().
    
    Link: https://lore.kernel.org/r/20210331084012.2091010-1-yangyingliang@huawei.com
    Fixes: 349e7a85b25fa ("PCI: endpoint: functions: Add an EP function to test PCI")
    Reported-by: Hulk Robot <hulkci@huawei.com>
    Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
    Signed-off-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 419e9b1cac512f20e4527d1ddf29e39d88af0469
Author: Trond Myklebust <trond.myklebust@hammerspace.com>
Date:   Mon Mar 29 16:46:05 2021 -0400

    NFS: Deal correctly with attribute generation counter overflow
    
    [ Upstream commit 9fdbfad1777cb4638f489eeb62d85432010c0031 ]
    
    We need to use unsigned long subtraction and then convert to signed in
    order to deal correcly with C overflow rules.
    
    Fixes: f5062003465c ("NFS: Set an attribute barrier on all updates")
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d81779f853661a762dd7fbbbeae35909b0cdefa2
Author: Trond Myklebust <trond.myklebust@hammerspace.com>
Date:   Sun Mar 28 18:17:14 2021 -0400

    NFSv4.2: Always flush out writes in nfs42_proc_fallocate()
    
    [ Upstream commit 99f23783224355e7022ceea9b8d9f62c0fd01bd8 ]
    
    Whether we're allocating or delallocating space, we should flush out the
    pending writes in order to avoid races with attribute updates.
    
    Fixes: 1e564d3dbd68 ("NFSv4.2: Fix a race in nfs42_proc_deallocate()")
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5896b20ce2a588a2bfe90869b222dc9e8e86027a
Author: Trond Myklebust <trond.myklebust@hammerspace.com>
Date:   Sun Mar 28 18:12:03 2021 -0400

    NFS: Fix attribute bitmask in _nfs42_proc_fallocate()
    
    [ Upstream commit e99812e1382f0bfb6149393262bc70645c9f537a ]
    
    We can't use nfs4_fattr_bitmap as a bitmask, because it hasn't been
    filtered to represent the attributes supported by the server. Instead,
    let's revert to using server->cache_consistency_bitmask after adding in
    the missing SPACE_USED attribute.
    
    Fixes: 913eca1aea87 ("NFS: Fallocate should use the nfs4_fattr_bitmap")
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 56fb39f29f49a5457ef334debafffd11ee98f385
Author: Trond Myklebust <trond.myklebust@hammerspace.com>
Date:   Thu Mar 25 18:15:36 2021 -0400

    NFS: nfs4_bitmask_adjust() must not change the server global bitmasks
    
    [ Upstream commit 332d1a0373be32a3a3c152756bca45ff4f4e11b5 ]
    
    As currently set, the calls to nfs4_bitmask_adjust() will end up
    overwriting the contents of the nfs_server cache_consistency_bitmask
    field.
    The intention here should be to modify a private copy of that mask in
    the close/delegreturn/write arguments.
    
    Fixes: 76bd5c016ef4 ("NFSv4: make cache consistency bitmask dynamic")
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f6b6eb4a7901efbcee44c28d4f176a3403384111
Author: Jia-Ju Bai <baijiaju1990@gmail.com>
Date:   Sat Mar 6 05:36:24 2021 -0800

    rpmsg: qcom_glink_native: fix error return code of qcom_glink_rx_data()
    
    [ Upstream commit 26594c6bbb60c6bc87e3762a86ceece57d164c66 ]
    
    When idr_find() returns NULL to intent, no error return code of
    qcom_glink_rx_data() is assigned.
    To fix this bug, ret is assigned with -ENOENT in this case.
    
    Fixes: 64f95f87920d ("rpmsg: glink: Use the local intents when receiving data")
    Reported-by: TOTE Robot <oslab@tsinghua.edu.cn>
    Signed-off-by: Jia-Ju Bai <baijiaju1990@gmail.com>
    Link: https://lore.kernel.org/r/20210306133624.17237-1-baijiaju1990@gmail.com
    Signed-off-by: Bjorn Andersson <bjorn.andersson@linaro.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 3bcabcfc78365e57dd04395e37512f0beb3d0c7c
Author: Chao Yu <chao@kernel.org>
Date:   Fri Apr 2 17:22:23 2021 +0800

    f2fs: fix to avoid accessing invalid fio in f2fs_allocate_data_block()
    
    [ Upstream commit 25ae837e61dee712b4b1df36602ebfe724b2a0b6 ]
    
    Callers may pass fio parameter with NULL value to f2fs_allocate_data_block(),
    so we should make sure accessing fio's field after fio's validation check.
    
    Fixes: f608c38c59c6 ("f2fs: clean up parameter of f2fs_allocate_data_block()")
    Signed-off-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 6ed6e777e6cae76c4db71d1bc399e6761d5d4cec
Author: Trond Myklebust <trond.myklebust@hammerspace.com>
Date:   Wed Mar 17 08:46:19 2021 -0400

    NFS: Only change the cookie verifier if the directory page cache is empty
    
    [ Upstream commit f892c41c14e0fa3d78ce37de1d5c8161ed13bf08 ]
    
    The cached NFSv3/v4 readdir cookies are associated with a verifier,
    which is checked by the server on subsequent calls to readdir, and is
    only expected to change when the cookies (and hence also the page cache
    contents) are considered invalid.
    We therefore do have to store the verifier, but only when the page cache
    is empty.
    
    Fixes: b593c09f83a2 ("NFS: Improve handling of directory verifiers")
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 78214e7f6e71ac819a0671427ebf9b0e8eae0484
Author: Trond Myklebust <trond.myklebust@hammerspace.com>
Date:   Tue Mar 16 07:57:40 2021 -0400

    NFS: Fix handling of cookie verifier in uncached_readdir()
    
    [ Upstream commit 13884ff2bef01df37c450c6dd09122f92333dccc ]
    
    If we're doing uncached readdir(), then the readdir cookie could be
    different from the one cached in the nfs_inode. We should therefore
    ensure that we save that one in the struct nfs_open_dir_context.
    
    Fixes: 35df59d3ef69 ("NFS: Reduce number of RPC calls when doing uncached readdir")
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit bdc9e552a3dc81864fcdc7de5aaa89d0703dd8f4
Author: Nagendra S Tomar <natomar@microsoft.com>
Date:   Tue Mar 16 10:25:14 2021 +0000

    nfs: Subsequent READDIR calls should carry non-zero cookieverifier
    
    [ Upstream commit ee3707ae2c1f1327ad5188836b7ab62ed2c93b28 ]
    
    If the loop in nfs_readdir_xdr_to_array() runs more than once, subsequent
    READDIR RPCs may wrongly carry a zero cookie verifier and non-zero cookie.
    Make sure subsequent calls to READDIR carry the cookie verifier returned
    by the first call.
    
    Signed-off-by: Nagendra S Tomar <natomar@microsoft.com>
    Fixes: b593c09f83a2 ("NFS: Improve handling of directory verifiers")
    Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit adc0a74ac2545e350f98ceae23ce2e7de6ff98d7
Author: Yi Zhuang <zhuangyi1@huawei.com>
Date:   Wed Mar 31 17:34:14 2021 +0800

    f2fs: Fix a hungtask problem in atomic write
    
    [ Upstream commit be1ee45d51384161681ecf21085a42d316ae25f7 ]
    
    In the cache writing process, if it is an atomic file, increase the page
    count of F2FS_WB_CP_DATA, otherwise increase the page count of
    F2FS_WB_DATA.
    
    When you step into the hook branch due to insufficient memory in
    f2fs_write_begin, f2fs_drop_inmem_pages_all will be called to traverse
    all atomic inodes and clear the FI_ATOMIC_FILE mark of all atomic files.
    
    In f2fs_drop_inmem_pages，first acquire the inmem_lock , revoke all the
    inmem_pages, and then clear the FI_ATOMIC_FILE mark. Before this mark is
    cleared, other threads may hold inmem_lock to add inmem_pages to the inode
    that has just been emptied inmem_pages, and increase the page count of
    F2FS_WB_CP_DATA.
    
    When the IO returns, it is found that the FI_ATOMIC_FILE flag is cleared
    by f2fs_drop_inmem_pages_all, and f2fs_is_atomic_file returns false,which
    causes the page count of F2FS_WB_DATA to be decremented. The page count of
    F2FS_WB_CP_DATA cannot be cleared. Finally, hungtask is triggered in
    f2fs_wait_on_all_pages because get_pages will never return zero.
    
    process A:                              process B:
    f2fs_drop_inmem_pages_all
    ->f2fs_drop_inmem_pages of inode#1
        ->mutex_lock(&fi->inmem_lock)
        ->__revoke_inmem_pages of inode#1   f2fs_ioc_commit_atomic_write
        ->mutex_unlock(&fi->inmem_lock)     ->f2fs_commit_inmem_pages of inode#1
                                            ->mutex_lock(&fi->inmem_lock)
                                            ->__f2fs_commit_inmem_pages
                                                ->f2fs_do_write_data_page
                                                    ->f2fs_outplace_write_data
                                                        ->do_write_page
                                                            ->f2fs_submit_page_write
                                                                ->inc_page_count(sbi, F2FS_WB_CP_DATA )
                                            ->mutex_unlock(&fi->inmem_lock)
        ->spin_lock(&sbi->inode_lock[ATOMIC_FILE]);
        ->clear_inode_flag(inode, FI_ATOMIC_FILE)
        ->spin_unlock(&sbi->inode_lock[ATOMIC_FILE])
                                            f2fs_write_end_io
                                            ->dec_page_count(sbi, F2FS_WB_DATA );
    
    We can fix the problem by putting the action of clearing the FI_ATOMIC_FILE
    mark into the inmem_lock lock. This operation can ensure that no one will
    submit the inmem pages before the FI_ATOMIC_FILE mark is cleared, so that
    there will be no atomic writes waiting for writeback.
    
    Fixes: 57864ae5ce3a ("f2fs: limit # of inmemory pages")
    Signed-off-by: Yi Zhuang <zhuangyi1@huawei.com>
    Reviewed-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2e61ed75d061401479e0b29b4f9b75cab40ce371
Author: Yang Yingliang <yangyingliang@huawei.com>
Date:   Tue Mar 30 21:06:32 2021 +0800

    fs: 9p: fix v9fs_file_open writeback fid error check
    
    [ Upstream commit f8b139e2f24112f4e21f1eb02c7fc7600fea4b8d ]
    
    IS_ERR() and PTR_ERR() use wrong pointer, it should be
    writeback_fid, fix it.
    
    Link: http://lkml.kernel.org/r/20210330130632.1054357-1-yangyingliang@huawei.com
    Fixes: 5bfe97d7382b ("9p: Fix writeback fid incorrectly being attached to dentry")
    Reported-by: Hulk Robot <hulkci@huawei.com>
    Signed-off-by: Yang Yingliang <yangyingliang@huawei.com>
    [Dominique: adjusted commit summary]
    Signed-off-by: Dominique Martinet <asmadeus@codewreck.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4147dd2f6f330fb58e0d26335c2ea0fee7adaa35
Author: Chao Yu <chao@kernel.org>
Date:   Fri Mar 26 09:46:22 2021 +0800

    f2fs: fix to cover __allocate_new_section() with curseg_lock
    
    [ Upstream commit 823d13e12b6cbaef2f6e5d63c648643e7bc094dd ]
    
    In order to avoid race with f2fs_do_replace_block().
    
    Fixes: f5a53edcf01e ("f2fs: support aligned pinned file")
    Signed-off-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1e116f87825f01a6380286472196882746b16f63
Author: Chao Yu <chao@kernel.org>
Date:   Wed Mar 24 11:18:28 2021 +0800

    f2fs: fix to avoid touching checkpointed data in get_victim()
    
    [ Upstream commit 61461fc921b756ae16e64243f72af2bfc2e620db ]
    
    In CP disabling mode, there are two issues when using LFS or SSR | AT_SSR
    mode to select victim:
    
    1. LFS is set to find source section during GC, the victim should have
    no checkpointed data, since after GC, section could not be set free for
    reuse.
    
    Previously, we only check valid chpt blocks in current segment rather
    than section, fix it.
    
    2. SSR | AT_SSR are set to find target segment for writes which can be
    fully filled by checkpointed and newly written blocks, we should never
    select such segment, otherwise it can cause panic or data corruption
    during allocation, potential case is described as below:
    
     a) target segment has 'n' (n < 512) ckpt valid blocks
     b) GC migrates 'n' valid blocks to other segment (segment is still
        in dirty list)
     c) GC migrates '512 - n' blocks to target segment (segment has 'n'
        cp_vblocks and '512 - n' vblocks)
     d) If GC selects target segment via {AT,}SSR allocator, however there
        is no free space in targe segment.
    
    Fixes: 4354994f097d ("f2fs: checkpoint disabling")
    Fixes: 093749e296e2 ("f2fs: support age threshold based garbage collection")
    Signed-off-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 679ebad058b8168f10e63876d63b0877fd2fe784
Author: Shradha Todi <shradha.t@samsung.com>
Date:   Wed Mar 24 15:46:09 2021 +0530

    PCI: endpoint: Fix NULL pointer dereference for ->get_features()
    
    [ Upstream commit 6613bc2301ba291a1c5a90e1dc24cf3edf223c03 ]
    
    get_features ops of pci_epc_ops may return NULL, causing NULL pointer
    dereference in pci_epf_test_alloc_space function. Let us add a check for
    pci_epc_feature pointer in pci_epf_test_bind before we access it to avoid
    any such NULL pointer dereference and return -ENOTSUPP in case
    pci_epc_feature is not found.
    
    When the patch is not applied and EPC features is not implemented in the
    platform driver, we see the following dump due to kernel NULL pointer
    dereference.
    
    Call trace:
     pci_epf_test_bind+0xf4/0x388
     pci_epf_bind+0x3c/0x80
     pci_epc_epf_link+0xa8/0xcc
     configfs_symlink+0x1a4/0x48c
     vfs_symlink+0x104/0x184
     do_symlinkat+0x80/0xd4
     __arm64_sys_symlinkat+0x1c/0x24
     el0_svc_common.constprop.3+0xb8/0x170
     el0_svc_handler+0x70/0x88
     el0_svc+0x8/0x640
    Code: d2800581 b9403ab9 f9404ebb 8b394f60 (f9400400)
    ---[ end trace a438e3c5a24f9df0 ]---
    
    Link: https://lore.kernel.org/r/20210324101609.79278-1-shradha.t@samsung.com
    Fixes: 2c04c5b8eef79 ("PCI: pci-epf-test: Use pci_epc_get_features() to get EPC features")
    Signed-off-by: Sriram Dash <dash.sriram@gmail.com>
    Signed-off-by: Shradha Todi <shradha.t@samsung.com>
    Signed-off-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
    Reviewed-by: Pankaj Dubey <pankaj.dubey@samsung.com>
    Reviewed-by: Kishon Vijay Abraham I <kishon@ti.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 81110da8e414e0ca05c531b21232c7469c92f58c
Author: Kishon Vijay Abraham I <kishon@ti.com>
Date:   Tue Feb 2 01:27:56 2021 +0530

    PCI: endpoint: Make *_free_bar() to return error codes on failure
    
    [ Upstream commit 0e27aeccfa3d1bab7c6a29fb8e6fcedbad7b09a8 ]
    
    Modify pci_epc_get_next_free_bar() and pci_epc_get_first_free_bar() to
    return error values if there are no free BARs available.
    
    Link: https://lore.kernel.org/r/20210201195809.7342-5-kishon@ti.com
    Signed-off-by: Kishon Vijay Abraham I <kishon@ti.com>
    Signed-off-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a6443fd10a7106110cb273177b23d616f36bbcda
Author: Kishon Vijay Abraham I <kishon@ti.com>
Date:   Tue Feb 2 01:27:55 2021 +0530

    PCI: endpoint: Add helper API to get the 'next' unreserved BAR
    
    [ Upstream commit fa8fef0e104a23efe568b835d9e7e188d1d97610 ]
    
    Add an API to get the next unreserved BAR starting from a given BAR number
    that can be used by the endpoint function.
    
    Link: https://lore.kernel.org/r/20210201195809.7342-4-kishon@ti.com
    Signed-off-by: Kishon Vijay Abraham I <kishon@ti.com>
    Signed-off-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ae737293b95868af23c83ca815c96dbca62bf9c4
Author: Kishon Vijay Abraham I <kishon@ti.com>
Date:   Tue Feb 2 01:27:54 2021 +0530

    PCI: endpoint: Make *_get_first_free_bar() take into account 64 bit BAR
    
    [ Upstream commit 959a48d0eac0321948c9f3d1707ba22c100e92d5 ]
    
    pci_epc_get_first_free_bar() uses only "reserved_bar" member in
    epc_features to get the first unreserved BAR. However if the reserved BAR
    is also a 64-bit BAR, then the next BAR shouldn't be returned (since 64-bit
    BAR uses two BARs).
    
    Make pci_epc_get_first_free_bar() take into account 64 bit BAR while
    returning the first free unreserved BAR.
    
    Link: https://lore.kernel.org/r/20210201195809.7342-3-kishon@ti.com
    Signed-off-by: Kishon Vijay Abraham I <kishon@ti.com>
    Signed-off-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 12ad20fc551ca817383a1125ceb27f430b4dc9cb
Author: Chao Yu <chao@kernel.org>
Date:   Wed Mar 24 11:24:33 2021 +0800

    f2fs: fix to update last i_size if fallocate partially succeeds
    
    [ Upstream commit 88f2cfc5fa90326edb569b4a81bb38ed4dcd3108 ]
    
    In the case of expanding pinned file, map.m_lblk and map.m_len
    will update in each round of section allocation, so in error
    path, last i_size will be calculated with wrong m_lblk and m_len,
    fix it.
    
    Fixes: f5a53edcf01e ("f2fs: support aligned pinned file")
    Signed-off-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 0a0a6e69764e992069fc0d7570444ece9f048b8d
Author: Chao Yu <chao@kernel.org>
Date:   Fri Mar 5 17:56:01 2021 +0800

    f2fs: fix to align to section for fallocate() on pinned file
    
    [ Upstream commit e1175f02291141bbd924fc578299305fcde35855 ]
    
    Now, fallocate() on a pinned file only allocates blocks which aligns
    to segment rather than section, so GC may try to migrate pinned file's
    block, and after several times of failure, pinned file's block could
    be migrated to other place, however user won't be aware of such
    condition, and then old obsolete block address may be readed/written
    incorrectly.
    
    To avoid such condition, let's try to allocate pinned file's blocks
    with section alignment.
    
    Signed-off-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7eeacc6728c5478e3c01bc82a1f08958eaa12366
Author: Zhen Lei <thunder.leizhen@huawei.com>
Date:   Thu Feb 18 03:00:05 2021 +0100

    ARM: 9064/1: hw_breakpoint: Do not directly check the event's overflow_handler hook
    
    [ Upstream commit a506bd5756290821a4314f502b4bafc2afcf5260 ]
    
    The commit 1879445dfa7b ("perf/core: Set event's default
    ::overflow_handler()") set a default event->overflow_handler in
    perf_event_alloc(), and replace the check event->overflow_handler with
    is_default_overflow_handler(), but one is missing.
    
    Currently, the bp->overflow_handler can not be NULL. As a result,
    enable_single_step() is always not invoked.
    
    Comments from Zhen Lei:
    
     https://patchwork.kernel.org/project/linux-arm-kernel/patch/20210207105934.2001-1-thunder.leizhen@huawei.com/
    
    Fixes: 1879445dfa7b ("perf/core: Set event's default ::overflow_handler()")
    Signed-off-by: Zhen Lei <thunder.leizhen@huawei.com>
    Cc: Wang Nan <wangnan0@huawei.com>
    Acked-by: Will Deacon <will@kernel.org>
    Signed-off-by: Russell King <rmk+kernel@armlinux.org.uk>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 250cf64e13bc9d36ba58ad6c7bb6f982b2c15b6c
Author: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
Date:   Mon Jan 25 02:28:26 2021 +0300

    PCI: Release OF node in pci_scan_device()'s error path
    
    [ Upstream commit c99e755a4a4c165cad6effb39faffd0f3377c02d ]
    
    In pci_scan_device(), if pci_setup_device() fails for any reason, the code
    will not release device's of_node by calling pci_release_of_node().  Fix
    that by calling the release function.
    
    Fixes: 98d9f30c820d ("pci/of: Match PCI devices to OF nodes dynamically")
    Link: https://lore.kernel.org/r/20210124232826.1879-1-dmitry.baryshkov@linaro.org
    Signed-off-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Reviewed-by: Leon Romanovsky <leonro@nvidia.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 9a2ca612cb65a3d6aef3cce59f4aef753437daab
Author: Pali Rohár <pali@kernel.org>
Date:   Wed Mar 3 15:22:02 2021 +0100

    PCI: iproc: Fix return value of iproc_msi_irq_domain_alloc()
    
    [ Upstream commit 1e83130f01b04c16579ed5a5e03d729bcffc4c5d ]
    
    IRQ domain alloc function should return zero on success. Non-zero value
    indicates failure.
    
    Link: https://lore.kernel.org/r/20210303142202.25780-1-pali@kernel.org
    Fixes: fc54bae28818 ("PCI: iproc: Allow allocation of multiple MSIs")
    Signed-off-by: Pali Rohár <pali@kernel.org>
    Signed-off-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
    Reviewed-by: Krzysztof Wilczyński <kw@linux.com>
    Acked-by: Ray Jui <ray.jui@broadcom.com>
    Acked-by: Marc Zyngier <maz@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4900d94f34f9dbc59caffb84f2cbbc099abf7bb1
Author: Bjorn Andersson <bjorn.andersson@linaro.org>
Date:   Fri Mar 12 15:20:02 2021 -0800

    remoteproc: qcom_q6v5_mss: Validate p_filesz in ELF loader
    
    [ Upstream commit 3d2ee78906af5f08d499d6aa3aa504406fa38106 ]
    
    Analog to the issue in the common mdt_loader code the MSS ELF loader
    does not validate that p_filesz bytes will fit in the memory region and
    that the loaded segments are not truncated. Fix this in the same way
    as proposed for the mdt_loader.
    
    Reviewed-by: Mathieu Poirier <mathieu.poirier@linaro.org>
    Fixes: 135b9e8d1cd8 ("remoteproc: qcom_q6v5_mss: Validate modem blob firmware size before load")
    Link: https://lore.kernel.org/r/20210312232002.3466791-1-bjorn.andersson@linaro.org
    Signed-off-by: Bjorn Andersson <bjorn.andersson@linaro.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d5b9e8bed59093e551e8a6272ad949eee75ef390
Author: Colin Ian King <colin.king@canonical.com>
Date:   Thu Mar 4 09:21:18 2021 +0000

    f2fs: fix a redundant call to f2fs_balance_fs if an error occurs
    
    [ Upstream commit 28e18ee636ba28532dbe425540af06245a0bbecb ]
    
    The  uninitialized variable dn.node_changed does not get set when a
    call to f2fs_get_node_page fails.  This uninitialized value gets used
    in the call to f2fs_balance_fs() that may or not may not balances
    dirty node and dentry pages depending on the uninitialized state of
    the variable. Fix this by only calling f2fs_balance_fs if err is
    not set.
    
    Thanks to Jaegeuk Kim for suggesting an appropriate fix.
    
    Addresses-Coverity: ("Uninitialized scalar variable")
    Fixes: 2a3407607028 ("f2fs: call f2fs_balance_fs only when node was changed")
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Reviewed-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 860afd680d9cc1dabd61cda3cd246f60aa1eb705
Author: Chao Yu <chao@kernel.org>
Date:   Sat Feb 20 17:35:41 2021 +0800

    f2fs: fix panic during f2fs_resize_fs()
    
    [ Upstream commit 3ab0598e6d860ef49d029943ba80f627c15c15d6 ]
    
    f2fs_resize_fs() hangs in below callstack with testcase:
    - mkfs 16GB image & mount image
    - dd 8GB fileA
    - dd 8GB fileB
    - sync
    - rm fileA
    - sync
    - resize filesystem to 8GB
    
    kernel BUG at segment.c:2484!
    Call Trace:
     allocate_segment_by_default+0x92/0xf0 [f2fs]
     f2fs_allocate_data_block+0x44b/0x7e0 [f2fs]
     do_write_page+0x5a/0x110 [f2fs]
     f2fs_outplace_write_data+0x55/0x100 [f2fs]
     f2fs_do_write_data_page+0x392/0x850 [f2fs]
     move_data_page+0x233/0x320 [f2fs]
     do_garbage_collect+0x14d9/0x1660 [f2fs]
     free_segment_range+0x1f7/0x310 [f2fs]
     f2fs_resize_fs+0x118/0x330 [f2fs]
     __f2fs_ioctl+0x487/0x3680 [f2fs]
     __x64_sys_ioctl+0x8e/0xd0
     do_syscall_64+0x33/0x80
     entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    The root cause is we forgot to check that whether we have enough space
    in resized filesystem to store all valid blocks in before-resizing
    filesystem, then allocator will run out-of-space during block migration
    in free_segment_range().
    
    Fixes: b4b10061ef98 ("f2fs: refactor resize_fs to avoid meta updates in progress")
    Signed-off-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 33157ff896623aa53d17841481e75f49eee2138d
Author: Chao Yu <chao@kernel.org>
Date:   Sat Feb 20 17:35:40 2021 +0800

    f2fs: fix to allow migrating fully valid segment
    
    [ Upstream commit 7dede88659df38f96128ab3922c50dde2d29c574 ]
    
    F2FS_IOC_FLUSH_DEVICE/F2FS_IOC_RESIZE_FS needs to migrate all blocks of
    target segment to other place, no matter the segment has partially or fully
    valid blocks.
    
    However, after commit 803e74be04b3 ("f2fs: stop GC when the victim becomes
    fully valid"), we may skip migration due to target segment is fully valid,
    result in failing the ioctl interface, fix this.
    
    Fixes: 803e74be04b3 ("f2fs: stop GC when the victim becomes fully valid")
    Signed-off-by: Chao Yu <yuchao0@huawei.com>
    Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 9ce1aaf8b2841daf310c53f0ceb1cd7cc5c3b01a
Author: Qiuxu Zhuo <qiuxu.zhuo@intel.com>
Date:   Mon Feb 22 09:17:17 2021 +0800

    PCI/RCEC: Fix RCiEP device to RCEC association
    
    [ Upstream commit d9b7eae8e3424c3480fe9f40ebafbb0c96426e4c ]
    
    rcec_assoc_rciep() used "rciep->devfn" (a single byte encoding both the
    device and function number) as the device number to check whether the
    corresponding bit was set in the RCEC's Association Bitmap for RCiEPs.
    
    But per PCIe r5.0, sec 7.9.10.2, "Association Bitmap for RCiEPs", the
    32-bit bitmap contains one bit per device.  That bit applies to all
    functions of the device.
    
    Fix rcec_assoc_rciep() to convert the value of "rciep->devfn" to a device
    number to ensure that RCiEP devices are correctly associated with the RCEC.
    
    Reported-and-tested-by: Wen Jin <wen.jin@intel.com>
    Fixes: 507b460f8144 ("PCI/ERR: Add pcie_link_rcec() to associate RCiEPs")
    Link: https://lore.kernel.org/r/20210222011717.43266-1-qiuxu.zhuo@intel.com
    Signed-off-by: Qiuxu Zhuo <qiuxu.zhuo@intel.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Reviewed-by: Sean V Kelley <sean.v.kelley@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c55cd249c54538fd613a09d5c4241028ce58a657
Author: Jia-Ju Bai <baijiaju1990@gmail.com>
Date:   Wed Mar 10 04:24:23 2021 -0800

    thermal: thermal_of: Fix error return code of thermal_of_populate_bind_params()
    
    [ Upstream commit 45c7eaeb29d67224db4ba935deb575586a1fda09 ]
    
    When kcalloc() returns NULL to __tcbp or of_count_phandle_with_args()
    returns zero or -ENOENT to count, no error return code of
    thermal_of_populate_bind_params() is assigned.
    To fix these bugs, ret is assigned with -ENOMEM and -ENOENT in these
    cases, respectively.
    
    Fixes: a92bab8919e3 ("of: thermal: Allow multiple devices to share cooling map")
    Reported-by: TOTE Robot <oslab@tsinghua.edu.cn>
    Signed-off-by: Jia-Ju Bai <baijiaju1990@gmail.com>
    Signed-off-by: Daniel Lezcano <daniel.lezcano@linaro.org>
    Link: https://lore.kernel.org/r/20210310122423.3266-1-baijiaju1990@gmail.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1ed3c7b213e931640f59dc65fb2b1cab1077bab9
Author: David Ward <david.ward@gatech.edu>
Date:   Sun Apr 18 09:46:57 2021 -0400

    ASoC: rt286: Make RT286_SET_GPIO_* readable and writable
    
    [ Upstream commit cd8499d5c03ba260e3191e90236d0e5f6b147563 ]
    
    The GPIO configuration cannot be applied if the registers are inaccessible.
    This prevented the headset mic from working on the Dell XPS 13 9343.
    
    BugLink: https://bugzilla.kernel.org/show_bug.cgi?id=114171
    Signed-off-by: David Ward <david.ward@gatech.edu>
    Link: https://lore.kernel.org/r/20210418134658.4333-5-david.ward@gatech.edu
    Reviewed-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 44cfd76de72ce6e0cd41255df8f75d3d24c74045
Author: Petr Mladek <pmladek@suse.com>
Date:   Thu Apr 29 22:54:33 2021 -0700

    watchdog: fix barriers when printing backtraces from all CPUs
    
    [ Upstream commit 9f113bf760ca90d709f8f89a733d10abb1f04a83 ]
    
    Any parallel softlockup reports are skipped when one CPU is already
    printing backtraces from all CPUs.
    
    The exclusive rights are synchronized using one bit in
    soft_lockup_nmi_warn.  There is also one memory barrier that does not make
    much sense.
    
    Use two barriers on the right location to prevent mixing two reports.
    
    [pmladek@suse.com: use bit lock operations to prevent multiple soft-lockup reports]
      Link: https://lkml.kernel.org/r/YFSVsLGVWMXTvlbk@alley
    
    Link: https://lkml.kernel.org/r/20210311122130.6788-6-pmladek@suse.com
    Signed-off-by: Petr Mladek <pmladek@suse.com>
    Acked-by: Peter Zijlstra (Intel) <peterz@infradead.org>
    Cc: Ingo Molnar <mingo@kernel.org>
    Cc: Laurence Oberman <loberman@redhat.com>
    Cc: Michal Hocko <mhocko@suse.com>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Vincent Whitchurch <vincent.whitchurch@axis.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 95aa28b3514fb8d57dc57dac02f64acd9aeae694
Author: Petr Mladek <pmladek@suse.com>
Date:   Thu Apr 29 22:54:30 2021 -0700

    watchdog/softlockup: remove logic that tried to prevent repeated reports
    
    [ Upstream commit 1bc503cb4a2638fb1c57801a7796aca57845ce63 ]
    
    The softlockup detector does some gymnastic with the variable
    soft_watchdog_warn.  It was added by the commit 58687acba59266735ad
    ("lockup_detector: Combine nmi_watchdog and softlockup detector").
    
    The purpose is not completely clear.  There are the following clues.  They
    describe the situation how it looked after the above mentioned commit:
    
      1. The variable was checked with a comment "only warn once".
    
      2. The variable was set when softlockup was reported. It was cleared
         only when the CPU was not longer in the softlockup state.
    
      3. watchdog_touch_ts was not explicitly updated when the softlockup
         was reported. Without this variable, the report would normally
         be printed again during every following watchdog_timer_fn()
         invocation.
    
    The logic has got even more tangled up by the commit ed235875e2ca98
    ("kernel/watchdog.c: print traces for all cpus on lockup detection").
    After this commit, soft_watchdog_warn is set only when
    softlockup_all_cpu_backtrace is enabled.  But multiple reports from all
    CPUs are prevented by a new variable soft_lockup_nmi_warn.
    
    Conclusion:
    
    The variable probably never worked as intended.  In each case, it has not
    worked last many years because the softlockup was reported repeatedly
    after the full period defined by watchdog_thresh.
    
    The reason is that watchdog gets touched in many known slow paths, for
    example, in printk_stack_address().  This code is called also when
    printing the softlockup report.  It means that the watchdog timestamp gets
    updated after each report.
    
    Solution:
    
    Simply remove the logic. People want the periodic report anyway.
    
    Link: https://lkml.kernel.org/r/20210311122130.6788-5-pmladek@suse.com
    Signed-off-by: Petr Mladek <pmladek@suse.com>
    Cc: Ingo Molnar <mingo@kernel.org>
    Cc: Laurence Oberman <loberman@redhat.com>
    Cc: Michal Hocko <mhocko@suse.com>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Vincent Whitchurch <vincent.whitchurch@axis.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit cc622029e0a155722b0b48b5396d3947470a6337
Author: Petr Mladek <pmladek@suse.com>
Date:   Thu Apr 29 22:54:23 2021 -0700

    watchdog: explicitly update timestamp when reporting softlockup
    
    [ Upstream commit c9ad17c991492f4390f42598f6ab0531f87eed07 ]
    
    The softlockup situation might stay for a long time or even forever.  When
    it happens, the softlockup debug messages are printed in regular intervals
    defined by get_softlockup_thresh().
    
    There is a mystery.  The repeated message is printed after the full
    interval that is defined by get_softlockup_thresh().  But the timer
    callback is called more often as defined by sample_period.  The code looks
    like the soflockup should get reported in every sample_period when it was
    once behind the thresh.
    
    It works only by chance.  The watchdog is touched when printing the stall
    report, for example, in printk_stack_address().
    
    Make the behavior clear and predictable by explicitly updating the
    timestamp in watchdog_timer_fn() when the report gets printed.
    
    Link: https://lkml.kernel.org/r/20210311122130.6788-3-pmladek@suse.com
    Signed-off-by: Petr Mladek <pmladek@suse.com>
    Cc: Ingo Molnar <mingo@kernel.org>
    Cc: Laurence Oberman <loberman@redhat.com>
    Cc: Michal Hocko <mhocko@suse.com>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Vincent Whitchurch <vincent.whitchurch@axis.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f3159d653b7842179bd3b88e2993092a78fb6da4
Author: Petr Mladek <pmladek@suse.com>
Date:   Thu Apr 29 22:54:20 2021 -0700

    watchdog: rename __touch_watchdog() to a better descriptive name
    
    [ Upstream commit 7c0012f522c802d25be102bafe54f333168e6119 ]
    
    Patch series "watchdog/softlockup: Report overall time and some cleanup", v2.
    
    I dug deep into the softlockup watchdog history when time permitted this
    year.  And reworked the patchset that fixed timestamps and cleaned up the
    code[2].
    
    I split it into very small steps and did even more code clean up.  The
    result looks quite strightforward and I am pretty confident with the
    changes.
    
    [1] v2: https://lore.kernel.org/r/20201210160038.31441-1-pmladek@suse.com
    [2] v1: https://lore.kernel.org/r/20191024114928.15377-1-pmladek@suse.com
    
    This patch (of 6):
    
    There are many touch_*watchdog() functions.  They are called in situations
    where the watchdog could report false positives or create unnecessary
    noise.  For example, when CPU is entering idle mode, a virtual machine is
    stopped, or a lot of messages are printed in the atomic context.
    
    These functions set SOFTLOCKUP_RESET instead of a real timestamp.  It
    allows to call them even in a context where jiffies might be outdated.
    For example, in an atomic context.
    
    The real timestamp is set by __touch_watchdog() that is called from the
    watchdog timer callback.
    
    Rename this callback to update_touch_ts().  It better describes the effect
    and clearly distinguish is from the other touch_*watchdog() functions.
    
    Another motivation is that two timestamps are going to be used.  One will
    be used for the total softlockup time.  The other will be used to measure
    time since the last report.  The new function name will help to
    distinguish which timestamp is being updated.
    
    Link: https://lkml.kernel.org/r/20210311122130.6788-1-pmladek@suse.com
    Link: https://lkml.kernel.org/r/20210311122130.6788-2-pmladek@suse.com
    Signed-off-by: Petr Mladek <pmladek@suse.com>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Ingo Molnar <mingo@kernel.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Laurence Oberman <loberman@redhat.com>
    Cc: Vincent Whitchurch <vincent.whitchurch@axis.com>
    Cc: Michal Hocko <mhocko@suse.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ee29b3d2942d6670aea278ad1776bff70d5a4b17
Author: Sergei Trofimovich <slyfox@gentoo.org>
Date:   Thu Apr 29 22:53:48 2021 -0700

    ia64: module: fix symbolizer crash on fdescr
    
    [ Upstream commit 99e729bd40fb3272fa4b0140839d5e957b58588a ]
    
    Noticed failure as a crash on ia64 when tried to symbolize all backtraces
    collected by page_owner=on:
    
        $ cat /sys/kernel/debug/page_owner
        <oops>
    
        CPU: 1 PID: 2074 Comm: cat Not tainted 5.12.0-rc4 #226
        Hardware name: hp server rx3600, BIOS 04.03 04/08/2008
        ip is at dereference_module_function_descriptor+0x41/0x100
    
    Crash happens at dereference_module_function_descriptor() due to
    use-after-free when dereferencing ".opd" section header.
    
    All section headers are already freed after module is laoded successfully.
    
    To keep symbolizer working the change stores ".opd" address and size after
    module is relocated to a new place and before section headers are
    discarded.
    
    To make similar errors less obscure module_finalize() now zeroes out all
    variables relevant to module loading only.
    
    Link: https://lkml.kernel.org/r/20210403074803.3309096-1-slyfox@gentoo.org
    Signed-off-by: Sergei Trofimovich <slyfox@gentoo.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2e2b2d47785eb2e999957d5206bc85c5d110be4f
Author: Michael Chan <michael.chan@broadcom.com>
Date:   Sun Apr 25 13:45:25 2021 -0400

    bnxt_en: Add PCI IDs for Hyper-V VF devices.
    
    [ Upstream commit 7fbf359bb2c19c824cbb1954020680824f6ee5a5 ]
    
    Support VF device IDs used by the Hyper-V hypervisor.
    
    Reviewed-by: Vasundhara Volam <vasundhara-v.volam@broadcom.com>
    Reviewed-by: Andy Gospodarek <gospo@broadcom.com>
    Signed-off-by: Edwin Peer <edwin.peer@broadcom.com>
    Signed-off-by: Michael Chan <michael.chan@broadcom.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 095fb38eafef744d6df0f48b2fdcdad826277667
Author: Masahiro Yamada <masahiroy@kernel.org>
Date:   Fri Mar 26 03:54:09 2021 +0900

    kbuild: generate Module.symvers only when vmlinux exists
    
    [ Upstream commit 69bc8d386aebbd91a6bb44b6d33f77c8dfa9ed8c ]
    
    The external module build shows the following warning if Module.symvers
    is missing in the kernel tree.
    
      WARNING: Symbol version dump "Module.symvers" is missing.
               Modules may not have dependencies or modversions.
    
    I think this is an important heads-up because the resulting modules may
    not work as expected. This happens when you did not build the entire
    kernel tree, for example, you might have prepared the minimal setups
    for external modules by 'make defconfig && make modules_preapre'.
    
    A problem is that 'make modules' creates Module.symvers even without
    vmlinux. In this case, that warning is suppressed since Module.symvers
    already exists in spite of its incomplete content.
    
    The incomplete (i.e. invalid) Module.symvers should not be created.
    
    This commit changes the second pass of modpost to dump symbols into
    modules-only.symvers. The final Module.symvers is created by
    concatenating vmlinux.symvers and modules-only.symvers if both exist.
    
    Module.symvers is supposed to collect symbols from both vmlinux and
    modules. It might be a bit confusing, and I am not quite sure if it
    is an official interface, but presumably it is difficult to rename it
    because some tools (e.g. kmod) parse it.
    
    Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4e7a198fa7edcd5c00c59b935b4a716411094a7e
Author: Petr Machata <petrm@nvidia.com>
Date:   Fri Apr 23 14:19:48 2021 +0200

    selftests: mlxsw: Fix mausezahn invocation in ERSPAN scale test
    
    [ Upstream commit 1233898ab758cbcf5f6fea10b8dd16a0b2c24fab ]
    
    The mirror_gre_scale test creates as many ERSPAN sessions as the underlying
    chip supports, and tests that they all work. In order to determine that it
    issues a stream of ICMP packets and checks if they are mirrored as
    expected.
    
    However, the mausezahn invocation missed the -6 flag to identify the use of
    IPv6 protocol, and was sending ICMP messages over IPv6, as opposed to
    ICMP6. It also didn't pass an explicit source IP address, which apparently
    worked at some point in the past, but does not anymore.
    
    To fix these issues, extend the function mirror_test() in mirror_lib by
    detecting the IPv6 protocol addresses, and using a different ICMP scheme.
    Fix __mirror_gre_test() in the selftest itself to pass a source IP address.
    
    Signed-off-by: Petr Machata <petrm@nvidia.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c839dce6b7c8d04513beb190a3268481a458c5e5
Author: Petr Machata <petrm@nvidia.com>
Date:   Fri Apr 23 14:19:47 2021 +0200

    selftests: mlxsw: Increase the tolerance of backlog buildup
    
    [ Upstream commit dda7f4fa55839baeb72ae040aeaf9ccf89d3e416 ]
    
    The intention behind this test is to make sure that qdisc limit is
    correctly projected to the HW. However, first, due to rounding in the
    qdisc, and then in the driver, the number cannot actually be accurate. And
    second, the approach to testing this is to oversubscribe the port with
    traffic generated on the same switch. The actual backlog size therefore
    fluctuates.
    
    In practice, this test proved to be noisier than the rest, and spuriously
    fails every now and then. Increase the tolerance to 10 % to avoid these
    issues.
    
    Signed-off-by: Petr Machata <petrm@nvidia.com>
    Acked-by: Jiri Pirko <jiri@nvidia.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5025b047b3b9ff5e3aced2c60d4ccddfb10f4d03
Author: Felix Fietkau <nbd@nbd.name>
Date:   Thu Apr 22 22:20:54 2021 -0700

    net: ethernet: mtk_eth_soc: fix RX VLAN offload
    
    [ Upstream commit 3f57d8c40fea9b20543cab4da12f4680d2ef182c ]
    
    The VLAN ID in the rx descriptor is only valid if the RX_DMA_VTAG bit is
    set. Fixes frames wrongly marked with VLAN tags.
    
    Signed-off-by: Felix Fietkau <nbd@nbd.name>
    [Ilya: fix commit message]
    Signed-off-by: Ilya Lipnitskiy <ilya.lipnitskiy@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2cf552e6dddf573e79d9d30b1a4e658da7a2f06f
Author: Stefan Assmann <sassmann@kpanic.de>
Date:   Tue Mar 9 15:41:42 2021 +0100

    iavf: remove duplicate free resources calls
    
    [ Upstream commit 1a0e880b028f97478dc689e2900b312741d0d772 ]
    
    Both iavf_free_all_tx_resources() and iavf_free_all_rx_resources() have
    already been called in the very same function.
    Remove the duplicate calls.
    
    Signed-off-by: Stefan Assmann <sassmann@kpanic.de>
    Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8089cb59dde9515df2877a5cf99e6e366dd09f00
Author: Alexey Kardashevskiy <aik@ozlabs.ru>
Date:   Mon Mar 1 17:36:53 2021 +1100

    powerpc/iommu: Annotate nested lock for lockdep
    
    [ Upstream commit cc7130bf119add37f36238343a593b71ef6ecc1e ]
    
    The IOMMU table is divided into pools for concurrent mappings and each
    pool has a separate spinlock. When taking the ownership of an IOMMU group
    to pass through a device to a VM, we lock these spinlocks which triggers
    a false negative warning in lockdep (below).
    
    This fixes it by annotating the large pool's spinlock as a nest lock
    which makes lockdep not complaining when locking nested locks if
    the nest lock is locked already.
    
    ===
    WARNING: possible recursive locking detected
    5.11.0-le_syzkaller_a+fstn1 #100 Not tainted
    --------------------------------------------
    qemu-system-ppc/4129 is trying to acquire lock:
    c0000000119bddb0 (&(p->lock)/1){....}-{2:2}, at: iommu_take_ownership+0xac/0x1e0
    
    but task is already holding lock:
    c0000000119bdd30 (&(p->lock)/1){....}-{2:2}, at: iommu_take_ownership+0xac/0x1e0
    
    other info that might help us debug this:
     Possible unsafe locking scenario:
    
           CPU0
           ----
      lock(&(p->lock)/1);
      lock(&(p->lock)/1);
    ===
    
    Signed-off-by: Alexey Kardashevskiy <aik@ozlabs.ru>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Link: https://lore.kernel.org/r/20210301063653.51003-1-aik@ozlabs.ru
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 00067148d755bc47501c1092952024d6cf689e6d
Author: Lee Gibson <leegib@gmail.com>
Date:   Mon Apr 19 15:58:42 2021 +0100

    qtnfmac: Fix possible buffer overflow in qtnf_event_handle_external_auth
    
    [ Upstream commit 130f634da1af649205f4a3dd86cbe5c126b57914 ]
    
    Function qtnf_event_handle_external_auth calls memcpy without
    checking the length.
    A user could control that length and trigger a buffer overflow.
    Fix by checking the length is within the maximum allowed size.
    
    Signed-off-by: Lee Gibson <leegib@gmail.com>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Link: https://lore.kernel.org/r/20210419145842.345787-1-leegib@gmail.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8f650c01d7180997afe11f0be92884e099a8444e
Author: Gustavo A. R. Silva <gustavoars@kernel.org>
Date:   Wed Apr 14 18:45:15 2021 -0500

    wl3501_cs: Fix out-of-bounds warnings in wl3501_mgmt_join
    
    [ Upstream commit bb43e5718d8f1b46e7a77e7b39be3c691f293050 ]
    
    Fix the following out-of-bounds warnings by adding a new structure
    wl3501_req instead of duplicating the same members in structure
    wl3501_join_req and wl3501_scan_confirm:
    
    arch/x86/include/asm/string_32.h:182:25: warning: '__builtin_memcpy' offset [39, 108] from the object at 'sig' is out of the bounds of referenced subobject 'beacon_period' with type 'short unsigned int' at offset 36 [-Warray-bounds]
    arch/x86/include/asm/string_32.h:182:25: warning: '__builtin_memcpy' offset [25, 95] from the object at 'sig' is out of the bounds of referenced subobject 'beacon_period' with type 'short unsigned int' at offset 22 [-Warray-bounds]
    
    Refactor the code, accordingly:
    
    $ pahole -C wl3501_req drivers/net/wireless/wl3501_cs.o
    struct wl3501_req {
            u16                        beacon_period;        /*     0     2 */
            u16                        dtim_period;          /*     2     2 */
            u16                        cap_info;             /*     4     2 */
            u8                         bss_type;             /*     6     1 */
            u8                         bssid[6];             /*     7     6 */
            struct iw_mgmt_essid_pset  ssid;                 /*    13    34 */
            struct iw_mgmt_ds_pset     ds_pset;              /*    47     3 */
            struct iw_mgmt_cf_pset     cf_pset;              /*    50     8 */
            struct iw_mgmt_ibss_pset   ibss_pset;            /*    58     4 */
            struct iw_mgmt_data_rset   bss_basic_rset;       /*    62    10 */
    
            /* size: 72, cachelines: 2, members: 10 */
            /* last cacheline: 8 bytes */
    };
    
    $ pahole -C wl3501_join_req drivers/net/wireless/wl3501_cs.o
    struct wl3501_join_req {
            u16                        next_blk;             /*     0     2 */
            u8                         sig_id;               /*     2     1 */
            u8                         reserved;             /*     3     1 */
            struct iw_mgmt_data_rset   operational_rset;     /*     4    10 */
            u16                        reserved2;            /*    14     2 */
            u16                        timeout;              /*    16     2 */
            u16                        probe_delay;          /*    18     2 */
            u8                         timestamp[8];         /*    20     8 */
            u8                         local_time[8];        /*    28     8 */
            struct wl3501_req          req;                  /*    36    72 */
    
            /* size: 108, cachelines: 2, members: 10 */
            /* last cacheline: 44 bytes */
    };
    
    $ pahole -C wl3501_scan_confirm drivers/net/wireless/wl3501_cs.o
    struct wl3501_scan_confirm {
            u16                        next_blk;             /*     0     2 */
            u8                         sig_id;               /*     2     1 */
            u8                         reserved;             /*     3     1 */
            u16                        status;               /*     4     2 */
            char                       timestamp[8];         /*     6     8 */
            char                       localtime[8];         /*    14     8 */
            struct wl3501_req          req;                  /*    22    72 */
            /* --- cacheline 1 boundary (64 bytes) was 30 bytes ago --- */
            u8                         rssi;                 /*    94     1 */
    
            /* size: 96, cachelines: 2, members: 8 */
            /* padding: 1 */
            /* last cacheline: 32 bytes */
    };
    
    The problem is that the original code is trying to copy data into a
    bunch of struct members adjacent to each other in a single call to
    memcpy(). Now that a new struct wl3501_req enclosing all those adjacent
    members is introduced, memcpy() doesn't overrun the length of
    &sig.beacon_period and &this->bss_set[i].beacon_period, because the
    address of the new struct object _req_ is used as the destination,
    instead.
    
    This helps with the ongoing efforts to globally enable -Warray-bounds
    and get us closer to being able to tighten the FORTIFY_SOURCE routines
    on memcpy().
    
    Link: https://github.com/KSPP/linux/issues/109
    Reported-by: kernel test robot <lkp@intel.com>
    Signed-off-by: Gustavo A. R. Silva <gustavoars@kernel.org>
    Reviewed-by: Kees Cook <keescook@chromium.org>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Link: https://lore.kernel.org/r/1fbaf516da763b50edac47d792a9145aa4482e29.1618442265.git.gustavoars@kernel.org
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 32d5486867da9153662c42995b48cc5de67c2dad
Author: Gustavo A. R. Silva <gustavoars@kernel.org>
Date:   Wed Apr 14 18:43:19 2021 -0500

    wl3501_cs: Fix out-of-bounds warnings in wl3501_send_pkt
    
    [ Upstream commit 820aa37638a252b57967bdf4038a514b1ab85d45 ]
    
    Fix the following out-of-bounds warnings by enclosing structure members
    daddr and saddr into new struct addr, in structures wl3501_md_req and
    wl3501_md_ind:
    
    arch/x86/include/asm/string_32.h:182:25: warning: '__builtin_memcpy' offset [18, 23] from the object at 'sig' is out of the bounds of referenced subobject 'daddr' with type 'u8[6]' {aka 'unsigned char[6]'} at offset 11 [-Warray-bounds]
    arch/x86/include/asm/string_32.h:182:25: warning: '__builtin_memcpy' offset [18, 23] from the object at 'sig' is out of the bounds of referenced subobject 'daddr' with type 'u8[6]' {aka 'unsigned char[6]'} at offset 11 [-Warray-bounds]
    
    Refactor the code, accordingly:
    
    $ pahole -C wl3501_md_req drivers/net/wireless/wl3501_cs.o
    struct wl3501_md_req {
            u16                        next_blk;             /*     0     2 */
            u8                         sig_id;               /*     2     1 */
            u8                         routing;              /*     3     1 */
            u16                        data;                 /*     4     2 */
            u16                        size;                 /*     6     2 */
            u8                         pri;                  /*     8     1 */
            u8                         service_class;        /*     9     1 */
            struct {
                    u8                 daddr[6];             /*    10     6 */
                    u8                 saddr[6];             /*    16     6 */
            } addr;                                          /*    10    12 */
    
            /* size: 22, cachelines: 1, members: 8 */
            /* last cacheline: 22 bytes */
    };
    
    $ pahole -C wl3501_md_ind drivers/net/wireless/wl3501_cs.o
    struct wl3501_md_ind {
            u16                        next_blk;             /*     0     2 */
            u8                         sig_id;               /*     2     1 */
            u8                         routing;              /*     3     1 */
            u16                        data;                 /*     4     2 */
            u16                        size;                 /*     6     2 */
            u8                         reception;            /*     8     1 */
            u8                         pri;                  /*     9     1 */
            u8                         service_class;        /*    10     1 */
            struct {
                    u8                 daddr[6];             /*    11     6 */
                    u8                 saddr[6];             /*    17     6 */
            } addr;                                          /*    11    12 */
    
            /* size: 24, cachelines: 1, members: 9 */
            /* padding: 1 */
            /* last cacheline: 24 bytes */
    };
    
    The problem is that the original code is trying to copy data into a
    couple of arrays adjacent to each other in a single call to memcpy().
    Now that a new struct _addr_ enclosing those two adjacent arrays
    is introduced, memcpy() doesn't overrun the length of &sig.daddr[0]
    and &sig.daddr, because the address of the new struct object _addr_
    is used, instead.
    
    This helps with the ongoing efforts to globally enable -Warray-bounds
    and get us closer to being able to tighten the FORTIFY_SOURCE routines
    on memcpy().
    
    Link: https://github.com/KSPP/linux/issues/109
    Reported-by: kernel test robot <lkp@intel.com>
    Reviewed-by: Kees Cook <keescook@chromium.org>
    Signed-off-by: Gustavo A. R. Silva <gustavoars@kernel.org>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Link: https://lore.kernel.org/r/d260fe56aed7112bff2be5b4d152d03ad7b78e78.1618442265.git.gustavoars@kernel.org
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f3ddabc9da87ab9352fdf49b0233d5551266d0fc
Author: Sean Christopherson <seanjc@google.com>
Date:   Tue Apr 6 15:49:45 2021 -0700

    crypto: ccp: Free SEV device if SEV init fails
    
    [ Upstream commit b61a9071dc72a3c709192c0c00ab87c2b3de1d94 ]
    
    Free the SEV device if later initialization fails.  The memory isn't
    technically leaked as it's tracked in the top-level device's devres
    list, but unless the top-level device is removed, the memory won't be
    freed and is effectively leaked.
    
    Signed-off-by: Sean Christopherson <seanjc@google.com>
    Message-Id: <20210406224952.4177376-2-seanjc@google.com>
    Reviewed-by: Brijesh Singh <brijesh.singh@amd.com>
    Acked-by: Tom Lendacky <thomas.lendacky@amd.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 012da2b2c62a5a4bd89587cd3d0928ed08a32b79
Author: Felix Fietkau <nbd@nbd.name>
Date:   Thu Apr 15 21:07:53 2021 +0200

    mt76: mt7615: fix entering driver-own state on mt7663
    
    [ Upstream commit 5c7d374444afdeb9dd534a37c4f6c13af032da0c ]
    
    Fixes hardware wakeup issues
    
    Signed-off-by: Felix Fietkau <nbd@nbd.name>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit e296bbda68ceb2c6984bc487cb39962583099de9
Author: Jinzhou Su <Jinzhou.Su@amd.com>
Date:   Tue Apr 20 16:17:14 2021 +0800

    drm/amdgpu: Add mem sync flag for IB allocated by SA
    
    [ Upstream commit 5c88e3b86a88f14efa0a3ddd28641c6ff49fb9c4 ]
    
    The buffer of SA bo will be used by many cases. So it's better
    to invalidate the cache of indirect buffer allocated by SA before
    commit the IB.
    
    Signed-off-by: Jinzhou Su <Jinzhou.Su@amd.com>
    Reviewed-by: Christian König <christian.koenig@amd.com>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4de0a3f610a9303a4ddda0153dd7afd27188c10c
Author: Dingchen (David) Zhang <dingchen.zhang@amd.com>
Date:   Mon Jan 25 18:05:50 2021 -0500

    drm/amd/display: add handling for hdcp2 rx id list validation
    
    [ Upstream commit 4ccf9446b2a3615615045346c97f8a1e2a16568a ]
    
    [why]
    the current implementation of hdcp2 rx id list validation does not
    have handler/checker for invalid message status, e.g. HMAC, the V
    parameter calculated from PSP not matching the V prime from Rx.
    
    [how]
    return a generic FAILURE for any message status not SUCCESS or
    REVOKED.
    
    Signed-off-by: Dingchen (David) Zhang <dingchen.zhang@amd.com>
    Reviewed-by: Bhawanpreet Lakha <Bhawanpreet.Lakha@amd.com>
    Acked-by: Aurabindo Pillai <aurabindo.pillai@amd.com>
    Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2c633e16a8cdd7fc72df1efa176718809f86926a
Author: Robin Singh <robin.singh@amd.com>
Date:   Mon Dec 14 19:14:48 2020 -0500

    drm/amd/display: fixed divide by zero kernel crash during dsc enablement
    
    [ Upstream commit 19cc1f3829567e7dca21c1389ea6407b8f5efab4 ]
    
    [why]
    During dsc enable, a divide by zero condition triggered the
    kernel crash.
    
    [how]
    An IGT test, which enable the DSC, was crashing at the time of
    restore the default dsc status, becaue of h_totals value
    becoming 0. So add a check before divide condition. If h_total
    is zero, gracefully ignore and set the default value.
    
    kernel panic log:
    
            [  128.758827] divide error: 0000 [#1] PREEMPT SMP NOPTI
            [  128.762714] CPU: 5 PID: 4562 Comm: amd_dp_dsc Tainted: G        W         5.4.19-android-x86_64 #1
            [  128.769728] Hardware name: ADVANCED MICRO DEVICES, INC. Mauna/Mauna, BIOS WMN0B13N Nov 11 2020
            [  128.777695] RIP: 0010:hubp2_vready_at_or_After_vsync+0x37/0x7a [amdgpu]
            [  128.785707] Code: 80 02 00 00 48 89 f3 48 8b 7f 08 b ......
            [  128.805696] RSP: 0018:ffffad8f82d43628 EFLAGS: 00010246
            ......
            [  128.857707] CR2: 00007106d8465000 CR3: 0000000426530000 CR4: 0000000000140ee0
            [  128.865695] Call Trace:
            [  128.869712] hubp3_setup+0x1f/0x7f [amdgpu]
            [  128.873705] dcn20_update_dchubp_dpp+0xc8/0x54a [amdgpu]
            [  128.877706] dcn20_program_front_end_for_ctx+0x31d/0x463 [amdgpu]
            [  128.885706] dc_commit_state+0x3d2/0x658 [amdgpu]
            [  128.889707] amdgpu_dm_atomic_commit_tail+0x4b3/0x1e7c [amdgpu]
            [  128.897699] ? dm_read_reg_func+0x41/0xb5 [amdgpu]
            [  128.901707] ? dm_read_reg_func+0x41/0xb5 [amdgpu]
            [  128.905706] ? __is_insn_slot_addr+0x43/0x48
            [  128.909706] ? fill_plane_buffer_attributes+0x29e/0x3dc [amdgpu]
            [  128.917705] ? dm_plane_helper_prepare_fb+0x255/0x284 [amdgpu]
            [  128.921700] ? usleep_range+0x7c/0x7c
            [  128.925705] ? preempt_count_sub+0xf/0x18
            [  128.929706] ? _raw_spin_unlock_irq+0x13/0x24
            [  128.933732] ? __wait_for_common+0x11e/0x18f
            [  128.937705] ? _raw_spin_unlock_irq+0x13/0x24
            [  128.941706] ? __wait_for_common+0x11e/0x18f
            [  128.945705] commit_tail+0x8b/0xd2 [drm_kms_helper]
            [  128.949707] drm_atomic_helper_commit+0xd8/0xf5 [drm_kms_helper]
            [  128.957706] amdgpu_dm_atomic_commit+0x337/0x360 [amdgpu]
            [  128.961705] ? drm_atomic_check_only+0x543/0x68d [drm]
            [  128.969705] ? drm_atomic_set_property+0x760/0x7af [drm]
            [  128.973704] ? drm_mode_atomic_ioctl+0x6f3/0x85a [drm]
            [  128.977705] drm_mode_atomic_ioctl+0x6f3/0x85a [drm]
            [  128.985705] ? drm_atomic_set_property+0x7af/0x7af [drm]
            [  128.989706] drm_ioctl_kernel+0x82/0xda [drm]
            [  128.993706] drm_ioctl+0x225/0x319 [drm]
            [  128.997707] ? drm_atomic_set_property+0x7af/0x7af [drm]
            [  129.001706] ? preempt_count_sub+0xf/0x18
            [  129.005713] amdgpu_drm_ioctl+0x4b/0x76 [amdgpu]
            [  129.009705] vfs_ioctl+0x1d/0x2a
            [  129.013705] do_vfs_ioctl+0x419/0x43d
            [  129.017707] ksys_ioctl+0x52/0x71
            [  129.021707] __x64_sys_ioctl+0x16/0x19
            [  129.025706] do_syscall_64+0x78/0x85
            [  129.029705] entry_SYSCALL_64_after_hwframe+0x44/0xa9
    
    Signed-off-by: Robin Singh <robin.singh@amd.com>
    Reviewed-by: Harry Wentland <Harry.Wentland@amd.com>
    Reviewed-by: Robin Singh <Robin.Singh@amd.com>
    Acked-by: Aurabindo Pillai <aurabindo.pillai@amd.com>
    Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit b1acfebf97ac48ba71da2d74e70ed951449369ba
Author: Michael Ellerman <mpe@ellerman.id.au>
Date:   Sun Apr 18 23:54:13 2021 +1000

    powerpc/pseries: Stop calling printk in rtas_stop_self()
    
    [ Upstream commit ed8029d7b472369a010a1901358567ca3b6dbb0d ]
    
    RCU complains about us calling printk() from an offline CPU:
    
      =============================
      WARNING: suspicious RCU usage
      5.12.0-rc7-02874-g7cf90e481cb8 #1 Not tainted
      -----------------------------
      kernel/locking/lockdep.c:3568 RCU-list traversed in non-reader section!!
    
      other info that might help us debug this:
    
      RCU used illegally from offline CPU!
      rcu_scheduler_active = 2, debug_locks = 1
      no locks held by swapper/0/0.
    
      stack backtrace:
      CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.12.0-rc7-02874-g7cf90e481cb8 #1
      Call Trace:
        dump_stack+0xec/0x144 (unreliable)
        lockdep_rcu_suspicious+0x124/0x144
        __lock_acquire+0x1098/0x28b0
        lock_acquire+0x128/0x600
        _raw_spin_lock_irqsave+0x6c/0xc0
        down_trylock+0x2c/0x70
        __down_trylock_console_sem+0x60/0x140
        vprintk_emit+0x1a8/0x4b0
        vprintk_func+0xcc/0x200
        printk+0x40/0x54
        pseries_cpu_offline_self+0xc0/0x120
        arch_cpu_idle_dead+0x54/0x70
        do_idle+0x174/0x4a0
        cpu_startup_entry+0x38/0x40
        rest_init+0x268/0x388
        start_kernel+0x748/0x790
        start_here_common+0x1c/0x614
    
    Which happens because by the time we get to rtas_stop_self() we are
    already offline. In addition the message can be spammy, and is not that
    helpful for users, so remove it.
    
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Link: https://lore.kernel.org/r/20210418135413.1204031-1-mpe@ellerman.id.au
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit fe2a47415426fa25c8e7f38e2770086dff99b5e5
Author: Yaqi Chen <chendotjs@gmail.com>
Date:   Fri Apr 16 23:48:03 2021 +0800

    samples/bpf: Fix broken tracex1 due to kprobe argument change
    
    [ Upstream commit 137733d08f4ab14a354dacaa9a8fc35217747605 ]
    
    >From commit c0bbbdc32feb ("__netif_receive_skb_core: pass skb by
    reference"), the first argument passed into __netif_receive_skb_core
    has changed to reference of a skb pointer.
    
    This commit fixes by using bpf_probe_read_kernel.
    
    Signed-off-by: Yaqi Chen <chendotjs@gmail.com>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>
    Acked-by: Yonghong Song <yhs@fb.com>
    Link: https://lore.kernel.org/bpf/20210416154803.37157-1-chendotjs@gmail.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2e8ffd93332073d43f82d32ea4c3c60070f7b74f
Author: Du Cheng <ducheng2@gmail.com>
Date:   Sat Apr 17 07:30:46 2021 +0800

    net: sched: tapr: prevent cycle_time == 0 in parse_taprio_schedule
    
    [ Upstream commit ed8157f1ebf1ae81a8fa2653e3f20d2076fad1c9 ]
    
    There is a reproducible sequence from the userland that will trigger a WARN_ON()
    condition in taprio_get_start_time, which causes kernel to panic if configured
    as "panic_on_warn". Catch this condition in parse_taprio_schedule to
    prevent this condition.
    
    Reported as bug on syzkaller:
    https://syzkaller.appspot.com/bug?extid=d50710fd0873a9c6b40c
    
    Reported-by: syzbot+d50710fd0873a9c6b40c@syzkaller.appspotmail.com
    Signed-off-by: Du Cheng <ducheng2@gmail.com>
    Acked-by: Cong Wang <cong.wang@bytedance.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit fc29bbcfdbacb5709d623e7d535beab09df10103
Author: Gustavo A. R. Silva <gustavoars@kernel.org>
Date:   Fri Apr 16 15:15:40 2021 -0500

    ethtool: ioctl: Fix out-of-bounds warning in store_link_ksettings_for_user()
    
    [ Upstream commit c1d9e34e11281a8ba1a1c54e4db554232a461488 ]
    
    Fix the following out-of-bounds warning:
    
    net/ethtool/ioctl.c:492:2: warning: 'memcpy' offset [49, 84] from the object at 'link_usettings' is out of the bounds of referenced subobject 'base' with type 'struct ethtool_link_settings' at offset 0 [-Warray-bounds]
    
    The problem is that the original code is trying to copy data into a
    some struct members adjacent to each other in a single call to
    memcpy(). This causes a legitimate compiler warning because memcpy()
    overruns the length of &link_usettings.base. Fix this by directly
    using &link_usettings and _from_ as destination and source addresses,
    instead.
    
    This helps with the ongoing efforts to globally enable -Warray-bounds
    and get us closer to being able to tighten the FORTIFY_SOURCE routines
    on memcpy().
    
    Link: https://github.com/KSPP/linux/issues/109
    Reported-by: kernel test robot <lkp@intel.com>
    Signed-off-by: Gustavo A. R. Silva <gustavoars@kernel.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 453f0a45b4a5e80341e3bad32fef1482f6739f85
Author: David Ward <david.ward@gatech.edu>
Date:   Sun Apr 18 09:46:58 2021 -0400

    ASoC: rt286: Generalize support for ALC3263 codec
    
    [ Upstream commit aa2f9c12821e6a4ba1df4fb34a3dbc6a2a1ee7fe ]
    
    The ALC3263 codec on the XPS 13 9343 is also found on the Latitude 13 7350
    and Venue 11 Pro 7140. They require the same handling for the combo jack to
    work with a headset: GPIO pin 6 must be set.
    
    The HDA driver always sets this pin on the ALC3263, which it distinguishes
    by the codec vendor/device ID 0x10ec0288 and PCI subsystem vendor ID 0x1028
    (Dell). The ASoC driver does not use PCI, so adapt this check to use DMI to
    determine if Dell is the system vendor.
    
    BugLink: https://bugzilla.kernel.org/show_bug.cgi?id=150601
    BugLink: https://bugzilla.kernel.org/show_bug.cgi?id=205961
    Signed-off-by: David Ward <david.ward@gatech.edu>
    Reviewed-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Link: https://lore.kernel.org/r/20210418134658.4333-6-david.ward@gatech.edu
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 6bf0833794c7dd506c030b78e4f5c7cfbc7e4037
Author: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
Date:   Fri Apr 9 12:40:16 2021 +0300

    mac80211: properly drop the connection in case of invalid CSA IE
    
    [ Upstream commit 253907ab8bc0818639af382f6398810fa1f022b3 ]
    
    In case the frequency is invalid, ieee80211_parse_ch_switch_ie
    will fail and we may not even reach the check in
    ieee80211_sta_process_chanswitch. Drop the connection
    in case ieee80211_parse_ch_switch_ie failed, but still
    take into account the CSA mode to remember not to send
    a deauth frame in case if it is forbidden to.
    
    Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
    Signed-off-by: Luca Coelho <luciano.coelho@intel.com>
    Link: https://lore.kernel.org/r/iwlwifi.20210409123755.34712ef96a0a.I75d7ad7f1d654e8b0aa01cd7189ff00a510512b3@changeid
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 196878ebf569785c469912ca820a192e698f99e3
Author: David Mosberger-Tang <davidm@egauge.net>
Date:   Wed Mar 3 19:50:07 2021 +0000

    wilc1000: Bring MAC address setting in line with typical Linux behavior
    
    [ Upstream commit a381b78a1598dde34a6e40dae2842024308a6ef2 ]
    
    Linux network drivers normally disallow changing the MAC address when
    the interface is up.  This driver has been different in that it allows
    to change the MAC address *only* when it's up.  This patch brings
    wilc1000 behavior more in line with other network drivers.  We could
    have replaced wilc_set_mac_addr() with eth_mac_addr() but that would
    break existing documentation on how to change the MAC address.
    Likewise, return -EADDRNOTAVAIL (not -EINVAL) when the specified MAC
    address is invalid or unavailable.
    
    Signed-off-by: David Mosberger-Tang <davidm@egauge.net>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Link: https://lore.kernel.org/r/20210303194846.1823596-1-davidm@egauge.net
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a98fe32c03191ab12a47f3c8a3dec9019d547d11
Author: Srikar Dronamraju <srikar@linux.vnet.ibm.com>
Date:   Thu Apr 1 21:12:00 2021 +0530

    powerpc/smp: Set numa node before updating mask
    
    [ Upstream commit 6980d13f0dd189846887bbbfa43793d9a41768d3 ]
    
    Geethika reported a trace when doing a dlpar CPU add.
    
    ------------[ cut here ]------------
    WARNING: CPU: 152 PID: 1134 at kernel/sched/topology.c:2057
    CPU: 152 PID: 1134 Comm: kworker/152:1 Not tainted 5.12.0-rc5-master #5
    Workqueue: events cpuset_hotplug_workfn
    NIP:  c0000000001cfc14 LR: c0000000001cfc10 CTR: c0000000007e3420
    REGS: c0000034a08eb260 TRAP: 0700   Not tainted  (5.12.0-rc5-master+)
    MSR:  8000000000029033 <SF,EE,ME,IR,DR,RI,LE>  CR: 28828422  XER: 00000020
    CFAR: c0000000001fd888 IRQMASK: 0 #012GPR00: c0000000001cfc10
    c0000034a08eb500 c000000001f35400 0000000000000027 #012GPR04:
    c0000035abaa8010 c0000035abb30a00 0000000000000027 c0000035abaa8018
    #012GPR08: 0000000000000023 c0000035abaaef48 00000035aa540000
    c0000035a49dffe8 #012GPR12: 0000000028828424 c0000035bf1a1c80
    0000000000000497 0000000000000004 #012GPR16: c00000000347a258
    0000000000000140 c00000000203d468 c000000001a1a490 #012GPR20:
    c000000001f9c160 c0000034adf70920 c0000034aec9fd20 0000000100087bd3
    #012GPR24: 0000000100087bd3 c0000035b3de09f8 0000000000000030
    c0000035b3de09f8 #012GPR28: 0000000000000028 c00000000347a280
    c0000034aefe0b00 c0000000010a2a68
    NIP [c0000000001cfc14] build_sched_domains+0x6a4/0x1500
    LR [c0000000001cfc10] build_sched_domains+0x6a0/0x1500
    Call Trace:
    [c0000034a08eb500] [c0000000001cfc10] build_sched_domains+0x6a0/0x1500 (unreliable)
    [c0000034a08eb640] [c0000000001d1e6c] partition_sched_domains_locked+0x3ec/0x530
    [c0000034a08eb6e0] [c0000000002936d4] rebuild_sched_domains_locked+0x524/0xbf0
    [c0000034a08eb7e0] [c000000000296bb0] rebuild_sched_domains+0x40/0x70
    [c0000034a08eb810] [c000000000296e74] cpuset_hotplug_workfn+0x294/0xe20
    [c0000034a08ebc30] [c000000000178dd0] process_one_work+0x300/0x670
    [c0000034a08ebd10] [c0000000001791b8] worker_thread+0x78/0x520
    [c0000034a08ebda0] [c000000000185090] kthread+0x1a0/0x1b0
    [c0000034a08ebe10] [c00000000000ccec] ret_from_kernel_thread+0x5c/0x70
    Instruction dump:
    7d2903a6 4e800421 e8410018 7f67db78 7fe6fb78 7f45d378 7f84e378 7c681b78
    3c62ff1a 3863c6f8 4802dc35 60000000 <0fe00000> 3920fff4 f9210070 e86100a0
    ---[ end trace 532d9066d3d4d7ec ]---
    
    Some of the per-CPU masks use cpu_cpu_mask as a filter to limit the search
    for related CPUs. On a dlpar add of a CPU, update cpu_cpu_mask before
    updating the per-CPU masks. This will ensure the cpu_cpu_mask is updated
    correctly before its used in setting the masks. Setting the numa_node will
    ensure that when cpu_cpu_mask() gets called, the correct node number is
    used. This code movement helped fix the above call trace.
    
    Reported-by: Geetika Moolchandani <Geetika.Moolchandani1@ibm.com>
    Signed-off-by: Srikar Dronamraju <srikar@linux.vnet.ibm.com>
    Reviewed-by: Nathan Lynch <nathanl@linux.ibm.com>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Link: https://lore.kernel.org/r/20210401154200.150077-1-srikar@linux.vnet.ibm.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit abd822deec9ec040e3d41a23a7b5a15bee0cf7eb
Author: Cédric Le Goater <clg@kaod.org>
Date:   Tue Apr 13 15:03:52 2021 +0200

    powerpc/xive: Use the "ibm, chip-id" property only under PowerNV
    
    [ Upstream commit e9e16917bc388846163b8566a298a291d71e44c9 ]
    
    The 'chip_id' field of the XIVE CPU structure is used to choose a
    target for a source located on the same chip. For that, the XIVE
    driver queries the chip identifier from the "ibm,chip-id" property
    and compares it to a 'src_chip' field identifying the chip of a
    source. This information is only available on the PowerNV platform,
    'src_chip' being assigned to XIVE_INVALID_CHIP_ID under pSeries.
    
    The "ibm,chip-id" property is also not available on all platforms. It
    was first introduced on PowerNV and later, under QEMU for pSeries/KVM.
    However, the property is not part of PAPR and does not exist under
    pSeries/PowerVM.
    
    Assign 'chip_id' to XIVE_INVALID_CHIP_ID by default and let the
    PowerNV platform override the value with the "ibm,chip-id" property.
    
    Signed-off-by: Cédric Le Goater <clg@kaod.org>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Link: https://lore.kernel.org/r/20210413130352.1183267-1-clg@kaod.org
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 26a3e488bde960a04b95cbc4c919a87fa5137c03
Author: Gustavo A. R. Silva <gustavoars@kernel.org>
Date:   Fri Apr 16 14:31:51 2021 -0500

    flow_dissector: Fix out-of-bounds warning in __skb_flow_bpf_to_target()
    
    [ Upstream commit 1e3d976dbb23b3fce544752b434bdc32ce64aabc ]
    
    Fix the following out-of-bounds warning:
    
    net/core/flow_dissector.c:835:3: warning: 'memcpy' offset [33, 48] from the object at 'flow_keys' is out of the bounds of referenced subobject 'ipv6_src' with type '__u32[4]' {aka 'unsigned int[4]'} at offset 16 [-Warray-bounds]
    
    The problem is that the original code is trying to copy data into a
    couple of struct members adjacent to each other in a single call to
    memcpy().  So, the compiler legitimately complains about it. As these
    are just a couple of members, fix this by copying each one of them in
    separate calls to memcpy().
    
    This helps with the ongoing efforts to globally enable -Warray-bounds
    and get us closer to being able to tighten the FORTIFY_SOURCE routines
    on memcpy().
    
    Link: https://github.com/KSPP/linux/issues/109
    Reported-by: kernel test robot <lkp@intel.com>
    Signed-off-by: Gustavo A. R. Silva <gustavoars@kernel.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 54718bd9810a1729c656e979accfae07b55a3f2c
Author: Gustavo A. R. Silva <gustavoars@kernel.org>
Date:   Fri Apr 16 14:12:36 2021 -0500

    sctp: Fix out-of-bounds warning in sctp_process_asconf_param()
    
    [ Upstream commit e5272ad4aab347dde5610c0aedb786219e3ff793 ]
    
    Fix the following out-of-bounds warning:
    
    net/sctp/sm_make_chunk.c:3150:4: warning: 'memcpy' offset [17, 28] from the object at 'addr' is out of the bounds of referenced subobject 'v4' with type 'struct sockaddr_in' at offset 0 [-Warray-bounds]
    
    This helps with the ongoing efforts to globally enable -Warray-bounds
    and get us closer to being able to tighten the FORTIFY_SOURCE routines
    on memcpy().
    
    Link: https://github.com/KSPP/linux/issues/109
    Reported-by: kernel test robot <lkp@intel.com>
    Signed-off-by: Gustavo A. R. Silva <gustavoars@kernel.org>
    Reviewed-by: Kees Cook <keescook@chromium.org>
    Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 44c87b34cbe5dd67081ae4d9b1d07f79fd84287d
Author: Kai Vehmanen <kai.vehmanen@linux.intel.com>
Date:   Fri Apr 16 16:11:57 2021 +0300

    ALSA: hda/hdmi: fix race in handling acomp ELD notification at resume
    
    [ Upstream commit 0c37e2eb6b83e375e8a654d01598292d5591fc65 ]
    
    When snd-hda-codec-hdmi is used with ASoC HDA controller like SOF (acomp
    used for ELD notifications), display connection change done during suspend,
    can be lost due to following sequence of events:
    
      1. system in S3 suspend
      2. DP/HDMI receiver connected
      3. system resumed
      4. HDA controller resumed, but card->deferred_resume_work not complete
      5. acomp eld_notify callback
      6. eld_notify ignored as power state is not CTL_POWER_D0
      7. HDA resume deferred work completed, power state set to CTL_POWER_D0
    
    This results in losing the notification, and the jack state reported to
    user-space is not correct.
    
    The check on step 6 was added in commit 8ae743e82f0b ("ALSA: hda - Skip
    ELD notification during system suspend"). It would seem with the deferred
    resume logic in ASoC core, this check is not safe.
    
    Fix the issue by modifying the check to use "dev.power.power_state.event"
    instead of ALSA specific card power state variable.
    
    BugLink: https://github.com/thesofproject/linux/issues/2825
    Suggested-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Kai Vehmanen <kai.vehmanen@linux.intel.com>
    Link: https://lore.kernel.org/r/20210416131157.1881366-1-kai.vehmanen@linux.intel.com
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 11eea859c2dd1ebec69b5a7ad9062985e07906aa
Author: Vamshi Krishna Gopal <vamshi.krishna.gopal@intel.com>
Date:   Thu Apr 15 12:50:09 2021 -0500

    ASoC: Intel: sof_sdw: add quirk for new ADL-P Rvp
    
    [ Upstream commit d25bbe80485f8bcbbeb91a2a6cd8798c124b27b7 ]
    
    Add quirks for jack detection, rt711 DAI and DMIC
    
    Reviewed-by: Bard Liao <bard.liao@intel.com>
    Reviewed-by: Kai Vehmanen <kai.vehmanen@linux.intel.com>
    Signed-off-by: Vamshi Krishna Gopal <vamshi.krishna.gopal@intel.com>
    Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Link: https://lore.kernel.org/r/20210415175013.192862-6-pierre-louis.bossart@linux.intel.com
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5241f40845c243a31d004dc388087fd2afee6aaf
Author: Takashi Iwai <tiwai@suse.de>
Date:   Fri Apr 16 10:12:11 2021 +0200

    ALSA: hda/realtek: Add quirk for Lenovo Ideapad S740
    
    [ Upstream commit 26928ca1f06aab4361eb5adbe7ef3b5c82f13cf2 ]
    
    Lenovo Ideapad S740 requires quite a few COEF setups to make its
    speakers working.  The verb table was provided from Ryan Prescott as
    the result of investigation via qemu:
      https://github.com/ryanprescott/realtek-verb-tools/wiki/How-to-sniff-verbs-from-a-Windows-sound-driver
    
    BugLink: https://github.com/thesofproject/linux/issues/2748
    Tested-by: Ryan Prescott <ryan@cousinscomputers.net>
    Link: https://lore.kernel.org/r/20210416081211.20059-1-tiwai@suse.de
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7b9075df7a8aacbdb1c82b6e86cb92951ed7f67a
Author: Mihai Moldovan <ionic@ionic.de>
Date:   Thu Apr 15 09:28:03 2021 +0200

    kconfig: nconf: stop endless search loops
    
    [ Upstream commit 8c94b430b9f6213dec84e309bb480a71778c4213 ]
    
    If the user selects the very first entry in a page and performs a
    search-up operation, or selects the very last entry in a page and
    performs a search-down operation that will not succeed (e.g., via
    [/]asdfzzz[Up Arrow]), nconf will never terminate searching the page.
    
    The reason is that in this case, the starting point will be set to -1
    or n, which is then translated into (n - 1) (i.e., the last entry of
    the page) or 0 (i.e., the first entry of the page) and finally the
    search begins. This continues to work fine until the index reaches 0 or
    (n - 1), at which point it will be decremented to -1 or incremented to
    n, but not checked against the starting point right away. Instead, it's
    wrapped around to the bottom or top again, after which the starting
    point check occurs... and naturally fails.
    
    My original implementation added another check for -1 before wrapping
    the running index variable around, but Masahiro Yamada pointed out that
    the actual issue is that the comparison point (starting point) exceeds
    bounds (i.e., the [0,n-1] interval) in the first place and that,
    instead, the starting point should be fixed.
    
    This has the welcome side-effect of also fixing the case where the
    starting point was n while searching down, which also lead to an
    infinite loop.
    
    OTOH, this code is now essentially all his work.
    
    Amazingly, nobody seems to have been hit by this for 11 years - or at
    the very least nobody bothered to debug and fix this.
    
    Signed-off-by: Mihai Moldovan <ionic@ionic.de>
    Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 93fe169efd1713cbc118d4053ddb70869d0c8da7
Author: Yonghong Song <yhs@fb.com>
Date:   Tue Apr 13 08:34:13 2021 -0700

    selftests: Set CC to clang in lib.mk if LLVM is set
    
    [ Upstream commit 26e6dd1072763cd5696b75994c03982dde952ad9 ]
    
    selftests/bpf/Makefile includes lib.mk. With the following command
      make -j60 LLVM=1 LLVM_IAS=1  <=== compile kernel
      make -j60 -C tools/testing/selftests/bpf LLVM=1 LLVM_IAS=1 V=1
    some files are still compiled with gcc. This patch
    fixed lib.mk issue which sets CC to gcc in all cases.
    
    Signed-off-by: Yonghong Song <yhs@fb.com>
    Signed-off-by: Alexei Starovoitov <ast@kernel.org>
    Acked-by: Andrii Nakryiko <andrii@kernel.org>
    Link: https://lore.kernel.org/bpf/20210413153413.3027426-1-yhs@fb.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit eea094b1d1d96579f9790b9d1aca33d567244d8f
Author: Anthony Wang <anthony1.wang@amd.com>
Date:   Wed Mar 31 11:03:35 2021 -0400

    drm/amd/display: Force vsync flip when reconfiguring MPCC
    
    [ Upstream commit 56d63782af9bbd1271bff1422a6a013123eade4d ]
    
    [Why]
    Underflow observed when disabling PIP overlay in-game when
    vsync is disabled, due to OTC master lock not working with
    game pipe which is immediate flip.
    
    [How]
    When performing a full update, override flip_immediate value
    to false for all planes, so that flip occurs on vsync.
    
    Signed-off-by: Anthony Wang <anthony1.wang@amd.com>
    Acked-by: Bindu Ramamurthy <bindur12@amd.com>
    Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit dcd68608c9e01dc80ff8c88787976c5c25ba0a37
Author: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Date:   Fri Apr 9 03:58:48 2021 -0500

    iommu/amd: Remove performance counter pre-initialization test
    
    [ Upstream commit 994d6608efe4a4c8834bdc5014c86f4bc6aceea6 ]
    
    In early AMD desktop/mobile platforms (during 2013), when the IOMMU
    Performance Counter (PMC) support was first introduced in
    commit 30861ddc9cca ("perf/x86/amd: Add IOMMU Performance Counter
    resource management"), there was a HW bug where the counters could not
    be accessed. The result was reading of the counter always return zero.
    
    At the time, the suggested workaround was to add a test logic prior
    to initializing the PMC feature to check if the counters can be programmed
    and read back the same value. This has been working fine until the more
    recent desktop/mobile platforms start enabling power gating for the PMC,
    which prevents access to the counters. This results in the PMC support
    being disabled unnecesarily.
    
    Unfortunatly, there is no documentation of since which generation
    of hardware the original PMC HW bug was fixed. Although, it was fixed
    soon after the first introduction of the PMC. Base on this, we assume
    that the buggy platforms are less likely to be in used, and it should
    be relatively safe to remove this legacy logic.
    
    Link: https://lore.kernel.org/linux-iommu/alpine.LNX.3.20.13.2006030935570.3181@monopod.intra.ispras.ru/
    Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=201753
    Cc: Tj (Elloe Linux) <ml.linux@elloe.vision>
    Cc: Shuah Khan <skhan@linuxfoundation.org>
    Cc: Alexander Monakov <amonakov@ispras.ru>
    Cc: David Coe <david.coe@live.co.uk>
    Cc: Paul Menzel <pmenzel@molgen.mpg.de>
    Signed-off-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
    Tested-by: Shuah Khan <skhan@linuxfoundation.org>
    Link: https://lore.kernel.org/r/20210409085848.3908-3-suravee.suthikulpanit@amd.com
    Signed-off-by: Joerg Roedel <jroedel@suse.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 6ba049c2974c1b7e429a27ed3efc6195feaf228d
Author: Paul Menzel <pmenzel@molgen.mpg.de>
Date:   Fri Apr 9 03:58:47 2021 -0500

    Revert "iommu/amd: Fix performance counter initialization"
    
    [ Upstream commit 715601e4e36903a653cd4294dfd3ed0019101991 ]
    
    This reverts commit 6778ff5b21bd8e78c8bd547fd66437cf2657fd9b.
    
    The original commit tries to address an issue, where PMC power-gating
    causing the IOMMU PMC pre-init test to fail on certain desktop/mobile
    platforms where the power-gating is normally enabled.
    
    There have been several reports that the workaround still does not
    guarantee to work, and can add up to 100 ms (on the worst case)
    to the boot process on certain platforms such as the MSI B350M MORTAR
    with AMD Ryzen 3 2200G.
    
    Therefore, revert this commit as a prelude to removing the pre-init
    test.
    
    Link: https://lore.kernel.org/linux-iommu/alpine.LNX.3.20.13.2006030935570.3181@monopod.intra.ispras.ru/
    Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=201753
    Cc: Tj (Elloe Linux) <ml.linux@elloe.vision>
    Cc: Shuah Khan <skhan@linuxfoundation.org>
    Cc: Alexander Monakov <amonakov@ispras.ru>
    Cc: David Coe <david.coe@live.co.uk>
    Signed-off-by: Paul Menzel <pmenzel@molgen.mpg.de>
    Signed-off-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
    Link: https://lore.kernel.org/r/20210409085848.3908-2-suravee.suthikulpanit@amd.com
    Signed-off-by: Joerg Roedel <jroedel@suse.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 875b62186f7b82236f303138045ccdc3f84ef6eb
Author: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
Date:   Thu Apr 8 13:28:38 2021 +0900

    ASoC: rsnd: call rsnd_ssi_master_clk_start() from rsnd_ssi_init()
    
    [ Upstream commit a122a116fc6d8fcf2f202dcd185173a54268f239 ]
    
    Current rsnd needs to call .prepare (P) for clock settings,
    .trigger for playback start (S) and stop (E).
    It should be called as below from SSI point of view.
    
            P -> S -> E -> P -> S -> E -> ...
    
    But, if you used MIXer, below case might happen
    
                          (2)
            1: P -> S ---> E -> ...
            2:         P ----> S -> ...
                      (1)     (3)
    
    P(1) setups clock, but E(2) resets it. and starts playback (3).
    In such case, it will reports "SSI parent/child should use same rate".
    
    rsnd_ssi_master_clk_start() which is the main function at (P)
    was called from rsnd_ssi_init() (= S) before,
    but was moved by below patch to rsnd_soc_dai_prepare() (= P) to avoid
    using clk_get_rate() which shouldn't be used under atomic context.
    
            commit 4d230d1271064 ("ASoC: rsnd: fixup not to call clk_get/set
                                    under non-atomic")
    
    Because of above patch, rsnd_ssi_master_clk_start() is now called at (P)
    which is for non atomic context. But (P) is assuming that spin lock is
    *not* used.
    One issue now is rsnd_ssi_master_clk_start() is checking ssi->xxx
    which should be protected by spin lock.
    
    After above patch, adg.c had below patch for other reasons.
    
            commit 06e8f5c842f2d ("ASoC: rsnd: don't call clk_get_rate()
                                    under atomic context")
    
    clk_get_rate() is used at probe() timing by this patch.
    In other words, rsnd_ssi_master_clk_start() is no longer using
    clk_get_rate() any more.
    
    This means we can call it from rsnd_ssi_init() (= S) again which is
    protected by spin lock.
    This patch re-move it to under spin lock, and solves
    1. checking ssi->xxx without spin lock issue.
    2. clk setting / device start / device stop race condition.
    
    Reported-by: Linh Phung T. Y. <linh.phung.jy@renesas.com>
    Signed-off-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
    Link: https://lore.kernel.org/r/875z0x1jt5.wl-kuninori.morimoto.gx@renesas.com
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d33a0894ce6ce7f0b8e5c7e875cdf7a74d0caa0c
Author: Vaibhav Jain <vaibhav@linux.ibm.com>
Date:   Sun Apr 4 22:01:48 2021 +0530

    powerpc/mm: Add cond_resched() while removing hpte mappings
    
    [ Upstream commit a5d6a3e73acbd619dd5b7b831762b755f9e2db80 ]
    
    While removing large number of mappings from hash page tables for
    large memory systems as soft-lockup is reported because of the time
    spent inside htap_remove_mapping() like one below:
    
     watchdog: BUG: soft lockup - CPU#8 stuck for 23s!
     <snip>
     NIP plpar_hcall+0x38/0x58
     LR  pSeries_lpar_hpte_invalidate+0x68/0xb0
     Call Trace:
      0x1fffffffffff000 (unreliable)
      pSeries_lpar_hpte_removebolted+0x9c/0x230
      hash__remove_section_mapping+0xec/0x1c0
      remove_section_mapping+0x28/0x3c
      arch_remove_memory+0xfc/0x150
      devm_memremap_pages_release+0x180/0x2f0
      devm_action_release+0x30/0x50
      release_nodes+0x28c/0x300
      device_release_driver_internal+0x16c/0x280
      unbind_store+0x124/0x170
      drv_attr_store+0x44/0x60
      sysfs_kf_write+0x64/0x90
      kernfs_fop_write+0x1b0/0x290
      __vfs_write+0x3c/0x70
      vfs_write+0xd4/0x270
      ksys_write+0xdc/0x130
      system_call+0x5c/0x70
    
    Fix this by adding a cond_resched() to the loop in
    htap_remove_mapping() that issues hcall to remove hpte mapping. The
    call to cond_resched() is issued every HZ jiffies which should prevent
    the soft-lockup from being reported.
    
    Suggested-by: Aneesh Kumar K.V <aneesh.kumar@linux.ibm.com>
    Signed-off-by: Vaibhav Jain <vaibhav@linux.ibm.com>
    Reviewed-by: Christophe Leroy <christophe.leroy@csgroup.eu>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Link: https://lore.kernel.org/r/20210404163148.321346-1-vaibhav@linux.ibm.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8048307cd833aa6df21ff0637cc15b97196d07fe
Author: Mordechay Goodstein <mordechay.goodstein@intel.com>
Date:   Sun Apr 11 12:46:22 2021 +0300

    iwlwifi: queue: avoid memory leak in reset flow
    
    [ Upstream commit 4cf2f5904d971a461f67825434ae3c31900ff84b ]
    
    In case the device is stopped any usage of hw queues needs to be
    reallocated in fw due to fw reset after device stop, so all driver
    internal queue should also be freed, and if we don't free the next usage
    would leak the old memory and get in recover flows
    "iwlwifi 0000:00:03.0: dma_pool_destroy iwlwifi:bc" warning.
    
    Also warn about trying to reuse an internal allocated queue.
    
    Signed-off-by: Mordechay Goodstein <mordechay.goodstein@intel.com>
    Signed-off-by: Luca Coelho <luciano.coelho@intel.com>
    Link: https://lore.kernel.org/r/iwlwifi.20210411124417.c72d2f0355c4.Ia3baff633b9b9109f88ab379ef0303aa152c16bf@changeid
    Signed-off-by: Luca Coelho <luciano.coelho@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ef1268d4b4edfbdc9d7712a9569f923691055bb6
Author: Johannes Berg <johannes.berg@intel.com>
Date:   Tue Mar 30 16:24:58 2021 +0300

    iwlwifi: pcie: make cfg vs. trans_cfg more robust
    
    [ Upstream commit 48a5494d6a4cb5812f0640d9515f1876ffc7a013 ]
    
    If we (for example) have a trans_cfg entry in the PCI IDs table,
    but then don't find a full cfg entry for it in the info table,
    we fall through to the code that treats the PCI ID table entry
    as a full cfg entry. This obviously causes crashes later, e.g.
    when trying to build the firmware name string.
    
    Avoid such crashes by using the low bit of the pointer as a tag
    for trans_cfg entries (automatically using a macro that checks
    the type when assigning) and then checking that before trying to
    use the data as a full entry - if it's just a partial entry at
    that point, fail.
    
    Since we're adding some macro magic, also check that the type is
    in fact either struct iwl_cfg_trans_params or struct iwl_cfg,
    failing compilation ("initializer element is not constant") if
    it isn't.
    
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Luca Coelho <luciano.coelho@intel.com>
    Link: https://lore.kernel.org/r/iwlwifi.20210330162204.6f69fe6e4128.I921d4ae20ef5276716baeeeda0b001cf25b9b968@changeid
    Signed-off-by: Luca Coelho <luciano.coelho@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7aa0d34a47c276dbb7f8571b6eae56cfc5b76958
Author: Miklos Szeredi <mszeredi@redhat.com>
Date:   Wed Apr 14 10:40:58 2021 +0200

    cuse: prevent clone
    
    [ Upstream commit 8217673d07256b22881127bf50dce874d0e51653 ]
    
    For cloned connections cuse_channel_release() will be called more than
    once, resulting in use after free.
    
    Prevent device cloning for CUSE, which does not make sense at this point,
    and highly unlikely to be used in real life.
    
    Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 067c57c94581799b8672d36ec6a14ec28585bfa9
Author: Miklos Szeredi <mszeredi@redhat.com>
Date:   Wed Apr 14 10:40:58 2021 +0200

    virtiofs: fix userns
    
    [ Upstream commit 0a7419c68a45d2d066b996be5087aa2d07ce80eb ]
    
    get_user_ns() is done twice (once in virtio_fs_get_tree() and once in
    fuse_conn_init()), resulting in a reference leak.
    
    Also looks better to use fsc->user_ns (which *should* be the
    current_user_ns() at this point).
    
    Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 7e60b26884d6d767549edb1c141f63efd73102f1
Author: Vivek Goyal <vgoyal@redhat.com>
Date:   Tue Apr 6 10:07:06 2021 -0400

    fuse: invalidate attrs when page writeback completes
    
    [ Upstream commit 3466958beb31a8e9d3a1441a34228ed088b84f3e ]
    
    In fuse when a direct/write-through write happens we invalidate attrs
    because that might have updated mtime/ctime on server and cached
    mtime/ctime will be stale.
    
    What about page writeback path.  Looks like we don't invalidate attrs
    there.  To be consistent, invalidate attrs in writeback path as well.  Only
    exception is when writeback_cache is enabled.  In that case we strust local
    mtime/ctime and there is no need to invalidate attrs.
    
    Recently users started experiencing failure of xfstests generic/080,
    geneirc/215 and generic/614 on virtiofs.  This happened only newer "stat"
    utility and not older one.  This patch fixes the issue.
    
    So what's the root cause of the issue.  Here is detailed explanation.
    
    generic/080 test does mmap write to a file, closes the file and then checks
    if mtime has been updated or not.  When file is closed, it leads to
    flushing of dirty pages (and that should update mtime/ctime on server).
    But we did not explicitly invalidate attrs after writeback finished.  Still
    generic/080 passed so far and reason being that we invalidated atime in
    fuse_readpages_end().  This is called in fuse_readahead() path and always
    seems to trigger before mmaped write.
    
    So after mmaped write when lstat() is called, it sees that atleast one of
    the fields being asked for is invalid (atime) and that results in
    generating GETATTR to server and mtime/ctime also get updated and test
    passes.
    
    But newer /usr/bin/stat seems to have moved to using statx() syscall now
    (instead of using lstat()).  And statx() allows it to query only ctime or
    mtime (and not rest of the basic stat fields).  That means when querying
    for mtime, fuse_update_get_attr() sees that mtime is not invalid (only
    atime is invalid).  So it does not generate a new GETATTR and fill stat
    with cached mtime/ctime.  And that means updated mtime is not seen by
    xfstest and tests start failing.
    
    Invalidating attrs after writeback completion should solve this problem in
    a generic manner.
    
    Signed-off-by: Vivek Goyal <vgoyal@redhat.com>
    Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit add13c3d54bf22ede130d03a358aae9220caced3
Author: Ye Weihua <yeweihua4@huawei.com>
Date:   Thu Apr 8 19:06:38 2021 +0800

    i2c: imx: Fix PM reference leak in i2c_imx_reg_slave()
    
    [ Upstream commit c4b1fcc310e655fa8414696c38a84d36c00684c8 ]
    
    pm_runtime_get_sync() will increment the PM reference count even on
    failure. Forgetting to put the reference again will result in a leak.
    
    Replace it with pm_runtime_resume_and_get() to keep the usage counter
    balanced.
    
    Reported-by: Hulk Robot <hulkci@huawei.com>
    Signed-off-by: Ye Weihua <yeweihua4@huawei.com>
    Signed-off-by: Wolfram Sang <wsa@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 6d40f1c520d640d0335492314755748c64db44b9
Author: Ryder Lee <ryder.lee@mediatek.com>
Date:   Tue Apr 6 12:46:09 2021 +0800

    mt76: mt7915: add wifi subsystem reset
    
    [ Upstream commit e07419a7dca97dd9bddfe5d099380857c19535f3 ]
    
    Reset wifi subsystem when MCU is already running.
    Fixes firmware download failure after soft reboot on systems where the PCIe
    reset could not be performed properly.
    
    Signed-off-by: Ryder Lee <ryder.lee@mediatek.com>
    Co-developed-by: Felix Fietkau <nbd@nbd.name>
    Signed-off-by: Felix Fietkau <nbd@nbd.name>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 448a00eaba77b2632db6585abb8e3385dd98a256
Author: Shayne Chen <shayne.chen@mediatek.com>
Date:   Thu Apr 1 10:31:29 2021 +0800

    mt76: mt7915: fix txpower init for TSSI off chips
    
    [ Upstream commit a226ccd04c479ccd23d6927c64bad1b441707f70 ]
    
    Fix incorrect txpower init value for TSSI off chips which causes
    too small txpower.
    
    Signed-off-by: Shayne Chen <shayne.chen@mediatek.com>
    Signed-off-by: Felix Fietkau <nbd@nbd.name>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f96e65476acec4600c2561187e2b60765a1d271c
Author: Felix Fietkau <nbd@nbd.name>
Date:   Mon Mar 22 21:39:57 2021 +0100

    mt76: mt7915: fix key set/delete issue
    
    [ Upstream commit 1da4fd48d28436f8b690cdc2879603dede6d8355 ]
    
    Deleting a key with the previous key index deletes the current key
    Rework the code to better keep track of multiple keys and check for the
    key index before deleting the current key
    
    Signed-off-by: Felix Fietkau <nbd@nbd.name>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit de32dbff010dd4e2e250e5a0662a45c393ae6562
Author: Lorenzo Bianconi <lorenzo@kernel.org>
Date:   Fri Feb 12 20:30:04 2021 +0100

    mt76: mt7915: always check return value from mt7915_mcu_alloc_wtbl_req
    
    [ Upstream commit 45f93e368211fbbd247e1ece254ffb121e20fa10 ]
    
    As done for mt76_connac_mcu_alloc_wtbl_req, even if this is not a real
    bug since mt7915_mcu_alloc_wtbl_req routine can fails just if nskb is NULL,
    always check return value from mt7915_mcu_alloc_wtbl_req in order to avoid
    possible future mistake.
    
    Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
    Signed-off-by: Felix Fietkau <nbd@nbd.name>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 4afe1ca637fad4ef28e50a7de45bf21a95cffe6c
Author: David Bauer <mail@david-bauer.net>
Date:   Sun Feb 7 16:09:17 2021 +0100

    mt76: mt76x0: disable GTK offloading
    
    [ Upstream commit 4b36cc6b390f18dbc59a45fb4141f90d7dfe2b23 ]
    
    When operating two VAP on a MT7610 with encryption (PSK2, SAE, OWE),
    only the first one to be created will transmit properly encrypteded
    frames.
    
    All subsequently created VAPs will sent out frames with the payload left
    unencrypted, breaking multicast traffic (ICMP6 NDP) and potentially
    disclosing information to a third party.
    
    Disable GTK offloading and encrypt these frames in software to
    circumvent this issue. THis only seems to be necessary on MT7610 chips,
    as MT7612 is not affected from our testing.
    
    Signed-off-by: David Bauer <mail@david-bauer.net>
    Signed-off-by: Felix Fietkau <nbd@nbd.name>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit aef8d2cf617dbd494ebafb4d6ae0e8e793955c73
Author: Sander Vanheule <sander@svanheule.net>
Date:   Tue Feb 2 09:59:53 2021 +0100

    mt76: mt7615: support loading EEPROM for MT7613BE
    
    [ Upstream commit 858ebf446bee7d5077bd99488aae617908c3f4fe ]
    
    EEPROM blobs for MT7613BE radios start with (little endian) 0x7663,
    which is also the PCI device ID for this device. The EEPROM is required
    for the radio to work at useful power levels, otherwise only the lowest
    power level is available.
    
    Suggested-by: Georgi Vlaev <georgi.vlaev@konsulko.com>
    Tested-by: Stijn Segers <foss@volatilesystems.org>
    Signed-off-by: Sander Vanheule <sander@svanheule.net>
    Signed-off-by: Felix Fietkau <nbd@nbd.name>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit ba70bf2a1b08a0eea5f8b668cef63221e7bdde9b
Author: Felix Fietkau <nbd@nbd.name>
Date:   Mon Feb 8 17:07:27 2021 +0100

    mt76: mt7615: fix key set/delete issues
    
    [ Upstream commit 730d6d0da8d8f5905faafe645a5b3c08ac3f5a8f ]
    
    There were multiple issues in the current key set/remove code:
    - deleting a key with the previous key index deletes the current key
    - BIP key would only be uploaded correctly initially and corrupted on rekey
    
    Rework the code to better keep track of multiple keys and check for the
    key index before deleting the current key
    
    Signed-off-by: Felix Fietkau <nbd@nbd.name>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 334180e4657764b290db4a92e81ef130a2a13fd2
Author: Po-Hao Huang <phhuang@realtek.com>
Date:   Fri Mar 19 13:42:16 2021 +0800

    rtw88: 8822c: add LC calibration for RTL8822C
    
    [ Upstream commit 7ae7784ec2a812c07d2ca91a6538ef2470154fb6 ]
    
    Fix power tracking issue by replacing unnecessary IQ calibration
    with LC calibration.
    When thermal difference exceeds limitation, let RF circuit adjsut
    its characteristic to fit in current environment.
    
    Signed-off-by: Po-Hao Huang <phhuang@realtek.com>
    Signed-off-by: Ping-Ke Shih <pkshih@realtek.com>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Link: https://lore.kernel.org/r/20210319054218.3319-6-pkshih@realtek.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 74a27dad632bdb71fd92c71043fc2f32236f6aca
Author: Krzysztof Kozlowski <krzysztof.kozlowski@canonical.com>
Date:   Thu Apr 8 21:50:29 2021 +0200

    pinctrl: samsung: use 'int' for register masks in Exynos
    
    [ Upstream commit fa0c10a5f3a49130dd11281aa27e7e1c8654abc7 ]
    
    The Special Function Registers on all Exynos SoC, including ARM64, are
    32-bit wide, so entire driver uses matching functions like readl() or
    writel().  On 64-bit ARM using unsigned long for register masks:
    1. makes little sense as immediately after bitwise operation it will be
       cast to 32-bit value when calling writel(),
    2. is actually error-prone because it might promote other operands to
       64-bit.
    
    Addresses-Coverity: Unintentional integer overflow
    Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@canonical.com>
    Reviewed-by: Sylwester Nawrocki <s.nawrocki@samsung.com>
    Link: https://lore.kernel.org/r/20210408195029.69974-1-krzysztof.kozlowski@canonical.com
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a5e38f28c33af8897cc07b8f277d947bb8f1eed1
Author: Gyeongtaek Lee <gt82.lee@samsung.com>
Date:   Wed Apr 7 13:14:04 2021 +0900

    ASoC: soc-compress: lock pcm_mutex to resolve lockdep error
    
    [ Upstream commit 45475bf60cc1d42da229a0aa757180c88bab8d22 ]
    
    If panic_on_warn=1 is added in bootargs and compress offload playback with
    DPCM is started, kernel panic would be occurred because rtd->card->pcm_mutex
    isn't held in soc_compr_open_fe() and soc_compr_free_fe() and it generates
    lockdep warning in the following code.
    
    void snd_soc_runtime_action(struct snd_soc_pcm_runtime *rtd,
                                int stream, int action)
    {
            struct snd_soc_dai *dai;
            int i;
    
            lockdep_assert_held(&rtd->card->pcm_mutex);
    
    To prevent lockdep warning but minimize side effect by adding mutex,
    pcm_mutex is held just before snd_soc_runtime_activate() and
    snd_soc_runtime_deactivate() and is released right after them.
    
    Signed-off-by: Gyeongtaek Lee <gt82.lee@samsung.com>
    Link: https://lore.kernel.org/r/1891546521.01617772502282.JavaMail.epsvc@epcpadp3
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a2cdbf2b54af46e1170b1ba57b2ffc58af881a55
Author: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
Date:   Thu Apr 8 14:31:25 2021 +0200

    mac80211: clear the beacon's CRC after channel switch
    
    [ Upstream commit d6843d1ee283137723b4a8c76244607ce6db1951 ]
    
    After channel switch, we should consider any beacon with a
    CSA IE as a new switch. If the CSA IE is a leftover from
    before the switch that the AP forgot to remove, we'll get
    a CSA-to-Self.
    
    This caused issues in iwlwifi where the firmware saw a beacon
    with a CSA-to-Self with mode = 1 on the new channel after a
    switch. The firmware considered this a new switch and closed
    its queues. Since the beacon didn't change between before and
    after the switch, we wouldn't handle it (the CRC is the same)
    and we wouldn't let the firmware open its queues again or
    disconnect if the CSA IE stays for too long.
    
    Clear the CRC valid state after we switch to make sure that
    we handle the beacon and handle the CSA IE as required.
    
    Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
    Link: https://lore.kernel.org/r/20210408143124.b9e68aa98304.I465afb55ca2c7d59f7bf610c6046a1fd732b4c28@changeid
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 52e986b78eb07f1f1d9d4cc2cea6e9c05740ef97
Author: Johan Almbladh <johan.almbladh@anyfinetworks.com>
Date:   Thu Apr 1 18:44:55 2021 +0200

    mac80211: Set priority and queue mapping for injected frames
    
    [ Upstream commit 96a7109a16665255b65d021e24141c2edae0e202 ]
    
    Some drivers, for example mt76, use the skb priority field, and
    expects that to be consistent with the skb queue mapping. On some
    frame injection code paths that was not true, and it broke frame
    injection. Now the skb queue mapping is set according to the skb
    priority value when the frame is injected. The skb priority value
    is also derived from the frame data for all frame types, as it
    was done prior to commit dbd50a851c50 (only allocate one queue
    when using iTXQs). Fixes frame injection with the mt76 driver on
    MT7610E chipset.
    
    Signed-off-by: Johan Almbladh <johan.almbladh@anyfinetworks.com>
    Link: https://lore.kernel.org/r/20210401164455.978245-1-johan.almbladh@anyfinetworks.com
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c44b9fcada261a994b2c58195e22018312f90a14
Author: Mike Marciniszyn <mike.marciniszyn@cornelisnetworks.com>
Date:   Mon Mar 29 09:54:09 2021 -0400

    IB/hfi1: Correct oversized ring allocation
    
    [ Upstream commit b536d4b2a279733f440c911dc831764690b90050 ]
    
    The completion ring for tx is using the wrong size to size the ring,
    oversizing the ring by two orders of magniture.
    
    Correct the allocation size and use kcalloc_node() to allocate the ring.
    Fix mistaken GFP defines in similar allocations.
    
    Link: https://lore.kernel.org/r/1617026056-50483-4-git-send-email-dennis.dalessandro@cornelisnetworks.com
    Reviewed-by: Kaike Wan <kaike.wan@intel.com>
    Signed-off-by: Mike Marciniszyn <mike.marciniszyn@cornelisnetworks.com>
    Signed-off-by: Dennis Dalessandro <dennis.dalessandro@cornelisnetworks.com>
    Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f4a8b770cb1073e9220cfffbc655bee562f3885b
Author: Suzuki K Poulose <suzuki.poulose@arm.com>
Date:   Mon Apr 5 17:42:57 2021 +0100

    coresight: Do not scan for graph if none is present
    
    [ Upstream commit 2b921b671a8d29c2adb255a86409aad1e3267309 ]
    
    If a graph node is not found for a given node, of_get_next_endpoint()
    will emit the following error message :
    
     OF: graph: no port node found in /<node_name>
    
    If the given component doesn't have any explicit connections (e.g,
    ETE) we could simply ignore the graph parsing. As for any legacy
    component where this is mandatory, the device will not be usable
    as before this patch. Updating the DT bindings to Yaml and enabling
    the schema checks can detect such issues with the DT.
    
    Cc: Mike Leach <mike.leach@linaro.org>
    Cc: Leo Yan <leo.yan@linaro.org>
    Signed-off-by: Suzuki K Poulose <suzuki.poulose@arm.com>
    Link: https://lore.kernel.org/r/20210405164307.1720226-11-suzuki.poulose@arm.com
    Signed-off-by: Mathieu Poirier <mathieu.poirier@linaro.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 96bd8200cc9ac84828a309e4dbd5ef228b002be5
Author: Tiezhu Yang <yangtiezhu@loongson.cn>
Date:   Tue Apr 6 17:25:12 2021 +0800

    MIPS: Loongson64: Use _CACHE_UNCACHED instead of _CACHE_UNCACHED_ACCELERATED
    
    [ Upstream commit 5e65c52ec716af6e8f51dacdaeb4a4d872249af1 ]
    
    Loongson64 processors have a writecombine issue that maybe failed to
    write back framebuffer used with ATI Radeon or AMD GPU at times, after
    commit 8a08e50cee66 ("drm: Permit video-buffers writecombine mapping
    for MIPS"), there exists some errors such as blurred screen and lockup,
    and so on.
    
    [   60.958721] radeon 0000:03:00.0: ring 0 stalled for more than 10079msec
    [   60.965315] radeon 0000:03:00.0: GPU lockup (current fence id 0x0000000000000112 last fence id 0x000000000000011d on ring 0)
    [   60.976525] radeon 0000:03:00.0: ring 3 stalled for more than 10086msec
    [   60.983156] radeon 0000:03:00.0: GPU lockup (current fence id 0x0000000000000374 last fence id 0x00000000000003a8 on ring 3)
    
    As discussed earlier [1], it might be better to disable writecombine
    on the CPU detection side because the root cause is unknown now.
    
    Actually, this patch is a temporary solution to just make it work well,
    it is not a proper and final solution, I hope someone will have a better
    solution to fix this issue in the future.
    
    [1] https://lore.kernel.org/patchwork/patch/1285542/
    
    Signed-off-by: Tiezhu Yang <yangtiezhu@loongson.cn>
    Signed-off-by: Thomas Bogendoerfer <tsbogend@alpha.franken.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a5596575e66997f7cd7f45529105695aa0092f27
Author: Daniel Winkler <danielwinkler@google.com>
Date:   Mon Apr 5 16:33:05 2021 -0700

    Bluetooth: Do not set cur_adv_instance in adv param MGMT request
    
    [ Upstream commit b6f1b79deabd32f89adbf24ef7b30f82d029808a ]
    
    We set hdev->cur_adv_instance in the adv param MGMT request to allow the
    callback to the hci param request to set the tx power to the correct
    instance. Now that the callbacks use the advertising handle from the hci
    request (as they should), this workaround is no longer necessary.
    
    Furthermore, this change resolves a race condition that is more
    prevalent when using the extended advertising MGMT calls - if
    hdev->cur_adv_instance is set in the params request, then when the data
    request is called, we believe our new instance is already active. This
    treats it as an update and immediately schedules the instance with the
    controller, which has a potential race with the software rotation adv
    update. By not setting hdev->cur_adv_instance too early, the new
    instance is queued as it should be, to be used when the rotation comes
    around again.
    
    This change is tested on harrison peak to confirm that it resolves the
    race condition on registration, and that there is no regression in
    single- and multi-advertising automated tests.
    
    Reviewed-by: Miao-chen Chou <mcchou@chromium.org>
    Signed-off-by: Daniel Winkler <danielwinkler@google.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit e7783464df35f88cb1d08eabf0314837a65c80c0
Author: Bence Csókás <bence98@sch.bme.hu>
Date:   Wed Mar 31 19:19:20 2021 +0000

    i2c: Add I2C_AQ_NO_REP_START adapter quirk
    
    [ Upstream commit aca01415e076aa96cca0f801f4420ee5c10c660d ]
    
    This quirk signifies that the adapter cannot do a repeated
    START, it always issues a STOP condition after transfers.
    
    Suggested-by: Wolfram Sang <wsa@kernel.org>
    Signed-off-by: Bence Csókás <bence98@sch.bme.hu>
    Signed-off-by: Wolfram Sang <wsa@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 97720ce80ae0a177b42c728c73a2c0c4c2592df1
Author: Matthieu Baerts <matthieu.baerts@tessares.net>
Date:   Thu Apr 1 16:19:45 2021 -0700

    selftests: mptcp: launch mptcp_connect with timeout
    
    [ Upstream commit 5888a61cb4e00695075bbacfd86f3fa73af00413 ]
    
    'mptcp_connect' already has a timeout for poll() but in some cases, it
    is not enough.
    
    With "timeout" tool, we will force the command to fail if it doesn't
    finish on time. Thanks to that, the script will continue and display
    details about the current state before marking the test as failed.
    Displaying this state is very important to be able to understand the
    issue. Best to have our CI reporting the issue than just "the test
    hanged".
    
    Note that in mptcp_connect.sh, we were using a long timeout to validate
    the fact we cannot create a socket if a sysctl is set. We don't need
    this timeout.
    
    In diag.sh, we want to send signals to mptcp_connect instances that have
    been started in the netns. But we cannot send this signal to 'timeout'
    otherwise that will stop the timeout and messages telling us SIGUSR1 has
    been received will be printed. Instead of trying to find the right PID
    and storing them in an array, we can simply use the output of
    'ip netns pids' which is all the PIDs we want to send signal to.
    
    Closes: https://github.com/multipath-tcp/mptcp_net-next/issues/160
    Signed-off-by: Matthieu Baerts <matthieu.baerts@tessares.net>
    Signed-off-by: Mat Martineau <mathew.j.martineau@linux.intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit fac30e10ca3d0322694b90150a70671240d34649
Author: Hans de Goede <hdegoede@redhat.com>
Date:   Fri Apr 2 16:07:45 2021 +0200

    ASoC: rt5670: Add a quirk for the Dell Venue 10 Pro 5055
    
    [ Upstream commit 84cb0d5581b6a7bd5d96013f67e9f2eb0c7b4378 ]
    
    Add a quirk with the jack-detect and dmic settings necessary to make
    jack-detect and the builtin mic work on Dell Venue 10 Pro 5055 tablets.
    
    Signed-off-by: Hans de Goede <hdegoede@redhat.com>
    Acked-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Link: https://lore.kernel.org/r/20210402140747.174716-5-hdegoede@redhat.com
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 28b9f7c043ba9323bad3f8809267098e311d5624
Author: mark-yw.chen <mark-yw.chen@mediatek.com>
Date:   Mon Mar 29 01:18:33 2021 +0800

    Bluetooth: btusb: Enable quirk boolean flag for Mediatek Chip.
    
    [ Upstream commit 27e554a4fcd84e499bf0a82122b8c4c3f1de38b6 ]
    
    Adding support LE scatternet and WBS for Mediatek Chip
    
    Signed-off-by: mark-yw.chen <mark-yw.chen@mediatek.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit e69716f2731fe4fb650c7c911c36863e2750b6a7
Author: Paul M Stillwell Jr <paul.m.stillwell.jr@intel.com>
Date:   Tue Mar 2 10:12:05 2021 -0800

    ice: handle increasing Tx or Rx ring sizes
    
    [ Upstream commit 2ec5638559c13b923250eccf495d2a033fccb3e7 ]
    
    There is an issue when the Tx or Rx ring size increases using
    'ethtool -L ...' where the new rings don't get the correct ITR
    values because when we rebuild the VSI we don't know that some
    of the rings may be new.
    
    Fix this by looking at the original number of rings and
    determining if the rings in ice_vsi_rebuild_set_coalesce()
    were not present in the original rings received in
    ice_vsi_rebuild_get_coalesce().
    
    Also change the code to return an error if we can't allocate
    memory for the coalesce data in ice_vsi_rebuild().
    
    Signed-off-by: Paul M Stillwell Jr <paul.m.stillwell.jr@intel.com>
    Tested-by: Tony Brelinski <tonyx.brelinski@intel.com>
    Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c5e0424a9567fd2992c598c8ea1f8d595eb6b369
Author: Hans de Goede <hdegoede@redhat.com>
Date:   Thu Mar 25 23:10:54 2021 +0100

    ASoC: Intel: bytcr_rt5640: Add quirk for the Chuwi Hi8 tablet
    
    [ Upstream commit 875c40eadf6ac6644c0f71842a4f30dd9968d281 ]
    
    The Chuwi Hi8 tablet is using an analog mic on IN1 and has its
    jack-detect connected to JD2_IN4N, instead of using the default
    IN3 for its internal mic and JD1_IN4P for jack-detect.
    
    It also only has 1 speaker.
    
    Add a quirk applying the correct settings for this configuration.
    
    Signed-off-by: Hans de Goede <hdegoede@redhat.com>
    Link: https://lore.kernel.org/r/20210325221054.22714-1-hdegoede@redhat.com
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a94bb20612797ce0f87049e1fdd2947355d2ecf3
Author: Eric Dumazet <edumazet@google.com>
Date:   Mon Mar 29 12:12:54 2021 -0700

    ip6_vti: proper dev_{hold|put} in ndo_[un]init methods
    
    [ Upstream commit 40cb881b5aaa0b69a7d93dec8440d5c62dae299f ]
    
    After adopting CONFIG_PCPU_DEV_REFCNT=n option, syzbot was able to trigger
    a warning [1]
    
    Issue here is that:
    
    - all dev_put() should be paired with a corresponding prior dev_hold().
    
    - A driver doing a dev_put() in its ndo_uninit() MUST also
      do a dev_hold() in its ndo_init(), only when ndo_init()
      is returning 0.
    
    Otherwise, register_netdevice() would call ndo_uninit()
    in its error path and release a refcount too soon.
    
    Therefore, we need to move dev_hold() call from
    vti6_tnl_create2() to vti6_dev_init_gen()
    
    [1]
    WARNING: CPU: 0 PID: 15951 at lib/refcount.c:31 refcount_warn_saturate+0xbf/0x1e0 lib/refcount.c:31
    Modules linked in:
    CPU: 0 PID: 15951 Comm: syz-executor.3 Not tainted 5.12.0-rc4-syzkaller #0
    Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
    RIP: 0010:refcount_warn_saturate+0xbf/0x1e0 lib/refcount.c:31
    Code: 1d 6a 5a e8 09 31 ff 89 de e8 8d 1a ab fd 84 db 75 e0 e8 d4 13 ab fd 48 c7 c7 a0 e1 c1 89 c6 05 4a 5a e8 09 01 e8 2e 36 fb 04 <0f> 0b eb c4 e8 b8 13 ab fd 0f b6 1d 39 5a e8 09 31 ff 89 de e8 58
    RSP: 0018:ffffc90001eaef28 EFLAGS: 00010282
    RAX: 0000000000000000 RBX: 0000000000000000 RCX: 0000000000000000
    RDX: 0000000000040000 RSI: ffffffff815c51f5 RDI: fffff520003d5dd7
    RBP: 0000000000000004 R08: 0000000000000000 R09: 0000000000000000
    R10: ffffffff815bdf8e R11: 0000000000000000 R12: ffff88801bb1c568
    R13: ffff88801f69e800 R14: 00000000ffffffff R15: ffff888050889d40
    FS:  00007fc79314e700(0000) GS:ffff8880b9c00000(0000) knlGS:0000000000000000
    CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    CR2: 00007f1c1ff47108 CR3: 0000000020fd5000 CR4: 00000000001506f0
    DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
    DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
    Call Trace:
     __refcount_dec include/linux/refcount.h:344 [inline]
     refcount_dec include/linux/refcount.h:359 [inline]
     dev_put include/linux/netdevice.h:4135 [inline]
     vti6_dev_uninit+0x31a/0x360 net/ipv6/ip6_vti.c:297
     register_netdevice+0xadf/0x1500 net/core/dev.c:10308
     vti6_tnl_create2+0x1b5/0x400 net/ipv6/ip6_vti.c:190
     vti6_newlink+0x9d/0xd0 net/ipv6/ip6_vti.c:1020
     __rtnl_newlink+0x1062/0x1710 net/core/rtnetlink.c:3443
     rtnl_newlink+0x64/0xa0 net/core/rtnetlink.c:3491
     rtnetlink_rcv_msg+0x44e/0xad0 net/core/rtnetlink.c:5553
     netlink_rcv_skb+0x153/0x420 net/netlink/af_netlink.c:2502
     netlink_unicast_kernel net/netlink/af_netlink.c:1312 [inline]
     netlink_unicast+0x533/0x7d0 net/netlink/af_netlink.c:1338
     netlink_sendmsg+0x856/0xd90 net/netlink/af_netlink.c:1927
     sock_sendmsg_nosec net/socket.c:654 [inline]
     sock_sendmsg+0xcf/0x120 net/socket.c:674
     ____sys_sendmsg+0x331/0x810 net/socket.c:2350
     ___sys_sendmsg+0xf3/0x170 net/socket.c:2404
     __sys_sendmmsg+0x195/0x470 net/socket.c:2490
     __do_sys_sendmmsg net/socket.c:2519 [inline]
     __se_sys_sendmmsg net/socket.c:2516 [inline]
     __x64_sys_sendmmsg+0x99/0x100 net/socket.c:2516
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 490c7e26b87eb7e6673882501730e4f10d6040b9
Author: Yunsheng Lin <linyunsheng@huawei.com>
Date:   Mon Mar 29 11:57:50 2021 +0800

    net: hns3: add handling for xmit skb with recursive fraglist
    
    [ Upstream commit d5d5e0193ee8f88efbbc7f1471087255657bc19a ]
    
    Currently hns3 driver only handle the xmit skb with one level of
    fraglist skb, add handling for multi level by calling hns3_tx_bd_num()
    recursively when calculating bd num and calling hns3_fill_skb_to_desc()
    recursively when filling tx desc.
    
    When the skb has a fraglist level of 24, the skb is simply dropped and
    stats.max_recursion_level is added to record the error. Move the stat
    handling from hns3_nic_net_xmit() to hns3_nic_maybe_stop_tx() in order
    to handle different error stat and add the 'max_recursion_level' and
    'hw_limitation' stat.
    
    Note that the max recursive level as 24 is chose according to below:
    commit 48a1df65334b ("skbuff: return -EMSGSIZE in skb_to_sgvec to
    prevent overflow").
    
    And that we are not able to find a testcase to verify the recursive
    fraglist case, so Fixes tag is not provided.
    
    Reported-by: Barry Song <song.bao.hua@hisilicon.com>
    Signed-off-by: Yunsheng Lin <linyunsheng@huawei.com>
    Signed-off-by: Huazhong Tan <tanhuazhong@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit fe4f6415177453ba06e296f186bd7644c0fa62dc
Author: Guangbin Huang <huangguangbin2@huawei.com>
Date:   Mon Mar 29 11:57:47 2021 +0800

    net: hns3: remediate a potential overflow risk of bd_num_list
    
    [ Upstream commit a2ee6fd28a190588e142ad8ea9d40069cd3c9f98 ]
    
    The array size of bd_num_list is a fixed value, it may have potential
    overflow risk when array size of hclge_dfx_bd_offset_list is greater
    than that fixed value. So modify bd_num_list as a pointer and allocate
    memory for it according to array size of hclge_dfx_bd_offset_list.
    
    Signed-off-by: Guangbin Huang <huangguangbin2@huawei.com>
    Signed-off-by: Huazhong Tan <tanhuazhong@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2e16f00251065ae242a0a94f2eeaa8212ea14736
Author: Christophe Leroy <christophe.leroy@csgroup.eu>
Date:   Fri Mar 12 12:50:25 2021 +0000

    powerpc/32: Statically initialise first emergency context
    
    [ Upstream commit a4719f5bb6d7dc220bffdc1b9f5ce5eaa5543581 ]
    
    The check of the emergency context initialisation in
    vmap_stack_overflow is buggy for the SMP case, as it
    compares r1 with 0 while in the SMP case r1 is offseted
    by the CPU id.
    
    Instead of fixing it, just perform static initialisation
    of the first emergency context.
    
    Signed-off-by: Christophe Leroy <christophe.leroy@csgroup.eu>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Link: https://lore.kernel.org/r/4a67ba422be75713286dca0c86ee0d3df2eb6dfa.1615552867.git.christophe.leroy@csgroup.eu
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2eed478b33f15877658efd79502b4aa7c37d62f5
Author: Russell Currey <ruscur@russell.cc>
Date:   Tue Feb 23 17:02:27 2021 +1000

    selftests/powerpc: Fix L1D flushing tests for Power10
    
    [ Upstream commit 3a72c94ebfb1f171eba0715998010678a09ec796 ]
    
    The rfi_flush and entry_flush selftests work by using the PM_LD_MISS_L1
    perf event to count L1D misses.  The value of this event has changed
    over time:
    
    - Power7 uses 0x400f0
    - Power8 and Power9 use both 0x400f0 and 0x3e054
    - Power10 uses only 0x3e054
    
    Rather than relying on raw values, configure perf to count L1D read
    misses in the most explicit way available.
    
    This fixes the selftests to work on systems without 0x400f0 as
    PM_LD_MISS_L1, and should change no behaviour for systems that the tests
    already worked on.
    
    The only potential downside is that referring to a specific perf event
    requires PMU support implemented in the kernel for that platform.
    
    Signed-off-by: Russell Currey <ruscur@russell.cc>
    Acked-by: Daniel Axtens <dja@axtens.net>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Link: https://lore.kernel.org/r/20210223070227.2916871-1-ruscur@russell.cc
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d3bc9846f68d02ec3154c347557f68393e1a785d
Author: Archie Pusaka <apusaka@chromium.org>
Date:   Tue Mar 23 16:32:20 2021 +0800

    Bluetooth: check for zapped sk before connecting
    
    [ Upstream commit 3af70b39fa2d415dc86c370e5b24ddb9fdacbd6f ]
    
    There is a possibility of receiving a zapped sock on
    l2cap_sock_connect(). This could lead to interesting crashes, one
    such case is tearing down an already tore l2cap_sock as is happened
    with this call trace:
    
    __dump_stack lib/dump_stack.c:15 [inline]
    dump_stack+0xc4/0x118 lib/dump_stack.c:56
    register_lock_class kernel/locking/lockdep.c:792 [inline]
    register_lock_class+0x239/0x6f6 kernel/locking/lockdep.c:742
    __lock_acquire+0x209/0x1e27 kernel/locking/lockdep.c:3105
    lock_acquire+0x29c/0x2fb kernel/locking/lockdep.c:3599
    __raw_spin_lock_bh include/linux/spinlock_api_smp.h:137 [inline]
    _raw_spin_lock_bh+0x38/0x47 kernel/locking/spinlock.c:175
    spin_lock_bh include/linux/spinlock.h:307 [inline]
    lock_sock_nested+0x44/0xfa net/core/sock.c:2518
    l2cap_sock_teardown_cb+0x88/0x2fb net/bluetooth/l2cap_sock.c:1345
    l2cap_chan_del+0xa3/0x383 net/bluetooth/l2cap_core.c:598
    l2cap_chan_close+0x537/0x5dd net/bluetooth/l2cap_core.c:756
    l2cap_chan_timeout+0x104/0x17e net/bluetooth/l2cap_core.c:429
    process_one_work+0x7e3/0xcb0 kernel/workqueue.c:2064
    worker_thread+0x5a5/0x773 kernel/workqueue.c:2196
    kthread+0x291/0x2a6 kernel/kthread.c:211
    ret_from_fork+0x4e/0x80 arch/x86/entry/entry_64.S:604
    
    Signed-off-by: Archie Pusaka <apusaka@chromium.org>
    Reported-by: syzbot+abfc0f5e668d4099af73@syzkaller.appspotmail.com
    Reviewed-by: Alain Michaud <alainm@chromium.org>
    Reviewed-by: Abhishek Pandit-Subedi <abhishekpandit@chromium.org>
    Reviewed-by: Guenter Roeck <groeck@chromium.org>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit e4c2365d41bdd867c069e4f6e19206eaa91c0633
Author: Nikolay Aleksandrov <nikolay@nvidia.com>
Date:   Mon Mar 22 17:45:27 2021 +0200

    net: bridge: when suppression is enabled exclude RARP packets
    
    [ Upstream commit 0353b4a96b7a9f60fe20d1b3ebd4931a4085f91c ]
    
    Recently we had an interop issue where RARP packets got suppressed with
    bridge neigh suppression enabled, but the check in the code was meant to
    suppress GARP. Exclude RARP packets from it which would allow some VMWare
    setups to work, to quote the report:
    "Those RARP packets usually get generated by vMware to notify physical
    switches when vMotion occurs. vMware may use random sip/tip or just use
    sip=tip=0. So the RARP packet sometimes get properly flooded by the vtep
    and other times get dropped by the logic"
    
    Reported-by: Amer Abdalamer <amer@nvidia.com>
    Signed-off-by: Nikolay Aleksandrov <nikolay@nvidia.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 35dc1ad4a04ec3448351b99743de39f4ad5d2afe
Author: Vladimir Oltean <vladimir.oltean@nxp.com>
Date:   Sun Mar 21 23:05:48 2021 +0200

    net/sched: cls_flower: use ntohs for struct flow_dissector_key_ports
    
    [ Upstream commit 6215afcb9a7e35cef334dc0ae7f998cc72c8465f ]
    
    A make W=1 build complains that:
    
    net/sched/cls_flower.c:214:20: warning: cast from restricted __be16
    net/sched/cls_flower.c:214:20: warning: incorrect type in argument 1 (different base types)
    net/sched/cls_flower.c:214:20:    expected unsigned short [usertype] val
    net/sched/cls_flower.c:214:20:    got restricted __be16 [usertype] dst
    
    This is because we use htons on struct flow_dissector_key_ports members
    src and dst, which are defined as __be16, so they are already in network
    byte order, not host. The byte swap function for the other direction
    should have been used.
    
    Because htons and ntohs do the same thing (either both swap, or none
    does), this change has no functional effect except to silence the
    warnings.
    
    Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 475b84f2762c38a9b0b40f698c80a4ae84fb30ee
Author: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>
Date:   Mon Mar 22 07:52:07 2021 +0900

    Bluetooth: initialize skb_queue_head at l2cap_chan_create()
    
    [ Upstream commit be8597239379f0f53c9710dd6ab551bbf535bec6 ]
    
    syzbot is hitting "INFO: trying to register non-static key." message [1],
    for "struct l2cap_chan"->tx_q.lock spinlock is not yet initialized when
    l2cap_chan_del() is called due to e.g. timeout.
    
    Since "struct l2cap_chan"->lock mutex is initialized at l2cap_chan_create()
    immediately after "struct l2cap_chan" is allocated using kzalloc(), let's
    as well initialize "struct l2cap_chan"->{tx_q,srej_q}.lock spinlocks there.
    
    [1] https://syzkaller.appspot.com/bug?extid=fadfba6a911f6bf71842
    
    Reported-and-tested-by: syzbot <syzbot+fadfba6a911f6bf71842@syzkaller.appspotmail.com>
    Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 2cf5b243807ddc98038ffb93b96211463eb36b44
Author: Archie Pusaka <apusaka@chromium.org>
Date:   Mon Mar 22 14:02:15 2021 +0800

    Bluetooth: Set CONF_NOT_COMPLETE as l2cap_chan default
    
    [ Upstream commit 3a9d54b1947ecea8eea9a902c0b7eb58a98add8a ]
    
    Currently l2cap_chan_set_defaults() reset chan->conf_state to zero.
    However, there is a flag CONF_NOT_COMPLETE which is set when
    creating the l2cap_chan. It is suggested that the flag should be
    cleared when l2cap_chan is ready, but when l2cap_chan_set_defaults()
    is called, l2cap_chan is not yet ready. Therefore, we must set this
    flag as the default.
    
    Example crash call trace:
    __dump_stack lib/dump_stack.c:15 [inline]
    dump_stack+0xc4/0x118 lib/dump_stack.c:56
    panic+0x1c6/0x38b kernel/panic.c:117
    __warn+0x170/0x1b9 kernel/panic.c:471
    warn_slowpath_fmt+0xc7/0xf8 kernel/panic.c:494
    debug_print_object+0x175/0x193 lib/debugobjects.c:260
    debug_object_assert_init+0x171/0x1bf lib/debugobjects.c:614
    debug_timer_assert_init kernel/time/timer.c:629 [inline]
    debug_assert_init kernel/time/timer.c:677 [inline]
    del_timer+0x7c/0x179 kernel/time/timer.c:1034
    try_to_grab_pending+0x81/0x2e5 kernel/workqueue.c:1230
    cancel_delayed_work+0x7c/0x1c4 kernel/workqueue.c:2929
    l2cap_clear_timer+0x1e/0x41 include/net/bluetooth/l2cap.h:834
    l2cap_chan_del+0x2d8/0x37e net/bluetooth/l2cap_core.c:640
    l2cap_chan_close+0x532/0x5d8 net/bluetooth/l2cap_core.c:756
    l2cap_sock_shutdown+0x806/0x969 net/bluetooth/l2cap_sock.c:1174
    l2cap_sock_release+0x64/0x14d net/bluetooth/l2cap_sock.c:1217
    __sock_release+0xda/0x217 net/socket.c:580
    sock_close+0x1b/0x1f net/socket.c:1039
    __fput+0x322/0x55c fs/file_table.c:208
    ____fput+0x17/0x19 fs/file_table.c:244
    task_work_run+0x19b/0x1d3 kernel/task_work.c:115
    exit_task_work include/linux/task_work.h:21 [inline]
    do_exit+0xe4c/0x204a kernel/exit.c:766
    do_group_exit+0x291/0x291 kernel/exit.c:891
    get_signal+0x749/0x1093 kernel/signal.c:2396
    do_signal+0xa5/0xcdb arch/x86/kernel/signal.c:737
    exit_to_usermode_loop arch/x86/entry/common.c:243 [inline]
    prepare_exit_to_usermode+0xed/0x235 arch/x86/entry/common.c:277
    syscall_return_slowpath+0x3a7/0x3b3 arch/x86/entry/common.c:348
    int_ret_from_sys_call+0x25/0xa3
    
    Signed-off-by: Archie Pusaka <apusaka@chromium.org>
    Reported-by: syzbot+338f014a98367a08a114@syzkaller.appspotmail.com
    Reviewed-by: Alain Michaud <alainm@chromium.org>
    Reviewed-by: Abhishek Pandit-Subedi <abhishekpandit@chromium.org>
    Reviewed-by: Guenter Roeck <groeck@chromium.org>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8de84ca5a7624d08d706b9a45c32fccb00976f83
Author: Takashi Sakamoto <o-takashi@sakamocchi.jp>
Date:   Sun Mar 21 12:28:31 2021 +0900

    ALSA: bebob: enable to deliver MIDI messages for multiple ports
    
    [ Upstream commit d2b6f15bc18ac8fbce25398290774c21f5b2cd44 ]
    
    Current implementation of bebob driver doesn't correctly handle the case
    that the device has multiple MIDI ports. The cause is the number of MIDI
    conformant data channels is passed to AM824 data block processing layer.
    
    This commit fixes the bug.
    
    Signed-off-by: Takashi Sakamoto <o-takashi@sakamocchi.jp>
    Link: https://lore.kernel.org/r/20210321032831.340278-4-o-takashi@sakamocchi.jp
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit b99bfc5eea9b13e050793ab7150d1b160b4d190a
Author: Tong Zhang <ztong0001@gmail.com>
Date:   Sun Mar 21 11:38:40 2021 -0400

    ALSA: rme9652: don't disable if not enabled
    
    [ Upstream commit f57a741874bb6995089020e97a1dcdf9b165dcbe ]
    
    rme9652 wants to disable a not enabled pci device, which makes kernel
    throw a warning. Make sure the device is enabled before calling disable.
    
    [    1.751595] snd_rme9652 0000:00:03.0: disabling already-disabled device
    [    1.751605] WARNING: CPU: 0 PID: 174 at drivers/pci/pci.c:2146 pci_disable_device+0x91/0xb0
    [    1.759968] Call Trace:
    [    1.760145]  snd_rme9652_card_free+0x76/0xa0 [snd_rme9652]
    [    1.760434]  release_card_device+0x4b/0x80 [snd]
    [    1.760679]  device_release+0x3b/0xa0
    [    1.760874]  kobject_put+0x94/0x1b0
    [    1.761059]  put_device+0x13/0x20
    [    1.761235]  snd_card_free+0x61/0x90 [snd]
    [    1.761454]  snd_rme9652_probe+0x3be/0x700 [snd_rme9652]
    
    Suggested-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Tong Zhang <ztong0001@gmail.com>
    Link: https://lore.kernel.org/r/20210321153840.378226-4-ztong0001@gmail.com
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 780d88e4e9559a6831df6f00de569fc24e2c642e
Author: Tong Zhang <ztong0001@gmail.com>
Date:   Sun Mar 21 11:38:39 2021 -0400

    ALSA: hdspm: don't disable if not enabled
    
    [ Upstream commit 790f5719b85e12e10c41753b864e74249585ed08 ]
    
    hdspm wants to disable a not enabled pci device, which makes kernel
    throw a warning. Make sure the device is enabled before calling disable.
    
    [    1.786391] snd_hdspm 0000:00:03.0: disabling already-disabled device
    [    1.786400] WARNING: CPU: 0 PID: 182 at drivers/pci/pci.c:2146 pci_disable_device+0x91/0xb0
    [    1.795181] Call Trace:
    [    1.795320]  snd_hdspm_card_free+0x58/0xa0 [snd_hdspm]
    [    1.795595]  release_card_device+0x4b/0x80 [snd]
    [    1.795860]  device_release+0x3b/0xa0
    [    1.796072]  kobject_put+0x94/0x1b0
    [    1.796260]  put_device+0x13/0x20
    [    1.796438]  snd_card_free+0x61/0x90 [snd]
    [    1.796659]  snd_hdspm_probe+0x97b/0x1440 [snd_hdspm]
    
    Suggested-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Tong Zhang <ztong0001@gmail.com>
    Link: https://lore.kernel.org/r/20210321153840.378226-3-ztong0001@gmail.com
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit eca306d839ffbe6cf542977447b081a9dad56d3c
Author: Tong Zhang <ztong0001@gmail.com>
Date:   Sun Mar 21 11:38:38 2021 -0400

    ALSA: hdsp: don't disable if not enabled
    
    [ Upstream commit 507cdb9adba006a7798c358456426e1aea3d9c4f ]
    
    hdsp wants to disable a not enabled pci device, which makes kernel
    throw a warning. Make sure the device is enabled before calling disable.
    
    [    1.758292] snd_hdsp 0000:00:03.0: disabling already-disabled device
    [    1.758327] WARNING: CPU: 0 PID: 180 at drivers/pci/pci.c:2146 pci_disable_device+0x91/0xb0
    [    1.766985] Call Trace:
    [    1.767121]  snd_hdsp_card_free+0x94/0xf0 [snd_hdsp]
    [    1.767388]  release_card_device+0x4b/0x80 [snd]
    [    1.767639]  device_release+0x3b/0xa0
    [    1.767838]  kobject_put+0x94/0x1b0
    [    1.768027]  put_device+0x13/0x20
    [    1.768207]  snd_card_free+0x61/0x90 [snd]
    [    1.768430]  snd_hdsp_probe+0x524/0x5e0 [snd_hdsp]
    
    Suggested-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Tong Zhang <ztong0001@gmail.com>
    Link: https://lore.kernel.org/r/20210321153840.378226-2-ztong0001@gmail.com
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit c4becc74d197909a51e94e1b896b59a947e2501f
Author: Wolfram Sang <wsa+renesas@sang-engineering.com>
Date:   Fri Mar 12 12:57:34 2021 +0100

    i2c: bail out early when RDWR parameters are wrong
    
    [ Upstream commit 71581562ee36032d2d574a9b23ad4af6d6a64cf7 ]
    
    The buggy parameters currently get caught later, but emit a noisy WARN.
    Userspace should not be able to trigger this, so add similar checks much
    earlier. Also avoids some unneeded code paths, of course. Apply kernel
    coding stlye to a comment while here.
    
    Reported-by: syzbot+ffb0b3ffa6cfbc7d7b3f@syzkaller.appspotmail.com
    Tested-by: syzbot+ffb0b3ffa6cfbc7d7b3f@syzkaller.appspotmail.com
    Signed-off-by: Wolfram Sang <wsa+renesas@sang-engineering.com>
    Signed-off-by: Wolfram Sang <wsa@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 05e6258b67efb2420076468d9d74f09b94ce838e
Author: Ayush Garg <ayush.garg@samsung.com>
Date:   Wed Mar 17 16:52:14 2021 +0530

    Bluetooth: Fix incorrect status handling in LE PHY UPDATE event
    
    [ Upstream commit 87df8bcccd2cede62dfb97dc3d4ca1fe66cb4f83 ]
    
    Skip updation of tx and rx PHYs values, when PHY Update
    event's status is not successful.
    
    Signed-off-by: Ayush Garg <ayush.garg@samsung.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1ba17c2a30c1e2166d2afa039ee53ca6ea13c971
Author: Mikhail Durnev <mikhail_durnev@mentor.com>
Date:   Tue Mar 16 14:47:35 2021 +1000

    ASoC: rsnd: core: Check convert rate in rsnd_hw_params
    
    [ Upstream commit 19c6a63ced5e07e40f3a5255cb1f0fe0d3be7b14 ]
    
    snd_pcm_hw_params_set_rate_near can return incorrect sample rate in
    some cases, e.g. when the backend output rate is set to some value higher
    than 48000 Hz and the input rate is 8000 Hz. So passing the value returned
    by snd_pcm_hw_params_set_rate_near to snd_pcm_hw_params will result in
    "FSO/FSI ratio error" and playing no audio at all while the userland
    is not properly notified about the issue.
    
    If SRC is unable to convert the requested sample rate to the sample rate
    the backend is using, then the requested sample rate should be adjusted in
    rsnd_hw_params. The userland will be notified about that change in the
    returned hw_params structure.
    
    Signed-off-by: Mikhail Durnev <mikhail_durnev@mentor.com>
    Link: https://lore.kernel.org/r/1615870055-13954-1-git-send-email-mikhail_durnev@mentor.com
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 612640348a3c037a744c599d2525d35ba189d3b2
Author: Jonathan McDowell <noodles@earth.li>
Date:   Sat Mar 13 13:18:26 2021 +0000

    net: stmmac: Set FIFO sizes for ipq806x
    
    [ Upstream commit e127906b68b49ddb3ecba39ffa36a329c48197d3 ]
    
    Commit eaf4fac47807 ("net: stmmac: Do not accept invalid MTU values")
    started using the TX FIFO size to verify what counts as a valid MTU
    request for the stmmac driver.  This is unset for the ipq806x variant.
    Looking at older patches for this it seems the RX + TXs buffers can be
    up to 8k, so set appropriately.
    
    (I sent this as an RFC patch in June last year, but received no replies.
    I've been running with this on my hardware (a MikroTik RB3011) since
    then with larger MTUs to support both the internal qca8k switch and
    VLANs with no problems. Without the patch it's impossible to set the
    larger MTU required to support this.)
    
    Signed-off-by: Jonathan McDowell <noodles@earth.li>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit aad5edb634fdbcaf84f72e44ca4ea7e4a7a30016
Author: Maxim Mikityanskiy <maximmi@mellanox.com>
Date:   Fri Jan 29 18:43:31 2021 +0200

    net/mlx5e: Use net_prefetchw instead of prefetchw in MPWQE TX datapath
    
    [ Upstream commit 991b2654605b455a94dac73e14b23480e7e20991 ]
    
    Commit e20f0dbf204f ("net/mlx5e: RX, Add a prefetch command for small
    L1_CACHE_BYTES") switched to using net_prefetchw at all places in mlx5e.
    In the same time frame, commit 5af75c747e2a ("net/mlx5e: Enhanced TX
    MPWQE for SKBs") added one more usage of prefetchw. When these two
    changes were merged, this new occurrence of prefetchw wasn't replaced
    with net_prefetchw.
    
    This commit fixes this last occurrence of prefetchw in
    mlx5e_tx_mpwqe_session_start, making the same change that was done in
    mlx5e_xdp_mpwqe_session_start.
    
    Signed-off-by: Maxim Mikityanskiy <maximmi@mellanox.com>
    Reviewed-by: Saeed Mahameed <saeedm@nvidia.com>
    Reviewed-by: Tariq Toukan <tariqt@nvidia.com>
    Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit cc2d42fcc30a7aa553cb67bbab0984dddd253d79
Author: Hans de Goede <hdegoede@redhat.com>
Date:   Fri Mar 12 12:48:50 2021 +0100

    ASoC: Intel: bytcr_rt5640: Enable jack-detect support on Asus T100TAF
    
    [ Upstream commit b7c7203a1f751348f35fc4bcb157572d303f7573 ]
    
    The Asus T100TAF uses the same jack-detect settings as the T100TA,
    this has been confirmed on actual hardware.
    
    Add these settings to the T100TAF quirks to enable jack-detect support
    on the T100TAF.
    
    Signed-off-by: Hans de Goede <hdegoede@redhat.com>
    Acked-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
    Link: https://lore.kernel.org/r/20210312114850.13832-1-hdegoede@redhat.com
    Signed-off-by: Mark Brown <broonie@kernel.org>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d0513cce80823078dd4078b26c77d2dba08d8b5f
Author: Hoang Le <hoang.h.le@dektech.com.au>
Date:   Thu Mar 11 10:33:22 2021 +0700

    tipc: convert dest node's address to network order
    
    [ Upstream commit 1980d37565061ab44bdc2f9e4da477d3b9752e81 ]
    
    (struct tipc_link_info)->dest is in network order (__be32), so we must
    convert the value to network order before assigning. The problem detected
    by sparse:
    
    net/tipc/netlink_compat.c:699:24: warning: incorrect type in assignment (different base types)
    net/tipc/netlink_compat.c:699:24:    expected restricted __be32 [usertype] dest
    net/tipc/netlink_compat.c:699:24:    got int
    
    Acked-by: Jon Maloy <jmaloy@redhat.com>
    Signed-off-by: Hoang Le <hoang.h.le@dektech.com.au>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit d6efc40a883ebdabeaa0b896c6487955c719f0c9
Author: Alexander Aring <aahringo@redhat.com>
Date:   Mon Mar 1 17:05:20 2021 -0500

    fs: dlm: add shutdown hook
    
    [ Upstream commit 9d232469bcd772dbedb9e75a165c681b920524ee ]
    
    This patch fixes issues which occurs when dlm lowcomms synchronize their
    workqueues but dlm application layer already released the lockspace. In
    such cases messages like:
    
    dlm: gfs2: release_lockspace final free
    dlm: invalid lockspace 3841231384 from 1 cmd 1 type 11
    
    are printed on the kernel log. This patch is solving this issue by
    introducing a new "shutdown" hook before calling "stop" hook when the
    lockspace is going to be released finally. This should pretend any
    dlm messages sitting in the workqueues during or after lockspace
    removal.
    
    It's necessary to call dlm_scand_stop() as I instrumented
    dlm_lowcomms_get_buffer() code to report a warning after it's called after
    dlm_midcomms_shutdown() functionality, see below:
    
    WARNING: CPU: 1 PID: 3794 at fs/dlm/midcomms.c:1003 dlm_midcomms_get_buffer+0x167/0x180
    Modules linked in: joydev iTCO_wdt intel_pmc_bxt iTCO_vendor_support drm_ttm_helper ttm pcspkr serio_raw i2c_i801 i2c_smbus drm_kms_helper virtio_scsi lpc_ich virtio_balloon virtio_console xhci_pci xhci_pci_renesas cec qemu_fw_cfg drm [last unloaded: qxl]
    CPU: 1 PID: 3794 Comm: dlm_scand Tainted: G        W         5.11.0+ #26
    Hardware name: Red Hat KVM/RHEL-AV, BIOS 1.13.0-2.module+el8.3.0+7353+9de0a3cc 04/01/2014
    RIP: 0010:dlm_midcomms_get_buffer+0x167/0x180
    Code: 5d 41 5c 41 5d 41 5e 41 5f c3 0f 0b 45 31 e4 5b 5d 4c 89 e0 41 5c 41 5d 41 5e 41 5f c3 4c 89 e7 45 31 e4 e8 3b f1 ec ff eb 86 <0f> 0b 4c 89 e7 45 31 e4 e8 2c f1 ec ff e9 74 ff ff ff 0f 1f 80 00
    RSP: 0018:ffffa81503f8fe60 EFLAGS: 00010202
    RAX: 0000000000000008 RBX: ffff8f969827f200 RCX: 0000000000000001
    RDX: 0000000000000000 RSI: ffffffffad1e89a0 RDI: ffff8f96a5294160
    RBP: 0000000000000001 R08: 0000000000000000 R09: ffff8f96a250bc60
    R10: 00000000000045d3 R11: 0000000000000000 R12: ffff8f96a250bc60
    R13: ffffa81503f8fec8 R14: 0000000000000070 R15: 0000000000000c40
    FS:  0000000000000000(0000) GS:ffff8f96fbc00000(0000) knlGS:0000000000000000
    CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    CR2: 000055aa3351c000 CR3: 000000010bf22000 CR4: 00000000000006e0
    DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
    DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
    Call Trace:
     dlm_scan_rsbs+0x420/0x670
     ? dlm_uevent+0x20/0x20
     dlm_scand+0xbf/0xe0
     kthread+0x13a/0x150
     ? __kthread_bind_mask+0x60/0x60
     ret_from_fork+0x22/0x30
    
    To synchronize all dlm scand messages we stop it right before shutdown
    hook.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 1a4947370f071d220e9d0f01a9972c42bb191370
Author: Alexander Aring <aahringo@redhat.com>
Date:   Mon Mar 1 17:05:19 2021 -0500

    fs: dlm: flush swork on shutdown
    
    [ Upstream commit eec054b5a7cfe6d1f1598a323b05771ee99857b5 ]
    
    This patch fixes the flushing of send work before shutdown. The function
    cancel_work_sync() is not the right workqueue functionality to use here
    as it would cancel the work if the work queues itself. In cases of
    EAGAIN in send() for dlm message we need to be sure that everything is
    send out before. The function flush_work() will ensure that every send
    work is be done inclusive in EAGAIN cases.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 8b762cf34e4eb6b7b8a13188ee863fbf16d92298
Author: Alexander Aring <aahringo@redhat.com>
Date:   Mon Mar 1 17:05:17 2021 -0500

    fs: dlm: check on minimum msglen size
    
    [ Upstream commit 710176e8363f269c6ecd73d203973b31ace119d3 ]
    
    This patch adds an additional check for minimum dlm header size which is
    an invalid dlm message and signals a broken stream. A msglen field cannot
    be less than the dlm header size because the field is inclusive header
    lengths.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit f3ab6234118d6f437d9254aac052be06c249395c
Author: Alexander Aring <aahringo@redhat.com>
Date:   Mon Mar 1 17:05:14 2021 -0500

    fs: dlm: change allocation limits
    
    [ Upstream commit c45674fbdda138814ca21138475219c96fa5aa1f ]
    
    While running tcpkill I experienced invalid header length values while
    receiving to check that a node doesn't try to send a invalid dlm message
    we also check on applications minimum allocation limit. Also use
    DEFAULT_BUFFER_SIZE as maximum allocation limit. The define
    LOWCOMMS_MAX_TX_BUFFER_LEN is to calculate maximum buffer limits on
    application layer, future midcomms layer will subtract their needs from
    this define.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 5369d3bf96495d6558947ae40f1a106448f8e615
Author: Alexander Aring <aahringo@redhat.com>
Date:   Mon Mar 1 17:05:13 2021 -0500

    fs: dlm: add check if dlm is currently running
    
    [ Upstream commit 517461630d1c25ee4dfc1dee80973a64189d6ccf ]
    
    This patch adds checks for dlm config attributes regarding to protocol
    parameters as it makes only sense to change them when dlm is not running.
    It also adds a check for valid protocol specifiers and return invalid
    argument if they are not supported.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 0881ef8dc7db7cd1aa7ea2804cb8335d8ce38d04
Author: Alexander Aring <aahringo@redhat.com>
Date:   Mon Mar 1 17:05:12 2021 -0500

    fs: dlm: add errno handling to check callback
    
    [ Upstream commit 8aa9540b49e0833feba75dbf4f45babadd0ed215 ]
    
    This allows to return individual errno values for the config attribute
    check callback instead of returning invalid argument only.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit b33f1e8d4ce0a0d725866f542fca2db97c3e7154
Author: Alexander Aring <aahringo@redhat.com>
Date:   Mon Mar 1 17:05:09 2021 -0500

    fs: dlm: fix mark setting deadlock
    
    [ Upstream commit e125fbeb538e5e35a00c6c8150a5361bef34814c ]
    
    This patch fixes an deadlock issue when dlm_lowcomms_close() is called.
    When dlm_lowcomms_close() is called the clusters_root.subsys.su_mutex is
    held to remove configfs items. At this time we flushing (e.g.
    cancel_work_sync()) the workers of send and recv workqueue. Due the fact
    that we accessing configfs items (mark values), these workers will lock
    clusters_root.subsys.su_mutex as well which are already hold by
    dlm_lowcomms_close() and ends in a deadlock situation.
    
    [67170.703046] ======================================================
    [67170.703965] WARNING: possible circular locking dependency detected
    [67170.704758] 5.11.0-rc4+ #22 Tainted: G        W
    [67170.705433] ------------------------------------------------------
    [67170.706228] dlm_controld/280 is trying to acquire lock:
    [67170.706915] ffff9f2f475a6948 ((wq_completion)dlm_recv){+.+.}-{0:0}, at: __flush_work+0x203/0x4c0
    [67170.708026]
                   but task is already holding lock:
    [67170.708758] ffffffffa132f878 (&clusters_root.subsys.su_mutex){+.+.}-{3:3}, at: configfs_rmdir+0x29b/0x310
    [67170.710016]
                   which lock already depends on the new lock.
    
    The new behaviour adds the mark value to the node address configuration
    which doesn't require to held the clusters_root.subsys.su_mutex by
    accessing mark values in a separate datastructure. However the mark
    values can be set now only after a node address was set which is the
    case when the user is using dlm_controld.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 9a5bd1599dc0ff4b9a3acd2f5d02a3d8e4a06757
Author: Alexander Aring <aahringo@redhat.com>
Date:   Mon Mar 1 17:05:08 2021 -0500

    fs: dlm: fix debugfs dump
    
    [ Upstream commit 92c48950b43f4a767388cf87709d8687151a641f ]
    
    This patch fixes the following message which randomly pops up during
    glocktop call:
    
    seq_file: buggy .next function table_seq_next did not update position index
    
    The issue is that seq_read_iter() in fs/seq_file.c also needs an
    increment of the index in an non next record case as well which this
    patch fixes otherwise seq_read_iter() will print out the above message.
    
    Signed-off-by: Alexander Aring <aahringo@redhat.com>
    Signed-off-by: David Teigland <teigland@redhat.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 354e882568e95184206e2b17d7f72fd3a538548b
Author: Nicolas MURE <nicolas.mure2019@gmail.com>
Date:   Mon Mar 1 16:27:26 2021 +0100

    ALSA: usb-audio: Add Pioneer DJM-850 to quirks-table
    
    [ Upstream commit a3c30b0cb6d05f5bf66d1a5d42e876f31753a447 ]
    
    Declare the Pioneer DJM-850 interfaces for capture and playback.
    
    See https://github.com/nm2107/Pioneer-DJM-850-driver-reverse-engineering/blob/172fb9a61055960c88c67b7c416fe5bf3609807b/doc/usb-device-specifications.md
    for the complete device spec.
    
    Signed-off-by: Nicolas MURE <nicolas.mure2019@gmail.com>
    Link: https://lore.kernel.org/r/20210301152729.18094-2-nicolas.mure2019@gmail.com
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit a4aa13fca62ebf0e604807efadbde76556492f80
Author: Pradeep Kumar Chitrapu <pradeepc@codeaurora.org>
Date:   Thu Feb 18 10:27:08 2021 -0800

    ath11k: fix thermal temperature read
    
    [ Upstream commit e3de5bb7ac1a4cb262f8768924fd3ef6182b10bb ]
    
    Fix dangling pointer in thermal temperature event which causes
    incorrect temperature read.
    
    Tested-on: IPQ8074 AHB WLAN.HK.2.4.0.1-00041-QCAHKSWPL_SILICONZ-1
    
    Signed-off-by: Pradeep Kumar Chitrapu <pradeepc@codeaurora.org>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Link: https://lore.kernel.org/r/20210218182708.8844-1-pradeepc@codeaurora.org
    Signed-off-by: Sasha Levin <sashal@kernel.org>

commit 01facb21f128c0dcf61c478c0fbc5e32cc1a4940
Author: David Matlack <dmatlack@google.com>
Date:   Thu May 6 15:24:43 2021 +0000

    kvm: Cap halt polling at kvm->max_halt_poll_ns
    
    commit 258785ef08b323bddd844b4926a32c2b2045a1b0 upstream.
    
    When growing halt-polling, there is no check that the poll time exceeds
    the per-VM limit. It's possible for vcpu->halt_poll_ns to grow past
    kvm->max_halt_poll_ns and stay there until a halt which takes longer
    than kvm->halt_poll_ns.
    
    Signed-off-by: David Matlack <dmatlack@google.com>
    Signed-off-by: Venkatesh Srinivas <venkateshs@chromium.org>
    Message-Id: <20210506152442.4010298-1-venkateshs@chromium.org>
    Cc: stable@vger.kernel.org
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0d564f2d74f82d1644825951792b46dc8d4a1921
Author: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
Date:   Wed Apr 21 19:40:56 2021 +0200

    cpufreq: intel_pstate: Use HWP if enabled by platform firmware
    
    commit e5af36b2adb858e982d78d41d7363d05d951a19a upstream.
    
    It turns out that there are systems where HWP is enabled during
    initialization by the platform firmware (BIOS), but HWP EPP support
    is not advertised.
    
    After commit 7aa1031223bc ("cpufreq: intel_pstate: Avoid enabling HWP
    if EPP is not supported") intel_pstate refuses to use HWP on those
    systems, but the fallback PERF_CTL interface does not work on them
    either because of enabled HWP, and once enabled, HWP cannot be
    disabled.  Consequently, the users of those systems cannot control
    CPU performance scaling.
    
    Address this issue by making intel_pstate use HWP unconditionally if
    it is enabled already when the driver starts.
    
    Fixes: 7aa1031223bc ("cpufreq: intel_pstate: Avoid enabling HWP if EPP is not supported")
    Reported-by: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
    Tested-by: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Cc: 5.9+ <stable@vger.kernel.org> # 5.9+
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b7fefdce0ed1841291a6f56fef9c9f15190b8d85
Author: Tony Lindgren <tony@atomide.com>
Date:   Wed May 5 14:09:15 2021 +0300

    PM: runtime: Fix unpaired parent child_count for force_resume
    
    commit c745253e2a691a40c66790defe85c104a887e14a upstream.
    
    As pm_runtime_need_not_resume() relies also on usage_count, it can return
    a different value in pm_runtime_force_suspend() compared to when called in
    pm_runtime_force_resume(). Different return values can happen if anything
    calls PM runtime functions in between, and causes the parent child_count
    to increase on every resume.
    
    So far I've seen the issue only for omapdrm that does complicated things
    with PM runtime calls during system suspend for legacy reasons:
    
    omap_atomic_commit_tail() for omapdrm.0
     dispc_runtime_get()
      wakes up 58000000.dss as it's the dispc parent
       dispc_runtime_resume()
        rpm_resume() increases parent child_count
     dispc_runtime_put() won't idle, PM runtime suspend blocked
    pm_runtime_force_suspend() for 58000000.dss, !pm_runtime_need_not_resume()
     __update_runtime_status()
    system suspended
    pm_runtime_force_resume() for 58000000.dss, pm_runtime_need_not_resume()
     pm_runtime_enable() only called because of pm_runtime_need_not_resume()
    omap_atomic_commit_tail() for omapdrm.0
     dispc_runtime_get()
      wakes up 58000000.dss as it's the dispc parent
       dispc_runtime_resume()
        rpm_resume() increases parent child_count
     dispc_runtime_put() won't idle, PM runtime suspend blocked
    ...
    rpm_suspend for 58000000.dss but parent child_count is now unbalanced
    
    Let's fix the issue by adding a flag for needs_force_resume and use it in
    pm_runtime_force_resume() instead of pm_runtime_need_not_resume().
    
    Additionally omapdrm system suspend could be simplified later on to avoid
    lots of unnecessary PM runtime calls and the complexity it adds. The
    driver can just use internal functions that are shared between the PM
    runtime and system suspend related functions.
    
    Fixes: 4918e1f87c5f ("PM / runtime: Rework pm_runtime_force_suspend/resume()")
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Reviewed-by: Ulf Hansson <ulf.hansson@linaro.org>
    Tested-by: Tomi Valkeinen <tomi.valkeinen@ideasonboard.com>
    Cc: 4.16+ <stable@vger.kernel.org> # 4.16+
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4bedd54b9693b1eb3524ac5e793f9317f0584332
Author: Sumeet Pawnikar <sumeet.r.pawnikar@intel.com>
Date:   Tue May 11 23:31:42 2021 +0530

    ACPI: PM: Add ACPI ID of Alder Lake Fan
    
    commit 2404b8747019184002823dba7d2f0ecf89d802b7 upstream.
    
    Add a new unique fan ACPI device ID for Alder Lake to
    support it in acpi_dev_pm_attach() function.
    
    Fixes: 38748bcb940e ("ACPI: DPTF: Support Alder Lake")
    Signed-off-by: Sumeet Pawnikar <sumeet.r.pawnikar@intel.com>
    Acked-by: Zhang Rui <rui.zhang@intel.com>
    Cc: 5.10+ <stable@vger.kernel.org> # 5.10+
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2dcda55fe3102b6cae39da4f7704cfe1a5ba9fe7
Author: Lai Jiangshan <laijs@linux.alibaba.com>
Date:   Tue May 4 21:50:14 2021 +0200

    KVM/VMX: Invoke NMI non-IST entry instead of IST entry
    
    commit a217a6593cec8b315d4c2f344bae33660b39b703 upstream.
    
    In VMX, the host NMI handler needs to be invoked after NMI VM-Exit.
    Before commit 1a5488ef0dcf6 ("KVM: VMX: Invoke NMI handler via indirect
    call instead of INTn"), this was done by INTn ("int $2"). But INTn
    microcode is relatively expensive, so the commit reworked NMI VM-Exit
    handling to invoke the kernel handler by function call.
    
    But this missed a detail. The NMI entry point for direct invocation is
    fetched from the IDT table and called on the kernel stack.  But on 64-bit
    the NMI entry installed in the IDT expects to be invoked on the IST stack.
    It relies on the "NMI executing" variable on the IST stack to work
    correctly, which is at a fixed position in the IST stack.  When the entry
    point is unexpectedly called on the kernel stack, the RSP-addressed "NMI
    executing" variable is obviously also on the kernel stack and is
    "uninitialized" and can cause the NMI entry code to run in the wrong way.
    
    Provide a non-ist entry point for VMX which shares the C-function with
    the regular NMI entry and invoke the new asm entry point instead.
    
    On 32-bit this just maps to the regular NMI entry point as 32-bit has no
    ISTs and is not affected.
    
    [ tglx: Made it independent for backporting, massaged changelog ]
    
    Fixes: 1a5488ef0dcf6 ("KVM: VMX: Invoke NMI handler via indirect call instead of INTn")
    Signed-off-by: Lai Jiangshan <laijs@linux.alibaba.com>
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Tested-by: Lai Jiangshan <laijs@linux.alibaba.com>
    Cc: stable@vger.kernel.org
    Link: https://lore.kernel.org/r/87r1imi8i1.ffs@nanos.tec.linutronix.de
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6d5ec40cad8ce7a56c56d6e5be352b9bf98fcc0a
Author: Sean Christopherson <seanjc@google.com>
Date:   Thu Jan 14 16:40:51 2021 -0800

    KVM: x86/mmu: Remove the defunct update_pte() paging hook
    
    commit c5e2184d1544f9e56140791eff1a351bea2e63b9 upstream.
    
    Remove the update_pte() shadow paging logic, which was obsoleted by
    commit 4731d4c7a077 ("KVM: MMU: out of sync shadow core"), but never
    removed.  As pointed out by Yu, KVM never write protects leaf page
    tables for the purposes of shadow paging, and instead marks their
    associated shadow page as unsync so that the guest can write PTEs at
    will.
    
    The update_pte() path, which predates the unsync logic, optimizes COW
    scenarios by refreshing leaf SPTEs when they are written, as opposed to
    zapping the SPTE, restarting the guest, and installing the new SPTE on
    the subsequent fault.  Since KVM no longer write-protects leaf page
    tables, update_pte() is unreachable and can be dropped.
    
    Reported-by: Yu Zhang <yu.c.zhang@intel.com>
    Signed-off-by: Sean Christopherson <seanjc@google.com>
    Message-Id: <20210115004051.4099250-1-seanjc@google.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fb9e14f4f8217a0980f8da2c8ff70dee058cbe47
Author: Tom Lendacky <thomas.lendacky@amd.com>
Date:   Fri Apr 9 09:38:42 2021 -0500

    KVM: SVM: Make sure GHCB is mapped before updating
    
    commit a3ba26ecfb569f4aa3f867e80c02aa65f20aadad upstream.
    
    Access to the GHCB is mainly in the VMGEXIT path and it is known that the
    GHCB will be mapped. But there are two paths where it is possible the GHCB
    might not be mapped.
    
    The sev_vcpu_deliver_sipi_vector() routine will update the GHCB to inform
    the caller of the AP Reset Hold NAE event that a SIPI has been delivered.
    However, if a SIPI is performed without a corresponding AP Reset Hold,
    then the GHCB might not be mapped (depending on the previous VMEXIT),
    which will result in a NULL pointer dereference.
    
    The svm_complete_emulated_msr() routine will update the GHCB to inform
    the caller of a RDMSR/WRMSR operation about any errors. While it is likely
    that the GHCB will be mapped in this situation, add a safe guard
    in this path to be certain a NULL pointer dereference is not encountered.
    
    Fixes: f1c6366e3043 ("KVM: SVM: Add required changes to support intercepts under SEV-ES")
    Fixes: 647daca25d24 ("KVM: SVM: Add support for booting APs in an SEV-ES guest")
    Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
    Cc: stable@vger.kernel.org
    Message-Id: <a5d3ebb600a91170fc88599d5a575452b3e31036.1617979121.git.thomas.lendacky@amd.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9acd718ffb7f6ec5ffeb2d9009d4c1b44cd0da72
Author: Jarkko Sakkinen <jarkko@kernel.org>
Date:   Mon May 10 15:28:31 2021 +0300

    tpm, tpm_tis: Reserve locality in tpm_tis_resume()
    
    commit 8a2d296aaebadd68d9c1f6908667df1d1c84c051 upstream.
    
    Reserve locality in tpm_tis_resume(), as it could be unsert after waking
    up from a sleep state.
    
    Cc: stable@vger.kernel.org
    Cc: Lino Sanfilippo <LinoSanfilippo@gmx.de>
    Reported-by: Hans de Goede <hdegoede@redhat.com>
    Fixes: a3fbfae82b4c ("tpm: take TPM chip power gating out of tpm_transmit()")
    Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e86c4d98e587d9055fee03935860178de3e1f28f
Author: Jarkko Sakkinen <jarkko@kernel.org>
Date:   Mon May 10 15:28:30 2021 +0300

    tpm, tpm_tis: Extend locality handling to TPM2 in tpm_tis_gen_interrupt()
    
    commit e630af7dfb450d1c00c30077314acf33032ff9e4 upstream.
    
    The earlier fix (linked) only partially fixed the locality handling bug
    in tpm_tis_gen_interrupt(), i.e. only for TPM 1.x.
    
    Extend the locality handling to cover TPM2.
    
    Cc: Hans de Goede <hdegoede@redhat.com>
    Cc: stable@vger.kernel.org
    Link: https://lore.kernel.org/linux-integrity/20210220125534.20707-1-jarkko@kernel.org/
    Fixes: a3fbfae82b4c ("tpm: take TPM chip power gating out of tpm_transmit()")
    Reported-by: Lino Sanfilippo <LinoSanfilippo@gmx.de>
    Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
    Tested-by: Lino Sanfilippo <LinoSanfilippo@gmx.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1bdc28f44f376a9db8d4eb2a9c6b2e2bbc8e1865
Author: Zhen Lei <thunder.leizhen@huawei.com>
Date:   Wed May 12 21:39:26 2021 +0800

    tpm: fix error return code in tpm2_get_cc_attrs_tbl()
    
    commit 1df83992d977355177810c2b711afc30546c81ce upstream.
    
    If the total number of commands queried through TPM2_CAP_COMMANDS is
    different from that queried through TPM2_CC_GET_CAPABILITY, it indicates
    an unknown error. In this case, an appropriate error code -EFAULT should
    be returned. However, we currently do not explicitly assign this error
    code to 'rc'. As a result, 0 was incorrectly returned.
    
    Cc: stable@vger.kernel.org
    Fixes: 58472f5cd4f6("tpm: validate TPM 2.0 commands")
    Reported-by: Hulk Robot <hulkci@huawei.com>
    Signed-off-by: Zhen Lei <thunder.leizhen@huawei.com>
    Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
    Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1c4031014106aff48e1e686e40101c31eab5d44c
Author: Colin Ian King <colin.king@canonical.com>
Date:   Fri Apr 30 12:37:24 2021 +0100

    KEYS: trusted: Fix memory leak on object td
    
    commit 83a775d5f9bfda95b1c295f95a3a041a40c7f321 upstream.
    
    Two error return paths are neglecting to free allocated object td,
    causing a memory leak. Fix this by returning via the error return
    path that securely kfree's td.
    
    Fixes clang scan-build warning:
    security/keys/trusted-keys/trusted_tpm1.c:496:10: warning: Potential
    memory leak [unix.Malloc]
    
    Cc: stable@vger.kernel.org
    Fixes: 5df16caada3f ("KEYS: trusted: Fix incorrect handling of tpm_get_random()")
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Reviewed-by: Nick Desaulniers <ndesaulniers@google.com>
    Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
    Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
