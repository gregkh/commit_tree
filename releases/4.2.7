commit 7317505d86acdb03b248901d198386764fb6c2f6
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Wed Dec 9 14:31:40 2015 -0500

    Linux 4.2.7

commit 069e1ce1b502506c23b5d98b41c6c6ef88bf1d9e
Author: Sudip Mukherjee <sudipm.mukherjee@gmail.com>
Date:   Mon Sep 7 20:06:57 2015 +0530

    tile: fix build failure
    
    commit 3a48d13d76c0088a988a2e4f5b4d94872bdf58f3 upstream.
    
    When building with allmodconfig the build was failing with the error:
    
    arch/tile/kernel/usb.c:70:1: warning: data definition has no type or storage class [enabled by default]
    arch/tile/kernel/usb.c:70:1: error: type defaults to 'int' in declaration of 'arch_initcall' [-Werror=implicit-int]
    arch/tile/kernel/usb.c:70:1: warning: parameter names (without types) in function declaration [enabled by default]
    arch/tile/kernel/usb.c:63:19: warning: 'tilegx_usb_init' defined but not used [-Wunused-function]
    
    Include linux/module.h to resolve the build failure.
    
    Signed-off-by: Sudip Mukherjee <sudip@vectorindia.org>
    Signed-off-by: Chris Metcalf <cmetcalf@ezchip.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7691b85a0295aafb1648da2caee75ada0f090033
Author: David Hildenbrand <dahi@linux.vnet.ibm.com>
Date:   Fri Nov 6 12:08:48 2015 +0100

    KVM: s390: enable SIMD only when no VCPUs were created
    
    commit 5967c17b118a2bd1dd1d554cc4eee16233e52bec upstream.
    
    We should never allow to enable/disable any facilities for the guest
    when other VCPUs were already created.
    
    kvm_arch_vcpu_(load|put) relies on SIMD not changing during runtime.
    If somebody would create and run VCPUs and then decides to enable
    SIMD, undefined behaviour could be possible (e.g. vector save area
    not being set up).
    
    Acked-by: Christian Borntraeger <borntraeger@de.ibm.com>
    Acked-by: Cornelia Huck <cornelia.huck@de.ibm.com>
    Signed-off-by: David Hildenbrand <dahi@linux.vnet.ibm.com>
    Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e8d097151d309eb71f750bbf34e6a7ef6256da7e
Author: Boris Ostrovsky <boris.ostrovsky@oracle.com>
Date:   Fri Nov 20 11:25:04 2015 -0500

    xen/events: Always allocate legacy interrupts on PV guests
    
    commit b4ff8389ed14b849354b59ce9b360bdefcdbf99c upstream.
    
    After commit 8c058b0b9c34 ("x86/irq: Probe for PIC presence before
    allocating descs for legacy IRQs") early_irq_init() will no longer
    preallocate descriptors for legacy interrupts if PIC does not
    exist, which is the case for Xen PV guests.
    
    Therefore we may need to allocate those descriptors ourselves.
    
    Signed-off-by: Boris Ostrovsky <boris.ostrovsky@oracle.com>
    Suggested-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: David Vrabel <david.vrabel@citrix.com>
    Cc: Vitaly Kuznetsov <vkuznets@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 06992dcaf2476456a66a0ab907b36c507161dedf
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Sun Sep 27 16:45:01 2015 -0400

    staging/lustre: use jiffies for lp_last_query times
    
    commit 9f088dba3cc267ea11ec0da318cd0175575b5f9b upstream.
    
    The recently introduced lnet_peer_set_alive() function uses
    get_seconds() to read the current time into a shared variable,
    but all other uses of that variable compare it to jiffies values.
    
    This changes the current use to jiffies as well for consistency.
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Fixes: af3fa7c71bf ("staging/lustre/lnet: peer aliveness status and NI status")
    Cc: Liang Zhen <liang.zhen@intel.com>
    Cc: James Simmons <uja.ornl@gmail.com>
    Cc: Isaac Huang <he.huang@intel.com>
    Signed-off-by: Oleg Drokin <oleg.drokin@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dcdd1b5255126b84682e3bc6884df25bbf46c0c4
Author: Rajmohan Mani <rajmohan.mani@intel.com>
Date:   Wed Nov 18 10:48:20 2015 +0200

    xhci: Workaround to get Intel xHCI reset working more reliably
    
    commit a5964396190d0c40dd549c23848c282fffa5d1f2 upstream.
    
    Existing Intel xHCI controllers require a delay of 1 mS,
    after setting the CMD_RESET bit in command register, before
    accessing any HC registers. This allows the HC to complete
    the reset operation and be ready for HC register access.
    Without this delay, the subsequent HC register access,
    may result in a system hang, very rarely.
    
    Verified CherryView / Braswell platforms go through over
    5000 warm reboot cycles (which was not possible without
    this patch), without any xHCI reset hang.
    
    Signed-off-by: Rajmohan Mani <rajmohan.mani@intel.com>
    Tested-by: Joe Lawrence <joe.lawrence@stratus.com>
    Signed-off-by: Mathias Nyman <mathias.nyman@linux.intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0163804569a78f87cf47cf5a0891c7e829bd101c
Author: Peter Hurley <peter@hurleysoftware.com>
Date:   Wed Nov 11 08:03:54 2015 -0500

    tty: Fix tty_send_xchar() lock order inversion
    
    commit ee0c1a65cf95230d5eb3d9de94fd2ead9a428c67 upstream.
    
    The correct lock order is atomic_write_lock => termios_rwsem, as
    established by tty_write() => n_tty_write().
    
    Fixes: c274f6ef1c666 ("tty: Hold termios_rwsem for tcflow(TCIxxx)")
    Reported-and-Tested-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Peter Hurley <peter@hurleysoftware.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b7861b3137c40241cc299345a47be7f7d1efae10
Author: Peter Hurley <peter@hurleysoftware.com>
Date:   Sun Nov 8 08:52:31 2015 -0500

    tty: audit: Fix audit source
    
    commit 6b2a3d628aa752f0ab825fc6d4d07b09e274d1c1 upstream.
    
    The data to audit/record is in the 'from' buffer (ie., the input
    read buffer).
    
    Fixes: 72586c6061ab ("n_tty: Fix auditing support for cannonical mode")
    Cc: Miloslav Trmač <mitr@redhat.com>
    Signed-off-by: Peter Hurley <peter@hurleysoftware.com>
    Acked-by: Laura Abbott <labbott@fedoraproject.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 761a753f6d8ce48b0e0a4c5e868fe8453f378786
Author: James Hogan <jhogan@kernel.org>
Date:   Tue Oct 6 15:12:06 2015 +0100

    ttyFDC: Fix build problems due to use of module_{init,exit}
    
    commit 3e8137a185240fa6da0ff91cd9c604716371903b upstream.
    
    Commit 0fd972a7d91d (module: relocate module_init from init.h to
    module.h) broke the build of ttyFDC driver due to that driver's (mis)use
    of module_mips_cdmm_driver() without first including module.h, for
    example:
    
    In file included from ./arch/mips/include/asm/cdmm.h +11 :0,
                     from drivers/tty/mips_ejtag_fdc.c +34 :
    include/linux/device.h +1295 :1: warning: data definition has no type or storage class
    ./arch/mips/include/asm/cdmm.h +84 :2: note: in expansion of macro ‘module_driver’
    drivers/tty/mips_ejtag_fdc.c +1157 :1: note: in expansion of macro ‘module_mips_cdmm_driver’
    include/linux/device.h +1295 :1: error: type defaults to ‘int’ in declaration of ‘module_init’ [-Werror=implicit-int]
    ./arch/mips/include/asm/cdmm.h +84 :2: note: in expansion of macro ‘module_driver’
    drivers/tty/mips_ejtag_fdc.c +1157 :1: note: in expansion of macro ‘module_mips_cdmm_driver’
    drivers/tty/mips_ejtag_fdc.c +1157 :1: warning: parameter names (without types) in function declaration
    
    Instead of just adding the module.h include, switch to using the new
    builtin_mips_cdmm_driver() helper macro and drop the remove callback,
    since it isn't needed. If module support is added later, the code can
    always be resurrected.
    
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Cc: Jiri Slaby <jslaby@suse.com>
    Cc: Paul Gortmaker <paul.gortmaker@windriver.com>
    Cc: linux-mips@linux-mips.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 40603ac05434633e26fc698fa69993e4a26e1a73
Author: Clemens Ladisch <clemens@ladisch.de>
Date:   Sun Nov 15 22:39:08 2015 +0100

    ALSA: usb-audio: work around CH345 input SysEx corruption
    
    commit a91e627e3f0ed820b11d86cdc04df38f65f33a70 upstream.
    
    One of the many faults of the QinHeng CH345 USB MIDI interface chip is
    that it does not handle received SysEx messages correctly -- every second
    event packet has a wrong code index number, which is the one from the last
    seen message, instead of 4.  For example, the two messages "FE F0 01 02 03
    04 05 06 07 08 09 0A 0B 0C 0D 0E F7" result in the following event
    packets:
    
    correct:       CH345:
    0F FE 00 00    0F FE 00 00
    04 F0 01 02    04 F0 01 02
    04 03 04 05    0F 03 04 05
    04 06 07 08    04 06 07 08
    04 09 0A 0B    0F 09 0A 0B
    04 0C 0D 0E    04 0C 0D 0E
    05 F7 00 00    05 F7 00 00
    
    A class-compliant driver must interpret an event packet with CIN 15 as
    having a single data byte, so the other two bytes would be ignored.  The
    message received by the host would then be missing two bytes out of six;
    in this example, "F0 01 02 03 06 07 08 09 0C 0D 0E F7".
    
    These corrupted SysEx event packages contain only data bytes, while the
    CH345 uses event packets with a correct CIN value only for messages with
    a status byte, so it is possible to distinguish between these two cases by
    checking for the presence of this status byte.
    
    (Other bugs in the CH345's input handling, such as the corruption resulting
    from running status, cannot be worked around.)
    
    Signed-off-by: Clemens Ladisch <clemens@ladisch.de>
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1b25851cf1b6111c35221f00c9e96021bb2c5c77
Author: Clemens Ladisch <clemens@ladisch.de>
Date:   Sun Nov 15 22:38:29 2015 +0100

    ALSA: usb-audio: prevent CH345 multiport output SysEx corruption
    
    commit 1ca8b201309d842642f221db7f02f71c0af5be2d upstream.
    
    The CH345 USB MIDI chip has two output ports.  However, they are
    multiplexed through one pin, and the number of ports cannot be reduced
    even for hardware that implements only one connector, so for those
    devices, data sent to either port ends up on the same hardware output.
    This becomes a problem when both ports are used at the same time, as
    longer MIDI commands (such as SysEx messages) are likely to be
    interrupted by messages from the other port, and thus to get lost.
    
    It would not be possible for the driver to detect how many ports the
    device actually has, except that in practice, _all_ devices built with
    the CH345 have only one port.  So we can just ignore the device's
    descriptors, and hardcode one output port.
    
    Signed-off-by: Clemens Ladisch <clemens@ladisch.de>
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d80f8d13f0e961bfa9b3346c1ebe6662f64bd234
Author: Clemens Ladisch <clemens@ladisch.de>
Date:   Sun Nov 15 22:37:44 2015 +0100

    ALSA: usb-audio: add packet size quirk for the Medeli DD305
    
    commit 98d362becb6621bebdda7ed0eac7ad7ec6c37898 upstream.
    
    Signed-off-by: Clemens Ladisch <clemens@ladisch.de>
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fe5bd911e39cba5d74fbbb8cf4dfd54df90afc29
Author: Bjørn Mork <bjorn@mork.no>
Date:   Wed Nov 18 21:12:33 2015 +0100

    USB: option: add XS Stick W100-2 from 4G Systems
    
    commit 638148e20c7f8f6e95017fdc13bce8549a6925e0 upstream.
    
    Thomas reports
    "
    4gsystems sells two total different LTE-surfsticks under the same name.
    ..
    The newer version of XS Stick W100 is from "omega"
    ..
    Under windows the driver switches to the same ID, and uses MI03\6 for
    network and MI01\6 for modem.
    ..
    echo "1c9e 9b01" > /sys/bus/usb/drivers/qmi_wwan/new_id
    echo "1c9e 9b01" > /sys/bus/usb-serial/drivers/option1/new_id
    
    T:  Bus=01 Lev=01 Prnt=01 Port=03 Cnt=01 Dev#=  4 Spd=480 MxCh= 0
    D:  Ver= 2.00 Cls=00(>ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs=  1
    P:  Vendor=1c9e ProdID=9b01 Rev=02.32
    S:  Manufacturer=USB Modem
    S:  Product=USB Modem
    S:  SerialNumber=
    C:  #Ifs= 5 Cfg#= 1 Atr=80 MxPwr=500mA
    I:  If#= 0 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
    I:  If#= 1 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
    I:  If#= 2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
    I:  If#= 3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=qmi_wwan
    I:  If#= 4 Alt= 0 #EPs= 2 Cls=08(stor.) Sub=06 Prot=50 Driver=usb-storage
    
    Now all important things are there:
    
    wwp0s29f7u2i3 (net), ttyUSB2 (at), cdc-wdm0 (qmi), ttyUSB1 (at)
    
    There is also ttyUSB0, but it is not usable, at least not for at.
    
    The device works well with qmi and ModemManager-NetworkManager.
    "
    
    Reported-by: Thomas Schäfer <tschaefer@t-online.de>
    Signed-off-by: Bjørn Mork <bjorn@mork.no>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4a56a92f517dfa44280d688e65e9683117688840
Author: Aleksander Morgado <aleksander@aleksander.es>
Date:   Wed Nov 11 19:51:40 2015 +0100

    USB: serial: option: add support for Novatel MiFi USB620L
    
    commit e07af133c3e2716db25e3e1e1d9f10c2088e9c1a upstream.
    
    Also known as Verizon U620L.
    
    The device is modeswitched from 1410:9020 to 1410:9022 by selecting the
    4th USB configuration:
    
     $ sudo usb_modeswitch –v 0x1410 –p 0x9020 –u 4
    
    This configuration provides a ECM interface as well as TTYs ('Enterprise
    Mode' according to the U620 Linux integration guide).
    
    Signed-off-by: Aleksander Morgado <aleksander@aleksander.es>
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c47ac41f789ff6cb210173dc51eaceb00138286b
Author: David Woodhouse <dwmw2@infradead.org>
Date:   Sat Nov 14 16:49:30 2015 +0000

    USB: ti_usb_3410_5052: Add Honeywell HGI80 ID
    
    commit 1bcb49e663f88bccee35b8688e6a3da2bea31fd4 upstream.
    
    The Honeywell HGI80 is a wireless interface to the evohome connected
    thermostat. It uses a TI 3410 USB-serial port.
    
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3475fbd2f9951267a542ea6a6e43c2527a03233e
Author: Uwe Kleine-König <u.kleine-koenig@pengutronix.de>
Date:   Fri Oct 23 09:53:50 2015 +0200

    usb: musb: core: fix order of arguments to ulpi write callback
    
    commit 705e63d2b29c8bbf091119084544d353bda70393 upstream.
    
    There is a bit of a mess in the order of arguments to the ulpi write
    callback. There is
    
            int ulpi_write(struct ulpi *ulpi, u8 addr, u8 val)
    
    in drivers/usb/common/ulpi.c;
    
            struct usb_phy_io_ops {
                    ...
                    int (*write)(struct usb_phy *x, u32 val, u32 reg);
            }
    
    in include/linux/usb/phy.h.
    
    The callback registered by the musb driver has to comply to the latter,
    but up to now had "offset" first which effectively made the function
    broken for correct users. So flip the order and while at it also
    switch to the parameter names of struct usb_phy_io_ops's write.
    
    Fixes: ffb865b1e460 ("usb: musb: add ulpi access operations")
    Signed-off-by: Uwe Kleine-König <u.kleine-koenig@pengutronix.de>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c5eb38c5d23946f2a139eb4534681f093decdd97
Author: Bjørn Mork <bjorn@mork.no>
Date:   Mon Nov 16 13:15:46 2015 +0100

    USB: qcserial: Fix support for HP lt4112 LTE/HSPA+ Gobi 4G Modem
    
    commit 59536da34513c594af2a6fd35ba65ea45b6960a1 upstream.
    
    The DEVICE_HWI type was added under the faulty assumption that Huawei
    devices based on Qualcomm chipsets and firmware use the static USB
    interface numbering known from Gobi devices.  But this model does
    not apply to Huawei devices like the HP branded lt4112 (Huawei me906e).
    Huawei firmwares will dynamically assign interface numbers. Functions
    are renumbered when the firmware is reconfigured.
    
    Fix by changing the DEVICE_HWI type to use a simplified version
    of Huawei's subclass + protocol scheme: Blacklisting known network
    interface combinations and assuming the rest are serial.
    
    Reported-and-tested-by: Muri Nicanor <muri+libqmi@immerda.ch>
    Tested-by: Martin Hauke <mardnh@gmx.de>
    Fixes: e7181d005e84 ("USB: qcserial: Add support for HP lt4112 LTE/HSPA+ Gobi 4G Modem")
    Signed-off-by: Bjørn Mork <bjorn@mork.no>
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9fe488e4b2b293457a5ab1ac4bcacc15754649b1
Author: Petr Štetiar <ynezz@true.cz>
Date:   Tue Nov 3 11:25:28 2015 +0100

    USB: qcserial: Add support for Quectel EC20 Mini PCIe module
    
    commit 9d5b5ed796d7afd7e8d2ac4b4fb77c6a49463f4b upstream.
    
    It seems like this device has same vendor and product IDs as G2K
    devices, but it has different number of interfaces(4 vs 5) and also
    different interface layout which makes it currently unusable:
    
            usbcore: registered new interface driver qcserial
            usbserial: USB Serial support registered for Qualcomm USB modem
            usb 2-1.2: unknown number of interfaces: 5
    
    lsusb output:
    
            Bus 002 Device 003: ID 05c6:9215 Qualcomm, Inc. Acer Gobi 2000 Wireless
            Device Descriptor:
              bLength                18
              bDescriptorType         1
              bcdUSB               2.00
              bDeviceClass            0 (Defined at Interface level)
              bDeviceSubClass         0
              bDeviceProtocol         0
              bMaxPacketSize0        64
              idVendor           0x05c6 Qualcomm, Inc.
              idProduct          0x9215 Acer Gobi 2000 Wireless Modem
              bcdDevice            2.32
              iManufacturer           1 Quectel
              iProduct                2 Quectel LTE Module
              iSerial                 0
              bNumConfigurations      1
              Configuration Descriptor:
                bLength                 9
                bDescriptorType         2
                wTotalLength          209
                bNumInterfaces          5
                bConfigurationValue     1
                iConfiguration          0
                bmAttributes         0xa0
                  (Bus Powered)
                  Remote Wakeup
                MaxPower              500mA
    
    Signed-off-by: Petr Štetiar <ynezz@true.cz>
    [johan: rename define and add comment ]
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 89d60298ffced3ccda132c24bc1af1cca90b5dcd
Author: Jiri Slaby <jslaby@suse.cz>
Date:   Mon Nov 2 10:27:00 2015 +0100

    usblp: do not set TASK_INTERRUPTIBLE before lock
    
    commit 19cd80a214821f4b558560ebd76bfb2c38b4f3d8 upstream.
    
    It is not permitted to set task state before lock. usblp_wwait sets
    the state to TASK_INTERRUPTIBLE and calls mutex_lock_interruptible.
    Upon return from that function, the state will be TASK_RUNNING again.
    
    This is clearly a bug and a warning is generated with LOCKDEP too:
    WARNING: CPU: 1 PID: 5109 at kernel/sched/core.c:7404 __might_sleep+0x7d/0x90()
    do not call blocking ops when !TASK_RUNNING; state=1 set at [<ffffffffa0c588d0>] usblp_wwait+0xa0/0x310 [usblp]
    Modules linked in: ...
    CPU: 1 PID: 5109 Comm: captmon Tainted: G        W       4.2.5-0.gef2823b-default #1
    Hardware name: LENOVO 23252SG/23252SG, BIOS G2ET33WW (1.13 ) 07/24/2012
     ffffffff81a4edce ffff880236ec7ba8 ffffffff81716651 0000000000000000
     ffff880236ec7bf8 ffff880236ec7be8 ffffffff8106e146 0000000000000282
     ffffffff81a50119 000000000000028b 0000000000000000 ffff8802dab7c508
    Call Trace:
    ...
     [<ffffffff8106e1c6>] warn_slowpath_fmt+0x46/0x50
     [<ffffffff8109a8bd>] __might_sleep+0x7d/0x90
     [<ffffffff8171b20f>] mutex_lock_interruptible_nested+0x2f/0x4b0
     [<ffffffffa0c588fc>] usblp_wwait+0xcc/0x310 [usblp]
     [<ffffffffa0c58bb2>] usblp_write+0x72/0x350 [usblp]
     [<ffffffff8121ed98>] __vfs_write+0x28/0xf0
    ...
    
    Commit 7f477358e2384c54b190cc3b6ce28277050a041b (usblp: Implement the
    ENOSPC convention) moved the set prior locking. So move it back after
    the lock.
    
    Signed-off-by: Jiri Slaby <jslaby@suse.cz>
    Fixes: 7f477358e2 ("usblp: Implement the ENOSPC convention")
    Acked-By: Pete Zaitcev <zaitcev@yahoo.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9ecdc4818391749abc7b83ebca08614d856a9b94
Author: Jonas Gorski <jogo@openwrt.org>
Date:   Sun Aug 23 15:01:08 2015 +0200

    usb: ehci-orion: fix probe for !GENERIC_PHY
    
    commit db1319e166c5e872c4be54eac4e47454133708cf upstream.
    
    Commit d445913ce0ab7f ("usb: ehci-orion: add optional PHY support")
    added support for optional phys, but devm_phy_optional_get returns
    -ENOSYS if GENERIC_PHY is not enabled.
    
    This causes probe failures, even when there are no phys specified:
    
    [    1.443365] orion-ehci f1058000.usb: init f1058000.usb fail, -38
    [    1.449403] orion-ehci: probe of f1058000.usb failed with error -38
    
    Similar to dwc3, treat -ENOSYS as no phy.
    
    Fixes: d445913ce0ab7f ("usb: ehci-orion: add optional PHY support")
    
    Signed-off-by: Jonas Gorski <jogo@openwrt.org>
    Acked-by: Alan Stern <stern@rowland.harvard.edu>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit df493fe1a1d1e3ab2c3248a7fc346e2f9749233e
Author: Jurgen Kramer <gtmkramer@xs4all.nl>
Date:   Mon Nov 9 12:13:55 2015 +0100

    ALSA: usb: Add native DSD support for Aune X1S
    
    commit 16771c7c704769c5f3d70c024630b6e5b3eafa67 upstream.
    
    This patch adds native DSD support for the Aune X1S 32BIT/384 DSD DAC
    
    Signed-off-by: Jurgen Kramer <gtmkramer@xs4all.nl>
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8097eb834e24946b1ba0a4cb5bd76c5b403af247
Author: Peter Chen <peter.chen@freescale.com>
Date:   Wed Sep 16 09:40:51 2015 +0800

    usb: chipidea: imx: refine clock operations to adapt for all platforms
    
    commit ae3e57ae26cdcc85728bb566f999bcb9a7cc6954 upstream.
    
    Some i.mx platforms need three clocks to let controller work, but
    others only need one, refine clock operation to adapt for all
    platforms, it fixes a regression found at i.mx27.
    
    Signed-off-by: Peter Chen <peter.chen@freescale.com>
    Tested-by: Fabio Estevam <fabio.estevam@freescale.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4c9af01573b04c699ae8f062cd3b32bdc3e7b677
Author: John Youn <John.Youn@synopsys.com>
Date:   Fri Oct 2 20:32:17 2015 -0700

    usb: dwc3: pci: Set enblslpm quirk for Synopsys platforms
    
    commit 94218ee31ba56fb3a8625978b393124ad660408e upstream.
    
    Certain Synopsys prototyping PHY boards are not able to meet timings
    constraints for LPM. This allows the PHY to meet those timings by
    leaving the PHY clock running during suspend.
    
    Signed-off-by: John Youn <johnyoun@synopsys.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f685172d2133c74459bbac43fa3156bd283a61de
Author: John Youn <John.Youn@synopsys.com>
Date:   Fri Oct 2 20:30:57 2015 -0700

    usb: dwc3: Add dis_enblslpm_quirk
    
    commit ec791d149bca4511e7d3a6a92bb3b030c5a443f9 upstream.
    
    Add a quirk to clear the GUSB2PHYCFG.ENBLSLPM bit, which controls
    whether the PHY receives the suspend signal from the controller.
    
    Signed-off-by: John Youn <johnyoun@synopsys.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cd6ddebda86fd4c95d8609fe532e2e8716be8827
Author: John Youn <John.Youn@synopsys.com>
Date:   Sat Sep 26 00:11:15 2015 -0700

    usb: dwc3: pci: Add platform data for Synopsys HAPS
    
    commit bb7f3d6d323a56b9c3b3e727380d1395a7f10107 upstream.
    
    Add platform data and set usb3_lpm_capable and has_lpm_erratum.
    
    Signed-off-by: John Youn <johnyoun@synopsys.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d693a54d0d31c7b6b5711e71450cbb3c304f07c1
Author: John Youn <John.Youn@synopsys.com>
Date:   Fri Sep 4 19:15:10 2015 -0700

    usb: dwc3: Support Synopsys USB 3.1 IP
    
    commit 690fb3718a70c66004342f6f5e2e8a5f95b977db upstream.
    
    This patch allows the dwc3 driver to run on the new Synopsys USB 3.1
    IP core, albeit in USB 3.0 mode only.
    
    The Synopsys USB 3.1 IP (DWC_usb31) retains mostly the same register
    interface and programming model as the existing USB 3.0 controller IP
    (DWC_usb3). However the GSNPSID and version numbers are different.
    
    Add checking for the new ID to pass driver probe.
    
    Also, since the DWC_usb31 version number is lower in value than the
    full GSNPSID of the DWC_usb3 IP, we set the high bit to identify
    DWC_usb31 and to ensure the values are higher.
    
    Finally, add a documentation note about the revision numbering scheme.
    Any future revision checks (for STARS, workarounds, and new features)
    should take into consideration how it applies to both the 3.1/3.0 IP.
    
    Signed-off-by: John Youn <johnyoun@synopsys.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 00f91ee765d5c0ed17909bd1855a25aa48f84d51
Author: John Youn <John.Youn@synopsys.com>
Date:   Fri Aug 7 11:47:25 2015 -0700

    usb: dwc3: pci: Add the PCI Product ID for Synopsys USB 3.1
    
    commit e8095a25364a30216ad40dbe8893ed5c3c235949 upstream.
    
    This adds the PCI product ID for the Synopsys USB 3.1 IP core
    (DWC_usb31) on a HAPS-based PCI development platform.
    
    Signed-off-by: John Youn <johnyoun@synopsys.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fc2fdeff34e23ca0d289dd0d41d89ff2c12bb7f0
Author: John Youn <John.Youn@synopsys.com>
Date:   Fri Aug 7 11:04:14 2015 -0700

    usb: dwc3: pci: Add the Synopsys HAPS AXI Product ID
    
    commit 41adc59caece02aa2e988a0e8f9fe8e6f426f82e upstream.
    
    This ID is for the Synopsys DWC_usb3 core with AXI interface on PCIe
    HAPS platform. This core has the debug registers mapped at a separate
    BAR in order to support enhanced hibernation.
    
    Signed-off-by: John Youn <johnyoun@synopsys.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit da14c81586682c2648169a9874895cd26045c67c
Author: Li Jun <B47624@freescale.com>
Date:   Fri Dec 12 09:11:42 2014 +0800

    usb: chipidea: otg: gadget module load and unload support
    
    commit 85da852df66e5e0d3aba761b0fece7c958ff0685 upstream.
    
    This patch is to support load and unload gadget driver in full OTG mode.
    
    Signed-off-by: Li Jun <jun.li@freescale.com>
    Signed-off-by: Peter Chen <peter.chen@freescale.com>
    Tested-by: Jiada Wang <jiada_wang@mentor.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ae3bb766f618041ccd882607cb6237a51d63f0ed
Author: Ben McCauley <ben.mccauley@garmin.com>
Date:   Mon Nov 16 10:47:24 2015 -0600

    usb: dwc3: gadget: let us set lower max_speed
    
    commit b9e51b2b1fda19143f48d182ed7a2943f21e1ae4 upstream.
    
    In some SoCs, dwc3 is implemented as a USB2.0 only
    core, meaning that it can't ever achieve SuperSpeed.
    
    Currect driver always sets gadget.max_speed to
    USB_SPEED_SUPER unconditionally. This can causes
    issues to some Host stacks where the host will issue
    a GetBOS() request and we will reply with a BOS
    containing Superspeed Capability Descriptor.
    
    At least Windows seems to be upset by this fact and
    prints a warning that we should connect $this device
    to another port.
    
    [ balbi@ti.com : rewrote entire commit, including
    source code comment to make a lot clearer what the
    problem is ]
    
    Signed-off-by: Ben McCauley <ben.mccauley@garmin.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b380e1570a80c9f87aaab4201426859816380706
Author: Douglas Gilbert <dgilbert@interlog.com>
Date:   Mon Nov 16 19:22:08 2015 +0100

    usb: gadget: atmel_usba_udc: Expose correct device speed
    
    commit d134c48d889ddceadf4c990e6f3df16b816ed5d4 upstream.
    
    Following changes that appeared in lk 4.0.0, the gadget udc driver for
    some ARM based Atmel SoCs (e.g. at91sam9x5 and sama5d3 families)
    incorrectly deduced full-speed USB link speed even when the hardware
    had negotiated a high-speed link. The fix is to make sure that the
    UDPHS Interrupt Enable Register value does not mask the SPEED bit
    in the Interrupt Status Register.
    
    For a mass storage gadget this problem lead to failures when the host
    had a USB 3 port with the xhci_hcd driver. If the host was a USB 2
    port using the ehci_hcd driver then the mass storage gadget worked
    (but probably at a lower speed than it should have).
    
    Signed-off-by: Douglas Gilbert <dgilbert@interlog.com>
    Reviewed-by: Boris Brezillon <boris.brezillon@free-electrons.com>
    Fixes: 9870d895ad87 ("usb: atmel_usba_udc: Mask status with enabled irqs")
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e3c606d2d0fad088b0c1fd191a9c161a5e48a39a
Author: Mian Yousaf Kaukab <yousaf.kaukab@intel.com>
Date:   Mon Oct 19 16:25:15 2015 +0200

    usb: gadget: net2280: restore ep_cfg after defect7374 workaround
    
    commit 81e9d14a53eb1abfbe6ac828a87a2deb4702b5f1 upstream.
    
    Defect 7374 workaround enables all GPEP as endpoint 0. Restore
    endpoint number when defect 7374 workaround is disabled. Otherwise,
    check to match USB endpoint number to hardware endpoint number in
    net2280_enable() fails.
    
    Reported-by: Paul Jones <p.jones@teclyn.com>
    Signed-off-by: Mian Yousaf Kaukab <yousaf.kaukab@intel.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 05d7797e1791df0b426d69c8526fea4d10af0b34
Author: Ville Syrjälä <ville.syrjala@linux.intel.com>
Date:   Mon Aug 31 19:48:28 2015 +0300

    Revert "usb: dwc3: gadget: drop unnecessary loop when cleaning up TRBs"
    
    commit d115d7050a0d2c4967532f18c9cb522fea6b7280 upstream.
    
    This reverts commit 8f2c9544aba636134303105ecb164190a39dece4.
    
    As it breaks g_ether on my Baytrail FFRD8 device. Everything starts out
    fine, but after a bit of data has been transferred it just stops
    flowing.
    
    Note that I do get a bunch of these "NOHZ: local_softirq_pending 08"
    when booting the machine, but I'm not really sure if they're related
    to this problem.
    
    Cc: Felipe Balbi <balbi@ti.com>
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Cc: linux-usb@vger.kernel.org
    Cc: stable@vger.kernel.org
    Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
    Signed-off-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c330c755997a2c338d9ac615655a1af0438521ed
Author: David Hildenbrand <dahi@linux.vnet.ibm.com>
Date:   Thu Nov 5 09:38:15 2015 +0100

    KVM: s390: avoid memory overwrites on emergency signal injection
    
    commit b85de33a1a3433487b6a721cfdce25ec8673e622 upstream.
    
    Commit 383d0b050106 ("KVM: s390: handle pending local interrupts via
    bitmap") introduced a possible memory overwrite from user space.
    
    User space could pass an invalid emergency signal code (sending VCPU)
    and therefore exceed the bitmap. Let's take care of this case and
    check that the id is in the valid range.
    
    Reviewed-by: Dominik Dingel <dingel@linux.vnet.ibm.com>
    Signed-off-by: David Hildenbrand <dahi@linux.vnet.ibm.com>
    Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ff3a0bb1f60713fd03ec8aa8e1a7f33402caf997
Author: David Hildenbrand <dahi@linux.vnet.ibm.com>
Date:   Thu Nov 5 09:06:06 2015 +0100

    KVM: s390: fix wrong lookup of VCPUs by array index
    
    commit 152e9f65d66f0a3891efc3869440becc0e7ff53f upstream.
    
    For now, VCPUs were always created sequentially with incrementing
    VCPU ids. Therefore, the index in the VCPUs array matched the id.
    
    As sequential creation might change with cpu hotplug, let's use
    the correct lookup function to find a VCPU by id, not array index.
    
    Let's also use kvm_lookup_vcpu() for validation of the sending VCPU
    on external call injection.
    
    Reviewed-by: Christian Borntraeger <borntraeger@de.ibm.com>
    Signed-off-by: David Hildenbrand <dahi@linux.vnet.ibm.com>
    Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3b2f017088af3c82901c88a4718a69ea2b7272d2
Author: David Hildenbrand <dahi@linux.vnet.ibm.com>
Date:   Thu Nov 5 09:03:50 2015 +0100

    KVM: Provide function for VCPU lookup by id
    
    commit db27a7a37aa0b1f8b373f8b0fb72a2ccaafb85b7 upstream.
    
    Let's provide a function to lookup a VCPU by id.
    
    Reviewed-by: Christian Borntraeger <borntraeger@de.ibm.com>
    Reviewed-by: Dominik Dingel <dingel@linux.vnet.ibm.com>
    Signed-off-by: David Hildenbrand <dahi@linux.vnet.ibm.com>
    Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
    [split patch from refactoring patch]
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8003ebad9780e21a3b89f62876fb341890adf2f7
Author: David Hildenbrand <dahi@linux.vnet.ibm.com>
Date:   Mon Oct 26 08:41:29 2015 +0100

    KVM: s390: SCA must not cross page boundaries
    
    commit c5c2c393468576bad6d10b2b5fefff8cd25df3f4 upstream.
    
    We seemed to have missed a few corner cases in commit f6c137ff00a4
    ("KVM: s390: randomize sca address").
    
    The SCA has a maximum size of 2112 bytes. By setting the sca_offset to
    some unlucky numbers, we exceed the page.
    
    0x7c0 (1984) -> Fits exactly
    0x7d0 (2000) -> 16 bytes out
    0x7e0 (2016) -> 32 bytes out
    0x7f0 (2032) -> 48 bytes out
    
    One VCPU entry is 32 bytes long.
    
    For the last two cases, we actually write data to the other page.
    1. The address of the VCPU.
    2. Injection/delivery/clearing of SIGP externall calls via SIGP IF.
    
    Especially the 2. happens regularly. So this could produce two problems:
    1. The guest losing/getting external calls.
    2. Random memory overwrites in the host.
    
    So this problem happens on every 127 + 128 created VM with 64 VCPUs.
    
    Acked-by: Christian Borntraeger <borntraeger@de.ibm.com>
    Signed-off-by: David Hildenbrand <dahi@linux.vnet.ibm.com>
    Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fb4e563b399e9b1ddca1e4ccdbd2947d51fe780d
Author: Rajkumar Manoharan <rmanohar@qti.qualcomm.com>
Date:   Tue Nov 3 11:51:33 2015 +0530

    ath10k: fix invalid NSS for 4x4 devices
    
    commit f680f70adbeab28b35f849016b964dd645db6237 upstream.
    
    The number of spatial streams that are derived from chain mask
    for 4x4 devices is using wrong bitmask and conditional check.
    This is affecting downlink throughput for QCA99x0 devices. Earlier
    cfg_tx_chainmask is not filled by default until user configured it
    and so get_nss_from_chainmask never be called. This issue is exposed
    by recent commit 166de3f1895d ("ath10k: remove supported chain mask").
    By default maximum supported chain mask is filled in cfg_tx_chainmask.
    
    Fixes: 5572a95b4b ("ath10k: apply chainmask settings to vdev on creation")
    Signed-off-by: Rajkumar Manoharan <rmanohar@qti.qualcomm.com>
    Signed-off-by: Kalle Valo <kvalo@qca.qualcomm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 37b435d84af64b9fa7118dceb9d8911d0759f588
Author: Vivek Natarajan <nataraja@qti.qualcomm.com>
Date:   Tue Oct 6 15:19:34 2015 +0300

    ath10k: use station's current operating mode from assoc request
    
    commit 72f8cef5d1155209561b01e092ce1a04ad50c4cb upstream.
    
    The current number of spatial streams used by the client is advertised
    as a separate IE in assoc request. Use this information to set
    the NSS operating mode.
    
    Fixes: 45c9abc059fa ("ath10k: implement more versatile set_bitrate_mask").
    Signed-off-by: Vivek Natarajan <nataraja@qti.qualcomm.com>
    Signed-off-by: Kalle Valo <kvalo@qca.qualcomm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d990487a527a347c078bb983500ef8a4bbaa06b8
Author: Mark Rutland <mark.rutland@arm.com>
Date:   Mon Oct 26 21:42:33 2015 +0000

    arm64: page-align sections for DEBUG_RODATA
    
    commit cb083816ab5ac3d10a9417527f07fc5962cc3808 upstream.
    
    A kernel built with DEBUG_RO_DATA && !CONFIG_DEBUG_ALIGN_RODATA doesn't
    have .text aligned to a page boundary, though fixup_executable works at
    page-granularity thanks to its use of create_mapping. If .text is not
    page-aligned, the first page it exists in may be marked non-executable,
    leading to failures when an attempt is made to execute code in said
    page.
    
    This patch upgrades ALIGN_DEBUG_RO and ALIGN_DEBUG_RO_MIN to force page
    alignment for DEBUG_RO_DATA && !CONFIG_DEBUG_ALIGN_RODATA kernels,
    ensuring that all sections with specific RWX permission requirements are
    mapped with the correct permissions.
    
    Signed-off-by: Mark Rutland <mark.rutland@arm.com>
    Reported-by: Jeremy Linton <jeremy.linton@arm.com>
    Reviewed-by: Laura Abbott <laura@labbott.name>
    Acked-by: Ard Biesheuvel <ard.biesheuvel@linaro.org>
    Cc: Suzuki Poulose <suzuki.poulose@arm.com>
    Cc: Will Deacon <will.deacon@arm.com>
    Fixes: da141706aea52c1a ("arm64: add better page protections to arm64")
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d005a5d9ddd873b36310096d8b88147f0fad5a3c
Author: Robin Murphy <robin.murphy@arm.com>
Date:   Thu Oct 22 15:41:52 2015 +0100

    arm64: Fix compat register mappings
    
    commit 5accd17d0eb523350c9ef754d655e379c9bb93b3 upstream.
    
    For reasons not entirely apparent, but now enshrined in history, the
    architectural mapping of AArch32 banked registers to AArch64 registers
    actually orders SP_<mode> and LR_<mode> backwards compared to the
    intuitive r13/r14 order, for all modes except FIQ.
    
    Fix the compat_<reg>_<mode> macros accordingly, in the hope of avoiding
    subtle bugs with KVM and AArch32 guests.
    
    Signed-off-by: Robin Murphy <robin.murphy@arm.com>
    Acked-by: Will Deacon <will.deacon@arm.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d79ee50a08a6b28374b8809ecbd87a09211f2687
Author: Mirza Krak <mirza.krak@hostmobility.com>
Date:   Tue Nov 10 14:59:34 2015 +0100

    can: sja1000: clear interrupts on start
    
    commit 7cecd9ab80f43972c056dc068338f7bcc407b71c upstream.
    
    According to SJA1000 data sheet error-warning (EI) interrupt is not
    cleared by setting the controller in to reset-mode.
    
    Then if we have the following case:
    - system is suspended (echo mem > /sys/power/state) and SJA1000 is left
      in operating state
    - A bus error condition occurs which activates EI interrupt, system is
      still suspended which means EI interrupt will be not be handled nor
      cleared.
    
    If the above two events occur, on resume there is no way to return the
    SJA1000 to operating state, except to cycle power to it.
    
    By simply reading the IR register on start we will clear any previous
    conditions that could be present.
    
    Signed-off-by: Mirza Krak <mirza.krak@hostmobility.com>
    Reported-by: Christian Magnusson <Christian.Magnusson@semcon.com>
    Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 50dd6983ed39ab512c5bacd8daa7917e6b7c75a4
Author: Marek Vasut <marex@denx.de>
Date:   Fri Oct 30 13:48:19 2015 +0100

    can: Use correct type in sizeof() in nla_put()
    
    commit 562b103a21974c2f9cd67514d110f918bb3e1796 upstream.
    
    The sizeof() is invoked on an incorrect variable, likely due to some
    copy-paste error, and this might result in memory corruption. Fix this.
    
    Signed-off-by: Marek Vasut <marex@denx.de>
    Cc: Wolfgang Grandegger <wg@grandegger.com>
    Cc: netdev@vger.kernel.org
    Signed-off-by: Marc Kleine-Budde <mkl@pengutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 178379ec9677c883c475e74b671faec23b539171
Author: Johan Hedberg <johan.hedberg@intel.com>
Date:   Mon Oct 19 10:51:47 2015 +0300

    Bluetooth: Fix removing connection parameters when unpairing
    
    commit a6ad2a6b9cc1d9d791aee5462cfb8528f366f1d4 upstream.
    
    The commit 89cbb0638e9b7 introduced support for deferred connection
    parameter removal when unpairing by removing them only once an
    existing connection gets disconnected. However, it failed to address
    the scenario when we're *not* connected and do an unpair operation.
    
    What makes things worse is that most user space BlueZ versions will
    first issue a disconnect request and only then unpair, meaning the
    buggy code will be triggered every time. This effectively causes the
    kernel to resume scanning and reconnect to a device for which we've
    removed all keys and GATT database information.
    
    This patch fixes the issue by adding the missing call to the
    hci_conn_params_del() function to a branch which handles the case of
    no existing connection.
    
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 070f6f091509e65ea742f3ddf1c2f8063c30d7f1
Author: Dmitry Tunin <hanipouspilot@gmail.com>
Date:   Fri Oct 16 11:45:26 2015 +0300

    Bluetooth: ath3k: Add support of AR3012 0cf3:817b device
    
    commit 18e0afab8ce3f1230ce3fef52b2e73374fd9c0e7 upstream.
    
    T: Bus=04 Lev=02 Prnt=02 Port=04 Cnt=01 Dev#= 3 Spd=12 MxCh= 0
    D: Ver= 1.10 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
    P: Vendor=0cf3 ProdID=817b Rev=00.02
    C: #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
    I: If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    I: If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    
    BugLink: https://bugs.launchpad.net/bugs/1506615
    
    Signed-off-by: Dmitry Tunin <hanipouspilot@gmail.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 24fda04224c379e38b17f9598ba17c7a8736fe82
Author: Dmitry Tunin <hanipouspilot@gmail.com>
Date:   Mon Oct 5 19:29:33 2015 +0300

    Bluetooth: ath3k: Add new AR3012 0930:021c id
    
    commit cd355ff071cd37e7197eccf9216770b2b29369f7 upstream.
    
    This adapter works with the existing linux-firmware.
    
    T:  Bus=01 Lev=01 Prnt=01 Port=03 Cnt=02 Dev#=  3 Spd=12  MxCh= 0
    D:  Ver= 1.10 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
    P:  Vendor=0930 ProdID=021c Rev=00.01
    C:  #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
    I:  If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    I:  If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    
    BugLink: https://bugs.launchpad.net/bugs/1502781
    
    Signed-off-by: Dmitry Tunin <hanipouspilot@gmail.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 063c2b25bfb142fd852b65bf6b558838429efbe0
Author: David Herrmann <dh.herrmann@gmail.com>
Date:   Mon Sep 7 12:05:41 2015 +0200

    Bluetooth: hidp: fix device disconnect on idle timeout
    
    commit 660f0fc07d21114549c1862e67e78b1cf0c90c29 upstream.
    
    The HIDP specs define an idle-timeout which automatically disconnects a
    device. This has always been implemented in the HIDP layer and forced a
    synchronous shutdown of the hidp-scheduler. This works just fine, but
    lacks a forced disconnect on the underlying l2cap channels. This has been
    broken since:
    
        commit 5205185d461d5902325e457ca80bd421127b7308
        Author: David Herrmann <dh.herrmann@gmail.com>
        Date:   Sat Apr 6 20:28:47 2013 +0200
    
            Bluetooth: hidp: remove old session-management
    
    The old session-management always forced an l2cap error on the ctrl/intr
    channels when shutting down. The new session-management skips this, as we
    don't want to enforce channel policy on the caller. In other words, if
    user-space removes an HIDP device, the underlying channels (which are
    *owned* and *referenced* by user-space) are still left active. User-space
    needs to call shutdown(2) or close(2) to release them.
    
    Unfortunately, this does not work with idle-timeouts. There is no way to
    signal user-space that the HIDP layer has been stopped. The API simply
    does not support any event-passing except for poll(2). Hence, we restore
    old behavior and force EUNATCH on the sockets if the HIDP layer is
    disconnected due to idle-timeouts (behavior of explicit disconnects
    remains unmodified). User-space can still call
    
        getsockopt(..., SO_ERROR, ...)
    
    ..to retrieve the EUNATCH error and clear sk_err. Hence, the channels can
    still be re-used (which nobody does so far, though). Therefore, the API
    still supports the new behavior, but with this patch it's also compatible
    to the old implicit channel shutdown.
    
    Reported-by: Mark Haun <haunma@keteu.org>
    Reported-by: Luiz Augusto von Dentz <luiz.dentz@gmail.com>
    Signed-off-by: David Herrmann <dh.herrmann@gmail.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7efb46b112c09e39033dacfcbb0711beecf4a2d6
Author: Larry Finger <Larry.Finger@lwfinger.net>
Date:   Sun Oct 18 22:14:48 2015 -0500

    staging: rtl8712: Add device ID for Sitecom WLA2100
    
    commit 1e6e63283691a2a9048a35d9c6c59cf0abd342e4 upstream.
    
    This adds the USB ID for the Sitecom WLA2100. The Windows 10 inf file
    was checked to verify that the addition is correct.
    
    Reported-by: Frans van de Wiel <fvdw@fvdw.eu>
    Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
    Cc: Frans van de Wiel <fvdw@fvdw.eu>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 30a413dfbc3566596999c196b73eed2ef23f9d05
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Mon Sep 21 19:19:53 2015 +0300

    mwifiex: fix mwifiex_rdeeprom_read()
    
    commit 1f9c6e1bc1ba5f8a10fcd6e99d170954d7c6d382 upstream.
    
    There were several bugs here.
    
    1)  The done label was in the wrong place so we didn't copy any
        information out when there was no command given.
    
    2)  We were using PAGE_SIZE as the size of the buffer instead of
        "PAGE_SIZE - pos".
    
    3)  snprintf() returns the number of characters that would have been
        printed if there were enough space.  If there was not enough space
        (and we had fixed the memory corruption bug #2) then it would result
        in an information leak when we do simple_read_from_buffer().  I've
        changed it to use scnprintf() instead.
    
    I also removed the initialization at the start of the function, because
    I thought it made the code a little more clear.
    
    Fixes: 5e6e3a92b9a4 ('wireless: mwifiex: initial commit for Marvell mwifiex driver')
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Acked-by: Amitkumar Karwar <akarwar@marvell.com>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 25de0b9a1b655f8b5da115dff349ba5472f295aa
Author: Tony Lindgren <tony@atomide.com>
Date:   Fri Sep 18 09:29:04 2015 -0700

    mfd: twl6040: Fix deferred probe handling for clk32k
    
    commit 75c08f17ec87c2d742487bb87408d6feebc526bd upstream.
    
    Commit 68bab8662f49 ("mfd: twl6040: Optional clk32k clock handling")
    added clock handling for the 32k clock from palmas-clk. However, that
    patch did not consider a typical situation where twl6040 is built-in,
    and palmas-clk is a loadable module like we have in omap2plus_defconfig.
    
    If palmas-clk is not loaded before twl6040 probes, we will get a
    "clk32k is not handled" warning during booting. This means that any
    drivers relying on this clock will mysteriously fail, including
    omap5-uevm WLAN and audio.
    
    Note that for WLAN, we probably should also eventually get
    the clk32kgaudio for MMC3 directly as that's shared between
    audio and WLAN SDIO at least for omap5-uevm. It seems the
    WLAN chip cannot get it as otherwise MMC3 won't get properly
    probed.
    
    Fixes: 68bab8662f49 ("mfd: twl6040: Optional clk32k clock handling")
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Reviewed-by: Felipe Balbi <balbi@ti.com>
    Signed-off-by: Lee Jones <lee.jones@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 56f786658585820d8572757cda5e571cd257bbbd
Author: Linus Walleij <linus.walleij@linaro.org>
Date:   Fri Oct 23 11:36:01 2015 +0200

    clk: versatile-icst: fix memory leak
    
    commit 7bdccef34fc67d3fce6778a018601dd41e43c5ce upstream.
    
    A static code checker found a memory leak in the Versatile
    ICST code. Fix it.
    
    Fixes: a183da637c52 "clk: versatile: respect parent rate in ICST clock"
    Reported-by: Stephen Boyd <sboyd@codeaurora.org>
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
    Signed-off-by: Stephen Boyd <sboyd@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5e5ed96b6766aca3bab1972ee2602b96fa335c05
Author: Simran Rai <ssimran@broadcom.com>
Date:   Mon Oct 19 15:27:19 2015 -0700

    clk: iproc: Fix PLL output frequency calculation
    
    commit 63243a4da7d0dfa19dcacd0a529782eeb2f86f92 upstream.
    
    This patch affects the clocks that use fractional ndivider in their
    PLL output frequency calculation. Instead of 2^20 divide factor, the
    clock's ndiv integer shift was used. Fixed the bug by replacing ndiv
    integer shift with 2^20 factor.
    
    Signed-off-by: Simran Rai <ssimran@broadcom.com>
    Signed-off-by: Ray Jui <rjui@broadcom.com>
    Reviewed-by: Scott Branden <sbranden@broadcom.com>
    Fixes: 5fe225c105fd ("clk: iproc: add initial common clock support")
    Signed-off-by: Michael Turquette <mturquette@baylibre.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8d7bdea211088ea3221a09563447ea3a19b82c41
Author: Ingo Molnar <mingo@kernel.org>
Date:   Wed Sep 30 15:59:17 2015 +0200

    fs/proc, core/debug: Don't expose absolute kernel addresses via wchan
    
    commit b2f73922d119686323f14fbbe46587f863852328 upstream.
    
    So the /proc/PID/stat 'wchan' field (the 30th field, which contains
    the absolute kernel address of the kernel function a task is blocked in)
    leaks absolute kernel addresses to unprivileged user-space:
    
            seq_put_decimal_ull(m, ' ', wchan);
    
    The absolute address might also leak via /proc/PID/wchan as well, if
    KALLSYMS is turned off or if the symbol lookup fails for some reason:
    
    static int proc_pid_wchan(struct seq_file *m, struct pid_namespace *ns,
                              struct pid *pid, struct task_struct *task)
    {
            unsigned long wchan;
            char symname[KSYM_NAME_LEN];
    
            wchan = get_wchan(task);
    
            if (lookup_symbol_name(wchan, symname) < 0) {
                    if (!ptrace_may_access(task, PTRACE_MODE_READ))
                            return 0;
                    seq_printf(m, "%lu", wchan);
            } else {
                    seq_printf(m, "%s", symname);
            }
    
            return 0;
    }
    
    This isn't ideal, because for example it trivially leaks the KASLR offset
    to any local attacker:
    
      fomalhaut:~> printf "%016lx\n" $(cat /proc/$$/stat | cut -d' ' -f35)
      ffffffff8123b380
    
    Most real-life uses of wchan are symbolic:
    
      ps -eo pid:10,tid:10,wchan:30,comm
    
    and procps uses /proc/PID/wchan, not the absolute address in /proc/PID/stat:
    
      triton:~/tip> strace -f ps -eo pid:10,tid:10,wchan:30,comm 2>&1 | grep wchan | tail -1
      open("/proc/30833/wchan", O_RDONLY)     = 6
    
    There's one compatibility quirk here: procps relies on whether the
    absolute value is non-zero - and we can provide that functionality
    by outputing "0" or "1" depending on whether the task is blocked
    (whether there's a wchan address).
    
    These days there appears to be very little legitimate reason
    user-space would be interested in  the absolute address. The
    absolute address is mostly historic: from the days when we
    didn't have kallsyms and user-space procps had to do the
    decoding itself via the System.map.
    
    So this patch sets all numeric output to "0" or "1" and keeps only
    symbolic output, in /proc/PID/wchan.
    
    ( The absolute sleep address can generally still be profiled via
      perf, by tasks with sufficient privileges. )
    
    Reviewed-by: Thomas Gleixner <tglx@linutronix.de>
    Acked-by: Kees Cook <keescook@chromium.org>
    Acked-by: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Al Viro <viro@zeniv.linux.org.uk>
    Cc: Alexander Potapenko <glider@google.com>
    Cc: Andrey Konovalov <andreyknvl@google.com>
    Cc: Andrey Ryabinin <ryabinin.a.a@gmail.com>
    Cc: Andy Lutomirski <luto@amacapital.net>
    Cc: Andy Lutomirski <luto@kernel.org>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: Denys Vlasenko <dvlasenk@redhat.com>
    Cc: Dmitry Vyukov <dvyukov@google.com>
    Cc: Kostya Serebryany <kcc@google.com>
    Cc: Mike Galbraith <efault@gmx.de>
    Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Sasha Levin <sasha.levin@oracle.com>
    Cc: kasan-dev <kasan-dev@googlegroups.com>
    Cc: linux-kernel@vger.kernel.org
    Link: http://lkml.kernel.org/r/20150930135917.GA3285@gmail.com
    Signed-off-by: Ingo Molnar <mingo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7f298382b9174e32fbb9e79e1fe6a218cefb92d3
Author: Marcin Wojtas <mw@semihalf.com>
Date:   Mon Nov 30 13:27:44 2015 +0100

    net: mvneta: fix error path for building skb
    
    commit 26c17a179f3f64f92de6e837c14279a6431a7ab6 upstream.
    
    In the actual RX processing, there is same error path for both descriptor
    ring refilling and building skb fails. This is not correct, because after
    successful refill, the ring is already updated with newly allocated
    buffer. Then, in case of build_skb() fail, hitherto code left the original
    buffer unmapped.
    
    This patch fixes above situation by swapping error check of skb build with
    DMA-unmap of original buffer.
    
    Signed-off-by: Marcin Wojtas <mw@semihalf.com>
    Acked-by: Simon Guinot <simon.guinot@sequanux.org>
    Fixes a84e32894191 ("net: mvneta: fix refilling for Rx DMA buffers")
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6de57dd089318444194f9119956e46405c48026d
Author: Maxime Ripard <mripard@kernel.org>
Date:   Fri Sep 25 18:09:35 2015 +0200

    net: mvneta: Fix CPU_MAP registers initialisation
    
    commit 2502d0ef272da7058ef303b849a2c8dc324c2e2e upstream.
    
    The CPU_MAP register is duplicated for each CPUs at different addresses,
    each instance being at a different address.
    
    However, the code so far was using CONFIG_NR_CPUS to initialise the CPU_MAP
    registers for each registers, while the SoCs embed at most 4 CPUs.
    
    This is especially an issue with multi_v7_defconfig, where CONFIG_NR_CPUS
    is currently set to 16, resulting in writes to registers that are not
    CPU_MAP.
    
    Fixes: c5aff18204da ("net: mvneta: driver for Marvell Armada 370/XP network unit")
    Signed-off-by: Maxime Ripard <maxime.ripard@free-electrons.com>
    Signed-off-by: Gregory CLEMENT <gregory.clement@free-electrons.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0efc792a078222c05eceeaaba5f79fd0412311b9
Author: Oren Givon <oren.givon@intel.com>
Date:   Wed Oct 28 12:32:20 2015 +0200

    iwlwifi: Add new PCI IDs for the 8260 series
    
    commit 4ab75944c4b324c1f5f01dbd4c4d122d2b9da187 upstream.
    
    Add some new PCI IDs for the 8260 series which were missing.
    The following sub-system IDs were added:
    0x0130, 0x1130, 0x0132, 0x1132, 0x1150, 0x8110, 0x9110, 0x8130,
    0x9130, 0x8132, 0x9132, 0x8150, 0x9150, 0x0044, 0x0930
    
    Signed-off-by: Oren Givon <oren.givon@intel.com>
    Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4d8e3ed9204298a446190513c95b32b5dc0a809f
Author: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
Date:   Wed Oct 21 19:55:32 2015 +0300

    iwlwifi: pcie: fix (again) prepare card flow
    
    commit 03a19cbb91994212be72ce15ac3406fa9f8ba079 upstream.
    
    The hardware bug in the commit mentioned below forces us
    not to re-enable the clock gating in the Host Cluster.
    The impact on the power consumption is minimal and it allows
    the WAKE_ME interrupt to propagate.
    
    Fixes: c9fdec9f3970 ("iwlwifi: pcie: fix prepare card flow")
    Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 05f374f2583f0038bdf6c3bd89acd336b806655d
Author: Christophe Ricard <christophe.ricard@gmail.com>
Date:   Sun Oct 25 22:54:22 2015 +0100

    NFC: nci: extract pipe value using NCI_HCP_MSG_GET_PIPE
    
    commit e65917b6d54f8b47d8293ea96adfa604fd46cf0d upstream.
    
    When receiving data in nci_hci_msg_rx_work, extract pipe
    value using NCI_HCP_MSG_GET_PIPE macro.
    
    Signed-off-by: Christophe Ricard <christophe-h.ricard@st.com>
    Signed-off-by: Samuel Ortiz <sameo@linux.intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 58a531a3b13a8501660377b33f82c34c4e18c3e7
Author: Christophe Ricard <christophe.ricard@gmail.com>
Date:   Sun Oct 25 22:54:21 2015 +0100

    NFC: nci: Fix improper management of HCI return code
    
    commit d8cd37ed2fc871c66b4c79c59f651dc2cdf7091c upstream.
    
    When sending HCI data over NCI, HCI return code is part
    of the NCI data. In order to get correctly the HCI return
    code, we assume the NCI communication is successful and
    extract the return code for the nci_hci functions return code.
    
    This is done because nci_to_errno does not match hci return
    code value.
    
    Signed-off-by: Christophe Ricard <christophe-h.ricard@st.com>
    Signed-off-by: Samuel Ortiz <sameo@linux.intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 12cd7a677da483ee9d7e0d97b8fd608753e9a281
Author: Christophe Ricard <christophe.ricard@gmail.com>
Date:   Sun Oct 25 22:54:20 2015 +0100

    NFC: nci: Fix incorrect data chaining when sending data
    
    commit 500c4ef02277eaadbfe20537f963b6221f6ac007 upstream.
    
    When sending HCI data over NCI, cmd information should be
    present only on the first packet.
    Each packet shall be specifically allocated and sent to the
    NCI layer.
    
    Signed-off-by: Christophe Ricard <christophe-h.ricard@st.com>
    Signed-off-by: Samuel Ortiz <sameo@linux.intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3d7594d9d9d18b712fa1542634cc5b78ee68ae7c
Author: Ola Olsson <ola1olsson@gmail.com>
Date:   Thu Oct 29 07:04:58 2015 +0100

    nl80211: Fix potential memory leak from parse_acl_data
    
    commit 4baf6bea37247e59f1971e8009d13aeda95edba2 upstream.
    
    If parse_acl_data succeeds but the subsequent parsing of smps
    attributes fails, there will be a memory leak due to early returns.
    Fix that by moving the ACL parsing later.
    
    Fixes: 18998c381b19b ("cfg80211: allow requesting SMPS mode on ap start")
    Signed-off-by: Ola Olsson <ola.olsson@sonymobile.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ac0912b41e13d6db2a443f7f4bd0d94572ef6c25
Author: Janusz.Dziedzic@tieto.com <Janusz.Dziedzic@tieto.com>
Date:   Tue Oct 27 08:35:11 2015 +0100

    mac80211: fix divide by zero when NOA update
    
    commit 519ee6918b91abdc4bc9720deae17599a109eb40 upstream.
    
    In case of one shot NOA the interval can be 0, catch that
    instead of potentially (depending on the driver) crashing
    like this:
    
    divide error: 0000 [#1] SMP
    [...]
    Call Trace:
    <IRQ>
    [<ffffffffc08e891c>] ieee80211_extend_absent_time+0x6c/0xb0 [mac80211]
    [<ffffffffc08e8a17>] ieee80211_update_p2p_noa+0xb7/0xe0 [mac80211]
    [<ffffffffc069cc30>] ath9k_p2p_ps_timer+0x170/0x190 [ath9k]
    [<ffffffffc070adf8>] ath_gen_timer_isr+0xc8/0xf0 [ath9k_hw]
    [<ffffffffc0691156>] ath9k_tasklet+0x296/0x2f0 [ath9k]
    [<ffffffff8107ad65>] tasklet_action+0xe5/0xf0
    [...]
    
    Signed-off-by: Janusz Dziedzic <janusz.dziedzic@tieto.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit edbabb74cd8a7091f1146fee35194a4f9115cee3
Author: Arik Nemtsov <arik@wizery.com>
Date:   Sun Oct 25 10:59:41 2015 +0200

    mac80211: allow null chandef in tracing
    
    commit 254d3dfe445f94a764e399ca12e04365ac9413ed upstream.
    
    In TDLS channel-switch operations the chandef can sometimes be NULL.
    Avoid an oops in the trace code for these cases and just print a
    chandef full of zeros.
    
    Fixes: a7a6bdd0670fe ("mac80211: introduce TDLS channel switch ops")
    Signed-off-by: Arik Nemtsov <arikx.nemtsov@intel.com>
    Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 48fc63733afc9681cf193d967628ba8b579b8d1a
Author: Johannes Berg <johannes.berg@intel.com>
Date:   Fri Aug 28 10:52:53 2015 +0200

    mac80211: fix driver RSSI event calculations
    
    commit 8ec6d97871f37e4743678ea4a455bd59580aa0f4 upstream.
    
    The ifmgd->ave_beacon_signal value cannot be taken as is for
    comparisons, it must be divided by since it's represented
    like that for better accuracy of the EWMA calculations. This
    would lead to invalid driver RSSI events. Fix the used value.
    
    Fixes: 615f7b9bb1f8 ("mac80211: add driver RSSI threshold events")
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0961f1c3deb40f21d95ff52711a0e340b2c8daf7
Author: Andrei Otcheretianski <andrei.otcheretianski@intel.com>
Date:   Sun Oct 25 10:59:38 2015 +0200

    mac80211: Fix local deauth while associating
    
    commit a64cba3c5330704a034bd3179270b8d04daf6987 upstream.
    
    Local request to deauthenticate wasn't handled while associating, thus
    the association could continue even when the user space required to
    disconnect.
    
    Signed-off-by: Andrei Otcheretianski <andrei.otcheretianski@intel.com>
    Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0e759edec31ed666a45fa66314896a40e5669f5c
Author: Dave Hansen <dave.hansen@linux.intel.com>
Date:   Wed Nov 11 10:19:34 2015 -0800

    x86/mpx: Fix 32-bit address space calculation
    
    commit f3119b830264d89d216bfb378ab65065dffa02d9 upstream.
    
    I received a bug report that running 32-bit MPX binaries on
    64-bit kernels was broken.  I traced it down to this little code
    snippet.  We were switching our "number of bounds directory
    entries" calculation correctly.  But, we didn't switch the other
    side of the calculation: the virtual space size.
    
    This meant that we were calculating an absurd size for
    bd_entry_virt_space() on 32-bit because we used the 64-bit
    virt_space.
    
    This was _also_ broken for 32-bit kernels running on 64-bit
    hardware since boot_cpu_data.x86_virt_bits=48 even when running
    in 32-bit mode.
    
    Correct that and properly handle all 3 possible cases:
    
     1. 32-bit binary on 64-bit kernel
     2. 64-bit binary on 64-bit kernel
     3. 32-bit binary on 32-bit kernel
    
    This manifested in having bounds tables not properly unmapped.
    It "leaked" memory but had no functional impact otherwise.
    
    Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
    Cc: Andy Lutomirski <luto@amacapital.net>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: Brian Gerst <brgerst@gmail.com>
    Cc: Dave Hansen <dave@sr71.net>
    Cc: Denys Vlasenko <dvlasenk@redhat.com>
    Cc: H. Peter Anvin <hpa@zytor.com>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Link: http://lkml.kernel.org/r/20151111181934.FA7FAC34@viggo.jf.intel.com
    Signed-off-by: Ingo Molnar <mingo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit db2eb1c254efd6bb5bb50e1e70ebc5d1a926bde1
Author: Dave Hansen <dave.hansen@linux.intel.com>
Date:   Wed Nov 11 10:19:31 2015 -0800

    x86/mpx: Do proper get_user() when running 32-bit binaries on 64-bit kernels
    
    commit 46561c3959d6307d22139c24cd0bf196162e5681 upstream.
    
    When you call get_user(foo, bar), you effectively do a
    
            copy_from_user(&foo, bar, sizeof(*bar));
    
    Note that the sizeof() is implicit.
    
    When we reach out to userspace to try to zap an entire "bounds
    table" we need to go read a "bounds directory entry" in order to
    locate the table's address.  The size of a "directory entry"
    depends on the binary being run and is always the size of a
    pointer.
    
    But, when we have a 64-bit kernel and a 32-bit application, the
    directory entry is still only 32-bits long, but we fetch it with
    a 64-bit pointer which makes get_user() does a 64-bit fetch.
    Reading 4 extra bytes isn't harmful, unless we are at the end of
    and run off the table.  It might also cause the zero page to get
    faulted in unnecessarily even if you are not at the end.
    
    Fix it up by doing a special 32-bit get_user() via a cast when
    we have 32-bit userspace.
    
    Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
    Cc: Andy Lutomirski <luto@amacapital.net>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: Brian Gerst <brgerst@gmail.com>
    Cc: Dave Hansen <dave@sr71.net>
    Cc: Denys Vlasenko <dvlasenk@redhat.com>
    Cc: H. Peter Anvin <hpa@zytor.com>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Link: http://lkml.kernel.org/r/20151111181931.3ACF6822@viggo.jf.intel.com
    Signed-off-by: Ingo Molnar <mingo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 33c347136b3c0ca4b9f9b9d68fa31c3e4cbb5833
Author: Dave Hansen <dave.hansen@linux.intel.com>
Date:   Tue Nov 10 16:23:54 2015 -0800

    x86/fpu: Fix 32-bit signal frame handling
    
    commit ab6b52947545a5355154f64f449f97af9d05845f upstream.
    
    (This should have gone to LKML originally. Sorry for the extra
     noise, folks on the cc.)
    
    Background:
    
    Signal frames on x86 have two formats:
    
      1. For 32-bit executables (whether on a real 32-bit kernel or
         under 32-bit emulation on a 64-bit kernel) we have a
        'fpregset_t' that includes the "FSAVE" registers.
    
      2. For 64-bit executables (on 64-bit kernels obviously), the
         'fpregset_t' is smaller and does not contain the "FSAVE"
         state.
    
    When creating the signal frame, we have to be aware of whether
    we are running a 32 or 64-bit executable so we create the
    correct format signal frame.
    
    Problem:
    
    save_xstate_epilog() uses 'fx_sw_reserved_ia32' whenever it is
    called for a 32-bit executable.  This is for real 32-bit and
    ia32 emulation.
    
    But, fpu__init_prepare_fx_sw_frame() only initializes
    'fx_sw_reserved_ia32' when emulation is enabled, *NOT* for real
    32-bit kernels.
    
    This leads to really wierd situations where 32-bit programs
    lose their extended state when returning from a signal handler.
    The kernel copies the uninitialized (zero) 'fx_sw_reserved_ia32'
    out to userspace in save_xstate_epilog().  But when returning
    from the signal, the kernel errors out in check_for_xstate()
    when it does not see FP_XSTATE_MAGIC1 present (because it was
    zeroed).  This leads to the FPU/XSAVE state being initialized.
    
    For MPX, this leads to the most permissive state and means we
    silently lose bounds violations.  I think this would also mean
    that we could lose *ANY* FPU/SSE/AVX state.  I'm not sure why
    no one has spotted this bug.
    
    I believe this was broken by:
    
            72a671ced66d ("x86, fpu: Unify signal handling code paths for x86 and x86_64 kernels")
    
    way back in 2012.
    
    Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
    Cc: Andy Lutomirski <luto@amacapital.net>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: Brian Gerst <brgerst@gmail.com>
    Cc: Denys Vlasenko <dvlasenk@redhat.com>
    Cc: H. Peter Anvin <hpa@zytor.com>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: dave@sr71.net
    Cc: fenghua.yu@intel.com
    Cc: yu-cheng.yu@intel.com
    Link: http://lkml.kernel.org/r/20151111002354.A0799571@viggo.jf.intel.com
    Signed-off-by: Ingo Molnar <mingo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cb0a3671cfd934083a5ac646ede19ce93da4a824
Author: Huaitong Han <huaitong.han@intel.com>
Date:   Fri Nov 6 17:00:23 2015 +0800

    x86/fpu: Fix get_xsave_addr() behavior under virtualization
    
    commit a05917b6ba9dc9a95fc42bdcbe3a875e8ad83935 upstream.
    
    KVM uses the get_xsave_addr() function in a different fashion from
    the native kernel, in that the 'xsave' parameter belongs to guest vcpu,
    not the currently running task.
    
    But 'xsave' is replaced with current task's (host) xsave structure, so
    get_xsave_addr() will incorrectly return the bad xsave address to KVM.
    
    Fix it so that the passed in 'xsave' address is used - as intended
    originally.
    
    Signed-off-by: Huaitong Han <huaitong.han@intel.com>
    Reviewed-by: Dave Hansen <dave.hansen@linux.intel.com>
    Cc: Andy Lutomirski <luto@amacapital.net>
    Cc: Paolo Bonzini <pbonzini@redhat.com>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: Fenghua Yu <fenghua.yu@intel.com>
    Cc: H. Peter Anvin <hpa@zytor.com>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Oleg Nesterov <oleg@redhat.com>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Quentin Casasnovas <quentin.casasnovas@oracle.com>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: dave.hansen@intel.com
    Link: http://lkml.kernel.org/r/1446800423-21622-1-git-send-email-huaitong.han@intel.com
    [ Tidied up the changelog. ]
    Signed-off-by: Ingo Molnar <mingo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 36e5b70aeab1fb56bb06c597ea26e325871d4cb3
Author: Andrew Cooper <andrew.cooper3@citrix.com>
Date:   Wed Jun 3 10:31:14 2015 +0100

    x86/cpu: Fix SMAP check in PVOPS environments
    
    commit 581b7f158fe0383b492acd1ce3fb4e99d4e57808 upstream.
    
    There appears to be no formal statement of what pv_irq_ops.save_fl() is
    supposed to return precisely.  Native returns the full flags, while lguest and
    Xen only return the Interrupt Flag, and both have comments by the
    implementations stating that only the Interrupt Flag is looked at.  This may
    have been true when initially implemented, but no longer is.
    
    To make matters worse, the Xen PVOP leaves the upper bits undefined, making
    the BUG_ON() undefined behaviour.  Experimentally, this now trips for 32bit PV
    guests on Broadwell hardware.  The BUG_ON() is consistent for an individual
    build, but not consistent for all builds.  It has also been a sitting timebomb
    since SMAP support was introduced.
    
    Use native_save_fl() instead, which will obtain an accurate view of the AC
    flag.
    
    Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
    Reviewed-by: David Vrabel <david.vrabel@citrix.com>
    Tested-by: Rusty Russell <rusty@rustcorp.com.au>
    Cc: Rusty Russell <rusty@rustcorp.com.au>
    Cc: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
    Cc: Boris Ostrovsky <boris.ostrovsky@oracle.com>
    Cc: <lguest@lists.ozlabs.org>
    Cc: Xen-devel <xen-devel@lists.xen.org>
    Link: http://lkml.kernel.org/r/1433323874-6927-1-git-send-email-andrew.cooper3@citrix.com
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dc3c09e9eaeb13c6246e927b7ac36453a36d5aae
Author: Borislav Petkov <bp@suse.de>
Date:   Thu Nov 5 16:57:56 2015 +0100

    x86/cpu: Call verify_cpu() after having entered long mode too
    
    commit 04633df0c43d710e5f696b06539c100898678235 upstream.
    
    When we get loaded by a 64-bit bootloader, kernel entry point is
    startup_64 in head_64.S. We don't trust any and all bootloaders because
    some will fiddle with CPU configuration so we go ahead and massage each
    CPU into sanity again.
    
    For example, some dell BIOSes have this XD disable feature which set
    IA32_MISC_ENABLE[34] and disable NX. This might be some dumb workaround
    for other OSes but Linux sure doesn't need it.
    
    A similar thing is present in the Surface 3 firmware - see
    https://bugzilla.kernel.org/show_bug.cgi?id=106051 - which sets this bit
    only on the BSP:
    
      # rdmsr -a 0x1a0
      400850089
      850089
      850089
      850089
    
    I know, right?!
    
    There's not even an off switch in there.
    
    So fix all those cases by sanitizing the 64-bit entry point too. For
    that, make verify_cpu() callable in 64-bit mode also.
    
    Requested-and-debugged-by: "H. Peter Anvin" <hpa@zytor.com>
    Reported-and-tested-by: Bastien Nocera <bugzilla@hadess.net>
    Signed-off-by: Borislav Petkov <bp@suse.de>
    Cc: Matt Fleming <matt@codeblueprint.co.uk>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Link: http://lkml.kernel.org/r/1446739076-21303-1-git-send-email-bp@alien8.de
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 36a6e9632583c9f83f8d76652b622904797e4518
Author: Vitaly Kuznetsov <vkuznets@redhat.com>
Date:   Tue Nov 3 10:40:14 2015 +0100

    x86/irq: Probe for PIC presence before allocating descs for legacy IRQs
    
    commit 8c058b0b9c34d8c8d7912880956543769323e2d8 upstream.
    
    Commit d32932d02e18 ("x86/irq: Convert IOAPIC to use hierarchical irqdomain
    interfaces") brought a regression for Hyper-V Gen2 instances. These
    instances don't have i8259 legacy PIC but they use legacy IRQs for serial
    port, rtc, and acpi. With this commit included we end up with these IRQs
    not initialized. Earlier, there was a special workaround for legacy IRQs
    in mp_map_pin_to_irq() doing mp_irqdomain_map() without looking at
    nr_legacy_irqs() and now we fail in __irq_domain_alloc_irqs() when
    irq_domain_alloc_descs() returns -EEXIST.
    
    The essence of the issue seems to be that early_irq_init() calls
    arch_probe_nr_irqs() to figure out the number of legacy IRQs before
    we probe for i8259 and gets 16. Later when init_8259A() is called we switch
    to NULL legacy PIC and nr_legacy_irqs() starts to return 0 but we already
    have 16 descs allocated.
    
    Solve the issue by separating i8259 probe from init and calling it in
    arch_probe_nr_irqs() before we actually use nr_legacy_irqs() information.
    
    Fixes: d32932d02e18 ("x86/irq: Convert IOAPIC to use hierarchical irqdomain interfaces")
    Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
    Cc: Jiang Liu <jiang.liu@linux.intel.com>
    Cc: K. Y. Srinivasan <kys@microsoft.com>
    Link: http://lkml.kernel.org/r/1446543614-3621-1-git-send-email-vkuznets@redhat.com
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 301cccb34389906afbae249d188d6c42d4baf314
Author: Krzysztof Mazur <krzysiek@podlesie.net>
Date:   Fri Nov 6 14:18:36 2015 +0100

    x86/setup: Fix low identity map for >= 2GB kernel range
    
    commit 68accac392d859d24adcf1be3a90e41f978bd54c upstream.
    
    The commit f5f3497cad8c extended the low identity mapping. However, if
    the kernel uses more than 2 GB (VMSPLIT_2G_OPT or VMSPLIT_1G memory
    split), the normal memory mapping is overwritten by the low identity
    mapping causing a crash. To avoid overwritting, limit the low identity
    map to cover only memory before kernel range (PAGE_OFFSET).
    
    Fixes: f5f3497cad8c "x86/setup: Extend low identity map to cover whole kernel range
    Signed-off-by: Krzysztof Mazur <krzysiek@podlesie.net>
    Cc: Andy Lutomirski <luto@amacapital.net>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: Laszlo Ersek <lersek@redhat.com>
    Cc: Matt Fleming <matt.fleming@intel.com>
    Cc: Paolo Bonzini <pbonzini@redhat.com>
    Link: http://lkml.kernel.org/r/1446815916-22105-1-git-send-email-krzysiek@podlesie.net
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 23aa5b9ecaaa5397ca097a1cb4861002e380e1d9
Author: Paolo Bonzini <pbonzini@redhat.com>
Date:   Wed Oct 14 13:30:45 2015 +0200

    x86/setup: Extend low identity map to cover whole kernel range
    
    commit f5f3497cad8c8416a74b9aaceb127908755d020a upstream.
    
    On 32-bit systems, the initial_page_table is reused by
    efi_call_phys_prolog as an identity map to call
    SetVirtualAddressMap.  efi_call_phys_prolog takes care of
    converting the current CPU's GDT to a physical address too.
    
    For PAE kernels the identity mapping is achieved by aliasing the
    first PDPE for the kernel memory mapping into the first PDPE
    of initial_page_table.  This makes the EFI stub's trick "just work".
    
    However, for non-PAE kernels there is no guarantee that the identity
    mapping in the initial_page_table extends as far as the GDT; in this
    case, accesses to the GDT will cause a page fault (which quickly becomes
    a triple fault).  Fix this by copying the kernel mappings from
    swapper_pg_dir to initial_page_table twice, both at PAGE_OFFSET and at
    identity mapping.
    
    For some reason, this is only reproducible with QEMU's dynamic translation
    mode, and not for example with KVM.  However, even under KVM one can clearly
    see that the page table is bogus:
    
        $ qemu-system-i386 -pflash OVMF.fd -M q35 vmlinuz0 -s -S -daemonize
        $ gdb
        (gdb) target remote localhost:1234
        (gdb) hb *0x02858f6f
        Hardware assisted breakpoint 1 at 0x2858f6f
        (gdb) c
        Continuing.
    
        Breakpoint 1, 0x02858f6f in ?? ()
        (gdb) monitor info registers
        ...
        GDT=     0724e000 000000ff
        IDT=     fffbb000 000007ff
        CR0=0005003b CR2=ff896000 CR3=032b7000 CR4=00000690
        ...
    
    The page directory is sane:
    
        (gdb) x/4wx 0x32b7000
        0x32b7000:  0x03398063      0x03399063      0x0339a063      0x0339b063
        (gdb) x/4wx 0x3398000
        0x3398000:  0x00000163      0x00001163      0x00002163      0x00003163
        (gdb) x/4wx 0x3399000
        0x3399000:  0x00400003      0x00401003      0x00402003      0x00403003
    
    but our particular page directory entry is empty:
    
        (gdb) x/1wx 0x32b7000 + (0x724e000 >> 22) * 4
        0x32b7070:  0x00000000
    
    [ It appears that you can skate past this issue if you don't receive
      any interrupts while the bogus GDT pointer is loaded, or if you avoid
      reloading the segment registers in general.
    
      Andy Lutomirski provides some additional insight:
    
       "AFAICT it's entirely permissible for the GDTR and/or LDT
        descriptor to point to unmapped memory.  Any attempt to use them
        (segment loads, interrupts, IRET, etc) will try to access that memory
        as if the access came from CPL 0 and, if the access fails, will
        generate a valid page fault with CR2 pointing into the GDT or
        LDT."
    
      Up until commit 23a0d4e8fa6d ("efi: Disable interrupts around EFI
      calls, not in the epilog/prolog calls") interrupts were disabled
      around the prolog and epilog calls, and the functional GDT was
      re-installed before interrupts were re-enabled.
    
      Which explains why no one has hit this issue until now. ]
    
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Reported-by: Laszlo Ersek <lersek@redhat.com>
    Cc: <stable@vger.kernel.org>
    Cc: Borislav Petkov <bp@alien8.de>
    Cc: "H. Peter Anvin" <hpa@zytor.com>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Ingo Molnar <mingo@kernel.org>
    Cc: Andy Lutomirski <luto@amacapital.net>
    Signed-off-by: Matt Fleming <matt.fleming@intel.com>
    [ Updated changelog. ]
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 832ddbfa33ba334ab7b136fc525a4c853519a1aa
Author: Eric Northup <digitaleric@google.com>
Date:   Tue Nov 3 18:03:53 2015 +0100

    KVM: x86: work around infinite loop in microcode when #AC is delivered
    
    commit 54a20552e1eae07aa240fa370a0293e006b5faed upstream.
    
    It was found that a guest can DoS a host by triggering an infinite
    stream of "alignment check" (#AC) exceptions.  This causes the
    microcode to enter an infinite loop where the core never receives
    another interrupt.  The host kernel panics pretty quickly due to the
    effects (CVE-2015-5307).
    
    Signed-off-by: Eric Northup <digitaleric@google.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f47e259ebdfcc68f4d3e30b3ce77d920fc30b618
Author: Laszlo Ersek <lersek@redhat.com>
Date:   Wed Nov 4 12:54:41 2015 +0100

    KVM: x86: obey KVM_X86_QUIRK_CD_NW_CLEARED in kvm_set_cr0()
    
    commit 879ae1880449c88db11c1ebdaedc2da79b2fe73f upstream.
    
    Commit b18d5431acc7 ("KVM: x86: fix CR0.CD virtualization") was
    technically correct, but it broke OVMF guests by slowing down various
    parts of the firmware.
    
    Commit fb279950ba02 ("KVM: vmx: obey KVM_QUIRK_CD_NW_CLEARED") quirked the
    first function modified by b18d5431acc7, vmx_get_mt_mask(), for OVMF's
    sake. This restored the speed of the OVMF code that runs before
    PlatformPei (including the memory intensive LZMA decompression in SEC).
    
    This patch extends the quirk to the second function modified by
    b18d5431acc7, kvm_set_cr0(). It eliminates the intrusive slowdown that
    hits the EFI_MP_SERVICES_PROTOCOL implementation of edk2's
    UefiCpuPkg/CpuDxe -- which is built into OVMF --, when CpuDxe starts up
    all APs at once for initialization, in order to count them.
    
    We also carry over the kvm_arch_has_noncoherent_dma() sub-condition from
    the other half of the original commit b18d5431acc7.
    
    Fixes: b18d5431acc7a2fd22767925f3a6f597aa4bd29e
    Cc: Jordan Justen <jordan.l.justen@intel.com>
    Cc: Alex Williamson <alex.williamson@redhat.com>
    Reviewed-by: Xiao Guangrong <guangrong.xiao@linux.intel.com>
    Tested-by: Janusz Mocek <januszmk6@gmail.com>
    Signed-off-by: Laszlo Ersek <lersek@redhat.com>#
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 636bda861f6b1c41dbf293b74b26a496d73a80d7
Author: Paolo Bonzini <pbonzini@redhat.com>
Date:   Tue Nov 3 13:43:05 2015 +0100

    KVM: x86: allow RSM from 64-bit mode
    
    commit 89651a3decbe03754f304a0b248f27eeb9a37937 upstream.
    
    The SDM says that exiting system management mode from 64-bit mode
    is invalid, but that would be too good to be true.  But actually,
    most of the code is already there to support exiting from compat
    mode (EFER.LME=1, EFER.LMA=0).  Getting all the way from 64-bit
    mode to real mode only requires clearing CS.L and CR4.PCIDE.
    
    Fixes: 660a5d517aaab9187f93854425c4c63f4a09195c
    Tested-by: Laszlo Ersek <lersek@redhat.com>
    Cc: Radim Krčmář <rkrcmar@redhat.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 533275b5603f285d9f11ecd90552ec9b1f0b1016
Author: Radim Krčmář <rkrcmar@redhat.com>
Date:   Fri Oct 30 16:36:25 2015 +0100

    KVM: x86: handle SMBASE as physical address in RSM
    
    commit f40606b147dd5b4678cedc877a71deb520ca507e upstream.
    
    GET_SMSTATE depends on real mode to ensure that smbase+offset is treated
    as a physical address, which has already caused a bug after shuffling
    the code.  Enforce physical addressing.
    
    Signed-off-by: Radim Krčmář <rkrcmar@redhat.com>
    Reported-by: Laszlo Ersek <lersek@redhat.com>
    Tested-by: Laszlo Ersek <lersek@redhat.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 19173aea3e80dc1a47cf3d2b8c9a7528d248fc6a
Author: Radim Krčmář <rkrcmar@redhat.com>
Date:   Fri Oct 30 16:36:24 2015 +0100

    KVM: x86: add read_phys to x86_emulate_ops
    
    commit 7a036a6f670f63b32c5ee126425f9109271ca13f upstream.
    
    We want to read the physical memory when emulating RSM.
    
    X86EMUL_IO_NEEDED is returned on all errors for consistency with other
    helpers.
    
    Signed-off-by: Radim Krčmář <rkrcmar@redhat.com>
    Tested-by: Laszlo Ersek <lersek@redhat.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3f2f60d5901fbedc72638a6c420df88df753c4dc
Author: Paolo Bonzini <pbonzini@redhat.com>
Date:   Mon Oct 19 11:30:19 2015 +0200

    kvm: x86: zero EFER on INIT
    
    commit 5690891bcec5fcfda38da974ffa5488e36a59811 upstream.
    
    Not zeroing EFER means that a 32-bit firmware cannot enter paging mode
    without clearing EFER.LME first (which it should not know about).
    Yang Zhang from Intel confirmed that the manual is wrong and EFER is
    cleared to zero on INIT.
    
    Fixes: d28bc9dd25ce023270d2e039e7c98d38ecbf7758
    Cc: Yang Z Zhang <yang.z.zhang@intel.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 014b67a66d84f5fa5b5971ecf9ec2a7f91ce10ca
Author: Radim Krčmář <rkrcmar@redhat.com>
Date:   Thu Oct 8 20:23:33 2015 +0200

    kvm: x86: set KVM_REQ_EVENT when updating IRR
    
    commit c77f3fab441c3e466b4c3601a475fc31ce156b06 upstream.
    
    After moving PIR to IRR, the interrupt needs to be delivered manually.
    
    Reported-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Radim Krčmář <rkrcmar@redhat.com>
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d64be019c9da275163e6ccb14bb3bdad02ea0a4d
Author: James Hogan <jhogan@kernel.org>
Date:   Wed Nov 11 14:21:20 2015 +0000

    MIPS: KVM: Uninit VCPU in vcpu_create error path
    
    commit 585bb8f9a5e592f2ce7abbe5ed3112d5438d2754 upstream.
    
    If either of the memory allocations in kvm_arch_vcpu_create() fail, the
    vcpu which has been allocated and kvm_vcpu_init'd doesn't get uninit'd
    in the error handling path. Add a call to kvm_vcpu_uninit() to fix this.
    
    Fixes: 669e846e6c4e ("KVM/MIPS32: MIPS arch specific APIs for KVM")
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: Ralf Baechle <ralf@linux-mips.org>
    Cc: Paolo Bonzini <pbonzini@redhat.com>
    Cc: Gleb Natapov <gleb@kernel.org>
    Cc: linux-mips@linux-mips.org
    Cc: kvm@vger.kernel.org
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c6a2bbdbf99e8a870703ba62020eaac35bf09876
Author: James Hogan <jhogan@kernel.org>
Date:   Wed Nov 11 14:21:19 2015 +0000

    MIPS: KVM: Fix CACHE immediate offset sign extension
    
    commit c5c2a3b998f1ff5a586f9d37e154070b8d550d17 upstream.
    
    The immediate field of the CACHE instruction is signed, so ensure that
    it gets sign extended by casting it to an int16_t rather than just
    masking the low 16 bits.
    
    Fixes: e685c689f3a8 ("KVM/MIPS32: Privileged instruction/target branch emulation.")
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: Ralf Baechle <ralf@linux-mips.org>
    Cc: Paolo Bonzini <pbonzini@redhat.com>
    Cc: Gleb Natapov <gleb@kernel.org>
    Cc: linux-mips@linux-mips.org
    Cc: kvm@vger.kernel.org
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 24e01d8fa8f0c5ff26993bcde25c13f59dcb8b3c
Author: James Hogan <jhogan@kernel.org>
Date:   Wed Nov 11 14:21:18 2015 +0000

    MIPS: KVM: Fix ASID restoration logic
    
    commit 002374f371bd02df864cce1fe85d90dc5b292837 upstream.
    
    ASID restoration on guest resume should determine the guest execution
    mode based on the guest Status register rather than bit 30 of the guest
    PC.
    
    Fix the two places in locore.S that do this, loading the guest status
    from the cop0 area. Note, this assembly is specific to the trap &
    emulate implementation of KVM, so it doesn't need to check the
    supervisor bit as that mode is not implemented in the guest.
    
    Fixes: b680f70fc111 ("KVM/MIPS32: Entry point for trampolining to...")
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: Ralf Baechle <ralf@linux-mips.org>
    Cc: Paolo Bonzini <pbonzini@redhat.com>
    Cc: Gleb Natapov <gleb@kernel.org>
    Cc: linux-mips@linux-mips.org
    Cc: kvm@vger.kernel.org
    Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d75d9cb5bc65de44104ad67738493274e3ad9b2d
Author: Alban Bedel <albeu@free.fr>
Date:   Tue Nov 17 09:40:07 2015 +0100

    MIPS: ath79: Fix the DDR control initialization on ar71xx and ar934x
    
    commit 5011a7e808c9fec643d752c5a495a48f27268a48 upstream.
    
    The DDR control initialization needs to know the SoC type, however
    ath79_detect_sys_type() was called after ath79_ddr_ctrl_init().
    Reverse the order to fix the DDR control initialization on ar71xx and
    ar934x.
    
    Signed-off-by: Alban Bedel <albeu@free.fr>
    Cc: Felix Fietkau <nbd@openwrt.org>
    Cc: Qais Yousef <qais.yousef@imgtec.com>
    Cc: Andrew Bresticker <abrestic@chromium.org>
    Cc: linux-mips@linux-mips.org
    Cc: linux-kernel@vger.kernel.org
    Patchwork: https://patchwork.linux-mips.org/patch/11500/
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d022dec28eacc745f36aa8a55045bc939b91eaa7
Author: James Hogan <jhogan@kernel.org>
Date:   Tue Oct 6 15:12:05 2015 +0100

    MIPS: CDMM: Add builtin_mips_cdmm_driver() macro
    
    commit 1b4a5ddb127caf125e14551ebd334be1acf21805 upstream.
    
    Add helper macro builtin_mips_cdmm_driver() for builtin CDMM drivers
    that don't do anything special in init and have no exit. The
    module_mips_cdmm_driver() helper isn't really appropriate for drivers
    that can't be built as a module.
    
    Signed-off-by: James Hogan <james.hogan@imgtec.com>
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Cc: Jiri Slaby <jslaby@suse.com>
    Cc: linux-mips@linux-mips.org
    Patchwork: http://patchwork.linux-mips.org/patch/11264/
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1d88214f5a7a3ac68459261a6075570c13a6d9d5
Author: Hauke Mehrtens <hauke@hauke-m.de>
Date:   Sun Oct 25 23:21:42 2015 +0100

    MIPS: lantiq: add clk_round_rate()
    
    commit 4e7d30dba493b60a80e9b590add1b4402265cc83 upstream.
    
    This adds a basic implementation of clk_round_rate()
    The clk_round_rate() function is called by multiple drivers and
    subsystems now and the lantiq clk driver is supposed to export this,
    but doesn't do so, this causes linking problems like this one:
    ERROR: "clk_round_rate" [drivers/media/v4l2-core/videodev.ko] undefined!
    
    Signed-off-by: Hauke Mehrtens <hauke@hauke-m.de>
    Acked-by: John Crispin <blogic@openwrt.org>
    Cc: linux-mips@linux-mips.org
    Patchwork: https://patchwork.linux-mips.org/patch/11358/
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1c04b0f02aba857f1624c5d01d0b8e3ec9757fd0
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Mon Oct 12 15:46:08 2015 +0200

    ARM: pxa: remove incorrect __init annotation on pxa27x_set_pwrmode
    
    commit 54c09889bff6d99c8733eed4a26c9391b177c88b upstream.
    
    The z2 machine calls pxa27x_set_pwrmode() in order to power off
    the machine, but this function gets discarded early at boot because
    it is marked __init, as pointed out by kbuild:
    
    WARNING: vmlinux.o(.text+0x145c4): Section mismatch in reference from the function z2_power_off() to the function .init.text:pxa27x_set_pwrmode()
    The function z2_power_off() references
    the function __init pxa27x_set_pwrmode().
    This is often because z2_power_off lacks a __init
    annotation or the annotation of pxa27x_set_pwrmode is wrong.
    
    This removes the __init section modifier to fix rebooting and the
    build error.
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Fixes: ba4a90a6d86a ("ARM: pxa/z2: fix building error of pxa27x_cpu_suspend() no longer available")
    Signed-off-by: Robert Jarzmik <robert.jarzmik@free.fr>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cc372ce4aa1aabfb95daa6063da16b452b8e98f7
Author: Chen-Yu Tsai <wens@csie.org>
Date:   Sat Oct 10 22:48:56 2015 +0800

    ARM: dts: sun6i: hummingbird: Fix VDD-CPU and VDD-GPU regulator names
    
    commit 976d84fce6aa1e5bf92b8d06d69014ac45fd5fad upstream.
    
    The VDD-CPU and VDD-GPU regulators were incorrectly swapped.
    
    Fixes: bab03561224ba ("ARM: dts: sun6i: hummingbird: Add AXP221 regulator
           nodes")
    
    Signed-off-by: Chen-Yu Tsai <wens@csie.org>
    Signed-off-by: Maxime Ripard <maxime.ripard@free-electrons.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b233e613b1b1f64520b6de860f26b65ecdb3428d
Author: Tony Lindgren <tony@atomide.com>
Date:   Fri Oct 16 12:32:32 2015 -0700

    ARM: dts: Fix WLAN regression on omap5-uevm
    
    commit 0efc898a9bea7a2e8e583c6efab0e19dc7093078 upstream.
    
    Commit 99f84cae43df ("ARM: dts: add wl12xx/wl18xx bindings") added
    device tree bindings for the TI WLAN SDIO on many omap variants.
    
    I recall wondering how come omap5-uevm did not have the WLAN
    added and this issue has been bugging me for a while now, and
    I finally tracked it down to a bad pinmux regression, and a missing
    deferred probe handling for the 32k clock from palmas that's
    requested by twl6040.
    
    Basically 392adaf796b9 ("ARM: dts: omap5-evm: Add mcspi data")
    added pin muxing for mcspi4 that conflicts with the onboard
    WLAN. While some omap5-uevm don't have WLAN populated, the
    pins are not reused for other devices. And as the SDIO bus
    should be probed, let's try to enable WLAN by default.
    
    Let's fix the regression and add the WLAN configuration as
    done for the other boards in 99f84cae43df ("ARM: dts: add
    wl12xx/wl18xx bindings"). And let's use the new MMC pwrseq for
    the 32k clock as suggested by Javier Martinez Canillas
    <javier@dowhile0.org>.
    
    Note that without a related deferred probe fix for twl6040,
    the 32k clock is not initialized if palmas-clk is a module
    and twl6040 is built-in.
    
    Let's also use the generic "non-removable" instead of the
    legacy "ti,non-removable" property while at it.
    
    And finally, note that omap5 seems to require WAKEUP_EN for
    the WLAN GPIO interrupt.
    
    Fixes: 392adaf796b9 ("ARM: dts: omap5-evm: Add mcspi data")
    Cc: Sourav Poddar <sourav.poddar@ti.com>
    Signed-off-by: Tony Lindgren <tony@atomide.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7e84bf710a83452d594155e0392a2d138efc4d94
Author: Patrick Doyle <pdoyle@irobot.com>
Date:   Fri Oct 16 12:39:05 2015 +0200

    ARM: at91: pm: at91_pm_suspend_in_sram() must be 8-byte aligned
    
    commit 5fcf8d1a0e84792b2bc44922c5d833dab96a9c1e upstream.
    
    fncpy() requires that the source and the destination are both 8-byte
    aligned.
    
    Signed-off-by: Patrick Doyle <pdoyle@irobot.com>
    Signed-off-by: Alexandre Belloni <alexandre.belloni@free-electrons.com>
    Acked-by: Nicolas Ferre <nicolas.ferre@atmel.com>
    Fixes: d94e688cae56 ("ARM: at91/pm: move the copying the sram function to the sram initialization phase")
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5242fa6e38ebd78fc4e65ff4b05aa53aaf2e423f
Author: Holger Busse <h.busse@kathrein-sachsen.de>
Date:   Wed Aug 26 10:45:45 2015 +0200

    ARM: at91/dt: corrections to i2c1 declaration to sama5d4
    
    commit d1a9c24ad16ab2b26f1574bc3f2c165a7beff5df upstream.
    
    Correcting the dma declaration for i2c1 dma.
    
    Signed-off-by: Holger Busse <h.busse@kathrein-sachsen.de>
    Signed-off-by: Nicolas Ferre <nicolas.ferre@atmel.com>
    Fixes: 4cc7cdf35c5f ("ARM: at91/dt: add i2c1 declaration to sama5d4")
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 77596bfeab71cce270766d02a6da7a45358539b8
Author: Dmitry Osipenko <digetx@gmail.com>
Date:   Tue Jun 30 17:15:50 2015 +0300

    ARM: tegra: paz00: use con_id's to refer GPIO's in gpiod_lookup table
    
    commit e77b675f8786f38d40fc1562e1275875daf67fef upstream.
    
    Commit 72daceb9a10a ("net: rfkill: gpio: Add default GPIO driver mappings
    for ACPI") removed possibility to request GPIO by table index for non-ACPI
    platforms without changing its users. As result "shutdown" GPIO request
    will fail if request for "reset" GPIO succeeded or "reset" will be
    requested instead of "shutdown" if "reset" wasn't defined. Fix it by
    making gpiod_lookup_table use con_id's instead of indexes.
    
    Signed-off-by: Dmitry Osipenko <digetx@gmail.com>
    Fixes: 72daceb (net: rfkill: gpio: Add default GPIO driver mappings for ACPI)
    Acked-by: Alexandre Courbot <acourbot@nvidia.com>
    Reviewed-by: Marc Dietrich <marvin24@gmx.de>
    Tested-by: Marc Dietrich <marvin24@gmx.de>
    Signed-off-by: Thierry Reding <treding@nvidia.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e7e0604402696763084fa6f96e50f837a3684371
Author: Peter Chen <peter.chen@freescale.com>
Date:   Wed Sep 16 09:35:06 2015 +0800

    ARM: dts: imx27.dtsi: change the clock information for usb
    
    commit facf47ee6b4d07d43c3bfd6f0762f1b28f64703a upstream.
    
    For imx27, it needs three clocks to let the controller work,
    the old code is wrong, and usbmisc has not included clock handling
    code any more. Without this patch, it will cause below data
    abort when accessing usbmisc registers.
    
    usbcore: registered new interface driver usb-storage
    Unhandled fault: external abort on non-linefetch (0x008) at 0xf4424600
    pgd = c0004000
    [f4424600] *pgd=10000452(bad)
    Internal error: : 8 [#1] PREEMPT ARM
    Modules linked in:
    CPU: 0 PID: 1 Comm: swapper Not tainted 4.1.0-next-20150701-dirty #3089
    Hardware name: Freescale i.MX27 (Device Tree Support)
    task: c7832b60 ti: c783e000 task.ti: c783e000
    PC is at usbmisc_imx27_init+0x4c/0xbc
    LR is at usbmisc_imx27_init+0x40/0xbc
    pc : [<c03cb5c0>]    lr : [<c03cb5b4>]    psr: 60000093
    sp : c783fe08  ip : 00000000  fp : 00000000
    r10: c0576434  r9 : 0000009c  r8 : c7a773a0
    r7 : 01000000  r6 : 60000013  r5 : c7a776f0  r4 : c7a773f0
    r3 : f4424600  r2 : 00000000  r1 : 00000001  r0 : 00000001
    Flags: nZCv  IRQs off  FIQs on  Mode SVC_32  ISA ARM  Segment kernel
    Control: 0005317f  Table: a0004000  DAC: 00000017
    Process swapper (pid: 1, stack limit = 0xc783e190)
    Stack: (0xc783fe08 to 0xc7840000)
    
    Signed-off-by: Peter Chen <peter.chen@freescale.com>
    Reported-by: Fabio Estevam <fabio.estevam@freescale.com>
    Tested-by: Fabio Estevam <fabio.estevam@freescale.com>
    Acked-by: Shawn Guo <shawnguo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 39a54dd06a321729fd0f1d897d99ed34d1f645eb
Author: Peter Ujfalusi <peter.ujfalusi@ti.com>
Date:   Wed Oct 14 14:42:43 2015 +0300

    ARM: common: edma: Fix channel parameter for irq callbacks
    
    commit 696d8b70c09dd421c4d037fab04341e5b30585cf upstream.
    
    In case when the interrupt happened for the second eDMA the channel
    number was incorrectly passed to the client driver.
    
    Signed-off-by: Peter Ujfalusi <peter.ujfalusi@ti.com>
    Signed-off-by: Vinod Koul <vinod.koul@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9bf66043f0c0a3b1447733e97ce885a41e8371d1
Author: Marek Szyprowski <m.szyprowski@samsung.com>
Date:   Fri Aug 28 09:42:09 2015 +0100

    ARM: 8427/1: dma-mapping: add support for offset parameter in dma_mmap()
    
    commit 7e31210349e9e03a9a4dff31ab5f2bc83e8e84f5 upstream.
    
    IOMMU-based dma_mmap() implementation lacked proper support for offset
    parameter used in mmap call (it always assumed that mapping starts from
    offset zero). This patch adds support for offset parameter to IOMMU-based
    implementation.
    
    Signed-off-by: Marek Szyprowski <m.szyprowski@samsung.com>
    Signed-off-by: Russell King <rmk+kernel@arm.linux.org.uk>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 85b3675493fa0738c7246789da4b258b67379d54
Author: Marek Szyprowski <m.szyprowski@samsung.com>
Date:   Fri Aug 28 09:41:39 2015 +0100

    ARM: 8426/1: dma-mapping: add missing range check in dma_mmap()
    
    commit 371f0f085f629fc0f66695f572373ca4445a67ad upstream.
    
    dma_mmap() function in IOMMU-based dma-mapping implementation lacked
    a check for valid range of mmap parameters (offset and buffer size), what
    might have caused access beyond the allocated buffer. This patch fixes
    this issue.
    
    Signed-off-by: Marek Szyprowski <m.szyprowski@samsung.com>
    Signed-off-by: Russell King <rmk+kernel@arm.linux.org.uk>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1935cd0bbfae6055518419ce2b0fdf565593deb7
Author: Sasha Levin <sasha.levin@oracle.com>
Date:   Tue Sep 8 10:53:40 2015 -0400

    RDS: verify the underlying transport exists before creating a connection
    
    [ Upstream commit 74e98eb085889b0d2d4908f59f6e00026063014f ]
    
    There was no verification that an underlying transport exists when creating
    a connection, this would cause dereferencing a NULL ptr.
    
    It might happen on sockets that weren't properly bound before attempting to
    send a message, which will cause a NULL ptr deref:
    
    [135546.047719] kasan: GPF could be caused by NULL-ptr deref or user memory accessgeneral protection fault: 0000 [#1] PREEMPT SMP DEBUG_PAGEALLOC KASAN
    [135546.051270] Modules linked in:
    [135546.051781] CPU: 4 PID: 15650 Comm: trinity-c4 Not tainted 4.2.0-next-20150902-sasha-00041-gbaa1222-dirty #2527
    [135546.053217] task: ffff8800835bc000 ti: ffff8800bc708000 task.ti: ffff8800bc708000
    [135546.054291] RIP: __rds_conn_create (net/rds/connection.c:194)
    [135546.055666] RSP: 0018:ffff8800bc70fab0  EFLAGS: 00010202
    [135546.056457] RAX: dffffc0000000000 RBX: 0000000000000f2c RCX: ffff8800835bc000
    [135546.057494] RDX: 0000000000000007 RSI: ffff8800835bccd8 RDI: 0000000000000038
    [135546.058530] RBP: ffff8800bc70fb18 R08: 0000000000000001 R09: 0000000000000000
    [135546.059556] R10: ffffed014d7a3a23 R11: ffffed014d7a3a21 R12: 0000000000000000
    [135546.060614] R13: 0000000000000001 R14: ffff8801ec3d0000 R15: 0000000000000000
    [135546.061668] FS:  00007faad4ffb700(0000) GS:ffff880252000000(0000) knlGS:0000000000000000
    [135546.062836] CS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b
    [135546.063682] CR2: 000000000000846a CR3: 000000009d137000 CR4: 00000000000006a0
    [135546.064723] Stack:
    [135546.065048]  ffffffffafe2055c ffffffffafe23fc1 ffffed00493097bf ffff8801ec3d0008
    [135546.066247]  0000000000000000 00000000000000d0 0000000000000000 ac194a24c0586342
    [135546.067438]  1ffff100178e1f78 ffff880320581b00 ffff8800bc70fdd0 ffff880320581b00
    [135546.068629] Call Trace:
    [135546.069028] ? __rds_conn_create (include/linux/rcupdate.h:856 net/rds/connection.c:134)
    [135546.069989] ? rds_message_copy_from_user (net/rds/message.c:298)
    [135546.071021] rds_conn_create_outgoing (net/rds/connection.c:278)
    [135546.071981] rds_sendmsg (net/rds/send.c:1058)
    [135546.072858] ? perf_trace_lock (include/trace/events/lock.h:38)
    [135546.073744] ? lockdep_init (kernel/locking/lockdep.c:3298)
    [135546.074577] ? rds_send_drop_to (net/rds/send.c:976)
    [135546.075508] ? __might_fault (./arch/x86/include/asm/current.h:14 mm/memory.c:3795)
    [135546.076349] ? __might_fault (mm/memory.c:3795)
    [135546.077179] ? rds_send_drop_to (net/rds/send.c:976)
    [135546.078114] sock_sendmsg (net/socket.c:611 net/socket.c:620)
    [135546.078856] SYSC_sendto (net/socket.c:1657)
    [135546.079596] ? SYSC_connect (net/socket.c:1628)
    [135546.080510] ? trace_dump_stack (kernel/trace/trace.c:1926)
    [135546.081397] ? ring_buffer_unlock_commit (kernel/trace/ring_buffer.c:2479 kernel/trace/ring_buffer.c:2558 kernel/trace/ring_buffer.c:2674)
    [135546.082390] ? trace_buffer_unlock_commit (kernel/trace/trace.c:1749)
    [135546.083410] ? trace_event_raw_event_sys_enter (include/trace/events/syscalls.h:16)
    [135546.084481] ? do_audit_syscall_entry (include/trace/events/syscalls.h:16)
    [135546.085438] ? trace_buffer_unlock_commit (kernel/trace/trace.c:1749)
    [135546.085515] rds_ib_laddr_check(): addr 36.74.25.172 ret -99 node type -1
    
    Acked-by: Santosh Shilimkar <santosh.shilimkar@oracle.com>
    Signed-off-by: Sasha Levin <sasha.levin@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fa3ef2632e218ea0db67930a5302e17123d71d39
Author: Eric Dumazet <edumazet@google.com>
Date:   Mon Nov 9 17:51:23 2015 -0800

    net: fix a race in dst_release()
    
    [ Upstream commit d69bbf88c8d0b367cf3e3a052f6daadf630ee566 ]
    
    Only cpu seeing dst refcount going to 0 can safely
    dereference dst->flags.
    
    Otherwise an other cpu might already have freed the dst.
    
    Fixes: 27b75c95f10d ("net: avoid RCU for NOCACHE dst")
    Reported-by: Greg Thelen <gthelen@google.com>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d780d212b55d09fbc354bc541ed9c48a5d5121cc
Author: Jay Vosburgh <jay.vosburgh@canonical.com>
Date:   Fri Nov 6 17:23:23 2015 -0800

    bonding: fix panic on non-ARPHRD_ETHER enslave failure
    
    [ Upstream commit 40baec225765c54eefa870530dd613bad9829bb7 ]
    
    Since commit 7d5cd2ce529b, when bond_enslave fails on devices that
    are not ARPHRD_ETHER, if needed, it resets the bonding device back to
    ARPHRD_ETHER by calling ether_setup.
    
            Unfortunately, ether_setup clobbers dev->flags, clearing IFF_UP
    if the bond device is up, leaving it in a quasi-down state without
    having actually gone through dev_close.  For bonding, if any periodic
    work queue items are active (miimon, arp_interval, etc), those will
    remain running, as they are stopped by bond_close.  At this point, if
    the bonding module is unloaded or the bond is deleted, the system will
    panic when the work function is called.
    
            This panic is resolved by calling dev_close on the bond itself
    prior to calling ether_setup.
    
    Cc: Nikolay Aleksandrov <nikolay@cumulusnetworks.com>
    Signed-off-by: Jay Vosburgh <jay.vosburgh@canonical.com>
    Fixes: 7d5cd2ce5292 ("bonding: correctly handle bonding type change on enslave failure")
    Acked-by: Nikolay Aleksandrov <nikolay@cumulusnetworks.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f8be56fc72c4398bf2591ffbbc4ec566a20f1fa5
Author: Francesco Ruggeri <fruggeri@aristanetworks.com>
Date:   Thu Nov 5 08:16:14 2015 -0800

    packet: race condition in packet_bind
    
    [ Upstream commit 30f7ea1c2b5f5fb7462c5ae44fe2e40cb2d6a474 ]
    
    There is a race conditions between packet_notifier and packet_bind{_spkt}.
    
    It happens if packet_notifier(NETDEV_UNREGISTER) executes between the
    time packet_bind{_spkt} takes a reference on the new netdevice and the
    time packet_do_bind sets po->ifindex.
    In this case the notification can be missed.
    If this happens during a dev_change_net_namespace this can result in the
    netdevice to be moved to the new namespace while the packet_sock in the
    old namespace still holds a reference on it. When the netdevice is later
    deleted in the new namespace the deletion hangs since the packet_sock
    is not found in the new namespace' &net->packet.sklist.
    It can be reproduced with the script below.
    
    This patch makes packet_do_bind check again for the presence of the
    netdevice in the packet_sock's namespace after the synchronize_net
    in unregister_prot_hook.
    More in general it also uses the rcu lock for the duration of the bind
    to stop dev_change_net_namespace/rollback_registered_many from
    going past the synchronize_net following unlist_netdevice, so that
    no NETDEV_UNREGISTER notifications can happen on the new netdevice
    while the bind is executing. In order to do this some code from
    packet_bind{_spkt} is consolidated into packet_do_dev.
    
    import socket, os, time, sys
    proto=7
    realDev='em1'
    vlanId=400
    if len(sys.argv) > 1:
       vlanId=int(sys.argv[1])
    dev='vlan%d' % vlanId
    
    os.system('taskset -p 0x10 %d' % os.getpid())
    
    s = socket.socket(socket.PF_PACKET, socket.SOCK_RAW, proto)
    os.system('ip link add link %s name %s type vlan id %d' %
              (realDev, dev, vlanId))
    os.system('ip netns add dummy')
    
    pid=os.fork()
    
    if pid == 0:
       # dev should be moved while packet_do_bind is in synchronize net
       os.system('taskset -p 0x20000 %d' % os.getpid())
       os.system('ip link set %s netns dummy' % dev)
       os.system('ip netns exec dummy ip link del %s' % dev)
       s.close()
       sys.exit(0)
    
    time.sleep(.004)
    try:
       s.bind(('%s' % dev, proto+1))
    except:
       print 'Could not bind socket'
       s.close()
       os.system('ip netns del dummy')
       sys.exit(0)
    
    os.waitpid(pid, 0)
    s.close()
    os.system('ip netns del dummy')
    sys.exit(0)
    
    Signed-off-by: Francesco Ruggeri <fruggeri@arista.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1b27b7f6522851424a37bee71ff591307cd29176
Author: WANG Cong <xiyou.wangcong@gmail.com>
Date:   Tue Nov 3 14:32:57 2015 -0800

    ipv4: disable BH when changing ip local port range
    
    [ Upstream commit 4ee3bd4a8c7463cdef0b82ebc33fc94a9170a7e0 ]
    
    This fixes the following lockdep warning:
    
     [ INFO: inconsistent lock state ]
     4.3.0-rc7+ #1197 Not tainted
     ---------------------------------
     inconsistent {IN-SOFTIRQ-R} -> {SOFTIRQ-ON-W} usage.
     sysctl/1019 [HC0[0]:SC0[0]:HE1:SE1] takes:
      (&(&net->ipv4.ip_local_ports.lock)->seqcount){+.+-..}, at: [<ffffffff81921de7>] ipv4_local_port_range+0xb4/0x12a
     {IN-SOFTIRQ-R} state was registered at:
       [<ffffffff810bd682>] __lock_acquire+0x2f6/0xdf0
       [<ffffffff810be6d5>] lock_acquire+0x11c/0x1a4
       [<ffffffff818e599c>] inet_get_local_port_range+0x4e/0xae
       [<ffffffff8166e8e3>] udp_flow_src_port.constprop.40+0x23/0x116
       [<ffffffff81671cb9>] vxlan_xmit_one+0x219/0xa6a
       [<ffffffff81672f75>] vxlan_xmit+0xa6b/0xaa5
       [<ffffffff817f2deb>] dev_hard_start_xmit+0x2ae/0x465
       [<ffffffff817f35ed>] __dev_queue_xmit+0x531/0x633
       [<ffffffff817f3702>] dev_queue_xmit_sk+0x13/0x15
       [<ffffffff818004a5>] neigh_resolve_output+0x12f/0x14d
       [<ffffffff81959cfa>] ip6_finish_output2+0x344/0x39f
       [<ffffffff8195bf58>] ip6_finish_output+0x88/0x8e
       [<ffffffff8195bfef>] ip6_output+0x91/0xe5
       [<ffffffff819792ae>] dst_output_sk+0x47/0x4c
       [<ffffffff81979392>] NF_HOOK_THRESH.constprop.30+0x38/0x82
       [<ffffffff8197981e>] mld_sendpack+0x189/0x266
       [<ffffffff8197b28b>] mld_ifc_timer_expire+0x1ef/0x223
       [<ffffffff810de581>] call_timer_fn+0xfb/0x28c
       [<ffffffff810ded1e>] run_timer_softirq+0x1c7/0x1f1
    
    Fixes: b8f1a55639e6 ("udp: Add function to make source port for UDP tunnels")
    Cc: Tom Herbert <tom@herbertland.com>
    Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f6f9261a75f09b4fe7eb20a8c3f01391148d82a1
Author: Sabrina Dubroca <sd@queasysnail.net>
Date:   Wed Nov 4 14:47:53 2015 +0100

    ipv6: clean up dev_snmp6 proc entry when we fail to initialize inet6_dev
    
    [ Upstream commit 2a189f9e57650e9f310ddf4aad75d66c1233a064 ]
    
    In ipv6_add_dev, when addrconf_sysctl_register fails, we do not clean up
    the dev_snmp6 entry that we have already registered for this device.
    Call snmp6_unregister_dev in this case.
    
    Fixes: a317a2f19da7d ("ipv6: fail early when creating netdev named all or default")
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: Sabrina Dubroca <sd@queasysnail.net>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1ce33c2bcc40c6ccc47fdd35d2afcf8e5c74ba66
Author: Eric Dumazet <edumazet@google.com>
Date:   Mon Nov 2 07:50:07 2015 -0800

    net: avoid NULL deref in inet_ctl_sock_destroy()
    
    [ Upstream commit 8fa677d2706d325d71dab91bf6e6512c05214e37 ]
    
    Under low memory conditions, tcp_sk_init() and icmp_sk_init()
    can both iterate on all possible cpus and call inet_ctl_sock_destroy(),
    with eventual NULL pointer.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b3c940d897e6368bc553c4c30f8fbe715a53beba
Author: Martin Habets <mhabets@solarflare.com>
Date:   Mon Nov 2 12:51:31 2015 +0000

    sfc: push partner queue for skb->xmit_more
    
    [ Upstream commit b2663a4f30e85ec606b806f5135413e6d5c78d1e ]
    
    When the IP stack passes SKBs the sfc driver puts them in 2 different TX
    queues (called partners), one for checksummed and one for not checksummed.
    If the SKB has xmit_more set the driver will delay pushing the work to the
    NIC.
    
    When later it does decide to push the buffers this patch ensures it also
    pushes the partner queue, if that also has any delayed work. Before this
    fix the work in the partner queue would be left for a long time and cause
    a netdev watchdog.
    
    Fixes: 70b33fb ("sfc: add support for skb->xmit_more")
    Reported-by: Jianlin Shi <jishi@redhat.com>
    Signed-off-by: Martin Habets <mhabets@solarflare.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0d0f84afb765a770c2b7bff8788aa01d3a9ef024
Author: Eric Dumazet <edumazet@google.com>
Date:   Mon Nov 2 17:08:19 2015 -0800

    sit: fix sit0 percpu double allocations
    
    [ Upstream commit 4ece9009774596ee3df0acba65a324b7ea79387c ]
    
    sit0 device allocates its percpu storage twice :
    - One time in ipip6_tunnel_init()
    - One time in ipip6_fb_tunnel_init()
    
    Thus we leak 48 bytes per possible cpu per network namespace dismantle.
    
    ipip6_fb_tunnel_init() can be much simpler and does not
    return an error, and should be called after register_netdev()
    
    Note that ipip6_tunnel_clone_6rd() also needs to be called
    after register_netdev() (calling ipip6_tunnel_init())
    
    Fixes: ebe084aafb7e ("sit: Use ipip6_tunnel_init as the ndo_init function.")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Cc: Steffen Klassert <steffen.klassert@secunet.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 176dae31a5901158a77986d260d02e55d437a0e8
Author: Ani Sinha <ani@arista.com>
Date:   Fri Oct 30 16:54:31 2015 -0700

    ipmr: fix possible race resulting from improper usage of IP_INC_STATS_BH() in preemptible context.
    
    [ Upstream commit 44f49dd8b5a606870a1f21101522a0f9c4414784 ]
    
    Fixes the following kernel BUG :
    
    BUG: using __this_cpu_add() in preemptible [00000000] code: bash/2758
    caller is __this_cpu_preempt_check+0x13/0x15
    CPU: 0 PID: 2758 Comm: bash Tainted: P           O   3.18.19 #2
     ffffffff8170eaca ffff880110d1b788 ffffffff81482b2a 0000000000000000
     0000000000000000 ffff880110d1b7b8 ffffffff812010ae ffff880007cab800
     ffff88001a060800 ffff88013a899108 ffff880108b84240 ffff880110d1b7c8
    Call Trace:
    [<ffffffff81482b2a>] dump_stack+0x52/0x80
    [<ffffffff812010ae>] check_preemption_disabled+0xce/0xe1
    [<ffffffff812010d4>] __this_cpu_preempt_check+0x13/0x15
    [<ffffffff81419d60>] ipmr_queue_xmit+0x647/0x70c
    [<ffffffff8141a154>] ip_mr_forward+0x32f/0x34e
    [<ffffffff8141af76>] ip_mroute_setsockopt+0xe03/0x108c
    [<ffffffff810553fc>] ? get_parent_ip+0x11/0x42
    [<ffffffff810e6974>] ? pollwake+0x4d/0x51
    [<ffffffff81058ac0>] ? default_wake_function+0x0/0xf
    [<ffffffff810553fc>] ? get_parent_ip+0x11/0x42
    [<ffffffff810613d9>] ? __wake_up_common+0x45/0x77
    [<ffffffff81486ea9>] ? _raw_spin_unlock_irqrestore+0x1d/0x32
    [<ffffffff810618bc>] ? __wake_up_sync_key+0x4a/0x53
    [<ffffffff8139a519>] ? sock_def_readable+0x71/0x75
    [<ffffffff813dd226>] do_ip_setsockopt+0x9d/0xb55
    [<ffffffff81429818>] ? unix_seqpacket_sendmsg+0x3f/0x41
    [<ffffffff813963fe>] ? sock_sendmsg+0x6d/0x86
    [<ffffffff813959d4>] ? sockfd_lookup_light+0x12/0x5d
    [<ffffffff8139650a>] ? SyS_sendto+0xf3/0x11b
    [<ffffffff810d5738>] ? new_sync_read+0x82/0xaa
    [<ffffffff813ddd19>] compat_ip_setsockopt+0x3b/0x99
    [<ffffffff813fb24a>] compat_raw_setsockopt+0x11/0x32
    [<ffffffff81399052>] compat_sock_common_setsockopt+0x18/0x1f
    [<ffffffff813c4d05>] compat_SyS_setsockopt+0x1a9/0x1cf
    [<ffffffff813c4149>] compat_SyS_socketcall+0x180/0x1e3
    [<ffffffff81488ea1>] cstar_dispatch+0x7/0x1e
    
    Signed-off-by: Ani Sinha <ani@arista.com>
    Acked-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 912bd0daa23af0c2841404eced4c0ed324495813
Author: Phil Reid <preid@electromag.com.au>
Date:   Fri Oct 30 16:43:55 2015 +0800

    stmmac: Correctly report PTP capabilities.
    
    [ Upstream commit e6dbe1eb2db0d7a14991c06278dd3030c45fb825 ]
    
    priv->hwts_*_en indicate if timestamping is enabled/disabled at run
    time. But  priv->dma_cap.time_stamp  and priv->dma_cap.atime_stamp
    indicates HW is support for PTPv1/PTPv2.
    
    Signed-off-by: Phil Reid <preid@electromag.com.au>
    Acked-by: Richard Cochran <richardcochran@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d5f4b22792972ecbf5984a6b482793a9edff523d
Author: Julian Anastasov <ja@ssi.bg>
Date:   Fri Oct 30 10:23:34 2015 +0200

    ipv4: update RTNH_F_LINKDOWN flag on UP event
    
    [ Upstream commit c9b3292eeb52c6834e972eb5b8fe38914771ed12 ]
    
    When nexthop is part of multipath route we should clear the
    LINKDOWN flag when link goes UP or when first address is added.
    This is needed because we always set LINKDOWN flag when DEAD flag
    was set but now on UP the nexthop is not dead anymore. Examples when
    LINKDOWN bit can be forgotten when no NETDEV_CHANGE is delivered:
    
    - link goes down (LINKDOWN is set), then link goes UP and device
    shows carrier OK but LINKDOWN remains set
    
    - last address is deleted (LINKDOWN is set), then address is
    added and device shows carrier OK but LINKDOWN remains set
    
    Steps to reproduce:
    modprobe dummy
    ifconfig dummy0 192.168.168.1 up
    
    here add a multipath route where one nexthop is for dummy0:
    
    ip route add 1.2.3.4 nexthop dummy0 nexthop SOME_OTHER_DEVICE
    ifconfig dummy0 down
    ifconfig dummy0 up
    
    now ip route shows nexthop that is not dead. Now set the sysctl var:
    
    echo 1 > /proc/sys/net/ipv4/conf/dummy0/ignore_routes_with_linkdown
    
    now ip route will show a dead nexthop because the forgotten
    RTNH_F_LINKDOWN is propagated as RTNH_F_DEAD.
    
    Fixes: 8a3d03166f19 ("net: track link-status of ipv4 nexthops")
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ee256463e827ce5cf65e290d0c2852852662a489
Author: Julian Anastasov <ja@ssi.bg>
Date:   Fri Oct 30 10:23:33 2015 +0200

    ipv4: fix to not remove local route on link down
    
    [ Upstream commit 4f823defdd5b106a5e89745ee8b163c71855de1e ]
    
    When fib_netdev_event calls fib_disable_ip on NETDEV_DOWN event
    we should not delete the local routes if the local address
    is still present. The confusion comes from the fact that both
    fib_netdev_event and fib_inetaddr_event use the NETDEV_DOWN
    constant. Fix it by returning back the variable 'force'.
    
    Steps to reproduce:
    modprobe dummy
    ifconfig dummy0 192.168.168.1 up
    ifconfig dummy0 down
    ip route list table local | grep dummy | grep host
    local 192.168.168.1 dev dummy0  proto kernel  scope host  src 192.168.168.1
    
    Fixes: 8a3d03166f19 ("net: track link-status of ipv4 nexthops")
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2d52c83a9f8c8eaef7e1f14b2c011d60339c8d03
Author: Jon Paul Maloy <jon.maloy@ericsson.com>
Date:   Wed Oct 28 13:09:53 2015 -0400

    tipc: linearize arriving NAME_DISTR and LINK_PROTO buffers
    
    [ Upstream commit 5cbb28a4bf65c7e4daa6c25b651fed8eb888c620 ]
    
    Testing of the new UDP bearer has revealed that reception of
    NAME_DISTRIBUTOR, LINK_PROTOCOL/RESET and LINK_PROTOCOL/ACTIVATE
    message buffers is not prepared for the case that those may be
    non-linear.
    
    We now linearize all such buffers before they are delivered up to the
    generic reception layer.
    
    In order for the commit to apply cleanly to 'net' and 'stable', we do
    the change in the function tipc_udp_recv() for now. Later, we will post
    a commit to 'net-next' moving the linearization to generic code, in
    tipc_named_rcv() and tipc_link_proto_rcv().
    
    Fixes: commit d0f91938bede ("tipc: add ip/udp media type")
    Signed-off-by: Jon Maloy <jon.maloy@ericsson.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 769053d221a67da8357b6713890041d3ecb41aad
Author: Carol L Soto <clsoto@linux.vnet.ibm.com>
Date:   Tue Oct 27 17:36:20 2015 +0200

    net/mlx4: Copy/set only sizeof struct mlx4_eqe bytes
    
    [ Upstream commit c02b05011fadf8e409e41910217ca689f2fc9d91 ]
    
    When doing memcpy/memset of EQEs, we should use sizeof struct
    mlx4_eqe as the base size and not caps.eqe_size which could be bigger.
    
    If caps.eqe_size is bigger than the struct mlx4_eqe then we corrupt
    data in the master context.
    
    When using a 64 byte stride, the memcpy copied over 63 bytes to the
    slave_eq structure.  This resulted in copying over the entire eqe of
    interest, including its ownership bit -- and also 31 bytes of garbage
    into the next WQE in the slave EQ -- which did NOT include the ownership
    bit (and therefore had no impact).
    
    However, once the stride is increased to 128, we are overwriting the
    ownership bits of *three* eqes in the slave_eq struct.  This results
    in an incorrect ownership bit for those eqes, which causes the eq to
    seem to be full. The issue therefore surfaced only once 128-byte EQEs
    started being used in SRIOV and (overarchitectures that have 128/256
    byte cache-lines such as PPC) - e.g after commit 77507aa249ae
    "net/mlx4_core: Enable CQE/EQE stride support".
    
    Fixes: 08ff32352d6f ('mlx4: 64-byte CQE/EQE support')
    Signed-off-by: Carol L Soto <clsoto@linux.vnet.ibm.com>
    Signed-off-by: Jack Morgenstein <jackm@dev.mellanox.co.il>
    Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit aee5e801d81f1d5f509cc105ae15568214919f62
Author: Sowmini Varadhan <sowmini.varadhan@oracle.com>
Date:   Mon Oct 26 12:46:37 2015 -0400

    RDS-TCP: Recover correctly from pskb_pull()/pksb_trim() failure in rds_tcp_data_recv
    
    [ Upstream commit 8ce675ff39b9958d1c10f86cf58e357efaafc856 ]
    
    Either of pskb_pull() or pskb_trim() may fail under low memory conditions.
    If rds_tcp_data_recv() ignores such failures, the application will
    receive corrupted data because the skb has not been correctly
    carved to the RDS datagram size.
    
    Avoid this by handling pskb_pull/pskb_trim failure in the same
    manner as the skb_clone failure: bail out of rds_tcp_data_recv(), and
    retry via the deferred call to rds_send_worker() that gets set up on
    ENOMEM from rds_tcp_read_sock()
    
    Signed-off-by: Sowmini Varadhan <sowmini.varadhan@oracle.com>
    Acked-by: Santosh Shilimkar <santosh.shilimkar@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 438da3c1178949a52f4a96af8de4ea2476c5e9c9
Author: Alexander Duyck <aduyck@mirantis.com>
Date:   Tue Oct 27 15:06:45 2015 -0700

    fib_trie: leaf_walk_rcu should not compute key if key is less than pn->key
    
    [ Upstream commit c2229fe1430d4e1c70e36520229dd64a87802b20 ]
    
    We were computing the child index in cases where the key value we were
    looking for was actually less than the base key of the tnode.  As a result
    we were getting incorrect index values that would cause us to skip over
    some children.
    
    To fix this I have added a test that will force us to use child index 0 if
    the key we are looking for is less than the key of the current tnode.
    
    Fixes: 8be33e955cb9 ("fib_trie: Fib walk rcu should take a tnode and key instead of a trie and a leaf")
    Reported-by: Brian Rak <brak@gameservers.com>
    Signed-off-by: Alexander Duyck <aduyck@mirantis.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e8b3a1a94d0aea81385adb9561ec17b38d0ba860
Author: Maciej S. Szmigiero <mail@maciej.szmigiero.name>
Date:   Thu Sep 3 21:38:30 2015 +0200

    net: fec: normalize return value of pm_runtime_get_sync() in MDIO write
    
    [ Upstream commit 42ea4457aea7aaeddf0c0b06724f297608f5e9d2 ]
    
    If fec MDIO write method succeeds its return value comes from
    call to pm_runtime_get_sync().
    But pm_runtime_get_sync() can also return 1.
    
    In case of Micrel KSZ9031 PHY this value will then
    be returned along the call chain of phy_write() ->
    ksz9031_extended_write() -> ksz9031_center_flp_timing() ->
    ksz9031_config_init() -> phy_init_hw() -> phy_attach_direct() ->
    phy_connect_direct().
    
    Then phy_connect() will cast it into a pointer using ERR_PTR(),
    which then fec_enet_mii_probe() will try to dereference
    resulting in an oops.
    
    Fix it by normalizing return value of pm_runtime_get_sync()
    to be zero if positive in MDIO write method.
    
    Fixes: 8fff755e9f8d ("net: fec: Ensure clocks are enabled while using mdio bus")
    Signed-off-by: Maciej Szmigiero <mail@maciej.szmigiero.name>
    Acked-by: Andrew Lunn <andrew@lunn.ch>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0a7f9f1c37ef991a13dfeedd9709a7020a35d321
Author: Eric Dumazet <edumazet@google.com>
Date:   Sat Oct 24 05:47:44 2015 -0700

    ipv6: gre: support SIT encapsulation
    
    [ Upstream commit 7e3b6e7423d5f994257c1de88e06b509673fdbcf ]
    
    gre_gso_segment() chokes if SIT frames were aggregated by GRO engine.
    
    Fixes: 61c1db7fae21e ("ipv6: sit: add GSO/TSO support")
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 914eba928de4ef337deecee507b889d27d5ac592
Author: Fabio Estevam <fabio.estevam@freescale.com>
Date:   Wed Aug 12 12:10:23 2015 -0300

    net: fec: Remove unneeded use of IS_ERR_VALUE() macro
    
    [ Upstream commit b0c6ce24911fcb64715de9569f0f7b4f54d1d045 ]
    
    There is no need to use the IS_ERR_VALUE() macro for checking
    the return value from pm_runtime_* functions.
    
    Just do a simple negative test instead.
    
    The semantic patch that makes this change is available
    in scripts/coccinelle/api/pm_runtime.cocci.
    
    Signed-off-by: Fabio Estevam <fabio.estevam@freescale.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6077315234f4c83dbacd4ba6456856df7f1c17ed
Author: Lendacky, Thomas <Thomas.Lendacky@amd.com>
Date:   Mon Oct 26 17:13:54 2015 -0500

    amd-xgbe: Fix race between access of desc and desc index
    
    [ Upstream commit 20986ed826cbb36bb8f2d77f872e3c52d8d30647 ]
    
    During Tx cleanup it's still possible for the descriptor data to be
    read ahead of the descriptor index. A memory barrier is required between
    the read of the descriptor index and the start of the Tx cleanup loop.
    This allows a change to a lighter-weight barrier in the Tx transmit
    routine just before updating the current descriptor index.
    
    Since the memory barrier does result in extra overhead on arm64, keep
    the previous change to not chase the current descriptor value. This
    prevents the execution of the barrier for each loop performed.
    
    Suggested-by: Alexander Duyck <alexander.duyck@gmail.com>
    Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3bc6cb1eeee449c1e30df02dd5e59b3d8d768a5c
Author: Lendacky, Thomas <Thomas.Lendacky@amd.com>
Date:   Wed Oct 21 15:37:05 2015 -0500

    amd-xgbe: Use wmb before updating current descriptor count
    
    [ Upstream commit 20a41fba679d665cdae2808e2b9cae97c073351f ]
    
    The code currently uses the lightweight dma_wmb barrier before updating
    the current descriptor count. Under heavy load, the Tx cleanup routine
    was seeing the updated current descriptor count before the updated
    descriptor information. As a result, the Tx descriptor was being cleaned
    up before it was used because it was not "owned" by the hardware yet,
    resulting in a Tx queue hang.
    
    Using the wmb barrier insures that the descriptor is updated before the
    descriptor counter preventing the Tx queue hang. For extra insurance,
    the Tx cleanup routine is changed to grab the current decriptor count on
    entry and uses that initial value in the processing loop rather than
    trying to chase the current value.
    
    Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
    Tested-by: Christoffer Dall <christoffer.dall@linaro.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8edcc554fb85b929844363d2ec6a0316a3007366
Author: Guillaume Nault <g.nault@alphalink.fr>
Date:   Thu Oct 22 16:57:10 2015 +0200

    ppp: fix pppoe_dev deletion condition in pppoe_release()
    
    [ Upstream commit 1acea4f6ce1b1c0941438aca75dd2e5c6b09db60 ]
    
    We can't rely on PPPOX_ZOMBIE to decide whether to clear po->pppoe_dev.
    PPPOX_ZOMBIE can be set by pppoe_disc_rcv() even when po->pppoe_dev is
    NULL. So we have no guarantee that (sk->sk_state & PPPOX_ZOMBIE) implies
    (po->pppoe_dev != NULL).
    Since we're releasing a PPPoE socket, we want to release the pppoe_dev
    if it exists and reset sk_state to PPPOX_DEAD, no matter the previous
    value of sk_state. So we can just check for po->pppoe_dev and avoid any
    assumption on sk->sk_state.
    
    Fixes: 2b018d57ff18 ("pppoe: drop PPPOX_ZOMBIEs in pppoe_release")
    Signed-off-by: Guillaume Nault <g.nault@alphalink.fr>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bd71bc5efc6ee83c4aa2f2515ad72430c84a9c00
Author: Jason Wang <jasowang@redhat.com>
Date:   Fri Oct 23 00:57:05 2015 -0400

    macvtap: unbreak receiving of gro skb with frag list
    
    [ Upstream commit f23d538bc24a83c16127c2eb82c9cf1adc2b5149 ]
    
    We don't have fraglist support in TAP_FEATURES. This will lead
    software segmentation of gro skb with frag list. Fixes by having
    frag list support in TAP_FEATURES.
    
    With this patch single session of netperf receiving were restored from
    about 5Gb/s to about 12Gb/s on mlx4.
    
    Fixes a567dd6252 ("macvtap: simplify usage of tap_features")
    Cc: Vlad Yasevich <vyasevic@redhat.com>
    Cc: Michael S. Tsirkin <mst@redhat.com>
    Signed-off-by: Jason Wang <jasowang@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7eaa9188e51d5d1584ba58bcdfa4395ae371aeed
Author: Bjørn Mork <bjorn@mork.no>
Date:   Thu Oct 22 14:15:58 2015 +0200

    qmi_wwan: add Sierra Wireless MC74xx/EM74xx
    
    [ Upstream commit 0db65fcfcded76fe4f74e3ca9f4e2baf67b683ef ]
    
    New device IDs shamelessly lifted from the vendor driver.
    
    Signed-off-by: Bjørn Mork <bjorn@mork.no>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit aa23ddc33c318841c3e856665e4c7fd0b432a1f5
Author: David Herrmann <dh.herrmann@gmail.com>
Date:   Wed Oct 21 11:47:43 2015 +0200

    netlink: fix locking around NETLINK_LIST_MEMBERSHIPS
    
    [ Upstream commit 47191d65b647af5eb5c82ede70ed4c24b1e93ef4 ]
    
    Currently, NETLINK_LIST_MEMBERSHIPS grabs the netlink table while copying
    the membership state to user-space. However, grabing the netlink table is
    effectively a write_lock_irq(), and as such we should not be triggering
    page-faults in the critical section.
    
    This can be easily reproduced by the following snippet:
        int s = socket(AF_NETLINK, SOCK_RAW, NETLINK_ROUTE);
        void *p = mmap(0, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, -1, 0);
        int r = getsockopt(s, 0x10e, 9, p, (void*)((char*)p + 4092));
    
    This should work just fine, but currently triggers EFAULT and a possible
    WARN_ON below handle_mm_fault().
    
    Fix this by reducing locking of NETLINK_LIST_MEMBERSHIPS to a read-side
    lock. The write-lock was overkill in the first place, and the read-lock
    allows page-faults just fine.
    
    Reported-by: Dmitry Vyukov <dvyukov@google.com>
    Signed-off-by: David Herrmann <dh.herrmann@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9a14758e5ab97d4da8813d5dec0c2d5cbe8458d0
Author: Renato Westphal <renatowestphal@gmail.com>
Date:   Mon Oct 19 18:51:34 2015 -0200

    tcp: remove improper preemption check in tcp_xmit_probe_skb()
    
    [ Upstream commit e2e8009ff72ad2a795b67785f3238af152146368 ]
    
    Commit e520af48c7e5a introduced the following bug when setting the
    TCP_REPAIR sockoption:
    
    [ 2860.657036] BUG: using __this_cpu_add() in preemptible [00000000] code: daemon/12164
    [ 2860.657045] caller is __this_cpu_preempt_check+0x13/0x20
    [ 2860.657049] CPU: 1 PID: 12164 Comm: daemon Not tainted 4.2.3 #1
    [ 2860.657051] Hardware name: Dell Inc. PowerEdge R210 II/0JP7TR, BIOS 2.0.5 03/13/2012
    [ 2860.657054]  ffffffff81c7f071 ffff880231e9fdf8 ffffffff8185d765 0000000000000002
    [ 2860.657058]  0000000000000001 ffff880231e9fe28 ffffffff8146ed91 ffff880231e9fe18
    [ 2860.657062]  ffffffff81cd1a5d ffff88023534f200 ffff8800b9811000 ffff880231e9fe38
    [ 2860.657065] Call Trace:
    [ 2860.657072]  [<ffffffff8185d765>] dump_stack+0x4f/0x7b
    [ 2860.657075]  [<ffffffff8146ed91>] check_preemption_disabled+0xe1/0xf0
    [ 2860.657078]  [<ffffffff8146edd3>] __this_cpu_preempt_check+0x13/0x20
    [ 2860.657082]  [<ffffffff817e0bc7>] tcp_xmit_probe_skb+0xc7/0x100
    [ 2860.657085]  [<ffffffff817e1e2d>] tcp_send_window_probe+0x2d/0x30
    [ 2860.657089]  [<ffffffff817d1d8c>] do_tcp_setsockopt.isra.29+0x74c/0x830
    [ 2860.657093]  [<ffffffff817d1e9c>] tcp_setsockopt+0x2c/0x30
    [ 2860.657097]  [<ffffffff81767b74>] sock_common_setsockopt+0x14/0x20
    [ 2860.657100]  [<ffffffff817669e1>] SyS_setsockopt+0x71/0xc0
    [ 2860.657104]  [<ffffffff81865172>] entry_SYSCALL_64_fastpath+0x16/0x75
    
    Since tcp_xmit_probe_skb() can be called from process context, use
    NET_INC_STATS() instead of NET_INC_STATS_BH().
    
    Fixes: e520af48c7e5 ("tcp: add TCPWinProbe and TCPKeepAlive SNMP counters")
    Signed-off-by: Renato Westphal <renatow@taghos.com.br>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c19282fd54a19e4651a4e67836cd842082546677
Author: Jon Paul Maloy <jon.maloy@ericsson.com>
Date:   Mon Oct 19 11:33:00 2015 -0400

    tipc: allow non-linear first fragment buffer
    
    [ Upstream commit 45c8b7b175ceb2d542e0fe15247377bf3bce29ec ]
    
    The current code for message reassembly is erroneously assuming that
    the the first arriving fragment buffer always is linear, and then goes
    ahead resetting the fragment list of that buffer in anticipation of
    more arriving fragments.
    
    However, if the buffer already happens to be non-linear, we will
    inadvertently drop the already attached fragment list, and later
    on trig a BUG() in __pskb_pull_tail().
    
    We see this happen when running fragmented TIPC multicast across UDP,
    something made possible since
    commit d0f91938bede ("tipc: add ip/udp media type")
    
    We fix this by not resetting the fragment list when the buffer is non-
    linear, and by initiatlizing our private fragment list tail pointer to
    the tail of the existing fragment list.
    
    Fixes: commit d0f91938bede ("tipc: add ip/udp media type")
    Signed-off-by: Jon Maloy <jon.maloy@ericsson.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 87056ada2a1d6906db244551a33f8f439d8d1af1
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Mon Oct 19 13:16:49 2015 +0300

    irda: precedence bug in irlmp_seq_hb_idx()
    
    [ Upstream commit 50010c20597d14667eff0fdb628309986f195230 ]
    
    This is decrementing the pointer, instead of the value stored in the
    pointer.  KASan detects it as an out of bounds reference.
    
    Reported-by: "Berry Cheng 程君(成淼)" <chengmiao.cj@alibaba-inc.com>
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
