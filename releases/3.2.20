commit 7313dd1519ea5cd81f67bc26b180e472d102ff88
Author: Ben Hutchings <ben@decadent.org.uk>
Date:   Sun Jun 10 14:42:13 2012 +0100

    Linux 3.2.20

commit 76f4fa4be06ea1de34b0cf441d97fe1916bb4b6e
Author: Theodore Ts'o <tytso@mit.edu>
Date:   Thu Jun 7 18:56:06 2012 -0400

    ext4: fix the free blocks calculation for ext3 file systems w/ uninit_bg
    
    commit b0dd6b70f0fda17ae9762fbb72d98e40a4f66556 upstream.
    
    Ext3 filesystems that are converted to use as many ext4 file system
    features as possible will enable uninit_bg to speed up e2fsck times.
    These file systems will have a native ext3 layout of inode tables and
    block allocation bitmaps (as opposed to ext4's flex_bg layout).
    Unfortunately, in these cases, when first allocating a block in an
    uninitialized block group, ext4 would incorrectly calculate the number
    of free blocks in that block group, and then errorneously report that
    the file system was corrupt:
    
    EXT4-fs error (device vdd): ext4_mb_generate_buddy:741: group 30, 32254 clusters in bitmap, 32258 in gd
    
    This problem can be reproduced via:
    
        mke2fs -q -t ext4 -O ^flex_bg /dev/vdd 5g
        mount -t ext4 /dev/vdd /mnt
        fallocate -l 4600m /mnt/test
    
    The problem was caused by a bone headed mistake in the check to see if a
    particular metadata block was part of the block group.
    
    Many thanks to Kees Cook for finding and bisecting the buggy commit
    which introduced this bug (commit fd034a84e1, present since v3.2).
    
    Reported-by: Sander Eikelenboom <linux@eikelenboom.it>
    Reported-by: Kees Cook <keescook@chromium.org>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Tested-by: Kees Cook <keescook@chromium.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 11c8b786fffcb89514892ba36fba10bf3d46310b
Author: Tao Ma <boyu.mt@taobao.com>
Date:   Thu Jun 7 19:04:19 2012 -0400

    ext4: don't set i_flags in EXT4_IOC_SETFLAGS
    
    commit b22b1f178f6799278d3178d894f37facb2085765 upstream.
    
    Commit 7990696 uses the ext4_{set,clear}_inode_flags() functions to
    change the i_flags automatically but fails to remove the error setting
    of i_flags.  So we still have the problem of trashing state flags.
    Fix this by removing the assignment.
    
    Signed-off-by: Tao Ma <boyu.mt@taobao.com>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 8de426390253cabdcfc7e46b53d2d56c894d23bf
Author: Theodore Ts'o <tytso@mit.edu>
Date:   Thu May 31 23:46:01 2012 -0400

    ext4: don't trash state flags in EXT4_IOC_SETFLAGS
    
    commit 79906964a187c405db72a3abc60eb9b50d804fbc upstream.
    
    In commit 353eb83c we removed i_state_flags with 64-bit longs, But
    when handling the EXT4_IOC_SETFLAGS ioctl, we replace i_flags
    directly, which trashes the state flags which are stored in the high
    32-bits of i_flags on 64-bit platforms.  So use the the
    ext4_{set,clear}_inode_flags() functions which use atomic bit
    manipulation functions instead.
    
    Reported-by: Tao Ma <boyu.mt@taobao.com>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit a466c7f9d6e61fb19c2d49f82007a0700724a1e3
Author: Eric Dumazet <edumazet@google.com>
Date:   Mon May 28 22:31:41 2012 +0000

    asix: allow full size 8021Q frames to be received
    
    commit 9dae31009b1a00d926c6fe032d5a88099620adc3 upstream.
    
    asix driver drops 8021Q full size frames because it doesn't take into
    account VLAN header size.
    
    Tested on AX88772 adapter.
    
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    CC: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    CC: Allan Chou <allan@asix.com.tw>
    CC: Trond Wuellner <trond@chromium.org>
    CC: Grant Grundler <grundler@chromium.org>
    CC: Paul Stewart <pstew@chromium.org>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    [bwh: Backported to 3.2: no offset used in asix_rx_fixup()]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 3798a7b34a19617eda5ce4b3025634b93b638de9
Author: Ulrich Drepper <drepper@akkadia.org>
Date:   Tue May 29 15:06:30 2012 -0700

    kbuild: install kernel-page-flags.h
    
    commit 9295b7a07c859a42346221b5839be0ae612333b0 upstream.
    
    Programs using /proc/kpageflags need to know about the various flags.  The
    <linux/kernel-page-flags.h> provides them and the comments in the file
    indicate that it is supposed to be used by user-level code.  But the file
    is not installed.
    
    Install the headers and mark the unstable flags as out-of-bounds.  The
    page-type tool is also adjusted to not duplicate the definitions
    
    Signed-off-by: Ulrich Drepper <drepper@gmail.com>
    Acked-by: KOSAKI Motohiro <kosaki.motohiro@jp.fujitsu.com>
    Acked-by: Fengguang Wu <fengguang.wu@intel.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    [bwh: Backported to 3.2: adjust context; drop change to missing tools/vm/]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 043d295af99c056807d9647fe9fa8dd784a9ebb5
Author: Roland Dreier <roland@purestorage.com>
Date:   Thu Jun 7 14:21:13 2012 -0700

    btree: fix tree corruption in btree_get_prev()
    
    commit cbf8ae32f66a9ceb8907ad9e16663c2a29e48990 upstream.
    
    The memory the parameter __key points to is used as an iterator in
    btree_get_prev(), so if we save off a bkey() pointer in retry_key and
    then assign that to __key, we'll end up corrupting the btree internals
    when we do eg
    
            longcpy(__key, bkey(geo, node, i), geo->keylen);
    
    to return the key value.  What we should do instead is use longcpy() to
    copy the key value that retry_key points to __key.
    
    This can cause a btree to get corrupted by seemingly read-only
    operations such as btree_for_each_safe.
    
    [akpm@linux-foundation.org: avoid the double longcpy()]
    Signed-off-by: Roland Dreier <roland@purestorage.com>
    Acked-by: Joern Engel <joern@logfs.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 74886d5f1a04e444f910d0e09e288793690bec96
Author: Alex Deucher <alexander.deucher@amd.com>
Date:   Tue Jun 5 09:50:30 2012 -0400

    drm/radeon/kms: add new BTC PCI ids
    
    commit a2bef8ce826dd1e787fd8ad9b6e0566ba59dab43 upstream.
    
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 6326101a9f9683c41a6c58178fdd28ab2335e6d8
Author: Alex Deucher <alexander.deucher@amd.com>
Date:   Tue Jun 5 09:50:29 2012 -0400

    drm/radeon/kms: add new Palm, Sumo PCI ids
    
    commit 4a6991cc1fad514745b79181df3ace72d561e7aa upstream.
    
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    [bwh: Backported to 3.2: adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit bbabaefbc4571546dd98da1fef0efcd8e3d94b3d
Author: Joerg Roedel <joerg.roedel@amd.com>
Date:   Thu May 31 17:38:11 2012 +0200

    iommu/amd: Cache pdev pointer to root-bridge
    
    commit c1bf94ec1e12d76838ad485158aecf208ebd8fb9 upstream.
    
    At some point pci_get_bus_and_slot started to enable
    interrupts. Since this function is used in the
    amd_iommu_resume path it will enable interrupts on resume
    which causes a warning. The fix will use a cached pointer
    to the root-bridge to re-enable the IOMMU in case the BIOS
    is broken.
    
    Signed-off-by: Joerg Roedel <joerg.roedel@amd.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 2492cd118dc5221953054e58f3fd81927b8beda9
Author: Nicholas Bellinger <nab@linux-iscsi.org>
Date:   Wed May 30 16:25:41 2012 -0700

    target/file: Use O_DSYNC by default for FILEIO backends
    
    commit a4dff3043c231d57f982af635c9d2192ee40e5ae upstream.
    
    Convert to use O_DSYNC for all cases at FILEIO backend creation time to
    avoid the extra syncing of pure timestamp updates with legacy O_SYNC during
    default operation as recommended by hch.  Continue to do this independently of
    Write Cache Enable (WCE) bit, as WCE=0 is currently the default for all backend
    devices and enabled by user on per device basis via attrib/emulate_write_cache.
    
    This patch drops the now unnecessary fd_buffered_io= token usage that was
    originally signalling when to explictly disable O_SYNC at backend creation
    time for buffered I/O operation.  This can end up being dangerous for a number
    of reasons during physical node failure, so go ahead and drop this option
    for now when O_DSYNC is used as the default.
    
    Also allow explict FUA WRITEs -> vfs_fsync_range() call to function in
    fd_execute_cmd() independently of WCE bit setting.
    
    Reported-by: Christoph Hellwig <hch@lst.de>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
    [bwh: Backported to 3.2:
     - We have fd_do_task() and not fd_execute_cmd()
     - Various fields are in struct se_task rather than struct se_cmd
     - fd_create_virtdevice() flags initialisation hasn't been cleaned up]

commit 7d094819d85c415f785e4680e48d7cef3fa51f71
Author: Andy Whitcroft <apw@canonical.com>
Date:   Thu May 3 14:48:26 2012 +0100

    ACPI battery: only refresh the sysfs files when pertinent information changes
    
    commit c5971456964290da7e98222892797b71ef793e62 upstream.
    
    We only need to regenerate the sysfs files when the capacity units
    change, avoid the update otherwise.
    
    The origin of this issue is dates way back to 2.6.38:
    da8aeb92d4853f37e281f11fddf61f9c7d84c3cd
    (ACPI / Battery: Update information on info notification and resume)
    
    Signed-off-by: Andy Whitcroft <apw@canonical.com>
    Tested-by: Ralf Jung <post@ralfj.de>
    Signed-off-by: Len Brown <len.brown@intel.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit f7687e882a0bbdc0bbd60613ed170d5fa4d55a44
Author: Benjamin Poirier <bpoirier@suse.de>
Date:   Thu May 24 11:32:38 2012 +0000

    xfrm: take net hdr len into account for esp payload size calculation
    
    [ Upstream commit 91657eafb64b4cb53ec3a2fbc4afc3497f735788 ]
    
    Corrects the function that determines the esp payload size. The calculations
    done in esp{4,6}_get_mtu() lead to overlength frames in transport mode for
    certain mtu values and suboptimal frames for others.
    
    According to what is done, mainly in esp{,6}_output() and tcp_mtu_to_mss(),
    net_header_len must be taken into account before doing the alignment
    calculation.
    
    Signed-off-by: Benjamin Poirier <bpoirier@suse.de>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit eaa74c53680f04bc6f9e79d930c532fb58d818d3
Author: Felix Fietkau <nbd@openwrt.org>
Date:   Tue May 29 03:35:08 2012 +0000

    skb: avoid unnecessary reallocations in __skb_cow
    
    [ Upstream commit 617c8c11236716dcbda877e764b7bf37c6fd8063 ]
    
    At the beginning of __skb_cow, headroom gets set to a minimum of
    NET_SKB_PAD. This causes unnecessary reallocations if the buffer was not
    cloned and the headroom is just below NET_SKB_PAD, but still more than the
    amount requested by the caller.
    This was showing up frequently in my tests on VLAN tx, where
    vlan_insert_tag calls skb_cow_head(skb, VLAN_HLEN).
    
    Locally generated packets should have enough headroom, and for forward
    paths, we already have NET_SKB_PAD bytes of headroom, so we don't need to
    add any extra space here.
    
    Signed-off-by: Felix Fietkau <nbd@openwrt.org>
    Signed-off-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit ba9ee5eb730f20bab874ba91d3dfec7816459dad
Author: Nicolas Dichtel <nicolas.dichtel@6wind.com>
Date:   Fri May 4 05:24:54 2012 +0000

    sctp: check cached dst before using it
    
    [ Upstream commit e0268868ba064980488fc8c194db3d8e9fb2959c ]
    
    dst_check() will take care of SA (and obsolete field), hence
    IPsec rekeying scenario is taken into account.
    
    Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
    Acked-by: Vlad Yaseivch <vyasevich@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 0fc2cf738f345db9798e546a70810c5984aed214
Author: David S. Miller <davem@davemloft.net>
Date:   Thu May 10 23:03:34 2012 -0400

    Revert "net: maintain namespace isolation between vlan and real device"
    
    [ Upstream commit 59b9997baba5242997ddc7bd96b1391f5275a5a4 ]
    
    This reverts commit 8a83a00b0735190384a348156837918271034144.
    
    It causes regressions for S390 devices, because it does an
    unconditional DST drop on SKBs for vlans and the QETH device
    needs the neighbour entry hung off the DST for certain things
    on transmit.
    
    Arnd can't remember exactly why he even needed this change.
    
    Conflicts:
    
            drivers/net/macvlan.c
            net/8021q/vlan_dev.c
            net/core/dev.c
    
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit a549123336c6afafcf2fd2eea7248a8c9ac3385f
Author: Julien Ducourthial <jducourt@free.fr>
Date:   Wed May 9 00:00:06 2012 +0200

    r8169: fix unsigned int wraparound with TSO
    
    [ Upstream commit 477206a018f902895bfcd069dd820bfe94c187b1 ]
    
    The r8169 may get stuck or show bad behaviour after activating TSO :
    the net_device is not stopped when it has no more TX descriptors.
    This problem comes from TX_BUFS_AVAIL which may reach -1 when all
    transmit descriptors are in use. The patch simply tries to keep positive
    values.
    
    Tested with 8111d(onboard) on a D510MO, and with 8111e(onboard) on a
    Zotac 890GXITX.
    
    Signed-off-by: Julien Ducourthial <jducourt@free.fr>
    Acked-by: Francois Romieu <romieu@fr.zoreil.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit ba3d9c0eb1ed88c156e49eadcb1e9ec22cfc2fed
Author: Francois Romieu <romieu@fr.zoreil.com>
Date:   Tue Jan 31 00:00:19 2012 +0100

    r8169: fix early queue wake-up.
    
    [ Upstream commit ae1f23fb433ac0aaff8aeaa5a7b14348e9aa8277 ]
    
    With infinite gratitude to Eric Dumazet for allowing me to identify
    the error.
    
    Signed-off-by: Francois Romieu <romieu@fr.zoreil.com>
    Acked-by: Eric Dumazet <eric.dumazet@gmail.com>
    Cc: Hayes Wang <hayeswang@realtek.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 32244144e774f32db30e9f33df7b54e0cddfa475
Author: Francois Romieu <romieu@fr.zoreil.com>
Date:   Fri Jan 27 15:05:38 2012 +0100

    r8169: missing barriers.
    
    [ Upstream commit 1e874e041fc7c222cbd85b20c4406070be1f687a ]
    
    Signed-off-by: Francois Romieu <romieu@fr.zoreil.com>
    Cc: Hayes Wang <hayeswang@realtek.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit dc999edca1654eff8494d9eadf2ec8e951a655fe
Author: James Chapman <jchapman@katalix.com>
Date:   Tue May 29 23:13:23 2012 +0000

    l2tp: fix oops in L2TP IP sockets for connect() AF_UNSPEC case
    
    [ Upstream commit c51ce49735c183ef2592db70f918ee698716276b ]
    
    An application may call connect() to disconnect a socket using an
    address with family AF_UNSPEC. The L2TP IP sockets were not handling
    this case when the socket is not bound and an attempt to connect()
    using AF_UNSPEC in such cases would result in an oops. This patch
    addresses the problem by protecting the sk_prot->disconnect() call
    against trying to unhash the socket before it is bound.
    
    The patch also adds more checks that the sockaddr supplied to bind()
    and connect() calls is valid.
    
     RIP: 0010:[<ffffffff82e133b0>]  [<ffffffff82e133b0>] inet_unhash+0x50/0xd0
     RSP: 0018:ffff88001989be28  EFLAGS: 00010293
     Stack:
      ffff8800407a8000 0000000000000000 ffff88001989be78 ffffffff82e3a249
      ffffffff82e3a050 ffff88001989bec8 ffff88001989be88 ffff8800407a8000
      0000000000000010 ffff88001989bec8 ffff88001989bea8 ffffffff82e42639
     Call Trace:
     [<ffffffff82e3a249>] udp_disconnect+0x1f9/0x290
     [<ffffffff82e42639>] inet_dgram_connect+0x29/0x80
     [<ffffffff82d012fc>] sys_connect+0x9c/0x100
    
    Reported-by: Sasha Levin <levinsasha928@gmail.com>
    Signed-off-by: James Chapman <jchapman@katalix.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit ef53defb2f4e1fb16a4688aaef10a084adf2e644
Author: Gao feng <gaofeng@cn.fujitsu.com>
Date:   Sat May 26 01:30:53 2012 +0000

    ipv6: fix incorrect ipsec fragment
    
    [ Upstream commit 0c1833797a5a6ec23ea9261d979aa18078720b74 ]
    
    Since commit ad0081e43a
    "ipv6: Fragment locally generated tunnel-mode IPSec6 packets as needed"
    the fragment of packets is incorrect.
    because tunnel mode needs IPsec headers and trailer for all fragments,
    while on transport mode it is sufficient to add the headers to the
    first fragment and the trailer to the last.
    
    so modify mtu and maxfraglen base on ipsec mode and if fragment is first
    or last.
    
    with my test,it work well(every fragment's size is the mtu)
    and does not trigger slow fragment path.
    
    Changes from v1:
            though optimization, mtu_prev and maxfraglen_prev can be delete.
            replace xfrm mode codes with dst_entry's new frag DST_XFRM_TUNNEL.
            add fuction ip6_append_data_mtu to make codes clearer.
    
    Signed-off-by: Gao feng <gaofeng@cn.fujitsu.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit f653363b91b7a2a9bf739b834c6830cd409c74b0
Author: Peter Huang (Peng) <peter.huangpeng@huawei.com>
Date:   Thu Apr 19 20:12:51 2012 +0000

    set fake_rtable's dst to NULL to avoid kernel Oops
    
    [ Upstream commit a881e963c7fe1f226e991ee9bbe8907acda93294 ]
    
    bridge: set fake_rtable's dst to NULL to avoid kernel Oops
    
    when bridge is deleted before tap/vif device's delete, kernel may
    encounter an oops because of NULL reference to fake_rtable's dst.
    Set fake_rtable's dst to NULL before sending packets out can solve
    this problem.
    
    v4 reformat, change br_drop_fake_rtable(skb) to {}
    
    v3 enrich commit header
    
    v2 introducing new flag DST_FAKE_RTABLE to dst_entry struct.
    
    [ Use "do { } while (0)" for nop br_drop_fake_rtable()
      implementation -DaveM ]
    
    Acked-by: Eric Dumazet <eric.dumazet@gmail.com>
    Signed-off-by: Peter Huang <peter.huangpeng@huawei.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 4a590034d6d5d5863d3f9a1915452026ee031a93
Author: Yanmin Zhang <yanmin_zhang@linux.intel.com>
Date:   Wed May 23 15:39:45 2012 +0000

    ipv4: fix the rcu race between free_fib_info and ip_route_output_slow
    
    [ Upstream commit e49cc0da7283088c5e03d475ffe2fdcb24a6d5b1 ]
    
    We hit a kernel OOPS.
    
    <3>[23898.789643] BUG: sleeping function called from invalid context at
    /data/buildbot/workdir/ics/hardware/intel/linux-2.6/arch/x86/mm/fault.c:1103
    <3>[23898.862215] in_atomic(): 0, irqs_disabled(): 0, pid: 10526, name:
    Thread-6683
    <4>[23898.967805] HSU serial 0000:00:05.1: 0000:00:05.2:HSU serial prevented me
    to suspend...
    <4>[23899.258526] Pid: 10526, comm: Thread-6683 Tainted: G        W
    3.0.8-137685-ge7742f9 #1
    <4>[23899.357404] HSU serial 0000:00:05.1: 0000:00:05.2:HSU serial prevented me
    to suspend...
    <4>[23899.904225] Call Trace:
    <4>[23899.989209]  [<c1227f50>] ? pgtable_bad+0x130/0x130
    <4>[23900.000416]  [<c1238c2a>] __might_sleep+0x10a/0x110
    <4>[23900.007357]  [<c1228021>] do_page_fault+0xd1/0x3c0
    <4>[23900.013764]  [<c18e9ba9>] ? restore_all+0xf/0xf
    <4>[23900.024024]  [<c17c007b>] ? napi_complete+0x8b/0x690
    <4>[23900.029297]  [<c1227f50>] ? pgtable_bad+0x130/0x130
    <4>[23900.123739]  [<c1227f50>] ? pgtable_bad+0x130/0x130
    <4>[23900.128955]  [<c18ea0c3>] error_code+0x5f/0x64
    <4>[23900.133466]  [<c1227f50>] ? pgtable_bad+0x130/0x130
    <4>[23900.138450]  [<c17f6298>] ? __ip_route_output_key+0x698/0x7c0
    <4>[23900.144312]  [<c17f5f8d>] ? __ip_route_output_key+0x38d/0x7c0
    <4>[23900.150730]  [<c17f63df>] ip_route_output_flow+0x1f/0x60
    <4>[23900.156261]  [<c181de58>] ip4_datagram_connect+0x188/0x2b0
    <4>[23900.161960]  [<c18e981f>] ? _raw_spin_unlock_bh+0x1f/0x30
    <4>[23900.167834]  [<c18298d6>] inet_dgram_connect+0x36/0x80
    <4>[23900.173224]  [<c14f9e88>] ? _copy_from_user+0x48/0x140
    <4>[23900.178817]  [<c17ab9da>] sys_connect+0x9a/0xd0
    <4>[23900.183538]  [<c132e93c>] ? alloc_file+0xdc/0x240
    <4>[23900.189111]  [<c123925d>] ? sub_preempt_count+0x3d/0x50
    
    Function free_fib_info resets nexthop_nh->nh_dev to NULL before releasing
    fi. Other cpu might be accessing fi. Fixing it by delaying the releasing.
    
    With the patch, we ran MTBF testing on Android mobile for 12 hours
    and didn't trigger the issue.
    
    Thank Eric for very detailed review/checking the issue.
    
    Signed-off-by: Yanmin Zhang <yanmin_zhang@linux.intel.com>
    Signed-off-by: Kun Jiang <kunx.jiang@intel.com>
    Acked-by: Eric Dumazet <edumazet@google.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 9f6cf3abdb1e954db86f963569590444642495ff
Author: David S. Miller <davem@davemloft.net>
Date:   Thu May 10 22:16:32 2012 -0400

    ipv4: Do not use dead fib_info entries.
    
    [ Upstream commit dccd9ecc374462e5d6a5b8f8110415a86c2213d8 ]
    
    Due to RCU lookups and RCU based release, fib_info objects can
    be found during lookup which have fi->fib_dead set.
    
    We must ignore these entries, otherwise we risk dereferencing
    the parts of the entry which are being torn down.
    
    Reported-by: Yevgen Pronenko <yevgen.pronenko@sonymobile.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 7a735af2d50190b6c612509c6dcad1b5aa0be828
Author: Chris Wilson <chris@chris-wilson.co.uk>
Date:   Tue Nov 8 23:17:34 2011 +0000

    drm/i915:: Disable FBC on SandyBridge
    
    commit d56d8b28e9247e7e35e02fbb12b12239a2c33ad1 upstream.
    
    Enabling FBC is causing the BLT ring to run between 10-100x slower than
    normal and frequently lockup. The interim solution is disable FBC once
    more until we know why.
    
    Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
    Signed-off-by: Keith Packard <keithp@keithp.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit cf0c2375d258e829777ae648500f6a6eeaecce5d
Author: Michael Gruetzner <mgruetzn@gmx.de>
Date:   Wed May 2 22:33:40 2012 +0200

    Bluetooth: Add support for Foxconn/Hon Hai AR5BBU22 0489:E03C
    
    commit 85d59726c5c66016a507f1f4a60db8e374dd284d upstream.
    
    Add Foxconn/Hon Hai AR5BBU22 Bluetooth Module( 0x489:0xE03C) to
    the blacklist of btusb module and add it to the ath3k module to properly
    load the firmware in Kernel 3.3.4
    The device is integrated in  e.g. some  Acer Aspire 7750G.
    
    Output from /sys/kernel/debug/usb/devices:
    
    T:  Bus=01 Lev=02 Prnt=02 Port=05 Cnt=02 Dev#=  6 Spd=12   MxCh= 0
    D:  Ver= 2.00 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
    P:  Vendor=0489 ProdID=e03c Rev= 0.02
    S:  Manufacturer=Atheros Communications
    S:  Product=Bluetooth USB Host Controller
    S:  SerialNumber=Alaska Day 2006
    C:* #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
    I:* If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=81(I) Atr=03(Int.) MxPS=  16 Ivl=1ms
    E:  Ad=82(I) Atr=02(Bulk) MxPS=  64 Ivl=0ms
    E:  Ad=02(O) Atr=02(Bulk) MxPS=  64 Ivl=0ms
    I:* If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=   0 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=   0 Ivl=1ms
    I:  If#= 1 Alt= 1 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=   9 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=   9 Ivl=1ms
    I:  If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=  17 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=  17 Ivl=1ms
    I:  If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=  25 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=  25 Ivl=1ms
    I:  If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=  33 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=  33 Ivl=1ms
    I:  If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=  49 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=  49 Ivl=1ms
    
    Signed-off-by: Michael Gruetzner <mgruetzn@gmx.de>
    Signed-off-by: Gustavo Padovan <gustavo@padovan.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit d5b23494cc37206d8085188f37bb79fab6eb0f1f
Author: Steven Harms <sjharms@gmail.com>
Date:   Fri Apr 13 14:45:55 2012 -0400

    Add Foxconn / Hon Hai IDs for btusb module
    
    commit 985140369be1e886754d8ac0375dd64e4f727311 upstream.
    
    This change adds 0x0489:0xe033 to the btusb module.
    
    This bluetooth usb device is integrated in the Acer TimelineX AS4830TG-6808 notebook.
    
    Output from /sys/kernel/debug/usb/devices:
    
    T:  Bus=01 Lev=02 Prnt=02 Port=05 Cnt=02 Dev#=  4 Spd=12   MxCh= 0
    D:  Ver= 2.00 Cls=ff(vend.) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
    P:  Vendor=0489 ProdID=e033 Rev= 2.29
    S:  Manufacturer=Broadcom Corp
    S:  Product=Acer Module
    S:  SerialNumber=60D819F74101
    C:* #Ifs= 4 Cfg#= 1 Atr=e0 MxPwr=  0mA
    I:* If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=01 Prot=01 Driver=btusb
    E:  Ad=81(I) Atr=03(Int.) MxPS=  16 Ivl=1ms
    E:  Ad=82(I) Atr=02(Bulk) MxPS=  64 Ivl=0ms
    E:  Ad=02(O) Atr=02(Bulk) MxPS=  64 Ivl=0ms
    I:* If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=   0 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=   0 Ivl=1ms
    I:  If#= 1 Alt= 1 #EPs= 2 Cls=ff(vend.) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=   9 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=   9 Ivl=1ms
    I:  If#= 1 Alt= 2 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=  17 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=  17 Ivl=1ms
    I:  If#= 1 Alt= 3 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=  32 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=  32 Ivl=1ms
    I:  If#= 1 Alt= 4 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=  64 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=  64 Ivl=1ms
    I:  If#= 1 Alt= 5 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    E:  Ad=83(I) Atr=01(Isoc) MxPS=  64 Ivl=1ms
    E:  Ad=03(O) Atr=01(Isoc) MxPS=  64 Ivl=1ms
    I:* If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
    E:  Ad=84(I) Atr=02(Bulk) MxPS=  32 Ivl=0ms
    E:  Ad=04(O) Atr=02(Bulk) MxPS=  32 Ivl=0ms
    I:* If#= 3 Alt= 0 #EPs= 0 Cls=fe(app. ) Sub=01 Prot=01 Driver=(none)
    
    Signed-off-by: Steven Harms <sjharms@gmail.com>
    Signed-off-by: Gustavo Padovan <gustavo@padovan.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 4c8899e7554a4d8d26defb0af1015a0cf8f17a8e
Author: AceLan Kao <acelan.kao@canonical.com>
Date:   Thu Apr 19 14:53:45 2012 +0800

    Bluetooth: Add support for AR3012 [0cf3:e004]
    
    commit ac71311e65e2c4c2dbac76db698fecbee755b016 upstream.
    
    Add another vendor specific ID for Atheros AR3012
    
    output of usb-devices:
    T:  Bus=02 Lev=02 Prnt=02 Port=04 Cnt=01 Dev#=  4 Spd=12  MxCh= 0
    D:  Ver= 1.10 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
    P:  Vendor=0cf3 ProdID=e004 Rev=00.02
    S:  Manufacturer=Atheros Communications
    S:  Product=Bluetooth USB Host Controller
    S:  SerialNumber=Alaska Day 2006
    C:  #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
    I:  If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    I:  If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    
    BugLink: https://bugs.launchpad.net/bugs/922715
    
    Signed-off-by: AceLan Kao <acelan.kao@canonical.com>
    Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 24f39f0c177861e84e037dadc6a5207fc87cab43
Author: AceLan Kao <acelan.kao@canonical.com>
Date:   Fri Apr 13 17:39:57 2012 +0800

    Bluetooth: Add support for Atheros [13d3:3362]
    
    commit 87522a433ba6886b5ccbb497e0a7cb8097def64e upstream.
    
    Add another vendor specific ID for Atheros AR3012 device.
    This chip is wrapped by IMC Networks.
    
    output of usb-devices:
    T:  Bus=01 Lev=02 Prnt=02 Port=00 Cnt=01 Dev#=  5 Spd=12  MxCh= 0
    D:  Ver= 1.10 Cls=e0(wlcon) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
    P:  Vendor=13d3 ProdID=3362 Rev=00.02
    S:  Manufacturer=Atheros Communications
    S:  Product=Bluetooth USB Host Controller
    S:  SerialNumber=Alaska Day 2006
    C:  #Ifs= 2 Cfg#= 1 Atr=e0 MxPwr=100mA
    I:  If#= 0 Alt= 0 #EPs= 3 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    I:  If#= 1 Alt= 0 #EPs= 2 Cls=e0(wlcon) Sub=01 Prot=01 Driver=btusb
    
    Signed-off-by: AceLan Kao <acelan.kao@canonical.com>
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit c44e806dde809f77e4db2aa77194e1cab7d204a1
Author: Manoj Iyer <manoj.iyer@canonical.com>
Date:   Mon Apr 9 09:22:28 2012 -0500

    Bluetooth: btusb: Add vendor specific ID (0489 e042) for BCM20702A0
    
    commit 79cd76022044f8177bb00e3fd590ec8d6b5f8c35 upstream.
    
    T: Bus=02 Lev=02 Prnt=02 Port=04 Cnt=01 Dev#= 3 Spd=12 MxCh= 0
    D: Ver= 2.00 Cls=ff(vend.) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
    P: Vendor=0489 ProdID=e042 Rev=01.12
    S: Manufacturer=Broadcom Corp
    S: Product=BCM20702A0
    S: SerialNumber=E4D53DCA61B5
    C: #Ifs= 4 Cfg#= 1 Atr=e0 MxPwr=0mA
    I: If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
    I: If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
    I: If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
    I: If#= 3 Alt= 0 #EPs= 0 Cls=fe(app. ) Sub=01 Prot=01 Driver=(none)
    
    Reported-by: Dennis Chua <dennis.chua@canonical.com>
    Signed-off-by: Manoj Iyer <manoj.iyer@canonical.com>
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit f44dab2d82a8b01cf0c230a1e91527f38c948ae8
Author: Don Zickus <dzickus@redhat.com>
Date:   Wed Mar 28 16:41:11 2012 -0400

    Bluetooth: btusb: typo in Broadcom SoftSailing id
    
    commit 2e8b506310f6433d5558387fd568d4bfb1d6a799 upstream.
    
    I was trying to backport the following commit to RHEL-6
    
        From 0cea73465cd22373c5cd43a3edd25fbd4bb532ef Mon Sep 17 00:00:00 2001
        From: Oliver Neukum <oliver@neukum.org>
        Date: Wed, 21 Sep 2011 11:37:15 +0200
        Subject: [PATCH] btusb: add device entry for Broadcom SoftSailing
    
    and noticed it wasn't working on an HP Elitebook.  Looking into the patch I
    noticed a very subtle typo in the ids.  The patch has '0x05ac' instead of
    '0x0a5c'.  A snippet of the lsusb -v output also shows this:
    
    Bus 002 Device 003: ID 0a5c:21e1 Broadcom Corp.
    Device Descriptor:
      bLength                18
      bDescriptorType         1
      bcdUSB               2.00
      bDeviceClass          255 Vendor Specific Class
      bDeviceSubClass         1
      bDeviceProtocol         1
      bMaxPacketSize0        64
      idVendor           0x0a5c Broadcom Corp.
      idProduct          0x21e1
      bcdDevice            1.12
      iManufacturer           1 Broadcom Corp
      iProduct                2 BCM20702A0
      iSerial                 3 60D819F0338C
      bNumConfigurations      1
    
    Looking at other Broadcom ids, the fix matches them whereas the original patch
    matches Apple's ids.
    
    Tested on an HP Elitebook 8760w.  The btusb binds and the userspace stuff loads
    correctly.
    
    Cc: Oliver Neukum <oliver@neukum.org>
    Signed-off-by: Don Zickus <dzickus@redhat.com>
    Acked-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit b2c55f4647154cd53810ca642d847156dcf48a62
Author: João Paulo Rechi Vita <jprvita@openbossa.org>
Date:   Wed Mar 14 21:45:16 2012 +0200

    Bluetooth: btusb: Add USB device ID "0a5c 21e8"
    
    commit 6dfc326f0605fd87e4c10ccde10de0ce4280d72d upstream.
    
    One more vendor-specific ID for BCM20702A0.
    
    T:  Bus=01 Lev=03 Prnt=05 Port=02 Cnt=01 Dev#=  9 Spd=12  MxCh= 0
    D:  Ver= 2.00 Cls=ff(vend.) Sub=01 Prot=01 MxPS=64 #Cfgs=  1
    P:  Vendor=0a5c ProdID=21e8 Rev=01.12
    S:  Manufacturer=Broadcom Corp
    S:  Product=BCM20702A0
    S:  SerialNumber=00027221F4E2
    C:  #Ifs= 4 Cfg#= 1 Atr=e0 MxPwr=0mA
    I:  If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
    I:  If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
    I:  If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
    I:  If#= 3 Alt= 0 #EPs= 0 Cls=fe(app. ) Sub=01 Prot=01 Driver=(none)
    
    Signed-off-by: João Paulo Rechi Vita <jprvita@openbossa.org>
    Acked-by: Gustavo F. Padovan <padovan@profusion.mobi>
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit cf9a32b172b3e412e33275610cca75614d6fac64
Author: James M. Leddy <james.leddy@canonical.com>
Date:   Tue Mar 6 02:41:33 2012 +0200

    Bluetooth: btusb: add support for BCM20702A0 [0a5c:21e6]
    
    commit 0a4eaeeb993658a4d6cff054a863241f32d3d2fb upstream.
    
    Add another vendor specific ID for BCM20702A0.  This has been tested and
    works on hardware with this device.
    
    output of usb-devices:
    T: Bus=01 Lev=02 Prnt=02 Port=03 Cnt=04 Dev#= 6 Spd=12 MxCh= 0
    D: Ver= 2.00 Cls=ff(vend.) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
    P: Vendor=0a5c ProdID=21e6 Rev=01.12
    S: Manufacturer=Broadcom Corp
    S: Product=BCM20702A0
    S: SerialNumber=D0DF9AFB227B
    C: #Ifs= 4 Cfg#= 1 Atr=e0 MxPwr=0mA
    I: If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
    I: If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
    I: If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
    I: If#= 3 Alt= 0 #EPs= 0 Cls=fe(app. ) Sub=01 Prot=01 Driver=(none)
    
    Signed-off-by: James M. Leddy <james.leddy@canonical.com>
    Acked-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit fac96c047981e2e6b71d2265b1b31ab031a900bd
Author: Manoj Iyer <manoj.iyer@canonical.com>
Date:   Thu Feb 2 09:32:36 2012 -0600

    Bluetooth: btusb: Add vendor specific ID (0a5c 21f3) for BCM20702A0
    
    commit 37305cf649689a4d2341dd6fd89b091c6007f9ba upstream.
    
    T: Bus=01 Lev=02 Prnt=02 Port=03 Cnt=03 Dev#= 5 Spd=12 MxCh= 0
    D: Ver= 2.00 Cls=ff(vend.) Sub=01 Prot=01 MxPS=64 #Cfgs= 1
    P: Vendor=0a5c ProdID=21f3 Rev=01.12
    S: Manufacturer=Broadcom Corp
    S: Product=BCM20702A0
    S: SerialNumber=74DE2B344A7B
    C: #Ifs= 4 Cfg#= 1 Atr=e0 MxPwr=0mA
    I: If#= 0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
    I: If#= 1 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=01 Prot=01 Driver=(none)
    I: If#= 2 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
    I: If#= 3 Alt= 0 #EPs= 0 Cls=fe(app. ) Sub=01 Prot=01 Driver=(none)
    
    Signed-off-by: Manoj Iyer <manoj.iyer@canonical.com>
    Tested-by: Dennis Chua <dennis.chua@canonical.com>
    Acked-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit a8e06b6819e23fe105fb9506011576277deef3c4
Author: Stephan Gatzka <stephan@gatzka.org>
Date:   Sat Jun 2 03:04:06 2012 +0000

    fec_mpc52xx: fix timestamp filtering
    
    commit 9ca3cc6f3026946ba655e863ca2096339e667639 upstream.
    
    skb_defer_rx_timestamp was called with a freshly allocated skb but must
    be called with rskb instead.
    
    Signed-off-by: Stephan Gatzka <stephan@gatzka.org>
    Acked-by: Richard Cochran <richardcochran@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit aa0a578e649c62a9060315cb0e658ef8dd0161e2
Author: Frank Svendsboe <frank.svendsboe@gmail.com>
Date:   Thu May 17 22:43:09 2012 +0200

    mtd: of_parts: fix breakage in Kconfig
    
    commit 2e929d001e85126d9267de373d4b76014789661d upstream.
    
    MTD_OF_PARTS and the default setting is not working due to using 'Y'
    instead of 'y', introduced in commit
    d6137badeff1ef64b4e0092ec249ebdeaeb3ff37. This made our board, and
    possibly other boards using DTS defined partitions and not having
    CONFIG_MTD_OF_PARTS=y defined in the defconfig, fail to mount root.
    
    Signed-off-by: Frank Svendsboe <frank.svendsboe@gmail.com>
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 65ca1815cd3b349988eeaa24a0fffe0d02629035
Author: Thomas Hellstrom <thellstrom@vmware.com>
Date:   Fri Jun 1 15:48:04 2012 +0200

    drm/vmwgfx: Fix nasty write past alloced memory area
    
    commit 0824db38e515644f8d1bfd64adbd7cb2c6ea7c62 upstream.
    
    Signed-off-by: Thomas Hellstrom <thellstrom@vmware.com>
    Reviewed-by: Jakob Bornecrantz <jakob@vmware.com>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 2d60c5acb3df4dc03ed512134c9f61c80cff7e18
Author: Thomas Hellstrom <thellstrom@vmware.com>
Date:   Fri Jun 1 15:39:11 2012 +0200

    drm/ttm: Fix spinlock imbalance
    
    commit a8ff3ee211fccf708e1911bbc096625453ebf759 upstream.
    
    This imbalance may cause hangs when TTM is trying to swap out a buffer
    that is already on the delayed delete list.
    
    Signed-off-by: Thomas Hellstrom <thellstrom@vmware.com>
    Reviewed-by: Jakob Bornecrantz <jakob@vmware.com>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit f0efda52fb8bffd27c789732d79042c04fc90850
Author: Jerome Glisse <jglisse@redhat.com>
Date:   Thu May 31 19:00:24 2012 -0400

    drm/radeon: fix HD6790, HD6570 backend programming
    
    commit 95c4b23ec4e2fa5604df229ddf134e31d7b3b378 upstream.
    
    Without this bit sets we get broken rendering and
    lockups.
    
    fglrx sets this bit.
    
    Bugs that should be fixed by this patch :
    https://bugs.freedesktop.org/show_bug.cgi?id=49792
    https://bugzilla.kernel.org/show_bug.cgi?id=43207
    https://bugs.freedesktop.org/show_bug.cgi?id=39282
    
    Signed-off-by: Jerome Glisse <jglisse@redhat.com>
    Acked-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit d08dedb9859a96adb21443b99c3a13f040c2b38e
Author: Alex Deucher <alexander.deucher@amd.com>
Date:   Thu May 31 18:54:43 2012 -0400

    drm/radeon: properly program gart on rv740, juniper, cypress, barts, hemlock
    
    commit 0b8c30bc4943137a4a36b9cb059b1cc684f5d702 upstream.
    
    Need to program an additional VM register.  This doesn't not currently
    cause any problems, but allows us to program the proper backend
    map in a subsequent patch which should improve performance on these
    asics.
    
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 9ece7de9fb0af2f9883607cfbbc496331b35118a
Author: Alex Deucher <alexander.deucher@amd.com>
Date:   Thu May 31 18:53:36 2012 -0400

    drm/radeon: fix bank information in tiling config
    
    commit 29d654067a98c1cb8874c774e5fd799a038af8a6 upstream.
    
    While there are cards with more than 8 mem banks, the max
    number of banks from a tiling perspective is 8, so cap
    the tiling config at 8 banks.
    
    Fixes:
    https://bugs.freedesktop.org/show_bug.cgi?id=43448
    
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    [bwh: Backported to 3.2: fix up context and indentation for missing
     IGP condition in ni.c]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 4e8e79304ddf4fb1fd350d017347bda0735afd8b
Author: Salman Qazi <sqazi@google.com>
Date:   Thu May 31 23:52:14 2012 -0400

    ext4: remove mb_groups before tearing down the buddy_cache
    
    commit 95599968d19db175829fb580baa6b68939b320fb upstream.
    
    We can't have references held on pages in the s_buddy_cache while we are
    trying to truncate its pages and put the inode.  All the pages must be
    gone before we reach clear_inode.  This can only be gauranteed if we
    can prevent new users from grabbing references to s_buddy_cache's pages.
    
    The original bug can be reproduced and the bug fix can be verified by:
    
    while true; do mount -t ext4 /dev/ram0 /export/hda3/ram0; \
            umount /export/hda3/ram0; done &
    
    while true; do cat /proc/fs/ext4/ram0/mb_groups; done
    
    Signed-off-by: Salman Qazi <sqazi@google.com>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 40fb8cb8f59ccca96bc4ab10b64ac24cabba4ddb
Author: Salman Qazi <sqazi@google.com>
Date:   Thu May 31 23:51:27 2012 -0400

    ext4: add ext4_mb_unload_buddy in the error path
    
    commit 02b7831019ea4e7994968c84b5826fa8b248ffc8 upstream.
    
    ext4_free_blocks fails to pair an ext4_mb_load_buddy with a matching
    ext4_mb_unload_buddy when it fails a memory allocation.
    
    Signed-off-by: Salman Qazi <sqazi@google.com>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit f139d067883637c9ab0091fbca821d01d0890123
Author: Clemens Ladisch <clemens@ladisch.de>
Date:   Fri May 18 18:00:43 2012 +0200

    ALSA: usb-audio: fix rate_list memory leak
    
    commit 5cd5d7c44990658df6ab49f6253c39617c53b03d upstream.
    
    The array of sample rates is reallocated every time when opening
    the PCM device, but was freed only once when unplugging the device.
    
    Reported-by: "Alexander E. Patrakov" <patrakov@gmail.com>
    Signed-off-by: Clemens Ladisch <clemens@ladisch.de>
    Signed-off-by: Takashi Iwai <tiwai@suse.de>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 168587994af06f0542dbbce9172fdb72ed74567f
Author: Theodore Ts'o <tytso@mit.edu>
Date:   Wed May 30 23:00:16 2012 -0400

    ext4: add missing save_error_info() to ext4_error()
    
    commit f3fc0210c0fc91900766c995f089c39170e68305 upstream.
    
    The ext4_error() function is missing a call to save_error_info().
    Since this is the function which marks the file system as containing
    an error, this oversight (which was introduced in 2.6.36) is quite
    significant, and should be backported to older stable kernels with
    high urgency.
    
    Reported-by: Ken Sumrall <ksumrall@google.com>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Cc: ksumrall@google.com
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 0264b862b122cdfda51029c78382e0b7865a3cd9
Author: Al Viro <viro@zeniv.linux.org.uk>
Date:   Tue May 29 22:03:48 2012 -0400

    vfs: umount_tree() might be called on subtree that had never made it
    
    commit 63d37a84ab6004c235314ffd7a76c5eb28c2fae0 upstream.
    
    __mnt_make_shortterm() in there undoes the effect of __mnt_make_longterm()
    we'd done back when we set ->mnt_ns non-NULL; it should not be done to
    vfsmounts that had never gone through commit_tree() and friends.  Kudos to
    lczerner for catching that one...
    
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit e384357a14c49f0107a061cb089c89a59d8a3b20
Author: Dmitry Kasatkin <dmitry.kasatkin@intel.com>
Date:   Tue May 29 11:02:21 2012 -0700

    vfs: increment iversion when a file is truncated
    
    commit 799243a389bde0de10fa21ca1ca453d2fe538b85 upstream.
    
    When a file is truncated with truncate()/ftruncate() and then closed,
    iversion is not updated.  This patch uses ATTR_SIZE flag as an indication
    to increment iversion.
    
    Mimi said:
    
    On fput(), i_version is used to detect and flag files that have changed
    and need to be re-measured in the IMA measurement policy.  When a file
    is truncated with truncate()/ftruncate() and then closed, i_version is
    not updated.  As a result, although the file has changed, it will not be
    re-measured and added to the IMA measurement list on subsequent access.
    
    Signed-off-by: Dmitry Kasatkin <dmitry.kasatkin@intel.com>
    Acked-by: Mimi Zohar <zohar@us.ibm.com>
    Cc: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 48b0fff1aa1f5c4c9258034c2ba087e6dec0b470
Author: Dmitry Maluka <D.Maluka@adbglobal.com>
Date:   Fri May 11 20:51:51 2012 +0300

    mtd: nand: fix scan_read_raw_oob
    
    commit 34a5704d91d6f8376a4c0a0143a1dd3eb3ccb37e upstream.
    
    It seems there is a bug in scan_read_raw_oob() in nand_bbt.c which
    should cause wrong functioning of NAND_BBT_SCANALLPAGES option.
    
    Artem: the patch did not apply and I had to amend it a bit.
    
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 7523a2de6d789ce1b8f5601f9305ccfa68924c3a
Author: Andreas Dilger <adilger@dilger.ca>
Date:   Mon May 28 17:02:25 2012 -0400

    ext4: disallow hard-linked directory in ext4_lookup
    
    commit 7e936b737211e6b54e34b71a827e56b872e958d8 upstream.
    
    A hard-linked directory to its parent can cause the VFS to deadlock,
    and is a sign of a corrupted file system.  So detect this case in
    ext4_lookup(), before the rmdir() lockup scenario can take place.
    
    Signed-off-by: Andreas Dilger <adilger@dilger.ca>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 3e9fc33800a233c2820abae8428fda5f5e508263
Author: Eric Sandeen <sandeen@redhat.com>
Date:   Mon May 28 14:17:25 2012 -0400

    ext4: force ro mount if ext4_setup_super() fails
    
    commit 7e84b6216467b84cd332c8e567bf5aa113fd2f38 upstream.
    
    If ext4_setup_super() fails i.e. due to a too-high revision,
    the error is logged in dmesg but the fs is not mounted RO as
    indicated.
    
    Tested by:
    
    # mkfs.ext4 -r 4 /dev/sdb6
    # mount /dev/sdb6 /mnt/test
    # dmesg | grep "too high"
    [164919.759248] EXT4-fs (sdb6): revision level too high, forcing read-only mode
    # grep sdb6 /proc/mounts
    /dev/sdb6 /mnt/test2 ext4 rw,seclabel,relatime,data=ordered 0 0
    
    Reviewed-by: Andreas Dilger <adilger@whamcloud.com>
    Signed-off-by: Eric Sandeen <sandeen@redhat.com>
    Signed-off-by: "Theodore Ts'o" <tytso@mit.edu>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit dd881278ba354640bec9f3d6c6dfaef38d2c53b9
Author: Joonsoo Kim <js1304@gmail.com>
Date:   Thu May 17 00:13:02 2012 +0900

    slub: fix a memory leak in get_partial_node()
    
    commit 02d7633fa567be7bf55a993b79d2a31b95ce2227 upstream.
    
    In the case which is below,
    
    1. acquire slab for cpu partial list
    2. free object to it by remote cpu
    3. page->freelist = t
    
    then memory leak is occurred.
    
    Change acquire_slab() not to zap freelist when it works for cpu partial list.
    I think it is a sufficient solution for fixing a memory leak.
    
    Below is output of 'slabinfo -r kmalloc-256'
    when './perf stat -r 30 hackbench 50 process 4000 > /dev/null' is done.
    
    ***Vanilla***
    Sizes (bytes)     Slabs              Debug                Memory
    ------------------------------------------------------------------------
    Object :     256  Total  :     468   Sanity Checks : Off  Total: 3833856
    SlabObj:     256  Full   :     111   Redzoning     : Off  Used : 2004992
    SlabSiz:    8192  Partial:     302   Poisoning     : Off  Loss : 1828864
    Loss   :       0  CpuSlab:      55   Tracking      : Off  Lalig:       0
    Align  :       8  Objects:      32   Tracing       : Off  Lpadd:       0
    
    ***Patched***
    Sizes (bytes)     Slabs              Debug                Memory
    ------------------------------------------------------------------------
    Object :     256  Total  :     300   Sanity Checks : Off  Total: 2457600
    SlabObj:     256  Full   :     204   Redzoning     : Off  Used : 2348800
    SlabSiz:    8192  Partial:      33   Poisoning     : Off  Loss :  108800
    Loss   :       0  CpuSlab:      63   Tracking      : Off  Lalig:       0
    Align  :       8  Objects:      32   Tracing       : Off  Lpadd:       0
    
    Total and loss number is the impact of this patch.
    
    Acked-by: Christoph Lameter <cl@linux.com>
    Signed-off-by: Joonsoo Kim <js1304@gmail.com>
    Signed-off-by: Pekka Enberg <penberg@kernel.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit af36d8c1604a720b299bf6d6d47da6375e3da37b
Author: Konrad Rzeszutek Wilk <konrad@darnok.org>
Date:   Wed May 30 18:23:56 2012 -0400

    x86, amd, xen: Avoid NULL pointer paravirt references
    
    commit 1ab46fd319bcf1fcd9fb6311727d532b580e4eba upstream.
    
    Stub out MSR methods that aren't actually needed.  This fixes a crash
    as Xen Dom0 on AMD Trinity systems.  A bigger patch should be added to
    remove the paravirt machinery completely for the methods which
    apparently have no users!
    
    Reported-by: Andre Przywara <andre.przywara@amd.com>
    Link: http://lkml.kernel.org/r/20120530222356.GA28417@andromeda.dapyr.net
    Signed-off-by: H. Peter Anvin <hpa@zytor.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit b7b2e9a76804a3ae4c3e9a99b8c56c48b4bc6a50
Author: Dave Hansen <dave@linux.vnet.ibm.com>
Date:   Wed May 30 07:51:07 2012 -0700

    mm: fix vma_resv_map() NULL pointer
    
    commit 4523e1458566a0e8ecfaff90f380dd23acc44d27 upstream.
    
    hugetlb_reserve_pages() can be used for either normal file-backed
    hugetlbfs mappings, or MAP_HUGETLB.  In the MAP_HUGETLB, semi-anonymous
    mode, there is not a VMA around.  The new call to resv_map_put() assumed
    that there was, and resulted in a NULL pointer dereference:
    
      BUG: unable to handle kernel NULL pointer dereference at 0000000000000030
      IP: vma_resv_map+0x9/0x30
      PGD 141453067 PUD 1421e1067 PMD 0
      Oops: 0000 [#1] PREEMPT SMP
      ...
      Pid: 14006, comm: trinity-child6 Not tainted 3.4.0+ #36
      RIP: vma_resv_map+0x9/0x30
      ...
      Process trinity-child6 (pid: 14006, threadinfo ffff8801414e0000, task ffff8801414f26b0)
      Call Trace:
        resv_map_put+0xe/0x40
        hugetlb_reserve_pages+0xa6/0x1d0
        hugetlb_file_setup+0x102/0x2c0
        newseg+0x115/0x360
        ipcget+0x1ce/0x310
        sys_shmget+0x5a/0x60
        system_call_fastpath+0x16/0x1b
    
    This was reported by Dave Jones, but was reproducible with the
    libhugetlbfs test cases, so shame on me for not running them in the
    first place.
    
    With this, the oops is gone, and the output of libhugetlbfs's
    run_tests.py is identical to plain 3.4 again.
    
    [ Marked for stable, since this was introduced by commit c50ac050811d
      ("hugetlb: fix resv_map leak in error path") which was also marked for
      stable ]
    
    Reported-by: Dave Jones <davej@redhat.com>
    Cc: Mel Gorman <mel@csn.ul.ie>
    Cc: KOSAKI Motohiro <kosaki.motohiro@jp.fujitsu.com>
    Cc: Christoph Lameter <cl@linux.com>
    Cc: Andrea Arcangeli <aarcange@redhat.com>
    Cc: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit fd680782af2f335685fb30c87b52fbebf3d224e7
Author: James Bottomley <jbottomley@parallels.com>
Date:   Wed May 30 09:45:39 2012 +0000

    fix scsi_wait_scan
    
    commit 1ff2f40305772b159a91c19590ee159d3a504afc upstream.
    
    Commit  c751085943362143f84346d274e0011419c84202
    Author: Rafael J. Wysocki <rjw@sisk.pl>
    Date:   Sun Apr 12 20:06:56 2009 +0200
    
        PM/Hibernate: Wait for SCSI devices scan to complete during resume
    
    Broke the scsi_wait_scan module in 2.6.30.  Apparently debian still uses it so
    fix it and backport to stable before removing it in 3.6.
    
    The breakage is caused because the function template in
    include/scsi/scsi_scan.h is defined to be a nop unless SCSI is built in.
    That means that in the modular case (which is every distro), the
    scsi_wait_scan module does a simple async_synchronize_full() instead of
    waiting for scans.
    
    Signed-off-by: James Bottomley <JBottomley@Parallels.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 39083c6db7e18732e872fed0c2f2427de12a622a
Author: KyongHo <pullip.cho@samsung.com>
Date:   Tue May 29 15:06:49 2012 -0700

    mm: fix faulty initialization in vmalloc_init()
    
    commit dbda591d920b4c7692725b13e3f68ecb251e9080 upstream.
    
    The transfer of ->flags causes some of the static mapping virtual
    addresses to be prematurely freed (before the mapping is removed) because
    VM_LAZY_FREE gets "set" if tmp->flags has VM_IOREMAP set.  This might
    cause subsequent vmalloc/ioremap calls to fail because it might allocate
    one of the freed virtual address ranges that aren't unmapped.
    
    va->flags has different types of flags from tmp->flags.  If a region with
    VM_IOREMAP set is registered with vm_area_add_early(), it will be removed
    by __purge_vmap_area_lazy().
    
    Fix vmalloc_init() to correctly initialize vmap_area for the given
    vm_struct.
    
    Also initialise va->vm.  If it is not set, find_vm_area() for the early
    vm regions will always fail.
    
    Signed-off-by: KyongHo Cho <pullip.cho@samsung.com>
    Cc: "Olav Haugan" <ohaugan@codeaurora.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 15db5b6a476408a1a4b165e1786874be5aa8e242
Author: Minchan Kim <minchan@kernel.org>
Date:   Tue Jan 10 15:08:39 2012 -0800

    mm/vmalloc.c: change void* into explict vm_struct*
    
    commit db1aecafef58b5dda39c4228debe2c845e4a27ab upstream.
    
    vmap_area->private is void* but we don't use the field for various purpose
    but use only for vm_struct.  So change it to a vm_struct* with naming to
    improve for readability and type checking.
    
    Signed-off-by: Minchan Kim <minchan@kernel.org>
    Acked-by: David Rientjes <rientjes@google.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 73436db332d5b4dd792f115cf0b500521badf3e5
Author: Dave Hansen <dave@linux.vnet.ibm.com>
Date:   Fri May 18 11:46:30 2012 -0700

    hugetlb: fix resv_map leak in error path
    
    commit c50ac050811d6485616a193eb0f37bfbd191cc89 upstream.
    
    When called for anonymous (non-shared) mappings, hugetlb_reserve_pages()
    does a resv_map_alloc().  It depends on code in hugetlbfs's
    vm_ops->close() to release that allocation.
    
    However, in the mmap() failure path, we do a plain unmap_region() without
    the remove_vma() which actually calls vm_ops->close().
    
    This is a decent fix.  This leak could get reintroduced if new code (say,
    after hugetlb_reserve_pages() in hugetlbfs_file_mmap()) decides to return
    an error.  But, I think it would have to unroll the reservation anyway.
    
    Christoph's test case:
    
            http://marc.info/?l=linux-mm&m=133728900729735
    
    Signed-off-by: Dave Hansen <dave@linux.vnet.ibm.com>
    [Christoph Lameter: I have rediffed the patch against 2.6.32 and 3.2.0.]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit d006ab31cd818f5e4dda2453fd09767063f49933
Author: Michal Hocko <mhocko@suse.cz>
Date:   Tue May 29 15:06:45 2012 -0700

    mm: consider all swapped back pages in used-once logic
    
    commit e48982734ea0500d1eba4f9d96195acc5406cad6 upstream.
    
    Commit 645747462435 ("vmscan: detect mapped file pages used only once")
    made mapped pages have another round in inactive list because they might
    be just short lived and so we could consider them again next time.  This
    heuristic helps to reduce pressure on the active list with a streaming
    IO worklods.
    
    This patch fixes a regression introduced by this commit for heavy shmem
    based workloads because unlike Anon pages, which are excluded from this
    heuristic because they are usually long lived, shmem pages are handled
    as a regular page cache.
    
    This doesn't work quite well, unfortunately, if the workload is mostly
    backed by shmem (in memory database sitting on 80% of memory) with a
    streaming IO in the background (backup - up to 20% of memory).  Anon
    inactive list is full of (dirty) shmem pages when watermarks are hit.
    Shmem pages are kept in the inactive list (they are referenced) in the
    first round and it is hard to reclaim anything else so we reach lower
    scanning priorities very quickly which leads to an excessive swap out.
    
    Let's fix this by excluding all swap backed pages (they tend to be long
    lived wrt.  the regular page cache anyway) from used-once heuristic and
    rather activate them if they are referenced.
    
    The customer's workload is shmem backed database (80% of RAM) and they
    are measuring transactions/s with an IO in the background (20%).
    Transactions touch more or less random rows in the table.  The
    transaction rate fell by a factor of 3 (in the worst case) because of
    commit 64574746.  This patch restores the previous numbers.
    
    Signed-off-by: Michal Hocko <mhocko@suse.cz>
    Acked-by: Johannes Weiner <hannes@cmpxchg.org>
    Cc: Mel Gorman <mel@csn.ul.ie>
    Cc: Minchan Kim <minchan@kernel.org>
    Cc: KAMEZAWA Hiroyuki <kamezawa.hiroyu@jp.fujitsu.com>
    Reviewed-by: Rik van Riel <riel@redhat.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit ff8445f52037e30411691d0d1ced9650c780c3c2
Author: Siddhesh Poyarekar <siddhesh.poyarekar@gmail.com>
Date:   Tue May 29 15:06:22 2012 -0700

    mm/fork: fix overflow in vma length when copying mmap on clone
    
    commit 7edc8b0ac16cbaed7cb4ea4c6b95ce98d2997e84 upstream.
    
    The vma length in dup_mmap is calculated and stored in a unsigned int,
    which is insufficient and hence overflows for very large maps (beyond
    16TB). The following program demonstrates this:
    
    #include <stdio.h>
    #include <unistd.h>
    #include <sys/mman.h>
    
    #define GIG 1024 * 1024 * 1024L
    #define EXTENT 16393
    
    int main(void)
    {
            int i, r;
            void *m;
            char buf[1024];
    
            for (i = 0; i < EXTENT; i++) {
                    m = mmap(NULL, (size_t) 1 * 1024 * 1024 * 1024L,
                             PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, 0, 0);
    
                    if (m == (void *)-1)
                            printf("MMAP Failed: %d\n", m);
                    else
                            printf("%d : MMAP returned %p\n", i, m);
    
                    r = fork();
    
                    if (r == 0) {
                            printf("%d: successed\n", i);
                            return 0;
                    } else if (r < 0)
                            printf("FORK Failed: %d\n", r);
                    else if (r > 0)
                            wait(NULL);
            }
            return 0;
    }
    
    Increase the storage size of the result to unsigned long, which is
    sufficient for storing the difference between addresses.
    
    Signed-off-by: Siddhesh Poyarekar <siddhesh.poyarekar@gmail.com>
    Cc: Tejun Heo <tj@kernel.org>
    Cc: Oleg Nesterov <oleg@redhat.com>
    Cc: Jens Axboe <axboe@kernel.dk>
    Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
    Acked-by: Hugh Dickins <hughd@google.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    [bwh: Backported to 3.2: adjust context]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit a3a704a9ab01cf1f65df997868ddeb611e244dfb
Author: Eyal Shapira <eyal@wizery.com>
Date:   Tue May 29 02:00:22 2012 -0700

    mac80211: fix ADDBA declined after suspend with wowlan
    
    commit 7b21aea04d084916ac4e0e8852dcc9cd60ec0d1d upstream.
    
    WLAN_STA_BLOCK_BA is set while suspending but doesn't get cleared
    when resuming in case of wowlan. This causes further ADDBA requests
    received to be rejected. Fix it by clearing it in the wowlan path
    as well.
    
    Signed-off-by: Eyal Shapira <eyal@wizery.com>
    Reviewed-by: Johannes Berg <johannes@sipsolutions.net>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 2bb9966c233293c9959f4d77a3c994182604472e
Author: Felix Fietkau <nbd@openwrt.org>
Date:   Thu May 24 14:32:20 2012 +0200

    ath9k: fix a use-after-free-bug when ath_tx_setup_buffer() fails
    
    commit 81357a281dcc454841532c46b30e6f2ba12b73ea upstream.
    
    ath_tx_setup_buffer() can fail if there is no ath_buf left, or if mapping DMA
    failed. In this case it frees the skb passed to it.
    If ath_tx_setup_buffer is called from ath_tx_form_aggr, the skb is still
    linked into the tid buffer list and must be dequeued before being released.
    
    Signed-off-by: Felix Fietkau <nbd@openwrt.org>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit c293fd77c4775f517926a61605c35b5bd2bd71cf
Author: Alex Deucher <alexander.deucher@amd.com>
Date:   Wed May 23 11:48:59 2012 -0400

    drm/radeon: fix XFX quirk
    
    commit 1ebf169ad4dc68f18cc0dab35163b0f324fc6c41 upstream.
    
    Only override the ddc bus if the connector doesn't have
    a valid one.  The existing code overrode the ddc bus for
    all connectors even if it had ddc bus.
    
    Fixes ddc on another XFX card with the same pci ids that
    was broken by the quirk overwriting the correct ddc bus.
    
    Reported-by: Mehdi Aqadjani Memar <m.aqadjanimemar@student.ru.nl>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 48a5b2b84d0501885ac992efbf7023c72322a510
Author: Trond Myklebust <Trond.Myklebust@netapp.com>
Date:   Mon May 28 11:36:28 2012 -0400

    NFSv4: Map NFS4ERR_SHARE_DENIED into an EACCES error instead of EIO
    
    commit fb13bfa7e1bcfdcfdece47c24b62f1a1cad957e9 upstream.
    
    If a file OPEN is denied due to a share lock, the resulting
    NFS4ERR_SHARE_DENIED is currently mapped to the default EIO.
    This patch adds a more appropriate mapping, and brings Linux
    into line with what Solaris 10 does.
    
    See https://bugzilla.kernel.org/show_bug.cgi?id=43286
    
    Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 1f529670d44fa70caf368eddfdcea3618aed0d19
Author: Grazvydas Ignotas <notasas@gmail.com>
Date:   Fri May 18 03:04:08 2012 +0300

    wl1251: fix oops on early interrupt
    
    commit f380f2c4a12e913356bd49f8790ec1063c4fe9f8 upstream.
    
    This driver disables interrupt just after requesting it and enables it
    later, after interface is up. However currently there is a time window
    between request_irq() and disable_irq() where if interrupt arrives, the
    driver oopses because it's not yet ready to process it. This can be
    reproduced by inserting the module, associating and removing the module
    multiple times.
    
    Eliminate this race by setting IRQF_NOAUTOEN flag before request_irq().
    
    Signed-off-by: Grazvydas Ignotas <notasas@gmail.com>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>
    [bwh: Backported to 3.2: adjust filename]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 8ed31bfda7baf80e74d138767f7920b58a6e4aeb
Author: Meenakshi Venkataraman <meenakshi.venkataraman@intel.com>
Date:   Wed May 16 22:35:59 2012 +0200

    iwlwifi: do not use shadow registers by default
    
    commit 66a770729a5cdd24efed8afa5258f81232d8bba2 upstream.
    
    Shadow registers in the device are meant to
    allow the driver to update certain device
    registers without needing to wake up all
    components of the device. However, using
    this feature in the device causes
    communication between the driver and the
    device to become unreliable, resulting in
    host command timeouts.
    
    Disable this feature by default till a fix is
    available for the bug.
    
    Signed-off-by: Meenakshi Venkataraman <meenakshi.venkataraman@intel.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 8d65eb751bebd005a06077c7af290760310dafd3
Author: Meenakshi Venkataraman <meenakshi.venkataraman@intel.com>
Date:   Wed May 16 22:35:57 2012 +0200

    iwlwifi: update BT traffic load states correctly
    
    commit 882dde8eb0d49ce0f853f8f4084dde56a21fe55f upstream.
    
    When BT traffic load changes from its
    previous state, a new LQ command needs to be
    sent down to the firmware. This needs to
    be done only once per change. The state
    variable that keeps track of this change is
    last_bt_traffic_load. However, it was not
    being updated when the change had been
    handled. Not updating this variable was
    causing a flood of advanced BT config
    commands to be sent to the firmware. Fix
    this.
    
    Signed-off-by: Meenakshi Venkataraman <meenakshi.venkataraman@intel.com>
    Signed-off-by: Wey-Yi Guy <wey-yi.w.guy@intel.com>
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 0d9dc2404a634843a3325377f0b26186937a6f39
Author: James Bottomley <JBottomley@Parallels.com>
Date:   Mon May 21 07:49:01 2012 +0100

    fix TLB fault path on PA2.0 narrow systems
    
    commit 2f649c1f6f0fef445ce79a19b79e5ce8fe9d7f19 upstream.
    
    commit 5e185581d7c46ddd33cd9c01106d1fc86efb9376
    Author: James Bottomley <JBottomley@Parallels.com>
    
        [PARISC] fix PA1.1 oops on boot
    
    Didn't quite fix the crash on boot.  It moved it from PA1.1 processors to
    PA2.0 narrow kernels.  The final fix is to make sure the [id]tlb_miss_20 paths
    also work.  Even on narrow systems, these paths require using the wide
    instructions becuase the tlb insertion format is wide.  Fix this by
    conditioning the dep[wd],z on whether we're being called from _11 or _20[w]
    paths.
    
    Tested-by: Helge Deller <deller@gmx.de>
    Signed-off-by: James Bottomley <JBottomley@Parallels.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit de05eed7bd858c12fa0e350763db47da0a3b9adb
Author: John David Anglin <dave.anglin@bell.net>
Date:   Thu May 17 10:34:34 2012 -0400

    fix boot failure on 32-bit systems caused by branch stubs placed before .text
    
    commit ed5fb2471b7060767957fb964eb1aaec71533ab1 upstream.
    
    In certain configurations, the resulting kernel becomes too large to boot
    because the linker places the long branch stubs for the merged .text section
    at the very start of the image.  As a result, the initial transfer of control
    jumps to an unexpected location.  Fix this by placing the head text in a
    separate section so the stubs for .text are not at the start of the image.
    
    Signed-off-by: John David Anglin <dave.anglin@bell.net>
    Signed-off-by: James Bottomley <JBottomley@Parallels.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 7e81c4be6d751d87fff5f5d06c6f1b82013684df
Author: Lars-Peter Clausen <lars@metafoo.de>
Date:   Mon Apr 9 15:05:44 2012 +0200

    microblaze: Do not select GENERIC_GPIO by default
    
    commit 59516b07b4ffa7e607a5787674ea3c405f1b390c upstream.
    
    The microblaze architecture does not provide a native GPIO API implementation
    nor requires GPIOLIB, but still selects GENERIC_GPIO by default. As a result the
    following build error occurs, if GPIOLIB is not selected:
    
            include/asm-generic/gpio.h: In function 'gpio_get_value_cansleep':
            include/asm-generic/gpio.h:218: error: implicit declaration of function '__gpio_get_value'
            include/asm-generic/gpio.h: In function 'gpio_set_value_cansleep':
            include/asm-generic/gpio.h:224: error: implicit declaration of function '__gpio_set_value'
    
    This patch addresses the issue by not selecting GENERIC_GPIO by default. This
    causes the GPIO API to be stubbed out if no implementation is provided.
    
    Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
    Tested-by: Michal Simek <monstr@monstr.eu>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 190fcdc0cc35d3eb01a97d9558c6132be0a97475
Author: David Woodhouse <dwmw2@infradead.org>
Date:   Thu May 24 04:58:27 2012 +0000

    solos-pci: Fix DMA support
    
    commit b4bd8ad9bb311e8536f726f7a633620ccd358cde upstream.
    
    DMA support has finally made its way to the top of the TODO list, having
    realised that a Geode using MMIO can't keep up with two ADSL2+ lines
    each running at 21Mb/s.
    
    This patch fixes a couple of bugs in the DMA support in the driver, so
    once the corresponding FPGA update is complete and tested everything
    should work properly.
    
    We weren't storing the currently-transmitting skb, so we were never
    unmapping it and never freeing/popping it when the TX was done.
    And the addition of pci_set_master() is fairly self-explanatory.
    
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit e837ca11bde0ac36eb3563cc31b026d3669419c4
Author: Jesse Barnes <jbarnes@virtuousgeek.org>
Date:   Tue May 22 09:30:33 2012 -0700

    drm/i915: always use RPNSWREQ for turbo change requests
    
    commit 89ba829e38bd500f438bc08af4229204c8ed7f35 upstream.
    
    Media turbo requests can either use RPVSWREQ or RPNSWREQ to indicate
    what the interrupt handler should do.  Since we only deal with the
    latter in our turbo code, make the media engine use that for turbo
    requests.
    
    Tested-by: Joe Bloggsian <joebloggsian@gmail.com>
    Signed-off-by: Jesse Barnes <jbarnes@virtuousgeek.org>
    Reviewed-by: Eugeni Dodonov <eugeni.dodonov@intel.com>
    Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    [bwh: Backported to 3.2: adjust filename]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 3f65169eeca4c217582e5ad252a782acf557cd22
Author: Ben Widawsky <ben@bwidawsk.net>
Date:   Mon Dec 12 19:21:59 2011 -0800

    drm/i915: Update GEN6_RP_CONTROL definitions
    
    commit 6ed55ee7da15329476174bc5821dbc723f671f44 upstream.
    
    This matches the modern specs more accurately.
    
    This will be used by the following patch to fix the way we display RC
    status.
    
    Signed-off-by: Ben Widawsky <ben@bwidawsk.net>
    Reviewed-by: Jesse Barnes <jbarnes@virtuousgeek.org>
    Reviewed-by: Eugeni Dodonov <eugeni.dodonov@intel.com>
    Signed-off-by: Keith Packard <keithp@keithp.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 67c2e0ae1ece3ee0c264fd7db5677a82ce64ea07
Author: Daniel Vetter <daniel.vetter@ffwll.ch>
Date:   Tue May 22 21:41:25 2012 +0200

    drm/i915: wait for a vblank to pass after tv detect
    
    commit bf2125e2f7e931b50a6c76ba0435ba001409ccbf upstream.
    
    Otherwise the hw will get confused and result in a black screen.
    
    This regression has been most likely introduce in
    
    commit 974b93315b2213b74a42a87e8a9d4fc8c0dbe90c
    Author: Chris Wilson <chris@chris-wilson.co.uk>
    Date:   Sun Sep 5 00:44:20 2010 +0100
    
        drm/i915/tv: Poll for DAC state change
    
    That commit replace the first msleep(20) with a busy-loop, but failed
    to keep the 2nd msleep around. Later on we've replaced all these
    msleep(20) by proper vblanks.
    
    For reference also see the commit in xf86-video-intel:
    
    commit 1142be53eb8d2ee8a9b60ace5d49f0ba27332275
    Author: Jesse Barnes <jbarnes@hobbes.lan>
    Date:   Mon Jun 9 08:52:59 2008 -0700
    
        Fix TV programming:  add vblank wait after TV_CTL writes
    
        Fxies FDO bug #14000; we need to wait for vblank after
        writing TV_CTL or following "DPMS on" calls may not actually enable the output.
    
    v2: As suggested by Chris Wilson, add a small comment to ensure that
    no one accidentally removes this vblank wait again - there really
    seems to be no sane explanation for why we need it, but it is
    required.
    
    Launchpad: https://bugs.launchpad.net/ubuntu/+source/xserver-xorg-video-intel/+bug/763688
    Reported-and-Tested-by: Robert Lowery <rglowery@exemail.com.au>
    Cc: Rodrigo Vivi <rodrigo.vivi@gmail.com>
    Acked-by: Chris Wilson <chris@chris-wilson.co.uk>
    Signed-Off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 4dbb08714c286320d16913992ebc4241ed983067
Author: Jan-Benedict Glaw <jan-benedict.glaw@getslash.de>
Date:   Tue May 22 15:21:53 2012 +0200

    drm/i915: no lvds quirk for HP t5740e Thin Client
    
    commit 3347111999870c37eab1b969e90af9fdaf0334ba upstream.
    
    This box has DisplayPort and VGA, but no LVDS. Product specs are at
    http://h10010.www1.hp.com/wwpc/us/en/sm/WF25a/12454-12454-321959-338927-3640406-4282707.html?dnr=1
    and dmidecode output can be found at http://www.getslash.de/bug_attachments/dmidecode-t5740e.txt
    
    Signed-off-by: Jan-Benedict Glaw <jbglaw@getslash.de>
    Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 8fc9cab73ecdf2717eea7055cc7c86b8306bb30c
Author: Marc Gariepy <mgariepy@ubuntu.com>
Date:   Thu Feb 9 09:35:21 2012 -0500

    drm/i915: Ignore LVDS on hp t5745 and hp st5747 thin client
    
    commit f5b8a7ed0405d48fd096acce48fbefbed77fb055 upstream.
    
    Add a no_lvds quirk for the HP t5745 and HP st5747 thin clients
    
    dmidecode for those thin clients are attached in thoses bugs:
    https://bugs.launchpad.net/ubuntu/+source/linux/+bug/911916
    https://bugs.launchpad.net/ubuntu/+source/linux/+bug/911920
    
    Signed-off-by: Marc Gariepy <mgariepy@ubuntu.com>
    Acked-by: Adam Jackson <ajax@redhat.com>
    Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    [bwh: Backported to 3.2: adjust context because these quirk entries aren't
     consistently cc'd to stable and are now being applied out of order]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit f3efc1d293abcc484ac06107d1480cf792ccf8c1
Author: Joel Sass <jsass@disklessworkstations.com>
Date:   Tue Jan 10 13:03:55 2012 -0500

    drm/i915: Add Clientron E830 to the ignore LVDS list
    
    commit 44306ab302687b519a31aa498b954c1e26f95a6b upstream.
    
    Signed-off-by: Joel Sass <jsass@disklessworkstations.com>
    Reviewed-by: Adam Jackson <ajax@redhat.com>
    Signed-off-by: Keith Packard <keithp@keithp.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit fd57a22a60c0fafc027f99bc8fca77845a1f8cfd
Author: Daniel Vetter <daniel.vetter@ffwll.ch>
Date:   Sun May 20 17:14:50 2012 +0200

    drm/i915: enable vdd when switching off the eDP panel
    
    commit 6cb49835da0426f69a2931bc2a0a8156344b0e41 upstream.
    
    We have one bug report from a validation team that we get the eDP
    panel sequencing still somewhat wrong: We need to enable VDD while
    switching off the panel and backlight. Unfortunately that reporter
    seems to have fallen off the earth :(
    
    For another reporter this actually fixes a black panel issue because
    without this the backlight/panel gets confused and doesn't light up
    again.
    
    v2: I've forgotten to remove the vdd_off call in panel_off which is
    now bogus. This essentially reverts
    
    commit 17038de5f16569a25343cf68668f3b657eafb00e
    Author: Chris Wilson <chris@chris-wilson.co.uk>
    Date:   Mon Apr 16 22:43:42 2012 +0100
    
        drm/i915/dp: Flush any outstanding work to turn the VDD off
    
    v3: the current panel_off code forces off the vdd power, too. Which is
    bogus and resulted in some funny warnings later on when we've tried to
    do aux channel communications with just the vdd forced on. Fix this,
    too.
    
    Bugzilla: https://bugs.freedesktop.org/show_bug.cgi?id=46312
    Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=43163
    Tested-by: Vincent Frentzel <zcecc22@gmail.com>
    Reviewed-by: Jesse Barnes <jbarnes@virtuousgeek.org>
    Signed-Off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    [bwh: Backported to 3.2: nothing to revert here]
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 02bc2328ac513673654c6045a06ef0ac9e8fa177
Author: Daniel Vetter <daniel.vetter@ffwll.ch>
Date:   Sat May 12 22:22:58 2012 +0200

    drm/i915: properly handle interlaced bit for sdvo dtd conversion
    
    commit 59d92bfa5f0cdf57f82f5181b0ad6af75c3fdf41 upstream.
    
    We've simply ignored this, which isn't too great. With this, interlaced
    1080i works on my HDMI screen connected through sdvo. For no apparent
    reason anything else still doesn't work as it should.
    
    While at it, give these magic numbers in the dtd proper names and
    add a comment that they match with EDID detailed timings.
    
    v2: Actually use the right bit for interlaced.
    
    Tested-by: Peter Ross <pross@xvid.org>
    Reviewed-by: Paulo Zanoni <paulo.r.zanoni@intel.com>
    Signed-Off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 9312f772b16ccee577a2396e3b455ad85e929ac8
Author: Richard Cochran <richardcochran@gmail.com>
Date:   Wed May 23 18:19:51 2012 +0200

    ixp4xx: fix compilation by adding gpiolib support
    
    commit 9dde0ae3769875ec1370cb316e50c54b57d52c1a upstream.
    
    Once again, ixp4xx no longer even compiles. This patch fixes the issue
    by converting over to gpiolib. This patch was first made by Imre and
    posted by Marc, and I added in Russell's suggestion to empty the gpio
    header file.
    
    This fix should also go for 3.1, 3.2, 3.3, and 3.4.
    
    Signed-off-by: Richard Cochran <richardcochran@gmail.com>
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 2302e9e4e1aba6a92d872a1361089689252d044b
Author: Jun'ichi Nomura <j-nomura@ce.jp.nec.com>
Date:   Tue May 22 18:57:17 2012 +0900

    Fix dm-multipath starvation when scsi host is busy
    
    commit b7e94a1686c5daef4f649f7f4f839cc294f07710 upstream.
    
    block congestion control doesn't have any concept of fairness across
    multiple queues.  This means that if SCSI reports the host as busy in
    the queue congestion control it can result in an unfair starvation
    situation in dm-mp if there are multiple multipath devices on the same
    host.  For example:
    http://www.redhat.com/archives/dm-devel/2012-May/msg00123.html
    
    The fix for this is to report only the sdev busy state (and ignore the
    host busy state) in the block congestion control call back.
    The host is still congested, but the SCSI subsystem will sort out the
    congestion in a fair way because it knows the relation between the
    queues and the host.
    
    [jejb: fixed up trailing whitespace]
    Reported-by: Bernd Schubert <bernd.schubert@itwm.fraunhofer.de>
    Tested-by: Bernd Schubert <bernd.schubert@itwm.fraunhofer.de>
    Signed-off-by: Jun'ichi Nomura <j-nomura@ce.jp.nec.com>
    Signed-off-by: James Bottomley <JBottomley@Parallels.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 7a35b41ff5811ed26e5265ad2c594062e4565571
Author: Shirish Pargaonkar <shirishpargaonkar@gmail.com>
Date:   Mon May 21 09:20:12 2012 -0500

    cifs: fix oops while traversing open file list (try #4)
    
    commit 2c0c2a08bed7a3b791f88d09d16ace56acb3dd98 upstream.
    
    While traversing the linked list of open file handles, if the identfied
    file handle is invalid, a reopen is attempted and if it fails, we
    resume traversing where we stopped and cifs can oops while accessing
    invalid next element, for list might have changed.
    
    So mark the invalid file handle and attempt reopen if no
    valid file handle is found in rest of the list.
    If reopen fails, move the invalid file handle to the end of the list
    and start traversing the list again from the begining.
    Repeat this four times before giving up and returning an error if
    file reopen keeps failing.
    
    Signed-off-by: Shirish Pargaonkar <shirishpargaonkar@gmail.com>
    Reviewed-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Steve French <sfrench@us.ibm.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 27b4384504c58e94b0938b467261f893aeab9966
Author: Boaz Harrosh <bharrosh@panasas.com>
Date:   Wed May 16 14:22:21 2012 +0300

    exofs: Fix CRASH on very early IO errors.
    
    commit 6abe4a87f7bc7978705c386dbba0ca0c7790b3ec upstream.
    
    If at exofs_fill_super() we had an early termination
    do to any error, like an IO error while reading the
    super-block. We would crash inside exofs_free_sbi().
    
    This is because sbi->oc.numdevs was set to 1, before
    we actually have a device table at all.
    
    Fix it by moving the sbi->oc.numdevs = 1 to after the
    allocation of the device table.
    
    Reported-by: Johannes Schild <JSchild@gmx.de>
    
    Stable: This is a bug since v3.2.0
    Signed-off-by: Boaz Harrosh <bharrosh@panasas.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit b35e0437787ca030484a278d052d3aada0bb9947
Author: Trond Myklebust <Trond.Myklebust@netapp.com>
Date:   Sat May 19 12:12:53 2012 -0400

    sunrpc: fix loss of task->tk_status after rpc_delay call in xprt_alloc_slot
    
    commit 1afeaf5c29aa07db25760d2fbed5c08a3aec3498 upstream.
    
    xprt_alloc_slot will call rpc_delay() to make the task wait a bit before
    retrying when it gets back an -ENOMEM error from xprt_dynamic_alloc_slot.
    The problem is that rpc_delay will clear the task->tk_status, causing
    call_reserveresult to abort the task.
    
    The solution is simply to let call_reserveresult handle the ENOMEM error
    directly.
    
    Reported-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 90f560e0729cc5483324673cb13522b8abcd8ca5
Author: Shirish Pargaonkar <shirishpargaonkar@gmail.com>
Date:   Tue May 15 10:19:16 2012 -0500

    cifs: Include backup intent search flags during searches {try #2)
    
    commit 2608bee744a92d60d15ff4e6e0b913d8b406aedd upstream.
    
    As observed and suggested by Tushar Gosavi...
    
    ---------
    readdir calls these function to send TRANS2_FIND_FIRST and
    TRANS2_FIND_NEXT command to the server. The current cifs module is
    not specifying CIFS_SEARCH_BACKUP_SEARCH flag while sending these
    command when backupuid/backupgid is specified. This can be resolved
    by specifying CIFS_SEARCH_BACKUP_SEARCH flag.
    ---------
    
    Reported-and-Tested-by: Tushar Gosavi <tugosavi@in.ibm.com>
    Signed-off-by: Shirish Pargaonkar <shirishpargaonkar@gmail.com>
    Acked-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Steve French <sfrench@us.ibm.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 6f6cc143f453b606839aac415e7b30fada258c08
Author: Jonas Gorski <jonas.gorski@gmail.com>
Date:   Tue May 15 17:47:52 2012 +0200

    MIPS: BCM63XX: Add missing include for bcm63xx_gpio.h
    
    commit 442209f31dafef9fde852858e1ce566b675b720d upstream.
    
    bcm63xx_gpio.h uses macros defined in bcm63xx_cpu.h without including it,
    leading to the following build failure:
    
      CC [M]  drivers/mmc/core/cd-gpio.o
    In file included from arch/mips/include/asm/mach-bcm63xx/gpio.h:4:0,
                     from arch/mips/include/asm/gpio.h:4,
                     from include/linux/gpio.h:30,
                     from drivers/mmc/core/cd-gpio.c:12:
    
    arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h: In function 'bcm63xx_gpio_count':
    arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h:10:2: error: implicit declaration of function 'bcm63xx_get_cpu_id'
    arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h:11:7: error: 'BCM6358_CPU_ID' undeclared (first use in this function)
    arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h:11:7: note: each undeclared identifier is reported only once for each function it appears in
    arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h:13:7: error: 'BCM6338_CPU_ID' undeclared (first use in this function)
    arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h:15:7: error: 'BCM6345_CPU_ID' undeclared (first use in this function)
    arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h:17:7: error: 'BCM6368_CPU_ID' undeclared (first use in this function)
    arch/mips/include/asm/mach-bcm63xx/bcm63xx_gpio.h:19:7: error: 'BCM6348_CPU_ID' undeclared (first use in this function)
    
    make[7]: *** [drivers/mmc/core/cd-gpio.o] Error 1
    
    Signed-off-by: Jonas Gorski <jonas.gorski@gmail.com>
    Cc: linux-mips@linux-mips.org
    Cc: Maxime Bizon <mbizon@freebox.fr>
    Cc: Florian Fainelli <florian@openwrt.org>
    Signed-off-by: Ralf Baechle <ralf@linux-mips.org>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>

commit 322a3fe8c915cdf512a510ad1bd359f8e0ed9a86
Author: Joerg Roedel <joerg.roedel@amd.com>
Date:   Thu Apr 12 14:12:00 2012 +0200

    iommu/amd: Add workaround for event log erratum
    
    commit 3d06fca8d2aa3543030e40b95f1d62f9f5a03540 upstream.
    
    Due to a recent erratum it can happen that the head pointer
    of the event-log is updated before the actual event-log
    entry is written. This patch implements the recommended
    workaround.
    
    Signed-off-by: Joerg Roedel <joerg.roedel@amd.com>
    Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
