commit 0147c2ae9d602b5791dae30322ece475271acd10
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Fri Apr 13 09:11:03 2012 -0700

    Linux 3.2.15

commit 1c5b4f2f9d7b36fb5d78f959705af57cc0233de9
Author: Peter Hurley <peter@hurleysoftware.com>
Date:   Mon Apr 2 13:44:56 2012 +0200

    Bluetooth: Fix l2cap conn failures for ssp devices
    
    commit 18daf1644e634bae951a6e3d4d19d89170209762 upstream
    
    Commit 330605423c fixed l2cap conn establishment for non-ssp remote
    devices by not setting HCI_CONN_ENCRYPT_PEND every time conn security
    is tested (which was always returning failure on any subsequent
    security checks).
    
    However, this broke l2cap conn establishment for ssp remote devices
    when an ACL link was already established at SDP-level security. This
    fix ensures that encryption must be pending whenever authentication
    is also pending.
    
    Signed-off-by: Peter Hurley <peter@hurleysoftware.com>
    Tested-by: Daniel Wagner <daniel.wagner@bmw-carit.de>
    Acked-by: Marcel Holtmann <marcel@holtmann.org>
    Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>

commit daf8a004df0ec601460d594c1ac9e9cfd938cb75
Author: Joerg Roedel <joerg.roedel@amd.com>
Date:   Wed Apr 11 18:40:38 2012 +0200

    iommu/amd: Make sure IOMMU interrupts are re-enabled on resume
    
    commit 9ddd592a191b32f2ee6c4b6ed2bd52665c3a49f5 upstream
    
    Unfortunatly the interrupts for the event log and the
    peripheral page-faults are only enabled at boot but not
    re-enabled at resume. Fix that for 3.2.
    
    Cc: stable@vger.kernel.org
    Signed-off-by: Joerg Roedel <joerg.roedel@amd.com>

commit fbb67524e89163c020c3588aec36f3013da0e56e
Author: Oleg Nesterov <oleg@redhat.com>
Date:   Mon Apr 9 21:03:50 2012 +0200

    cred: copy_process() should clear child->replacement_session_keyring
    
    commit 79549c6dfda0603dba9a70a53467ce62d9335c33 upstream.
    
    keyctl_session_to_parent(task) sets ->replacement_session_keyring,
    it should be processed and cleared by key_replace_session_keyring().
    
    However, this task can fork before it notices TIF_NOTIFY_RESUME and
    the new child gets the bogus ->replacement_session_keyring copied by
    dup_task_struct(). This is obviously wrong and, if nothing else, this
    leads to put_cred(already_freed_cred).
    
    change copy_creds() to clear this member. If copy_process() fails
    before this point the wrong ->replacement_session_keyring doesn't
    matter, exit_creds() won't be called.
    
    Signed-off-by: Oleg Nesterov <oleg@redhat.com>
    Acked-by: David Howells <dhowells@redhat.com>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b0a4205ff563f69026c852834a78a1a5952421b2
Author: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
Date:   Wed Apr 4 23:28:01 2012 -0700

    ASoC: ak4642: fixup: mute needs +1 step
    
    commit 1f99e44cf059d2ed43c5a0724fa738b83800f725 upstream.
    
    ak4642 out_tlv is +12.0dB to -115.0 dB, and it supports mute.
    But current settings didn't care +1 step for mute.
    This patch adds it
    
    Signed-off-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6edff982fee8f69e496321147e32dd3eb70bc5cc
Author: Dan Williams <dan.j.williams@intel.com>
Date:   Fri Mar 23 13:36:42 2012 -0700

    ioat: fix size of 'completion' for Xen
    
    commit 275029353953c2117941ade84f02a2303912fad1 upstream.
    
    Starting with v3.2 Jonathan reports that Xen crashes loading the ioatdma
    driver.  A debug run shows:
    
      ioatdma 0000:00:16.4: desc[0]: (0x300cc7000->0x300cc7040) cookie: 0 flags: 0x2 ctl: 0x29 (op: 0 int_en: 1 compl: 1)
      ...
      ioatdma 0000:00:16.4: ioat_get_current_completion: phys_complete: 0xcc7000
    
    ...which shows that in this environment GFP_KERNEL memory may be backed
    by a 64-bit dma address.  This breaks the driver's assumption that an
    unsigned long should be able to contain the physical address for
    descriptor memory.  Switch to dma_addr_t which beyond being the right
    size, is the true type for the data i.e. an io-virtual address
    inidicating the engine's last processed descriptor.
    
    Reported-by: Jonathan Nieder <jrnieder@gmail.com>
    Reported-by: William Dauchy <wdauchy@gmail.com>
    Tested-by: William Dauchy <wdauchy@gmail.com>
    Tested-by: Dave Jiang <dave.jiang@intel.com>
    Signed-off-by: Dan Williams <dan.j.williams@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e9bb42585941aa85624a457aff922604aa041a57
Author: Guan Xin <guanx.bac@gmail.com>
Date:   Mon Mar 26 04:11:46 2012 +0000

    USB: Add Motorola Rokr E6 Id to the USBNet driver "zaurus"
    
    commit a2daf263107ba3eb6db33931881731fa51c95045 upstream.
    
    Added Vendor/Device Id of Motorola Rokr E6 (22b8:6027) so it can be
    recognized by the "zaurus" USBNet driver.
    Applies to Linux 3.2.13 and 2.6.39.4.
    Signed-off-by: Guan Xin <guanx.bac@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5071aa97c540286cb979b64aebf4ca142f858529
Author: Nishanth Menon <nm@ti.com>
Date:   Wed Feb 22 20:03:45 2012 -0600

    mfd: Clear twl6030 IRQ status register only once
    
    commit 3f8349e6e98ba0455437724589072523865eae5e upstream.
    
    TWL6030 family of PMIC use a shadow interrupt status register
    while kernel processes the current interrupt event.
    However, any write(0 or 1) to register INT_STS_A, INT_STS_B or
    INT_STS_C clears all 3 interrupt status registers.
    
    Since clear of the interrupt is done on 32k clk, depending on I2C
    bus speed, we could in-adverently clear the status of a interrupt
    status pending on shadow register in the current implementation.
    This is due to the fact that multi-byte i2c write operation into
    three seperate status register could result in multiple load
    and clear of status and result in lost interrupts.
    
    Instead, doing a single byte write to INT_STS_A register with 0x0
    will clear all three interrupt status registers without the related
    risk.
    
    Acked-by: Santosh Shilimkar <santosh.shilimkar@ti.com>
    Signed-off-by: Nishanth Menon <nm@ti.com>
    Signed-off-by: Samuel Ortiz <sameo@linux.intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 193bc3a0209aececb61262bd432e82710c2d499a
Author: Salman Qazi <sqazi@google.com>
Date:   Fri Mar 9 16:41:01 2012 -0800

    sched/x86: Fix overflow in cyc2ns_offset
    
    commit 9993bc635d01a6ee7f6b833b4ee65ce7c06350b1 upstream.
    
    When a machine boots up, the TSC generally gets reset.  However,
    when kexec is used to boot into a kernel, the TSC value would be
    carried over from the previous kernel.  The computation of
    cycns_offset in set_cyc2ns_scale is prone to an overflow, if the
    machine has been up more than 208 days prior to the kexec.  The
    overflow happens when we multiply *scale, even though there is
    enough room to store the final answer.
    
    We fix this issue by decomposing tsc_now into the quotient and
    remainder of division by CYC2NS_SCALE_FACTOR and then performing
    the multiplication separately on the two components.
    
    Refactor code to share the calculation with the previous
    fix in __cycles_2_ns().
    
    Signed-off-by: Salman Qazi <sqazi@google.com>
    Acked-by: John Stultz <john.stultz@linaro.org>
    Acked-by: Peter Zijlstra <a.p.zijlstra@chello.nl>
    Cc: Paul Turner <pjt@google.com>
    Cc: john stultz <johnstul@us.ibm.com>
    Link: http://lkml.kernel.org/r/20120310004027.19291.88460.stgit@dungbeetle.mtv.corp.google.com
    Signed-off-by: Ingo Molnar <mingo@elte.hu>
    Cc: Mike Galbraith <efault@gmx.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a94841724154dac38ce5239d1d88c00e758dc20d
Author: Sachin Prabhu <sprabhu@redhat.com>
Date:   Thu Mar 22 16:46:28 2012 +0000

    Fix length of buffer copied in __nfs4_get_acl_uncached
    
    commit 20e0fa98b751facf9a1101edaefbc19c82616a68 upstream.
    
    _copy_from_pages() used to copy data from the temporary buffer to the
    user passed buffer is passed the wrong size parameter when copying
    data. res.acl_len contains both the bitmap and acl lenghts while
    acl_len contains the acl length after adjusting for the bitmap size.
    
    Signed-off-by: Sachin Prabhu <sprabhu@redhat.com>
    Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
    Cc: Josh Boyer <jwboyer@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6160e6a7942f2052d76385ccd9b16e6d567f4000
Author: Lee, Chun-Yi <joeyli.kernel@gmail.com>
Date:   Fri Mar 23 12:36:44 2012 +0800

    acer-wmi: No wifi rfkill on Sony machines
    
    commit 5719b81988f3c24ff694dc3a37e35b35630a3966 upstream.
    
    The wireless rfkill should charged by sony-laptop but not acer-wmi.
    So, add Sony's SNY5001 acpi device to blacklist in acer-wmi.
    
    Tested on Sony Vaio
    
    Cc: Carlos Corbacho <carlos@strangeworlds.co.uk>
    Cc: Matthew Garrett <mjg@redhat.com>
    Cc: Mattia Dongili <malattia@linux.it>
    Cc: Dimitris N <ddarlac@gmail.com>
    Tested-by: Dimitris N <ddarlac@gmail.com>
    Signed-off-by: Lee, Chun-Yi <jlee@suse.com>
    Signed-off-by: Matthew Garrett <mjg@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ae4698ab01272cdbc81e57c8132fefde03861065
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Tue Apr 10 16:04:49 2012 -0700

    Revert "x86/ioapic: Add register level checks to detect bogus io-apic entries"
    
    This reverts commit 273fb194e86b795b08a724c7646d0f694949070b
    [73d63d038ee9f769f5e5b46792d227fe20e442c5 upstream]
    
    It causes problems, so needs to be reverted from 3.2-stable for now.
    
    Reported-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
    Cc: Jon Dufresne <jon@jondufresne.org>
    Cc: Suresh Siddha <suresh.b.siddha@intel.com>
    Cc: <yinghai@kernel.org>
    Cc: Josh Boyer <jwboyer@redhat.com>
    Cc: Ingo Molnar <mingo@elte.hu>
    Cc: Teck Choon Giam <giamteckchoon@gmail.com>
    Cc: Ben Guthro <ben@guthro.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ddfdc39959c916766a3264facffc75fbba3d7f4c
Author: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>
Date:   Wed Feb 29 21:53:22 2012 +0900

    TOMOYO: Fix mount flags checking order.
    
    commit df91e49477a9be15921cb2854e1d12a3bdb5e425 upstream.
    
    Userspace can pass in arbitrary combinations of MS_* flags to mount().
    
    If both MS_BIND and one of MS_SHARED/MS_PRIVATE/MS_SLAVE/MS_UNBINDABLE are
    passed, device name which should be checked for MS_BIND was not checked because
    MS_SHARED/MS_PRIVATE/MS_SLAVE/MS_UNBINDABLE had higher priority than MS_BIND.
    
    If both one of MS_BIND/MS_MOVE and MS_REMOUNT are passed, device name which
    should not be checked for MS_REMOUNT was checked because MS_BIND/MS_MOVE had
    higher priority than MS_REMOUNT.
    
    Fix these bugs by changing priority to MS_REMOUNT -> MS_BIND ->
    MS_SHARED/MS_PRIVATE/MS_SLAVE/MS_UNBINDABLE -> MS_MOVE as with do_mount() does.
    
    Also, unconditionally return -EINVAL if more than one of
    MS_SHARED/MS_PRIVATE/MS_SLAVE/MS_UNBINDABLE is passed so that TOMOYO will not
    generate inaccurate audit logs, for commit 7a2e8a8f "VFS: Sanity check mount
    flags passed to change_mnt_propagation()" clarified that these flags must be
    exclusively passed.
    
    Signed-off-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>
    Signed-off-by: James Morris <james.l.morris@oracle.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a22f4d0a2c2e59e6cd52dfac2ba916c82c5cb3be
Author: Jonathan Nieder <jrnieder@gmail.com>
Date:   Tue Feb 28 15:31:35 2012 -0600

    x86/PCI: do not tie MSI MS-7253 use_crs quirk to BIOS version
    
    commit a97f4f5e524bcd09a85ef0b8821a14d35e69335f upstream.
    
    Carlos was getting
    
            WARNING: at drivers/pci/pci.c:118 pci_ioremap_bar+0x24/0x52()
    
    when probing his sound card, and sound did not work.  After adding
    pci=use_crs to the kernel command line, no more trouble.
    
    Ok, we can add a quirk.  dmidecode output reveals that this is an MSI
    MS-7253, for which we already have a quirk, but the short-sighted
    author tied the quirk to a single BIOS version, making it not kick in
    on Carlos's machine with BIOS V1.2.  If a later BIOS update makes it
    no longer necessary to look at the _CRS info it will still be
    harmless, so let's stop trying to guess which versions have and don't
    have accurate _CRS tables.
    
    Addresses https://bugtrack.alsa-project.org/alsa-bug/view.php?id=5533
    Also see <https://bugzilla.kernel.org/show_bug.cgi?id=42619>.
    
    Reported-by: Carlos Luna <caralu74@gmail.com>
    Reviewed-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Jonathan Nieder <jrnieder@gmail.com>
    Signed-off-by: Jesse Barnes <jbarnes@virtuousgeek.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c5c31309b1f442ea69eaf64d2e42f9489b3eae84
Author: Jonathan Nieder <jrnieder@gmail.com>
Date:   Tue Feb 28 11:51:10 2012 -0700

    x86/PCI: use host bridge _CRS info on MSI MS-7253
    
    commit 8411371709610c826bf65684f886bfdfb5780ca1 upstream.
    
    In the spirit of commit 29cf7a30f8a0 ("x86/PCI: use host bridge _CRS
    info on ASUS M2V-MX SE"), this DMI quirk turns on "pci_use_crs" by
    default on a board that needs it.
    
    This fixes boot failures and oopses introduced in 3e3da00c01d0
    ("x86/pci: AMD one chain system to use pci read out res").  The quirk
    is quite targetted (to a specific board and BIOS version) for two
    reasons:
    
     (1) to emphasize that this method of tackling the problem one quirk
         at a time is a little insane
    
     (2) to give BIOS vendors an opportunity to use simpler tables and
         allow us to return to generic behavior (whatever that happens to
         be) with a later BIOS update
    
    In other words, I am not at all happy with having quirks like this.
    But it is even worse for the kernel not to work out of the box on
    these machines, so...
    
    Reference: https://bugzilla.kernel.org/show_bug.cgi?id=42619
    Reported-by: Svante Signell <svante.signell@telia.com>
    Signed-off-by: Jonathan Nieder <jrnieder@gmail.com>
    Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
    Signed-off-by: Jesse Barnes <jbarnes@virtuousgeek.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5fb8a151e767140e21da2cb83bf49be7755305f9
Author: Frank Rowand <frowand.list@gmail.com>
Date:   Mon Apr 9 17:59:03 2012 -0700

    modpost: Fix modpost license checking of vmlinux.o
    
    commit 258f742635360175564e9470eb060ff4d4b984e7 upstream.
    
    Commit f02e8a6596b7 ("module: Sort exported symbols") sorts symbols
    placing each of them in its own elf section.  This sorting and merging
    into the canonical sections are done by the linker.
    
    Unfortunately modpost to generate Module.symvers file parses vmlinux.o
    (which is not linked yet) and all modules object files (which aren't
    linked yet).  These aren't sanitized by the linker yet.  That breaks
    modpost that can't detect license properly for modules.
    
    This patch makes modpost aware of the new exported symbols structure.
    
    [ This above is a slightly corrected version of the explanation of the
      problem, copied from commit 62a2635610db ("modpost: Fix modpost's
      license checking V3").  That commit fixed the problem for module
      object files, but not for vmlinux.o.  This patch fixes modpost for
      vmlinux.o. ]
    
    Signed-off-by: Frank Rowand <frank.rowand@am.sony.com>
    Signed-off-by: Alessio Igor Bogani <abogani@kernel.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7e2d1469b5835ce42794f5bb7d160cd3ca81673f
Author: Kees Cook <keescook@chromium.org>
Date:   Wed Apr 4 11:40:19 2012 -0700

    sysctl: fix write access to dmesg_restrict/kptr_restrict
    
    commit 620f6e8e855d6d447688a5f67a4e176944a084e8 upstream.
    
    Commit bfdc0b4 adds code to restrict access to dmesg_restrict,
    however, it incorrectly alters kptr_restrict rather than
    dmesg_restrict.
    
    The original patch from Richard Weinberger
    (https://lkml.org/lkml/2011/3/14/362) alters dmesg_restrict as
    expected, and so the patch seems to have been misapplied.
    
    This adds the CAP_SYS_ADMIN check to both dmesg_restrict and
    kptr_restrict, since both are sensitive.
    
    Reported-by: Phillip Lougher <plougher@redhat.com>
    Signed-off-by: Kees Cook <keescook@chromium.org>
    Acked-by: Serge Hallyn <serge.hallyn@canonical.com>
    Acked-by: Richard Weinberger <richard@nod.at>
    Signed-off-by: James Morris <james.l.morris@oracle.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit aba6427f057d78fc9a5051d1b57f5c4798811b7c
Author: Mark Rustad <mark.d.rustad@intel.com>
Date:   Tue Apr 3 10:24:52 2012 -0700

    tcm_fc: Do not free tpg structure during wq allocation failure
    
    commit 06383f10c49f507220594a455c6491ca6f8c94ab upstream.
    
    Avoid freeing a registered tpg structure if an alloc_workqueue call
    fails.  This fixes a bug where the failure was leaking memory associated
    with se_portal_group setup during the original core_tpg_register() call.
    
    Signed-off-by: Mark Rustad <mark.d.rustad@intel.com>
    Acked-by: Kiran Patil <Kiran.patil@intel.com>
    Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3e9e7cc0e5cf8d8234bce7b85692f2c6082e1e85
Author: Mark Rustad <mark.d.rustad@intel.com>
Date:   Tue Apr 3 10:24:41 2012 -0700

    tcm_fc: Add abort flag for gracefully handling exchange timeout
    
    commit e1c4038282c7586c3544542b37872c434669d3ac upstream.
    
    Add abort flag and use it to terminate processing when an exchange
    is timed out or is reset. The abort flag is used in place of the
    transport_generic_free_cmd function call in the reset and timeout
    cases, because calling that function in that context would free
    memory that was in use. The aborted flag allows the lifetime to
    be managed in a more normal way, while truncating the processing.
    
    This change eliminates a source of memory corruption which
    manifested in a variety of ugly ways.
    
    (nab: Drop unused struct fc_exch *ep in ft_recv_seq)
    
    Signed-off-by: Mark Rustad <mark.d.rustad@intel.com>
    Acked-by: Kiran Patil <Kiran.patil@intel.com>
    Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bd4a0cb6f12b87c701f25519acb89308321023d9
Author: Ludovic Desroches <ludovic.desroches@atmel.com>
Date:   Wed Mar 28 12:28:33 2012 +0200

    mmc: atmel-mci: correct data timeout computation
    
    commit 66292ad92c6d3f2f1c137a1c826b331ca8595dfd upstream.
    
    The HSMCI operates at a rate of up to Master Clock divided by two.
    Moreover previous calculation can cause overflows and so wrong
    timeouts.
    
    Signed-off-by: Ludovic Desroches <ludovic.desroches@atmel.com>
    Acked-by: Nicolas Ferre <nicolas.ferre@atmel.com>
    Signed-off-by: Chris Ball <cjb@laptop.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1a042a419c438247391b0943092541de662ca683
Author: Alf Høgemark <alf@i100.no>
Date:   Wed Apr 4 12:27:09 2012 -0400

    mmc: sdhci-dove: Fix compile error by including module.h
    
    commit 8c2fc8e413ecc2c96b696e28d4eb1bc6cee8dc84 upstream.
    
    This patch fixes a compile error in drivers/mmc/host/sdhci-dove.c
    by including the linux/module.h file.
    
    Signed-off-by: Alf Høgemark <alf@i100.no>
    Signed-off-by: Chris Ball <cjb@laptop.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 95e465deb2cf36f1ebc48df3e061a34e7b9a9b1a
Author: Stephen Warren <swarren@nvidia.com>
Date:   Thu Apr 5 16:50:05 2012 -0600

    ARM: tegra: remove Tegra30 errata from MACH_TEGRA_DT
    
    [no upstream commit match, as this is a fix for a mis-applied patch in the
    previous 3.2-stable release. - gregkh]
    
    Commit 83e4194 "ARM: tegra: select required CPU and L2 errata options"
    contained two chunks; one was errata for Tegra20 (correctly applied)
    and the second errata for Tegra30. The latter was accidentally applied
    to the wrong config option; Tegra30 support wasn't added until v3.3,
    and so the second chunk should have just been dropped. This patch does
    so.
    
    Signed-off-by: Stephen Warren <swarren@nvidia.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2d5e264758e31dd1d1e609a5a4d3d6dc693b9d2e
Author: Pavel Shilovsky <piastry@etersoft.ru>
Date:   Wed Mar 28 21:56:19 2012 +0400

    CIFS: Fix VFS lock usage for oplocked files
    
    commit 66189be74ff5f9f3fd6444315b85be210d07cef2 upstream.
    
    We can deadlock if we have a write oplock and two processes
    use the same file handle. In this case the first process can't
    unlock its lock if the second process blocked on the lock in the
    same time.
    
    Fix it by using posix_lock_file rather than posix_lock_file_wait
    under cinode->lock_mutex. If we request a blocking lock and
    posix_lock_file indicates that there is another lock that prevents
    us, wait untill that lock is released and restart our call.
    
    Acked-by: Jeff Layton <jlayton@redhat.com>
    Signed-off-by: Pavel Shilovsky <piastry@etersoft.ru>
    Signed-off-by: Steve French <sfrench@us.ibm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fdf8d98d89726f435f4d7f89fc898340c2f47bc9
Author: Jason Wessel <jason.wessel@windriver.com>
Date:   Fri Mar 23 09:35:05 2012 -0500

    x86,kgdb: Fix DEBUG_RODATA limitation using text_poke()
    
    commit 3751d3e85cf693e10e2c47c03c8caa65e171099b upstream.
    
    There has long been a limitation using software breakpoints with a
    kernel compiled with CONFIG_DEBUG_RODATA going back to 2.6.26. For
    this particular patch, it will apply cleanly and has been tested all
    the way back to 2.6.36.
    
    The kprobes code uses the text_poke() function which accommodates
    writing a breakpoint into a read-only page.  The x86 kgdb code can
    solve the problem similarly by overriding the default breakpoint
    set/remove routines and using text_poke() directly.
    
    The x86 kgdb code will first attempt to use the traditional
    probe_kernel_write(), and next try using a the text_poke() function.
    The break point install method is tracked such that the correct break
    point removal routine will get called later on.
    
    Cc: x86@kernel.org
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Ingo Molnar <mingo@redhat.com>
    Cc: H. Peter Anvin <hpa@zytor.com>
    Inspried-by: Masami Hiramatsu <masami.hiramatsu.pt@hitachi.com>
    Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 706e51dedb8c4d05cf9f4feb1cfecc3d5618f2bf
Author: Jason Wessel <jason.wessel@windriver.com>
Date:   Thu Mar 29 17:41:24 2012 -0500

    kgdbts: (2 of 2) fix single step awareness to work correctly with SMP
    
    commit 23bbd8e346f1ef3fc1219c79cea53d8d52b207d8 upstream.
    
    The do_fork and sys_open tests have never worked properly on anything
    other than a UP configuration with the kgdb test suite.  This is
    because the test suite did not fully implement the behavior of a real
    debugger.  A real debugger tracks the state of what thread it asked to
    single step and can correctly continue other threads of execution or
    conditionally stop while waiting for the original thread single step
    request to return.
    
    Below is a simple method to cause a fatal kernel oops with the kgdb
    test suite on a 2 processor ARM system:
    
    while [ 1 ] ; do ls > /dev/null 2> /dev/null; done&
    while [ 1 ] ; do ls > /dev/null 2> /dev/null; done&
    echo V1I1F100 > /sys/module/kgdbts/parameters/kgdbts
    
    Very soon after starting the test the kernel will start warning with
    messages like:
    
    kgdbts: BP mismatch c002487c expected c0024878
    ------------[ cut here ]------------
    WARNING: at drivers/misc/kgdbts.c:317 check_and_rewind_pc+0x9c/0xc4()
    [<c01f6520>] (check_and_rewind_pc+0x9c/0xc4)
    [<c01f595c>] (validate_simple_test+0x3c/0xc4)
    [<c01f60d4>] (run_simple_test+0x1e8/0x274)
    
    The kernel will eventually recovers, but the test suite has completely
    failed to test anything useful.
    
    This patch implements behavior similar to a real debugger that does
    not rely on hardware single stepping by using only software planted
    breakpoints.
    
    In order to mimic a real debugger, the kgdb test suite now tracks the
    most recent thread that was continued (cont_thread_id), with the
    intent to single step just this thread.  When the response to the
    single step request stops in a different thread that hit the original
    break point that thread will now get continued, while the debugger
    waits for the thread with the single step pending.  Here is a high
    level description of the sequence of events.
    
       cont_instead_of_sstep = 0;
    
    1) set breakpoint at do_fork
    2) continue
    3)   Save the thread id where we stop to cont_thread_id
    4) Remove breakpoint at do_fork
    5) Reset the PC if needed depending on kernel exception type
    6) soft single step
    7)   Check where we stopped
           if current thread != cont_thread_id {
               if (here for more than 2 times for the same thead) {
                  ### must be a really busy system, start test again ###
                  goto step 1
               }
               goto step 5
           } else {
               cont_instead_of_sstep = 0;
           }
    8) clean up and run test again if needed
    9) Clear out any threads that were waiting on a break point at the
       point in time the test is ended with get_cont_catch().  This
       happens sometimes because breakpoints are used in place of single
       stepping and some threads could have been in the debugger exception
       handling queue because breakpoints were hit concurrently on
       different CPUs.  This also means we wait at least one second before
       unplumbing the debugger connection at the very end, so as respond
       to any debug threads waiting to be serviced.
    
    Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1fd9412a53d904d439a9c25ecdd0759abf525923
Author: Jason Wessel <jason.wessel@windriver.com>
Date:   Thu Mar 29 17:41:24 2012 -0500

    kgdbts: (1 of 2) fix single step awareness to work correctly with SMP
    
    commit 486c5987a00a89d56c2c04c506417ef8f823ca2e upstream.
    
    The do_fork and sys_open tests have never worked properly on anything
    other than a UP configuration with the kgdb test suite.  This is
    because the test suite did not fully implement the behavior of a real
    debugger.  A real debugger tracks the state of what thread it asked to
    single step and can correctly continue other threads of execution or
    conditionally stop while waiting for the original thread single step
    request to return.
    
    Below is a simple method to cause a fatal kernel oops with the kgdb
    test suite on a 4 processor x86 system:
    
    while [ 1 ] ; do ls > /dev/null 2> /dev/null; done&
    while [ 1 ] ; do ls > /dev/null 2> /dev/null; done&
    while [ 1 ] ; do ls > /dev/null 2> /dev/null; done&
    while [ 1 ] ; do ls > /dev/null 2> /dev/null; done&
    echo V1I1F1000 > /sys/module/kgdbts/parameters/kgdbts
    
    Very soon after starting the test the kernel will oops with a message like:
    
    kgdbts: BP mismatch 3b7da66480 expected ffffffff8106a590
    WARNING: at drivers/misc/kgdbts.c:303 check_and_rewind_pc+0xe0/0x100()
    Call Trace:
     [<ffffffff812994a0>] check_and_rewind_pc+0xe0/0x100
     [<ffffffff81298945>] validate_simple_test+0x25/0xc0
     [<ffffffff81298f77>] run_simple_test+0x107/0x2c0
     [<ffffffff81298a18>] kgdbts_put_char+0x18/0x20
    
    The warn will turn to a hard kernel crash shortly after that because
    the pc will not get properly rewound to the right value after hitting
    a breakpoint leading to a hard lockup.
    
    This change is broken up into 2 pieces because archs that have hw
    single stepping (2.6.26 and up) need different changes than archs that
    do not have hw single stepping (3.0 and up).  This change implements
    the correct behavior for an arch that supports hw single stepping.
    
    A minor defect was fixed where sys_open should be do_sys_open
    for the sys_open break point test.  This solves the problem of running
    a 64 bit with a 32 bit user space.  The sys_open() never gets called
    when using the 32 bit file system for the kgdb testsuite because the
    32 bit binaries invoke the compat_sys_open() call leading to the test
    never completing.
    
    In order to mimic a real debugger, the kgdb test suite now tracks the
    most recent thread that was continued (cont_thread_id), with the
    intent to single step just this thread.  When the response to the
    single step request stops in a different thread that hit the original
    break point that thread will now get continued, while the debugger
    waits for the thread with the single step pending.  Here is a high
    level description of the sequence of events.
    
       cont_instead_of_sstep = 0;
    
    1) set breakpoint at do_fork
    2) continue
    3)   Save the thread id where we stop to cont_thread_id
    4) Remove breakpoint at do_fork
    5) Reset the PC if needed depending on kernel exception type
    6) if (cont_instead_of_sstep) { continue } else { single step }
    7)   Check where we stopped
           if current thread != cont_thread_id {
               cont_instead_of_sstep = 1;
               goto step 5
           } else {
               cont_instead_of_sstep = 0;
           }
    8) clean up and run test again if needed
    
    Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3d396f7041788d392c4df3d5214a0ec6ce546069
Author: Jason Wessel <jason.wessel@windriver.com>
Date:   Thu Mar 29 06:55:44 2012 -0500

    kgdbts: Fix kernel oops with CONFIG_DEBUG_RODATA
    
    commit 456ca7ff24841bf2d2a2dfd690fe7d42ef70d932 upstream.
    
    On x86 the kgdb test suite will oops when the kernel is compiled with
    CONFIG_DEBUG_RODATA and you run the tests after boot time. This is
    regression has existed since 2.6.26 by commit: b33cb815 (kgdbts: Use
    HW breakpoints with CONFIG_DEBUG_RODATA).
    
    The test suite can use hw breakpoints for all the tests, but it has to
    execute the hardware breakpoint specific tests first in order to
    determine that the hw breakpoints actually work.  Specifically the
    very first test causes an oops:
    
    # echo V1I1 > /sys/module/kgdbts/parameters/kgdbts
    kgdb: Registered I/O driver kgdbts.
    kgdbts:RUN plant and detach test
    
    Entering kdb (current=0xffff880017aa9320, pid 1078) on processor 0 due to Keyboard Entry
    [0]kdb> kgdbts: ERROR PUT: end of test buffer on 'plant_and_detach_test' line 1 expected OK got $E14#aa
    WARNING: at drivers/misc/kgdbts.c:730 run_simple_test+0x151/0x2c0()
    [...oops clipped...]
    
    This commit re-orders the running of the tests and puts the RODATA
    check into its own function so as to correctly avoid the kernel oops
    by detecting and using the hw breakpoints.
    
    Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5aa0f981535b054fa447c0202317be5f9e79f676
Author: Jason Wessel <jason.wessel@windriver.com>
Date:   Wed Mar 21 10:17:03 2012 -0500

    kgdb,debug_core: pass the breakpoint struct instead of address and memory
    
    commit 98b54aa1a2241b59372468bd1e9c2d207bdba54b upstream.
    
    There is extra state information that needs to be exposed in the
    kgdb_bpt structure for tracking how a breakpoint was installed.  The
    debug_core only uses the the probe_kernel_write() to install
    breakpoints, but this is not enough for all the archs.  Some arch such
    as x86 need to use text_poke() in order to install a breakpoint into a
    read only page.
    
    Passing the kgdb_bpt structure to kgdb_arch_set_breakpoint() and
    kgdb_arch_remove_breakpoint() allows other archs to set the type
    variable which indicates how the breakpoint was installed.
    
    Signed-off-by: Jason Wessel <jason.wessel@windriver.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3c47f1832ad77075020307589e291faa7dcd7551
Author: Martin Svec <martin.svec@zoner.cz>
Date:   Mon Feb 6 22:13:25 2012 -0800

    target: Fix unsupported WRITE_SAME sense payload
    
    commit 67236c44741e250199ccd77f1115568e68cf8848 upstream.
    
    This patch fixes a bug in target-core where unsupported WRITE_SAME ops
    from a target_check_write_same_discard() failure was incorrectly
    returning CHECK_CONDITION w/ TCM_INVALID_CDB_FIELD sense data.
    This was causing some clients to not properly fall back, so go ahead
    and use the correct TCM_UNSUPPORTED_SCSI_OPCODE sense for this case.
    
    Reported-by: Martin Svec <martin.svec@zoner.cz>
    Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bf60b022fc40cbb8dd501ccc00629bec86ebc6b7
Author: françois romieu <romieu@fr.zoreil.com>
Date:   Tue Mar 6 01:14:12 2012 +0000

    r8169: runtime resume before shutdown.
    
    commit 2a15cd2ff488a9fdb55e5e34060f499853b27c77 upstream.
    
    With runtime PM, if the ethernet cable is disconnected, the device is
    transitioned to D3 state to conserve energy. If the system is shutdown
    in this state, any register accesses in rtl_shutdown are dropped on
    the floor. As the device was programmed by .runtime_suspend() to wake
    on link changes, it is thus brought back up as soon as the link recovers.
    
    Resuming every suspended device through the driver core would slow things
    down and it is not clear how many devices really need it now.
    
    Original report and D0 transition patch by Sameer Nanda. Patch has been
    changed to comply with advices by Rafael J. Wysocki and the PM folks.
    
    Reported-by: Sameer Nanda <snanda@chromium.org>
    Signed-off-by: Francois Romieu <romieu@fr.zoreil.com>
    Cc: Rafael J. Wysocki <rjw@sisk.pl>
    Cc: Hayes Wang <hayeswang@realtek.com>
    Cc: Alan Stern <stern@rowland.harvard.edu>
    Acked-by: Rafael J. Wysocki <rjw@sisk.pl>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0bf49f820c3943117f7f967582bff367b6bbc05f
Author: Daniel Vetter <daniel.vetter@ffwll.ch>
Date:   Sat Mar 24 23:51:30 2012 +0100

    drm/i915: quirk away broken OpRegion VBT
    
    commit 25e341cfc33d94435472983825163e97fe370a6c upstream.
    
    Somehow the BIOS manages to screw things up when copying the VBT
    around, because the one we scrap from the VBIOS rom actually works.
    
    Tested-by: Markus Heinz <markus.heinz@uni-dortmund.de>
    Acked-by: Chris Wilson <chris@chris-wilson.co.uk>
    Reviewed-by: Rodrigo Vivi <rodrigo.vivi@gmail.com>
    Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=28812
    Signed-Off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c3140c5a90be5cc54a68099de13e80a034b6196d
Author: Sean Paul <seanpaul@chromium.org>
Date:   Fri Mar 23 08:52:58 2012 -0400

    drm/i915: Add lock on drm_helper_resume_force_mode
    
    commit 927a2f119e8235238a2fc64871051b16c9bdae75 upstream.
    
    i915_drm_thaw was not locking the mode_config lock when calling
    drm_helper_resume_force_mode. When there were multiple wake sources,
    this caused FDI training failure on SNB which in turn corrupted the
    display.
    
    Signed-off-by: Sean Paul <seanpaul@chromium.org>
    Reviewed-by: Chris Wilson <chris@chris-wilson.co.uk>
    Signed-Off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b1db3350081817e91ab5502ca4e8915e4c32d38b
Author: Chris Wilson <chris@chris-wilson.co.uk>
Date:   Thu Mar 22 15:00:50 2012 +0000

    drm/i915: Sanitize BIOS debugging bits from PIPECONF
    
    commit f47166d2b0001fcb752b40c5a2d4db986dfbea68 upstream.
    
    Quoting the BSpec from time immemorial:
    
      PIPEACONF, bits 28:27: Frame Start Delay (Debug)
    
      Used to delay the frame start signal that is sent to the display planes.
      Care must be taken to insure that there are enough lines during VBLANK
      to support this setting.
    
    An instance of the BIOS leaving these bits set was found in the wild,
    where it caused our modesetting to go all squiffy and skewiff.
    
    Bugzilla: https://bugs.freedesktop.org/show_bug.cgi?id=47271
    Reported-and-tested-by: Eva Wang <evawang@linpus.com>
    Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=43012
    Reported-and-tested-by: Carl Richell <carl@system76.com>
    Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
    Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit abbea1a868f24cb748b7335ac41ba0145d168ff9
Author: Anisse Astier <anisse@astier.eu>
Date:   Wed Mar 7 18:36:35 2012 +0100

    drm/i915: no-lvds quirk on MSI DC500
    
    commit 97effadb65ed08809e1720c8d3ee80b73a93665c upstream.
    
    This hardware doesn't have an LVDS, it's a desktop box. Fix incorrect
    LVDS detection.
    
    Signed-off-by: Anisse Astier <anisse@astier.eu>
    Acked-by: Chris Wilson <chris@chris-wilson.co.uk>
    Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 125b1ef2e38735db5730d6ed640999abfb913c66
Author: Alex Deucher <alexander.deucher@amd.com>
Date:   Thu Mar 29 19:04:08 2012 -0400

    drm/radeon/kms: fix fans after resume
    
    commit 402976fe51b2d1a58a29ba06fa1ca5ace3a4cdcd upstream.
    
    On pre-R600 asics, the SpeedFanControl table is not
    executed as part of ASIC_Init as it is on newer asics.
    
    Fixes:
    https://bugzilla.kernel.org/show_bug.cgi?id=29412
    
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Reviewed-by: Michel Dänzer <michel.daenzer@amd.com>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b717db8282337f56f04cfd3ecfaa1c7310b2ec1c
Author: Chris Wilson <chris@chris-wilson.co.uk>
Date:   Mon Mar 26 21:15:53 2012 +0100

    drm: Validate requested virtual size against allocated fb size
    
    commit 62fb376e214d3c1bfdf6fbb77dac162f6da04d7e upstream.
    
    mplayer -vo fbdev tries to create a screen that is twice as tall as the
    allocated framebuffer for "doublebuffering". By default, and all in-tree
    users, only sufficient memory is allocated and mapped to satisfy the
    smallest framebuffer and the virtual size is no larger than the actual.
    For these users, we should therefore reject any userspace request to
    create a screen that requires a buffer larger than the framebuffer
    originally allocated.
    
    References: https://bugs.freedesktop.org/show_bug.cgi?id=38138
    Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
    Reviewed-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3c13b036280e85f2aec5b852e31a5d0236ef7031
Author: Larry Finger <Larry.Finger@lwfinger.net>
Date:   Mon Mar 26 09:59:48 2012 -0500

    rtlwifi: rtl8192ce: rtl8192cu: rtl8192de: Fix low-gain setting when scanning
    
    commit 643c61e119459e9d750087b7b34be94491efebf9 upstream.
    
    In https://bugzilla.redhat.com/show_bug.cgi?id=770207, slowdowns of driver
    rtl8192ce are reported. One fix (commit a9b89e2) has already been applied,
    and it helped, but the maximum RX speed would still drop to 1 Mbps. As in
    the previous fix, the initial gain was determined to be the problem; however,
    the problem arises from a setting of the gain when scans are started.
    
    Driver rtl8192de also has the same code structure - this one is fixed as well.
    
    Reported-and-Tested-by: Ivan Pesin <ivan.pesin@gmail.com>
    Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 53449f46a7b2624a2350f041791882d070cad719
Author: Stanislaw Gruszka <sgruszka@redhat.com>
Date:   Mon Mar 19 16:00:26 2012 +0100

    mac80211: fix possible tid_rx->reorder_timer use after free
    
    commit d72308bff5c2fa207949a5925b020bce74495e33 upstream.
    
    Is possible that we will arm the tid_rx->reorder_timer after
    del_timer_sync() in ___ieee80211_stop_rx_ba_session(). We need to stop
    timer after RCU grace period finish, so move it to
    ieee80211_free_tid_rx(). Timer will not be armed again, as
    rcu_dereference(sta->ampdu_mlme.tid_rx[tid]) will return NULL.
    
    Debug object detected problem with the following warning:
    ODEBUG: free active (active state 0) object type: timer_list hint: sta_rx_agg_reorder_timer_expired+0x0/0xf0 [mac80211]
    
    Bug report (with all warning messages):
    https://bugzilla.redhat.com/show_bug.cgi?id=804007
    
    Reported-by: "jan p. springer" <jsd@igroup.org>
    Signed-off-by: Stanislaw Gruszka <sgruszka@redhat.com>
    Signed-off-by: John W. Linville <linville@tuxdriver.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3f2d237ff6379e5dd552e9cdb7c2662c0ea89cc8
Author: Geert Uytterhoeven <geert@linux-m68k.org>
Date:   Sun Mar 18 13:21:38 2012 +0100

    m68k/mac: Add missing platform check before registering platform devices
    
    commit 6cfeba53911d6d2f17ebbd1246893557d5ff5aeb upstream.
    
    On multi-platform kernels, the Mac platform devices should be registered
    when running on Mac only. Else it may crash later.
    
    Signed-off-by: Geert Uytterhoeven <geert@linux-m68k.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7be29c2aabb07d7964600f2ffda281a349642efe
Author: Steven Rostedt <srostedt@redhat.com>
Date:   Tue Mar 27 10:43:28 2012 -0400

    tracing: Fix ent_size in trace output
    
    commit 12b5da349a8b94c9dbc3430a6bc42eabd9eaf50b upstream.
    
    When reading the trace file, the records of each of the per_cpu buffers
    are examined to find the next event to print out. At the point of looking
    at the event, the size of the event is recorded. But if the first event is
    chosen, the other events in the other CPU buffers will reset the event size
    that is stored in the iterator descriptor, causing the event size passed to
    the output functions to be incorrect.
    
    In most cases this is not a problem, but for the case of stack traces, it
    is. With the change to the stack tracing to record a dynamic number of
    back traces, the output depends on the size of the entry instead of the
    fixed 8 back traces. When the entry size is not correct, the back traces
    would not be fully printed.
    
    Note, reading from the per-cpu trace files were not affected.
    
    Reported-by: Thomas Gleixner <tglx@linutronix.de>
    Tested-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Steven Rostedt <rostedt@goodmis.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a4c3bcc7b26896c0d85a145f1ae08b12b8760e29
Author: Wolfgang Mauerer <wolfgang.mauerer@siemens.com>
Date:   Thu Mar 22 11:18:20 2012 +0100

    tracing: Fix ftrace stack trace entries
    
    commit 01de982abf8c9e10fc3089e10585cd2cc914bdab upstream.
    
    8 hex characters tell only half the tale for 64 bit CPUs,
    so use the appropriate length.
    
    Link: http://lkml.kernel.org/r/1332411501-8059-2-git-send-email-wolfgang.mauerer@siemens.com
    
    Signed-off-by: Wolfgang Mauerer <wolfgang.mauerer@siemens.com>
    Signed-off-by: Steven Rostedt <rostedt@goodmis.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 14768b0d5692cc3a6c1adcc1533519d59dfffe72
Author: Jiang Liu <liuj97@gmail.com>
Date:   Fri Mar 30 23:11:33 2012 +0800

    genirq: Adjust irq thread affinity on IRQ_SET_MASK_OK_NOCOPY return value
    
    commit f5cb92ac82d06cb583c1f66666314c5c0a4d7913 upstream.
    
    irq_move_masked_irq() checks the return code of
    chip->irq_set_affinity() only for 0, but IRQ_SET_MASK_OK_NOCOPY is
    also a valid return code, which is there to avoid a redundant copy of
    the cpumask. But in case of IRQ_SET_MASK_OK_NOCOPY we not only avoid
    the redundant copy, we also fail to adjust the thread affinity of an
    eventually threaded interrupt handler.
    
    Handle IRQ_SET_MASK_OK (==0) and IRQ_SET_MASK_OK_NOCOPY(==1) return
    values correctly by checking the valid return values seperately.
    
    Signed-off-by: Jiang Liu <jiang.liu@huawei.com>
    Cc: Jiang Liu <liuj97@gmail.com>
    Cc: Keping Chen <chenkeping@huawei.com>
    Link: http://lkml.kernel.org/r/1333120296-13563-2-git-send-email-jiang.liu@huawei.com
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a465b08978d6b1109778101eeaccc150108624c7
Author: Jan Beulich <JBeulich@suse.com>
Date:   Thu Mar 8 09:41:25 2012 +0000

    modpost: fix ALL_INIT_DATA_SECTIONS
    
    commit 9aaf440f8fabcebf9ea79a62ccf4c212e6544b49 upstream.
    
    This was lacking a comma between two supposed to be separate strings.
    
    Signed-off-by: Jan Beulich <jbeulich@suse.com>
    Signed-off-by: Michal Marek <mmarek@suse.cz>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6ed09fc142ae8d938bf225e297e0be12fdbd1381
Author: Julian Anastasov <ja@ssi.bg>
Date:   Thu Feb 23 22:40:43 2012 +0200

    ACPICA: Fix regression in FADT revision checks
    
    commit 3e80acd1af40fcd91a200b0416a7616b20c5d647 upstream.
    
            commit 64b3db22c04586997ab4be46dd5a5b99f8a2d390 (2.6.39),
    "Remove use of unreliable FADT revision field" causes regression
    for old P4 systems because now cst_control and other fields are
    not reset to 0.
    
            The effect is that acpi_processor_power_init will notice
    cst_control != 0 and a write to CST_CNT register is performed
    that should not happen. As result, the system oopses after the
    "No _CST, giving up" message, sometimes in acpi_ns_internalize_name,
    sometimes in acpi_ns_get_type, usually at random places. May be
    during migration to CPU 1 in acpi_processor_get_throttling.
    
            Every one of these settings help to avoid this problem:
     - acpi=off
     - processor.nocst=1
     - maxcpus=1
    
            The fix is to update acpi_gbl_FADT.header.length after
    the original value is used to check for old revisions.
    
    https://bugzilla.kernel.org/show_bug.cgi?id=42700
    https://bugzilla.redhat.com/show_bug.cgi?id=727865
    
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Acked-by: Bob Moore <robert.moore@intel.com>
    Signed-off-by: Len Brown <len.brown@intel.com>
    Cc: Jonathan Nieder <jrnieder@gmail.com>
    Cc: Josh Boyer <jwboyer@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5c9a4a9ae67f4f593664aabbedf006d445d2cbc3
Author: Yinghai Lu <yinghai@kernel.org>
Date:   Sat Mar 3 13:29:20 2012 -0800

    PNPACPI: Fix device ref leaking in acpi_pnp_match
    
    commit 89e96ada572fb216e582dbe3f64e1a6939a37f74 upstream.
    
    During testing pci root bus removal, found some root bus bridge is not freed.
    If booting with pnpacpi=off, those hostbridge could be freed without problem.
    It turns out that some devices reference are not released during acpi_pnp_match.
    that match should not hold one device ref during every calling.
    Add pu_device calling before returning.
    
    Signed-off-by: Yinghai Lu <yinghai@kernel.org>
    Signed-off-by: Len Brown <len.brown@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 35cb6ba080586b2b780b032650a816887e7ad96d
Author: Andi Kleen <andi@firstfloor.org>
Date:   Mon Feb 6 08:17:11 2012 -0800

    ACPI: Do cpufreq clamping for throttling per package v2
    
    commit 2815ab92ba3ab27556212cc306288dc95692824b upstream.
    
    On Intel CPUs the processor typically uses the highest frequency
    set by any logical CPU. When the system overheats
    Linux first forces the frequency to the lowest available one
    to lower the temperature.
    
    However this was done only per logical CPU, which means all
    logical CPUs in a package would need to go through this before
    the frequency is actually lowered.
    
    Worse this delay actually prevents real throttling, because
    the real throttle code only proceeds when the lowest frequency
    is already reached.
    
    So when a throttle event happens force the lowest frequency
    for all CPUs in the package where it happened. The per CPU
    state is now kept per package, not per logical CPU. An alternative
    would be to do it per cpufreq unit, but since we want to bring
    down the temperature of the complete chip it's better
    to do it for all.
    
    In principle it may even make sense to do it for all CPUs,
    but I kept it on the package for now.
    
    With this change the frequency is actually lowered, which
    in terms also allows real throttling to proceed.
    
    I also removed an unnecessary per cpu variable initialization.
    
    v2: Fix package mapping
    
    Signed-off-by: Andi Kleen <ak@linux.intel.com>
    Signed-off-by: Len Brown <len.brown@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6f60a95fc14d047632a071ed9486d1fa4bd199ec
Author: Brian Norris <computersforpeace@gmail.com>
Date:   Tue Jan 31 00:06:03 2012 -0800

    mtd: m25p80: set writebufsize
    
    commit b54f47c8bcfc5f766bf13ec31bd7dd1d4726d33b upstream.
    
    Using UBI on m25p80 can give messages like:
    
        UBI error: io_init: bad write buffer size 0 for 1 min. I/O unit
    
    We need to initialize writebufsize; I think "page_size" is the correct
    "bufsize", although I'm not sure. Comments?
    
    Signed-off-by: Brian Norris <computersforpeace@gmail.com>
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0e801cd65d23758efdbefdc5669771b1e131729a
Author: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
Date:   Fri Feb 3 09:53:28 2012 +0200

    mtd: lart: initialize writebufsize
    
    commit fcc44a07dae0af16e84e93425fc8afe642ddc603 upstream.
    
    The writebufsize concept was introduce by commit
    "0e4ca7e mtd: add writebufsize field to mtd_info struct" and it represents
    the maximum amount of data the device writes to the media at a time. This is
    an important parameter for UBIFS which is used during recovery and which
    basically defines how big a corruption caused by a power cut can be.
    
    Set writebufsize to 4 because this drivers writes at max 4 bytes at a time.
    
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3a3df72123208ed08e8475ce5f542317b41e12f5
Author: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
Date:   Fri Feb 3 09:32:44 2012 +0200

    mtd: block2mtd: initialize writebufsize
    
    commit b604387411ec6a072e95910099262616edd2bd2f upstream.
    
    The writebufsize concept was introduce by commit
    "0e4ca7e mtd: add writebufsize field to mtd_info struct" and it represents
    the maximum amount of data the device writes to the media at a time. This is
    an important parameter for UBIFS which is used during recovery and which
    basically defines how big a corruption caused by a power cut can be.
    
    However, we forgot to set this parameter for block2mtd. Set it to PAGE_SIZE
    because this is actually the amount of data we write at a time.
    
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
    Acked-by: Joern Engel <joern@lazybastard.org>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c35f209ac6ec89540e7654bed40d1cec3c7e6cc0
Author: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
Date:   Fri Feb 3 10:16:50 2012 +0200

    mtd: sst25l: initialize writebufsize
    
    commit c4cc625ea5958d065c21cc0fcea29e9ed8f3d2bc upstream.
    
    The writebufsize concept was introduce by commit
    "0e4ca7e mtd: add writebufsize field to mtd_info struct" and it represents
    the maximum amount of data the device writes to the media at a time. This is
    an important parameter for UBIFS which is used during recovery and which
    basically defines how big a corruption caused by a power cut can be.
    
    Set writebufsize to the flash page size because it is the maximum amount of
    data it writes at a time.
    
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 496a4138c1575d40c4578a74da7cdda3d8b2a095
Author: Wolfram Sang <w.sang@pengutronix.de>
Date:   Tue Jan 31 13:10:43 2012 +0100

    mtd: nand: gpmi: use correct member for checking NAND_BBT_USE_FLASH
    
    commit 5289966ea576a062b80319975b31b661c196ff9d upstream.
    
    This has been moved from .options to .bbt_options meanwhile. So, it
    currently checks for something totally different (NAND_OWN_BUFFERS) and
    decides according to that.
    
    Artem Bityutskiy: the options were moved in
    a40f734 mtd: nand: consolidate redundant flash-based BBT flags
    
    Artem Bityutskiy: CCing -stable
    
    Signed-off-by: Wolfram Sang <w.sang@pengutronix.de>
    Acked-by: Huang Shijie <b32955@freescale.com>
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7cc1b0b2fea66ee8d4ee4a1aacafb543168db914
Author: Daniel Schwierzeck <daniel.schwierzeck@googlemail.com>
Date:   Thu Feb 23 17:59:49 2012 +0100

    mtd: mips: lantiq: reintroduce support for cmdline partitions
    
    commit bf011f2ed53d587fdd8148c173c4f09ed77bdf1a upstream.
    
    Since commit ca97dec2ab5c87e9fbdf7e882e1820004a3966fa the
    command line parsing of MTD partitions does not work anymore.
    
    Signed-off-by: Daniel Schwierzeck <daniel.schwierzeck@googlemail.com>
    Signed-off-by: John Crispin <blogic@openwrt.org>
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
    Acked-by: John Crispin <blogic@openwrt.org>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 16dcb2d3d104ca9cdd9547969deab9903226948a
Author: Marc Kleine-Budde <mkl@blackshift.org>
Date:   Wed Feb 8 20:24:29 2012 +0100

    mtd: ixp4xx: oops in ixp4xx_flash_probe
    
    commit a3c1e3b732b3708a80e4035b9d845f3f7c7dd0c9 upstream.
    
    In commit "c797533 mtd: abstract last MTD partition parser argument" the
    third argument of "mtd_device_parse_register()" changed from start address
    of the MTD device to a pointer to a struct.
    
    The "ixp4xx_flash_probe()" function was not converted properly, causing
    an oops during boot.
    
    This patch fixes the problem by filling the needed information into a
    "struct mtd_part_parser_data" and passing it to
    "mtd_device_parse_register()".
    
    Signed-off-by: Marc Kleine-Budde <mkl@blackshift.org>
    Signed-off-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
    Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 97ff9284d7872dad9785ebb4b78d030b7c3cde5c
Author: Mark Brown <broonie@opensource.wolfsonmicro.com>
Date:   Wed Mar 21 13:22:40 2012 +0000

    ASoC: wm8994: Update WM8994 DCS calibration
    
    commit e16605855d58803fe0608417150c7a618b4f8243 upstream.
    
    Based on latest production information.
    
    Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 127241bd9ae2771020b24c4537ee1219f823c45f
Author: Kenth Eriksson <kenth.eriksson@transmode.com>
Date:   Tue Mar 27 22:05:54 2012 +0000

    Fix non TBI PHY access; a bad merge undid bug fix in a previous commit.
    
    [ Upstream commit 464b57da56910c8737ede75ad820b9a7afc46b3e ]
    
    The merge done in commit b26e478f undid bug fix in commit c3e072f8
    ("net: fsl_pq_mdio: fix non tbi phy access"), with the result that non
    TBI (e.g. MDIO) PHYs cannot be accessed.
    
    Signed-off-by: Kenth Eriksson <kenth.eriksson@transmode.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0ccef2bfa30d6b6e4cc9674b9dca3b26d1517e33
Author: Rabin Vincent <rabin@rab.in>
Date:   Thu Mar 29 07:15:15 2012 +0000

    net: usb: cdc_eem: fix mtu
    
    [ Upstream commit 78fb72f7936c01d5b426c03a691eca082b03f2b9 ]
    
    Make CDC EEM recalculate the hard_mtu after adjusting the
    hard_header_len.
    
    Without this, usbnet adjusts the MTU down to 1494 bytes, and the host is
    unable to receive standard 1500-byte frames from the device.
    
    Tested with the Linux USB Ethernet gadget.
    
    Cc: Oliver Neukum <oliver@neukum.name>
    Signed-off-by: Rabin Vincent <rabin@rab.in>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 61234da7f859094fb5f9c676385897d4b60319ca
Author: Daniel Borkmann <daniel@iogearbox.net>
Date:   Tue Mar 27 22:47:43 2012 +0000

    rose_dev: fix memcpy-bug in rose_set_mac_address
    
    [ Upstream commit 81213b5e8ae68e204aa7a3f83c4f9100405dbff9 ]
    
    If both addresses equal, nothing needs to be done. If the device is down,
    then we simply copy the new address to dev->dev_addr. If the device is up,
    then we add another loopback device with the new address, and if that does
    not fail, we remove the loopback device with the old address. And only
    then, we update the dev->dev_addr.
    
    Signed-off-by: Daniel Borkmann <daniel.borkmann@tik.ee.ethz.ch>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit df657e3c1b59def8eb018c95f0951c1898f4cf80
Author: Lino Sanfilippo <LinoSanfilippo@gmx.de>
Date:   Fri Mar 30 07:28:59 2012 +0000

    sky2: dont overwrite settings for PHY Quick link
    
    [ Upstream commit 2240eb4ae3dc4acff20d1a8947c441c451513e37 ]
    
    This patch corrects a bug in function sky2_open() of the Marvell Yukon 2 driver
    in which the settings for PHY quick link are overwritten.
    
    Signed-off-by: Lino Sanfilippo <LinoSanfilippo@gmx.de>
    Acked-by: Stephen Hemminger <shemminger@vyattta.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2cdc02f59b9f7b14b72e8f12055f8d26b72dd948
Author: Matt Carlson <mcarlson@broadcom.com>
Date:   Mon Apr 2 09:01:40 2012 +0000

    tg3: Fix 5717 serdes powerdown problem
    
    [ Upstream commit 085f1afc56619bda424941412fdeaff1e32c21dc ]
    
    If port 0 of a 5717 serdes device powers down, it hides the phy from
    port 1.  This patch works around the problem by keeping port 0's phy
    powered up.
    
    Signed-off-by: Matt Carlson <mcarlson@broadcom.com>
    Signed-off-by: Michael Chan <mchan@broadcom.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a85323409e6aba510bee3873ca1f858b700bb8b0
Author: zhuangfeiran@ict.ac.cn <zhuangfeiran@ict.ac.cn>
Date:   Wed Mar 28 23:27:00 2012 +0000

    x86 bpf_jit: fix a bug in emitting the 16-bit immediate operand of AND
    
    [ Upstream commit 1d24fb3684f347226747c6b11ea426b7b992694e ]
    
    When K >= 0xFFFF0000, AND needs the two least significant bytes of K as
    its operand, but EMIT2() gives it the least significant byte of K and
    0x2. EMIT() should be used here to replace EMIT2().
    
    Signed-off-by: Feiran Zhuang  <zhuangfeiran@ict.ac.cn>
    Acked-by: Eric Dumazet <eric.dumazet@gmail.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
