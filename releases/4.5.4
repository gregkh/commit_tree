commit a29ab351c8753bba3fd2dab8bb99454393c44dfb
Author: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Date:   Wed May 11 11:22:08 2016 +0200

    Linux 4.5.4

commit 0d5406b61afb06ca7c9b76c924ddc044127bb791
Author: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
Date:   Wed Mar 23 21:07:39 2016 -0700

    ACPI / processor: Request native thermal interrupt handling via _OSC
    
    commit a21211672c9a1d730a39aa65d4a5b3414700adfb upstream.
    
    There are several reports of freeze on enabling HWP (Hardware PStates)
    feature on Skylake-based systems by the Intel P-states driver. The root
    cause is identified as the HWP interrupts causing BIOS code to freeze.
    
    HWP interrupts use the thermal LVT which can be handled by Linux
    natively, but on the affected Skylake-based systems SMM will respond
    to it by default.  This is a problem for several reasons:
     - On the affected systems the SMM thermal LVT handler is broken (it
       will crash when invoked) and a BIOS update is necessary to fix it.
     - With thermal interrupt handled in SMM we lose all of the reporting
       features of the arch/x86/kernel/cpu/mcheck/therm_throt driver.
     - Some thermal drivers like x86-package-temp depend on the thermal
       threshold interrupts signaled via the thermal LVT.
     - The HWP interrupts are useful for debugging and tuning
       performance (if the kernel can handle them).
    The native handling of thermal interrupts needs to be enabled
    because of that.
    
    This requires some way to tell SMM that the OS can handle thermal
    interrupts.  That can be done by using _OSC/_PDC in processor
    scope very early during ACPI initialization.
    
    The meaning of _OSC/_PDC bit 12 in processor scope is whether or
    not the OS supports native handling of interrupts for Collaborative
    Processor Performance Control (CPPC) notifications.  Since on
    HWP-capable systems CPPC is a firmware interface to HWP, setting
    this bit effectively tells the firmware that the OS will handle
    thermal interrupts natively going forward.
    
    For details on _OSC/_PDC refer to:
    http://www.intel.com/content/www/us/en/standards/processor-vendor-specific-acpi-specification.html
    
    To implement the _OSC/_PDC handshake as described, introduce a new
    function, acpi_early_processor_osc(), that walks the ACPI
    namespace looking for ACPI processor objects and invokes _OSC for
    them with bit 12 in the capabilities buffer set and terminates the
    namespace walk on the first success.
    
    Also modify intel_thermal_interrupt() to clear HWP status bits in
    the HWP_STATUS MSR to acknowledge HWP interrupts (which prevents
    them from firing continuously).
    
    Signed-off-by: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
    [ rjw: Subject & changelog, function rename ]
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 833a955842a53a88f6d6c6bd58c39c4d551442ed
Author: Shashank Sharma <shashank.sharma@intel.com>
Date:   Thu Apr 21 16:48:32 2016 +0530

    drm/i915: Fake HDMI live status
    
    commit 60b3143c7cac7e8d2ca65c0b347466c5776395d1 upstream.
    
    This patch does the following:
    - Fakes live status of HDMI as connected (even if that's not).
      While testing certain (monitor + cable) combinations with
      various intel  platforms, it seems that live status register
      doesn't work reliably on some older devices. So limit the
      live_status check for HDMI detection, only for platforms
      from gen7 onwards.
    
    V2: restrict faking live_status to certain platforms
    V3: (Ville)
       - keep the debug message for !live_status case
       - fix indentation of comment
       - remove "warning" from the debug message
    
        (Jani)
       - Change format of fix details in the commit message
    
    Fixes: 237ed86c693d ("drm/i915: Check live status before reading edid")
    Suggested-by: Ville Syrjala <ville.syrjala@linux.intel.com>
    Signed-off-by: Shashank Sharma <shashank.sharma@intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1461237606-16491-1-git-send-email-shashank.sharma@intel.com
    Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
    (cherry picked from commit 4f4a8185011773f7520d9916c6857db946e7f9d1)
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 92e753482815696eb690e8e76dd282c43ea66f14
Author: Ville Syrjälä <ville.syrjala@linux.intel.com>
Date:   Wed Apr 20 16:43:56 2016 +0300

    drm/i915: Make RPS EI/thresholds multiple of 25 on SNB-BDW
    
    commit 4ea3959018d09edfa36a9e7b5ccdbd4ec4b99e49 upstream.
    
    Somehow my SNB GT1 (Dell XPS 8300) gets very unhappy around
    GPU hangs if the RPS EI/thresholds aren't suitably aligned.
    It seems like scheduling/timer interupts stop working somehow
    and things get stuck eg. in usleep_range().
    
    I bisected the problem down to
    commit 8a5864377b12 ("drm/i915/skl: Restructured the gen6_set_rps_thresholds function")
    I observed that before all the values were at least multiples of 25,
    but afterwards they are not. And rounding things up to the next multiple
    of 25 does seem to help, so lets' do that. I also tried roundup(..., 5)
    but that wasn't sufficient. Also I have no idea if we might need this sort of
    thing on gen9+ as well.
    
    These are the original EI/thresholds:
     LOW_POWER
      GEN6_RP_UP_EI          12500
      GEN6_RP_UP_THRESHOLD   11800
      GEN6_RP_DOWN_EI        25000
      GEN6_RP_DOWN_THRESHOLD 21250
     BETWEEN
      GEN6_RP_UP_EI          10250
      GEN6_RP_UP_THRESHOLD    9225
      GEN6_RP_DOWN_EI        25000
      GEN6_RP_DOWN_THRESHOLD 18750
     HIGH_POWER
      GEN6_RP_UP_EI           8000
      GEN6_RP_UP_THRESHOLD    6800
      GEN6_RP_DOWN_EI        25000
      GEN6_RP_DOWN_THRESHOLD 15000
    
    These are after 8a5864377b12:
     LOW_POWER
      GEN6_RP_UP_EI          12500
      GEN6_RP_UP_THRESHOLD   11875
      GEN6_RP_DOWN_EI        25000
      GEN6_RP_DOWN_THRESHOLD 21250
     BETWEEN
      GEN6_RP_UP_EI          10156
      GEN6_RP_UP_THRESHOLD    9140
      GEN6_RP_DOWN_EI        25000
      GEN6_RP_DOWN_THRESHOLD 18750
     HIGH_POWER
      GEN6_RP_UP_EI           7812
      GEN6_RP_UP_THRESHOLD    6640
      GEN6_RP_DOWN_EI        25000
      GEN6_RP_DOWN_THRESHOLD 15000
    
    And these are what we have after this patch:
     LOW_POWER
      GEN6_RP_UP_EI          12500
      GEN6_RP_UP_THRESHOLD   11875
      GEN6_RP_DOWN_EI        25000
      GEN6_RP_DOWN_THRESHOLD 21250
     BETWEEN
      GEN6_RP_UP_EI          10175
      GEN6_RP_UP_THRESHOLD    9150
      GEN6_RP_DOWN_EI        25000
      GEN6_RP_DOWN_THRESHOLD 18750
     HIGH_POWER
      GEN6_RP_UP_EI           7825
      GEN6_RP_UP_THRESHOLD    6650
      GEN6_RP_DOWN_EI        25000
      GEN6_RP_DOWN_THRESHOLD 15000
    
    Cc: Akash Goel <akash.goel@intel.com>
    Cc: Chris Wilson <chris@chris-wilson.co.uk>
    Testcase: igt/kms_pipe_crc_basic/hang-read-crc-pipe-B
    Fixes: 8a5864377b12 ("drm/i915/skl: Restructured the gen6_set_rps_thresholds function")
    Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1461159836-9108-1-git-send-email-ville.syrjala@linux.intel.com
    Acked-by: Chris Wilson <chris@chris-wilson.co.uk>
    Reviewed-by: Patrik Jakobsson <patrik.jakobsson@linux.intel.com>
    (cherry picked from commit 8a292d016d1cc4938ff14b4df25328230b08a408)
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e0a0f419514404fb68cc911babfbc0a003ec260d
Author: Mika Kahola <mika.kahola@intel.com>
Date:   Wed Apr 20 15:39:02 2016 +0300

    drm/i915: Fix eDP low vswing for Broadwell
    
    commit 992e7a41f9fcc7bcd10e7d346aee5ed7a2c241cb upstream.
    
    It was noticed on bug #94087 that module parameter
    i915.edp_vswing=2 that should override the VBT setting
    to use default voltage swing (400 mV) was not applied
    for Broadwell.
    
    This patch provides a fix for this by checking if default
    i.e. higher voltage swing is requested to be used and
    applies the DDI translations table for DP instead of eDP
    (low vswing) table.
    
    v2: Combine two if statements into one (Jani)
    v3: Change dev_priv->edp_low_vswing to use dev_priv->vbt.edp.low_vswing
    
    Bugzilla: https://bugs.freedesktop.org/show_bug.cgi?id=94087
    Signed-off-by: Mika Kahola <mika.kahola@intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1461155942-7749-1-git-send-email-mika.kahola@intel.com
    Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
    (cherry picked from commit 00983519214b61c1b9371ec2ed55a4dde773e384)
    [Jani: s/dev_priv->vbt.edp.low_vswing/dev_priv->edp_low_vswing/ to backport]
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 54e03b7a92e3427971b203629051d1e456b47f9a
Author: Imre Deak <imre.deak@intel.com>
Date:   Mon Apr 18 14:45:54 2016 +0300

    drm/i915: Fix system resume if PCI device remained enabled
    
    commit dab9a2663f4e688106c041f7cd2797a721382f0a upstream.
    
    During system resume we depended on pci_enable_device() also putting the
    device into PCI D0 state. This won't work if the PCI device was already
    enabled but still in D3 state. This is because pci_enable_device() is
    refcounted and will not change the HW state if called with a non-zero
    refcount. Leaving the device in D3 will make all subsequent device
    accesses fail.
    
    This didn't cause a problem most of the time, since we resumed with an
    enable refcount of 0. But it fails at least after module reload because
    after that we also happen to leak a PCI device enable reference: During
    probing we call drm_get_pci_dev() which will enable the PCI device, but
    during device removal drm_put_dev() won't disable it. This is a bug of
    its own in DRM core, but without much harm as it only leaves the PCI
    device enabled. Fixing it is also a bit more involved, due to DRM
    mid-layering and because it affects non-i915 drivers too. The fix in
    this patch is valid regardless of the problem in DRM core.
    
    v2:
    - Add a code comment about the relation of this fix to the freeze/thaw
      vs. the suspend/resume phases. (Ville)
    - Add a code comment about the inconsistent ordering of set power state
      and device enable calls. (Chris)
    
    CC: Ville Syrjälä <ville.syrjala@linux.intel.com>
    CC: Chris Wilson <chris@chris-wilson.co.uk>
    Signed-off-by: Imre Deak <imre.deak@intel.com>
    Reviewed-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1460979954-14503-1-git-send-email-imre.deak@intel.com
    (cherry picked from commit 44410cd0bfb26bde9288da34c190cc9267d42a20)
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1a484857ca5e61b3d5c9975ab22c868daa7a8ff0
Author: Imre Deak <imre.deak@intel.com>
Date:   Mon Apr 18 10:04:21 2016 +0300

    drm/i915/ddi: Fix eDP VDD handling during booting and suspend/resume
    
    commit 5eaa60c7109b40f17ac81090bc8b90482da76cd1 upstream.
    
    The driver's VDD on/off logic assumes that whenever the VDD is on we
    also hold an AUX power domain reference. Since BIOS can leave the VDD on
    during booting and resuming and on DDI platforms we won't take a
    corresponding power reference, the above assumption won't hold on those
    platforms and an eventual delayed VDD off work will do an extraneous AUX
    power domain put resulting in a refcount underflow. Fix this the same
    way we did this for non-DDI DP encoders:
    
    commit 6d93c0c41760c0 ("drm/i915: fix VDD state tracking after system
    resume")
    
    At the same time call the DP encoder suspend handler the same way as the
    non-DDI DP encoders do to flush any pending VDD off work. Leaving the
    work running may cause a HW access where we don't expect this (at a point
    where power domains are suspended already).
    
    While at it remove an unnecessary function call indirection.
    
    This fixed for me AUX refcount underflow problems on BXT during
    suspend/resume.
    
    CC: Ville Syrjälä <ville.syrjala@linux.intel.com>
    Signed-off-by: Imre Deak <imre.deak@intel.com>
    Reviewed-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1460963062-13211-4-git-send-email-imre.deak@intel.com
    (cherry picked from commit bf93ba67e9c05882f05b7ca2d773cfc8bf462c2a)
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b04de71b86e9a4ad75ae9222c4a9f5fad49d1d60
Author: Chris Wilson <chris@chris-wilson.co.uk>
Date:   Sun Apr 17 20:42:46 2016 +0100

    drm/i915: Avoid stalling on pending flips for legacy cursor updates
    
    commit 7ac7d19f808697abe6658c64c96868f728273f9c upstream.
    
    The legacy cursor ioctl expects to be asynchronous with respect to other
    screen updates, in particular page flips. As X updates the cursor from a
    signal context, if the cursor blocks then it will stall both the input
    and output chains causing bad stuttering and horrible UX.
    
    Reported-and-tested-by: Rafael Ristovski <rafael.ristovski@gmail.com>
    Bugzilla: https://bugs.freedesktop.org/show_bug.cgi?id=94980
    Fixes: 5008e874edd34 ("drm/i915: Make wait_for_flips interruptible.")
    Suggested-by: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
    Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
    Cc: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
    Cc: Ville Syrjälä <ville.syrjala@linux.intel.com>
    Cc: Daniel Vetter <daniel.vetter@ffwll.ch>
    Cc: Jani Nikula <jani.nikula@intel.com>
    Link: http://patchwork.freedesktop.org/patch/msgid/1460922166-20292-1-git-send-email-chris@chris-wilson.co.uk
    Acked-by: Daniel Vetter <daniel.vetter@ffwll.ch>
    Reviewed-by: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
    (cherry picked from commit acf4e84d6167317ff21be5c03e1ea76ea5783701)
    Signed-off-by: Jani Nikula <jani.nikula@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 45225b7e84ee53ffdaeb84970640e9e174bcce0b
Author: Alex Deucher <alexander.deucher@amd.com>
Date:   Mon May 2 18:53:27 2016 -0400

    drm/radeon: make sure vertical front porch is at least 1
    
    commit 3104b8128d4d646a574ed9d5b17c7d10752cd70b upstream.
    
    hw doesn't like a 0 value.
    
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 47b0084c2eedd73c85f378f8bd11c6eb65b8999f
Author: Richard Leitner <dev@g0hl1n.net>
Date:   Tue Apr 5 15:03:48 2016 +0200

    iio: ak8975: fix maybe-uninitialized warning
    
    commit 05be8d4101d960bad271d32b4f6096af1ccb1534 upstream.
    
    If i2c_device_id *id is NULL and acpi_match_device returns NULL too,
    then chipset may be unitialized when accessing &ak_def_array[chipset] in
    ak8975_probe. Therefore initialize chipset to AK_MAX_TYPE, which will
    return an error when not changed.
    
    This patch fixes the following maybe-uninitialized warning:
    
    drivers/iio/magnetometer/ak8975.c: In function ‘ak8975_probe’:
    drivers/iio/magnetometer/ak8975.c:788:14: warning: ‘chipset’ may be used
    uninitialized in this function [-Wmaybe-uninitialized]
      data->def = &ak_def_array[chipset];
    
    Signed-off-by: Richard Leitner <dev@g0hl1n.net>
    Signed-off-by: Jonathan Cameron <jic23@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3d1e08a31bde2cf5a32dcfe32996d4c753d43ff4
Author: Krzysztof Kozlowski <krzk@kernel.org>
Date:   Mon Apr 4 14:54:59 2016 +0900

    iio: ak8975: Fix NULL pointer exception on early interrupt
    
    commit 07d2390e36ee5b3265e9cc8305f2a106c8721e16 upstream.
    
    In certain probe conditions the interrupt came right after registering
    the handler causing a NULL pointer exception because of uninitialized
    waitqueue:
    
    $ udevadm trigger
    i2c-gpio i2c-gpio-1: using pins 143 (SDA) and 144 (SCL)
    i2c-gpio i2c-gpio-3: using pins 53 (SDA) and 52 (SCL)
    Unable to handle kernel NULL pointer dereference at virtual address 00000000
    pgd = e8b38000
    [00000000] *pgd=00000000
    Internal error: Oops: 5 [#1] SMP ARM
    Modules linked in: snd_soc_i2s(+) i2c_gpio(+) snd_soc_idma snd_soc_s3c_dma snd_soc_core snd_pcm_dmaengine snd_pcm snd_timer snd soundcore ac97_bus spi_s3c64xx pwm_samsung dwc2 exynos_adc phy_exynos_usb2 exynosdrm exynos_rng rng_core rtc_s3c
    CPU: 0 PID: 717 Comm: data-provider-m Not tainted 4.6.0-rc1-next-20160401-00011-g1b8d87473b9e-dirty #101
    Hardware name: SAMSUNG EXYNOS (Flattened Device Tree)
    (...)
    (__wake_up_common) from [<c0379624>] (__wake_up+0x38/0x4c)
    (__wake_up) from [<c0a41d30>] (ak8975_irq_handler+0x28/0x30)
    (ak8975_irq_handler) from [<c0386720>] (handle_irq_event_percpu+0x88/0x140)
    (handle_irq_event_percpu) from [<c038681c>] (handle_irq_event+0x44/0x68)
    (handle_irq_event) from [<c0389c40>] (handle_edge_irq+0xf0/0x19c)
    (handle_edge_irq) from [<c0385e04>] (generic_handle_irq+0x24/0x34)
    (generic_handle_irq) from [<c05ee360>] (exynos_eint_gpio_irq+0x50/0x68)
    (exynos_eint_gpio_irq) from [<c0386720>] (handle_irq_event_percpu+0x88/0x140)
    (handle_irq_event_percpu) from [<c038681c>] (handle_irq_event+0x44/0x68)
    (handle_irq_event) from [<c0389a70>] (handle_fasteoi_irq+0xb4/0x194)
    (handle_fasteoi_irq) from [<c0385e04>] (generic_handle_irq+0x24/0x34)
    (generic_handle_irq) from [<c03860b4>] (__handle_domain_irq+0x5c/0xb4)
    (__handle_domain_irq) from [<c0301774>] (gic_handle_irq+0x54/0x94)
    (gic_handle_irq) from [<c030c910>] (__irq_usr+0x50/0x80)
    
    The bug was reproduced on exynos4412-trats2 (with a max77693 device also
    using i2c-gpio) after building max77693 as a module.
    
    Fixes: 94a6d5cf7caa ("iio:ak8975 Implement data ready interrupt handling")
    Signed-off-by: Krzysztof Kozlowski <k.kozlowski@samsung.com>
    Tested-by: Gregor Boirie <gregor.boirie@parrot.com>
    Signed-off-by: Jonathan Cameron <jic23@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 258868e6b953083e459f1e98679cf581889361c2
Author: Dave Airlie <airlied@redhat.com>
Date:   Tue May 3 12:44:29 2016 +1000

    drm/amdgpu: set metadata pointer to NULL after freeing.
    
    commit 0092d3edcb23fcdb8cbe4159ba94a534290ff982 upstream.
    
    Without this there was a double free of the metadata,
    which ended up freeing the fd table for me here, and taking
    out the machine more often than not.
    
    I reproduced with X.org + modesetting DDX + latest llvm/mesa,
    also required using dri3.
    
    Reviewed-by: Christian König <christian.koenig@amd.com>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bdc6a007a3252d2d7be325fe6198b0ffd73ae6f5
Author: Alex Deucher <alexander.deucher@amd.com>
Date:   Mon May 2 18:54:39 2016 -0400

    drm/amdgpu: make sure vertical front porch is at least 1
    
    commit 0126d4b9a516256f2432ca0dc78ab293a8255378 upstream.
    
    hw doesn't like a 0 value.
    
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 5e894774db088718ca19c6f00ad38c0a806b8bf6
Author: Philipp Zabel <p.zabel@pengutronix.de>
Date:   Wed Apr 27 10:17:51 2016 +0200

    gpu: ipu-v3: Fix imx-ipuv3-crtc module autoloading
    
    commit 503fe87bd0a8346ba9d8b7f49115dcd0a4185226 upstream.
    
    If of_node is set before calling platform_device_add, the driver core
    will try to use of: modalias matching, which fails because the device
    tree nodes don't have a compatible property set. This patch fixes
    imx-ipuv3-crtc module autoloading by setting the of_node property only
    after the platform modalias is set.
    
    Fixes: 304e6be652e2 ("gpu: ipu-v3: Assign of_node of child platform devices to corresponding ports")
    Reported-by: Dennis Gilmore <dennis@ausil.us>
    Signed-off-by: Philipp Zabel <p.zabel@pengutronix.de>
    Tested-By: Dennis Gilmore <dennis@ausil.us>
    Signed-off-by: Dave Airlie <airlied@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e81de7e0c84f4080642936caf205e67e392ebb07
Author: K. Y. Srinivasan <kys@microsoft.com>
Date:   Sat Apr 2 16:17:38 2016 -0700

    Drivers: hv: vmbus: Fix signaling logic in hv_need_to_signal_on_read()
    
    commit 1db488d12894f1936360779d6ab2aede3dd7f06a upstream.
    
    On the consumer side, we have interrupt driven flow management of the
    producer. It is sufficient to base the signaling decision on the
    amount of space that is available to write after the read is complete.
    The current code samples the previous available space and uses this
    in making the signaling decision. This state can be stale and is
    unnecessary. Since the state can be stale, we end up not signaling
    the host (when we should) and this can result in a hang. Fix this
    problem by removing the unnecessary check. I would like to thank
    Arseney Romanenko <arseneyr@microsoft.com> for pointing out this issue.
    
    Also, issue a full memory barrier before making the signaling descision
    to correctly deal with potential reordering of the write (read index)
    followed by the read of pending_sz.
    
    Signed-off-by: K. Y. Srinivasan <kys@microsoft.com>
    Tested-by: Dexuan Cui <decui@microsoft.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 61a33e0e3a51e43c5b3970c6f2dadb5ef14c61ed
Author: Stanislav Meduna <stano@meduna.org>
Date:   Mon May 2 16:05:11 2016 +0100

    nvmem: mxs-ocotp: fix buffer overflow in read
    
    commit d1306eb675ad7a9a760b6b8e8e189824b8db89e7 upstream.
    
    This patch fixes the issue where the mxs_ocotp_read is reading
    the ocotp in reg_size steps but decrements the remaining size
    by 1. The number of iterations is thus four times higher,
    overwriting the area behind the output buffer.
    
    Fixes: c01e9a11ab6f ("nvmem: add driver for ocotp in i.MX23 and i.MX28")
    Tested-by: Stefan Wahren <stefan.wahren@i2se.com>
    Signed-off-by: Stanislav Meduna <stano@meduna.org>
    Signed-off-by: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dc19120c1cfd7bc8ae59776ad9f48ffdf37d7c7d
Author: Johan Hovold <johan@kernel.org>
Date:   Mon May 2 15:35:57 2016 +0200

    Revert "USB / PM: Allow USB devices to remain runtime-suspended when sleeping"
    
    commit 9be427efc764464fbcbc1ca3f0d34f575cb0f037 upstream.
    
    This reverts commit e3345db85068ddb937fc0ba40dfc39c293dad977, which
    broke system resume for a large class of devices.
    
    Devices that after having been reset during resume need to be rebound
    due to a missing reset_resume callback, are now left in a suspended
    state. This specifically broke resume of common USB-serial devices,
    which are now unusable after system suspend (until disconnected and
    reconnected) when USB persist is enabled.
    
    During resume, usb_resume_interface will set the needs_binding flag for
    such interfaces, but unlike system resume, run-time resume does not
    honour it.
    
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Acked-by: Alan Stern <stern@rowland.harvard.edu>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c0947948aed5b84aaf54a7757bf899d80d2079fe
Author: Jasem Mutlaq <mutlaqja@ikarustech.com>
Date:   Tue Apr 19 10:38:27 2016 +0300

    USB: serial: cp210x: add Straizona Focusers device ids
    
    commit 613ac23a46e10d4d4339febdd534fafadd68e059 upstream.
    
    Adding VID:PID for Straizona Focusers to cp210x driver.
    
    Signed-off-by: Jasem Mutlaq <mutlaqja@ikarustech.com>
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7b9cf0adfcf71a616c16970e440e450b7d402856
Author: Mike Manning <michael@bsch.com.au>
Date:   Mon Apr 18 12:13:23 2016 +0000

    USB: serial: cp210x: add ID for Link ECU
    
    commit 1d377f4d690637a0121eac8701f84a0aa1e69a69 upstream.
    
    The Link ECU is an aftermarket ECU computer for vehicles that provides
    full tuning abilities as well as datalogging and displaying capabilities
    via the USB to Serial adapter built into the device.
    
    Signed-off-by: Mike Manning <michael@bsch.com.au>
    Signed-off-by: Johan Hovold <johan@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit dd7ac00e80f3711a61212549135a013871b2daa2
Author: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
Date:   Fri Apr 1 08:52:57 2016 +0100

    ata: ahci-platform: Add ports-implemented DT bindings.
    
    commit 17dcc37e3e847bc0e67a5b1ec52471fcc6c18682 upstream.
    
    On some SOCs PORTS_IMPL register value is never programmed by the
    firmware and left at zero value. Which means that no sata ports are
    available for software. AHCI driver used to cope up with this by
    fabricating the port_map if the PORTS_IMPL register is read zero,
    but recent patch broke this workaround as zero value was valid for
    NVMe disks.
    
    This patch adds ports-implemented DT bindings as workaround for this issue
    in a way that DT can can override the PORTS_IMPL register in cases where
    the firmware did not program it already.
    
    Fixes: 566d1827df2e ("libata: disable forced PORTS_IMPL for >= AHCI 1.3")
    Signed-off-by: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
    Acked-by: Tejun Heo <tj@kernel.org>
    Reviewed-by: Andy Gross <andy.gross@linaro.org>
    Signed-off-by: Tejun Heo <tj@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 24514718a8d7cfde0d871cd41e6695f840d10701
Author: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
Date:   Fri Apr 1 08:52:56 2016 +0100

    libahci: save port map for forced port map
    
    commit 2fd0f46cb1b82587c7ae4a616d69057fb9bd0af7 upstream.
    
    In usecases where force_port_map is used saved_port_map is never set,
    resulting in not programming the PORTS_IMPL register as part of initial
    config. This patch fixes this by setting it to port_map even in case
    where force_port_map is used, making it more inline with other parts of
    the code.
    
    Fixes: 566d1827df2e ("libata: disable forced PORTS_IMPL for >= AHCI 1.3")
    Signed-off-by: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
    Acked-by: Tejun Heo <tj@kernel.org>
    Reviewed-by: Andy Gross <andy.gross@linaro.org>
    Signed-off-by: Tejun Heo <tj@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1b827ac8f57dbc38e10970bf163cdc6a9109deb8
Author: Anton Blanchard <anton@samba.org>
Date:   Sat Apr 30 08:29:27 2016 +1000

    powerpc: Fix bad inline asm constraint in create_zero_mask()
    
    commit b4c112114aab9aff5ed4568ca5e662bb02cdfe74 upstream.
    
    In create_zero_mask() we have:
    
            addi    %1,%2,-1
            andc    %1,%1,%2
            popcntd %0,%1
    
    using the "r" constraint for %2. r0 is a valid register in the "r" set,
    but addi X,r0,X turns it into an li:
    
            li      r7,-1
            andc    r7,r7,r0
            popcntd r4,r7
    
    Fix this by using the "b" constraint, for which r0 is not a valid
    register.
    
    This was found with a kernel build using gcc trunk, narrowed down to
    when -frename-registers was enabled at -O2. It is just luck however
    that we aren't seeing this on older toolchains.
    
    Thanks to Segher for working with me to find this issue.
    
    Fixes: d0cebfa650a0 ("powerpc: word-at-a-time optimization for 64-bit Little Endian")
    Signed-off-by: Anton Blanchard <anton@samba.org>
    Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1a2f5e091630fa32c68d268eb9435f1e330be249
Author: Prarit Bhargava <prarit@redhat.com>
Date:   Wed May 4 13:48:56 2016 +0800

    ACPICA: Dispatcher: Update thread ID for recursive method calls
    
    commit 93d68841a23a5779cef6fb9aa0ef32e7c5bd00da upstream.
    
    ACPICA commit 7a3bd2d962f221809f25ddb826c9e551b916eb25
    
    Set the mutex owner thread ID.
    Original patch from: Prarit Bhargava <prarit@redhat.com>
    
    Link: https://bugzilla.kernel.org/show_bug.cgi?id=115121
    Link: https://github.com/acpica/acpica/commit/7a3bd2d9
    Signed-off-by: Prarit Bhargava <prarit@redhat.com>
    Tested-by: Andy Lutomirski <luto@kernel.org> # On a Dell XPS 13 9350
    Signed-off-by: Bob Moore <robert.moore@intel.com>
    Signed-off-by: Lv Zheng <lv.zheng@intel.com>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 9db555f30fbcc07be06ce4682faf6ebd9ed44da6
Author: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
Date:   Fri Apr 1 08:52:58 2016 +0100

    ARM: dts: apq8064: add ahci ports-implemented mask
    
    commit bb4add2ce991e4ec891b5a0287fd1ab77b631979 upstream.
    
    This patch adds new ports-implemented mask, which is required to get
    achi working on the mainline. Without this patch value read from
    PORTS_IMPL register which is zero would not enable any ports for
    software to use.
    
    Fixes: 566d1827df2e ("libata: disable forced PORTS_IMPL for >= AHCI 1.3")
    Signed-off-by: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
    Reviewed-by: Andy Gross <andy.gross@linaro.org>
    Signed-off-by: Tejun Heo <tj@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ebb096d092fa27159b24d1de55629e847e62798e
Author: Wang YanQing <udknight@gmail.com>
Date:   Thu May 5 14:14:21 2016 +0100

    x86/sysfb_efi: Fix valid BAR address range check
    
    commit c10fcb14c7afd6688c7b197a814358fecf244222 upstream.
    
    The code for checking whether a BAR address range is valid will break
    out of the loop when a start address of 0x0 is encountered.
    
    This behaviour is wrong since by breaking out of the loop we may miss
    the BAR that describes the EFI frame buffer in a later iteration.
    
    Because of this bug I can't use video=efifb: boot parameter to get
    efifb on my new ThinkPad E550 for my old linux system hard disk with
    3.10 kernel. In 3.10, efifb is the only choice due to DRM/I915 not
    supporting the GPU.
    
    This patch also add a trivial optimization to break out after we find
    the frame buffer address range without testing later BARs.
    
    Signed-off-by: Wang YanQing <udknight@gmail.com>
    [ Rewrote changelog. ]
    Signed-off-by: Matt Fleming <matt@codeblueprint.co.uk>
    Reviewed-by: Peter Jones <pjones@redhat.com>
    Cc: Ard Biesheuvel <ard.biesheuvel@linaro.org>
    Cc: David Herrmann <dh.herrmann@gmail.com>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: Tomi Valkeinen <tomi.valkeinen@ti.com>
    Cc: linux-efi@vger.kernel.org
    Link: http://lkml.kernel.org/r/1462454061-21561-2-git-send-email-matt@codeblueprint.co.uk
    Signed-off-by: Ingo Molnar <mingo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fa04b83c64c8ef6aab759b6a33fc9b35659c0a0b
Author: Vineet Gupta <vgupta@synopsys.com>
Date:   Thu May 5 13:32:34 2016 +0530

    ARC: Add missing io barriers to io{read,write}{16,32}be()
    
    commit e5bc0478ab6cf565619224536d75ecb2aedca43b upstream.
    
    While reviewing a different change to asm-generic/io.h Arnd spotted that
    ARC ioread32 and ioread32be both of which come from asm-generic versions
    are not symmetrical in terms of calling the io barriers.
    
    generic ioread32   -> ARC readl()                  [ has barriers]
    generic ioread32be -> __be32_to_cpu(__raw_readl()) [ lacks barriers]
    
    While generic ioread32be is being remediated to call readl(), that involves
    a swab32(), causing double swaps on ioread32be() on Big Endian systems.
    
    So provide our versions of big endian IO accessors to ensure io barrier
    calls while also keeping them optimal
    
    Suggested-by: Arnd Bergmann <arnd@arndb.de>
    Acked-by: Arnd Bergmann <arnd@arndb.de>
    Signed-off-by: Vineet Gupta <vgupta@synopsys.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 97e5ea472b70811cdf3a9c7403da06b55a2ecc5f
Author: Sudeep Holla <Sudeep.Holla@arm.com>
Date:   Wed Apr 27 17:18:59 2016 +0100

    cpufreq: st: enable selective initialization based on the platform
    
    commit 2482bc31ca8096241b8fa97610ef23154ce55f45 upstream.
    
    The sti-cpufreq does unconditional registration of the cpufreq-dt driver
    which causes issue on an multi-platform build. For example, on Vexpress
    TC2 platform, we get the following error on boot:
    
    cpu cpu0: OPP-v2 not supported
    cpu cpu0: Not doing voltage scaling
    cpu: dev_pm_opp_of_cpumask_add_table: couldn't find opp table
            for cpu:0, -19
    cpu cpu0: dev_pm_opp_get_max_volt_latency: Invalid regulator (-6)
    ...
    arm_big_little: bL_cpufreq_register: Failed registering platform driver:
                    vexpress-spc, err: -17
    
    The actual driver fails to initialise as cpufreq-dt is probed
    successfully, which is incorrect. This issue can happen to any platform
    not using cpufreq-dt in a multi-platform build.
    
    This patch adds a check to do selective initialization of the driver.
    
    Fixes: ab0ea257fc58 (cpufreq: st: Provide runtime initialised driver for ST's platforms)
    Signed-off-by: Sudeep Holla <sudeep.holla@arm.com>
    Acked-by: Viresh Kumar <viresh.kumar@linaro.org>
    Acked-by: Lee Jones <lee.jones@linaro.org>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 60d4c63013b2e24a262742185b562082d1c91cfe
Author: Dmitry V. Levin <ldv@altlinux.org>
Date:   Wed Apr 27 04:56:11 2016 +0300

    parisc: fix a bug when syscall number of tracee is __NR_Linux_syscalls
    
    commit f0b22d1bb2a37a665a969e95785c75a4f49d1499 upstream.
    
    Do not load one entry beyond the end of the syscall table when the
    syscall number of a traced process equals to __NR_Linux_syscalls.
    Similar bug with regular processes was fixed by commit 3bb457af4fa8
    ("[PARISC] Fix bug when syscall nr is __NR_Linux_syscalls").
    
    This bug was found by strace test suite.
    
    Signed-off-by: Dmitry V. Levin <ldv@altlinux.org>
    Acked-by: Helge Deller <deller@gmx.de>
    Signed-off-by: Helge Deller <deller@gmx.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 20c2b0d977d5f4255d84d82908e29e531e993652
Author: James Morse <james.morse@arm.com>
Date:   Tue Apr 26 12:15:01 2016 +0100

    ARM: cpuidle: Pass on arm_cpuidle_suspend()'s return value
    
    commit 625fe4f8ffc1b915248558481bb94249f6bd411c upstream.
    
    arm_cpuidle_suspend() may return -EOPNOTSUPP, or any value returned
    by the cpu_ops/cpuidle_ops suspend call. arm_enter_idle_state() doesn't
    update 'ret' with this value, meaning we always signal success to
    cpuidle_enter_state(), causing it to update the usage counters as if we
    succeeded.
    
    Fixes: 191de17aa3c1 ("ARM64: cpuidle: Replace cpu_suspend by the common ARM/ARM64 function")
    Signed-off-by: James Morse <james.morse@arm.com>
    Acked-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
    Acked-by: Daniel Lezcano <daniel.lezcano@linaro.org>
    Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1ef1d7bf79e81997d0bed1aef0b440c17ae30bf6
Author: Chen Yu <yu.c.chen@intel.com>
Date:   Fri May 6 11:33:39 2016 +0800

    x86/tsc: Read all ratio bits from MSR_PLATFORM_INFO
    
    commit 886123fb3a8656699dff40afa0573df359abeb18 upstream.
    
    Currently we read the tsc radio: ratio = (MSR_PLATFORM_INFO >> 8) & 0x1f;
    
    Thus we get bit 8-12 of MSR_PLATFORM_INFO, however according to the SDM
    (35.5), the ratio bits are bit 8-15.
    
    Ignoring the upper bits can result in an incorrect tsc ratio, which causes the
    TSC calibration and the Local APIC timer frequency to be incorrect.
    
    Fix this problem by masking 0xff instead.
    
    [ tglx: Massaged changelog ]
    
    Fixes: 7da7c1561366 "x86, tsc: Add static (MSR) TSC calibration on Intel Atom SoCs"
    Signed-off-by: Chen Yu <yu.c.chen@intel.com>
    Cc: "Rafael J. Wysocki" <rafael@kernel.org>
    Cc: Bin Gao <bin.gao@intel.com>
    Cc: Len Brown <lenb@kernel.org>
    Link: http://lkml.kernel.org/r/1462505619-5516-1-git-send-email-yu.c.chen@intel.com
    Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit df0e585778892f181aefdc3324e6407872d83a28
Author: Matt Fleming <matt@codeblueprint.co.uk>
Date:   Tue May 3 20:29:39 2016 +0100

    MAINTAINERS: Remove asterisk from EFI directory names
    
    commit e8dfe6d8f6762d515fcd4f30577f7bfcf7659887 upstream.
    
    Mark reported that having asterisks on the end of directory names
    confuses get_maintainer.pl when it encounters subdirectories, and that
    my name does not appear when run on drivers/firmware/efi/libstub.
    
    Reported-by: Mark Rutland <mark.rutland@arm.com>
    Signed-off-by: Matt Fleming <matt@codeblueprint.co.uk>
    Cc: Ard Biesheuvel <ard.biesheuvel@linaro.org>
    Cc: Catalin Marinas <catalin.marinas@arm.com>
    Cc: Linus Torvalds <torvalds@linux-foundation.org>
    Cc: Peter Zijlstra <peterz@infradead.org>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Cc: linux-efi@vger.kernel.org
    Link: http://lkml.kernel.org/r/1462303781-8686-2-git-send-email-matt@codeblueprint.co.uk
    Signed-off-by: Ingo Molnar <mingo@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6eaf7a4da0e6e7987c355e10f3b620e08ffb8740
Author: Howard Cochran <hcochran@kernelspring.com>
Date:   Thu Mar 10 01:12:39 2016 -0500

    writeback: Fix performance regression in wb_over_bg_thresh()
    
    commit 74d369443325063a5f0260e63971decb950fd8fa upstream.
    
    Commit 947e9762a8dd ("writeback: update wb_over_bg_thresh() to use
    wb_domain aware operations") unintentionally changed this function's
    meaning from "are there more dirty pages than the background writeback
    threshold" to "are there more dirty pages than the writeback threshold".
    The background writeback threshold is typically half of the writeback
    threshold, so this had the effect of raising the number of dirty pages
    required to cause a writeback worker to perform background writeout.
    
    This can cause a very severe performance regression when a BDI uses
    BDI_CAP_STRICTLIMIT because balance_dirty_pages() and the writeback worker
    can now disagree on whether writeback should be initiated.
    
    For example, in a system having 1GB of RAM, a single spinning disk, and a
    "pass-through" FUSE filesystem mounted over the disk, application code
    mmapped a 128MB file on the disk and was randomly dirtying pages in that
    mapping.
    
    Because FUSE uses strictlimit and has a default max_ratio of only 1%, in
    balance_dirty_pages, thresh is ~200, bg_thresh is ~100, and the
    dirty_freerun_ceiling is the average of those, ~150. So, it pauses the
    dirtying processes when we have 151 dirty pages and wakes up a background
    writeback worker. But the worker tests the wrong threshold (200 instead of
    100), so it does not initiate writeback and just returns.
    
    Thus, balance_dirty_pages keeps looping, sleeping and then waking up the
    worker who will do nothing. It remains stuck in this state until the few
    dirty pages that we have finally expire and we write them back for that
    reason. Then the whole process repeats, resulting in near-zero throughput
    through the FUSE BDI.
    
    The fix is to call the parameterized variant of wb_calc_thresh, so that the
    worker will do writeback if the bg_thresh is exceeded which was the
    behavior before the referenced commit.
    
    Fixes: 947e9762a8dd ("writeback: update wb_over_bg_thresh() to use wb_domain aware operations")
    Signed-off-by: Howard Cochran <hcochran@kernelspring.com>
    Acked-by: Tejun Heo <tj@kernel.org>
    Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
    Tested-by Sedat Dilek <sedat.dilek@gmail.com>
    Signed-off-by: Jens Axboe <axboe@fb.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d43a71c7203434cc202e9b5279cbd915a56bddd4
Author: Dan Williams <dan.j.williams@intel.com>
Date:   Sat Apr 30 13:07:06 2016 -0700

    libnvdimm, pfn: fix memmap reservation sizing
    
    commit 658922e57b847bb7112aa67f6441b6bbc6554412 upstream.
    
    When configuring a pfn-device instance to allocate the memmap array it
    needs to account for the fact that vmemmap_populate_hugepages()
    allocates struct page blocks in HPAGE_SIZE chunks.  We need to align the
    reserved area size to 2MB otherwise arch_add_memory() runs out of memory
    while establishing the memmap:
    
     WARNING: CPU: 0 PID: 496 at arch/x86/mm/init_64.c:704 arch_add_memory+0xe7/0xf0
     [..]
     Call Trace:
      [<ffffffff8148bdb3>] dump_stack+0x85/0xc2
      [<ffffffff810a749b>] __warn+0xcb/0xf0
      [<ffffffff810a75cd>] warn_slowpath_null+0x1d/0x20
      [<ffffffff8106a497>] arch_add_memory+0xe7/0xf0
      [<ffffffff811d2097>] devm_memremap_pages+0x287/0x450
      [<ffffffff811d1ffa>] ? devm_memremap_pages+0x1ea/0x450
      [<ffffffffa0000298>] __wrap_devm_memremap_pages+0x58/0x70 [nfit_test_iomap]
      [<ffffffffa0047a58>] pmem_attach_disk+0x318/0x420 [nd_pmem]
      [<ffffffffa0047bcf>] nd_pmem_probe+0x6f/0x90 [nd_pmem]
      [<ffffffffa0009469>] nvdimm_bus_probe+0x69/0x110 [libnvdimm]
     [..]
      ndbus0: nd_pmem.probe(pfn3.0) = -12
     nd_pmem: probe of pfn3.0 failed with error -12
    libndctl: ndctl_pfn_enable: pfn3.0: failed to enable
    
    Reported-by: Namratha Kothapalli <namratha.n.kothapalli@intel.com>
    Signed-off-by: Dan Williams <dan.j.williams@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1b4297673495d4970aef8b59c66efb709c78bf10
Author: Sven Eckelmann <sven@narfation.org>
Date:   Sun Mar 20 12:27:53 2016 +0100

    batman-adv: Reduce refcnt of removed router when updating route
    
    commit d1a65f1741bfd9c69f9e4e2ad447a89b6810427d upstream.
    
    _batadv_update_route rcu_derefences orig_ifinfo->router outside of a
    spinlock protected region to print some information messages to the debug
    log. But this pointer is not checked again when the new pointer is assigned
    in the spinlock protected region. Thus is can happen that the value of
    orig_ifinfo->router changed in the meantime and thus the reference counter
    of the wrong router gets reduced after the spinlock protected region.
    
    Just rcu_dereferencing the value of orig_ifinfo->router inside the spinlock
    protected region (which also set the new pointer) is enough to get the
    correct old router object.
    
    Fixes: e1a5382f978b ("batman-adv: Make orig_node->router an rcu protected pointer")
    Signed-off-by: Sven Eckelmann <sven@narfation.org>
    Signed-off-by: Marek Lindner <mareklindner@neomailbox.ch>
    Signed-off-by: Antonio Quartulli <a@unstable.cc>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit faf1954f51fcf82eae28226dc9801afd8646a99b
Author: Linus Lüssing <linus.luessing@c0d3.blue>
Date:   Fri Mar 11 14:04:49 2016 +0100

    batman-adv: Fix broadcast/ogm queue limit on a removed interface
    
    commit c4fdb6cff2aa0ae740c5f19b6f745cbbe786d42f upstream.
    
    When removing a single interface while a broadcast or ogm packet is
    still pending then we will free the forward packet without releasing the
    queue slots again.
    
    This patch is supposed to fix this issue.
    
    Fixes: 6d5808d4ae1b ("batman-adv: Add missing hardif_free_ref in forw_packet_free")
    Signed-off-by: Linus Lüssing <linus.luessing@c0d3.blue>
    [sven@narfation.org: fix conflicts with current version]
    Signed-off-by: Sven Eckelmann <sven@narfation.org>
    Signed-off-by: Marek Lindner <mareklindner@neomailbox.ch>
    Signed-off-by: Antonio Quartulli <a@unstable.cc>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit accd3bbf7bafa5741f2317c4ea97896ec571d165
Author: Sven Eckelmann <sven@narfation.org>
Date:   Fri Feb 26 17:56:13 2016 +0100

    batman-adv: Check skb size before using encapsulated ETH+VLAN header
    
    commit c78296665c3d81f040117432ab9e1cb125521b0c upstream.
    
    The encapsulated ethernet and VLAN header may be outside the received
    ethernet frame. Thus the skb buffer size has to be checked before it can be
    parsed to find out if it encapsulates another batman-adv packet.
    
    Fixes: 420193573f11 ("batman-adv: softif bridge loop avoidance")
    Signed-off-by: Sven Eckelmann <sven@narfation.org>
    Signed-off-by: Marek Lindner <mareklindner@neomailbox.ch>
    Signed-off-by: Antonio Quartulli <a@unstable.cc>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 932793e450c0b57c93fa5ac048e3936c478291b8
Author: Antonio Quartulli <a@unstable.cc>
Date:   Sat Mar 12 11:12:59 2016 +0100

    batman-adv: fix DAT candidate selection (must use vid)
    
    commit 2871734e85e920503d49b3a8bc0afbe0773b6036 upstream.
    
    Now that DAT is VLAN aware, it must use the VID when
    computing the DHT address of the candidate nodes where
    an entry is going to be stored/retrieved.
    
    Fixes: be1db4f6615b ("batman-adv: make the Distributed ARP Table vlan aware")
    Signed-off-by: Antonio Quartulli <a@unstable.cc>
    [sven@narfation.org: fix conflicts with current version]
    Signed-off-by: Sven Eckelmann <sven@narfation.org>
    Signed-off-by: Marek Lindner <mareklindner@neomailbox.ch>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 61ecd7fd2fafedc786ba500680a674324715673f
Author: Jason Baron <jbaron@akamai.com>
Date:   Thu May 5 16:22:12 2016 -0700

    mm: update min_free_kbytes from khugepaged after core initialization
    
    commit bc22af74f271ef76b2e6f72f3941f91f0da3f5f8 upstream.
    
    Khugepaged attempts to raise min_free_kbytes if its set too low.
    However, on boot khugepaged sets min_free_kbytes first from
    subsys_initcall(), and then the mm 'core' over-rides min_free_kbytes
    after from init_per_zone_wmark_min(), via a module_init() call.
    
    Khugepaged used to use a late_initcall() to set min_free_kbytes (such
    that it occurred after the core initialization), however this was
    removed when the initialization of min_free_kbytes was integrated into
    the starting of the khugepaged thread.
    
    The fix here is simply to invoke the core initialization using a
    core_initcall() instead of module_init(), such that the previous
    initialization ordering is restored.  I didn't restore the
    late_initcall() since start_stop_khugepaged() already sets
    min_free_kbytes via set_recommended_min_free_kbytes().
    
    This was noticed when we had a number of page allocation failures when
    moving a workload to a kernel with this new initialization ordering.  On
    an 8GB system this restores min_free_kbytes back to 67584 from 11365
    when CONFIG_TRANSPARENT_HUGEPAGE=y is set and either
    CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS=y or
    CONFIG_TRANSPARENT_HUGEPAGE_MADVISE=y.
    
    Fixes: 79553da293d3 ("thp: cleanup khugepaged startup")
    Signed-off-by: Jason Baron <jbaron@akamai.com>
    Acked-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
    Acked-by: David Rientjes <rientjes@google.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3e047c7357c2022dffdddd0b6484ed53571f13ba
Author: Mathias Krause <minipli@googlemail.com>
Date:   Thu May 5 16:22:26 2016 -0700

    proc: prevent accessing /proc/<PID>/environ until it's ready
    
    commit 8148a73c9901a8794a50f950083c00ccf97d43b3 upstream.
    
    If /proc/<PID>/environ gets read before the envp[] array is fully set up
    in create_{aout,elf,elf_fdpic,flat}_tables(), we might end up trying to
    read more bytes than are actually written, as env_start will already be
    set but env_end will still be zero, making the range calculation
    underflow, allowing to read beyond the end of what has been written.
    
    Fix this as it is done for /proc/<PID>/cmdline by testing env_end for
    zero.  It is, apparently, intentionally set last in create_*_tables().
    
    This bug was found by the PaX size_overflow plugin that detected the
    arithmetic underflow of 'this_len = env_end - (env_start + src)' when
    env_end is still zero.
    
    The expected consequence is that userland trying to access
    /proc/<PID>/environ of a not yet fully set up process may get
    inconsistent data as we're in the middle of copying in the environment
    variables.
    
    Fixes: https://forums.grsecurity.net/viewtopic.php?f=3&t=4363
    Fixes: https://bugzilla.kernel.org/show_bug.cgi?id=116461
    Signed-off-by: Mathias Krause <minipli@googlemail.com>
    Cc: Emese Revfy <re.emese@gmail.com>
    Cc: Pax Team <pageexec@freemail.hu>
    Cc: Al Viro <viro@zeniv.linux.org.uk>
    Cc: Mateusz Guzik <mguzik@redhat.com>
    Cc: Alexey Dobriyan <adobriyan@gmail.com>
    Cc: Cyrill Gorcunov <gorcunov@openvz.org>
    Cc: Jarod Wilson <jarod@redhat.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 182029d97919c3712676c46c18b4190d28fc802a
Author: Knut Wohlrab <Knut.Wohlrab@de.bosch.com>
Date:   Mon Apr 25 14:08:25 2016 -0700

    Input: zforce_ts - fix dual touch recognition
    
    commit 6984ab1ab35f422292b7781c65284038bcc0f6a6 upstream.
    
    A wrong decoding of the touch coordinate message causes a wrong touch
    ID. Touch ID for dual touch must be 0 or 1.
    
    According to the actual Neonode nine byte touch coordinate coding,
    the state is transported in the lower nibble and the touch ID in
    the higher nibble of payload byte five.
    
    Signed-off-by: Knut Wohlrab <Knut.Wohlrab@de.bosch.com>
    Signed-off-by: Oleksij Rempel <linux@rempel-privat.de>
    Signed-off-by: Dirk Behme <dirk.behme@de.bosch.com>
    Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit eadd64d6214ae166105fda54509a9240f39cdb2a
Author: Nazar Mokrynskyi <nazar@mokrynskyi.com>
Date:   Mon Apr 25 17:01:56 2016 +0300

    HID: Fix boot delay for Creative SB Omni Surround 5.1 with quirk
    
    commit 567a44ecb44eb2584ddb93e962cfb133ce77e0bb upstream.
    
    Needed for v2 of the device firmware, otherwise kernel will stuck for few
    seconds and throw "usb_submit_urb(ctrl) failed: -1" early on system boot.
    
    Signed-off-by: Nazar Mokrynskyi <nazar@mokrynskyi.com>
    Reviewed-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 20a0d92976779082cd8fe90ba712a736d746ea3b
Author: Ping Cheng <pinglinux@gmail.com>
Date:   Tue Apr 12 13:37:45 2016 -0700

    HID: wacom: Add support for DTK-1651
    
    commit e1123fe975852cc0970b4e53ea65ca917e54c923 upstream.
    
    DTK-1651 is a display pen-only tablet
    
    Signed-off-by: Ping Cheng <pingc@wacom.com>
    Signed-off-by: Jiri Kosina <jkosina@suse.cz>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c29239fa84d99a5695595ff9600ac0b25d4e3368
Author: Jan Beulich <JBeulich@suse.com>
Date:   Wed May 4 07:02:36 2016 -0600

    xen/evtchn: fix ring resize when binding new events
    
    commit 27e0e6385377c4dc68a4ddaf1a35a2dfa951f3c5 upstream.
    
    The copying of ring data was wrong for two cases: For a full ring
    nothing got copied at all (as in that case the canonicalized producer
    and consumer indexes are identical). And in case one or both of the
    canonicalized (after the resize) indexes would point into the second
    half of the buffer, the copied data ended up in the wrong (free) part
    of the new buffer. In both cases uninitialized data would get passed
    back to the caller.
    
    Fix this by simply copying the old ring contents twice: Once to the
    low half of the new buffer, and a second time to the high half.
    
    This addresses the inability to boot a HVM guest with 64 or more
    vCPUs.  This regression was caused by 8620015499101090 (xen/evtchn:
    dynamically grow pending event channel ring).
    
    Reported-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
    Signed-off-by: Jan Beulich <jbeulich@suse.com>
    Signed-off-by: David Vrabel <david.vrabel@citrix.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 464ae61119b0430bf8c97432780f5081f442dead
Author: Ross Lagerwall <ross.lagerwall@citrix.com>
Date:   Thu Mar 17 16:52:00 2016 +0000

    xen/balloon: Fix crash when ballooning on x86 32 bit PAE
    
    commit dfd74a1edfaba5864276a2859190a8d242d18952 upstream.
    
    Commit 55b3da98a40dbb3776f7454daf0d95dde25c33d2 (xen/balloon: find
    non-conflicting regions to place hotplugged memory) caused a
    regression in 4.4.
    
    When ballooning on an x86 32 bit PAE system with close to 64 GiB of
    memory, the address returned by allocate_resource may be above 64 GiB.
    When using CONFIG_SPARSEMEM, this setup is limited to using physical
    addresses < 64 GiB.  When adding memory at this address, it runs off
    the end of the mem_section array and causes a crash.  Instead, fail
    the ballooning request.
    
    Signed-off-by: Ross Lagerwall <ross.lagerwall@citrix.com>
    Signed-off-by: David Vrabel <david.vrabel@citrix.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2a2432a51fa831a7754a13f3f64ac60583968252
Author: Ross Lagerwall <ross.lagerwall@citrix.com>
Date:   Thu Mar 17 16:51:59 2016 +0000

    xen: Fix page <-> pfn conversion on 32 bit systems
    
    commit 60901df3aed230d4565dca003f11b6a95fbf30d9 upstream.
    
    Commit 1084b1988d22dc165c9dbbc2b0e057f9248ac4db (xen: Add Xen specific
    page definition) caused a regression in 4.4.
    
    The xen functions to convert between pages and pfns fail due to an
    overflow on systems where a physical address may not fit in an
    unsigned long (e.g. x86 32 bit PAE systems). Rework the conversion to
    avoid overflow. This should also result in simpler object code.
    
    This bug manifested itself as disk corruption with Linux 4.4 when
    using blkfront in a Xen HVM x86 32 bit guest with more than 4 GiB of
    memory.
    
    Signed-off-by: Ross Lagerwall <ross.lagerwall@citrix.com>
    Signed-off-by: David Vrabel <david.vrabel@citrix.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit bcb6a4ed25d6d3d43aaab2b1d2c59228ab725559
Author: Sascha Hauer <s.hauer@pengutronix.de>
Date:   Wed Apr 20 13:34:31 2016 +0000

    ARM: SoCFPGA: Fix secondary CPU startup in thumb2 kernel
    
    commit 5616f36713ea77f57ae908bf2fef641364403c9f upstream.
    
    The secondary CPU starts up in ARM mode. When the kernel is compiled in
    thumb2 mode we have to explicitly compile the secondary startup
    trampoline in ARM mode, otherwise the CPU will go to Nirvana.
    
    Signed-off-by: Sascha Hauer <s.hauer@pengutronix.de>
    Reported-by: Steffen Trumtrar <s.trumtrar@pengutronix.de>
    Suggested-by: Ard Biesheuvel <ard.biesheuvel@linaro.org>
    Signed-off-by: Dinh Nguyen <dinguyen@opensource.altera.com>
    Signed-off-by: Kevin Hilman <khilman@baylibre.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 008e868fe30d39e8cb7d328edd0b813ef5160367
Author: Krzysztof Kozlowski <krzk@kernel.org>
Date:   Fri Apr 22 09:26:52 2016 +0200

    ARM: EXYNOS: Properly skip unitialized parent clock in power domain on
    
    commit a0a966b83873f33778710a4fc59240244b0734a5 upstream.
    
    We want to skip reparenting a clock on turning on power domain, if we
    do not have the parent yet. The parent is obtained when turning the
    domain off. However due to a typo, the loop is continued on IS_ERR() of
    clock being reparented, not on the IS_ERR() of the parent.
    
    Theoretically this could lead to OOPS on first turn on of a power
    domain, if there was no turn off before. Practically that should never
    happen because all power domains are turned on by default (reset value,
    bootloader does not turn off them usually) so the first action will be
    always turn off.
    
    Fixes: 29e5eea06bc1 ("ARM: EXYNOS: Get current parent clock for power domain on/off")
    Reported-by: Vladimir Zapolskiy <vz@mleia.com>
    Signed-off-by: Krzysztof Kozlowski <k.kozlowski@samsung.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cdfa8796c9971707685ac5e868db99a29e52f29a
Author: Philipp Zabel <p.zabel@pengutronix.de>
Date:   Thu May 5 16:22:29 2016 -0700

    modpost: fix module autoloading for OF devices with generic compatible property
    
    commit acbef7b7662953cec96c243db4009ac561d88989 upstream.
    
    Since the wildcard at the end of OF module aliases is gone, autoloading
    of modules that don't match a device's last (most generic) compatible
    value fails.
    
    For example the CODA960 VPU on i.MX6Q has the SoC specific compatible
    "fsl,imx6q-vpu" and the generic compatible "cnm,coda960".  Since the
    driver currently only works with knowledge about the SoC specific
    integration, it doesn't list "cnm,cod960" in the module device table.
    
    This results in the device compatible
    "of:NvpuT<NULL>Cfsl,imx6q-vpuCcnm,coda960" not matching the module alias
    "of:N*T*Cfsl,imx6q-vpu" anymore, whereas before commit 2f632369ab79
    ("modpost: don't add a trailing wildcard for OF module aliases") it
    matched the module alias "of:N*T*Cfsl,imx6q-vpu*".
    
    This patch adds two module aliases for each compatible, one without the
    wildcard and one with "C*" appended.
    
      $ modinfo coda | grep imx6q
      alias:          of:N*T*Cfsl,imx6q-vpuC*
      alias:          of:N*T*Cfsl,imx6q-vpu
    
    Fixes: 2f632369ab79 ("modpost: don't add a trailing wildcard for OF module aliases")
    Link: http://lkml.kernel.org/r/1462203339-15340-1-git-send-email-p.zabel@pengutronix.de
    Signed-off-by: Philipp Zabel <p.zabel@pengutronix.de>
    Cc: Javier Martinez Canillas <javier@osg.samsung.com>
    Cc: Brian Norris <computersforpeace@gmail.com>
    Cc: Sjoerd Simons <sjoerd.simons@collabora.co.uk>
    Cc: Rusty Russell <rusty@rustcorp.com.au>
    Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b439d566d2219d9e1f05ae4cdb4fd19f132899c8
Author: Eric W. Biederman <ebiederm@xmission.com>
Date:   Thu May 5 09:29:29 2016 -0500

    propogate_mnt: Handle the first propogated copy being a slave
    
    commit 5ec0811d30378ae104f250bfc9b3640242d81e3f upstream.
    
    When the first propgated copy was a slave the following oops would result:
    > BUG: unable to handle kernel NULL pointer dereference at 0000000000000010
    > IP: [<ffffffff811fba4e>] propagate_one+0xbe/0x1c0
    > PGD bacd4067 PUD bac66067 PMD 0
    > Oops: 0000 [#1] SMP
    > Modules linked in:
    > CPU: 1 PID: 824 Comm: mount Not tainted 4.6.0-rc5userns+ #1523
    > Hardware name: Bochs Bochs, BIOS Bochs 01/01/2007
    > task: ffff8800bb0a8000 ti: ffff8800bac3c000 task.ti: ffff8800bac3c000
    > RIP: 0010:[<ffffffff811fba4e>]  [<ffffffff811fba4e>] propagate_one+0xbe/0x1c0
    > RSP: 0018:ffff8800bac3fd38  EFLAGS: 00010283
    > RAX: 0000000000000000 RBX: ffff8800bb77ec00 RCX: 0000000000000010
    > RDX: 0000000000000000 RSI: ffff8800bb58c000 RDI: ffff8800bb58c480
    > RBP: ffff8800bac3fd48 R08: 0000000000000001 R09: 0000000000000000
    > R10: 0000000000001ca1 R11: 0000000000001c9d R12: 0000000000000000
    > R13: ffff8800ba713800 R14: ffff8800bac3fda0 R15: ffff8800bb77ec00
    > FS:  00007f3c0cd9b7e0(0000) GS:ffff8800bfb00000(0000) knlGS:0000000000000000
    > CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    > CR2: 0000000000000010 CR3: 00000000bb79d000 CR4: 00000000000006e0
    > Stack:
    >  ffff8800bb77ec00 0000000000000000 ffff8800bac3fd88 ffffffff811fbf85
    >  ffff8800bac3fd98 ffff8800bb77f080 ffff8800ba713800 ffff8800bb262b40
    >  0000000000000000 0000000000000000 ffff8800bac3fdd8 ffffffff811f1da0
    > Call Trace:
    >  [<ffffffff811fbf85>] propagate_mnt+0x105/0x140
    >  [<ffffffff811f1da0>] attach_recursive_mnt+0x120/0x1e0
    >  [<ffffffff811f1ec3>] graft_tree+0x63/0x70
    >  [<ffffffff811f1f6b>] do_add_mount+0x9b/0x100
    >  [<ffffffff811f2c1a>] do_mount+0x2aa/0xdf0
    >  [<ffffffff8117efbe>] ? strndup_user+0x4e/0x70
    >  [<ffffffff811f3a45>] SyS_mount+0x75/0xc0
    >  [<ffffffff8100242b>] do_syscall_64+0x4b/0xa0
    >  [<ffffffff81988f3c>] entry_SYSCALL64_slow_path+0x25/0x25
    > Code: 00 00 75 ec 48 89 0d 02 22 22 01 8b 89 10 01 00 00 48 89 05 fd 21 22 01 39 8e 10 01 00 00 0f 84 e0 00 00 00 48 8b 80 d8 00 00 00 <48> 8b 50 10 48 89 05 df 21 22 01 48 89 15 d0 21 22 01 8b 53 30
    > RIP  [<ffffffff811fba4e>] propagate_one+0xbe/0x1c0
    >  RSP <ffff8800bac3fd38>
    > CR2: 0000000000000010
    > ---[ end trace 2725ecd95164f217 ]---
    
    This oops happens with the namespace_sem held and can be triggered by
    non-root users.  An all around not pleasant experience.
    
    To avoid this scenario when finding the appropriate source mount to
    copy stop the walk up the mnt_master chain when the first source mount
    is encountered.
    
    Further rewrite the walk up the last_source mnt_master chain so that
    it is clear what is going on.
    
    The reason why the first source mount is special is that it it's
    mnt_parent is not a mount in the dest_mnt propagation tree, and as
    such termination conditions based up on the dest_mnt mount propgation
    tree do not make sense.
    
    To avoid other kinds of confusion last_dest is not changed when
    computing last_source.  last_dest is only used once in propagate_one
    and that is above the point of the code being modified, so changing
    the global variable is meaningless and confusing.
    
    fixes: f2ebb3a921c1ca1e2ddd9242e95a1989a50c4c68 ("smarter propagate_mnt()")
    Reported-by: Tycho Andersen <tycho.andersen@canonical.com>
    Reviewed-by: Seth Forshee <seth.forshee@canonical.com>
    Tested-by: Seth Forshee <seth.forshee@canonical.com>
    Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit de6d747a37d456e5a64055d2a8647c666449c2b6
Author: Dan Streetman <ddstreet@ieee.org>
Date:   Thu May 5 16:22:23 2016 -0700

    mm/zswap: provide unique zpool name
    
    commit 32a4e169039927bfb6ee9f0ccbbe3a8aaf13a4bc upstream.
    
    Instead of using "zswap" as the name for all zpools created, add an
    atomic counter and use "zswap%x" with the counter number for each zpool
    created, to provide a unique name for each new zpool.
    
    As zsmalloc, one of the zpool implementations, requires/expects a unique
    name for each pool created, zswap should provide a unique name.  The
    zsmalloc pool creation does not fail if a new pool with a conflicting
    name is created, unless CONFIG_ZSMALLOC_STAT is enabled; in that case,
    zsmalloc pool creation fails with -ENOMEM.  Then zswap will be unable to
    change its compressor parameter if its zpool is zsmalloc; it also will
    be unable to change its zpool parameter back to zsmalloc, if it has any
    existing old zpool using zsmalloc with page(s) in it.  Attempts to
    change the parameters will result in failure to create the zpool.  This
    changes zswap to provide a unique name for each zpool creation.
    
    Fixes: f1c54846ee45 ("zswap: dynamic pool creation")
    Signed-off-by: Dan Streetman <ddstreet@ieee.org>
    Reported-by: Sergey Senozhatsky <sergey.senozhatsky@gmail.com>
    Reviewed-by: Sergey Senozhatsky <sergey.senozhatsky@gmail.com>
    Cc: Dan Streetman <dan.streetman@canonical.com>
    Cc: Minchan Kim <minchan@kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f1b5f0d8d55029e34d1bb3a2558c6ac5ae92aee3
Author: Hugh Dickins <hughd@google.com>
Date:   Thu May 5 16:22:15 2016 -0700

    mm, cma: prevent nr_isolated_* counters from going negative
    
    commit 14af4a5e9b26ad251f81c174e8a43f3e179434a5 upstream.
    
    /proc/sys/vm/stat_refresh warns nr_isolated_anon and nr_isolated_file go
    increasingly negative under compaction: which would add delay when
    should be none, or no delay when should delay.  The bug in compaction
    was due to a recent mmotm patch, but much older instance of the bug was
    also noticed in isolate_migratepages_range() which is used for CMA and
    gigantic hugepage allocations.
    
    The bug is caused by putback_movable_pages() in an error path
    decrementing the isolated counters without them being previously
    incremented by acct_isolated().  Fix isolate_migratepages_range() by
    removing the error-path putback, thus reaching acct_isolated() with
    migratepages still isolated, and leaving putback to caller like most
    other places do.
    
    Fixes: edc2ca612496 ("mm, compaction: move pageblock checks up from isolate_migratepages_range()")
    [vbabka@suse.cz: expanded the changelog]
    Signed-off-by: Hugh Dickins <hughd@google.com>
    Signed-off-by: Vlastimil Babka <vbabka@suse.cz>
    Acked-by: Joonsoo Kim <iamjoonsoo.kim@lge.com>
    Cc: Michal Hocko <mhocko@kernel.org>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 948a36c33ff066b57600a8af3159132ff480380f
Author: Johannes Weiner <hannes@cmpxchg.org>
Date:   Thu May 5 16:22:03 2016 -0700

    mm: memcontrol: let v2 cgroups follow changes in system swappiness
    
    commit 4550c4e157ca3da929593bb6c64080a59141af35 upstream.
    
    Cgroup2 currently doesn't have a per-cgroup swappiness setting.  We
    might want to add one later - that's a different discussion - but until
    we do, the cgroups should always follow the system setting.  Otherwise
    it will be unchangeably set to whatever the ancestor inherited from the
    system setting at the time of cgroup creation.
    
    Signed-off-by: Johannes Weiner <hannes@cmpxchg.org>
    Acked-by: Michal Hocko <mhocko@suse.com>
    Acked-by: Vladimir Davydov <vdavydov@virtuozzo.com>
    Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e223f3f95a942ad4529f59eeeb1bcbf413193492
Author: Linus Torvalds <torvalds@linux-foundation.org>
Date:   Mon May 2 12:46:42 2016 -0700

    Minimal fix-up of bad hashing behavior of hash_64()
    
    commit 689de1d6ca95b3b5bd8ee446863bf81a4883ea25 upstream.
    
    This is a fairly minimal fixup to the horribly bad behavior of hash_64()
    with certain input patterns.
    
    In particular, because the multiplicative value used for the 64-bit hash
    was intentionally bit-sparse (so that the multiply could be done with
    shifts and adds on architectures without hardware multipliers), some
    bits did not get spread out very much.  In particular, certain fairly
    common bit ranges in the input (roughly bits 12-20: commonly with the
    most information in them when you hash things like byte offsets in files
    or memory that have block factors that mean that the low bits are often
    zero) would not necessarily show up much in the result.
    
    There's a bigger patch-series brewing to fix up things more completely,
    but this is the fairly minimal fix for the 64-bit hashing problem.  It
    simply picks a much better constant multiplier, spreading the bits out a
    lot better.
    
    NOTE! For 32-bit architectures, the bad old hash_64() remains the same
    for now, since 64-bit multiplies are expensive.  The bigger hashing
    cleanup will replace the 32-bit case with something better.
    
    The new constants were picked by George Spelvin who wrote that bigger
    cleanup series.  I just picked out the constants and part of the comment
    from that series.
    
    Cc: George Spelvin <linux@horizon.com>
    Cc: Thomas Gleixner <tglx@linutronix.de>
    Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ea70acba9060f000b29a448ae297e52afae62674
Author: Shaohua Li <shli@fb.com>
Date:   Mon Apr 25 16:52:38 2016 -0700

    MD: make bio mergeable
    
    commit 9c573de3283af007ea11c17bde1e4568d9417328 upstream.
    
    blk_queue_split marks bio unmergeable, which makes sense for normal bio.
    But if dispatching the bio to underlayer disk, the blk_queue_split
    checks are invalid, hence it's possible the bio becomes mergeable.
    
    In the reported bug, this bug causes trim against raid0 performance slash
    https://bugzilla.kernel.org/show_bug.cgi?id=117051
    
    Reported-and-tested-by: Park Ju Hyung <qkrwngud825@gmail.com>
    Fixes: 6ac45aeb6bca(block: avoid to merge splitted bio)
    Cc: Ming Lei <ming.lei@canonical.com>
    Cc: Neil Brown <neilb@suse.de>
    Reviewed-by: Jens Axboe <axboe@fb.com>
    Signed-off-by: Shaohua Li <shli@fb.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8da6fc209021d8668602401b59cc08c52c3e0e01
Author: Chunyu Hu <chuhu@redhat.com>
Date:   Tue May 3 19:34:34 2016 +0800

    tracing: Don't display trigger file for events that can't be enabled
    
    commit 854145e0a8e9a05f7366d240e2f99d9c1ca6d6dd upstream.
    
    Currently register functions for events will be called
    through the 'reg' field of event class directly without
    any check when seting up triggers.
    
    Triggers for events that don't support register through
    debug fs (events under events/ftrace are for trace-cmd to
    read event format, and most of them don't have a register
    function except events/ftrace/functionx) can't be enabled
    at all, and an oops will be hit when setting up trigger
    for those events, so just not creating them is an easy way
    to avoid the oops.
    
    Link: http://lkml.kernel.org/r/1462275274-3911-1-git-send-email-chuhu@redhat.com
    
    Fixes: 85f2b08268c01 ("tracing: Add basic event trigger framework")
    Signed-off-by: Chunyu Hu <chuhu@redhat.com>
    Signed-off-by: Steven Rostedt <rostedt@goodmis.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 76b41725381f94570085755e37883a0bf55ee176
Author: Johannes Berg <johannes.berg@intel.com>
Date:   Tue Apr 26 13:47:08 2016 +0200

    mac80211: fix statistics leak if dev_alloc_name() fails
    
    commit e6436be21e77e3659b4ff7e357ab5a8342d132d2 upstream.
    
    In the case that dev_alloc_name() fails, e.g. because the name was
    given by the user and already exists, we need to clean up properly
    and free the per-CPU statistics. Fix that.
    
    Fixes: 5a490510ba5f ("mac80211: use per-CPU TX/RX statistics")
    Signed-off-by: Johannes Berg <johannes.berg@intel.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 8010bbdf5d0aa35b9dfa598f41d837c2f987e05c
Author: Oleksij Rempel <linux@rempel-privat.de>
Date:   Tue Apr 12 19:37:44 2016 +0200

    ath9k: ar5008_hw_cmn_spur_mitigate: add missing mask_m & mask_p initialisation
    
    commit de478a61389cacafe94dc8b035081b681b878f9d upstream.
    
    by moving common code to ar5008_hw_cmn_spur_mitigate i forgot to move
    mask_m & mask_p initialisation. This coused a performance regression
    on ar9281.
    
    Fixes: f911085ffa88 ("ath9k: split ar5008_hw_spur_mitigate and reuse common code in ar9002_hw_spur_mitigate.")
    Reported-by: Gustav Frederiksen <lkml2017@openmailbox.org>
    Tested-by: Gustav Frederiksen <lkml2017@openmailbox.org>
    Signed-off-by: Oleksij Rempel <linux@rempel-privat.de>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b9a9e4a4f79e801d638786c81a4fdba827c378a2
Author: Ville Syrjälä <ville.syrjala@linux.intel.com>
Date:   Mon Apr 25 16:01:19 2016 +0300

    gpiolib-acpi: Duplicate con_id string when adding it to the crs lookup list
    
    commit 7df89e92a56a3d2c8f84aa76c61471e4a7bc24f9 upstream.
    
    Calling gpiod_get() from a module and then unloading the module leads to an
    oops due to acpi_can_fallback_to_crs() storing the pointer to the passed
    'con_id' string onto acpi_crs_lookup_list. The next guy to come along will then
    try to access the string but the memory may now be gone with the module.
    Make a copy of the passed string instead, and store the copy on the list.
    
    BUG: unable to handle kernel paging request at ffffffffa03e7855
    IP: [<ffffffff81338322>] strcmp+0x12/0x30
    PGD 2a07067 PUD 2a08063 PMD 74720067 PTE 0
    Oops: 0000 [#1] PREEMPT SMP
    Modules linked in: i915(+) drm_kms_helper drm intel_gtt snd_hda_codec snd_hda_core i2c_algo_bit syscopya
    rea sysfillrect sysimgblt fb_sys_fops agpgart snd_soc_sst_bytcr_rt5640 coretemp hwmon intel_rapl intel_soc_dts_thermal
    punit_atom_debug snd_soc_rt5640 snd_soc_rl6231 serio snd_intel_sst_acpi snd_intel_sst_core video snd_soc_sst_mfld_platf
    orm snd_soc_sst_match backlight int3402_thermal processor_thermal_device int3403_thermal int3400_thermal acpi_thermal_r
    el snd_soc_core intel_soc_dts_iosf int340x_thermal_zone snd_compress i2c_hid hid snd_pcm snd_timer snd soundcore evdev
    sch_fq_codel efivarfs ipv6 autofs4 [last unloaded: drm]
    CPU: 2 PID: 3064 Comm: modprobe Tainted: G     U  W       4.6.0-rc3-ffrd-ipvr+ #302
    Hardware name: Intel Corp. VALLEYVIEW C0 PLATFORM/BYT-T FFD8, BIOS BLAKFF81.X64.0088.R10.1403240443 FFD8
    _X64_R_2014_13_1_00 03/24/2014
    task: ffff8800701cd200 ti: ffff880070034000 task.ti: ffff880070034000
    RIP: 0010:[<ffffffff81338322>]  [<ffffffff81338322>] strcmp+0x12/0x30
    RSP: 0000:ffff880070037748  EFLAGS: 00010286
    RAX: 0000000080000000 RBX: ffff88007a342800 RCX: 0000000000000006
    RDX: 0000000000000006 RSI: ffffffffa054f856 RDI: ffffffffa03e7856
    RBP: ffff880070037748 R08: 0000000000000000 R09: 0000000000000001
    R10: 0000000000000000 R11: 0000000000000000 R12: ffffffffa054f855
    R13: ffff88007281cae0 R14: 0000000000000010 R15: ffffffffffffffea
    FS:  00007faa51447700(0000) GS:ffff880079300000(0000) knlGS:0000000000000000
    CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
    CR2: ffffffffa03e7855 CR3: 0000000041eba000 CR4: 00000000001006e0
    Stack:
     ffff880070037770 ffffffff8136ad28 ffffffffa054f855 0000000000000000
     ffff88007a0a2098 ffff8800700377e8 ffffffff8136852e ffff88007a342800
     00000007700377a0 ffff8800700377a0 ffffffff81412442 70672d6c656e6170
    Call Trace:
     [<ffffffff8136ad28>] acpi_can_fallback_to_crs+0x88/0x100
     [<ffffffff8136852e>] gpiod_get_index+0x25e/0x310
     [<ffffffff81412442>] ? mipi_dsi_attach+0x22/0x30
     [<ffffffff813685f2>] gpiod_get+0x12/0x20
     [<ffffffffa04fcf41>] intel_dsi_init+0x421/0x480 [i915]
     [<ffffffffa04d3783>] intel_modeset_init+0x853/0x16b0 [i915]
     [<ffffffffa0504864>] ? intel_setup_gmbus+0x214/0x260 [i915]
     [<ffffffffa0510158>] i915_driver_load+0xdc8/0x19b0 [i915]
     [<ffffffff8160fb53>] ? _raw_spin_unlock_irqrestore+0x43/0x70
     [<ffffffffa026b13b>] drm_dev_register+0xab/0xc0 [drm]
     [<ffffffffa026d7b3>] drm_get_pci_dev+0x93/0x1f0 [drm]
     [<ffffffff8160fb53>] ? _raw_spin_unlock_irqrestore+0x43/0x70
     [<ffffffffa043f1f4>] i915_pci_probe+0x34/0x50 [i915]
     [<ffffffff81379751>] pci_device_probe+0x91/0x100
     [<ffffffff8141a75a>] driver_probe_device+0x20a/0x2d0
     [<ffffffff8141a8be>] __driver_attach+0x9e/0xb0
     [<ffffffff8141a820>] ? driver_probe_device+0x2d0/0x2d0
     [<ffffffff81418439>] bus_for_each_dev+0x69/0xa0
     [<ffffffff8141a04e>] driver_attach+0x1e/0x20
     [<ffffffff81419c20>] bus_add_driver+0x1c0/0x240
     [<ffffffff8141b6d0>] driver_register+0x60/0xe0
     [<ffffffff81377d20>] __pci_register_driver+0x60/0x70
     [<ffffffffa026d9f4>] drm_pci_init+0xe4/0x110 [drm]
     [<ffffffff810ce04e>] ? trace_hardirqs_on+0xe/0x10
     [<ffffffffa02f1000>] ? 0xffffffffa02f1000
     [<ffffffffa02f1094>] i915_init+0x94/0x9b [i915]
     [<ffffffff810003bb>] do_one_initcall+0x8b/0x1c0
     [<ffffffff810eb616>] ? rcu_read_lock_sched_held+0x86/0x90
     [<ffffffff811de6d6>] ? kmem_cache_alloc_trace+0x1f6/0x270
     [<ffffffff81183826>] do_init_module+0x60/0x1dc
     [<ffffffff81115a8d>] load_module+0x1d0d/0x2390
     [<ffffffff811120b0>] ? __symbol_put+0x70/0x70
     [<ffffffff811f41b2>] ? kernel_read_file+0x92/0x120
     [<ffffffff811162f4>] SYSC_finit_module+0xa4/0xb0
     [<ffffffff8111631e>] SyS_finit_module+0xe/0x10
     [<ffffffff81001ff3>] do_syscall_64+0x63/0x350
     [<ffffffff816103da>] entry_SYSCALL64_slow_path+0x25/0x25
    Code: f7 48 8d 76 01 48 8d 52 01 0f b6 4e ff 84 c9 88 4a ff 75 ed 5d c3 0f 1f 00 55 48 89 e5 eb 04 84 c0
     74 18 48 8d 7f 01 48 8d 76 01 <0f> b6 47 ff 3a 46 ff 74 eb 19 c0 83 c8 01 5d c3 31 c0 5d c3 66
    RIP  [<ffffffff81338322>] strcmp+0x12/0x30
     RSP <ffff880070037748>
    CR2: ffffffffa03e7855
    
    v2: Make the copied con_id const
    
    Cc: Dmitry Torokhov <dmitry.torokhov@gmail.com>
    Cc: Mika Westerberg <mika.westerberg@linux.intel.com>
    Cc: Alexandre Courbot <gnurou@gmail.com>
    Fixes: 10cf4899f8af ("gpiolib: tighten up ACPI legacy gpio lookups")
    Signed-off-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
    Acked-by: Mika Westerberg <mika.westerberg@linux.intel.com>
    Reviewed-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit b6de3b96580259012915ba5b6c3c45f39a57b227
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Mon Mar 14 15:29:44 2016 +0100

    lpfc: fix misleading indentation
    
    commit aeb6641f8ebdd61939f462a8255b316f9bfab707 upstream.
    
    gcc-6 complains about the indentation of the lpfc_destroy_vport_work_array()
    call in lpfc_online(), which clearly doesn't look right:
    
    drivers/scsi/lpfc/lpfc_init.c: In function 'lpfc_online':
    drivers/scsi/lpfc/lpfc_init.c:2880:3: warning: statement is indented as if it were guarded by... [-Wmisleading-indentation]
       lpfc_destroy_vport_work_array(phba, vports);
       ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    drivers/scsi/lpfc/lpfc_init.c:2863:2: note: ...this 'if' clause, but it is not
      if (vports != NULL)
      ^~
    
    Looking at the patch that introduced this code, it's clear that the
    behavior is correct and the indentation is wrong.
    
    This fixes the indentation and adds curly braces around the previous
    if() block for clarity, as that is most likely what caused the code
    to be misindented in the first place.
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Fixes: 549e55cd2a1b ("[SCSI] lpfc 8.2.2 : Fix locking around HBA's port_list")
    Reviewed-by: Sebastian Herbszt <herbszt@gmx.de>
    Reviewed-by: Hannes Reinecke <hare@suse.com>
    Reviewed-by: Ewan D. Milne <emilne@redhat.com>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit fdf354707a098eb25d4097eaf9182f86d9d3bf49
Author: David Rivshin <drivshin@allworx.com>
Date:   Fri Jan 29 23:26:53 2016 -0500

    pwm: omap-dmtimer: Round load and match values rather than truncate
    
    commit 7b0883f33809ff0aeca9848193c31629a752bb77 upstream.
    
    When converting period and duty_cycle from nanoseconds to fclk cycles,
    the error introduced by the integer division can be appreciable, especially
    in the case of slow fclk or short period. Use DIV_ROUND_CLOSEST_ULL() so
    that the error is kept to +/- 0.5 clock cycles.
    
    Fixes: 6604c6556db9 ("pwm: Add PWM driver for OMAP using dual-mode timers")
    Signed-off-by: David Rivshin <drivshin@allworx.com>
    Acked-by: Neil Armstrong <narmstrong@baylibre.com>
    Signed-off-by: Thierry Reding <thierry.reding@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3f2f96761734e73f43d0c5442c1c7a5cf028e239
Author: David Rivshin <drivshin@allworx.com>
Date:   Fri Jan 29 23:26:52 2016 -0500

    pwm: omap-dmtimer: Add sanity checking for load and match values
    
    commit cd378881426379a62a7fe67f34b8cbe738302022 upstream.
    
    Add sanity checking to ensure that we do not program load or match values
    that are out of range if a user requests period or duty_cycle values which
    are not achievable. The match value cannot be less than the load value (but
    can be equal), and neither can be 0xffffffff. This means that there must be
    at least one fclk cycle between load and match, and another between match
    and overflow.
    
    Fixes: 6604c6556db9 ("pwm: Add PWM driver for OMAP using dual-mode timers")
    Signed-off-by: David Rivshin <drivshin@allworx.com>
    Acked-by: Neil Armstrong <narmstrong@baylibre.com>
    [thierry.reding@gmail.com: minor coding style cleanups]
    Signed-off-by: Thierry Reding <thierry.reding@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0b3ece4d8ba3e1d17d5cef76e1493bf6b4088a3d
Author: David Rivshin <drivshin@allworx.com>
Date:   Fri Jan 29 23:26:51 2016 -0500

    pwm: omap-dmtimer: Fix inaccurate period and duty cycle calculations
    
    commit f8caa792261c0edded20eba2b8fcc899a1b91819 upstream.
    
    Fix the calculation of load_value and match_value. Currently they
    are slightly too low, which produces a noticeably wrong PWM rate with
    sufficiently short periods (i.e. when 1/period approaches clk_rate/2).
    
    Example:
     clk_rate=32768Hz, period=122070ns, duty_cycle=61035ns (8192Hz/50% PWM)
     Correct values: load = 0xfffffffc, match = 0xfffffffd
     Current values: load = 0xfffffffa, match = 0xfffffffc
     effective PWM: period=183105ns, duty_cycle=91553ns (5461Hz/50% PWM)
    
    Fixes: 6604c6556db9 ("pwm: Add PWM driver for OMAP using dual-mode timers")
    Signed-off-by: David Rivshin <drivshin@allworx.com>
    Acked-by: Neil Armstrong <narmstrong@baylibre.com>
    Tested-by: Adam Ford <aford173@gmail.com>
    Signed-off-by: Thierry Reding <thierry.reding@gmail.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 452a55daa3653c4ada9f8f4f6dd027dc09695b15
Author: Vladimir Zapolskiy <vz@mleia.com>
Date:   Sun Mar 6 03:21:35 2016 +0200

    clk: bcm2835: fix check of error code returned by devm_ioremap_resource()
    
    commit 4d3ac6662452060721599a3392bc2f524af984cb upstream.
    
    The change fixes potential oops while accessing iomem on invalid
    address, if devm_ioremap_resource() fails due to some reason.
    
    The devm_ioremap_resource() function returns ERR_PTR() and never
    returns NULL, which makes useless a following check for NULL.
    
    Signed-off-by: Vladimir Zapolskiy <vz@mleia.com>
    Fixes: 5e63dcc74b30 ("clk: bcm2835: Add a driver for the auxiliary peripheral clock gates")
    Reviewed-by: Eric Anholt <eric@anholt.net>
    Signed-off-by: Stephen Boyd <sboyd@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit da596e76e09236a30a4e092f4d20ef780e4f3c3e
Author: Loc Ho <lho@apm.com>
Date:   Mon Feb 29 14:15:43 2016 -0700

    clk: xgene: Add missing parenthesis when clearing divider value
    
    commit 0f4c7a138dfefb0ebdbaf56e3ba2acd2958a6605 upstream.
    
    In the initial fix for non-zero divider shift value, the parenthesis
    was missing after the negate operation. This patch adds the required
    parenthesis. Otherwise, lower bits may be cleared unintentionally.
    
    Signed-off-by: Loc Ho <lho@apm.com>
    Acked-by: Toan Le <toanle@apm.com>
    Fixes: 1382ea631ddd ("clk: xgene: Fix divider with non-zero shift value")
    Signed-off-by: Stephen Boyd <sboyd@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 51c822713d042b81bb455f8921e354b24677b863
Author: Chen-Yu Tsai <wens@csie.org>
Date:   Mon Feb 15 17:40:19 2016 +0800

    clk: sunxi: Fix sun8i-a23-apb0-clk divider flags
    
    commit 33f60d02605a3a604e56b07a78d80d7d801b2843 upstream.
    
    The APB0 clock on A23 is a zero-based divider, not a power-of-two based
    divider.
    
    Note that this patch does not apply cleanly to kernels before 4.5-rc1,
    which added CLK_OF_DECLARE support to this driver.
    
    Fixes: 57a1fbf28424 ("clk: sunxi: Add A23 APB0 divider clock support")
    Signed-off-by: Chen-Yu Tsai <wens@csie.org>
    Signed-off-by: Maxime Ripard <maxime.ripard@free-electrons.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit de8ec2040e310dfc6cf15c9e60150cac4405fe64
Author: Stephen Boyd <sboyd@codeaurora.org>
Date:   Tue Mar 1 17:26:48 2016 -0800

    clk: qcom: msm8960: Fix ce3_src register offset
    
    commit 0f75e1a370fd843c9e508fc1ccf0662833034827 upstream.
    
    The offset seems to have been copied from the sata clk. Fix it so
    that enabling the crypto engine source clk works.
    
    Tested-by: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
    Tested-by: Bjorn Andersson <bjorn.andersson@linaro.org>
    Fixes: 5f775498bdc4 ("clk: qcom: Fully support apq8064 global clock control")
    Signed-off-by: Stephen Boyd <sboyd@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f798e3ed236db3cb3b29988166c9bc3b563b10f6
Author: Linus Walleij <linus.walleij@linaro.org>
Date:   Wed Feb 24 09:39:11 2016 +0100

    clk: versatile: sp810: support reentrance
    
    commit ec7957a6aa0aaf981fb8356dc47a2cdd01cde03c upstream.
    
    Despite care take to allocate clocks state containers the
    SP810 driver actually just supports creating one instance:
    all clocks registered for every instance will end up with the
    exact same name and __clk_init() will fail.
    
    Rename the timclken<0> .. timclken<n> to sp810_<instance>_<n>
    so every clock on every instance gets a unique name.
    
    This is necessary for the RealView PBA8 which has two SP810
    blocks: the second block will not register its clocks unless
    every clock on every instance is unique and results in boot
    logs like this:
    
    ------------[ cut here ]------------
    WARNING: CPU: 0 PID: 0 at ../drivers/clk/versatile/clk-sp810.c:137
      clk_sp810_of_setup+0x110/0x154()
    Modules linked in:
    CPU: 0 PID: 0 Comm: swapper/0 Not tainted
    4.5.0-rc2-00030-g352718fc39f6-dirty #225
    Hardware name: ARM RealView Machine (Device Tree Support)
    [<c00167f8>] (unwind_backtrace) from [<c0013204>]
                 (show_stack+0x10/0x14)
    [<c0013204>] (show_stack) from [<c01a049c>]
                 (dump_stack+0x84/0x9c)
    [<c01a049c>] (dump_stack) from [<c0024990>]
                 (warn_slowpath_common+0x74/0xb0)
    [<c0024990>] (warn_slowpath_common) from [<c0024a68>]
                 (warn_slowpath_null+0x1c/0x24)
    [<c0024a68>] (warn_slowpath_null) from [<c051eb44>]
                 (clk_sp810_of_setup+0x110/0x154)
    [<c051eb44>] (clk_sp810_of_setup) from [<c051e3a4>]
                 (of_clk_init+0x12c/0x1c8)
    [<c051e3a4>] (of_clk_init) from [<c0504714>]
                 (time_init+0x20/0x2c)
    [<c0504714>] (time_init) from [<c0501b18>]
                 (start_kernel+0x244/0x3c4)
    [<c0501b18>] (start_kernel) from [<7000807c>] (0x7000807c)
    ---[ end trace cb88537fdc8fa200 ]---
    
    Cc: Michael Turquette <mturquette@baylibre.com>
    Cc: Pawel Moll <pawel.moll@arm.com>
    Fixes: 6e973d2c4385 "clk: vexpress: Add separate SP810 driver"
    Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
    Signed-off-by: Stephen Boyd <sboyd@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit e5a3b2876a5da1038a8079986fa0162df7849714
Author: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
Date:   Mon Feb 22 11:43:39 2016 +0000

    clk: qcom: msm8960: fix ce3_core clk enable register
    
    commit 732d6913691848db9fabaa6a25b4d6fad10ddccf upstream.
    
    This patch corrects the enable register offset which is actually 0x36cc
    instead of 0x36c4
    
    Signed-off-by: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
    Fixes: 5f775498bdc4 ("clk: qcom: Fully support apq8064 global clock control")
    Signed-off-by: Stephen Boyd <sboyd@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 6f14af38abc3e45d13a556590afdf7db3dae4b48
Author: Andreas Färber <afaerber@suse.de>
Date:   Sun Feb 7 22:13:03 2016 +0100

    clk: meson: Fix meson_clk_register_clks() signature type mismatch
    
    commit bb473593c8099302bfd7befc23de67df907e3a99 upstream.
    
    As preparation for arm64 based mesongxbb, which pulls in this code once
    enabling ARCH_MESON, fix a size_t vs. unsigned int type mismatch.
    The loop uses a local unsigned int variable, so adopt that type,
    matching the header.
    
    Fixes: 7a29a869434e ("clk: meson: Add support for Meson clock controller")
    Signed-off-by: Andreas Färber <afaerber@suse.de>
    Acked-by: Carlo Caione <carlo@endlessm.com>
    Signed-off-by: Stephen Boyd <sboyd@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4f2f2e7d177ed83dda98c3248e8bf603b9558498
Author: Shawn Lin <shawn.lin@rock-chips.com>
Date:   Tue Feb 2 11:37:50 2016 +0800

    clk: rockchip: free memory in error cases when registering clock branches
    
    commit 2467b6745e0ae9c6cdccff24c4cceeb14b1cce3f upstream.
    
    Add free memeory if rockchip_clk_register_branch fails.
    
    Fixes: a245fecbb806 ("clk: rockchip: add basic infrastructure...")
    Signed-off-by: Shawn Lin <shawn.lin@rock-chips.com>
    Signed-off-by: Heiko Stuebner <heiko@sntech.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit d2697f62467377bc43901145638b67887b0bcdd9
Author: Shawn Lin <shawn.lin@rock-chips.com>
Date:   Tue Jan 26 11:30:18 2016 +0800

    clk: rockchip: fix wrong mmc phase shift for rk3228
    
    commit bb07698fc8d13ec74f4f5bd87b04953777ee6982 upstream.
    
    mmc sample shift is 0 for rk3228 refer to user manaul.
    So it's broken if we enable mmc tuning for rk3228.
    
    Fixes: 307a2e9ac ("clk: rockchip: add clock controller for rk3228")
    Signed-off-by: Shawn Lin <shawn.lin@rock-chips.com>
    Reviewed-by: Xing Zheng <zhengxing@rock-chips.com>
    Signed-off-by: Heiko Stuebner <heiko@sntech.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit ac322c13727a9aa0823895cddd7c6e53786b88fe
Author: Shawn Lin <shawn.lin@rock-chips.com>
Date:   Mon Feb 1 16:18:40 2016 +0800

    soc: rockchip: power-domain: fix err handle while probing
    
    commit 1d961f11a108af9f7fbe89cc950a8d16ddbdbb28 upstream.
    
    If we fail to probe the driver, we should not directly break
    from the for_each_available_child_of_node since it calls of_node_get
    while iterating. This patch add of_node_put to fix the unbalanced
    call pair.
    
    Fixes: 7c696693a4f5 ("soc: rockchip: power-domain: Add power domain driver")
    Signed-off-by: Shawn Lin <shawn.lin@rock-chips.com>
    Signed-off-by: Heiko Stuebner <heiko@sntech.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit a2a9208d19bd14adda6a4ab8738315b4c9b5959b
Author: Heiko Stuebner <heiko@sntech.de>
Date:   Thu Jan 21 21:53:09 2016 +0100

    clk-divider: make sure read-only dividers do not write to their register
    
    commit 50359819794b4a16ae35051cd80f2dab025f6019 upstream.
    
    Commit e6d5e7d90be9 ("clk-divider: Fix READ_ONLY when divider > 1") removed
    the special ops struct for read-only clocks and instead opted to handle
    them inside the regular ops.
    
    On the rk3368 this results in breakage as aclkm now gets set a value.
    While it is the same divider value, the A53 core still doesn't like it,
    which can result in the cpu ending up in a hang.
    The reason being that "ACLKENMasserts one clock cycle before the rising
    edge of ACLKM" and the clock should only be touched when STANDBYWFIL2
    is asserted.
    
    To fix this, reintroduce the read-only ops but do include the round_rate
    callback. That way no writes that may be unsafe are done to the divider
    register in any case.
    
    The Rockchip use of the clk_divider_ops is adapted to this split again,
    as is the nxp, lpc18xx-ccu driver that was included since the original
    commit. On lpc18xx-ccu the divider seems to always be read-only
    so only uses the new ops now.
    
    Fixes: e6d5e7d90be9 ("clk-divider: Fix READ_ONLY when divider > 1")
    Reported-by: Zhang Qing <zhangqing@rock-chips.com>
    Signed-off-by: Heiko Stuebner <heiko@sntech.de>
    Signed-off-by: Stephen Boyd <sboyd@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 826a816fb278289e231ac8f1eec355730ac2b592
Author: Krzysztof Halasa <khalasa@piap.pl>
Date:   Fri Mar 11 12:32:14 2016 +0100

    CNS3xxx: Fix PCI cns3xxx_write_config()
    
    commit 88e9da9a2a70b6f1a171fbf30a681d6bc4031c4d upstream.
    
    The "where" offset was added twice, fix it.
    
    Signed-off-by: Krzysztof Hałasa <khalasa@piap.pl>
    Fixes: 498a92d42596 ("ARM: cns3xxx: pci: avoid potential stack overflow")
    Signed-off-by: Olof Johansson <olof@lixom.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3fb17a4d3e0d8760d268815f27589662fb702f4f
Author: Amitkumar Karwar <akarwar@marvell.com>
Date:   Tue Feb 23 05:16:17 2016 -0800

    mwifiex: fix corner case association failure
    
    commit a6139b6271f9f95377fe3486aed6120c9142779b upstream.
    
    This patch corrects the error case in association path by returning
    -1. Earlier "media_connected" used to remain on in this error case
    causing failure for further association attempts.
    
    Signed-off-by: Amitkumar Karwar <akarwar@marvell.com>
    Fixes: b887664d882ee4 ('mwifiex: channel switch handling for station')
    Signed-off-by: Cathy Luo <cluo@marvell.com>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4b758fd539dd8a40c9fafc4fae5c84932d4b1bf5
Author: Ashok Raj Nagarajan <arnagara@qti.qualcomm.com>
Date:   Fri Feb 5 21:12:48 2016 +0530

    ath10k: fix pktlog in QCA99X0
    
    commit 53a5c9bc53ce51f65699a43c67ab167436d28083 upstream.
    
    Currently, we are providing wrong payload data of pktlog to trace points.
    Data we receive from FW through copy engine 8 contains pktlog data alone.
    We don't need to parse anything in driver before handing it to trace
    points.
    
    Fixes: afb0bf7f530b ("ath10k: add support for pktlog in QCA99X0")
    Signed-off-by: Ashok Raj Nagarajan <arnagara@qti.qualcomm.com>
    Signed-off-by: Kalle Valo <kvalo@qca.qualcomm.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 1364fd09f7f2c400df57c938761bc6fbd05e1544
Author: Andrzej Hajda <a.hajda@samsung.com>
Date:   Thu Jan 7 14:28:50 2016 +0100

    wlcore: fix error handling in wlcore_event_fw_logger
    
    commit 68f37e5d7a2e00306adab033fba6c3042b33e8e1 upstream.
    
    wlcore_read/wlcore_write can return negative values so it should
    be assigned to signed variable.
    
    The problem has been detected using proposed semantic patch
    scripts/coccinelle/tests/unsigned_lesser_than_zero.cocci [1].
    
    [1]: http://permalink.gmane.org/gmane.linux.kernel/2120705
    
    Fixes: 3719c17e1816 ("wlcore/wl18xx: fw logger over sdio")
    Signed-off-by: Andrzej Hajda <a.hajda@samsung.com>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit f0ffb73b2c569cdd2ac40be762981ff69d508800
Author: Dan Carpenter <dan.carpenter@oracle.com>
Date:   Thu Mar 10 10:45:32 2016 +0300

    ata: ahci_xgene: dereferencing uninitialized pointer in probe
    
    commit 8134233e8d346aaa1c929dc510e75482ae318bce upstream.
    
    If the call to acpi_get_object_info() fails then "info" hasn't been
    initialized.  In that situation, we already know that "version" should
    be XGENE_AHCI_V1 so we don't actually need to dereference "info".
    
    Fixes: c9802a4be661 ('ata: ahci_xgene: Add AHCI Support for 2nd HW version of APM X-Gene SoC AHCI SATA Host controller.')
    Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
    Signed-off-by: Tejun Heo <tj@kernel.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit c44c5c623b797503f31c2f2a9b366eee74a0677c
Author: Wenwei Tao <ww.tao0320@gmail.com>
Date:   Sat Mar 5 00:27:04 2016 +0800

    null_blk: add lightnvm null_blk device to the nullb_list
    
    commit 3681c85dffda70e551dead31c8d102bd69033fe8 upstream.
    
    After register null_blk devices into lightnvm, we forget
    to add these devices to the the nullb_list, makes them
    invisible to the null_blk driver.
    
    Signed-off-by: Wenwei Tao <ww.tao0320@gmail.com>
    Fixes: a514379b0c77 ("null_blk: oops when initializing without lightnvm")
    Signed-off-by: Jens Axboe <axboe@fb.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3ebb655a6aa716086e1234b37683c8091832a4f0
Author: Javier González <javier@cnexlabs.com>
Date:   Sat Feb 20 08:52:40 2016 +0100

    lightnvm: update closed list outside of intr context
    
    commit 6adb03de406e8c92579c2e4b11640841fa908277 upstream.
    
    When an I/O finishes, full blocks are moved from the open to the closed
    list - a lock is taken to protect the list. This happens at the moment
    in the interrupt context, which is not correct.
    
    This patch moves this logic to the block workqueue instead, avoiding
    holding a spinlock without interrupt save in an interrupt context.
    
    Signed-off-by: Javier González <javier@cnexlabs.com>
    Fixes: ff0e498bfa18 ("lightnvm: manage open and closed blocks sepa...")
    Signed-off-by: Matias Bjørling <m@bjorling.me>
    Signed-off-by: Jens Axboe <axboe@fb.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit cf06fea41cd4e5f1fa1b584b830c6b9b0cdf291d
Author: Dan Streetman <dan.streetman@canonical.com>
Date:   Thu Jan 14 13:42:32 2016 -0500

    nbd: ratelimit error msgs after socket close
    
    commit da6ccaaa79caca4f38b540b651238f87215217a2 upstream.
    
    Make the "Attempted send on closed socket" error messages generated in
    nbd_request_handler() ratelimited.
    
    When the nbd socket is shutdown, the nbd_request_handler() function emits
    an error message for every request remaining in its queue.  If the queue
    is large, this will spam a large amount of messages to the log.  There's
    no need for a separate error message for each request, so this patch
    ratelimits it.
    
    In the specific case this was found, the system was virtual and the error
    messages were logged to the serial port, which overwhelmed it.
    
    Fixes: 4d48a542b427 ("nbd: fix I/O hang on disconnected nbds")
    Signed-off-by: Dan Streetman <dan.streetman@canonical.com>
    Signed-off-by: Markus Pargmann <mpa@pengutronix.de>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 318ff841ff1dee3a2572b9efaab243aed896b64e
Author: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
Date:   Fri Jan 22 16:48:46 2016 +0200

    mfd: intel-lpss: Remove clock tree on error path
    
    commit 84cb36cac581c915ef4e8b70abb73e084325df92 upstream.
    
    We forgot to remove the clock tree if something goes wrong in ->probe(). Add a
    call to intel_lpss_unregister_clock() on error path in ->probe() to fix the
    potential issue.
    
    Fixes: 4b45efe85263 (mfd: Add support for Intel Sunrisepoint LPSS devices)
    Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
    Acked-by: Mika Westerberg <mika.westerberg@linux.intel.com>
    Signed-off-by: Lee Jones <lee.jones@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 7bbda3d4ec7a9f989fa0f43669698928adc3cc39
Author: Larry Finger <Larry.Finger@lwfinger.net>
Date:   Thu Feb 25 11:03:01 2016 -0600

    rtlwifi: Fix size of wireless mode variable
    
    commit 73fb270592164b1917442f8bff4c791d095ee2ef upstream.
    
    Smatch reports the following warning:
    
      CHECK   drivers/net/wireless/realtek/rtlwifi/rc.c
    drivers/net/wireless/realtek/rtlwifi/rc.c:144 _rtl_rc_rate_set_series() warn: impossible condition '(wireless_mode == 256) => (0-255 == 256)'
    
    This warning arises because commit acc6907b87a9 ("rtlwifi: Fix warning
    from ieee80211_get_tx_rates() when using 5G") now checks the wireless
    mode for WIRELESS_MODE_AC_ONLY (BIT(8)) in _rtl_rc_rate_set_series().
    As a result, all quantities used to store the wireless mode must be u16.
    
    This patch also reorders struct rtl_sta_info to save a little space.
    
    Fixes: d76d65fd2695 ("rtlwifi: fix broken VHT support")
    Reported-by: Dan Williams <dcbw@redhat.com>
    Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
    Signed-off-by: Kalle Valo <kvalo@codeaurora.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 4920ee6f309009d122f929c0aaae47464e413eb9
Author: Julian Anastasov <ja@ssi.bg>
Date:   Sat Mar 5 15:03:22 2016 +0200

    ipvs: drop first packet to redirect conntrack
    
    commit f719e3754ee2f7275437e61a6afd520181fdd43b upstream.
    
    Jiri Bohac is reporting for a problem where the attempt
    to reschedule existing connection to another real server
    needs proper redirect for the conntrack used by the IPVS
    connection. For example, when IPVS connection is created
    to NAT-ed real server we alter the reply direction of
    conntrack. If we later decide to select different real
    server we can not alter again the conntrack. And if we
    expire the old connection, the new connection is left
    without conntrack.
    
    So, the only way to redirect both the IPVS connection and
    the Netfilter's conntrack is to drop the SYN packet that
    hits existing connection, to wait for the next jiffie
    to expire the old connection and its conntrack and to rely
    on client's retransmission to create new connection as
    usually.
    
    Jiri Bohac provided a fix that drops all SYNs on rescheduling,
    I extended his patch to do such drops only for connections
    that use conntrack. Here is the original report from Jiri Bohac:
    
    Since commit dc7b3eb900aa ("ipvs: Fix reuse connection if real server
    is dead"), new connections to dead servers are redistributed
    immediately to new servers.  The old connection is expired using
    ip_vs_conn_expire_now() which sets the connection timer to expire
    immediately.
    
    However, before the timer callback, ip_vs_conn_expire(), is run
    to clean the connection's conntrack entry, the new redistributed
    connection may already be established and its conntrack removed
    instead.
    
    Fix this by dropping the first packet of the new connection
    instead, like we do when the destination server is not available.
    The timer will have deleted the old conntrack entry long before
    the first packet of the new connection is retransmitted.
    
    Fixes: dc7b3eb900aa ("ipvs: Fix reuse connection if real server is dead")
    Signed-off-by: Jiri Bohac <jbohac@suse.cz>
    Signed-off-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 3ed30f36fe42d7a88d7020e55d7a85ab27687126
Author: Marco Angaroni <marcoangaroni@gmail.com>
Date:   Sat Mar 5 12:10:02 2016 +0100

    ipvs: correct initial offset of Call-ID header search in SIP persistence engine
    
    commit 7617a24f83b5d67f4dab1844956be1cebc44aec8 upstream.
    
    The IPVS SIP persistence engine is not able to parse the SIP header
    "Call-ID" when such header is inserted in the first positions of
    the SIP message.
    
    When IPVS is configured with "--pe sip" option, like for example:
    ipvsadm -A -u 1.2.3.4:5060 -s rr --pe sip -p 120 -o
    some particular messages (see below for details) do not create entries
    in the connection template table, which can be listed with:
    ipvsadm -Lcn --persistent-conn
    
    Problematic SIP messages are SIP responses having "Call-ID" header
    positioned just after message first line:
    SIP/2.0 200 OK
    [Call-ID header here]
    [rest of the headers]
    
    When "Call-ID" header is positioned down (after a few other headers)
    it is correctly recognized.
    
    This is due to the data offset used in get_callid function call inside
    ip_vs_pe_sip.c file: since dptr already points to the start of the
    SIP message, the value of dataoff should be initially 0.
    Otherwise the header is searched starting from some bytes after the
    first character of the SIP message.
    
    Fixes: 758ff0338722 ("IPVS: sip persistence engine")
    Signed-off-by: Marco Angaroni <marcoangaroni@gmail.com>
    Acked-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 12bd7b2817dc5de5fc1bd979a9e9c2db1828551e
Author: Arnd Bergmann <arnd@arndb.de>
Date:   Wed Jan 27 14:52:02 2016 +0100

    ipvs: handle ip_vs_fill_iph_skb_off failure
    
    commit 3f20efba41916ee17ce82f0fdd02581ada2872b2 upstream.
    
    ip_vs_fill_iph_skb_off() may not find an IP header, and gcc has
    determined that ip_vs_sip_fill_param() then incorrectly accesses
    the protocol fields:
    
    net/netfilter/ipvs/ip_vs_pe_sip.c: In function 'ip_vs_sip_fill_param':
    net/netfilter/ipvs/ip_vs_pe_sip.c:76:5: error: 'iph.protocol' may be used uninitialized in this function [-Werror=maybe-uninitialized]
      if (iph.protocol != IPPROTO_UDP)
         ^
    net/netfilter/ipvs/ip_vs_pe_sip.c:81:10: error: 'iph.len' may be used uninitialized in this function [-Werror=maybe-uninitialized]
      dataoff = iph.len + sizeof(struct udphdr);
              ^
    
    This adds a check for the ip_vs_fill_iph_skb_off() return code
    before looking at the ip header data returned from it.
    
    Signed-off-by: Arnd Bergmann <arnd@arndb.de>
    Fixes: b0e010c527de ("ipvs: replace ip_vs_fill_ip4hdr with ip_vs_fill_iph_skb_off")
    Acked-by: Julian Anastasov <ja@ssi.bg>
    Signed-off-by: Simon Horman <horms@verge.net.au>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 0123127c7f11f0b91bbfe7f71d845b2249a0d062
Author: Leon Romanovsky <leon@kernel.org>
Date:   Tue Feb 23 10:25:21 2016 +0200

    net/mlx5_core: Fix caching ATOMIC endian mode capability
    
    commit 91d9ed8443b88cc50b81cf5ec900172515270f6f upstream.
    
    Add caching of maximum device capability of ATOMIC endian mode.
    
    Fixes: f91e6d8941bf ('net/mlx5_core: Add setting ATOMIC endian mode')
    Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
    Reviewed-by: Saeed Mahameed <saeedm@mellanox.com>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 2b2da6e18561efbd763659fd0ff1dfb9dd54873e
Author: Hariprasad S <hariprasad@chelsio.com>
Date:   Tue Apr 5 10:23:48 2016 +0530

    RDMA/iw_cxgb4: Fix bar2 virt addr calculation for T4 chips
    
    commit 32cc92c7b5e52357a0a24010bae9eb257fa75d3e upstream.
    
    For T4, kernel mode qps don't use the user doorbell. User mode qps during
    flow control db ringing are forced into kernel, where user doorbell is
    treated as kernel doorbell and proper bar2 offset in bar2 virtual space is
    calculated, which incase of T4 is a bogus address, causing a kernel panic
    due to illegal write during doorbell ringing.
    In case of T4, kernel mode qp bar2 virtual address should be 0. Added T4
    check during bar2 virtual address calculation to return 0. Fixed Bar2
    range checks based on bar2 physical address.
    
    The below oops will be fixed
    
      <1>BUG: unable to handle kernel paging request at 000000000002aa08
      <1>IP: [<ffffffffa011d800>] c4iw_uld_control+0x4e0/0x880 [iw_cxgb4]
      <4>PGD 1416a8067 PUD 15bf35067 PMD 0
      <4>Oops: 0002 [#1] SMP
      <4>last sysfs file:
      /sys/devices/pci0000:00/0000:00:03.0/0000:02:00.4/infiniband/cxgb4_0/node_guid
      <4>CPU 5
      <4>Modules linked in: rdma_ucm rdma_cm ib_cm ib_sa ib_mad ib_uverbs
      ip6table_filter ip6_tables ebtable_nat ebtables ipt_MASQUERADE
      iptable_nat nf_nat nf_conntrack_ipv4 nf_defrag_ipv4 xt_state nf_conntrack
      ipt_REJECT xt_CHECKSUM iptable_mangle iptable_filter ip_tables bridge autofs4
      target_core_iblock target_core_file target_core_pscsi target_core_mod
      configfs bnx2fc cnic uio fcoe libfcoe libfc scsi_transport_fc scsi_tgt 8021q
      garp stp llc cpufreq_ondemand acpi_cpufreq freq_table mperf vhost_net macvtap
      macvlan tun kvm uinput microcode iTCO_wdt iTCO_vendor_support sg joydev
      serio_raw i2c_i801 i2c_core lpc_ich mfd_core e1000e ptp pps_core ioatdma dca
      i7core_edac edac_core shpchp ext3 jbd mbcache sd_mod crc_t10dif pata_acpi
      ata_generic ata_piix iw_cxgb4 iw_cm ib_core ib_addr cxgb4 ipv6 dm_mirror
      dm_region_hash dm_log dm_mod [last unloaded: scsi_wait_scan]
      <4>
      Supermicro X8ST3/X8ST3
      <4>RIP: 0010:[<ffffffffa011d800>]  [<ffffffffa011d800>]
      c4iw_uld_control+0x4e0/0x880 [iw_cxgb4]
      <4>RSP: 0000:ffff880155a03db0  EFLAGS: 00010006
      <4>RAX: 000000000000001d RBX: ffff88013ae5fc00 RCX: ffff880155adb180
      <4>RDX: 000000000002aa00 RSI: 0000000000000001 RDI: ffff88013ae5fdf8
      <4>RBP: ffff880155a03e10 R08: 0000000000000000 R09: 0000000000000001
      <4>R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
      <4>R13: 000000000000001d R14: ffff880156414ab0 R15: ffffe8ffffc05b88
      <4>FS:  0000000000000000(0000) GS:ffff8800282a0000(0000) knlGS:0000000000000000
      <4>CS:  0010 DS: 0018 ES: 0018 CR0: 000000008005003b
      <4>CR2: 000000000002aa08 CR3: 000000015bd0e000 CR4: 00000000000007e0
      <4>DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
      <4>DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400
      <4>Process cxgb4 (pid: 394, threadinfo ffff880155a00000, task ffff880156414ab0)
      <4>Stack:
      <4> ffff880156415068 ffff880155adb180 ffff880155a03df0 ffffffffa00a344b
      <4><d> 00000000000003e8 ffff880155920000 0000000000000004 ffff880155920000
      <4><d> ffff88015592d438 ffffffffa00a3860 ffff880155a03fd8 ffffe8ffffc05b88
      <4>Call Trace:
      <4> [<ffffffffa00a344b>] ? enable_txq_db+0x2b/0x80 [cxgb4]
      <4> [<ffffffffa00a3860>] ? process_db_full+0x0/0xa0 [cxgb4]
      <4> [<ffffffffa00a38a6>] process_db_full+0x46/0xa0 [cxgb4]
      <4> [<ffffffff8109fda0>] worker_thread+0x170/0x2a0
      <4> [<ffffffff810a6aa0>] ? autoremove_wake_function+0x0/0x40
      <4> [<ffffffff8109fc30>] ? worker_thread+0x0/0x2a0
      <4> [<ffffffff810a660e>] kthread+0x9e/0xc0
      <4> [<ffffffff8100c28a>] child_rip+0xa/0x20
      <4> [<ffffffff810a6570>] ? kthread+0x0/0xc0
      <4> [<ffffffff8100c280>] ? child_rip+0x0/0x20
      <4>Code: e9 ba 00 00 00 66 0f 1f 44 00 00 44 8b 05 29 07 02 00 45 85 c0 0f 85
      71 02 00 00 8b 83 70 01 00 00 45 0f b7 ed c1 e0 0f 44 09 e8 <89> 42 08 0f ae f8
      66 c7 83 82 01 00 00 00 00 44 0f b7 ab dc 01
      <1>RIP  [<ffffffffa011d800>] c4iw_uld_control+0x4e0/0x880 [iw_cxgb4]
      <4> RSP <ffff880155a03db0>
      <4>CR2: 000000000002aa08`
    
    Based on original work by Bharat Potnuri <bharat@chelsio.com>
    
    Fixes: 74217d4c6a4fb0d8 ("iw_cxgb4: support for bar2 qid densities exceeding the page size")
    
    Signed-off-by: Steve Wise <swise@opengridcomputing.com>
    Signed-off-by: Hariprasad Shenai <hariprasad@chelsio.com>
    Reviewed-by: Leon Romanovsky <leon@leon.nu>
    Signed-off-by: Doug Ledford <dledford@redhat.com>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

commit 42ff5fc8661040f37a67a4a95c231f6765d6f59c
Author: Daniel Lezcano <daniel.lezcano@linaro.org>
Date:   Tue Apr 19 15:43:02 2016 +0200

    clocksource/drivers/tango-xtal: Fix boot hang due to incorrect test
    
    commit 16eeed7e5558a3dcf30f75526a896b2632f299f9 upstream.
    
    Commit 0881841f7e78 introduced a regression by inverting a test check
    after calling clocksource_mmio_init(). That results on the system to
    hang at boot time.
    
    Fix it by inverting the test again.
    
    Fixes: 0881841f7e78 ("Replace code by clocksource_mmio_init")
    Reported-by: Marc Gonzalez <marc_gonzalez@sigmadesigns.com>
    Signed-off-by: Daniel Lezcano <daniel.lezcano@linaro.org>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
